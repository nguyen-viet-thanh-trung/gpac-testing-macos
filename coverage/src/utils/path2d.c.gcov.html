<!DOCTYPE HTML PUBLIC "-//W3C//DTD HTML 4.01 Transitional//EN">

<html lang="en">

<head>
  <meta http-equiv="Content-Type" content="text/html; charset=UTF-8">
  <title>LCOV - coverage.info - src/utils/path2d.c</title>
  <link rel="stylesheet" type="text/css" href="../../gcov.css">
</head>

<body>

  <table width="100%" border=0 cellspacing=0 cellpadding=0>
    <tr><td class="title">LCOV - code coverage report</td></tr>
    <tr><td class="ruler"><img src="../../glass.png" width=3 height=3 alt=""></td></tr>

    <tr>
      <td width="100%">
        <table cellpadding=1 border=0 width="100%">
          <tr>
            <td width="10%" class="headerItem">Current view:</td>
            <td width="35%" class="headerValue"><a href="../../index.html">top level</a> - <a href="index.html">src/utils</a> - path2d.c<span style="font-size: 80%;"> (source / <a href="path2d.c.func-sort-c.html">functions</a>)</span></td>
            <td width="5%"></td>
            <td width="15%"></td>
            <td width="10%" class="headerCovTableHead">Hit</td>
            <td width="10%" class="headerCovTableHead">Total</td>
            <td width="15%" class="headerCovTableHead">Coverage</td>
          </tr>
          <tr>
            <td class="headerItem">Test:</td>
            <td class="headerValue">coverage.info</td>
            <td></td>
            <td class="headerItem">Lines:</td>
            <td class="headerCovTableEntry">89</td>
            <td class="headerCovTableEntry">704</td>
            <td class="headerCovTableEntryLo">12.6 %</td>
          </tr>
          <tr>
            <td class="headerItem">Date:</td>
            <td class="headerValue">2016-06-07 10:36:32</td>
            <td></td>
            <td class="headerItem">Functions:</td>
            <td class="headerCovTableEntry">11</td>
            <td class="headerCovTableEntry">38</td>
            <td class="headerCovTableEntryLo">28.9 %</td>
          </tr>
          <tr><td><img src="../../glass.png" width=3 height=3 alt=""></td></tr>
        </table>
      </td>
    </tr>

    <tr><td class="ruler"><img src="../../glass.png" width=3 height=3 alt=""></td></tr>
  </table>

  <table cellpadding=0 cellspacing=0 border=0>
    <tr>
      <td><br></td>
    </tr>
    <tr>
      <td>
<pre class="sourceHeading">          Line data    Source code</pre>
<pre class="source">
<a name="1"><span class="lineNum">       1 </span>            : /*</a>
<span class="lineNum">       2 </span>            :  *                      GPAC - Multimedia Framework C SDK
<span class="lineNum">       3 </span>            :  *
<span class="lineNum">       4 </span>            :  *                      Authors: Jean Le Feuvre
<span class="lineNum">       5 </span>            :  *                      Copyright (c) Telecom ParisTech 2000-2012
<span class="lineNum">       6 </span>            :  *                                      All rights reserved
<span class="lineNum">       7 </span>            :  *
<span class="lineNum">       8 </span>            :  *  This file is part of GPAC / common tools sub-project
<span class="lineNum">       9 </span>            :  *
<span class="lineNum">      10 </span>            :  *  GPAC is free software; you can redistribute it and/or modify
<span class="lineNum">      11 </span>            :  *  it under the terms of the GNU Lesser General Public License as published by
<span class="lineNum">      12 </span>            :  *  the Free Software Foundation; either version 2, or (at your option)
<span class="lineNum">      13 </span>            :  *  any later version.
<span class="lineNum">      14 </span>            :  *
<span class="lineNum">      15 </span>            :  *  GPAC is distributed in the hope that it will be useful,
<span class="lineNum">      16 </span>            :  *  but WITHOUT ANY WARRANTY; without even the implied warranty of
<span class="lineNum">      17 </span>            :  *  MERCHANTABILITY or FITNESS FOR A PARTICULAR PURPOSE.  See the
<span class="lineNum">      18 </span>            :  *  GNU Lesser General Public License for more details.
<span class="lineNum">      19 </span>            :  *
<span class="lineNum">      20 </span>            :  *  You should have received a copy of the GNU Lesser General Public
<span class="lineNum">      21 </span>            :  *  License along with this library; see the file COPYING.  If not, write to
<span class="lineNum">      22 </span>            :  *  the Free Software Foundation, 675 Mass Ave, Cambridge, MA 02139, USA.
<span class="lineNum">      23 </span>            :  *
<span class="lineNum">      24 </span>            :  */
<span class="lineNum">      25 </span>            : 
<span class="lineNum">      26 </span>            : 
<span class="lineNum">      27 </span>            : #include &lt;gpac/path2d.h&gt;
<a name="28"><span class="lineNum">      28 </span>            : </a>
<span class="lineNum">      29 </span>            : GF_EXPORT
<span class="lineNum">      30 </span>            : GF_Path *gf_path_new()
<span class="lineNum">      31 </span>            : {
<span class="lineNum">      32 </span>            :         GF_Path *gp;
<span class="lineNum">      33 </span><span class="lineNoCov">          0 :         GF_SAFEALLOC(gp, GF_Path);</span>
<span class="lineNum">      34 </span><span class="lineNoCov">          0 :         if (!gp) return NULL;</span>
<span class="lineNum">      35 </span><span class="lineNoCov">          0 :         gp-&gt;fineness = FIX_ONE;</span>
<span class="lineNum">      36 </span><span class="lineNoCov">          0 :         return gp;</span>
<span class="lineNum">      37 </span><span class="lineNoCov">          0 : }</span>
<a name="38"><span class="lineNum">      38 </span>            : </a>
<span class="lineNum">      39 </span>            : GF_EXPORT
<span class="lineNum">      40 </span>            : void gf_path_reset(GF_Path *gp)
<span class="lineNum">      41 </span>            : {
<span class="lineNum">      42 </span>            :         Fixed fineness;
<span class="lineNum">      43 </span>            :         u32 flags;
<span class="lineNum">      44 </span><span class="lineCov">      14452 :         if (!gp) return;</span>
<span class="lineNum">      45 </span><span class="lineCov">      14452 :         if (gp-&gt;contours) gf_free(gp-&gt;contours);</span>
<span class="lineNum">      46 </span><span class="lineCov">      14452 :         if (gp-&gt;tags) gf_free(gp-&gt;tags);</span>
<span class="lineNum">      47 </span><span class="lineCov">      14452 :         if (gp-&gt;points) gf_free(gp-&gt;points);</span>
<span class="lineNum">      48 </span><span class="lineCov">      28924 :         fineness = gp-&gt;fineness ? gp-&gt;fineness : FIX_ONE;</span>
<span class="lineNum">      49 </span><span class="lineCov">      14452 :         flags = gp-&gt;flags;</span>
<span class="lineNum">      50 </span><span class="lineCov">      14452 :         memset(gp, 0, sizeof(GF_Path));</span>
<span class="lineNum">      51 </span><span class="lineCov">      14452 :         gp-&gt;flags = flags | GF_PATH_FLATTENED | GF_PATH_BBOX_DIRTY;</span>
<span class="lineNum">      52 </span><span class="lineCov">      14452 :         gp-&gt;fineness = fineness;</span>
<span class="lineNum">      53 </span><span class="lineCov">      28904 : }</span>
<a name="54"><span class="lineNum">      54 </span>            : </a>
<span class="lineNum">      55 </span>            : GF_EXPORT
<span class="lineNum">      56 </span>            : GF_Path *gf_path_clone(GF_Path *gp)
<span class="lineNum">      57 </span>            : {
<span class="lineNum">      58 </span>            :         GF_Path *dst;
<span class="lineNum">      59 </span><span class="lineNoCov">          0 :         GF_SAFEALLOC(dst, GF_Path);</span>
<span class="lineNum">      60 </span><span class="lineNoCov">          0 :         if (!dst) return NULL;</span>
<span class="lineNum">      61 </span><span class="lineNoCov">          0 :         dst-&gt;contours = (u32 *)gf_malloc(sizeof(u32)*gp-&gt;n_contours);</span>
<span class="lineNum">      62 </span><span class="lineNoCov">          0 :         if (!dst-&gt;contours) {</span>
<span class="lineNum">      63 </span><span class="lineNoCov">          0 :                 gf_free(dst);</span>
<span class="lineNum">      64 </span><span class="lineNoCov">          0 :                 return NULL;</span>
<span class="lineNum">      65 </span>            :         }
<span class="lineNum">      66 </span><span class="lineNoCov">          0 :         dst-&gt;points = (GF_Point2D *) gf_malloc(sizeof(GF_Point2D)*gp-&gt;n_points);</span>
<span class="lineNum">      67 </span><span class="lineNoCov">          0 :         if (!dst-&gt;points) {</span>
<span class="lineNum">      68 </span><span class="lineNoCov">          0 :                 gf_free(dst-&gt;contours);</span>
<span class="lineNum">      69 </span><span class="lineNoCov">          0 :                 gf_free(dst);</span>
<span class="lineNum">      70 </span><span class="lineNoCov">          0 :                 return NULL;</span>
<span class="lineNum">      71 </span>            :         }
<span class="lineNum">      72 </span><span class="lineNoCov">          0 :         dst-&gt;tags = (u8 *) gf_malloc(sizeof(u8)*gp-&gt;n_points);</span>
<span class="lineNum">      73 </span><span class="lineNoCov">          0 :         if (!dst-&gt;tags) {</span>
<span class="lineNum">      74 </span><span class="lineNoCov">          0 :                 gf_free(dst-&gt;points);</span>
<span class="lineNum">      75 </span><span class="lineNoCov">          0 :                 gf_free(dst-&gt;contours);</span>
<span class="lineNum">      76 </span><span class="lineNoCov">          0 :                 gf_free(dst);</span>
<span class="lineNum">      77 </span><span class="lineNoCov">          0 :                 return NULL;</span>
<span class="lineNum">      78 </span>            :         }
<span class="lineNum">      79 </span><span class="lineNoCov">          0 :         memcpy(dst-&gt;contours, gp-&gt;contours, sizeof(u32)*gp-&gt;n_contours);</span>
<span class="lineNum">      80 </span><span class="lineNoCov">          0 :         dst-&gt;n_contours = gp-&gt;n_contours;</span>
<span class="lineNum">      81 </span><span class="lineNoCov">          0 :         memcpy(dst-&gt;points, gp-&gt;points, sizeof(GF_Point2D)*gp-&gt;n_points);</span>
<span class="lineNum">      82 </span><span class="lineNoCov">          0 :         memcpy(dst-&gt;tags, gp-&gt;tags, sizeof(u8)*gp-&gt;n_points);</span>
<span class="lineNum">      83 </span><span class="lineNoCov">          0 :         dst-&gt;n_alloc_points = dst-&gt;n_points = gp-&gt;n_points;</span>
<span class="lineNum">      84 </span><span class="lineNoCov">          0 :         dst-&gt;flags = gp-&gt;flags;</span>
<span class="lineNum">      85 </span><span class="lineNoCov">          0 :         dst-&gt;bbox = gp-&gt;bbox;</span>
<span class="lineNum">      86 </span><span class="lineNoCov">          0 :         dst-&gt;fineness = gp-&gt;fineness;</span>
<span class="lineNum">      87 </span><span class="lineNoCov">          0 :         return dst;</span>
<span class="lineNum">      88 </span><span class="lineNoCov">          0 : }</span>
<a name="89"><span class="lineNum">      89 </span>            : </a>
<span class="lineNum">      90 </span>            : GF_EXPORT
<span class="lineNum">      91 </span>            : void gf_path_del(GF_Path *gp)
<span class="lineNum">      92 </span>            : {
<span class="lineNum">      93 </span><span class="lineCov">      14432 :         if (!gp) return;</span>
<span class="lineNum">      94 </span><span class="lineCov">      28856 :         if (gp-&gt;contours) gf_free(gp-&gt;contours);</span>
<span class="lineNum">      95 </span><span class="lineCov">      28856 :         if (gp-&gt;tags) gf_free(gp-&gt;tags);</span>
<span class="lineNum">      96 </span><span class="lineCov">      28856 :         if (gp-&gt;points) gf_free(gp-&gt;points);</span>
<span class="lineNum">      97 </span><span class="lineCov">      14432 :         gf_free(gp);</span>
<span class="lineNum">      98 </span><span class="lineCov">      28864 : }</span>
<span class="lineNum">      99 </span>            : 
<span class="lineNum">     100 </span>            : #define GF_2D_REALLOC(_gp)      \
<span class="lineNum">     101 </span>            :         if (_gp-&gt;n_alloc_points &lt; _gp-&gt;n_points+3) {   \
<span class="lineNum">     102 </span>            :                 _gp-&gt;n_alloc_points = (_gp-&gt;n_alloc_points&lt;5) ? 10 : (_gp-&gt;n_alloc_points*3/2);     \
<span class="lineNum">     103 </span>            :                 _gp-&gt;points = (GF_Point2D *)gf_realloc(_gp-&gt;points, sizeof(GF_Point2D)*(_gp-&gt;n_alloc_points)); \
<span class="lineNum">     104 </span>            :                 _gp-&gt;tags = (u8 *) gf_realloc(_gp-&gt;tags, sizeof(u8)*(_gp-&gt;n_alloc_points));    \
<span class="lineNum">     105 </span>            :         }       \
<span class="lineNum">     106 </span>            :  
<a name="107"><span class="lineNum">     107 </span>            : </a>
<span class="lineNum">     108 </span>            : GF_EXPORT
<span class="lineNum">     109 </span>            : GF_Err gf_path_add_move_to(GF_Path *gp, Fixed x, Fixed y)
<span class="lineNum">     110 </span>            : {
<span class="lineNum">     111 </span><span class="lineCov">      14922 :         if (!gp) return GF_BAD_PARAM;</span>
<span class="lineNum">     112 </span>            : 
<span class="lineNum">     113 </span>            : #if 0
<span class="lineNum">     114 </span>            :         /*skip empty paths*/
<span class="lineNum">     115 </span>            :         if ((gp-&gt;n_contours&gt;=2) &amp;&amp; (gp-&gt;contours[gp-&gt;n_contours-2]+1==gp-&gt;contours[gp-&gt;n_contours-1])) {
<span class="lineNum">     116 </span>            :                 gp-&gt;points[gp-&gt;n_points].x = x;
<span class="lineNum">     117 </span>            :                 gp-&gt;points[gp-&gt;n_points].y = y;
<span class="lineNum">     118 </span>            :                 return GF_OK;
<span class="lineNum">     119 </span>            :         }
<span class="lineNum">     120 </span>            : #endif
<span class="lineNum">     121 </span>            : 
<span class="lineNum">     122 </span><span class="lineCov">      14922 :         gp-&gt;contours = (u32 *) gf_realloc(gp-&gt;contours, sizeof(u32)*(gp-&gt;n_contours+1));</span>
<span class="lineNum">     123 </span><span class="lineCov">      43938 :         GF_2D_REALLOC(gp)</span>
<span class="lineNum">     124 </span>            : 
<span class="lineNum">     125 </span><span class="lineCov">      14922 :         gp-&gt;points[gp-&gt;n_points].x = x;</span>
<span class="lineNum">     126 </span><span class="lineCov">      14922 :         gp-&gt;points[gp-&gt;n_points].y = y;</span>
<span class="lineNum">     127 </span><span class="lineCov">      14922 :         gp-&gt;tags[gp-&gt;n_points] = 1;</span>
<span class="lineNum">     128 </span>            :         /*set end point*/
<span class="lineNum">     129 </span><span class="lineCov">      14922 :         gp-&gt;contours[gp-&gt;n_contours] = gp-&gt;n_points;</span>
<span class="lineNum">     130 </span>            :         /*new contour*/
<span class="lineNum">     131 </span><span class="lineCov">      14922 :         gp-&gt;n_contours++;</span>
<span class="lineNum">     132 </span><span class="lineCov">      14922 :         gp-&gt;n_points++;</span>
<span class="lineNum">     133 </span><span class="lineCov">      14922 :         gp-&gt;flags |= GF_PATH_BBOX_DIRTY;</span>
<span class="lineNum">     134 </span><span class="lineCov">      14922 :         return GF_OK;</span>
<span class="lineNum">     135 </span><span class="lineCov">      14922 : }</span>
<a name="136"><span class="lineNum">     136 </span>            : </a>
<span class="lineNum">     137 </span>            : GF_EXPORT
<span class="lineNum">     138 </span>            : GF_Err gf_path_add_move_to_vec(GF_Path *gp, GF_Point2D *pt) {
<span class="lineNum">     139 </span><span class="lineCov">       7434 :         return gf_path_add_move_to(gp, pt-&gt;x, pt-&gt;y);</span>
<span class="lineNum">     140 </span>            : }
<a name="141"><span class="lineNum">     141 </span>            : </a>
<span class="lineNum">     142 </span>            : GF_EXPORT
<span class="lineNum">     143 </span>            : GF_Err gf_path_add_line_to(GF_Path *gp, Fixed x, Fixed y)
<span class="lineNum">     144 </span>            : {
<span class="lineNum">     145 </span><span class="lineCov">     221116 :         if (!gp || !gp-&gt;n_contours) return GF_BAD_PARAM;</span>
<span class="lineNum">     146 </span>            :         /*we allow line to same point as move (seen in SVG sequences) - striking will make a point*/
<span class="lineNum">     147 </span>            : 
<span class="lineNum">     148 </span><span class="lineCov">     135338 :         GF_2D_REALLOC(gp)</span>
<span class="lineNum">     149 </span><span class="lineCov">     110558 :         gp-&gt;points[gp-&gt;n_points].x = x;</span>
<span class="lineNum">     150 </span><span class="lineCov">     110558 :         gp-&gt;points[gp-&gt;n_points].y = y;</span>
<span class="lineNum">     151 </span><span class="lineCov">     110558 :         gp-&gt;tags[gp-&gt;n_points] = 1;</span>
<span class="lineNum">     152 </span>            :         /*set end point*/
<span class="lineNum">     153 </span><span class="lineCov">     110558 :         gp-&gt;contours[gp-&gt;n_contours-1] = gp-&gt;n_points;</span>
<span class="lineNum">     154 </span><span class="lineCov">     110558 :         gp-&gt;n_points++;</span>
<span class="lineNum">     155 </span><span class="lineCov">     110558 :         gp-&gt;flags |= GF_PATH_BBOX_DIRTY;</span>
<span class="lineNum">     156 </span><span class="lineCov">     110558 :         return GF_OK;</span>
<span class="lineNum">     157 </span><span class="lineCov">     110558 : }</span>
<a name="158"><span class="lineNum">     158 </span>            : </a>
<span class="lineNum">     159 </span>            : GF_EXPORT
<span class="lineNum">     160 </span>            : GF_Err gf_path_add_line_to_vec(GF_Path *gp, GF_Point2D *pt) {
<span class="lineNum">     161 </span><span class="lineCov">      49462 :         return gf_path_add_line_to(gp, pt-&gt;x, pt-&gt;y);</span>
<span class="lineNum">     162 </span>            : }
<a name="163"><span class="lineNum">     163 </span>            : </a>
<span class="lineNum">     164 </span>            : GF_EXPORT
<span class="lineNum">     165 </span>            : GF_Err gf_path_close(GF_Path *gp)
<span class="lineNum">     166 </span>            : {
<span class="lineNum">     167 </span>            :         Fixed diff;
<span class="lineNum">     168 </span>            :         GF_Point2D start, end;
<span class="lineNum">     169 </span><span class="lineCov">      25644 :         if (!gp || !gp-&gt;n_contours) return GF_BAD_PARAM;</span>
<span class="lineNum">     170 </span>            : 
<span class="lineNum">     171 </span><span class="lineCov">      25186 :         if (gp-&gt;n_contours&lt;=1) start = gp-&gt;points[0];</span>
<span class="lineNum">     172 </span><span class="lineCov">        458 :         else start = gp-&gt;points[gp-&gt;contours[gp-&gt;n_contours-2] + 1];</span>
<span class="lineNum">     173 </span><span class="lineCov">      12822 :         end = gp-&gt;points[gp-&gt;n_points-1];</span>
<span class="lineNum">     174 </span><span class="lineCov">      12822 :         end.x -= start.x;</span>
<span class="lineNum">     175 </span><span class="lineCov">      12822 :         end.y -= start.y;</span>
<span class="lineNum">     176 </span><span class="lineCov">      12822 :         diff = gf_mulfix(end.x, end.x) + gf_mulfix(end.y, end.y);</span>
<span class="lineNum">     177 </span><span class="lineCov">      27522 :         if (ABS(diff) &gt; FIX_ONE/1000) {</span>
<span class="lineNum">     178 </span><span class="lineCov">      10944 :                 GF_Err e = gf_path_add_line_to(gp, start.x, start.y);</span>
<span class="lineNum">     179 </span><span class="lineCov">      10944 :                 if (e) return e;</span>
<span class="lineNum">     180 </span>            :         }
<span class="lineNum">     181 </span><span class="lineCov">      12822 :         gp-&gt;tags[gp-&gt;n_points-1] = GF_PATH_CLOSE;</span>
<span class="lineNum">     182 </span><span class="lineCov">      12822 :         return GF_OK;</span>
<span class="lineNum">     183 </span><span class="lineCov">      12822 : }</span>
<a name="184"><span class="lineNum">     184 </span>            : </a>
<span class="lineNum">     185 </span>            : GF_EXPORT
<span class="lineNum">     186 </span>            : GF_Err gf_path_add_cubic_to(GF_Path *gp, Fixed c1_x, Fixed c1_y, Fixed c2_x, Fixed c2_y, Fixed x, Fixed y)
<span class="lineNum">     187 </span>            : {
<span class="lineNum">     188 </span><span class="lineCov">     129376 :         if (!gp || !gp-&gt;n_contours) return GF_BAD_PARAM;</span>
<span class="lineNum">     189 </span><span class="lineCov">      81368 :         GF_2D_REALLOC(gp)</span>
<span class="lineNum">     190 </span><span class="lineCov">      64688 :         gp-&gt;points[gp-&gt;n_points].x = c1_x;</span>
<span class="lineNum">     191 </span><span class="lineCov">      64688 :         gp-&gt;points[gp-&gt;n_points].y = c1_y;</span>
<span class="lineNum">     192 </span><span class="lineCov">      64688 :         gp-&gt;tags[gp-&gt;n_points] = GF_PATH_CURVE_CUBIC;</span>
<span class="lineNum">     193 </span><span class="lineCov">      64688 :         gp-&gt;n_points++;</span>
<span class="lineNum">     194 </span><span class="lineCov">      64688 :         gp-&gt;points[gp-&gt;n_points].x = c2_x;</span>
<span class="lineNum">     195 </span><span class="lineCov">      64688 :         gp-&gt;points[gp-&gt;n_points].y = c2_y;</span>
<span class="lineNum">     196 </span><span class="lineCov">      64688 :         gp-&gt;tags[gp-&gt;n_points] = GF_PATH_CURVE_CUBIC;</span>
<span class="lineNum">     197 </span><span class="lineCov">      64688 :         gp-&gt;n_points++;</span>
<span class="lineNum">     198 </span><span class="lineCov">      64688 :         gp-&gt;points[gp-&gt;n_points].x = x;</span>
<span class="lineNum">     199 </span><span class="lineCov">      64688 :         gp-&gt;points[gp-&gt;n_points].y = y;</span>
<span class="lineNum">     200 </span><span class="lineCov">      64688 :         gp-&gt;tags[gp-&gt;n_points] = GF_PATH_CURVE_ON;</span>
<span class="lineNum">     201 </span>            :         /*set end point*/
<span class="lineNum">     202 </span><span class="lineCov">      64688 :         gp-&gt;contours[gp-&gt;n_contours-1] = gp-&gt;n_points;</span>
<span class="lineNum">     203 </span><span class="lineCov">      64688 :         gp-&gt;n_points++;</span>
<span class="lineNum">     204 </span><span class="lineCov">      64688 :         gp-&gt;flags |= GF_PATH_BBOX_DIRTY;</span>
<span class="lineNum">     205 </span><span class="lineCov">      64688 :         gp-&gt;flags &amp;= ~GF_PATH_FLATTENED;</span>
<span class="lineNum">     206 </span><span class="lineCov">      64688 :         return GF_OK;</span>
<span class="lineNum">     207 </span><span class="lineCov">      64688 : }</span>
<a name="208"><span class="lineNum">     208 </span>            : </a>
<span class="lineNum">     209 </span>            : GF_EXPORT
<span class="lineNum">     210 </span>            : GF_Err gf_path_add_cubic_to_vec(GF_Path *gp, GF_Point2D *c1, GF_Point2D *c2, GF_Point2D *pt)
<span class="lineNum">     211 </span>            : {
<span class="lineNum">     212 </span><span class="lineCov">      32344 :         return gf_path_add_cubic_to(gp, c1-&gt;x, c1-&gt;y, c2-&gt;x, c2-&gt;y, pt-&gt;x, pt-&gt;y);</span>
<span class="lineNum">     213 </span>            : }
<span class="lineNum">     214 </span>            : 
<a name="215"><span class="lineNum">     215 </span>            : </a>
<span class="lineNum">     216 </span>            : GF_EXPORT
<span class="lineNum">     217 </span>            : GF_Err gf_path_add_quadratic_to(GF_Path *gp, Fixed c_x, Fixed c_y, Fixed x, Fixed y)
<span class="lineNum">     218 </span>            : {
<span class="lineNum">     219 </span><span class="lineCov">        232 :         if (!gp || !gp-&gt;n_contours) return GF_BAD_PARAM;</span>
<span class="lineNum">     220 </span><span class="lineCov">        188 :         GF_2D_REALLOC(gp)</span>
<span class="lineNum">     221 </span><span class="lineCov">        116 :         gp-&gt;points[gp-&gt;n_points].x = c_x;</span>
<span class="lineNum">     222 </span><span class="lineCov">        116 :         gp-&gt;points[gp-&gt;n_points].y = c_y;</span>
<span class="lineNum">     223 </span><span class="lineCov">        116 :         gp-&gt;tags[gp-&gt;n_points] = GF_PATH_CURVE_CONIC;</span>
<span class="lineNum">     224 </span><span class="lineCov">        116 :         gp-&gt;n_points++;</span>
<span class="lineNum">     225 </span><span class="lineCov">        116 :         gp-&gt;points[gp-&gt;n_points].x = x;</span>
<span class="lineNum">     226 </span><span class="lineCov">        116 :         gp-&gt;points[gp-&gt;n_points].y = y;</span>
<span class="lineNum">     227 </span><span class="lineCov">        116 :         gp-&gt;tags[gp-&gt;n_points] = GF_PATH_CURVE_ON;</span>
<span class="lineNum">     228 </span>            :         /*set end point*/
<span class="lineNum">     229 </span><span class="lineCov">        116 :         gp-&gt;contours[gp-&gt;n_contours-1] = gp-&gt;n_points;</span>
<span class="lineNum">     230 </span><span class="lineCov">        116 :         gp-&gt;n_points++;</span>
<span class="lineNum">     231 </span><span class="lineCov">        116 :         gp-&gt;flags |= GF_PATH_BBOX_DIRTY;</span>
<span class="lineNum">     232 </span><span class="lineCov">        116 :         gp-&gt;flags &amp;= ~GF_PATH_FLATTENED;</span>
<span class="lineNum">     233 </span><span class="lineCov">        116 :         return GF_OK;</span>
<a name="234"><span class="lineNum">     234 </span><span class="lineCov">        116 : }</span></a>
<span class="lineNum">     235 </span>            : GF_EXPORT
<span class="lineNum">     236 </span>            : GF_Err gf_path_add_quadratic_to_vec(GF_Path *gp, GF_Point2D *c, GF_Point2D *pt)
<span class="lineNum">     237 </span>            : {
<span class="lineNum">     238 </span><span class="lineCov">         58 :         return gf_path_add_quadratic_to(gp, c-&gt;x, c-&gt;y, pt-&gt;x, pt-&gt;y);</span>
<span class="lineNum">     239 </span>            : }
<span class="lineNum">     240 </span>            : 
<a name="241"><span class="lineNum">     241 </span>            : /*adds rectangle centered on cx, cy*/</a>
<span class="lineNum">     242 </span>            : GF_EXPORT
<span class="lineNum">     243 </span>            : GF_Err gf_path_add_rect_center(GF_Path *gp, Fixed cx, Fixed cy, Fixed w, Fixed h)
<span class="lineNum">     244 </span>            : {
<span class="lineNum">     245 </span><span class="lineNoCov">          0 :         GF_Err e = gf_path_add_move_to(gp, cx - w/2, cy - h/2);</span>
<span class="lineNum">     246 </span><span class="lineNoCov">          0 :         if (e) return e;</span>
<span class="lineNum">     247 </span><span class="lineNoCov">          0 :         e = gf_path_add_line_to(gp, cx + w/2, cy - h/2);</span>
<span class="lineNum">     248 </span><span class="lineNoCov">          0 :         if (e) return e;</span>
<span class="lineNum">     249 </span><span class="lineNoCov">          0 :         e = gf_path_add_line_to(gp, cx + w/2, cy + h/2);</span>
<span class="lineNum">     250 </span><span class="lineNoCov">          0 :         if (e) return e;</span>
<span class="lineNum">     251 </span><span class="lineNoCov">          0 :         e = gf_path_add_line_to(gp, cx - w/2, cy + h/2);</span>
<span class="lineNum">     252 </span><span class="lineNoCov">          0 :         if (e) return e;</span>
<span class="lineNum">     253 </span><span class="lineNoCov">          0 :         return gf_path_close(gp);</span>
<span class="lineNum">     254 </span><span class="lineNoCov">          0 : }</span>
<a name="255"><span class="lineNum">     255 </span>            : </a>
<span class="lineNum">     256 </span>            : GF_EXPORT
<span class="lineNum">     257 </span>            : GF_Err gf_path_add_rect(GF_Path *gp, Fixed ox, Fixed oy, Fixed w, Fixed h)
<span class="lineNum">     258 </span>            : {
<span class="lineNum">     259 </span><span class="lineNoCov">          0 :         GF_Err e = gf_path_add_move_to(gp, ox, oy);</span>
<span class="lineNum">     260 </span><span class="lineNoCov">          0 :         if (e) return e;</span>
<span class="lineNum">     261 </span><span class="lineNoCov">          0 :         e = gf_path_add_line_to(gp, ox + w, oy);</span>
<span class="lineNum">     262 </span><span class="lineNoCov">          0 :         if (e) return e;</span>
<span class="lineNum">     263 </span><span class="lineNoCov">          0 :         e = gf_path_add_line_to(gp, ox+w, oy-h);</span>
<span class="lineNum">     264 </span><span class="lineNoCov">          0 :         if (e) return e;</span>
<span class="lineNum">     265 </span><span class="lineNoCov">          0 :         e = gf_path_add_line_to(gp, ox, oy-h);</span>
<span class="lineNum">     266 </span><span class="lineNoCov">          0 :         if (e) return e;</span>
<span class="lineNum">     267 </span><span class="lineNoCov">          0 :         return gf_path_close(gp);</span>
<span class="lineNum">     268 </span><span class="lineNoCov">          0 : }</span>
<span class="lineNum">     269 </span>            : 
<span class="lineNum">     270 </span>            : #define GF_2D_DEFAULT_RES       64
<a name="271"><span class="lineNum">     271 </span>            : </a>
<span class="lineNum">     272 </span>            : GF_EXPORT
<span class="lineNum">     273 </span>            : GF_Err gf_path_add_ellipse(GF_Path *gp, Fixed cx, Fixed cy, Fixed a_axis, Fixed b_axis)
<span class="lineNum">     274 </span>            : {
<span class="lineNum">     275 </span>            :         GF_Err e;
<span class="lineNum">     276 </span>            :         Fixed _vx, _vy, cur;
<span class="lineNum">     277 </span>            :         u32 i;
<span class="lineNum">     278 </span><span class="lineNoCov">          0 :         a_axis /= 2;</span>
<span class="lineNum">     279 </span><span class="lineNoCov">          0 :         b_axis /= 2;</span>
<span class="lineNum">     280 </span><span class="lineNoCov">          0 :         e = gf_path_add_move_to(gp, cx+a_axis, cy);</span>
<span class="lineNum">     281 </span><span class="lineNoCov">          0 :         if (e) return e;</span>
<span class="lineNum">     282 </span><span class="lineNoCov">          0 :         for (i=1; i&lt;GF_2D_DEFAULT_RES; i++) {</span>
<span class="lineNum">     283 </span><span class="lineNoCov">          0 :                 cur = GF_2PI*i/GF_2D_DEFAULT_RES;</span>
<span class="lineNum">     284 </span><span class="lineNoCov">          0 :                 _vx = gf_mulfix(a_axis, gf_cos(cur) );</span>
<span class="lineNum">     285 </span><span class="lineNoCov">          0 :                 _vy = gf_mulfix(b_axis, gf_sin(cur) );</span>
<span class="lineNum">     286 </span><span class="lineNoCov">          0 :                 e = gf_path_add_line_to(gp, _vx + cx, _vy + cy);</span>
<span class="lineNum">     287 </span><span class="lineNoCov">          0 :                 if (e) return e;</span>
<span class="lineNum">     288 </span>            :         }
<span class="lineNum">     289 </span><span class="lineNoCov">          0 :         return gf_path_close(gp);</span>
<a name="290"><span class="lineNum">     290 </span><span class="lineNoCov">          0 : }</span></a>
<span class="lineNum">     291 </span>            : 
<span class="lineNum">     292 </span>            : GF_Err gf_path_add_subpath(GF_Path *gp, GF_Path *src, GF_Matrix2D *mx)
<span class="lineNum">     293 </span>            : {
<span class="lineNum">     294 </span>            :         u32 i;
<span class="lineNum">     295 </span><span class="lineNoCov">          0 :         if (!src) return GF_OK;</span>
<span class="lineNum">     296 </span><span class="lineNoCov">          0 :         gp-&gt;contours = (u32*)gf_realloc(gp-&gt;contours, sizeof(u32) * (gp-&gt;n_contours + src-&gt;n_contours));</span>
<span class="lineNum">     297 </span><span class="lineNoCov">          0 :         if (!gp-&gt;contours) return GF_OUT_OF_MEM;</span>
<span class="lineNum">     298 </span><span class="lineNoCov">          0 :         for (i=0; i&lt;src-&gt;n_contours; i++) {</span>
<span class="lineNum">     299 </span><span class="lineNoCov">          0 :                 gp-&gt;contours[i+gp-&gt;n_contours] = src-&gt;contours[i] + gp-&gt;n_points;</span>
<span class="lineNum">     300 </span>            :         }
<span class="lineNum">     301 </span><span class="lineNoCov">          0 :         gp-&gt;n_contours += src-&gt;n_contours;</span>
<span class="lineNum">     302 </span><span class="lineNoCov">          0 :         gp-&gt;n_alloc_points += src-&gt;n_alloc_points;</span>
<span class="lineNum">     303 </span><span class="lineNoCov">          0 :         gp-&gt;points = (GF_Point2D*)gf_realloc(gp-&gt;points, sizeof(GF_Point2D)*gp-&gt;n_alloc_points);</span>
<span class="lineNum">     304 </span><span class="lineNoCov">          0 :         if (!gp-&gt;points) return GF_OUT_OF_MEM;</span>
<span class="lineNum">     305 </span><span class="lineNoCov">          0 :         gp-&gt;tags = (u8*)gf_realloc(gp-&gt;tags, sizeof(u8)*gp-&gt;n_alloc_points);</span>
<span class="lineNum">     306 </span><span class="lineNoCov">          0 :         if (!gp-&gt;tags) return GF_OUT_OF_MEM;</span>
<span class="lineNum">     307 </span><span class="lineNoCov">          0 :         memcpy(gp-&gt;points + gp-&gt;n_points, src-&gt;points, sizeof(GF_Point2D)*src-&gt;n_points);</span>
<span class="lineNum">     308 </span><span class="lineNoCov">          0 :         if (mx) {</span>
<span class="lineNum">     309 </span><span class="lineNoCov">          0 :                 for (i=0; i&lt;src-&gt;n_points; i++) {</span>
<span class="lineNum">     310 </span><span class="lineNoCov">          0 :                         gf_mx2d_apply_coords(mx, &amp;gp-&gt;points[i+gp-&gt;n_points].x, &amp;gp-&gt;points[i+gp-&gt;n_points].y);</span>
<span class="lineNum">     311 </span>            :                 }
<span class="lineNum">     312 </span>            :         }
<span class="lineNum">     313 </span><span class="lineNoCov">          0 :         memcpy(gp-&gt;tags + gp-&gt;n_points, src-&gt;tags, sizeof(u8)*src-&gt;n_points);</span>
<span class="lineNum">     314 </span><span class="lineNoCov">          0 :         gp-&gt;n_points += src-&gt;n_points;</span>
<span class="lineNum">     315 </span><span class="lineNoCov">          0 :         gf_rect_union(&amp;gp-&gt;bbox, &amp;src-&gt;bbox);</span>
<span class="lineNum">     316 </span><span class="lineNoCov">          0 :         if (!(src-&gt;flags &amp; GF_PATH_FLATTENED)) gp-&gt;flags &amp;= ~GF_PATH_FLATTENED;</span>
<span class="lineNum">     317 </span><span class="lineNoCov">          0 :         if (src-&gt;flags &amp; GF_PATH_BBOX_DIRTY) gp-&gt;flags |= GF_PATH_BBOX_DIRTY;</span>
<span class="lineNum">     318 </span><span class="lineNoCov">          0 :         return GF_OK;</span>
<span class="lineNum">     319 </span><span class="lineNoCov">          0 : }</span>
<a name="320"><span class="lineNum">     320 </span>            : </a>
<span class="lineNum">     321 </span>            : /*generic N-bezier*/
<span class="lineNum">     322 </span>            : static void NBezier(GF_Point2D *pts, s32 n, Double mu, GF_Point2D *pt_out)
<span class="lineNum">     323 </span>            : {
<span class="lineNum">     324 </span>            :         s32 k,kn,nn,nkn;
<span class="lineNum">     325 </span>            :         Double blend, muk, munk;
<span class="lineNum">     326 </span><span class="lineNoCov">          0 :         pt_out-&gt;x = pt_out-&gt;y = 0;</span>
<span class="lineNum">     327 </span>            : 
<span class="lineNum">     328 </span>            :         muk = 1;
<span class="lineNum">     329 </span><span class="lineNoCov">          0 :         munk = pow(1-mu,(Double)n);</span>
<span class="lineNum">     330 </span><span class="lineNoCov">          0 :         for (k=0; k&lt;=n; k++) {</span>
<span class="lineNum">     331 </span>            :                 nn = n;
<span class="lineNum">     332 </span>            :                 kn = k;
<span class="lineNum">     333 </span><span class="lineNoCov">          0 :                 nkn = n - k;</span>
<span class="lineNum">     334 </span><span class="lineNoCov">          0 :                 blend = muk * munk;</span>
<span class="lineNum">     335 </span><span class="lineNoCov">          0 :                 muk *= mu;</span>
<span class="lineNum">     336 </span><span class="lineNoCov">          0 :                 munk /= (1-mu);</span>
<span class="lineNum">     337 </span><span class="lineNoCov">          0 :                 while (nn &gt;= 1) {</span>
<span class="lineNum">     338 </span><span class="lineNoCov">          0 :                         blend *= nn;</span>
<span class="lineNum">     339 </span><span class="lineNoCov">          0 :                         nn--;</span>
<span class="lineNum">     340 </span><span class="lineNoCov">          0 :                         if (kn &gt; 1) {</span>
<span class="lineNum">     341 </span><span class="lineNoCov">          0 :                                 blend /= (double)kn;</span>
<span class="lineNum">     342 </span><span class="lineNoCov">          0 :                                 kn--;</span>
<span class="lineNum">     343 </span><span class="lineNoCov">          0 :                         }</span>
<span class="lineNum">     344 </span><span class="lineNoCov">          0 :                         if (nkn &gt; 1) {</span>
<span class="lineNum">     345 </span><span class="lineNoCov">          0 :                                 blend /= (double)nkn;</span>
<span class="lineNum">     346 </span><span class="lineNoCov">          0 :                                 nkn--;</span>
<span class="lineNum">     347 </span><span class="lineNoCov">          0 :                         }</span>
<span class="lineNum">     348 </span>            :                 }
<span class="lineNum">     349 </span><span class="lineNoCov">          0 :                 pt_out-&gt;x += gf_mulfix(pts[k].x, FLT2FIX(blend));</span>
<span class="lineNum">     350 </span><span class="lineNoCov">          0 :                 pt_out-&gt;y += gf_mulfix(pts[k].y, FLT2FIX(blend));</span>
<span class="lineNum">     351 </span>            :         }
<a name="352"><span class="lineNum">     352 </span><span class="lineNoCov">          0 : }</span></a>
<span class="lineNum">     353 </span>            : 
<span class="lineNum">     354 </span>            : static void gf_add_n_bezier(GF_Path *gp, GF_Point2D *newpts, u32 nbPoints)
<span class="lineNum">     355 </span>            : {
<span class="lineNum">     356 </span>            :         Double mu;
<span class="lineNum">     357 </span>            :         u32 numPoints, i;
<span class="lineNum">     358 </span>            :         GF_Point2D end;
<span class="lineNum">     359 </span><span class="lineNoCov">          0 :         numPoints = (u32) FIX2INT(GF_2D_DEFAULT_RES * gp-&gt;fineness);</span>
<span class="lineNum">     360 </span>            :         mu = 0.0;
<span class="lineNum">     361 </span><span class="lineNoCov">          0 :         if (numPoints) mu = 1/(Double)numPoints;</span>
<span class="lineNum">     362 </span><span class="lineNoCov">          0 :         for (i=1; i&lt;numPoints; i++) {</span>
<span class="lineNum">     363 </span><span class="lineNoCov">          0 :                 NBezier(newpts, nbPoints - 1, i*mu, &amp;end);</span>
<span class="lineNum">     364 </span><span class="lineNoCov">          0 :                 gf_path_add_line_to(gp, end.x, end.y);</span>
<span class="lineNum">     365 </span>            :         }
<span class="lineNum">     366 </span><span class="lineNoCov">          0 :         gf_path_add_line_to(gp, newpts[nbPoints-1].x, newpts[nbPoints-1].y);</span>
<span class="lineNum">     367 </span><span class="lineNoCov">          0 : }</span>
<a name="368"><span class="lineNum">     368 </span>            : </a>
<span class="lineNum">     369 </span>            : GF_EXPORT
<span class="lineNum">     370 </span>            : GF_Err gf_path_add_bezier(GF_Path *gp, GF_Point2D *pts, u32 nbPoints)
<span class="lineNum">     371 </span>            : {
<span class="lineNum">     372 </span>            :         GF_Point2D *newpts;
<span class="lineNum">     373 </span><span class="lineNoCov">          0 :         if (!gp-&gt;n_points) return GF_BAD_PARAM;</span>
<span class="lineNum">     374 </span>            : 
<span class="lineNum">     375 </span><span class="lineNoCov">          0 :         newpts = (GF_Point2D *) gf_malloc(sizeof(GF_Point2D) * (nbPoints+1));</span>
<span class="lineNum">     376 </span><span class="lineNoCov">          0 :         newpts[0] = gp-&gt;points[gp-&gt;n_points-1];</span>
<span class="lineNum">     377 </span><span class="lineNoCov">          0 :         memcpy(&amp;newpts[1], pts, sizeof(GF_Point2D) * nbPoints);</span>
<span class="lineNum">     378 </span>            : 
<span class="lineNum">     379 </span><span class="lineNoCov">          0 :         gf_add_n_bezier(gp, newpts, nbPoints + 1);</span>
<span class="lineNum">     380 </span>            : 
<span class="lineNum">     381 </span><span class="lineNoCov">          0 :         gf_free(newpts);</span>
<span class="lineNum">     382 </span><span class="lineNoCov">          0 :         return GF_OK;</span>
<span class="lineNum">     383 </span><span class="lineNoCov">          0 : }</span>
<a name="384"><span class="lineNum">     384 </span>            : </a>
<span class="lineNum">     385 </span>            : GF_EXPORT
<span class="lineNum">     386 </span>            : GF_Err gf_path_add_arc_to(GF_Path *gp, Fixed end_x, Fixed end_y, Fixed fa_x, Fixed fa_y, Fixed fb_x, Fixed fb_y, Bool cw)
<span class="lineNum">     387 </span>            : {
<span class="lineNum">     388 </span>            :         GF_Matrix2D mat, inv;
<span class="lineNum">     389 </span>            :         Fixed angle, start_angle, end_angle, sweep, axis_w, axis_h, tmp, cx, cy, _vx, _vy, start_x, start_y;
<span class="lineNum">     390 </span>            :         s32 i, num_steps;
<span class="lineNum">     391 </span>            : 
<span class="lineNum">     392 </span><span class="lineNoCov">          0 :         if (!gp-&gt;n_points) return GF_BAD_PARAM;</span>
<span class="lineNum">     393 </span>            : 
<span class="lineNum">     394 </span><span class="lineNoCov">          0 :         start_x = gp-&gt;points[gp-&gt;n_points-1].x;</span>
<span class="lineNum">     395 </span><span class="lineNoCov">          0 :         start_y = gp-&gt;points[gp-&gt;n_points-1].y;</span>
<span class="lineNum">     396 </span>            : 
<span class="lineNum">     397 </span><span class="lineNoCov">          0 :         cx = (fb_x + fa_x)/2;</span>
<span class="lineNum">     398 </span><span class="lineNoCov">          0 :         cy = (fb_y + fa_y)/2;</span>
<span class="lineNum">     399 </span>            : 
<span class="lineNum">     400 </span><span class="lineNoCov">          0 :         angle = gf_atan2(fb_y-fa_y, fb_x-fa_x);</span>
<span class="lineNum">     401 </span><span class="lineNoCov">          0 :         gf_mx2d_init(mat);</span>
<span class="lineNum">     402 </span><span class="lineNoCov">          0 :         gf_mx2d_add_rotation(&amp;mat, 0, 0, angle);</span>
<span class="lineNum">     403 </span><span class="lineNoCov">          0 :         gf_mx2d_add_translation(&amp;mat, cx, cy);</span>
<span class="lineNum">     404 </span>            : 
<span class="lineNum">     405 </span><span class="lineNoCov">          0 :         gf_mx2d_copy(inv, mat);</span>
<span class="lineNum">     406 </span><span class="lineNoCov">          0 :         gf_mx2d_inverse(&amp;inv);</span>
<span class="lineNum">     407 </span><span class="lineNoCov">          0 :         gf_mx2d_apply_coords(&amp;inv, &amp;start_x, &amp;start_y);</span>
<span class="lineNum">     408 </span><span class="lineNoCov">          0 :         gf_mx2d_apply_coords(&amp;inv, &amp;end_x, &amp;end_y);</span>
<span class="lineNum">     409 </span><span class="lineNoCov">          0 :         gf_mx2d_apply_coords(&amp;inv, &amp;fa_x, &amp;fa_y);</span>
<span class="lineNum">     410 </span><span class="lineNoCov">          0 :         gf_mx2d_apply_coords(&amp;inv, &amp;fb_x, &amp;fb_y);</span>
<span class="lineNum">     411 </span>            : 
<span class="lineNum">     412 </span>            :         //start angle and end angle
<span class="lineNum">     413 </span><span class="lineNoCov">          0 :         start_angle = gf_atan2(start_y, start_x);</span>
<span class="lineNum">     414 </span><span class="lineNoCov">          0 :         end_angle = gf_atan2(end_y, end_x);</span>
<span class="lineNum">     415 </span><span class="lineNoCov">          0 :         tmp = gf_mulfix((start_x - fa_x), (start_x - fa_x)) + gf_mulfix((start_y - fa_y), (start_y - fa_y));</span>
<span class="lineNum">     416 </span><span class="lineNoCov">          0 :         axis_w = gf_sqrt(tmp);</span>
<span class="lineNum">     417 </span><span class="lineNoCov">          0 :         tmp = gf_mulfix((start_x - fb_x) , (start_x - fb_x)) + gf_mulfix((start_y - fb_y), (start_y - fb_y));</span>
<span class="lineNum">     418 </span><span class="lineNoCov">          0 :         axis_w += gf_sqrt(tmp);</span>
<span class="lineNum">     419 </span><span class="lineNoCov">          0 :         axis_w /= 2;</span>
<span class="lineNum">     420 </span><span class="lineNoCov">          0 :         axis_h = gf_sqrt(gf_mulfix(axis_w, axis_w) - gf_mulfix(fa_x,fa_x));</span>
<span class="lineNum">     421 </span><span class="lineNoCov">          0 :         sweep = end_angle - start_angle;</span>
<span class="lineNum">     422 </span>            : 
<span class="lineNum">     423 </span><span class="lineNoCov">          0 :         if (cw) {</span>
<span class="lineNum">     424 </span><span class="lineNoCov">          0 :                 if (sweep&gt;0) sweep -= 2*GF_PI;</span>
<span class="lineNum">     425 </span>            :         } else {
<span class="lineNum">     426 </span><span class="lineNoCov">          0 :                 if (sweep&lt;0) sweep += 2*GF_PI;</span>
<span class="lineNum">     427 </span>            :         }
<span class="lineNum">     428 </span>            :         num_steps = GF_2D_DEFAULT_RES/2;
<span class="lineNum">     429 </span><span class="lineNoCov">          0 :         for (i=1; i&lt;=num_steps; i++) {</span>
<span class="lineNum">     430 </span><span class="lineNoCov">          0 :                 angle = start_angle + sweep*i/num_steps;</span>
<span class="lineNum">     431 </span><span class="lineNoCov">          0 :                 _vx = gf_mulfix(axis_w, gf_cos(angle));</span>
<span class="lineNum">     432 </span><span class="lineNoCov">          0 :                 _vy = gf_mulfix(axis_h, gf_sin(angle));</span>
<span class="lineNum">     433 </span>            :                 /*re-invert*/
<span class="lineNum">     434 </span><span class="lineNoCov">          0 :                 gf_mx2d_apply_coords(&amp;mat, &amp;_vx, &amp;_vy);</span>
<span class="lineNum">     435 </span><span class="lineNoCov">          0 :                 gf_path_add_line_to(gp, _vx, _vy);</span>
<span class="lineNum">     436 </span>            :         }
<span class="lineNum">     437 </span><span class="lineNoCov">          0 :         return GF_OK;</span>
<span class="lineNum">     438 </span><span class="lineNoCov">          0 : }</span>
<span class="lineNum">     439 </span>            : 
<span class="lineNum">     440 </span>            : 
<a name="441"><span class="lineNum">     441 </span>            : </a>
<span class="lineNum">     442 </span>            : GF_EXPORT
<span class="lineNum">     443 </span>            : GF_Err gf_path_add_svg_arc_to(GF_Path *gp, Fixed end_x, Fixed end_y, Fixed r_x, Fixed r_y, Fixed x_axis_rotation, Bool large_arc_flag, Bool sweep_flag)
<span class="lineNum">     444 </span>            : {
<span class="lineNum">     445 </span>            :         Fixed start_x, start_y;
<span class="lineNum">     446 </span>            :         Fixed xmid,ymid;
<span class="lineNum">     447 </span>            :         Fixed xmidp,ymidp;
<span class="lineNum">     448 </span>            :         Fixed xmidpsq,ymidpsq;
<span class="lineNum">     449 </span>            :         Fixed phi, cos_phi, sin_phi;
<span class="lineNum">     450 </span>            :         Fixed c_x, c_y;
<span class="lineNum">     451 </span>            :         Fixed cxp, cyp;
<span class="lineNum">     452 </span>            :         Fixed scale;
<span class="lineNum">     453 </span>            :         Fixed rxsq, rysq;
<span class="lineNum">     454 </span>            :         Fixed start_angle, sweep_angle;
<span class="lineNum">     455 </span>            :         Fixed radius_scale;
<span class="lineNum">     456 </span>            :         Fixed vx, vy, normv;
<span class="lineNum">     457 </span>            :         Fixed ux, uy, normu;
<span class="lineNum">     458 </span>            :         Fixed sign;
<span class="lineNum">     459 </span>            :         u32 i, num_steps;
<span class="lineNum">     460 </span>            : 
<span class="lineNum">     461 </span><span class="lineNoCov">          0 :         if (!gp-&gt;n_points) return GF_BAD_PARAM;</span>
<span class="lineNum">     462 </span>            : 
<span class="lineNum">     463 </span><span class="lineNoCov">          0 :         if (!r_x || !r_y) {</span>
<span class="lineNum">     464 </span><span class="lineNoCov">          0 :                 gf_path_add_line_to(gp, end_x, end_y);</span>
<span class="lineNum">     465 </span><span class="lineNoCov">          0 :                 return GF_OK;</span>
<span class="lineNum">     466 </span>            :         }
<span class="lineNum">     467 </span>            : 
<span class="lineNum">     468 </span><span class="lineNoCov">          0 :         if (r_x &lt; 0) r_x = -r_x;</span>
<span class="lineNum">     469 </span><span class="lineNoCov">          0 :         if (r_y &lt; 0) r_y = -r_y;</span>
<span class="lineNum">     470 </span>            : 
<span class="lineNum">     471 </span><span class="lineNoCov">          0 :         start_x = gp-&gt;points[gp-&gt;n_points-1].x;</span>
<span class="lineNum">     472 </span><span class="lineNoCov">          0 :         start_y = gp-&gt;points[gp-&gt;n_points-1].y;</span>
<span class="lineNum">     473 </span>            : 
<span class="lineNum">     474 </span><span class="lineNoCov">          0 :         phi = gf_mulfix(x_axis_rotation/180, GF_PI);</span>
<span class="lineNum">     475 </span><span class="lineNoCov">          0 :         cos_phi = gf_cos(phi);</span>
<span class="lineNum">     476 </span><span class="lineNoCov">          0 :         sin_phi = gf_sin(phi);</span>
<span class="lineNum">     477 </span><span class="lineNoCov">          0 :         xmid = (start_x - end_x)/2;</span>
<span class="lineNum">     478 </span><span class="lineNoCov">          0 :         ymid = (start_y - end_y)/2;</span>
<span class="lineNum">     479 </span><span class="lineNoCov">          0 :         if (!xmid &amp;&amp; !ymid) {</span>
<span class="lineNum">     480 </span><span class="lineNoCov">          0 :                 gf_path_add_line_to(gp, end_x, end_y);</span>
<span class="lineNum">     481 </span><span class="lineNoCov">          0 :                 return GF_OK;</span>
<span class="lineNum">     482 </span>            :         }
<span class="lineNum">     483 </span>            : 
<span class="lineNum">     484 </span><span class="lineNoCov">          0 :         xmidp = gf_mulfix(cos_phi, xmid) + gf_mulfix(sin_phi, ymid);</span>
<span class="lineNum">     485 </span><span class="lineNoCov">          0 :         ymidp = gf_mulfix(-sin_phi, xmid) + gf_mulfix(cos_phi, ymid);</span>
<span class="lineNum">     486 </span><span class="lineNoCov">          0 :         xmidpsq = gf_mulfix(xmidp, xmidp);</span>
<span class="lineNum">     487 </span><span class="lineNoCov">          0 :         ymidpsq = gf_mulfix(ymidp, ymidp);</span>
<span class="lineNum">     488 </span>            : 
<span class="lineNum">     489 </span><span class="lineNoCov">          0 :         rxsq = gf_mulfix(r_x, r_x);</span>
<span class="lineNum">     490 </span><span class="lineNoCov">          0 :         rysq = gf_mulfix(r_y, r_y);</span>
<span class="lineNum">     491 </span>            :         assert(rxsq &amp;&amp; rxsq);
<span class="lineNum">     492 </span>            : 
<span class="lineNum">     493 </span><span class="lineNoCov">          0 :         radius_scale = gf_divfix(xmidpsq, rxsq) + gf_divfix(ymidpsq, rysq);</span>
<span class="lineNum">     494 </span><span class="lineNoCov">          0 :         if (radius_scale &gt; FIX_ONE) {</span>
<span class="lineNum">     495 </span><span class="lineNoCov">          0 :                 r_x = gf_mulfix(gf_sqrt(radius_scale), r_x);</span>
<span class="lineNum">     496 </span><span class="lineNoCov">          0 :                 r_y = gf_mulfix(gf_sqrt(radius_scale), r_y);</span>
<span class="lineNum">     497 </span><span class="lineNoCov">          0 :                 rxsq = gf_mulfix(r_x, r_x);</span>
<span class="lineNum">     498 </span><span class="lineNoCov">          0 :                 rysq = gf_mulfix(r_y, r_y);</span>
<span class="lineNum">     499 </span><span class="lineNoCov">          0 :         }</span>
<span class="lineNum">     500 </span>            : 
<span class="lineNum">     501 </span>            : #if 0
<span class="lineNum">     502 </span>            :         /* Old code with overflow problems in fixed point,
<span class="lineNum">     503 </span>            :            sign was sometimes negative (cf tango SVG icons appointment-new.svg)*/
<span class="lineNum">     504 </span>            : 
<span class="lineNum">     505 </span>            :         sign = gf_mulfix(rxsq,ymidpsq) + gf_mulfix(rysq, xmidpsq);
<span class="lineNum">     506 </span>            :         scale = FIX_ONE;
<span class="lineNum">     507 </span>            :         /*FIXME - what if scale is 0 ??*/
<span class="lineNum">     508 </span>            :         if (sign) scale = gf_divfix(
<span class="lineNum">     509 </span>            :                                       (gf_mulfix(rxsq,rysq) - gf_mulfix(rxsq, ymidpsq) - gf_mulfix(rysq,xmidpsq)),
<span class="lineNum">     510 </span>            :                                       sign
<span class="lineNum">     511 </span>            :                                   );
<span class="lineNum">     512 </span>            : #else
<span class="lineNum">     513 </span>            :         /* New code: the sign variable computation is split into simpler cases and
<span class="lineNum">     514 </span>            :            the expression is divided by rxsq to reduce the range */
<span class="lineNum">     515 </span><span class="lineNoCov">          0 :         if ((rxsq == 0 || ymidpsq ==0) &amp;&amp; (rysq == 0 || xmidpsq == 0)) {</span>
<span class="lineNum">     516 </span>            :                 scale = FIX_ONE;
<span class="lineNum">     517 </span><span class="lineNoCov">          0 :         } else if (rxsq == 0 || ymidpsq ==0) {</span>
<span class="lineNum">     518 </span><span class="lineNoCov">          0 :                 scale = gf_divfix(rxsq,xmidpsq) - FIX_ONE;</span>
<span class="lineNum">     519 </span><span class="lineNoCov">          0 :         } else if (rysq == 0 || xmidpsq == 0) {</span>
<span class="lineNum">     520 </span><span class="lineNoCov">          0 :                 scale = gf_divfix(rysq,ymidpsq) - FIX_ONE;</span>
<span class="lineNum">     521 </span><span class="lineNoCov">          0 :         } else {</span>
<span class="lineNum">     522 </span>            :                 Fixed tmp;
<span class="lineNum">     523 </span><span class="lineNoCov">          0 :                 tmp = gf_mulfix(gf_divfix(rysq, rxsq), xmidpsq);</span>
<span class="lineNum">     524 </span><span class="lineNoCov">          0 :                 sign = ymidpsq + tmp;</span>
<span class="lineNum">     525 </span><span class="lineNoCov">          0 :                 scale = gf_divfix((rysq - ymidpsq - tmp),sign);</span>
<span class="lineNum">     526 </span>            :         }
<span class="lineNum">     527 </span>            : #endif
<span class="lineNum">     528 </span>            :         /* precision problem may lead to negative value around zero, we need to take care of it before sqrt */
<span class="lineNum">     529 </span><span class="lineNoCov">          0 :         scale = gf_sqrt(ABS(scale));</span>
<span class="lineNum">     530 </span>            : 
<span class="lineNum">     531 </span><span class="lineNoCov">          0 :         cxp = gf_mulfix(scale, gf_divfix(gf_mulfix(r_x, ymidp),r_y));</span>
<span class="lineNum">     532 </span><span class="lineNoCov">          0 :         cyp = gf_mulfix(scale, -gf_divfix(gf_mulfix(r_y, xmidp),r_x));</span>
<span class="lineNum">     533 </span><span class="lineNoCov">          0 :         cxp = (large_arc_flag == sweep_flag ? - cxp : cxp);</span>
<span class="lineNum">     534 </span><span class="lineNoCov">          0 :         cyp = (large_arc_flag == sweep_flag ? - cyp : cyp);</span>
<span class="lineNum">     535 </span>            : 
<span class="lineNum">     536 </span><span class="lineNoCov">          0 :         c_x = gf_mulfix(cos_phi, cxp) - gf_mulfix(sin_phi, cyp) + (start_x + end_x)/2;</span>
<span class="lineNum">     537 </span><span class="lineNoCov">          0 :         c_y = gf_mulfix(sin_phi, cxp) + gf_mulfix(cos_phi, cyp) + (start_y + end_y)/2;</span>
<span class="lineNum">     538 </span>            : 
<span class="lineNum">     539 </span><span class="lineNoCov">          0 :         vx = gf_divfix(xmidp-cxp,r_x);</span>
<span class="lineNum">     540 </span><span class="lineNoCov">          0 :         vy = gf_divfix(ymidp-cyp,r_y);</span>
<span class="lineNum">     541 </span><span class="lineNoCov">          0 :         normv = gf_sqrt(gf_mulfix(vx, vx) + gf_mulfix(vy,vy));</span>
<span class="lineNum">     542 </span>            : 
<span class="lineNum">     543 </span>            :         sign = vy;
<span class="lineNum">     544 </span><span class="lineNoCov">          0 :         start_angle = gf_acos(gf_divfix(vx,normv));</span>
<span class="lineNum">     545 </span><span class="lineNoCov">          0 :         start_angle = (sign &gt; 0 ? start_angle: -start_angle);</span>
<span class="lineNum">     546 </span>            : 
<span class="lineNum">     547 </span>            :         ux = vx;
<span class="lineNum">     548 </span>            :         uy = vy;
<span class="lineNum">     549 </span>            : 
<span class="lineNum">     550 </span><span class="lineNoCov">          0 :         vx = gf_divfix(-xmidp-cxp,r_x);</span>
<span class="lineNum">     551 </span><span class="lineNoCov">          0 :         vy = gf_divfix(-ymidp-cyp,r_y);</span>
<span class="lineNum">     552 </span>            :         normu = gf_sqrt(gf_mulfix(ux, ux) + gf_mulfix(uy,uy));
<span class="lineNum">     553 </span>            : 
<span class="lineNum">     554 </span><span class="lineNoCov">          0 :         sign = gf_mulfix(ux, vy) - gf_mulfix(uy, vx);</span>
<span class="lineNum">     555 </span><span class="lineNoCov">          0 :         sweep_angle = gf_divfix( gf_mulfix(ux,vx) + gf_mulfix(uy, vy), gf_mulfix(normu, normv) );</span>
<span class="lineNum">     556 </span>            :         /*numerical stability safety*/
<span class="lineNum">     557 </span><span class="lineNoCov">          0 :         sweep_angle = MAX(-FIX_ONE, MIN(sweep_angle, FIX_ONE));</span>
<span class="lineNum">     558 </span><span class="lineNoCov">          0 :         sweep_angle = gf_acos(sweep_angle);</span>
<span class="lineNum">     559 </span><span class="lineNoCov">          0 :         sweep_angle = (sign &gt; 0 ? sweep_angle: -sweep_angle);</span>
<span class="lineNum">     560 </span><span class="lineNoCov">          0 :         if (sweep_flag == 0) {</span>
<span class="lineNum">     561 </span><span class="lineNoCov">          0 :                 if (sweep_angle &gt; 0) sweep_angle -= GF_2PI;</span>
<span class="lineNum">     562 </span>            :         } else {
<span class="lineNum">     563 </span><span class="lineNoCov">          0 :                 if (sweep_angle &lt; 0) sweep_angle += GF_2PI;</span>
<span class="lineNum">     564 </span>            :         }
<span class="lineNum">     565 </span>            : 
<span class="lineNum">     566 </span>            :         num_steps = GF_2D_DEFAULT_RES/2;
<span class="lineNum">     567 </span><span class="lineNoCov">          0 :         for (i=1; i&lt;=num_steps; i++) {</span>
<span class="lineNum">     568 </span>            :                 Fixed _vx, _vy;
<span class="lineNum">     569 </span>            :                 Fixed _vxp, _vyp;
<span class="lineNum">     570 </span><span class="lineNoCov">          0 :                 Fixed angle = start_angle + sweep_angle*(s32)i/(s32)num_steps;</span>
<span class="lineNum">     571 </span><span class="lineNoCov">          0 :                 _vx = gf_mulfix(r_x, gf_cos(angle));</span>
<span class="lineNum">     572 </span><span class="lineNoCov">          0 :                 _vy = gf_mulfix(r_y, gf_sin(angle));</span>
<span class="lineNum">     573 </span><span class="lineNoCov">          0 :                 _vxp = gf_mulfix(cos_phi, _vx) - gf_mulfix(sin_phi, _vy) + c_x;</span>
<span class="lineNum">     574 </span><span class="lineNoCov">          0 :                 _vyp = gf_mulfix(sin_phi, _vx) + gf_mulfix(cos_phi, _vy) + c_y;</span>
<span class="lineNum">     575 </span><span class="lineNoCov">          0 :                 gf_path_add_line_to(gp, _vxp, _vyp);</span>
<span class="lineNum">     576 </span>            :         }
<span class="lineNum">     577 </span><span class="lineNoCov">          0 :         return GF_OK;</span>
<span class="lineNum">     578 </span><span class="lineNoCov">          0 : }</span>
<a name="579"><span class="lineNum">     579 </span>            : </a>
<span class="lineNum">     580 </span>            : GF_EXPORT
<span class="lineNum">     581 </span>            : GF_Err gf_path_add_arc(GF_Path *gp, Fixed radius, Fixed start_angle, Fixed end_angle, u32 close_type)
<span class="lineNum">     582 </span>            : {
<span class="lineNum">     583 </span>            :         GF_Err e;
<span class="lineNum">     584 </span>            :         Fixed _vx, _vy, step, cur;
<span class="lineNum">     585 </span>            :         s32 i, do_run;
<span class="lineNum">     586 </span>            : 
<span class="lineNum">     587 </span><span class="lineNoCov">          0 :         step = (end_angle - start_angle) / (GF_2D_DEFAULT_RES);</span>
<span class="lineNum">     588 </span><span class="lineNoCov">          0 :         radius *= 2;</span>
<span class="lineNum">     589 </span>            : 
<span class="lineNum">     590 </span>            :         /*pie*/
<span class="lineNum">     591 </span>            :         i=0;
<span class="lineNum">     592 </span><span class="lineNoCov">          0 :         if (close_type==2) {</span>
<span class="lineNum">     593 </span><span class="lineNoCov">          0 :                 gf_path_add_move_to(gp, 0, 0);</span>
<span class="lineNum">     594 </span>            :                 i=1;
<span class="lineNum">     595 </span><span class="lineNoCov">          0 :         }</span>
<span class="lineNum">     596 </span>            :         do_run = 1;
<span class="lineNum">     597 </span>            :         cur=start_angle;
<span class="lineNum">     598 </span><span class="lineNoCov">          0 :         while (do_run) {</span>
<span class="lineNum">     599 </span><span class="lineNoCov">          0 :                 if (cur&gt;=end_angle) {</span>
<span class="lineNum">     600 </span>            :                         do_run = 0;
<span class="lineNum">     601 </span>            :                         cur = end_angle;
<span class="lineNum">     602 </span><span class="lineNoCov">          0 :                 }</span>
<span class="lineNum">     603 </span><span class="lineNoCov">          0 :                 _vx = gf_mulfix(radius, gf_cos(cur));</span>
<span class="lineNum">     604 </span><span class="lineNoCov">          0 :                 _vy = gf_mulfix(radius, gf_sin(cur));</span>
<span class="lineNum">     605 </span><span class="lineNoCov">          0 :                 if (!i) {</span>
<span class="lineNum">     606 </span><span class="lineNoCov">          0 :                         e = gf_path_add_move_to(gp, _vx, _vy);</span>
<span class="lineNum">     607 </span>            :                         i = 1;
<span class="lineNum">     608 </span><span class="lineNoCov">          0 :                 } else {</span>
<span class="lineNum">     609 </span><span class="lineNoCov">          0 :                         e = gf_path_add_line_to(gp, _vx, _vy);</span>
<span class="lineNum">     610 </span>            :                 }
<span class="lineNum">     611 </span><span class="lineNoCov">          0 :                 if (e) return e;</span>
<span class="lineNum">     612 </span><span class="lineNoCov">          0 :                 cur+=step;</span>
<span class="lineNum">     613 </span><span class="lineNoCov">          0 :         }</span>
<span class="lineNum">     614 </span><span class="lineNoCov">          0 :         if (close_type) e = gf_path_close(gp);</span>
<span class="lineNum">     615 </span><span class="lineNoCov">          0 :         return e;</span>
<span class="lineNum">     616 </span><span class="lineNoCov">          0 : }</span>
<span class="lineNum">     617 </span>            : 
<a name="618"><span class="lineNum">     618 </span>            : </a>
<span class="lineNum">     619 </span>            : GF_EXPORT
<span class="lineNum">     620 </span>            : GF_Err gf_path_get_control_bounds(GF_Path *gp, GF_Rect *rc)
<span class="lineNum">     621 </span>            : {
<span class="lineNum">     622 </span>            :         GF_Point2D *pt, *end;
<span class="lineNum">     623 </span>            :         Fixed xMin, xMax, yMin, yMax;
<span class="lineNum">     624 </span><span class="lineNoCov">          0 :         if (!gp || !rc) return GF_BAD_PARAM;</span>
<span class="lineNum">     625 </span>            : 
<span class="lineNum">     626 </span><span class="lineNoCov">          0 :         if (!gp-&gt;n_points) {</span>
<span class="lineNum">     627 </span><span class="lineNoCov">          0 :                 rc-&gt;x = rc-&gt;y = rc-&gt;width = rc-&gt;height = 0;</span>
<span class="lineNum">     628 </span><span class="lineNoCov">          0 :                 return GF_OK;</span>
<span class="lineNum">     629 </span>            :         }
<span class="lineNum">     630 </span><span class="lineNoCov">          0 :         pt = gp-&gt;points;</span>
<span class="lineNum">     631 </span><span class="lineNoCov">          0 :         end = pt + gp-&gt;n_points;</span>
<span class="lineNum">     632 </span><span class="lineNoCov">          0 :         xMin = xMax = pt-&gt;x;</span>
<span class="lineNum">     633 </span><span class="lineNoCov">          0 :         yMin = yMax = pt-&gt;y;</span>
<span class="lineNum">     634 </span><span class="lineNoCov">          0 :         pt++;</span>
<span class="lineNum">     635 </span><span class="lineNoCov">          0 :         for ( ; pt &lt; end; pt++ ) {</span>
<span class="lineNum">     636 </span>            :                 Fixed v;
<span class="lineNum">     637 </span><span class="lineNoCov">          0 :                 v = pt-&gt;x;</span>
<span class="lineNum">     638 </span><span class="lineNoCov">          0 :                 if (v &lt; xMin) xMin = v;</span>
<span class="lineNum">     639 </span><span class="lineNoCov">          0 :                 if (v &gt; xMax) xMax = v;</span>
<span class="lineNum">     640 </span><span class="lineNoCov">          0 :                 v = pt-&gt;y;</span>
<span class="lineNum">     641 </span><span class="lineNoCov">          0 :                 if (v &lt; yMin) yMin = v;</span>
<span class="lineNum">     642 </span><span class="lineNoCov">          0 :                 if (v &gt; yMax) yMax = v;</span>
<span class="lineNum">     643 </span>            :         }
<span class="lineNum">     644 </span><span class="lineNoCov">          0 :         rc-&gt;x = xMin;</span>
<span class="lineNum">     645 </span><span class="lineNoCov">          0 :         rc-&gt;y = yMax;</span>
<span class="lineNum">     646 </span><span class="lineNoCov">          0 :         rc-&gt;width = xMax - xMin;</span>
<span class="lineNum">     647 </span><span class="lineNoCov">          0 :         rc-&gt;height = yMax - yMin;</span>
<span class="lineNum">     648 </span>            : 
<span class="lineNum">     649 </span>            : #if 0
<span class="lineNum">     650 </span>            :         /*take care of straight line path by adding a default width if height and vice-versa*/
<span class="lineNum">     651 </span>            :         if (rc-&gt;height &amp;&amp; !rc-&gt;width) {
<span class="lineNum">     652 </span>            :                 rc-&gt;width = 2*FIX_ONE;
<span class="lineNum">     653 </span>            :                 rc-&gt;x -= FIX_ONE;
<span class="lineNum">     654 </span>            :         }
<span class="lineNum">     655 </span>            :         else if (!rc-&gt;height &amp;&amp; rc-&gt;width) {
<span class="lineNum">     656 </span>            :                 rc-&gt;height = 2*FIX_ONE;
<span class="lineNum">     657 </span>            :                 rc-&gt;y += FIX_ONE;
<span class="lineNum">     658 </span>            :         }
<span class="lineNum">     659 </span>            : #endif
<span class="lineNum">     660 </span><span class="lineNoCov">          0 :         return GF_OK;</span>
<span class="lineNum">     661 </span><span class="lineNoCov">          0 : }</span>
<span class="lineNum">     662 </span>            : 
<span class="lineNum">     663 </span>            : /*
<span class="lineNum">     664 </span>            :  *      conic bbox computing taken from freetype
<span class="lineNum">     665 </span>            :  *              Copyright 1996-2001, 2002, 2004 by
<span class="lineNum">     666 </span>            :  *              David Turner, Robert Wilhelm, and Werner Lemberg.
<a name="667"><span class="lineNum">     667 </span>            :  *      License: FTL or GPL</a>
<span class="lineNum">     668 </span>            :  */
<span class="lineNum">     669 </span>            : static void gf_conic_check(Fixed y1, Fixed y2, Fixed y3, Fixed *min, Fixed *max)
<span class="lineNum">     670 </span>            : {
<span class="lineNum">     671 </span>            :         /* flat arc */
<span class="lineNum">     672 </span><span class="lineNoCov">          0 :         if ((y1 &lt;= y3) &amp;&amp; (y2 == y1)) goto Suite;</span>
<span class="lineNum">     673 </span>            : 
<span class="lineNum">     674 </span><span class="lineNoCov">          0 :         if ( y1 &lt; y3 ) {</span>
<span class="lineNum">     675 </span>            :                 /* ascending arc */
<span class="lineNum">     676 </span><span class="lineNoCov">          0 :                 if ((y2 &gt;= y1) &amp;&amp; (y2 &lt;= y3)) goto Suite;</span>
<span class="lineNum">     677 </span>            :         } else {
<span class="lineNum">     678 </span>            :                 /* descending arc */
<span class="lineNum">     679 </span><span class="lineNoCov">          0 :                 if ((y2 &gt;= y3) &amp;&amp; (y2 &lt;= y1)) {</span>
<span class="lineNum">     680 </span>            :                         y2 = y1;
<span class="lineNum">     681 </span>            :                         y1 = y3;
<span class="lineNum">     682 </span>            :                         y3 = y2;
<span class="lineNum">     683 </span><span class="lineNoCov">          0 :                         goto Suite;</span>
<span class="lineNum">     684 </span>            :                 }
<span class="lineNum">     685 </span>            :         }
<span class="lineNum">     686 </span><span class="lineNoCov">          0 :         y1 = y3 = y1 - gf_muldiv(y2 - y1, y2 - y1, y1 - 2*y2 + y3);</span>
<span class="lineNum">     687 </span>            : 
<span class="lineNum">     688 </span>            : Suite:
<span class="lineNum">     689 </span><span class="lineNoCov">          0 :         if ( y1 &lt; *min ) *min = y1;</span>
<span class="lineNum">     690 </span><span class="lineNoCov">          0 :         if ( y3 &gt; *max ) *max = y3;</span>
<span class="lineNum">     691 </span><span class="lineNoCov">          0 : }</span>
<span class="lineNum">     692 </span>            : 
<span class="lineNum">     693 </span>            : 
<span class="lineNum">     694 </span>            : /*
<span class="lineNum">     695 </span>            :  *      cubic bbox computing taken from freetype
<span class="lineNum">     696 </span>            :  *              Copyright 1996-2001, 2002, 2004 by
<span class="lineNum">     697 </span>            :  *              David Turner, Robert Wilhelm, and Werner Lemberg.
<span class="lineNum">     698 </span>            :  *      License: FTL or GPL
<span class="lineNum">     699 </span>            : 
<a name="700"><span class="lineNum">     700 </span>            :  *      Note: we're using the decomposition method, not the equation one which is not usable with Floats (only 16.16 fixed)</a>
<span class="lineNum">     701 </span>            : */
<span class="lineNum">     702 </span>            : static void gf_cubic_check(Fixed p1, Fixed p2, Fixed p3, Fixed p4, Fixed *min, Fixed *max)
<span class="lineNum">     703 </span>            : {
<span class="lineNum">     704 </span><span class="lineNoCov">          0 :         Fixed stack[32*3 + 1], *arc;</span>
<span class="lineNum">     705 </span><span class="lineNoCov">          0 :         arc = stack;</span>
<span class="lineNum">     706 </span><span class="lineNoCov">          0 :         arc[0] = p1;</span>
<span class="lineNum">     707 </span><span class="lineNoCov">          0 :         arc[1] = p2;</span>
<span class="lineNum">     708 </span><span class="lineNoCov">          0 :         arc[2] = p3;</span>
<span class="lineNum">     709 </span><span class="lineNoCov">          0 :         arc[3] = p4;</span>
<span class="lineNum">     710 </span>            : 
<span class="lineNum">     711 </span><span class="lineNoCov">          0 :         do {</span>
<span class="lineNum">     712 </span><span class="lineNoCov">          0 :                 Fixed y1 = arc[0];</span>
<span class="lineNum">     713 </span><span class="lineNoCov">          0 :                 Fixed y2 = arc[1];</span>
<span class="lineNum">     714 </span><span class="lineNoCov">          0 :                 Fixed y3 = arc[2];</span>
<span class="lineNum">     715 </span><span class="lineNoCov">          0 :                 Fixed y4 = arc[3];</span>
<span class="lineNum">     716 </span>            : 
<span class="lineNum">     717 </span><span class="lineNoCov">          0 :                 if (ABS(y1)&lt;FIX_EPSILON) arc[0] = y1 = 0;</span>
<span class="lineNum">     718 </span><span class="lineNoCov">          0 :                 if (ABS(y2)&lt;FIX_EPSILON) arc[1] = y2 = 0;</span>
<span class="lineNum">     719 </span><span class="lineNoCov">          0 :                 if (ABS(y3)&lt;FIX_EPSILON) arc[2] = y3 = 0;</span>
<span class="lineNum">     720 </span><span class="lineNoCov">          0 :                 if (ABS(y4)&lt;FIX_EPSILON) arc[3] = y4 = 0;</span>
<span class="lineNum">     721 </span>            : 
<span class="lineNum">     722 </span><span class="lineNoCov">          0 :                 if ( y1 == y4 ) {</span>
<span class="lineNum">     723 </span>            :                         /* flat */
<span class="lineNum">     724 </span><span class="lineNoCov">          0 :                         if ((y1 == y2) &amp;&amp; (y1 == y3)) goto Test;</span>
<span class="lineNum">     725 </span>            :                 }
<span class="lineNum">     726 </span><span class="lineNoCov">          0 :                 else if ( y1 &lt; y4 ) {</span>
<span class="lineNum">     727 </span>            :                         /* ascending */
<span class="lineNum">     728 </span><span class="lineNoCov">          0 :                         if ((y2 &gt;= y1) &amp;&amp; (y2 &lt;= y4) &amp;&amp; (y3 &gt;= y1) &amp;&amp; (y3 &lt;= y4)) goto Test;</span>
<span class="lineNum">     729 </span>            :                 } else {
<span class="lineNum">     730 </span>            :                         /* descending */
<span class="lineNum">     731 </span><span class="lineNoCov">          0 :                         if ((y2 &gt;= y4) &amp;&amp; (y2 &lt;= y1) &amp;&amp; (y3 &gt;= y4) &amp;&amp; (y3 &lt;= y1)) {</span>
<span class="lineNum">     732 </span>            :                                 y2 = y1;
<span class="lineNum">     733 </span>            :                                 y1 = y4;
<span class="lineNum">     734 </span>            :                                 y4 = y2;
<span class="lineNum">     735 </span><span class="lineNoCov">          0 :                                 goto Test;</span>
<span class="lineNum">     736 </span>            :                         }
<span class="lineNum">     737 </span>            :                 }
<span class="lineNum">     738 </span>            :                 /* unknown direction -- split the arc in two */
<span class="lineNum">     739 </span><span class="lineNoCov">          0 :                 arc[6] = y4;</span>
<span class="lineNum">     740 </span><span class="lineNoCov">          0 :                 arc[1] = y1 = ( y1 + y2 ) / 2;</span>
<span class="lineNum">     741 </span><span class="lineNoCov">          0 :                 arc[5] = y4 = ( y4 + y3 ) / 2;</span>
<span class="lineNum">     742 </span><span class="lineNoCov">          0 :                 y2 = ( y2 + y3 ) / 2;</span>
<span class="lineNum">     743 </span><span class="lineNoCov">          0 :                 arc[2] = y1 = ( y1 + y2 ) / 2;</span>
<span class="lineNum">     744 </span><span class="lineNoCov">          0 :                 arc[4] = y4 = ( y4 + y2 ) / 2;</span>
<span class="lineNum">     745 </span><span class="lineNoCov">          0 :                 arc[3] = ( y1 + y4 ) / 2;</span>
<span class="lineNum">     746 </span>            : 
<span class="lineNum">     747 </span>            :                 arc += 3;
<span class="lineNum">     748 </span><span class="lineNoCov">          0 :                 goto Suite;</span>
<span class="lineNum">     749 </span>            : 
<span class="lineNum">     750 </span>            : Test:
<span class="lineNum">     751 </span><span class="lineNoCov">          0 :                 if ( y1 &lt; *min ) *min = y1;</span>
<span class="lineNum">     752 </span><span class="lineNoCov">          0 :                 if ( y4 &gt; *max ) *max = y4;</span>
<span class="lineNum">     753 </span><span class="lineNoCov">          0 :                 arc -= 3;</span>
<span class="lineNum">     754 </span>            : Suite:
<span class="lineNum">     755 </span>            :                 ;
<span class="lineNum">     756 </span><span class="lineNoCov">          0 :         }</span>
<span class="lineNum">     757 </span>            :         while ( arc &gt;= stack );
<span class="lineNum">     758 </span><span class="lineNoCov">          0 : }</span>
<span class="lineNum">     759 </span>            : 
<a name="760"><span class="lineNum">     760 </span>            : </a>
<span class="lineNum">     761 </span>            : GF_EXPORT
<span class="lineNum">     762 </span>            : GF_Err gf_path_get_bounds(GF_Path *gp, GF_Rect *rc)
<span class="lineNum">     763 </span>            : {
<span class="lineNum">     764 </span>            :         u32 i;
<span class="lineNum">     765 </span>            :         GF_Point2D *pt, *end, *ctrl1, *ctrl2;
<span class="lineNum">     766 </span>            :         Fixed xMin, xMax, yMin, yMax, cxMin, cxMax, cyMin, cyMax;
<span class="lineNum">     767 </span><span class="lineNoCov">          0 :         if (!gp || !rc) return GF_BAD_PARAM;</span>
<span class="lineNum">     768 </span>            : 
<span class="lineNum">     769 </span><span class="lineNoCov">          0 :         if (!(gp-&gt;flags &amp; GF_PATH_BBOX_DIRTY)) {</span>
<span class="lineNum">     770 </span><span class="lineNoCov">          0 :                 *rc = gp-&gt;bbox;</span>
<span class="lineNum">     771 </span><span class="lineNoCov">          0 :                 return GF_OK;</span>
<span class="lineNum">     772 </span>            :         }
<span class="lineNum">     773 </span>            :         /*no curves in path*/
<span class="lineNum">     774 </span><span class="lineNoCov">          0 :         if (gp-&gt;flags &amp; GF_PATH_FLATTENED) {</span>
<span class="lineNum">     775 </span>            :                 GF_Err e;
<span class="lineNum">     776 </span><span class="lineNoCov">          0 :                 gp-&gt;flags &amp;= ~GF_PATH_BBOX_DIRTY;</span>
<span class="lineNum">     777 </span><span class="lineNoCov">          0 :                 e = gf_path_get_control_bounds(gp, &amp;gp-&gt;bbox);</span>
<span class="lineNum">     778 </span><span class="lineNoCov">          0 :                 *rc = gp-&gt;bbox;</span>
<span class="lineNum">     779 </span><span class="lineNoCov">          0 :                 return e;</span>
<span class="lineNum">     780 </span>            :         }
<span class="lineNum">     781 </span>            : 
<span class="lineNum">     782 </span>            :         gp-&gt;flags &amp;= ~GF_PATH_BBOX_DIRTY;
<span class="lineNum">     783 </span>            : 
<span class="lineNum">     784 </span><span class="lineNoCov">          0 :         if (!gp-&gt;n_points) {</span>
<span class="lineNum">     785 </span><span class="lineNoCov">          0 :                 gp-&gt;bbox.x = gp-&gt;bbox.y = gp-&gt;bbox.width = gp-&gt;bbox.height = 0;</span>
<span class="lineNum">     786 </span><span class="lineNoCov">          0 :                 *rc = gp-&gt;bbox;</span>
<span class="lineNum">     787 </span><span class="lineNoCov">          0 :                 return GF_OK;</span>
<span class="lineNum">     788 </span>            :         }
<span class="lineNum">     789 </span><span class="lineNoCov">          0 :         pt = gp-&gt;points;</span>
<span class="lineNum">     790 </span><span class="lineNoCov">          0 :         xMin = xMax = cxMin = cxMax = pt-&gt;x;</span>
<span class="lineNum">     791 </span><span class="lineNoCov">          0 :         yMin = yMax = cyMin = cyMax = pt-&gt;y;</span>
<span class="lineNum">     792 </span><span class="lineNoCov">          0 :         pt++;</span>
<span class="lineNum">     793 </span><span class="lineNoCov">          0 :         for (i=1 ; i &lt; gp-&gt;n_points; i++ ) {</span>
<span class="lineNum">     794 </span>            :                 Fixed x, y;
<span class="lineNum">     795 </span><span class="lineNoCov">          0 :                 x = pt-&gt;x;</span>
<span class="lineNum">     796 </span><span class="lineNoCov">          0 :                 y = pt-&gt;y;</span>
<span class="lineNum">     797 </span><span class="lineNoCov">          0 :                 if (x &lt; cxMin) cxMin = x;</span>
<span class="lineNum">     798 </span><span class="lineNoCov">          0 :                 if (x &gt; cxMax) cxMax = x;</span>
<span class="lineNum">     799 </span><span class="lineNoCov">          0 :                 if (y &lt; cyMin) cyMin = y;</span>
<span class="lineNum">     800 </span><span class="lineNoCov">          0 :                 if (y &gt; cyMax) cyMax = y;</span>
<span class="lineNum">     801 </span>            :                 /*point on curve, update*/
<span class="lineNum">     802 </span><span class="lineNoCov">          0 :                 if (gp-&gt;tags[i] &amp; GF_PATH_CURVE_ON) {</span>
<span class="lineNum">     803 </span><span class="lineNoCov">          0 :                         if (x &lt; xMin) xMin = x;</span>
<span class="lineNum">     804 </span><span class="lineNoCov">          0 :                         if (x &gt; xMax) xMax = x;</span>
<span class="lineNum">     805 </span><span class="lineNoCov">          0 :                         if (y &lt; yMin) yMin = y;</span>
<span class="lineNum">     806 </span><span class="lineNoCov">          0 :                         if (y &gt; yMax) yMax = y;</span>
<span class="lineNum">     807 </span>            :                 }
<span class="lineNum">     808 </span><span class="lineNoCov">          0 :                 pt++;</span>
<span class="lineNum">     809 </span>            :         }
<span class="lineNum">     810 </span>            : 
<span class="lineNum">     811 </span>            :         /*control box is bigger than box , decompose curves*/
<span class="lineNum">     812 </span><span class="lineNoCov">          0 :         if ((cxMin &lt; xMin) || (cxMax &gt; xMax) || (cyMin &lt; yMin) || (cyMax &gt; yMax)) {</span>
<span class="lineNum">     813 </span>            :                 /*decompose all control points*/
<span class="lineNum">     814 </span><span class="lineNoCov">          0 :                 pt = gp-&gt;points;</span>
<span class="lineNum">     815 </span><span class="lineNoCov">          0 :                 for (i=1 ; i &lt; gp-&gt;n_points; ) {</span>
<span class="lineNum">     816 </span><span class="lineNoCov">          0 :                         switch (gp-&gt;tags[i]) {</span>
<span class="lineNum">     817 </span>            :                         case GF_PATH_CURVE_ON:
<span class="lineNum">     818 </span>            :                         case GF_PATH_CLOSE:
<span class="lineNum">     819 </span><span class="lineNoCov">          0 :                                 pt = &amp;gp-&gt;points[i];</span>
<span class="lineNum">     820 </span><span class="lineNoCov">          0 :                                 i++;</span>
<span class="lineNum">     821 </span><span class="lineNoCov">          0 :                                 break;</span>
<span class="lineNum">     822 </span>            :                         case GF_PATH_CURVE_CONIC:
<span class="lineNum">     823 </span>            :                                 /*decompose*/
<span class="lineNum">     824 </span><span class="lineNoCov">          0 :                                 ctrl1 = &amp;gp-&gt;points[i];</span>
<span class="lineNum">     825 </span><span class="lineNoCov">          0 :                                 end = &amp;gp-&gt;points[i+1];</span>
<span class="lineNum">     826 </span><span class="lineNoCov">          0 :                                 if ((ctrl1-&gt;x &lt; xMin) || (ctrl1-&gt;x &gt; xMax))</span>
<span class="lineNum">     827 </span><span class="lineNoCov">          0 :                                         gf_conic_check(pt-&gt;x, ctrl1-&gt;x, end-&gt;x, &amp;xMin, &amp;xMax);</span>
<span class="lineNum">     828 </span>            : 
<span class="lineNum">     829 </span><span class="lineNoCov">          0 :                                 if ((ctrl1-&gt;y &lt; yMin) || (ctrl1-&gt;y &gt; yMax))</span>
<span class="lineNum">     830 </span><span class="lineNoCov">          0 :                                         gf_conic_check(pt-&gt;y, ctrl1-&gt;y, end-&gt;y, &amp;yMin, &amp;yMax);</span>
<span class="lineNum">     831 </span>            : 
<span class="lineNum">     832 </span>            :                                 /*and move*/
<span class="lineNum">     833 </span>            :                                 pt = end;
<span class="lineNum">     834 </span><span class="lineNoCov">          0 :                                 i+=2;</span>
<span class="lineNum">     835 </span><span class="lineNoCov">          0 :                                 break;</span>
<span class="lineNum">     836 </span>            :                         case GF_PATH_CURVE_CUBIC:
<span class="lineNum">     837 </span>            :                                 /*decompose*/
<span class="lineNum">     838 </span><span class="lineNoCov">          0 :                                 ctrl1 = &amp;gp-&gt;points[i];</span>
<span class="lineNum">     839 </span><span class="lineNoCov">          0 :                                 ctrl2 = &amp;gp-&gt;points[i+1];</span>
<span class="lineNum">     840 </span><span class="lineNoCov">          0 :                                 end = &amp;gp-&gt;points[i+2];</span>
<span class="lineNum">     841 </span><span class="lineNoCov">          0 :                                 if ((ctrl1-&gt;x &lt; xMin) || (ctrl1-&gt;x &gt; xMax) || (ctrl2-&gt;x &lt; xMin) || (ctrl2-&gt;x &gt; xMax))</span>
<span class="lineNum">     842 </span><span class="lineNoCov">          0 :                                         gf_cubic_check(pt-&gt;x, ctrl1-&gt;x, ctrl2-&gt;x, end-&gt;x, &amp;xMin, &amp;xMax);</span>
<span class="lineNum">     843 </span>            : 
<span class="lineNum">     844 </span><span class="lineNoCov">          0 :                                 if ((ctrl1-&gt;y &lt; yMin) || (ctrl1-&gt;y &gt; yMax) || (ctrl2-&gt;y &lt; yMin) || (ctrl2-&gt;y &gt; yMax))</span>
<span class="lineNum">     845 </span><span class="lineNoCov">          0 :                                         gf_cubic_check(pt-&gt;y, ctrl1-&gt;y, ctrl2-&gt;y, end-&gt;y, &amp;yMin, &amp;yMax);</span>
<span class="lineNum">     846 </span>            : 
<span class="lineNum">     847 </span>            :                                 /*and move*/
<span class="lineNum">     848 </span>            :                                 pt = end;
<span class="lineNum">     849 </span><span class="lineNoCov">          0 :                                 i+=3;</span>
<span class="lineNum">     850 </span><span class="lineNoCov">          0 :                                 break;</span>
<span class="lineNum">     851 </span>            :                         }
<span class="lineNum">     852 </span>            :                 }
<span class="lineNum">     853 </span>            :         }
<span class="lineNum">     854 </span><span class="lineNoCov">          0 :         gp-&gt;bbox.x = xMin;</span>
<span class="lineNum">     855 </span><span class="lineNoCov">          0 :         gp-&gt;bbox.y = yMax;</span>
<span class="lineNum">     856 </span><span class="lineNoCov">          0 :         gp-&gt;bbox.width = xMax - xMin;</span>
<span class="lineNum">     857 </span><span class="lineNoCov">          0 :         gp-&gt;bbox.height = yMax - yMin;</span>
<span class="lineNum">     858 </span><span class="lineNoCov">          0 :         *rc = gp-&gt;bbox;</span>
<span class="lineNum">     859 </span><span class="lineNoCov">          0 :         return GF_OK;</span>
<span class="lineNum">     860 </span><span class="lineNoCov">          0 : }</span>
<a name="861"><span class="lineNum">     861 </span>            : </a>
<span class="lineNum">     862 </span>            : /*flattening algo taken from libart but passed to sqrt tests for line distance to avoid 16.16 fixed overflow*/
<span class="lineNum">     863 </span>            : static GF_Err gf_subdivide_cubic(GF_Path *gp, Fixed x0, Fixed y0, Fixed x1, Fixed y1, Fixed x2, Fixed y2, Fixed x3, Fixed y3, Fixed fineness)
<span class="lineNum">     864 </span>            : {
<span class="lineNum">     865 </span>            :         GF_Point2D pt;
<span class="lineNum">     866 </span>            :         Fixed x3_0, y3_0, z3_0, z1_0, z1_dot, z2_dot, z1_perp, z2_perp;
<span class="lineNum">     867 </span>            :         Fixed max_perp;
<span class="lineNum">     868 </span>            :         Fixed x_m, y_m, xa1, ya1, xa2, ya2, xb1, yb1, xb2, yb2;
<span class="lineNum">     869 </span>            :         GF_Err e;
<span class="lineNum">     870 </span>            : 
<span class="lineNum">     871 </span><span class="lineNoCov">          0 :         pt.x = x3_0 = x3 - x0;</span>
<span class="lineNum">     872 </span><span class="lineNoCov">          0 :         pt.y = y3_0 = y3 - y0;</span>
<span class="lineNum">     873 </span>            : 
<span class="lineNum">     874 </span>            :         /*z3_0 is dist z0-z3*/
<span class="lineNum">     875 </span><span class="lineNoCov">          0 :         z3_0 = gf_v2d_len(&amp;pt);</span>
<span class="lineNum">     876 </span>            : 
<span class="lineNum">     877 </span><span class="lineNoCov">          0 :         pt.x = x1 - x0;</span>
<span class="lineNum">     878 </span><span class="lineNoCov">          0 :         pt.y = y1 - y0;</span>
<span class="lineNum">     879 </span><span class="lineNoCov">          0 :         z1_0 = gf_v2d_len(&amp;pt);</span>
<span class="lineNum">     880 </span>            : 
<span class="lineNum">     881 </span><span class="lineNoCov">          0 :         if ((z3_0*100 &lt; FIX_ONE) &amp;&amp; (z1_0*100 &lt; FIX_ONE))</span>
<span class="lineNum">     882 </span>            :                 goto nosubdivide;
<span class="lineNum">     883 </span>            : 
<span class="lineNum">     884 </span>            :         /* perp is distance from line, multiplied by dist z0-z3 */
<span class="lineNum">     885 </span><span class="lineNoCov">          0 :         max_perp = gf_mulfix(fineness, z3_0);</span>
<span class="lineNum">     886 </span>            : 
<span class="lineNum">     887 </span><span class="lineNoCov">          0 :         z1_perp = gf_mulfix((y1 - y0), x3_0) - gf_mulfix((x1 - x0), y3_0);</span>
<span class="lineNum">     888 </span><span class="lineNoCov">          0 :         if (ABS(z1_perp) &gt; max_perp)</span>
<span class="lineNum">     889 </span>            :                 goto subdivide;
<span class="lineNum">     890 </span>            : 
<span class="lineNum">     891 </span><span class="lineNoCov">          0 :         z2_perp = gf_mulfix((y3 - y2), x3_0) - gf_mulfix((x3 - x2), y3_0);</span>
<span class="lineNum">     892 </span><span class="lineNoCov">          0 :         if (ABS(z2_perp) &gt; max_perp)</span>
<span class="lineNum">     893 </span>            :                 goto subdivide;
<span class="lineNum">     894 </span>            : 
<span class="lineNum">     895 </span><span class="lineNoCov">          0 :         z1_dot = gf_mulfix((x1 - x0), x3_0) + gf_mulfix((y1 - y0), y3_0);</span>
<span class="lineNum">     896 </span><span class="lineNoCov">          0 :         if ((z1_dot &lt; 0) &amp;&amp; (ABS(z1_dot) &gt; max_perp))</span>
<span class="lineNum">     897 </span>            :                 goto subdivide;
<span class="lineNum">     898 </span>            : 
<span class="lineNum">     899 </span><span class="lineNoCov">          0 :         z2_dot = gf_mulfix((x3 - x2), x3_0) + gf_mulfix((y3 - y2), y3_0);</span>
<span class="lineNum">     900 </span><span class="lineNoCov">          0 :         if ((z2_dot &lt; 0) &amp;&amp; (ABS(z2_dot) &gt; max_perp))</span>
<span class="lineNum">     901 </span>            :                 goto subdivide;
<span class="lineNum">     902 </span>            : 
<span class="lineNum">     903 </span><span class="lineNoCov">          0 :         if (gf_divfix(z1_dot + z1_dot, z3_0) &gt; z3_0)</span>
<span class="lineNum">     904 </span>            :                 goto subdivide;
<span class="lineNum">     905 </span>            : 
<span class="lineNum">     906 </span><span class="lineNoCov">          0 :         if (gf_divfix(z2_dot + z2_dot, z3_0) &gt; z3_0)</span>
<span class="lineNum">     907 </span>            :                 goto subdivide;
<span class="lineNum">     908 </span>            : 
<span class="lineNum">     909 </span>            : nosubdivide:
<span class="lineNum">     910 </span>            :         /* don't subdivide */
<span class="lineNum">     911 </span><span class="lineNoCov">          0 :         return gf_path_add_line_to(gp, x3, y3);</span>
<span class="lineNum">     912 </span>            : 
<span class="lineNum">     913 </span>            : subdivide:
<span class="lineNum">     914 </span><span class="lineNoCov">          0 :         xa1 = (x0 + x1) / 2;</span>
<span class="lineNum">     915 </span><span class="lineNoCov">          0 :         ya1 = (y0 + y1) / 2;</span>
<span class="lineNum">     916 </span><span class="lineNoCov">          0 :         xa2 = (x0 + 2 * x1 + x2) / 4;</span>
<span class="lineNum">     917 </span><span class="lineNoCov">          0 :         ya2 = (y0 + 2 * y1 + y2) / 4;</span>
<span class="lineNum">     918 </span><span class="lineNoCov">          0 :         xb1 = (x1 + 2 * x2 + x3) / 4;</span>
<span class="lineNum">     919 </span><span class="lineNoCov">          0 :         yb1 = (y1 + 2 * y2 + y3) / 4;</span>
<span class="lineNum">     920 </span><span class="lineNoCov">          0 :         xb2 = (x2 + x3) / 2;</span>
<span class="lineNum">     921 </span><span class="lineNoCov">          0 :         yb2 = (y2 + y3) / 2;</span>
<span class="lineNum">     922 </span><span class="lineNoCov">          0 :         x_m = (xa2 + xb1) / 2;</span>
<span class="lineNum">     923 </span><span class="lineNoCov">          0 :         y_m = (ya2 + yb1) / 2;</span>
<span class="lineNum">     924 </span>            :         /*safeguard for numerical stability*/
<span class="lineNum">     925 </span><span class="lineNoCov">          0 :         if ( (ABS(x_m-x0) &lt; FIX_EPSILON) &amp;&amp; (ABS(y_m-y0) &lt; FIX_EPSILON))</span>
<span class="lineNum">     926 </span><span class="lineNoCov">          0 :                 return gf_path_add_line_to(gp, x3, y3);</span>
<span class="lineNum">     927 </span><span class="lineNoCov">          0 :         if ( (ABS(x3-x_m) &lt; FIX_EPSILON) &amp;&amp; (ABS(y3-y_m) &lt; FIX_EPSILON))</span>
<span class="lineNum">     928 </span><span class="lineNoCov">          0 :                 return gf_path_add_line_to(gp, x3, y3);</span>
<span class="lineNum">     929 </span>            : 
<span class="lineNum">     930 </span><span class="lineNoCov">          0 :         e = gf_subdivide_cubic(gp, x0, y0, xa1, ya1, xa2, ya2, x_m, y_m, fineness);</span>
<span class="lineNum">     931 </span><span class="lineNoCov">          0 :         if (e) return e;</span>
<span class="lineNum">     932 </span><span class="lineNoCov">          0 :         return gf_subdivide_cubic(gp, x_m, y_m, xb1, yb1, xb2, yb2, x3, y3, fineness);</span>
<span class="lineNum">     933 </span><span class="lineNoCov">          0 : }</span>
<a name="934"><span class="lineNum">     934 </span>            : </a>
<span class="lineNum">     935 </span>            : GF_EXPORT
<span class="lineNum">     936 </span>            : GF_Path *gf_path_get_flatten(GF_Path *gp)
<span class="lineNum">     937 </span>            : {
<span class="lineNum">     938 </span>            :         GF_Path *ngp;
<span class="lineNum">     939 </span>            :         Fixed fineness;
<span class="lineNum">     940 </span>            :         u32 i, *countour;
<span class="lineNum">     941 </span>            :         GF_Point2D *pt;
<span class="lineNum">     942 </span><span class="lineNoCov">          0 :         if (!gp || !gp-&gt;n_points) return NULL;</span>
<span class="lineNum">     943 </span>            : 
<span class="lineNum">     944 </span><span class="lineNoCov">          0 :         if (gp-&gt;flags &amp; GF_PATH_FLATTENED) return gf_path_clone(gp);</span>
<span class="lineNum">     945 </span>            : 
<span class="lineNum">     946 </span>            :         /*avoid too high precision */
<span class="lineNum">     947 </span><span class="lineNoCov">          0 :         fineness = MAX(FIX_ONE - gp-&gt;fineness, FIX_ONE / 100);</span>
<span class="lineNum">     948 </span>            : 
<span class="lineNum">     949 </span><span class="lineNoCov">          0 :         ngp = gf_path_new();</span>
<span class="lineNum">     950 </span><span class="lineNoCov">          0 :         pt = &amp;gp-&gt;points[0];</span>
<span class="lineNum">     951 </span><span class="lineNoCov">          0 :         gf_path_add_move_to_vec(ngp, pt);</span>
<span class="lineNum">     952 </span><span class="lineNoCov">          0 :         countour = gp-&gt;contours;</span>
<span class="lineNum">     953 </span><span class="lineNoCov">          0 :         for (i=1; i&lt;gp-&gt;n_points; ) {</span>
<span class="lineNum">     954 </span><span class="lineNoCov">          0 :                 switch (gp-&gt;tags[i]) {</span>
<span class="lineNum">     955 </span>            :                 case GF_PATH_CURVE_ON:
<span class="lineNum">     956 </span>            :                 case GF_PATH_CLOSE:
<span class="lineNum">     957 </span><span class="lineNoCov">          0 :                         pt = &amp;gp-&gt;points[i];</span>
<span class="lineNum">     958 </span><span class="lineNoCov">          0 :                         if (*countour == i-1) {</span>
<span class="lineNum">     959 </span><span class="lineNoCov">          0 :                                 gf_path_add_move_to_vec(ngp, pt);</span>
<span class="lineNum">     960 </span><span class="lineNoCov">          0 :                                 countour++;</span>
<span class="lineNum">     961 </span><span class="lineNoCov">          0 :                         } else {</span>
<span class="lineNum">     962 </span><span class="lineNoCov">          0 :                                 gf_path_add_line_to_vec(ngp, pt);</span>
<span class="lineNum">     963 </span>            :                         }
<span class="lineNum">     964 </span><span class="lineNoCov">          0 :                         if (gp-&gt;tags[i]==GF_PATH_CLOSE) gf_path_close(ngp);</span>
<span class="lineNum">     965 </span><span class="lineNoCov">          0 :                         i++;</span>
<span class="lineNum">     966 </span><span class="lineNoCov">          0 :                         break;</span>
<span class="lineNum">     967 </span>            :                 case GF_PATH_CURVE_CONIC:
<span class="lineNum">     968 </span>            :                 {
<span class="lineNum">     969 </span>            :                         GF_Point2D *ctl, *end, c1, c2;
<span class="lineNum">     970 </span><span class="lineNoCov">          0 :                         ctl = &amp;gp-&gt;points[i];</span>
<span class="lineNum">     971 </span><span class="lineNoCov">          0 :                         end = &amp;gp-&gt;points[i+1];</span>
<span class="lineNum">     972 </span><span class="lineNoCov">          0 :                         c1.x = pt-&gt;x + 2*(ctl-&gt;x - pt-&gt;x)/3;</span>
<span class="lineNum">     973 </span><span class="lineNoCov">          0 :                         c1.y = pt-&gt;y + 2*(ctl-&gt;y - pt-&gt;y)/3;</span>
<span class="lineNum">     974 </span><span class="lineNoCov">          0 :                         c2.x = c1.x + (end-&gt;x - pt-&gt;x) / 3;</span>
<span class="lineNum">     975 </span><span class="lineNoCov">          0 :                         c2.y = c1.y + (end-&gt;y - pt-&gt;y) / 3;</span>
<span class="lineNum">     976 </span>            : 
<span class="lineNum">     977 </span><span class="lineNoCov">          0 :                         gf_subdivide_cubic(ngp, pt-&gt;x, pt-&gt;y, c1.x, c1.y, c2.x, c2.y, end-&gt;x, end-&gt;y, fineness);</span>
<span class="lineNum">     978 </span>            :                         pt = end;
<span class="lineNum">     979 </span><span class="lineNoCov">          0 :                         if (gp-&gt;tags[i+1]==GF_PATH_CLOSE) gf_path_close(ngp);</span>
<span class="lineNum">     980 </span><span class="lineNoCov">          0 :                         i+=2;</span>
<span class="lineNum">     981 </span>            :                 }
<span class="lineNum">     982 </span><span class="lineNoCov">          0 :                 break;</span>
<span class="lineNum">     983 </span>            :                 case GF_PATH_CURVE_CUBIC:
<span class="lineNum">     984 </span><span class="lineNoCov">          0 :                         gf_subdivide_cubic(ngp, pt-&gt;x, pt-&gt;y, gp-&gt;points[i].x, gp-&gt;points[i].y, gp-&gt;points[i+1].x, gp-&gt;points[i+1].y, gp-&gt;points[i+2].x, gp-&gt;points[i+2].y, fineness);</span>
<span class="lineNum">     985 </span><span class="lineNoCov">          0 :                         pt = &amp;gp-&gt;points[i+2];</span>
<span class="lineNum">     986 </span><span class="lineNoCov">          0 :                         if (gp-&gt;tags[i+2]==GF_PATH_CLOSE) gf_path_close(ngp);</span>
<span class="lineNum">     987 </span><span class="lineNoCov">          0 :                         i+=3;</span>
<span class="lineNum">     988 </span><span class="lineNoCov">          0 :                         break;</span>
<span class="lineNum">     989 </span>            :                 }
<span class="lineNum">     990 </span>            :         }
<span class="lineNum">     991 </span><span class="lineNoCov">          0 :         if (gp-&gt;flags &amp; GF_PATH_FILL_ZERO_NONZERO) ngp-&gt;flags |= GF_PATH_FILL_ZERO_NONZERO;</span>
<span class="lineNum">     992 </span><span class="lineNoCov">          0 :         ngp-&gt;flags |= (GF_PATH_BBOX_DIRTY | GF_PATH_FLATTENED);</span>
<span class="lineNum">     993 </span><span class="lineNoCov">          0 :         return ngp;</span>
<span class="lineNum">     994 </span><span class="lineNoCov">          0 : }</span>
<a name="995"><span class="lineNum">     995 </span>            : </a>
<span class="lineNum">     996 </span>            : GF_EXPORT
<span class="lineNum">     997 </span>            : void gf_path_flatten(GF_Path *gp)
<span class="lineNum">     998 </span>            : {
<span class="lineNum">     999 </span>            :         GF_Path *res;
<span class="lineNum">    1000 </span><span class="lineNoCov">          0 :         if (gp-&gt;flags &amp; GF_PATH_FLATTENED) return;</span>
<span class="lineNum">    1001 </span><span class="lineNoCov">          0 :         if (!gp-&gt;n_points) return;</span>
<span class="lineNum">    1002 </span><span class="lineNoCov">          0 :         res = gf_path_get_flatten(gp);</span>
<span class="lineNum">    1003 </span><span class="lineNoCov">          0 :         if (gp-&gt;contours) gf_free(gp-&gt;contours);</span>
<span class="lineNum">    1004 </span><span class="lineNoCov">          0 :         if (gp-&gt;points) gf_free(gp-&gt;points);</span>
<span class="lineNum">    1005 </span><span class="lineNoCov">          0 :         if (gp-&gt;tags) gf_free(gp-&gt;tags);</span>
<span class="lineNum">    1006 </span><span class="lineNoCov">          0 :         memcpy(gp, res, sizeof(GF_Path));</span>
<span class="lineNum">    1007 </span><span class="lineNoCov">          0 :         gf_free(res);</span>
<span class="lineNum">    1008 </span><span class="lineNoCov">          0 : }</span>
<span class="lineNum">    1009 </span>            : 
<span class="lineNum">    1010 </span>            : 
<span class="lineNum">    1011 </span>            : 
<span class="lineNum">    1012 </span>            : #define isLeft(P0, P1, P2) \
<span class="lineNum">    1013 </span>            :         ( gf_mulfix((P1.x - P0.x), (P2.y - P0.y)) - gf_mulfix((P2.x - P0.x), (P1.y - P0.y)) )
<a name="1014"><span class="lineNum">    1014 </span>            : </a>
<span class="lineNum">    1015 </span>            : 
<span class="lineNum">    1016 </span>            : static void gf_subdivide_cubic_hit_test(Fixed h_x, Fixed h_y, Fixed x0, Fixed y0, Fixed x1, Fixed y1, Fixed x2, Fixed y2, Fixed x3, Fixed y3, s32 *wn)
<span class="lineNum">    1017 </span>            : {
<span class="lineNum">    1018 </span>            :         GF_Point2D s, e, pt;
<span class="lineNum">    1019 </span>            :         Fixed x_m, y_m, xa1, ya1, xa2, ya2, xb1, yb1, xb2, yb2, y_min, y_max;
<span class="lineNum">    1020 </span>            : 
<span class="lineNum">    1021 </span>            :         /*if hit line doesn't intersects control box abort*/
<span class="lineNum">    1022 </span><span class="lineNoCov">          0 :         y_min = MIN(y0, MIN(y1, MIN(y2, y3)));</span>
<span class="lineNum">    1023 </span><span class="lineNoCov">          0 :         y_max = MAX(y0, MAX(y1, MAX(y2, y3)));</span>
<span class="lineNum">    1024 </span><span class="lineNoCov">          0 :         if ((h_y&lt;y_min) || (h_y&gt;y_max) ) return;</span>
<span class="lineNum">    1025 </span>            : 
<span class="lineNum">    1026 </span>            :         /*if vert diff between end points larger than 1 pixels, subdivide (we need pixel accuracy for is_over)*/
<span class="lineNum">    1027 </span><span class="lineNoCov">          0 :         if (y_max - y_min &gt; FIX_ONE) {</span>
<span class="lineNum">    1028 </span><span class="lineNoCov">          0 :                 xa1 = (x0 + x1) / 2;</span>
<span class="lineNum">    1029 </span><span class="lineNoCov">          0 :                 ya1 = (y0 + y1) / 2;</span>
<span class="lineNum">    1030 </span><span class="lineNoCov">          0 :                 xa2 = (x0 + 2 * x1 + x2) / 4;</span>
<span class="lineNum">    1031 </span><span class="lineNoCov">          0 :                 ya2 = (y0 + 2 * y1 + y2) / 4;</span>
<span class="lineNum">    1032 </span><span class="lineNoCov">          0 :                 xb1 = (x1 + 2 * x2 + x3) / 4;</span>
<span class="lineNum">    1033 </span><span class="lineNoCov">          0 :                 yb1 = (y1 + 2 * y2 + y3) / 4;</span>
<span class="lineNum">    1034 </span><span class="lineNoCov">          0 :                 xb2 = (x2 + x3) / 2;</span>
<span class="lineNum">    1035 </span><span class="lineNoCov">          0 :                 yb2 = (y2 + y3) / 2;</span>
<span class="lineNum">    1036 </span><span class="lineNoCov">          0 :                 x_m = (xa2 + xb1) / 2;</span>
<span class="lineNum">    1037 </span><span class="lineNoCov">          0 :                 y_m = (ya2 + yb1) / 2;</span>
<span class="lineNum">    1038 </span>            : 
<span class="lineNum">    1039 </span><span class="lineNoCov">          0 :                 gf_subdivide_cubic_hit_test(h_x, h_y, x0, y0, xa1, ya1, xa2, ya2, x_m, y_m, wn);</span>
<span class="lineNum">    1040 </span><span class="lineNoCov">          0 :                 gf_subdivide_cubic_hit_test(h_x, h_y, x_m, y_m, xb1, yb1, xb2, yb2, x3, y3, wn);</span>
<span class="lineNum">    1041 </span><span class="lineNoCov">          0 :                 return;</span>
<span class="lineNum">    1042 </span>            :         }
<span class="lineNum">    1043 </span>            : 
<span class="lineNum">    1044 </span>            :         s.x = x0;
<span class="lineNum">    1045 </span>            :         s.y = y0;
<span class="lineNum">    1046 </span>            :         e.x = x3;
<span class="lineNum">    1047 </span>            :         e.y = y3;
<span class="lineNum">    1048 </span>            :         pt.x = h_x;
<span class="lineNum">    1049 </span>            :         pt.y= h_y;
<span class="lineNum">    1050 </span>            : 
<span class="lineNum">    1051 </span><span class="lineNoCov">          0 :         if (s.y&lt;=pt.y) {</span>
<span class="lineNum">    1052 </span><span class="lineNoCov">          0 :                 if (e.y&gt;pt.y) {</span>
<span class="lineNum">    1053 </span><span class="lineNoCov">          0 :                         if (isLeft(s, e, pt) &gt; 0)</span>
<span class="lineNum">    1054 </span><span class="lineNoCov">          0 :                                 (*wn)++;</span>
<span class="lineNum">    1055 </span>            :                 }
<span class="lineNum">    1056 </span>            :         }
<span class="lineNum">    1057 </span><span class="lineNoCov">          0 :         else if (e.y&lt;=pt.y) {</span>
<span class="lineNum">    1058 </span><span class="lineNoCov">          0 :                 if (isLeft(s, e, pt) &lt; 0)</span>
<span class="lineNum">    1059 </span><span class="lineNoCov">          0 :                         (*wn)--;</span>
<span class="lineNum">    1060 </span>            :         }
<span class="lineNum">    1061 </span><span class="lineNoCov">          0 : }</span>
<a name="1062"><span class="lineNum">    1062 </span>            : </a>
<span class="lineNum">    1063 </span>            : GF_EXPORT
<span class="lineNum">    1064 </span>            : Bool gf_path_point_over(GF_Path *gp, Fixed x, Fixed y)
<span class="lineNum">    1065 </span>            : {
<span class="lineNum">    1066 </span>            :         u32 i, *contour, start_idx;
<span class="lineNum">    1067 </span>            :         s32 wn;
<span class="lineNum">    1068 </span>            :         GF_Point2D start, s, e, pt;
<span class="lineNum">    1069 </span>            :         GF_Rect rc;
<span class="lineNum">    1070 </span>            : 
<span class="lineNum">    1071 </span>            :         /*check if not in bounds*/
<span class="lineNum">    1072 </span><span class="lineNoCov">          0 :         gf_path_get_bounds(gp, &amp;rc);</span>
<span class="lineNum">    1073 </span><span class="lineNoCov">          0 :         if ((x&lt;rc.x) || (y&gt;rc.y) || (x&gt;rc.x+rc.width) || (y&lt;rc.y-rc.height)) return GF_FALSE;</span>
<span class="lineNum">    1074 </span>            : 
<span class="lineNum">    1075 </span><span class="lineNoCov">          0 :         if (!gp || (gp-&gt;n_points&lt;2)) return GF_FALSE;</span>
<span class="lineNum">    1076 </span>            : 
<span class="lineNum">    1077 </span>            :         pt.x = x;
<span class="lineNum">    1078 </span>            :         pt.y = y;
<span class="lineNum">    1079 </span><span class="lineNoCov">          0 :         wn = 0;</span>
<span class="lineNum">    1080 </span><span class="lineNoCov">          0 :         s = start = gp-&gt;points[0];</span>
<span class="lineNum">    1081 </span>            :         start_idx = 0;
<span class="lineNum">    1082 </span><span class="lineNoCov">          0 :         contour = gp-&gt;contours;</span>
<span class="lineNum">    1083 </span><span class="lineNoCov">          0 :         for (i=1; i&lt;gp-&gt;n_points; ) {</span>
<span class="lineNum">    1084 </span><span class="lineNoCov">          0 :                 switch (gp-&gt;tags[i]) {</span>
<span class="lineNum">    1085 </span>            :                 case GF_PATH_CURVE_ON:
<span class="lineNum">    1086 </span>            :                 case GF_PATH_CLOSE:
<span class="lineNum">    1087 </span><span class="lineNoCov">          0 :                         e = gp-&gt;points[i];</span>
<span class="lineNum">    1088 </span><span class="lineNoCov">          0 :                         if (s.y&lt;=pt.y) {</span>
<span class="lineNum">    1089 </span><span class="lineNoCov">          0 :                                 if (e.y&gt;pt.y) {</span>
<span class="lineNum">    1090 </span><span class="lineNoCov">          0 :                                         if (isLeft(s, e, pt) &gt; 0) wn++;</span>
<span class="lineNum">    1091 </span>            :                                 }
<span class="lineNum">    1092 </span>            :                         }
<span class="lineNum">    1093 </span><span class="lineNoCov">          0 :                         else if (e.y&lt;=pt.y) {</span>
<span class="lineNum">    1094 </span><span class="lineNoCov">          0 :                                 if (isLeft(s, e, pt) &lt; 0) wn--;</span>
<span class="lineNum">    1095 </span>            :                         }
<span class="lineNum">    1096 </span>            :                         s = e;
<span class="lineNum">    1097 </span><span class="lineNoCov">          0 :                         i++;</span>
<span class="lineNum">    1098 </span><span class="lineNoCov">          0 :                         break;</span>
<span class="lineNum">    1099 </span>            :                 case GF_PATH_CURVE_CONIC:
<span class="lineNum">    1100 </span>            :                 {
<span class="lineNum">    1101 </span>            :                         GF_Point2D *ctl, *end, c1, c2;
<span class="lineNum">    1102 </span><span class="lineNoCov">          0 :                         ctl = &amp;gp-&gt;points[i];</span>
<span class="lineNum">    1103 </span><span class="lineNoCov">          0 :                         end = &amp;gp-&gt;points[i+1];</span>
<span class="lineNum">    1104 </span><span class="lineNoCov">          0 :                         c1.x = s.x + 2*(ctl-&gt;x - s.x) / 3;</span>
<span class="lineNum">    1105 </span><span class="lineNoCov">          0 :                         c1.y = s.y + 2*(ctl-&gt;y - s.y) / 3;</span>
<span class="lineNum">    1106 </span><span class="lineNoCov">          0 :                         c2.x = c1.x + (end-&gt;x - s.x) / 3;</span>
<span class="lineNum">    1107 </span><span class="lineNoCov">          0 :                         c2.y = c1.y + (end-&gt;y - s.y) / 3;</span>
<span class="lineNum">    1108 </span><span class="lineNoCov">          0 :                         gf_subdivide_cubic_hit_test(x, y, s.x, s.y, c1.x, c1.y, c2.x, c2.y, end-&gt;x, end-&gt;y, &amp;wn);</span>
<span class="lineNum">    1109 </span><span class="lineNoCov">          0 :                         s = *end;</span>
<span class="lineNum">    1110 </span>            :                 }
<span class="lineNum">    1111 </span><span class="lineNoCov">          0 :                 i+=2;</span>
<span class="lineNum">    1112 </span><span class="lineNoCov">          0 :                 break;</span>
<span class="lineNum">    1113 </span>            :                 case GF_PATH_CURVE_CUBIC:
<span class="lineNum">    1114 </span><span class="lineNoCov">          0 :                         gf_subdivide_cubic_hit_test(x, y, s.x, s.y, gp-&gt;points[i].x, gp-&gt;points[i].y, gp-&gt;points[i+1].x, gp-&gt;points[i+1].y, gp-&gt;points[i+2].x, gp-&gt;points[i+2].y, &amp;wn);</span>
<span class="lineNum">    1115 </span><span class="lineNoCov">          0 :                         s = gp-&gt;points[i+2];</span>
<span class="lineNum">    1116 </span><span class="lineNoCov">          0 :                         i+=3;</span>
<span class="lineNum">    1117 </span><span class="lineNoCov">          0 :                         break;</span>
<span class="lineNum">    1118 </span>            :                 }
<span class="lineNum">    1119 </span>            :                 /*end of subpath*/
<span class="lineNum">    1120 </span><span class="lineNoCov">          0 :                 if (*contour==i-1) {</span>
<span class="lineNum">    1121 </span>            :                         /*close path if needed, but don't test for lines...*/
<span class="lineNum">    1122 </span><span class="lineNoCov">          0 :                         if ((i-start_idx &gt; 2) &amp;&amp; (pt.y&lt;s.y)) {</span>
<span class="lineNum">    1123 </span><span class="lineNoCov">          0 :                                 if ((start.x != s.x) || (start.y != s.y)) {</span>
<span class="lineNum">    1124 </span>            :                                         e = start;
<span class="lineNum">    1125 </span><span class="lineNoCov">          0 :                                         if (s.x&lt;=pt.x) {</span>
<span class="lineNum">    1126 </span><span class="lineNoCov">          0 :                                                 if (e.y&gt;pt.y) {</span>
<span class="lineNum">    1127 </span><span class="lineNoCov">          0 :                                                         if (isLeft(s, e, pt) &gt; 0) wn++;</span>
<span class="lineNum">    1128 </span>            :                                                 }
<span class="lineNum">    1129 </span>            :                                         }
<span class="lineNum">    1130 </span><span class="lineNoCov">          0 :                                         else if (e.y&lt;=pt.y) {</span>
<span class="lineNum">    1131 </span><span class="lineNoCov">          0 :                                                 if (isLeft(s, e, pt) &lt; 0) wn--;</span>
<span class="lineNum">    1132 </span>            :                                         }
<span class="lineNum">    1133 </span>            :                                 }
<span class="lineNum">    1134 </span>            :                         }
<span class="lineNum">    1135 </span><span class="lineNoCov">          0 :                         if ( i &lt; gp-&gt;n_points )</span>
<span class="lineNum">    1136 </span><span class="lineNoCov">          0 :                                 s = start = gp-&gt;points[i];</span>
<span class="lineNum">    1137 </span><span class="lineNoCov">          0 :                         i++;</span>
<span class="lineNum">    1138 </span><span class="lineNoCov">          0 :                 }</span>
<span class="lineNum">    1139 </span>            :         }
<span class="lineNum">    1140 </span><span class="lineNoCov">          0 :         if (gp-&gt;flags &amp; GF_PATH_FILL_ZERO_NONZERO) return wn ? GF_TRUE : GF_FALSE;</span>
<span class="lineNum">    1141 </span><span class="lineNoCov">          0 :         return wn%2 ? GF_TRUE : GF_FALSE;</span>
<span class="lineNum">    1142 </span><span class="lineNoCov">          0 : }</span>
<a name="1143"><span class="lineNum">    1143 </span>            : </a>
<span class="lineNum">    1144 </span>            : GF_EXPORT
<span class="lineNum">    1145 </span>            : Bool gf_path_is_empty(GF_Path *gp)
<span class="lineNum">    1146 </span>            : {
<span class="lineNum">    1147 </span><span class="lineNoCov">          0 :         if (gp &amp;&amp; gp-&gt;contours) return GF_FALSE;</span>
<span class="lineNum">    1148 </span><span class="lineNoCov">          0 :         return GF_TRUE;</span>
<span class="lineNum">    1149 </span><span class="lineNoCov">          0 : }</span>
<span class="lineNum">    1150 </span>            : 
<span class="lineNum">    1151 </span>            : /*iteration info*/
<span class="lineNum">    1152 </span>            : typedef struct
<span class="lineNum">    1153 </span>            : {
<span class="lineNum">    1154 </span>            :         Fixed len;
<span class="lineNum">    1155 </span>            :         Fixed dx, dy;
<span class="lineNum">    1156 </span>            :         Fixed start_x, start_y;
<span class="lineNum">    1157 </span>            : } IterInfo;
<span class="lineNum">    1158 </span>            : 
<span class="lineNum">    1159 </span>            : struct _path_iterator
<span class="lineNum">    1160 </span>            : {
<span class="lineNum">    1161 </span>            :         u32 num_seg;
<span class="lineNum">    1162 </span>            :         IterInfo *seg;
<span class="lineNum">    1163 </span>            :         Fixed length;
<span class="lineNum">    1164 </span>            : };
<a name="1165"><span class="lineNum">    1165 </span>            : </a>
<span class="lineNum">    1166 </span>            : GF_EXPORT
<span class="lineNum">    1167 </span>            : GF_PathIterator *gf_path_iterator_new(GF_Path *gp)
<span class="lineNum">    1168 </span>            : {
<span class="lineNum">    1169 </span>            :         GF_Path *flat;
<span class="lineNum">    1170 </span>            :         GF_PathIterator *it;
<span class="lineNum">    1171 </span>            :         u32 i, j, cur;
<span class="lineNum">    1172 </span>            :         GF_Point2D start, end;
<span class="lineNum">    1173 </span>            : 
<span class="lineNum">    1174 </span><span class="lineNoCov">          0 :         GF_SAFEALLOC(it, GF_PathIterator);</span>
<span class="lineNum">    1175 </span><span class="lineNoCov">          0 :         if (!it) return NULL;</span>
<span class="lineNum">    1176 </span><span class="lineNoCov">          0 :         flat = gf_path_get_flatten(gp);</span>
<span class="lineNum">    1177 </span><span class="lineNoCov">          0 :         if (!flat) {</span>
<span class="lineNum">    1178 </span><span class="lineNoCov">          0 :                 gf_free(it);</span>
<span class="lineNum">    1179 </span><span class="lineNoCov">          0 :                 return NULL;</span>
<span class="lineNum">    1180 </span>            :         }
<span class="lineNum">    1181 </span><span class="lineNoCov">          0 :         it-&gt;seg = (IterInfo *) gf_malloc(sizeof(IterInfo) * flat-&gt;n_points);</span>
<span class="lineNum">    1182 </span><span class="lineNoCov">          0 :         it-&gt;num_seg = 0;</span>
<span class="lineNum">    1183 </span><span class="lineNoCov">          0 :         it-&gt;length = 0;</span>
<span class="lineNum">    1184 </span>            :         cur = 0;
<span class="lineNum">    1185 </span><span class="lineNoCov">          0 :         for (i=0; i&lt;flat-&gt;n_contours; i++) {</span>
<span class="lineNum">    1186 </span>            :                 Fixed dx, dy;
<span class="lineNum">    1187 </span><span class="lineNoCov">          0 :                 u32 nb_pts = 1+flat-&gt;contours[i]-cur;</span>
<span class="lineNum">    1188 </span><span class="lineNoCov">          0 :                 start = flat-&gt;points[cur];</span>
<span class="lineNum">    1189 </span><span class="lineNoCov">          0 :                 for (j=1; j&lt;nb_pts; j++) {</span>
<span class="lineNum">    1190 </span><span class="lineNoCov">          0 :                         end = flat-&gt;points[cur+j];</span>
<span class="lineNum">    1191 </span><span class="lineNoCov">          0 :                         it-&gt;seg[it-&gt;num_seg].start_x = start.x;</span>
<span class="lineNum">    1192 </span><span class="lineNoCov">          0 :                         it-&gt;seg[it-&gt;num_seg].start_y = start.y;</span>
<span class="lineNum">    1193 </span><span class="lineNoCov">          0 :                         dx = it-&gt;seg[it-&gt;num_seg].dx = end.x - start.x;</span>
<span class="lineNum">    1194 </span><span class="lineNoCov">          0 :                         dy = it-&gt;seg[it-&gt;num_seg].dy = end.y - start.y;</span>
<span class="lineNum">    1195 </span><span class="lineNoCov">          0 :                         it-&gt;seg[it-&gt;num_seg].len = gf_sqrt(gf_mulfix(dx, dx) + gf_mulfix(dy, dy));</span>
<span class="lineNum">    1196 </span><span class="lineNoCov">          0 :                         it-&gt;length += it-&gt;seg[it-&gt;num_seg].len;</span>
<span class="lineNum">    1197 </span>            :                         start = end;
<span class="lineNum">    1198 </span><span class="lineNoCov">          0 :                         it-&gt;num_seg++;</span>
<span class="lineNum">    1199 </span>            :                 }
<span class="lineNum">    1200 </span>            :                 cur += nb_pts;
<span class="lineNum">    1201 </span>            :         }
<span class="lineNum">    1202 </span><span class="lineNoCov">          0 :         gf_path_del(flat);</span>
<span class="lineNum">    1203 </span><span class="lineNoCov">          0 :         return it;</span>
<span class="lineNum">    1204 </span><span class="lineNoCov">          0 : }</span>
<a name="1205"><span class="lineNum">    1205 </span>            : </a>
<span class="lineNum">    1206 </span>            : GF_EXPORT
<span class="lineNum">    1207 </span>            : Fixed gf_path_iterator_get_length(GF_PathIterator *it)
<span class="lineNum">    1208 </span>            : {
<span class="lineNum">    1209 </span><span class="lineNoCov">          0 :         return it ? it-&gt;length : 0;</span>
<span class="lineNum">    1210 </span>            : }
<a name="1211"><span class="lineNum">    1211 </span>            : </a>
<span class="lineNum">    1212 </span>            : GF_EXPORT
<span class="lineNum">    1213 </span>            : Bool gf_path_iterator_get_transform(GF_PathIterator *path, Fixed offset, Bool follow_tangent, GF_Matrix2D *mat, Bool smooth_edges, Fixed length_after_point)
<span class="lineNum">    1214 </span>            : {
<span class="lineNum">    1215 </span>            :         GF_Matrix2D final, rot;
<span class="lineNum">    1216 </span>            :         Bool tang = GF_FALSE;
<span class="lineNum">    1217 </span>            :         Fixed res, angle, angleNext;
<span class="lineNum">    1218 </span>            :         u32 i;
<span class="lineNum">    1219 </span>            :         Fixed curLen = 0;
<span class="lineNum">    1220 </span><span class="lineNoCov">          0 :         if (!path) return GF_FALSE;</span>
<span class="lineNum">    1221 </span>            : 
<span class="lineNum">    1222 </span><span class="lineNoCov">          0 :         for (i=0; i&lt;path-&gt;num_seg; i++) {</span>
<span class="lineNum">    1223 </span><span class="lineNoCov">          0 :                 if (curLen + path-&gt;seg[i].len &gt;= offset) goto found;</span>
<span class="lineNum">    1224 </span>            :                 curLen += path-&gt;seg[i].len;
<span class="lineNum">    1225 </span>            :         }
<span class="lineNum">    1226 </span><span class="lineNoCov">          0 :         if (!follow_tangent) return GF_FALSE;</span>
<span class="lineNum">    1227 </span>            :         tang = GF_TRUE;
<span class="lineNum">    1228 </span><span class="lineNoCov">          0 :         i--;</span>
<span class="lineNum">    1229 </span>            : 
<span class="lineNum">    1230 </span>            : found:
<span class="lineNum">    1231 </span><span class="lineNoCov">          0 :         gf_mx2d_init(final);</span>
<span class="lineNum">    1232 </span>            : 
<span class="lineNum">    1233 </span><span class="lineNoCov">          0 :         res = gf_divfix(offset - curLen, path-&gt;seg[i].len);</span>
<span class="lineNum">    1234 </span><span class="lineNoCov">          0 :         if (tang) res += 1;</span>
<span class="lineNum">    1235 </span>            : 
<span class="lineNum">    1236 </span>            :         /*move to current point*/
<span class="lineNum">    1237 </span><span class="lineNoCov">          0 :         gf_mx2d_add_translation(&amp;final, path-&gt;seg[i].start_x + gf_mulfix(path-&gt;seg[i].dx, res), path-&gt;seg[i].start_y + gf_mulfix(path-&gt;seg[i].dy, res));</span>
<span class="lineNum">    1238 </span>            : 
<span class="lineNum">    1239 </span><span class="lineNoCov">          0 :         if (!path-&gt;seg[i].dx) {</span>
<span class="lineNum">    1240 </span>            :                 angle = GF_PI2;
<span class="lineNum">    1241 </span><span class="lineNoCov">          0 :         } else {</span>
<span class="lineNum">    1242 </span><span class="lineNoCov">          0 :                 angle = gf_acos( gf_divfix(path-&gt;seg[i].dx , path-&gt;seg[i].len) );</span>
<span class="lineNum">    1243 </span>            :         }
<span class="lineNum">    1244 </span><span class="lineNoCov">          0 :         if (path-&gt;seg[i].dy&lt;0) angle *= -1;</span>
<span class="lineNum">    1245 </span>            : 
<span class="lineNum">    1246 </span><span class="lineNoCov">          0 :         if (smooth_edges) {</span>
<span class="lineNum">    1247 </span><span class="lineNoCov">          0 :                 if (offset + length_after_point &gt; curLen + path-&gt;seg[i].len) {</span>
<span class="lineNum">    1248 </span><span class="lineNoCov">          0 :                         Fixed ratio = gf_divfix(curLen + path-&gt;seg[i].len-offset, length_after_point);</span>
<span class="lineNum">    1249 </span><span class="lineNoCov">          0 :                         if (i &lt; path-&gt;num_seg - 1) {</span>
<span class="lineNum">    1250 </span><span class="lineNoCov">          0 :                                 if (!path-&gt;seg[i+1].dx) {</span>
<span class="lineNum">    1251 </span>            :                                         angleNext = GF_PI2;
<span class="lineNum">    1252 </span><span class="lineNoCov">          0 :                                 } else {</span>
<span class="lineNum">    1253 </span><span class="lineNoCov">          0 :                                         angleNext = gf_acos( gf_divfix(path-&gt;seg[i+1].dx, path-&gt;seg[i+1].len) );</span>
<span class="lineNum">    1254 </span>            :                                 }
<span class="lineNum">    1255 </span><span class="lineNoCov">          0 :                                 if (path-&gt;seg[i+1].dy&lt;0) angleNext *= -1;</span>
<span class="lineNum">    1256 </span>            : 
<span class="lineNum">    1257 </span><span class="lineNoCov">          0 :                                 if (angle&lt;0 &amp;&amp; angleNext&gt;0) {</span>
<span class="lineNum">    1258 </span><span class="lineNoCov">          0 :                                         angle = gf_mulfix(FIX_ONE-ratio, angleNext) - gf_mulfix(ratio, angle);</span>
<span class="lineNum">    1259 </span><span class="lineNoCov">          0 :                                 } else {</span>
<span class="lineNum">    1260 </span><span class="lineNoCov">          0 :                                         angle = gf_mulfix(ratio, angle) + gf_mulfix(FIX_ONE-ratio, angleNext);</span>
<span class="lineNum">    1261 </span>            :                                 }
<span class="lineNum">    1262 </span>            :                         }
<span class="lineNum">    1263 </span>            :                 }
<span class="lineNum">    1264 </span>            :         }
<span class="lineNum">    1265 </span>            :         /*handle res=0 case for rotation (point on line join)*/
<span class="lineNum">    1266 </span><span class="lineNoCov">          0 :         else if (res==1) {</span>
<span class="lineNum">    1267 </span><span class="lineNoCov">          0 :                 if (i &lt; path-&gt;num_seg - 1) {</span>
<span class="lineNum">    1268 </span><span class="lineNoCov">          0 :                         if (!path-&gt;seg[i+1].dx) {</span>
<span class="lineNum">    1269 </span>            :                                 angleNext = GF_PI2;
<span class="lineNum">    1270 </span><span class="lineNoCov">          0 :                         } else {</span>
<span class="lineNum">    1271 </span><span class="lineNoCov">          0 :                                 angleNext = gf_acos( gf_divfix(path-&gt;seg[i+1].dx, path-&gt;seg[i+1].len) );</span>
<span class="lineNum">    1272 </span>            :                         }
<span class="lineNum">    1273 </span><span class="lineNoCov">          0 :                         if (path-&gt;seg[i+1].dy&lt;0) angleNext *= -1;</span>
<span class="lineNum">    1274 </span><span class="lineNoCov">          0 :                         angle = ( angle + angleNext) / 2;</span>
<span class="lineNum">    1275 </span><span class="lineNoCov">          0 :                 }</span>
<span class="lineNum">    1276 </span>            :         }
<span class="lineNum">    1277 </span>            : 
<span class="lineNum">    1278 </span><span class="lineNoCov">          0 :         gf_mx2d_init(rot);</span>
<span class="lineNum">    1279 </span><span class="lineNoCov">          0 :         gf_mx2d_add_rotation(&amp;rot, 0, 0, angle);</span>
<span class="lineNum">    1280 </span><span class="lineNoCov">          0 :         gf_mx2d_add_matrix(mat, &amp;rot);</span>
<span class="lineNum">    1281 </span><span class="lineNoCov">          0 :         gf_mx2d_add_matrix(mat, &amp;final);</span>
<span class="lineNum">    1282 </span><span class="lineNoCov">          0 :         return GF_TRUE;</span>
<span class="lineNum">    1283 </span><span class="lineNoCov">          0 : }</span>
<a name="1284"><span class="lineNum">    1284 </span>            : </a>
<span class="lineNum">    1285 </span>            : GF_EXPORT
<span class="lineNum">    1286 </span>            : void gf_path_iterator_del(GF_PathIterator *it)
<span class="lineNum">    1287 </span>            : {
<span class="lineNum">    1288 </span><span class="lineNoCov">          0 :         if (it-&gt;seg) gf_free(it-&gt;seg);</span>
<span class="lineNum">    1289 </span><span class="lineNoCov">          0 :         gf_free(it);</span>
<span class="lineNum">    1290 </span><span class="lineNoCov">          0 : }</span>
<span class="lineNum">    1291 </span>            : 
<span class="lineNum">    1292 </span>            : 
<span class="lineNum">    1293 </span>            : #define ConvexCompare(delta)    \
<span class="lineNum">    1294 </span>            :     ( (delta.x &gt; 0) ? -1 :           \
<span class="lineNum">    1295 </span>            :       (delta.x &lt; 0) ?        1 :             \
<span class="lineNum">    1296 </span>            :       (delta.y &gt; 0) ? -1 :           \
<span class="lineNum">    1297 </span>            :       (delta.y &lt; 0) ?        1 :     \
<span class="lineNum">    1298 </span>            :       0 )
<span class="lineNum">    1299 </span>            : 
<span class="lineNum">    1300 </span>            : #define ConvexGetPointDelta(delta, pprev, pcur )                        \
<span class="lineNum">    1301 </span>            :     /* Given a previous point 'pprev', read a new point into 'pcur' */  \
<span class="lineNum">    1302 </span>            :     /* and return delta in 'delta'.                                 */  \
<span class="lineNum">    1303 </span>            :     pcur = pts[iread++];                                                \
<span class="lineNum">    1304 </span>            :     delta.x = pcur.x - pprev.x;                                 \
<span class="lineNum">    1305 </span>            :     delta.y = pcur.y - pprev.y;                                 \
<span class="lineNum">    1306 </span>            :  
<span class="lineNum">    1307 </span>            : #define ConvexCross(p, q) gf_mulfix(p.x,q.y) - gf_mulfix(p.y,q.x);
<span class="lineNum">    1308 </span>            : 
<span class="lineNum">    1309 </span>            : #define ConvexCheckTriple                                               \
<span class="lineNum">    1310 </span>            :     if ( (thisDir = ConvexCompare(dcur)) == -curDir ) {                 \
<span class="lineNum">    1311 </span>            :           ++dirChanges;                                                 \
<span class="lineNum">    1312 </span>            :           /* if ( dirChanges &gt; 2 ) return NotConvex;              */ \
<span class="lineNum">    1313 </span>            :     }                                                                   \
<span class="lineNum">    1314 </span>            :     curDir = thisDir;                                                   \
<span class="lineNum">    1315 </span>            :     cross = ConvexCross(dprev, dcur);                                   \
<span class="lineNum">    1316 </span>            :     if ( cross &gt; 0 ) { \
<span class="lineNum">    1317 </span>            :                 if ( angleSign == -1 ) return GF_POLYGON_COMPLEX_CW;            \
<span class="lineNum">    1318 </span>            :                 angleSign = 1;                                  \
<span class="lineNum">    1319 </span>            :         }                                                       \
<span class="lineNum">    1320 </span>            :     else if (cross &lt; 0) {    \
<span class="lineNum">    1321 </span>            :                 if (angleSign == 1) return GF_POLYGON_COMPLEX_CCW;              \
<span class="lineNum">    1322 </span>            :                 angleSign = -1;                         \
<span class="lineNum">    1323 </span>            :         }                                               \
<span class="lineNum">    1324 </span>            :     pSecond = pThird;           \
<span class="lineNum">    1325 </span>            :     dprev.x = dcur.x;           \
<span class="lineNum">    1326 </span>            :     dprev.y = dcur.y;                                                   \
<a name="1327"><span class="lineNum">    1327 </span>            :  </a>
<span class="lineNum">    1328 </span>            : GF_EXPORT
<span class="lineNum">    1329 </span>            : u32 gf_polygone2d_get_convexity(GF_Point2D *pts, u32 len)
<span class="lineNum">    1330 </span>            : {
<span class="lineNum">    1331 </span>            :         s32 curDir, thisDir = 0, dirChanges = 0, angleSign = 0;
<span class="lineNum">    1332 </span>            :         u32 iread;
<span class="lineNum">    1333 </span>            :         Fixed cross;
<span class="lineNum">    1334 </span>            :         GF_Point2D pSecond, pThird, pSaveSecond;
<span class="lineNum">    1335 </span>            :         GF_Point2D dprev, dcur;
<span class="lineNum">    1336 </span>            : 
<span class="lineNum">    1337 </span>            :         /* Get different point, return if less than 3 diff points. */
<span class="lineNum">    1338 </span><span class="lineNoCov">          0 :         if (len &lt; 3 ) return GF_POLYGON_CONVEX_LINE;</span>
<span class="lineNum">    1339 </span>            :         iread = 1;
<span class="lineNum">    1340 </span><span class="lineNoCov">          0 :         ConvexGetPointDelta(dprev, (pts[0]), pSecond);</span>
<span class="lineNum">    1341 </span>            :         pSaveSecond = pSecond;
<span class="lineNum">    1342 </span>            :         /*initial direction */
<span class="lineNum">    1343 </span><span class="lineNoCov">          0 :         curDir = ConvexCompare(dprev);</span>
<span class="lineNum">    1344 </span><span class="lineNoCov">          0 :         while ( iread &lt; len) {</span>
<span class="lineNum">    1345 </span>            :                 /* Get different point, break if no more points */
<span class="lineNum">    1346 </span><span class="lineNoCov">          0 :                 ConvexGetPointDelta(dcur, pSecond, pThird );</span>
<span class="lineNum">    1347 </span><span class="lineNoCov">          0 :                 if ( (dcur.x == 0) &amp;&amp; (dcur.y == 0) ) continue;</span>
<span class="lineNum">    1348 </span>            :                 /* Check current three points */
<span class="lineNum">    1349 </span><span class="lineNoCov">          0 :                 ConvexCheckTriple;</span>
<span class="lineNum">    1350 </span><span class="lineNoCov">          0 :         }</span>
<span class="lineNum">    1351 </span>            : 
<span class="lineNum">    1352 </span>            :         /* Must check for direction changes from last vertex back to first */
<span class="lineNum">    1353 </span>            :         /* Prepare for 'ConvexCheckTriple' */
<span class="lineNum">    1354 </span><span class="lineNoCov">          0 :         pThird = pts[0];</span>
<span class="lineNum">    1355 </span><span class="lineNoCov">          0 :         dcur.x = pThird.x - pSecond.x;</span>
<span class="lineNum">    1356 </span><span class="lineNoCov">          0 :         dcur.y = pThird.y - pSecond.y;</span>
<span class="lineNum">    1357 </span><span class="lineNoCov">          0 :         if ( ConvexCompare(dcur) ) ConvexCheckTriple;</span>
<span class="lineNum">    1358 </span>            : 
<span class="lineNum">    1359 </span>            :         /* and check for direction changes back to second vertex */
<span class="lineNum">    1360 </span><span class="lineNoCov">          0 :         dcur.x = pSaveSecond.x - pSecond.x;</span>
<span class="lineNum">    1361 </span><span class="lineNoCov">          0 :         dcur.y = pSaveSecond.y - pSecond.y;</span>
<span class="lineNum">    1362 </span>            :         /* Don't care about 'pThird' now */
<span class="lineNum">    1363 </span><span class="lineNoCov">          0 :         ConvexCheckTriple;</span>
<span class="lineNum">    1364 </span>            : 
<span class="lineNum">    1365 </span>            :         /* Decide on polygon type given accumulated status */
<span class="lineNum">    1366 </span><span class="lineNoCov">          0 :         if ( dirChanges &gt; 2 ) return GF_POLYGON_COMPLEX;</span>
<span class="lineNum">    1367 </span><span class="lineNoCov">          0 :         if ( angleSign &gt; 0 ) return GF_POLYGON_CONVEX_CCW;</span>
<span class="lineNum">    1368 </span><span class="lineNoCov">          0 :         if ( angleSign &lt; 0 ) return GF_POLYGON_CONVEX_CW;</span>
<span class="lineNum">    1369 </span><span class="lineNoCov">          0 :         return GF_POLYGON_CONVEX_LINE;</span>
<span class="lineNum">    1370 </span><span class="lineNoCov">          0 : }</span>
</pre>
      </td>
    </tr>
  </table>
  <br>

  <table width="100%" border=0 cellspacing=0 cellpadding=0>
    <tr><td class="ruler"><img src="../../glass.png" width=3 height=3 alt=""></td></tr>
    <tr><td class="versionInfo">Generated by: <a href="http://ltp.sourceforge.net/coverage/lcov.php" target="_parent">LCOV version 1.12</a></td></tr>
  </table>
  <br>

</body>
</html>
