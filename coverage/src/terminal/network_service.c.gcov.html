<!DOCTYPE HTML PUBLIC "-//W3C//DTD HTML 4.01 Transitional//EN">

<html lang="en">

<head>
  <meta http-equiv="Content-Type" content="text/html; charset=UTF-8">
  <title>LCOV - coverage.info - src/terminal/network_service.c</title>
  <link rel="stylesheet" type="text/css" href="../../gcov.css">
</head>

<body>

  <table width="100%" border=0 cellspacing=0 cellpadding=0>
    <tr><td class="title">LCOV - code coverage report</td></tr>
    <tr><td class="ruler"><img src="../../glass.png" width=3 height=3 alt=""></td></tr>

    <tr>
      <td width="100%">
        <table cellpadding=1 border=0 width="100%">
          <tr>
            <td width="10%" class="headerItem">Current view:</td>
            <td width="35%" class="headerValue"><a href="../../index.html">top level</a> - <a href="index.html">src/terminal</a> - network_service.c<span style="font-size: 80%;"> (source / <a href="network_service.c.func-sort-c.html">functions</a>)</span></td>
            <td width="5%"></td>
            <td width="15%"></td>
            <td width="10%" class="headerCovTableHead">Hit</td>
            <td width="10%" class="headerCovTableHead">Total</td>
            <td width="15%" class="headerCovTableHead">Coverage</td>
          </tr>
          <tr>
            <td class="headerItem">Test:</td>
            <td class="headerValue">coverage.info</td>
            <td></td>
            <td class="headerItem">Lines:</td>
            <td class="headerCovTableEntry">0</td>
            <td class="headerCovTableEntry">818</td>
            <td class="headerCovTableEntryLo">0.0 %</td>
          </tr>
          <tr>
            <td class="headerItem">Date:</td>
            <td class="headerValue">2016-06-07 10:36:32</td>
            <td></td>
            <td class="headerItem">Functions:</td>
            <td class="headerCovTableEntry">0</td>
            <td class="headerCovTableEntry">34</td>
            <td class="headerCovTableEntryLo">0.0 %</td>
          </tr>
          <tr><td><img src="../../glass.png" width=3 height=3 alt=""></td></tr>
        </table>
      </td>
    </tr>

    <tr><td class="ruler"><img src="../../glass.png" width=3 height=3 alt=""></td></tr>
  </table>

  <table cellpadding=0 cellspacing=0 border=0>
    <tr>
      <td><br></td>
    </tr>
    <tr>
      <td>
<pre class="sourceHeading">          Line data    Source code</pre>
<pre class="source">
<a name="1"><span class="lineNum">       1 </span>            : /*</a>
<span class="lineNum">       2 </span>            :  *                      GPAC - Multimedia Framework C SDK
<span class="lineNum">       3 </span>            :  *
<span class="lineNum">       4 </span>            :  *                      Authors: Jean Le Feuvre
<span class="lineNum">       5 </span>            :  *                      Copyright (c) Telecom ParisTech 2000-2012
<span class="lineNum">       6 </span>            :  *                                      All rights reserved
<span class="lineNum">       7 </span>            :  *
<span class="lineNum">       8 </span>            :  *  This file is part of GPAC / Media terminal sub-project
<span class="lineNum">       9 </span>            :  *
<span class="lineNum">      10 </span>            :  *  GPAC is free software; you can redistribute it and/or modify
<span class="lineNum">      11 </span>            :  *  it under the terms of the GNU Lesser General Public License as published by
<span class="lineNum">      12 </span>            :  *  the Free Software Foundation; either version 2, or (at your option)
<span class="lineNum">      13 </span>            :  *  any later version.
<span class="lineNum">      14 </span>            :  *
<span class="lineNum">      15 </span>            :  *  GPAC is distributed in the hope that it will be useful,
<span class="lineNum">      16 </span>            :  *  but WITHOUT ANY WARRANTY; without even the implied warranty of
<span class="lineNum">      17 </span>            :  *  MERCHANTABILITY or FITNESS FOR A PARTICULAR PURPOSE.  See the
<span class="lineNum">      18 </span>            :  *  GNU Lesser General Public License for more details.
<span class="lineNum">      19 </span>            :  *
<span class="lineNum">      20 </span>            :  *  You should have received a copy of the GNU Lesser General Public
<span class="lineNum">      21 </span>            :  *  License along with this library; see the file COPYING.  If not, write to
<span class="lineNum">      22 </span>            :  *  the Free Software Foundation, 675 Mass Ave, Cambridge, MA 02139, USA.
<span class="lineNum">      23 </span>            :  *
<span class="lineNum">      24 </span>            :  */
<span class="lineNum">      25 </span>            : 
<span class="lineNum">      26 </span>            : #include &lt;gpac/internal/terminal_dev.h&gt;
<span class="lineNum">      27 </span>            : #include &lt;gpac/internal/compositor_dev.h&gt;
<span class="lineNum">      28 </span>            : #include &lt;gpac/network.h&gt;
<span class="lineNum">      29 </span>            : #include &lt;gpac/cache.h&gt;
<span class="lineNum">      30 </span>            : #include &quot;media_memory.h&quot;
<span class="lineNum">      31 </span>            : #include &quot;media_control.h&quot;
<span class="lineNum">      32 </span>            : 
<span class="lineNum">      33 </span>            : 
<span class="lineNum">      34 </span>            : 
<a name="35"><span class="lineNum">      35 </span>            : #define GET_TERM()      GF_Terminal *term = (GF_Terminal *) user_priv; if (!term) return;</a>
<span class="lineNum">      36 </span>            : 
<span class="lineNum">      37 </span>            : static GFINLINE GF_Channel *gf_term_get_channel(GF_ClientService *service, LPNETCHANNEL ns)
<span class="lineNum">      38 </span>            : {
<span class="lineNum">      39 </span><span class="lineNoCov">          0 :         GF_Channel *ch = (GF_Channel *)ns;</span>
<span class="lineNum">      40 </span><span class="lineNoCov">          0 :         if (!service || !ch) return NULL;</span>
<span class="lineNum">      41 </span><span class="lineNoCov">          0 :         if (ch-&gt;service != service) return NULL;</span>
<span class="lineNum">      42 </span><span class="lineNoCov">          0 :         return ch;</span>
<a name="43"><span class="lineNum">      43 </span><span class="lineNoCov">          0 : }</span></a>
<span class="lineNum">      44 </span>            : 
<span class="lineNum">      45 </span>            : static void term_on_connect(GF_ClientService *service, LPNETCHANNEL netch, GF_Err err)
<span class="lineNum">      46 </span>            : {
<span class="lineNum">      47 </span>            :         GF_Channel *ch;
<span class="lineNum">      48 </span>            :         GF_ObjectManager *root;
<span class="lineNum">      49 </span><span class="lineNoCov">          0 :         GF_Terminal *term = service-&gt;term;</span>
<span class="lineNum">      50 </span>            : 
<span class="lineNum">      51 </span><span class="lineNoCov">          0 :         GF_LOG(GF_LOG_DEBUG, GF_LOG_MEDIA, (&quot;[Terminal] %s connection ACK received from %s - %s\n&quot;, netch ? &quot;Channel&quot; : &quot;Service&quot;, service-&gt;url, gf_error_to_string(err) ));</span>
<span class="lineNum">      52 </span>            : 
<span class="lineNum">      53 </span><span class="lineNoCov">          0 :         root = service-&gt;owner;</span>
<span class="lineNum">      54 </span><span class="lineNoCov">          0 :         if (root &amp;&amp; (root-&gt;net_service != service)) {</span>
<span class="lineNum">      55 </span><span class="lineNoCov">          0 :                 gf_term_message(term, service-&gt;url, &quot;Incompatible module type&quot;, GF_SERVICE_ERROR);</span>
<span class="lineNum">      56 </span><span class="lineNoCov">          0 :                 return;</span>
<span class="lineNum">      57 </span>            :         }
<span class="lineNum">      58 </span>            :         /*this is service connection*/
<span class="lineNum">      59 </span><span class="lineNoCov">          0 :         if (!netch) {</span>
<span class="lineNum">      60 </span><span class="lineNoCov">          0 :                 gf_term_service_media_event(service-&gt;owner, GF_EVENT_MEDIA_SETUP_DONE);</span>
<span class="lineNum">      61 </span><span class="lineNoCov">          0 :                 if (err) {</span>
<span class="lineNum">      62 </span><span class="lineNoCov">          0 :                         char msg[5000];</span>
<span class="lineNum">      63 </span><span class="lineNoCov">          0 :                         snprintf(msg, sizeof(msg), &quot;Cannot open %s&quot;, service-&gt;url);</span>
<span class="lineNum">      64 </span><span class="lineNoCov">          0 :                         gf_term_message(term, service-&gt;url, msg, err);</span>
<span class="lineNum">      65 </span>            : 
<span class="lineNum">      66 </span><span class="lineNoCov">          0 :                         gf_term_service_media_event(service-&gt;owner, GF_EVENT_ERROR);</span>
<span class="lineNum">      67 </span>            : 
<span class="lineNum">      68 </span>            :                         /*destroy service only if attached*/
<span class="lineNum">      69 </span><span class="lineNoCov">          0 :                         if (root) {</span>
<span class="lineNum">      70 </span><span class="lineNoCov">          0 :                                 gf_term_lock_media_queue(term, 1);</span>
<span class="lineNum">      71 </span>            :                                 //notify before disconnecting
<span class="lineNum">      72 </span><span class="lineNoCov">          0 :                                 if (root-&gt;subscene) gf_scene_notify_event(root-&gt;subscene, GF_EVENT_SCENE_ATTACHED, NULL, NULL, err, GF_FALSE);</span>
<span class="lineNum">      73 </span>            : 
<span class="lineNum">      74 </span><span class="lineNoCov">          0 :                                 service-&gt;ifce-&gt;CloseService(service-&gt;ifce);</span>
<span class="lineNum">      75 </span><span class="lineNoCov">          0 :                                 root-&gt;net_service = NULL;</span>
<span class="lineNum">      76 </span><span class="lineNoCov">          0 :                                 if (service-&gt;owner &amp;&amp; service-&gt;nb_odm_users) service-&gt;nb_odm_users--;</span>
<span class="lineNum">      77 </span><span class="lineNoCov">          0 :                                 service-&gt;owner = NULL;</span>
<span class="lineNum">      78 </span>            :                                 /*depends on module: some module could forget to call gf_service_disconnect_ack */
<span class="lineNum">      79 </span><span class="lineNoCov">          0 :                                 if ( gf_list_del_item(term-&gt;net_services, service) &gt;= 0) {</span>
<span class="lineNum">      80 </span>            :                                         /*and queue for destroy*/
<span class="lineNum">      81 </span><span class="lineNoCov">          0 :                                         gf_list_add(term-&gt;net_services_to_remove, service);</span>
<span class="lineNum">      82 </span><span class="lineNoCov">          0 :                                 }</span>
<span class="lineNum">      83 </span>            : 
<span class="lineNum">      84 </span><span class="lineNoCov">          0 :                                 gf_term_lock_media_queue(term, 0);</span>
<span class="lineNum">      85 </span>            : 
<span class="lineNum">      86 </span><span class="lineNoCov">          0 :                                 if (!root-&gt;parentscene) {</span>
<span class="lineNum">      87 </span><span class="lineNoCov">          0 :                                         GF_Event evt;</span>
<span class="lineNum">      88 </span><span class="lineNoCov">          0 :                                         evt.type = GF_EVENT_CONNECT;</span>
<span class="lineNum">      89 </span><span class="lineNoCov">          0 :                                         evt.connect.is_connected = 0;</span>
<span class="lineNum">      90 </span><span class="lineNoCov">          0 :                                         gf_term_send_event(term, &amp;evt);</span>
<span class="lineNum">      91 </span><span class="lineNoCov">          0 :                                 } else {</span>
<span class="lineNum">      92 </span>            :                                         /*try to reinsert OD for VRML/X3D with multiple URLs:
<span class="lineNum">      93 </span>            :                                         1- first remove from parent scene without destroying object, this will trigger a re-setup
<span class="lineNum">      94 </span>            :                                         if other URLs are present
<span class="lineNum">      95 </span>            :                                         2- then destroy object*/
<span class="lineNum">      96 </span><span class="lineNoCov">          0 :                                         gf_scene_remove_object(root-&gt;parentscene, root, 0);</span>
<span class="lineNum">      97 </span><span class="lineNoCov">          0 :                                         gf_odm_disconnect(root, 1);</span>
<span class="lineNum">      98 </span>            :                                 }
<span class="lineNum">      99 </span><span class="lineNoCov">          0 :                                 return;</span>
<span class="lineNum">     100 </span>            :                         }
<span class="lineNum">     101 </span><span class="lineNoCov">          0 :                 }</span>
<span class="lineNum">     102 </span>            : 
<span class="lineNum">     103 </span><span class="lineNoCov">          0 :                 if (!root) {</span>
<span class="lineNum">     104 </span>            :                         /*channel service connect*/
<span class="lineNum">     105 </span>            :                         u32 i;
<span class="lineNum">     106 </span>            :                         GF_ChannelSetup *cs;
<span class="lineNum">     107 </span>            :                         GF_List *ODs;
<span class="lineNum">     108 </span>            : 
<span class="lineNum">     109 </span><span class="lineNoCov">          0 :                         if (!gf_list_count(term-&gt;channels_pending)) {</span>
<span class="lineNum">     110 </span>            :                                 return;
<span class="lineNum">     111 </span>            :                         }
<span class="lineNum">     112 </span><span class="lineNoCov">          0 :                         ODs = gf_list_new();</span>
<span class="lineNum">     113 </span><span class="lineNoCov">          0 :                         gf_term_lock_net(term, 1);</span>
<span class="lineNum">     114 </span><span class="lineNoCov">          0 :                         i=0;</span>
<span class="lineNum">     115 </span><span class="lineNoCov">          0 :                         while ((cs = (GF_ChannelSetup*)gf_list_enum(term-&gt;channels_pending, &amp;i))) {</span>
<span class="lineNum">     116 </span><span class="lineNoCov">          0 :                                 if (cs-&gt;ch-&gt;service != service) continue;</span>
<span class="lineNum">     117 </span><span class="lineNoCov">          0 :                                 gf_list_rem(term-&gt;channels_pending, i-1);</span>
<span class="lineNum">     118 </span><span class="lineNoCov">          0 :                                 i--;</span>
<span class="lineNum">     119 </span>            :                                 /*even if error do setup (channel needs to be deleted)*/
<span class="lineNum">     120 </span><span class="lineNoCov">          0 :                                 if (gf_odm_post_es_setup(cs-&gt;ch, cs-&gt;dec, err) == GF_OK) {</span>
<span class="lineNum">     121 </span><span class="lineNoCov">          0 :                                         if (cs-&gt;ch-&gt;odm &amp;&amp; (gf_list_find(ODs, cs-&gt;ch-&gt;odm)==-1) ) gf_list_add(ODs, cs-&gt;ch-&gt;odm);</span>
<span class="lineNum">     122 </span>            :                                 }
<span class="lineNum">     123 </span><span class="lineNoCov">          0 :                                 gf_free(cs);</span>
<span class="lineNum">     124 </span><span class="lineNoCov">          0 :                         }</span>
<span class="lineNum">     125 </span><span class="lineNoCov">          0 :                         gf_term_lock_net(term, 0);</span>
<span class="lineNum">     126 </span>            :                         /*finally setup all ODs concerned (we do this later in case of scalability)*/
<span class="lineNum">     127 </span><span class="lineNoCov">          0 :                         while (gf_list_count(ODs)) {</span>
<span class="lineNum">     128 </span><span class="lineNoCov">          0 :                                 GF_ObjectManager *odm = (GF_ObjectManager*)gf_list_get(ODs, 0);</span>
<span class="lineNum">     129 </span><span class="lineNoCov">          0 :                                 gf_list_rem(ODs, 0);</span>
<span class="lineNum">     130 </span>            :                                 /*force re-setup*/
<span class="lineNum">     131 </span><span class="lineNoCov">          0 :                                 gf_scene_setup_object(odm-&gt;parentscene, odm);</span>
<span class="lineNum">     132 </span><span class="lineNoCov">          0 :                         }</span>
<span class="lineNum">     133 </span><span class="lineNoCov">          0 :                         gf_list_del(ODs);</span>
<span class="lineNum">     134 </span><span class="lineNoCov">          0 :                 } else {</span>
<span class="lineNum">     135 </span>            :                         /*setup od*/
<span class="lineNum">     136 </span><span class="lineNoCov">          0 :                         gf_odm_setup_entry_point(root, service-&gt;url);</span>
<span class="lineNum">     137 </span>            :                 }
<span class="lineNum">     138 </span>            :                 /*load cache if requested*/
<span class="lineNum">     139 </span><span class="lineNoCov">          0 :                 if (!err &amp;&amp; term-&gt;enable_cache) {</span>
<span class="lineNum">     140 </span><span class="lineNoCov">          0 :                         err = gf_term_service_cache_load(service);</span>
<span class="lineNum">     141 </span>            :                         /*not a fatal error*/
<span class="lineNum">     142 </span><span class="lineNoCov">          0 :                         if (err) gf_term_message(term, &quot;GPAC Cache&quot;, &quot;Cannot load cache&quot;, err);</span>
<span class="lineNum">     143 </span>            :                 }
<span class="lineNum">     144 </span>            :                 return;
<span class="lineNum">     145 </span>            :         }
<span class="lineNum">     146 </span>            : 
<span class="lineNum">     147 </span>            :         /*this is channel connection*/
<span class="lineNum">     148 </span><span class="lineNoCov">          0 :         ch = gf_term_get_channel(service, netch);</span>
<span class="lineNum">     149 </span><span class="lineNoCov">          0 :         if (!ch) {</span>
<span class="lineNum">     150 </span><span class="lineNoCov">          0 :                 GF_LOG(GF_LOG_ERROR, GF_LOG_MEDIA, (&quot;[Terminal] Channel connection ACK error: channel not found\n&quot;));</span>
<span class="lineNum">     151 </span>            :                 return;
<span class="lineNum">     152 </span>            :         }
<span class="lineNum">     153 </span>            : 
<span class="lineNum">     154 </span>            :         /*confirm channel connection even if error - this allow playback of objects even if not all streams are setup*/
<span class="lineNum">     155 </span><span class="lineNoCov">          0 :         gf_term_lock_net(term, 1);</span>
<span class="lineNum">     156 </span><span class="lineNoCov">          0 :         gf_es_on_connect(ch);</span>
<span class="lineNum">     157 </span><span class="lineNoCov">          0 :         gf_term_lock_net(term, 0);</span>
<span class="lineNum">     158 </span>            : 
<span class="lineNum">     159 </span><span class="lineNoCov">          0 :         if (err &amp;&amp; ((err!=GF_STREAM_NOT_FOUND) || (ch-&gt;esd-&gt;decoderConfig-&gt;streamType!=GF_STREAM_INTERACT))) {</span>
<span class="lineNum">     160 </span><span class="lineNoCov">          0 :                 GF_LOG(GF_LOG_ERROR, GF_LOG_MEDIA, (&quot;[Terminal] Channel %d connection error: %s\n&quot;, ch-&gt;esd-&gt;ESID, gf_error_to_string(err) ));</span>
<span class="lineNum">     161 </span><span class="lineNoCov">          0 :                 ch-&gt;es_state = GF_ESM_ES_UNAVAILABLE;</span>
<span class="lineNum">     162 </span>            :                 /*              return;*/
<span class="lineNum">     163 </span><span class="lineNoCov">          0 :         }</span>
<span class="lineNum">     164 </span>            : 
<span class="lineNum">     165 </span><span class="lineNoCov">          0 :         if (ch-&gt;odm-&gt;mo) {</span>
<span class="lineNum">     166 </span><span class="lineNoCov">          0 :                 GF_LOG(GF_LOG_DEBUG, GF_LOG_MEDIA, (&quot;[Terminal] Channel %d connected - %d objects opened\n&quot;, ch-&gt;esd-&gt;ESID, ch-&gt;odm-&gt;mo-&gt;num_open ));</span>
<span class="lineNum">     167 </span>            :         } else {
<span class="lineNum">     168 </span><span class="lineNoCov">          0 :                 GF_LOG(GF_LOG_DEBUG, GF_LOG_MEDIA, (&quot;[Terminal] Channel %d connected - not attached to the scene\n&quot;, ch-&gt;esd-&gt;ESID));</span>
<span class="lineNum">     169 </span>            :         }
<span class="lineNum">     170 </span>            :         /*Plays request are skiped until all channels are connected. We send a PLAY on the objecy in case
<span class="lineNum">     171 </span>            :                 1-OD user has requested a play
<span class="lineNum">     172 </span>            :                 2-this is a channel of the root OD
<span class="lineNum">     173 </span>            :         */
<span class="lineNum">     174 </span><span class="lineNoCov">          0 :         if ( (ch-&gt;odm-&gt;mo &amp;&amp; ch-&gt;odm-&gt;mo-&gt;num_open)</span>
<span class="lineNum">     175 </span>            :                 || !ch-&gt;odm-&gt;parentscene
<span class="lineNum">     176 </span>            :            ) {
<span class="lineNum">     177 </span><span class="lineNoCov">          0 :                 gf_odm_start(ch-&gt;odm, 0);</span>
<span class="lineNum">     178 </span><span class="lineNoCov">          0 :         }</span>
<span class="lineNum">     179 </span>            : #if 0
<span class="lineNum">     180 </span>            :         else if (ch-&gt;odm-&gt;codec &amp;&amp; ch-&gt;odm-&gt;codec-&gt;ck &amp;&amp; ch-&gt;odm-&gt;codec-&gt;ck-&gt;no_time_ctrl) {
<span class="lineNum">     181 </span>            :                 gf_odm_play(ch-&gt;odm);
<span class="lineNum">     182 </span>            :         }
<span class="lineNum">     183 </span>            : #endif
<a name="184"><span class="lineNum">     184 </span><span class="lineNoCov">          0 : }</span></a>
<span class="lineNum">     185 </span>            : 
<span class="lineNum">     186 </span>            : static void term_on_disconnect(GF_ClientService *service, LPNETCHANNEL netch, GF_Err response)
<span class="lineNum">     187 </span>            : {
<span class="lineNum">     188 </span>            :         GF_ObjectManager *root;
<span class="lineNum">     189 </span>            :         GF_Channel *ch;
<span class="lineNum">     190 </span><span class="lineNoCov">          0 :         GF_Terminal *term = service-&gt;term;</span>
<span class="lineNum">     191 </span>            : 
<span class="lineNum">     192 </span>            :         /*may be null upon destroy*/
<span class="lineNum">     193 </span><span class="lineNoCov">          0 :         root = service-&gt;owner;</span>
<span class="lineNum">     194 </span><span class="lineNoCov">          0 :         if (root &amp;&amp; (root-&gt;net_service != service)) {</span>
<span class="lineNum">     195 </span><span class="lineNoCov">          0 :                 if (root-&gt;net_service) gf_term_message(term, service-&gt;url, &quot;Incompatible module type&quot;, GF_SERVICE_ERROR);</span>
<span class="lineNum">     196 </span>            :                 return;
<span class="lineNum">     197 </span>            :         }
<span class="lineNum">     198 </span>            :         //reset global seek time
<span class="lineNum">     199 </span><span class="lineNoCov">          0 :         if (term-&gt;root_scene &amp;&amp; term-&gt;root_scene-&gt;root_od)</span>
<span class="lineNum">     200 </span><span class="lineNoCov">          0 :                 term-&gt;root_scene-&gt;root_od-&gt;media_start_time = 0;</span>
<span class="lineNum">     201 </span>            : 
<span class="lineNum">     202 </span>            :         /*this is service disconnect*/
<span class="lineNum">     203 </span><span class="lineNoCov">          0 :         if (!netch) {</span>
<span class="lineNum">     204 </span><span class="lineNoCov">          0 :                 if (service-&gt;subservice_disconnect) {</span>
<span class="lineNum">     205 </span><span class="lineNoCov">          0 :                         if (service-&gt;owner &amp;&amp; service-&gt;subservice_disconnect==1) {</span>
<span class="lineNum">     206 </span><span class="lineNoCov">          0 :                                 GF_Scene *scene = service-&gt;owner-&gt;subscene ? service-&gt;owner-&gt;subscene : service-&gt;owner-&gt;parentscene;</span>
<span class="lineNum">     207 </span>            :                                 /*destroy all media*/
<span class="lineNum">     208 </span><span class="lineNoCov">          0 :                                 gf_scene_disconnect(scene, 1);</span>
<span class="lineNum">     209 </span><span class="lineNoCov">          0 :                         }</span>
<span class="lineNum">     210 </span>            :                         return;
<span class="lineNum">     211 </span>            :                 }
<span class="lineNum">     212 </span><span class="lineNoCov">          0 :                 gf_term_lock_media_queue(term, 1);</span>
<span class="lineNum">     213 </span>            :                 /*unregister from valid services*/
<span class="lineNum">     214 </span><span class="lineNoCov">          0 :                 if (gf_list_del_item(term-&gt;net_services, service)&gt;=0) {</span>
<span class="lineNum">     215 </span>            :                         /*and queue for destroy*/
<span class="lineNum">     216 </span><span class="lineNoCov">          0 :                         gf_list_add(term-&gt;net_services_to_remove, service);</span>
<span class="lineNum">     217 </span><span class="lineNoCov">          0 :                 }</span>
<span class="lineNum">     218 </span><span class="lineNoCov">          0 :                 gf_term_lock_media_queue(term, 0);</span>
<span class="lineNum">     219 </span><span class="lineNoCov">          0 :                 return;</span>
<span class="lineNum">     220 </span>            :         }
<span class="lineNum">     221 </span>            :         /*this is channel disconnect*/
<span class="lineNum">     222 </span>            : 
<span class="lineNum">     223 </span>            :         /*no notif in case of failure for disconnection*/
<span class="lineNum">     224 </span><span class="lineNoCov">          0 :         ch = gf_term_get_channel(service, netch);</span>
<span class="lineNum">     225 </span><span class="lineNoCov">          0 :         if (!ch) return;</span>
<span class="lineNum">     226 </span>            :         /*signal channel state*/
<span class="lineNum">     227 </span><span class="lineNoCov">          0 :         ch-&gt;es_state = GF_ESM_ES_DISCONNECTED;</span>
<a name="228"><span class="lineNum">     228 </span><span class="lineNoCov">          0 : }</span></a>
<span class="lineNum">     229 </span>            : 
<span class="lineNum">     230 </span>            : static void term_on_data_packet(GF_ClientService *service, LPNETCHANNEL netch, char *data, u32 data_size, GF_SLHeader *hdr, GF_Err reception_status)
<span class="lineNum">     231 </span>            : {
<span class="lineNum">     232 </span>            :         GF_Channel *ch;
<span class="lineNum">     233 </span>            : 
<span class="lineNum">     234 </span><span class="lineNoCov">          0 :         ch = gf_term_get_channel(service, netch);</span>
<span class="lineNum">     235 </span><span class="lineNoCov">          0 :         if (!ch)</span>
<span class="lineNum">     236 </span>            :                 return;
<span class="lineNum">     237 </span>            : 
<span class="lineNum">     238 </span><span class="lineNoCov">          0 :         if (reception_status==GF_EOS) {</span>
<span class="lineNum">     239 </span><span class="lineNoCov">          0 :                 gf_es_on_eos(ch);</span>
<span class="lineNum">     240 </span><span class="lineNoCov">          0 :                 return;</span>
<span class="lineNum">     241 </span>            :         }
<span class="lineNum">     242 </span>            :         /*otherwise dispatch with error code*/
<span class="lineNum">     243 </span><span class="lineNoCov">          0 :         gf_es_receive_sl_packet(service, ch, data, data_size, hdr, reception_status);</span>
<a name="244"><span class="lineNum">     244 </span><span class="lineNoCov">          0 : }</span></a>
<span class="lineNum">     245 </span>            : 
<span class="lineNum">     246 </span>            : static Bool is_same_od(GF_ObjectDescriptor *od1, GF_ObjectDescriptor *od2)
<span class="lineNum">     247 </span>            : {
<span class="lineNum">     248 </span>            :         GF_ESD *esd1, *esd2;
<span class="lineNum">     249 </span><span class="lineNoCov">          0 :         if (gf_list_count(od1-&gt;ESDescriptors) != gf_list_count(od2-&gt;ESDescriptors)) return 0;</span>
<span class="lineNum">     250 </span><span class="lineNoCov">          0 :         esd1 = gf_list_get(od1-&gt;ESDescriptors, 0);</span>
<span class="lineNum">     251 </span><span class="lineNoCov">          0 :         if (!esd1) return 0;</span>
<span class="lineNum">     252 </span><span class="lineNoCov">          0 :         esd2 = gf_list_get(od2-&gt;ESDescriptors, 0);</span>
<span class="lineNum">     253 </span><span class="lineNoCov">          0 :         if (!esd2) return 0;</span>
<span class="lineNum">     254 </span><span class="lineNoCov">          0 :         if (esd1-&gt;ESID!=esd2-&gt;ESID) return 0;</span>
<span class="lineNum">     255 </span><span class="lineNoCov">          0 :         if (esd1-&gt;decoderConfig-&gt;streamType != esd2-&gt;decoderConfig-&gt;streamType) return 0;</span>
<span class="lineNum">     256 </span><span class="lineNoCov">          0 :         if (esd1-&gt;decoderConfig-&gt;objectTypeIndication != esd2-&gt;decoderConfig-&gt;objectTypeIndication ) return 0;</span>
<span class="lineNum">     257 </span><span class="lineNoCov">          0 :         return 1;</span>
<a name="258"><span class="lineNum">     258 </span><span class="lineNoCov">          0 : }</span></a>
<span class="lineNum">     259 </span>            : 
<span class="lineNum">     260 </span>            : static void term_on_media_add(GF_ClientService *service, GF_Descriptor *media_desc, Bool no_scene_check)
<span class="lineNum">     261 </span>            : {
<span class="lineNum">     262 </span>            :         u32 i, min_od_id;
<span class="lineNum">     263 </span>            :         GF_MediaObject *the_mo;
<span class="lineNum">     264 </span>            :         GF_Scene *scene;
<span class="lineNum">     265 </span>            :         GF_ObjectManager *odm, *root;
<span class="lineNum">     266 </span>            :         GF_ObjectDescriptor *od;
<span class="lineNum">     267 </span><span class="lineNoCov">          0 :         GF_Terminal *term = service-&gt;term;</span>
<span class="lineNum">     268 </span>            : 
<span class="lineNum">     269 </span><span class="lineNoCov">          0 :         root = service-&gt;owner;</span>
<span class="lineNum">     270 </span><span class="lineNoCov">          0 :         if (!root) {</span>
<span class="lineNum">     271 </span><span class="lineNoCov">          0 :                 GF_LOG(GF_LOG_ERROR, GF_LOG_MEDIA, (&quot;[Service %s] has not root, aborting !\n&quot;, service-&gt;url));</span>
<span class="lineNum">     272 </span>            :                 return;
<span class="lineNum">     273 </span>            :         }
<span class="lineNum">     274 </span><span class="lineNoCov">          0 :         if (root-&gt;flags &amp; GF_ODM_DESTROYED) {</span>
<span class="lineNum">     275 </span><span class="lineNoCov">          0 :                 GF_LOG(GF_LOG_ERROR, GF_LOG_MEDIA, (&quot;[Service %s] root has been scheduled for destruction - aborting !\n&quot;, service-&gt;url));</span>
<span class="lineNum">     276 </span>            :                 return;
<span class="lineNum">     277 </span>            :         }
<span class="lineNum">     278 </span><span class="lineNoCov">          0 :         scene = root-&gt;subscene ? root-&gt;subscene : root-&gt;parentscene;</span>
<span class="lineNum">     279 </span><span class="lineNoCov">          0 :         if (scene-&gt;root_od-&gt;addon &amp;&amp; (scene-&gt;root_od-&gt;addon-&gt;addon_type == GF_ADDON_TYPE_MAIN)) {</span>
<span class="lineNum">     280 </span>            :                 no_scene_check = 1;
<span class="lineNum">     281 </span><span class="lineNoCov">          0 :                 scene-&gt;root_od-&gt;flags |= GF_ODM_REGENERATE_SCENE;</span>
<span class="lineNum">     282 </span><span class="lineNoCov">          0 :         }</span>
<span class="lineNum">     283 </span>            : 
<span class="lineNum">     284 </span><span class="lineNoCov">          0 :         GF_LOG(GF_LOG_DEBUG, GF_LOG_MEDIA, (&quot;[Service %s] %s\n&quot;, service-&gt;url, media_desc ? &quot;Adding new media object&quot; : &quot;Regenerating scene graph&quot;));</span>
<span class="lineNum">     285 </span><span class="lineNoCov">          0 :         if (!media_desc) {</span>
<span class="lineNum">     286 </span><span class="lineNoCov">          0 :                 if (!no_scene_check)</span>
<span class="lineNum">     287 </span><span class="lineNoCov">          0 :                         gf_scene_regenerate(scene);</span>
<span class="lineNum">     288 </span>            :                 return;
<span class="lineNum">     289 </span>            :         }
<span class="lineNum">     290 </span>            : 
<span class="lineNum">     291 </span><span class="lineNoCov">          0 :         switch (media_desc-&gt;tag) {</span>
<span class="lineNum">     292 </span>            :         case GF_ODF_OD_TAG:
<span class="lineNum">     293 </span>            :         case GF_ODF_IOD_TAG:
<span class="lineNum">     294 </span><span class="lineNoCov">          0 :                 if (root &amp;&amp; (root-&gt;net_service == service)) {</span>
<span class="lineNum">     295 </span><span class="lineNoCov">          0 :                         od = (GF_ObjectDescriptor *) media_desc;</span>
<span class="lineNum">     296 </span>            :                         break;
<span class="lineNum">     297 </span>            :                 }
<span class="lineNum">     298 </span>            :         default:
<span class="lineNum">     299 </span><span class="lineNoCov">          0 :                 gf_odf_desc_del(media_desc);</span>
<span class="lineNum">     300 </span><span class="lineNoCov">          0 :                 return;</span>
<span class="lineNum">     301 </span>            :         }
<span class="lineNum">     302 </span>            : 
<span class="lineNum">     303 </span><span class="lineNoCov">          0 :         gf_term_lock_net(term, 1);</span>
<span class="lineNum">     304 </span>            :         /*object declared this way are not part of an OD stream and are considered as dynamic*/
<span class="lineNum">     305 </span>            :         /*      od-&gt;objectDescriptorID = GF_MEDIA_EXTERNAL_ID; */
<span class="lineNum">     306 </span>            : 
<span class="lineNum">     307 </span>            :         /*check if we have a mediaObject in the scene not attached and matching this object*/
<span class="lineNum">     308 </span>            :         the_mo = NULL;
<span class="lineNum">     309 </span>            :         odm = NULL;
<span class="lineNum">     310 </span>            :         min_od_id = 0;
<span class="lineNum">     311 </span><span class="lineNoCov">          0 :         for (i=0; i&lt;gf_list_count(scene-&gt;scene_objects); i++) {</span>
<span class="lineNum">     312 </span>            :                 char *frag, *ext;
<span class="lineNum">     313 </span>            :                 GF_ESD *esd;
<span class="lineNum">     314 </span>            :                 char *url;
<span class="lineNum">     315 </span>            :                 u32 match_esid = 0;
<span class="lineNum">     316 </span><span class="lineNoCov">          0 :                 GF_MediaObject *mo = gf_list_get(scene-&gt;scene_objects, i);</span>
<span class="lineNum">     317 </span>            : 
<span class="lineNum">     318 </span><span class="lineNoCov">          0 :                 if ((mo-&gt;OD_ID != GF_MEDIA_EXTERNAL_ID) &amp;&amp; (min_od_id&lt;mo-&gt;OD_ID))</span>
<span class="lineNum">     319 </span><span class="lineNoCov">          0 :                         min_od_id = mo-&gt;OD_ID;</span>
<span class="lineNum">     320 </span>            : 
<span class="lineNum">     321 </span><span class="lineNoCov">          0 :                 if (!mo-&gt;odm) continue;</span>
<span class="lineNum">     322 </span>            :                 /*if object is attached to a service, don't bother looking in a different one*/
<span class="lineNum">     323 </span><span class="lineNoCov">          0 :                 if (mo-&gt;odm-&gt;net_service &amp;&amp; (mo-&gt;odm-&gt;net_service != service)) continue;</span>
<span class="lineNum">     324 </span>            : 
<span class="lineNum">     325 </span>            :                 /*already assigned object - this may happen since the compositor has no control on when objects are declared by the service,
<span class="lineNum">     326 </span>            :                 therefore opening file#video and file#audio may result in the objects being declared twice if the service doesn't
<span class="lineNum">     327 </span>            :                 keep track of declared objects*/
<span class="lineNum">     328 </span><span class="lineNoCov">          0 :                 if (mo-&gt;odm-&gt;OD) {</span>
<span class="lineNum">     329 </span><span class="lineNoCov">          0 :                         if (od-&gt;objectDescriptorID &amp;&amp; is_same_od(mo-&gt;odm-&gt;OD, od)) {</span>
<span class="lineNum">     330 </span>            :                                 /*reassign OD ID*/
<span class="lineNum">     331 </span><span class="lineNoCov">          0 :                                 if (mo-&gt;OD_ID != GF_MEDIA_EXTERNAL_ID) {</span>
<span class="lineNum">     332 </span><span class="lineNoCov">          0 :                                         od-&gt;objectDescriptorID = mo-&gt;OD_ID;</span>
<span class="lineNum">     333 </span><span class="lineNoCov">          0 :                                 } else {</span>
<span class="lineNum">     334 </span><span class="lineNoCov">          0 :                                         mo-&gt;OD_ID = od-&gt;objectDescriptorID;</span>
<span class="lineNum">     335 </span>            :                                 }
<span class="lineNum">     336 </span><span class="lineNoCov">          0 :                                 gf_odf_desc_del(media_desc);</span>
<span class="lineNum">     337 </span><span class="lineNoCov">          0 :                                 gf_term_lock_net(term, 0);</span>
<span class="lineNum">     338 </span><span class="lineNoCov">          0 :                                 return;</span>
<span class="lineNum">     339 </span>            :                         }
<span class="lineNum">     340 </span>            :                         continue;
<span class="lineNum">     341 </span>            :                 }
<span class="lineNum">     342 </span><span class="lineNoCov">          0 :                 if (mo-&gt;OD_ID != GF_MEDIA_EXTERNAL_ID) {</span>
<span class="lineNum">     343 </span><span class="lineNoCov">          0 :                         if (mo-&gt;OD_ID == od-&gt;objectDescriptorID) {</span>
<span class="lineNum">     344 </span>            :                                 the_mo = mo;
<span class="lineNum">     345 </span>            :                                 odm = mo-&gt;odm;
<span class="lineNum">     346 </span><span class="lineNoCov">          0 :                                 break;</span>
<span class="lineNum">     347 </span>            :                         }
<span class="lineNum">     348 </span>            :                         continue;
<span class="lineNum">     349 </span>            :                 }
<span class="lineNum">     350 </span><span class="lineNoCov">          0 :                 if (!mo-&gt;URLs.count || !mo-&gt;URLs.vals[0].url) continue;</span>
<span class="lineNum">     351 </span>            : 
<span class="lineNum">     352 </span>            :                 frag = NULL;
<span class="lineNum">     353 </span><span class="lineNoCov">          0 :                 ext = strrchr(mo-&gt;URLs.vals[0].url, '#');</span>
<span class="lineNum">     354 </span><span class="lineNoCov">          0 :                 if (ext) {</span>
<span class="lineNum">     355 </span><span class="lineNoCov">          0 :                         frag = strchr(ext, '=');</span>
<span class="lineNum">     356 </span><span class="lineNoCov">          0 :                         ext[0] = 0;</span>
<span class="lineNum">     357 </span><span class="lineNoCov">          0 :                 }</span>
<span class="lineNum">     358 </span><span class="lineNoCov">          0 :                 url = mo-&gt;URLs.vals[0].url;</span>
<span class="lineNum">     359 </span><span class="lineNoCov">          0 :                 if (!strnicmp(url, &quot;file://localhost&quot;, 16)) url += 16;</span>
<span class="lineNum">     360 </span><span class="lineNoCov">          0 :                 else if (!strnicmp(url, &quot;file://&quot;, 7)) url += 7;</span>
<span class="lineNum">     361 </span><span class="lineNoCov">          0 :                 else if (!strnicmp(url, &quot;gpac://&quot;, 7)) url += 7;</span>
<span class="lineNum">     362 </span><span class="lineNoCov">          0 :                 else if (!strnicmp(url, &quot;pid://&quot;, 6)) match_esid = atoi(url+6);</span>
<span class="lineNum">     363 </span>            : 
<span class="lineNum">     364 </span><span class="lineNoCov">          0 :                 if (!match_esid &amp;&amp; !strstr(service-&gt;url, url)) {</span>
<span class="lineNum">     365 </span><span class="lineNoCov">          0 :                         if (ext) ext[0] = '#';</span>
<span class="lineNum">     366 </span>            :                         continue;
<span class="lineNum">     367 </span>            :                 }
<span class="lineNum">     368 </span><span class="lineNoCov">          0 :                 if (ext) ext[0] = '#';</span>
<span class="lineNum">     369 </span>            : 
<span class="lineNum">     370 </span><span class="lineNoCov">          0 :                 esd = gf_list_get(od-&gt;ESDescriptors, 0);</span>
<span class="lineNum">     371 </span><span class="lineNoCov">          0 :                 if (match_esid &amp;&amp; (esd-&gt;ESID != match_esid))</span>
<span class="lineNum">     372 </span>            :                         continue;
<span class="lineNum">     373 </span>            :                 /*match type*/
<span class="lineNum">     374 </span><span class="lineNoCov">          0 :                 switch (esd-&gt;decoderConfig-&gt;streamType) {</span>
<span class="lineNum">     375 </span>            :                 case GF_STREAM_VISUAL:
<span class="lineNum">     376 </span><span class="lineNoCov">          0 :                         if (mo-&gt;type != GF_MEDIA_OBJECT_VIDEO) continue;</span>
<span class="lineNum">     377 </span>            :                         break;
<span class="lineNum">     378 </span>            :                 case GF_STREAM_AUDIO:
<span class="lineNum">     379 </span><span class="lineNoCov">          0 :                         if (mo-&gt;type != GF_MEDIA_OBJECT_AUDIO) continue;</span>
<span class="lineNum">     380 </span>            :                         break;
<span class="lineNum">     381 </span>            :                 case GF_STREAM_PRIVATE_MEDIA:
<span class="lineNum">     382 </span><span class="lineNoCov">          0 :                         if ((mo-&gt;type != GF_MEDIA_OBJECT_AUDIO) &amp;&amp; (mo-&gt;type != GF_MEDIA_OBJECT_VIDEO)) continue;</span>
<span class="lineNum">     383 </span>            :                         break;
<span class="lineNum">     384 </span>            :                 case GF_STREAM_SCENE:
<span class="lineNum">     385 </span><span class="lineNoCov">          0 :                         if (mo-&gt;type != GF_MEDIA_OBJECT_UPDATES) continue;</span>
<span class="lineNum">     386 </span>            :                         break;
<span class="lineNum">     387 </span>            :                 default:
<span class="lineNum">     388 </span>            :                         continue;
<span class="lineNum">     389 </span>            :                 }
<span class="lineNum">     390 </span><span class="lineNoCov">          0 :                 if (frag) {</span>
<span class="lineNum">     391 </span>            :                         u32 frag_id = 0;
<span class="lineNum">     392 </span><span class="lineNoCov">          0 :                         u32 ID = od-&gt;objectDescriptorID;</span>
<span class="lineNum">     393 </span><span class="lineNoCov">          0 :                         if (ID==GF_MEDIA_EXTERNAL_ID) ID = esd-&gt;ESID;</span>
<span class="lineNum">     394 </span><span class="lineNoCov">          0 :                         frag++;</span>
<span class="lineNum">     395 </span><span class="lineNoCov">          0 :                         frag_id = atoi(frag);</span>
<span class="lineNum">     396 </span><span class="lineNoCov">          0 :                         if (ID!=frag_id) continue;</span>
<span class="lineNum">     397 </span>            :                 }
<span class="lineNum">     398 </span>            :                 the_mo = mo;
<span class="lineNum">     399 </span><span class="lineNoCov">          0 :                 odm = mo-&gt;odm;</span>
<span class="lineNum">     400 </span><span class="lineNoCov">          0 :                 break;</span>
<span class="lineNum">     401 </span>            :         }
<span class="lineNum">     402 </span>            : 
<span class="lineNum">     403 </span>            :         /*add a pass on scene-&gt;resource to check for min_od_id,
<span class="lineNum">     404 </span>            :         otherwise we may have another modules declaring an object with ID 0 from
<span class="lineNum">     405 </span>            :         another thread, which will assert (only one object with a givne OD ID)*/
<span class="lineNum">     406 </span><span class="lineNoCov">          0 :         for (i=0; i&lt;gf_list_count(scene-&gt;resources); i++) {</span>
<span class="lineNum">     407 </span><span class="lineNoCov">          0 :                 GF_ObjectManager *an_odm = gf_list_get(scene-&gt;resources, i);</span>
<span class="lineNum">     408 </span>            : 
<span class="lineNum">     409 </span><span class="lineNoCov">          0 :                 if (an_odm-&gt;OD &amp;&amp; (an_odm-&gt;OD-&gt;objectDescriptorID != GF_MEDIA_EXTERNAL_ID) &amp;&amp; (min_od_id &lt; an_odm-&gt;OD-&gt;objectDescriptorID))</span>
<span class="lineNum">     410 </span><span class="lineNoCov">          0 :                         min_od_id = an_odm-&gt;OD-&gt;objectDescriptorID;</span>
<span class="lineNum">     411 </span>            :         }
<span class="lineNum">     412 </span>            : 
<span class="lineNum">     413 </span><span class="lineNoCov">          0 :         if (!odm) {</span>
<span class="lineNum">     414 </span><span class="lineNoCov">          0 :                 odm = gf_odm_new();</span>
<span class="lineNum">     415 </span><span class="lineNoCov">          0 :                 odm-&gt;term = term;</span>
<span class="lineNum">     416 </span><span class="lineNoCov">          0 :                 odm-&gt;parentscene = scene;</span>
<span class="lineNum">     417 </span><span class="lineNoCov">          0 :                 gf_mx_p(scene-&gt;mx_resources);</span>
<span class="lineNum">     418 </span><span class="lineNoCov">          0 :                 gf_list_add(scene-&gt;resources, odm);</span>
<span class="lineNum">     419 </span><span class="lineNoCov">          0 :                 gf_mx_v(scene-&gt;mx_resources);</span>
<span class="lineNum">     420 </span><span class="lineNoCov">          0 :         }</span>
<span class="lineNum">     421 </span><span class="lineNoCov">          0 :         odm-&gt;flags |= GF_ODM_NOT_SETUP;</span>
<span class="lineNum">     422 </span><span class="lineNoCov">          0 :         odm-&gt;OD = od;</span>
<span class="lineNum">     423 </span><span class="lineNoCov">          0 :         odm-&gt;mo = the_mo;</span>
<span class="lineNum">     424 </span><span class="lineNoCov">          0 :         odm-&gt;flags |= GF_ODM_NOT_IN_OD_STREAM;</span>
<span class="lineNum">     425 </span><span class="lineNoCov">          0 :         if (!od-&gt;objectDescriptorID) {</span>
<span class="lineNum">     426 </span><span class="lineNoCov">          0 :                 od-&gt;objectDescriptorID = min_od_id + 1;</span>
<span class="lineNum">     427 </span><span class="lineNoCov">          0 :         }</span>
<span class="lineNum">     428 </span>            : 
<span class="lineNum">     429 </span><span class="lineNoCov">          0 :         if (the_mo) the_mo-&gt;OD_ID = od-&gt;objectDescriptorID;</span>
<span class="lineNum">     430 </span><span class="lineNoCov">          0 :         if (!scene-&gt;selected_service_id)</span>
<span class="lineNum">     431 </span><span class="lineNoCov">          0 :                 scene-&gt;selected_service_id = od-&gt;ServiceID;</span>
<span class="lineNum">     432 </span>            : 
<span class="lineNum">     433 </span>            : 
<span class="lineNum">     434 </span>            :         /*net is unlocked before seting up the object as this might trigger events going into JS and deadlocks
<span class="lineNum">     435 </span>            :         with the compositor*/
<span class="lineNum">     436 </span><span class="lineNoCov">          0 :         gf_term_lock_net(term, 0);</span>
<span class="lineNum">     437 </span>            : 
<span class="lineNum">     438 </span><span class="lineNoCov">          0 :         GF_LOG(GF_LOG_DEBUG, GF_LOG_MEDIA, (&quot;[ODM%d] setup object - MO %08x\n&quot;, odm-&gt;OD-&gt;objectDescriptorID, odm-&gt;mo));</span>
<span class="lineNum">     439 </span><span class="lineNoCov">          0 :         gf_odm_setup_object(odm, service);</span>
<span class="lineNum">     440 </span>            : 
<span class="lineNum">     441 </span>            :         /*OD inserted by service: resetup scene*/
<span class="lineNum">     442 </span><span class="lineNoCov">          0 :         if (!no_scene_check &amp;&amp; scene-&gt;is_dynamic_scene) gf_scene_regenerate(scene);</span>
<a name="443"><span class="lineNum">     443 </span><span class="lineNoCov">          0 : }</span></a>
<span class="lineNum">     444 </span>            : 
<span class="lineNum">     445 </span>            : static void gather_buffer_level(GF_ObjectManager *odm, GF_ClientService *service, GF_NetworkCommand *com, u32 *max_buffer_time)
<span class="lineNum">     446 </span>            : {
<span class="lineNum">     447 </span><span class="lineNoCov">          0 :         u32 j, count = gf_list_count(odm-&gt;channels);</span>
<span class="lineNum">     448 </span><span class="lineNoCov">          0 :         for (j=0; j&lt;count; j++) {</span>
<span class="lineNum">     449 </span><span class="lineNoCov">          0 :                 GF_Channel *ch = (GF_Channel *)gf_list_get(odm-&gt;channels, j);</span>
<span class="lineNum">     450 </span><span class="lineNoCov">          0 :                 if (ch-&gt;service != service) continue;</span>
<span class="lineNum">     451 </span><span class="lineNoCov">          0 :                 if (ch-&gt;es_state != GF_ESM_ES_RUNNING) continue;</span>
<span class="lineNum">     452 </span><span class="lineNoCov">          0 :                 if (com-&gt;base.on_channel &amp;&amp; (com-&gt;base.on_channel != ch)) continue;</span>
<span class="lineNum">     453 </span><span class="lineNoCov">          0 :                 if (/*!ch-&gt;MaxBuffer || */ch-&gt;dispatch_after_db || ch-&gt;bypass_sl_and_db || ch-&gt;IsEndOfStream) continue;</span>
<span class="lineNum">     454 </span>            : 
<span class="lineNum">     455 </span>            :                 //if not in hybrid mode, perform buffer management only on base layer  -this is because we don't signal which ESs are on/off in the underlying service ...
<span class="lineNum">     456 </span><span class="lineNoCov">          0 :                 if (ch-&gt;esd-&gt;dependsOnESID) {</span>
<span class="lineNum">     457 </span><span class="lineNoCov">          0 :                         if (!ch-&gt;odm-&gt;lower_layer_odm) continue;</span>
<span class="lineNum">     458 </span><span class="lineNoCov">          0 :                         if (ch-&gt;odm-&gt;net_service == ch-&gt;odm-&gt;lower_layer_odm-&gt;net_service) continue;</span>
<span class="lineNum">     459 </span>            :                 }
<span class="lineNum">     460 </span>            : 
<span class="lineNum">     461 </span><span class="lineNoCov">          0 :                 gf_es_update_buffering(ch, 0);</span>
<span class="lineNum">     462 </span>            : 
<span class="lineNum">     463 </span><span class="lineNoCov">          0 :                 if (ch-&gt;MaxBuffer&gt;com-&gt;buffer.max) com-&gt;buffer.max = ch-&gt;MaxBuffer;</span>
<span class="lineNum">     464 </span><span class="lineNoCov">          0 :                 if (ch-&gt;MinBuffer&lt;com-&gt;buffer.min) com-&gt;buffer.min = ch-&gt;MinBuffer;</span>
<span class="lineNum">     465 </span>            : 
<span class="lineNum">     466 </span><span class="lineNoCov">          0 :                 if (ch-&gt;IsClockInit) {</span>
<span class="lineNum">     467 </span><span class="lineNoCov">          0 :                         s32 buf_time = (s32) (ch-&gt;BufferTime / FIX2FLT(ch-&gt;clock-&gt;speed) );</span>
<span class="lineNum">     468 </span><span class="lineNoCov">          0 :                         if (!buf_time &amp;&amp; ch-&gt;BufferTime) buf_time = ch-&gt;BufferTime;</span>
<span class="lineNum">     469 </span>            : 
<span class="lineNum">     470 </span><span class="lineNoCov">          0 :                         if (buf_time &gt; (s32) *max_buffer_time)</span>
<span class="lineNum">     471 </span><span class="lineNoCov">          0 :                                 *max_buffer_time = buf_time ;</span>
<span class="lineNum">     472 </span>            : 
<span class="lineNum">     473 </span>            :                         /*if we don't have more units (compressed or not) than requested max for the composition memory, request more data*/
<span class="lineNum">     474 </span><span class="lineNoCov">          0 :                         if (ch-&gt;odm-&gt;codec &amp;&amp; ch-&gt;odm-&gt;codec-&gt;CB &amp;&amp; (odm-&gt;codec-&gt;CB-&gt;UnitCount + ch-&gt;AU_Count &lt;= odm-&gt;codec-&gt;CB-&gt;Capacity)) {</span>
<span class="lineNum">     475 </span><span class="lineNoCov">          0 :                                 com-&gt;buffer.occupancy = 0;</span>
<span class="lineNum">     476 </span><span class="lineNoCov">          0 :                         } else if ( (u32) buf_time &lt; com-&gt;buffer.occupancy ) {</span>
<span class="lineNum">     477 </span><span class="lineNoCov">          0 :                                 com-&gt;buffer.occupancy = buf_time;</span>
<span class="lineNum">     478 </span><span class="lineNoCov">          0 :                         }</span>
<span class="lineNum">     479 </span>            :                 }
<span class="lineNum">     480 </span><span class="lineNoCov">          0 :                 if (ch-&gt;BufferOn) {</span>
<span class="lineNum">     481 </span><span class="lineNoCov">          0 :                         com-&gt;buffer.buffering = GF_TRUE;</span>
<span class="lineNum">     482 </span><span class="lineNoCov">          0 :                 }</span>
<span class="lineNum">     483 </span>            :         }
<a name="484"><span class="lineNum">     484 </span><span class="lineNoCov">          0 : }</span></a>
<span class="lineNum">     485 </span>            : 
<span class="lineNum">     486 </span>            : static void term_on_command(GF_ClientService *service, GF_NetworkCommand *com, GF_Err response)
<span class="lineNum">     487 </span>            : {
<span class="lineNum">     488 </span>            :         GF_Channel *ch;
<span class="lineNum">     489 </span><span class="lineNoCov">          0 :         GF_Terminal *term = service-&gt;term;</span>
<span class="lineNum">     490 </span>            : 
<span class="lineNum">     491 </span><span class="lineNoCov">          0 :         if (com-&gt;command_type==GF_NET_BUFFER_QUERY) {</span>
<span class="lineNum">     492 </span>            :                 GF_Scene *scene;
<span class="lineNum">     493 </span>            : 
<span class="lineNum">     494 </span>            :                 u32 i, max_buffer_time;
<span class="lineNum">     495 </span>            :                 GF_ObjectManager *odm;
<span class="lineNum">     496 </span><span class="lineNoCov">          0 :                 com-&gt;buffer.max = 0;</span>
<span class="lineNum">     497 </span><span class="lineNoCov">          0 :                 com-&gt;buffer.min = com-&gt;buffer.occupancy = (u32) -1;</span>
<span class="lineNum">     498 </span><span class="lineNoCov">          0 :                 com-&gt;buffer.buffering = GF_FALSE;</span>
<span class="lineNum">     499 </span><span class="lineNoCov">          0 :                 if (!service-&gt;owner) {</span>
<span class="lineNum">     500 </span><span class="lineNoCov">          0 :                         com-&gt;buffer.occupancy = 0;</span>
<span class="lineNum">     501 </span><span class="lineNoCov">          0 :                         return;</span>
<span class="lineNum">     502 </span>            :                 }
<span class="lineNum">     503 </span>            : 
<span class="lineNum">     504 </span>            :                 /*browse all channels in the scene, running on this service, and get buffer info*/
<span class="lineNum">     505 </span>            :                 scene = NULL;
<span class="lineNum">     506 </span><span class="lineNoCov">          0 :                 if (service-&gt;owner-&gt;subscene) {</span>
<span class="lineNum">     507 </span>            :                         scene = service-&gt;owner-&gt;subscene;
<span class="lineNum">     508 </span><span class="lineNoCov">          0 :                 } else if (service-&gt;owner-&gt;parentscene) {</span>
<span class="lineNum">     509 </span>            :                         scene = service-&gt;owner-&gt;parentscene;
<span class="lineNum">     510 </span><span class="lineNoCov">          0 :                 }</span>
<span class="lineNum">     511 </span><span class="lineNoCov">          0 :                 if (!scene) {</span>
<span class="lineNum">     512 </span><span class="lineNoCov">          0 :                         com-&gt;buffer.occupancy = 0;</span>
<span class="lineNum">     513 </span><span class="lineNoCov">          0 :                         return;</span>
<span class="lineNum">     514 </span>            :                 }
<span class="lineNum">     515 </span>            :                 /*get exclusive access to scene resources , to make sure ODs are not being inserted/remove*/
<span class="lineNum">     516 </span><span class="lineNoCov">          0 :                 gf_mx_p(scene-&gt;mx_resources);</span>
<span class="lineNum">     517 </span>            : 
<span class="lineNum">     518 </span><span class="lineNoCov">          0 :                 max_buffer_time=0;</span>
<span class="lineNum">     519 </span><span class="lineNoCov">          0 :                 if (!gf_list_count(scene-&gt;resources))</span>
<span class="lineNum">     520 </span><span class="lineNoCov">          0 :                         GF_LOG(GF_LOG_WARNING, GF_LOG_MEDIA, (&quot;[ODM] No object manager found for the scene (URL: %s), buffer occupancy will remain unchanged\n&quot;, service-&gt;url));</span>
<span class="lineNum">     521 </span><span class="lineNoCov">          0 :                 i=0;</span>
<span class="lineNum">     522 </span><span class="lineNoCov">          0 :                 while ((odm = (GF_ObjectManager*)gf_list_enum(scene-&gt;resources, &amp;i))) {</span>
<span class="lineNum">     523 </span><span class="lineNoCov">          0 :                         gather_buffer_level(odm, service, com, &amp;max_buffer_time);</span>
<span class="lineNum">     524 </span><span class="lineNoCov">          0 :                 }</span>
<span class="lineNum">     525 </span><span class="lineNoCov">          0 :                 gf_mx_v(scene-&gt;mx_resources);</span>
<span class="lineNum">     526 </span><span class="lineNoCov">          0 :                 if (com-&gt;buffer.occupancy==(u32) -1) com-&gt;buffer.occupancy = 0;</span>
<span class="lineNum">     527 </span>            : 
<span class="lineNum">     528 </span>            :                 //in bench mode return the 1 if one of the buffer is full (eg sleep until all buffers are not full), 0 otherwise
<span class="lineNum">     529 </span><span class="lineNoCov">          0 :                 if (term-&gt;bench_mode) {</span>
<span class="lineNum">     530 </span><span class="lineNoCov">          0 :                         com-&gt;buffer.occupancy = (max_buffer_time&gt;com-&gt;buffer.max) ? 2 : 0;</span>
<span class="lineNum">     531 </span><span class="lineNoCov">          0 :                         com-&gt;buffer.max = 1;</span>
<span class="lineNum">     532 </span><span class="lineNoCov">          0 :                         com-&gt;buffer.min = 0;</span>
<span class="lineNum">     533 </span><span class="lineNoCov">          0 :                 }</span>
<span class="lineNum">     534 </span>            :                 return;
<span class="lineNum">     535 </span>            :         }
<span class="lineNum">     536 </span><span class="lineNoCov">          0 :         if (com-&gt;command_type==GF_NET_SERVICE_INFO) {</span>
<span class="lineNum">     537 </span><span class="lineNoCov">          0 :                 GF_Event evt;</span>
<span class="lineNum">     538 </span><span class="lineNoCov">          0 :                 evt.type = GF_EVENT_METADATA;</span>
<span class="lineNum">     539 </span><span class="lineNoCov">          0 :                 gf_term_send_event(term, &amp;evt);</span>
<span class="lineNum">     540 </span>            :                 return;
<span class="lineNum">     541 </span><span class="lineNoCov">          0 :         }</span>
<span class="lineNum">     542 </span><span class="lineNoCov">          0 :         if (com-&gt;command_type==GF_NET_SERVICE_MEDIA_CAP_QUERY) {</span>
<span class="lineNum">     543 </span><span class="lineNoCov">          0 :                 gf_sc_get_av_caps(term-&gt;compositor, &amp;com-&gt;mcaps.width, &amp;com-&gt;mcaps.height, &amp;com-&gt;mcaps.display_bit_depth, &amp;com-&gt;mcaps.audio_bpp, &amp;com-&gt;mcaps.channels, &amp;com-&gt;mcaps.sample_rate);</span>
<span class="lineNum">     544 </span><span class="lineNoCov">          0 :                 return;</span>
<span class="lineNum">     545 </span>            :         }
<span class="lineNum">     546 </span><span class="lineNoCov">          0 :         if (com-&gt;command_type==GF_NET_SERVICE_EVENT) {</span>
<span class="lineNum">     547 </span>            :                 /*check for UDP timeout*/
<span class="lineNum">     548 </span><span class="lineNoCov">          0 :                 if (com-&gt;send_event.evt.message.error == GF_IP_UDP_TIMEOUT) {</span>
<span class="lineNum">     549 </span><span class="lineNoCov">          0 :                         const char *sOpt = gf_cfg_get_key(term-&gt;user-&gt;config, &quot;Network&quot;, &quot;AutoReconfigUDP&quot;);</span>
<span class="lineNum">     550 </span><span class="lineNoCov">          0 :                         if (sOpt &amp;&amp; !stricmp(sOpt, &quot;yes&quot;)) {</span>
<span class="lineNum">     551 </span><span class="lineNoCov">          0 :                                 char szMsg[1024];</span>
<span class="lineNum">     552 </span><span class="lineNoCov">          0 :                                 sprintf(szMsg, &quot;!! UDP down (%s) - Retrying with TCP !!\n&quot;, com-&gt;send_event.evt.message.message);</span>
<span class="lineNum">     553 </span><span class="lineNoCov">          0 :                                 gf_term_message(term, service-&gt;url, szMsg, GF_IP_NETWORK_FAILURE);</span>
<span class="lineNum">     554 </span>            : 
<span class="lineNum">     555 </span>            :                                 /*reload scene - FIXME this shall work on inline nodes, not on the root !*/
<span class="lineNum">     556 </span><span class="lineNoCov">          0 :                                 if (term-&gt;reload_url) gf_free(term-&gt;reload_url);</span>
<span class="lineNum">     557 </span><span class="lineNoCov">          0 :                                 term-&gt;reload_state = 1;</span>
<span class="lineNum">     558 </span><span class="lineNoCov">          0 :                                 term-&gt;reload_url = gf_strdup(term-&gt;root_scene-&gt;root_od-&gt;net_service-&gt;url);</span>
<span class="lineNum">     559 </span><span class="lineNoCov">          0 :                                 gf_cfg_set_key(term-&gt;user-&gt;config, &quot;Network&quot;, &quot;UDPNotAvailable&quot;, &quot;yes&quot;);</span>
<span class="lineNum">     560 </span>            :                                 return;
<span class="lineNum">     561 </span><span class="lineNoCov">          0 :                         }</span>
<span class="lineNum">     562 </span>            :                 }
<span class="lineNum">     563 </span>            : 
<span class="lineNum">     564 </span><span class="lineNoCov">          0 :                 com-&gt;send_event.res = 0;</span>
<span class="lineNum">     565 </span><span class="lineNoCov">          0 :                 gf_term_send_event(term, &amp;com-&gt;send_event.evt);</span>
<span class="lineNum">     566 </span><span class="lineNoCov">          0 :                 return;</span>
<span class="lineNum">     567 </span>            :         }
<span class="lineNum">     568 </span>            : 
<span class="lineNum">     569 </span><span class="lineNoCov">          0 :         if (com-&gt;command_type==GF_NET_ASSOCIATED_CONTENT_LOCATION) {</span>
<span class="lineNum">     570 </span>            :                 GF_Scene *scene = NULL;
<span class="lineNum">     571 </span><span class="lineNoCov">          0 :                 if (service-&gt;owner-&gt;subscene) {</span>
<span class="lineNum">     572 </span>            :                         scene = service-&gt;owner-&gt;subscene;
<span class="lineNum">     573 </span><span class="lineNoCov">          0 :                 } else if (service-&gt;owner-&gt;parentscene) {</span>
<span class="lineNum">     574 </span>            :                         scene = service-&gt;owner-&gt;parentscene;
<span class="lineNum">     575 </span><span class="lineNoCov">          0 :                 }</span>
<span class="lineNum">     576 </span><span class="lineNoCov">          0 :                 if (scene)</span>
<span class="lineNum">     577 </span><span class="lineNoCov">          0 :                         gf_scene_register_associated_media(scene, &amp;com-&gt;addon_info);</span>
<span class="lineNum">     578 </span>            :                 return;
<span class="lineNum">     579 </span>            :         }
<span class="lineNum">     580 </span><span class="lineNoCov">          0 :         if (com-&gt;command_type==GF_NET_ASSOCIATED_CONTENT_TIMING) {</span>
<span class="lineNum">     581 </span>            :                 GF_Scene *scene = NULL;
<span class="lineNum">     582 </span><span class="lineNoCov">          0 :                 if (service-&gt;owner-&gt;subscene) {</span>
<span class="lineNum">     583 </span>            :                         scene = service-&gt;owner-&gt;subscene;
<span class="lineNum">     584 </span><span class="lineNoCov">          0 :                 } else if (service-&gt;owner-&gt;parentscene) {</span>
<span class="lineNum">     585 </span>            :                         scene = service-&gt;owner-&gt;parentscene;
<span class="lineNum">     586 </span><span class="lineNoCov">          0 :                 }</span>
<span class="lineNum">     587 </span><span class="lineNoCov">          0 :                 if (scene)</span>
<span class="lineNum">     588 </span><span class="lineNoCov">          0 :                         gf_scene_notify_associated_media_timeline(scene, &amp;com-&gt;addon_time);</span>
<span class="lineNum">     589 </span>            :                 return;
<span class="lineNum">     590 </span>            :         }
<span class="lineNum">     591 </span><span class="lineNoCov">          0 :         if (com-&gt;command_type==GF_NET_SERVICE_SEEK) {</span>
<span class="lineNum">     592 </span>            :                 GF_Scene *scene = NULL;
<span class="lineNum">     593 </span><span class="lineNoCov">          0 :                 if (service-&gt;owner-&gt;subscene) {</span>
<span class="lineNum">     594 </span>            :                         scene = service-&gt;owner-&gt;subscene;
<span class="lineNum">     595 </span><span class="lineNoCov">          0 :                 } else if (service-&gt;owner-&gt;parentscene) {</span>
<span class="lineNum">     596 </span>            :                         scene = service-&gt;owner-&gt;parentscene;
<span class="lineNum">     597 </span><span class="lineNoCov">          0 :                 }</span>
<span class="lineNum">     598 </span><span class="lineNoCov">          0 :                 if (scene &amp;&amp; scene-&gt;is_dynamic_scene) {</span>
<span class="lineNum">     599 </span><span class="lineNoCov">          0 :                         gf_sc_lock(term-&gt;compositor, 1);</span>
<span class="lineNum">     600 </span><span class="lineNoCov">          0 :                         gf_scene_restart_dynamic(scene, (u64) (com-&gt;play.start_range*1000), 0, 0);</span>
<span class="lineNum">     601 </span><span class="lineNoCov">          0 :                         gf_sc_lock(term-&gt;compositor, 0);</span>
<span class="lineNum">     602 </span><span class="lineNoCov">          0 :                 }</span>
<span class="lineNum">     603 </span>            :                 return;
<span class="lineNum">     604 </span>            :         }
<span class="lineNum">     605 </span>            : 
<span class="lineNum">     606 </span><span class="lineNoCov">          0 :         if (com-&gt;command_type == GF_NET_SERVICE_CODEC_STAT_QUERY) {</span>
<span class="lineNum">     607 </span>            :                 GF_List *od_list;
<span class="lineNum">     608 </span>            :                 u32 i;
<span class="lineNum">     609 </span>            :                 GF_ObjectManager *odm;
<span class="lineNum">     610 </span>            : 
<span class="lineNum">     611 </span><span class="lineNoCov">          0 :                 com-&gt;codec_stat.avg_dec_time = 0;</span>
<span class="lineNum">     612 </span><span class="lineNoCov">          0 :                 com-&gt;codec_stat.max_dec_time = 0;</span>
<span class="lineNum">     613 </span><span class="lineNoCov">          0 :                 com-&gt;codec_stat.irap_avg_dec_time = 0;</span>
<span class="lineNum">     614 </span><span class="lineNoCov">          0 :                 com-&gt;codec_stat.irap_max_dec_time = 0;</span>
<span class="lineNum">     615 </span>            : 
<span class="lineNum">     616 </span><span class="lineNoCov">          0 :                 if (!service-&gt;owner) return;</span>
<span class="lineNum">     617 </span>            :                 /*browse all channels in the scene, running on this service, and get codec stat*/
<span class="lineNum">     618 </span>            :                 od_list = NULL;
<span class="lineNum">     619 </span><span class="lineNoCov">          0 :                 if (service-&gt;owner-&gt;subscene) {</span>
<span class="lineNum">     620 </span><span class="lineNoCov">          0 :                         od_list = service-&gt;owner-&gt;subscene-&gt;resources;</span>
<span class="lineNum">     621 </span><span class="lineNoCov">          0 :                 } else if (service-&gt;owner-&gt;parentscene) {</span>
<span class="lineNum">     622 </span><span class="lineNoCov">          0 :                         od_list = service-&gt;owner-&gt;parentscene-&gt;resources;</span>
<span class="lineNum">     623 </span><span class="lineNoCov">          0 :                 }</span>
<span class="lineNum">     624 </span><span class="lineNoCov">          0 :                 if (!od_list) return;</span>
<span class="lineNum">     625 </span>            : 
<span class="lineNum">     626 </span>            :                 /*get exclusive access to media scheduler, to make sure ODs are not being manipulated*/
<span class="lineNum">     627 </span><span class="lineNoCov">          0 :                 i=0;</span>
<span class="lineNum">     628 </span><span class="lineNoCov">          0 :                 while ((odm = (GF_ObjectManager*)gf_list_enum(od_list, &amp;i))) {</span>
<span class="lineNum">     629 </span>            :                         u32 avg_dec_time;
<span class="lineNum">     630 </span>            :                         /*the decoder statistics are reliable only if we decoded at least 1s*/
<span class="lineNum">     631 </span><span class="lineNoCov">          0 :                         if (!odm-&gt;codec || !odm-&gt;codec-&gt;nb_dec_frames ||</span>
<span class="lineNum">     632 </span>            :                                 (odm-&gt;codec-&gt;ck-&gt;speed &gt; 0 ? odm-&gt;codec-&gt;stat_start + 1000 &gt; odm-&gt;codec-&gt;last_unit_dts : odm-&gt;codec-&gt;stat_start - 1000 &lt; odm-&gt;codec-&gt;last_unit_dts))
<span class="lineNum">     633 </span>            :                                 continue;
<span class="lineNum">     634 </span><span class="lineNoCov">          0 :                         avg_dec_time = (u32) (odm-&gt;codec-&gt;total_dec_time / odm-&gt;codec-&gt;nb_dec_frames);</span>
<span class="lineNum">     635 </span><span class="lineNoCov">          0 :                         if (avg_dec_time &gt; com-&gt;codec_stat.avg_dec_time) {</span>
<span class="lineNum">     636 </span><span class="lineNoCov">          0 :                                 com-&gt;codec_stat.avg_dec_time = avg_dec_time;</span>
<span class="lineNum">     637 </span><span class="lineNoCov">          0 :                                 com-&gt;codec_stat.max_dec_time = odm-&gt;codec-&gt;max_dec_time;</span>
<span class="lineNum">     638 </span><span class="lineNoCov">          0 :                                 com-&gt;codec_stat.irap_avg_dec_time = odm-&gt;codec-&gt;nb_iframes ? (u32) (odm-&gt;codec-&gt;total_iframes_time / odm-&gt;codec-&gt;nb_iframes) : 0;</span>
<span class="lineNum">     639 </span><span class="lineNoCov">          0 :                                 com-&gt;codec_stat.irap_max_dec_time = odm-&gt;codec-&gt;max_iframes_time;</span>
<span class="lineNum">     640 </span><span class="lineNoCov">          0 :                         }</span>
<span class="lineNum">     641 </span><span class="lineNoCov">          0 :                         if (odm-&gt;codec-&gt;codec_reset) {</span>
<span class="lineNum">     642 </span><span class="lineNoCov">          0 :                                 com-&gt;codec_stat.codec_reset = GF_TRUE;</span>
<span class="lineNum">     643 </span><span class="lineNoCov">          0 :                                 odm-&gt;codec-&gt;codec_reset = GF_FALSE;</span>
<span class="lineNum">     644 </span><span class="lineNoCov">          0 :                         }</span>
<span class="lineNum">     645 </span><span class="lineNoCov">          0 :                         com-&gt;codec_stat.decode_only_rap = odm-&gt;codec-&gt;decode_only_rap ? GF_TRUE : GF_FALSE;</span>
<span class="lineNum">     646 </span><span class="lineNoCov">          0 :                 }</span>
<span class="lineNum">     647 </span>            : 
<span class="lineNum">     648 </span>            :                 return;
<span class="lineNum">     649 </span>            :         }
<span class="lineNum">     650 </span>            : 
<span class="lineNum">     651 </span><span class="lineNoCov">          0 :         if (!com-&gt;base.on_channel) return;</span>
<span class="lineNum">     652 </span>            : 
<span class="lineNum">     653 </span><span class="lineNoCov">          0 :         ch = gf_term_get_channel(service, com-&gt;base.on_channel);</span>
<span class="lineNum">     654 </span><span class="lineNoCov">          0 :         if (!ch) return;</span>
<span class="lineNum">     655 </span>            : 
<span class="lineNum">     656 </span><span class="lineNoCov">          0 :         switch (com-&gt;command_type) {</span>
<span class="lineNum">     657 </span>            :         /*SL reconfiguration*/
<span class="lineNum">     658 </span>            :         case GF_NET_CHAN_RECONFIG:
<span class="lineNum">     659 </span><span class="lineNoCov">          0 :                 gf_term_lock_net(term, 1);</span>
<span class="lineNum">     660 </span><span class="lineNoCov">          0 :                 gf_es_reconfig_sl(ch, &amp;com-&gt;cfg.sl_config, com-&gt;cfg.use_m2ts_sections);</span>
<span class="lineNum">     661 </span><span class="lineNoCov">          0 :                 gf_term_lock_net(term, 0);</span>
<span class="lineNum">     662 </span><span class="lineNoCov">          0 :                 return;</span>
<span class="lineNum">     663 </span>            :         case GF_NET_CHAN_SET_MEDIA_TIME:
<span class="lineNum">     664 </span><span class="lineNoCov">          0 :                 if (gf_es_owns_clock(ch) || !ch-&gt;clock-&gt;has_media_time_shift) {</span>
<span class="lineNum">     665 </span><span class="lineNoCov">          0 :                         Double mtime = com-&gt;map_time.media_time;</span>
<span class="lineNum">     666 </span><span class="lineNoCov">          0 :                         if (ch-&gt;clock-&gt;clock_init) {</span>
<span class="lineNum">     667 </span><span class="lineNoCov">          0 :                                 Double t = (Double) com-&gt;map_time.timestamp;</span>
<span class="lineNum">     668 </span><span class="lineNoCov">          0 :                                 t /= ch-&gt;esd-&gt;slConfig-&gt;timestampResolution;</span>
<span class="lineNum">     669 </span><span class="lineNoCov">          0 :                                 t -= ((Double) ch-&gt;clock-&gt;init_time) /1000;</span>
<span class="lineNum">     670 </span><span class="lineNoCov">          0 :                                 mtime += t;</span>
<span class="lineNum">     671 </span><span class="lineNoCov">          0 :                         }</span>
<span class="lineNum">     672 </span><span class="lineNoCov">          0 :                         ch-&gt;clock-&gt;media_time_at_init = (u32) (1000*mtime);</span>
<span class="lineNum">     673 </span><span class="lineNoCov">          0 :                         ch-&gt;clock-&gt;has_media_time_shift = 1;</span>
<span class="lineNum">     674 </span><span class="lineNoCov">          0 :                 }</span>
<span class="lineNum">     675 </span>            :                 return;
<span class="lineNum">     676 </span>            :         /*time mapping (TS to media-time)*/
<span class="lineNum">     677 </span>            :         case GF_NET_CHAN_MAP_TIME:
<span class="lineNum">     678 </span>            : 
<span class="lineNum">     679 </span><span class="lineNoCov">          0 :                 if (ch-&gt;esd-&gt;dependsOnESID) {</span>
<span class="lineNum">     680 </span>            :                         //ignore everything
<span class="lineNum">     681 </span>            :                 } else {
<span class="lineNum">     682 </span>            :                         u32 i;
<span class="lineNum">     683 </span><span class="lineNoCov">          0 :                         GF_LOG(GF_LOG_DEBUG, GF_LOG_SYNC, (&quot;[SyncLayer] ES%d: before mapping: seed TS %d - TS offset %d\n&quot;, ch-&gt;esd-&gt;ESID, ch-&gt;seed_ts, ch-&gt;ts_offset));</span>
<span class="lineNum">     684 </span><span class="lineNoCov">          0 :                         ch-&gt;seed_ts = com-&gt;map_time.timestamp;</span>
<span class="lineNum">     685 </span><span class="lineNoCov">          0 :                         ch-&gt;ts_offset = (u32) (com-&gt;map_time.media_time*1000);</span>
<span class="lineNum">     686 </span><span class="lineNoCov">          0 :                         GF_LOG(GF_LOG_INFO, GF_LOG_SYNC, (&quot;[SyncLayer] ES%d: mapping TS &quot;LLD&quot; to media time %f - current time %d\n&quot;, ch-&gt;esd-&gt;ESID, com-&gt;map_time.timestamp, com-&gt;map_time.media_time, gf_clock_time(ch-&gt;clock)));</span>
<span class="lineNum">     687 </span><span class="lineNoCov">          0 :                         GF_LOG(GF_LOG_DEBUG, GF_LOG_SYNC, (&quot;[SyncLayer] ES%d: after mapping: seed TS %d - TS offset %d\n&quot;, ch-&gt;esd-&gt;ESID, ch-&gt;seed_ts, ch-&gt;ts_offset));</span>
<span class="lineNum">     688 </span>            : 
<span class="lineNum">     689 </span><span class="lineNoCov">          0 :                         if (com-&gt;map_time.reset_buffers) {</span>
<span class="lineNum">     690 </span><span class="lineNoCov">          0 :                                 gf_es_reset_buffers(ch);</span>
<span class="lineNum">     691 </span><span class="lineNoCov">          0 :                         }</span>
<span class="lineNum">     692 </span>            :                         /*if we were reassembling an AU, do not perform clock init check when dispatching it since we computed its timestamps
<span class="lineNum">     693 </span>            :                         according to the previous clock origin*/
<span class="lineNum">     694 </span>            :                         else {
<span class="lineNum">     695 </span><span class="lineNoCov">          0 :                                 gf_mx_p(ch-&gt;mx);</span>
<span class="lineNum">     696 </span><span class="lineNoCov">          0 :                                 ch-&gt;skip_time_check_for_pending = 1;</span>
<span class="lineNum">     697 </span><span class="lineNoCov">          0 :                                 gf_mx_v(ch-&gt;mx);</span>
<span class="lineNum">     698 </span>            :                         }
<span class="lineNum">     699 </span>            :                         /*if the channel is the clock, force a re-init*/
<span class="lineNum">     700 </span><span class="lineNoCov">          0 :                         if (gf_es_owns_clock(ch)) {</span>
<span class="lineNum">     701 </span><span class="lineNoCov">          0 :                                 ch-&gt;IsClockInit = 0;</span>
<span class="lineNum">     702 </span><span class="lineNoCov">          0 :                                 gf_clock_reset(ch-&gt;clock);</span>
<span class="lineNum">     703 </span><span class="lineNoCov">          0 :                         }</span>
<span class="lineNum">     704 </span><span class="lineNoCov">          0 :                         else if (ch-&gt;odm-&gt;flags &amp; GF_ODM_INHERIT_TIMELINE) {</span>
<span class="lineNum">     705 </span><span class="lineNoCov">          0 :                                 ch-&gt;IsClockInit = 0;</span>
<span class="lineNum">     706 </span>            : //                              ch-&gt;ts_offset -= ch-&gt;seed_ts*1000/ch-&gt;ts_res;
<span class="lineNum">     707 </span><span class="lineNoCov">          0 :                         }</span>
<span class="lineNum">     708 </span>            : 
<span class="lineNum">     709 </span><span class="lineNoCov">          0 :                         for (i=0; i&lt;gf_list_count(ch-&gt;odm-&gt;channels); i++) {</span>
<span class="lineNum">     710 </span><span class="lineNoCov">          0 :                                 GF_Channel *a_ch = gf_list_get(ch-&gt;odm-&gt;channels, i);</span>
<span class="lineNum">     711 </span><span class="lineNoCov">          0 :                                 if (ch==a_ch) continue;</span>
<span class="lineNum">     712 </span><span class="lineNoCov">          0 :                                 if (! a_ch-&gt;esd-&gt;dependsOnESID) continue;</span>
<span class="lineNum">     713 </span><span class="lineNoCov">          0 :                                 a_ch-&gt;seed_ts = ch-&gt;seed_ts;</span>
<span class="lineNum">     714 </span><span class="lineNoCov">          0 :                                 a_ch-&gt;IsClockInit = 0;</span>
<span class="lineNum">     715 </span><span class="lineNoCov">          0 :                                 a_ch-&gt;ts_offset = ch-&gt;ts_offset;</span>
<span class="lineNum">     716 </span><span class="lineNoCov">          0 :                         }</span>
<span class="lineNum">     717 </span>            :                 }
<span class="lineNum">     718 </span>            :                 break;
<span class="lineNum">     719 </span>            :         /*duration changed*/
<span class="lineNum">     720 </span>            :         case GF_NET_CHAN_DURATION:
<span class="lineNum">     721 </span><span class="lineNoCov">          0 :                 gf_odm_set_duration(ch-&gt;odm, ch, (u32) (1000*com-&gt;duration.duration));</span>
<span class="lineNum">     722 </span><span class="lineNoCov">          0 :                 break;</span>
<span class="lineNum">     723 </span>            :         case GF_NET_CHAN_BUFFER_QUERY:
<span class="lineNum">     724 </span><span class="lineNoCov">          0 :                 if (ch-&gt;IsEndOfStream) {</span>
<span class="lineNum">     725 </span><span class="lineNoCov">          0 :                         com-&gt;buffer.max = com-&gt;buffer.min = com-&gt;buffer.occupancy = 0;</span>
<span class="lineNum">     726 </span><span class="lineNoCov">          0 :                 } else {</span>
<span class="lineNum">     727 </span><span class="lineNoCov">          0 :                         com-&gt;buffer.max = ch-&gt;MaxBuffer;</span>
<span class="lineNum">     728 </span><span class="lineNoCov">          0 :                         com-&gt;buffer.min = ch-&gt;MinBuffer;</span>
<span class="lineNum">     729 </span><span class="lineNoCov">          0 :                         com-&gt;buffer.occupancy = (u32) (ch-&gt;BufferTime / FIX2FLT(ch-&gt;clock-&gt;speed) );</span>
<span class="lineNum">     730 </span>            :                 }
<span class="lineNum">     731 </span>            :                 break;
<span class="lineNum">     732 </span>            :         case GF_NET_CHAN_DRM_CFG:
<span class="lineNum">     733 </span><span class="lineNoCov">          0 :                 gf_term_lock_net(term, 1);</span>
<span class="lineNum">     734 </span><span class="lineNoCov">          0 :                 gf_es_config_drm(ch, &amp;com-&gt;drm_cfg);</span>
<span class="lineNum">     735 </span><span class="lineNoCov">          0 :                 gf_term_lock_net(term, 0);</span>
<span class="lineNum">     736 </span><span class="lineNoCov">          0 :                 return;</span>
<span class="lineNum">     737 </span>            :         case GF_NET_CHAN_GET_ESD:
<span class="lineNum">     738 </span><span class="lineNoCov">          0 :                 gf_term_lock_net(term, 1);</span>
<span class="lineNum">     739 </span><span class="lineNoCov">          0 :                 com-&gt;cache_esd.esd = ch-&gt;esd;</span>
<span class="lineNum">     740 </span><span class="lineNoCov">          0 :                 com-&gt;cache_esd.is_iod_stream = (ch-&gt;odm-&gt;subscene /*&amp;&amp; (ch-&gt;odm-&gt;subscene-&gt;root_od==ch-&gt;odm)*/) ? 1 : 0;</span>
<span class="lineNum">     741 </span><span class="lineNoCov">          0 :                 gf_term_lock_net(term, 0);</span>
<span class="lineNum">     742 </span><span class="lineNoCov">          0 :                 return;</span>
<span class="lineNum">     743 </span>            :         case GF_NET_CHAN_RESET:
<span class="lineNum">     744 </span><span class="lineNoCov">          0 :                 gf_es_reset_buffers(ch);</span>
<span class="lineNum">     745 </span><span class="lineNoCov">          0 :                 break;</span>
<span class="lineNum">     746 </span>            :         case GF_NET_CHAN_PAUSE:
<span class="lineNum">     747 </span><span class="lineNoCov">          0 :                 ch-&gt;MaxBuffer = com-&gt;buffer.max;</span>
<span class="lineNum">     748 </span><span class="lineNoCov">          0 :                 ch-&gt;MinBuffer = com-&gt;buffer.min;</span>
<span class="lineNum">     749 </span><span class="lineNoCov">          0 :                 ch-&gt;BufferTime = com-&gt;buffer.max;</span>
<span class="lineNum">     750 </span><span class="lineNoCov">          0 :                 gf_es_buffer_on(ch);</span>
<span class="lineNum">     751 </span><span class="lineNoCov">          0 :                 break;</span>
<span class="lineNum">     752 </span>            :         case GF_NET_CHAN_RESUME:
<span class="lineNum">     753 </span><span class="lineNoCov">          0 :                 ch-&gt;BufferTime = ch-&gt;MaxBuffer;</span>
<span class="lineNum">     754 </span><span class="lineNoCov">          0 :                 gf_es_update_buffering(ch, 1);</span>
<span class="lineNum">     755 </span><span class="lineNoCov">          0 :                 gf_es_buffer_off(ch);</span>
<span class="lineNum">     756 </span><span class="lineNoCov">          0 :                 break;</span>
<span class="lineNum">     757 </span>            :         case GF_NET_CHAN_BUFFER:
<span class="lineNum">     758 </span><span class="lineNoCov">          0 :                 ch-&gt;MaxBuffer = com-&gt;buffer.max;</span>
<span class="lineNum">     759 </span><span class="lineNoCov">          0 :                 ch-&gt;MinBuffer = com-&gt;buffer.min;</span>
<span class="lineNum">     760 </span><span class="lineNoCov">          0 :                 ch-&gt;BufferTime = com-&gt;buffer.occupancy;</span>
<span class="lineNum">     761 </span><span class="lineNoCov">          0 :                 gf_es_update_buffering(ch, 1);</span>
<span class="lineNum">     762 </span><span class="lineNoCov">          0 :                 break;</span>
<span class="lineNum">     763 </span>            :         default:
<span class="lineNum">     764 </span>            :                 return;
<span class="lineNum">     765 </span>            :         }
<span class="lineNum">     766 </span><span class="lineNoCov">          0 : }</span>
<a name="767"><span class="lineNum">     767 </span>            : </a>
<span class="lineNum">     768 </span>            : 
<span class="lineNum">     769 </span>            : Bool net_check_interface(GF_InputService *ifce)
<span class="lineNum">     770 </span>            : {
<span class="lineNum">     771 </span><span class="lineNoCov">          0 :         if (!ifce-&gt;CanHandleURL) return 0;</span>
<span class="lineNum">     772 </span><span class="lineNoCov">          0 :         if (!ifce-&gt;ConnectService) return 0;</span>
<span class="lineNum">     773 </span><span class="lineNoCov">          0 :         if (!ifce-&gt;CloseService) return 0;</span>
<span class="lineNum">     774 </span><span class="lineNoCov">          0 :         if (!ifce-&gt;ConnectChannel) return 0;</span>
<span class="lineNum">     775 </span><span class="lineNoCov">          0 :         if (!ifce-&gt;DisconnectChannel) return 0;</span>
<span class="lineNum">     776 </span><span class="lineNoCov">          0 :         if (!ifce-&gt;GetServiceDescriptor) return 0;</span>
<span class="lineNum">     777 </span><span class="lineNoCov">          0 :         if (!ifce-&gt;ServiceCommand) return 0;</span>
<span class="lineNum">     778 </span><span class="lineNoCov">          0 :         return 1;</span>
<span class="lineNum">     779 </span><span class="lineNoCov">          0 : }</span>
<a name="780"><span class="lineNum">     780 </span>            : </a>
<span class="lineNum">     781 </span>            : 
<span class="lineNum">     782 </span>            : static char *get_mime_type(GF_Terminal *term, const char *url, GF_Err *ret_code, GF_DownloadSession **the_session)
<span class="lineNum">     783 </span>            : {
<span class="lineNum">     784 </span>            :         char * ret = NULL;
<span class="lineNum">     785 </span>            :         GF_DownloadSession * sess;
<span class="lineNum">     786 </span><span class="lineNoCov">          0 :         (*ret_code) = GF_OK;</span>
<span class="lineNum">     787 </span><span class="lineNoCov">          0 :         if (strnicmp(url, &quot;http&quot;, 4)) return NULL;</span>
<span class="lineNum">     788 </span>            : 
<span class="lineNum">     789 </span>            :         /*don't use any NetIO and don't issue a HEAD command, always go for GET, use cache and store the session*/
<span class="lineNum">     790 </span><span class="lineNoCov">          0 :         sess = gf_dm_sess_new(term-&gt;downloader, (char *) url, GF_NETIO_SESSION_NOT_THREADED , NULL, NULL, ret_code);</span>
<span class="lineNum">     791 </span><span class="lineNoCov">          0 :         if (!sess) {</span>
<span class="lineNum">     792 </span><span class="lineNoCov">          0 :                 if (strstr(url, &quot;rtsp://&quot;) || strstr(url, &quot;rtp://&quot;) || strstr(url, &quot;udp://&quot;) || strstr(url, &quot;tcp://&quot;) ) (*ret_code) = GF_OK;</span>
<span class="lineNum">     793 </span><span class="lineNoCov">          0 :                 return NULL;</span>
<span class="lineNum">     794 </span>            :         } else {
<span class="lineNum">     795 </span>            :                 /*start processing the resource, and stop if error or as soon as we get data*/
<span class="lineNum">     796 </span>            :                 while (1) {
<span class="lineNum">     797 </span><span class="lineNoCov">          0 :                         *ret_code = gf_dm_sess_process_headers(sess);</span>
<span class="lineNum">     798 </span><span class="lineNoCov">          0 :                         if (*ret_code) break;</span>
<span class="lineNum">     799 </span><span class="lineNoCov">          0 :                         if (gf_dm_sess_get_status(sess)&gt;=GF_NETIO_DATA_EXCHANGE) {</span>
<span class="lineNum">     800 </span><span class="lineNoCov">          0 :                                 const char * mime = gf_dm_sess_mime_type(sess);</span>
<span class="lineNum">     801 </span>            :                                 /* The mime type is returned lower case */
<span class="lineNum">     802 </span><span class="lineNoCov">          0 :                                 if (mime) {</span>
<span class="lineNum">     803 </span><span class="lineNoCov">          0 :                                         ret = gf_strdup(mime);</span>
<span class="lineNum">     804 </span><span class="lineNoCov">          0 :                                 }</span>
<span class="lineNum">     805 </span>            :                                 break;
<span class="lineNum">     806 </span>            :                         }
<span class="lineNum">     807 </span>            :                 }
<span class="lineNum">     808 </span>            :         }
<span class="lineNum">     809 </span>            : 
<span class="lineNum">     810 </span><span class="lineNoCov">          0 :         if (the_session &amp;&amp; (*ret_code == GF_OK)) {</span>
<span class="lineNum">     811 </span><span class="lineNoCov">          0 :                 *the_session = sess;</span>
<span class="lineNum">     812 </span><span class="lineNoCov">          0 :         } else {</span>
<span class="lineNum">     813 </span><span class="lineNoCov">          0 :                 gf_dm_sess_del(sess);</span>
<span class="lineNum">     814 </span>            :         }
<span class="lineNum">     815 </span><span class="lineNoCov">          0 :         return ret;</span>
<span class="lineNum">     816 </span><span class="lineNoCov">          0 : }</span>
<a name="817"><span class="lineNum">     817 </span>            : </a>
<span class="lineNum">     818 </span>            : 
<span class="lineNum">     819 </span>            : static Bool check_extension(const char *szExtList, char *szExt)
<span class="lineNum">     820 </span>            : {
<span class="lineNum">     821 </span><span class="lineNoCov">          0 :         char szExt2[500];</span>
<span class="lineNum">     822 </span><span class="lineNoCov">          0 :         if (szExtList[0] != '&quot;') return 0;</span>
<span class="lineNum">     823 </span><span class="lineNoCov">          0 :         szExtList += 1;</span>
<span class="lineNum">     824 </span>            : 
<span class="lineNum">     825 </span><span class="lineNoCov">          0 :         while (1) {</span>
<span class="lineNum">     826 </span>            :                 u32 i = 0;
<span class="lineNum">     827 </span><span class="lineNoCov">          0 :                 while ((szExtList[0] != ' ') &amp;&amp; (szExtList[0] != '&quot;')) {</span>
<span class="lineNum">     828 </span><span class="lineNoCov">          0 :                         szExt2[i] = szExtList[0];</span>
<span class="lineNum">     829 </span><span class="lineNoCov">          0 :                         i++;</span>
<span class="lineNum">     830 </span><span class="lineNoCov">          0 :                         szExtList++;</span>
<span class="lineNum">     831 </span><span class="lineNoCov">          0 :                 }</span>
<span class="lineNum">     832 </span><span class="lineNoCov">          0 :                 szExt2[i] = 0;</span>
<span class="lineNum">     833 </span><span class="lineNoCov">          0 :                 if (!strncmp(szExt, szExt2, strlen(szExt2))) return 1;</span>
<span class="lineNum">     834 </span><span class="lineNoCov">          0 :                 if (szExtList[0]=='&quot;') break;</span>
<span class="lineNum">     835 </span><span class="lineNoCov">          0 :                 else szExtList++;</span>
<span class="lineNum">     836 </span><span class="lineNoCov">          0 :         }</span>
<span class="lineNum">     837 </span><span class="lineNoCov">          0 :         return 0;</span>
<span class="lineNum">     838 </span><span class="lineNoCov">          0 : }</span>
<a name="839"><span class="lineNum">     839 </span>            : </a>
<span class="lineNum">     840 </span>            : 
<span class="lineNum">     841 </span>            : static GF_InputService *gf_term_can_handle_service(GF_Terminal *term, const char *url, const char *parent_url, Bool no_mime_check, char **out_url, GF_Err *ret_code, GF_DownloadSession **the_session, char **out_mime_type)
<span class="lineNum">     842 </span>            : {
<span class="lineNum">     843 </span>            :         u32 i;
<span class="lineNum">     844 </span>            :         GF_Err e;
<span class="lineNum">     845 </span>            :         char *sURL, *qm, *frag, *ext, *mime_type, *url_res;
<span class="lineNum">     846 </span><span class="lineNoCov">          0 :         char szExt[50];</span>
<span class="lineNum">     847 </span>            :         const char *force_module = NULL;
<span class="lineNum">     848 </span>            :         GF_InputService *ifce;
<span class="lineNum">     849 </span>            :         Bool skip_mime = 0;
<span class="lineNum">     850 </span><span class="lineNoCov">          0 :         memset(szExt, 0, sizeof(szExt));</span>
<span class="lineNum">     851 </span>            : 
<span class="lineNum">     852 </span><span class="lineNoCov">          0 :         (*ret_code) = GF_OK;</span>
<span class="lineNum">     853 </span>            :         ifce = NULL;
<span class="lineNum">     854 </span>            :         mime_type = NULL;
<span class="lineNum">     855 </span><span class="lineNoCov">          0 :         GF_LOG(GF_LOG_DEBUG, GF_LOG_MEDIA, (&quot;[Terminal] Looking for plugin for URL %s\n&quot;, url));</span>
<span class="lineNum">     856 </span><span class="lineNoCov">          0 :         *out_url = NULL;</span>
<span class="lineNum">     857 </span><span class="lineNoCov">          0 :         *out_mime_type = NULL;</span>
<span class="lineNum">     858 </span>            :         sURL = NULL;
<span class="lineNum">     859 </span><span class="lineNoCov">          0 :         if (!url || !strncmp(url, &quot;\\\\&quot;, 2) ) {</span>
<span class="lineNum">     860 </span><span class="lineNoCov">          0 :                 (*ret_code) = GF_URL_ERROR;</span>
<span class="lineNum">     861 </span><span class="lineNoCov">          0 :                 goto exit;</span>
<span class="lineNum">     862 </span>            :         }
<span class="lineNum">     863 </span>            : 
<span class="lineNum">     864 </span><span class="lineNoCov">          0 :         if (!strnicmp(url, &quot;libplayer://&quot;, 12)) {</span>
<span class="lineNum">     865 </span>            :                 force_module = &quot;LibPlayer&quot;;
<span class="lineNum">     866 </span><span class="lineNoCov">          0 :         }</span>
<span class="lineNum">     867 </span>            : 
<span class="lineNum">     868 </span>            :         /*used by GUIs scripts to skip URL concatenation*/
<span class="lineNum">     869 </span><span class="lineNoCov">          0 :         if (!strncmp(url, &quot;gpac://&quot;, 7)) sURL = gf_strdup(url+7);</span>
<span class="lineNum">     870 </span>            :         /*opera-style localhost URLs*/
<span class="lineNum">     871 </span><span class="lineNoCov">          0 :         else if (!strncmp(url, &quot;file://localhost&quot;, 16)) sURL = gf_strdup(url+16);</span>
<span class="lineNum">     872 </span>            : 
<span class="lineNum">     873 </span><span class="lineNoCov">          0 :         else if (parent_url) sURL = gf_url_concatenate(parent_url, url);</span>
<span class="lineNum">     874 </span>            : 
<span class="lineNum">     875 </span>            :         /*path absolute*/
<span class="lineNum">     876 </span><span class="lineNoCov">          0 :         if (!sURL) sURL = gf_strdup(url);</span>
<span class="lineNum">     877 </span>            : 
<span class="lineNum">     878 </span><span class="lineNoCov">          0 :         if (gf_url_is_local(sURL))</span>
<span class="lineNum">     879 </span><span class="lineNoCov">          0 :                 gf_url_to_fs_path(sURL);</span>
<span class="lineNum">     880 </span>            : 
<span class="lineNum">     881 </span><span class="lineNoCov">          0 :         if (the_session) *the_session = NULL;</span>
<span class="lineNum">     882 </span><span class="lineNoCov">          0 :         if (no_mime_check) {</span>
<span class="lineNum">     883 </span>            :                 mime_type = NULL;
<span class="lineNum">     884 </span><span class="lineNoCov">          0 :         } else {</span>
<span class="lineNum">     885 </span>            :                 /*fetch a mime type if any. If error don't even attempt to open the service     */
<span class="lineNum">     886 </span><span class="lineNoCov">          0 :                 mime_type = get_mime_type(term, sURL, &amp;e, the_session);</span>
<span class="lineNum">     887 </span><span class="lineNoCov">          0 :                 if (e) {</span>
<span class="lineNum">     888 </span><span class="lineNoCov">          0 :                         (*ret_code) = e;</span>
<span class="lineNum">     889 </span><span class="lineNoCov">          0 :                         goto exit;</span>
<span class="lineNum">     890 </span>            :                 }
<span class="lineNum">     891 </span>            :         }
<span class="lineNum">     892 </span>            : 
<span class="lineNum">     893 </span><span class="lineNoCov">          0 :         if (mime_type &amp;&amp;</span>
<span class="lineNum">     894 </span><span class="lineNoCov">          0 :                 (!stricmp(mime_type, &quot;text/plain&quot;)</span>
<span class="lineNum">     895 </span><span class="lineNoCov">          0 :                  || !stricmp(mime_type, &quot;video/quicktime&quot;)</span>
<span class="lineNum">     896 </span><span class="lineNoCov">          0 :                  || !stricmp(mime_type, &quot;video/mpeg&quot;)</span>
<span class="lineNum">     897 </span><span class="lineNoCov">          0 :                  || !stricmp(mime_type, &quot;application/octet-stream&quot;)</span>
<span class="lineNum">     898 </span>            :                 )
<span class="lineNum">     899 </span>            :            ) {
<span class="lineNum">     900 </span>            :                 skip_mime = 1;
<span class="lineNum">     901 </span><span class="lineNoCov">          0 :         }</span>
<span class="lineNum">     902 </span>            : 
<span class="lineNum">     903 </span>            :         ifce = NULL;
<span class="lineNum">     904 </span>            : 
<span class="lineNum">     905 </span>            :         /*load from mime type*/
<span class="lineNum">     906 </span><span class="lineNoCov">          0 :         if (mime_type &amp;&amp; !skip_mime) {</span>
<span class="lineNum">     907 </span><span class="lineNoCov">          0 :                 const char *sPlug = gf_cfg_get_key(term-&gt;user-&gt;config, &quot;MimeTypes&quot;, mime_type);</span>
<span class="lineNum">     908 </span><span class="lineNoCov">          0 :                 GF_LOG(GF_LOG_DEBUG, GF_LOG_MEDIA, (&quot;[Terminal] Mime type found: %s\n&quot;, mime_type));</span>
<span class="lineNum">     909 </span><span class="lineNoCov">          0 :                 if (!sPlug) {</span>
<span class="lineNum">     910 </span><span class="lineNoCov">          0 :                         *out_mime_type = mime_type;</span>
<span class="lineNum">     911 </span>            :                         mime_type=NULL;
<span class="lineNum">     912 </span><span class="lineNoCov">          0 :                 }</span>
<span class="lineNum">     913 </span><span class="lineNoCov">          0 :                 if (sPlug) sPlug = strrchr(sPlug, '&quot;');</span>
<span class="lineNum">     914 </span><span class="lineNoCov">          0 :                 if (sPlug) {</span>
<span class="lineNum">     915 </span><span class="lineNoCov">          0 :                         sPlug += 2;</span>
<span class="lineNum">     916 </span><span class="lineNoCov">          0 :                         GF_LOG(GF_LOG_DEBUG, GF_LOG_DASH, (&quot;%s:%d FOUND matching module %s\n&quot;, __FILE__, __LINE__, sPlug));</span>
<span class="lineNum">     917 </span><span class="lineNoCov">          0 :                         ifce = (GF_InputService *) gf_modules_load_interface_by_name(term-&gt;user-&gt;modules, sPlug, GF_NET_CLIENT_INTERFACE);</span>
<span class="lineNum">     918 </span><span class="lineNoCov">          0 :                         if (force_module &amp;&amp; ifce &amp;&amp; !strstr(ifce-&gt;module_name, force_module)) {</span>
<span class="lineNum">     919 </span><span class="lineNoCov">          0 :                                 gf_modules_close_interface((GF_BaseInterface *) ifce);</span>
<span class="lineNum">     920 </span>            :                                 ifce = NULL;
<span class="lineNum">     921 </span><span class="lineNoCov">          0 :                         }</span>
<span class="lineNum">     922 </span><span class="lineNoCov">          0 :                         if (ifce &amp;&amp; !net_check_interface(ifce) ) {</span>
<span class="lineNum">     923 </span><span class="lineNoCov">          0 :                                 gf_modules_close_interface((GF_BaseInterface *) ifce);</span>
<span class="lineNum">     924 </span>            :                                 ifce = NULL;
<span class="lineNum">     925 </span><span class="lineNoCov">          0 :                         }</span>
<span class="lineNum">     926 </span>            :                 }
<span class="lineNum">     927 </span>            :         }
<span class="lineNum">     928 </span>            : 
<span class="lineNum">     929 </span>            :         /* The file extension, if any, is before '?' if any or before '#' if any.*/
<span class="lineNum">     930 </span><span class="lineNoCov">          0 :         url_res = strrchr(sURL, '/');</span>
<span class="lineNum">     931 </span><span class="lineNoCov">          0 :         if (!url_res) url_res = strrchr(sURL, '\\');</span>
<span class="lineNum">     932 </span><span class="lineNoCov">          0 :         if (!url_res) url_res = sURL;</span>
<span class="lineNum">     933 </span><span class="lineNoCov">          0 :         qm = strchr(url_res, '?');</span>
<span class="lineNum">     934 </span><span class="lineNoCov">          0 :         if (qm) {</span>
<span class="lineNum">     935 </span><span class="lineNoCov">          0 :                 qm[0] = 0;</span>
<span class="lineNum">     936 </span><span class="lineNoCov">          0 :                 ext = strrchr(url_res, '.');</span>
<span class="lineNum">     937 </span><span class="lineNoCov">          0 :                 qm[0] = '?';</span>
<span class="lineNum">     938 </span><span class="lineNoCov">          0 :         } else {</span>
<span class="lineNum">     939 </span><span class="lineNoCov">          0 :                 frag = strchr(url_res, '#');</span>
<span class="lineNum">     940 </span><span class="lineNoCov">          0 :                 if (frag) {</span>
<span class="lineNum">     941 </span><span class="lineNoCov">          0 :                         frag[0] = 0;</span>
<span class="lineNum">     942 </span><span class="lineNoCov">          0 :                         ext = strrchr(url_res, '.');</span>
<span class="lineNum">     943 </span><span class="lineNoCov">          0 :                         frag[0] = '#';</span>
<span class="lineNum">     944 </span><span class="lineNoCov">          0 :                 } else {</span>
<span class="lineNum">     945 </span><span class="lineNoCov">          0 :                         ext = strrchr(url_res, '.');</span>
<span class="lineNum">     946 </span>            :                 }
<span class="lineNum">     947 </span>            :         }
<span class="lineNum">     948 </span><span class="lineNoCov">          0 :         if (ext &amp;&amp; !stricmp(ext, &quot;.gz&quot;)) {</span>
<span class="lineNum">     949 </span>            :                 char *anext;
<span class="lineNum">     950 </span><span class="lineNoCov">          0 :                 ext[0] = 0;</span>
<span class="lineNum">     951 </span><span class="lineNoCov">          0 :                 anext = strrchr(sURL, '.');</span>
<span class="lineNum">     952 </span><span class="lineNoCov">          0 :                 ext[0] = '.';</span>
<span class="lineNum">     953 </span>            :                 ext = anext;
<span class="lineNum">     954 </span><span class="lineNoCov">          0 :         }</span>
<span class="lineNum">     955 </span>            :         /*no mime type: either local or streaming. If streaming discard extension checking*/
<span class="lineNum">     956 </span><span class="lineNoCov">          0 :         if (!ifce &amp;&amp; !mime_type &amp;&amp; strstr(sURL, &quot;://&quot;) &amp;&amp; strnicmp(sURL, &quot;file://&quot;, 7)) ext = NULL;</span>
<span class="lineNum">     957 </span>            : 
<span class="lineNum">     958 </span>            :         /*browse extensions for prefered module*/
<span class="lineNum">     959 </span><span class="lineNoCov">          0 :         if (!ifce &amp;&amp; ext) {</span>
<span class="lineNum">     960 </span>            :                 u32 keyCount;
<span class="lineNum">     961 </span><span class="lineNoCov">          0 :                 strncpy(szExt, &amp;ext[1], 49);</span>
<span class="lineNum">     962 </span><span class="lineNoCov">          0 :                 ext = strrchr(szExt, '?');</span>
<span class="lineNum">     963 </span><span class="lineNoCov">          0 :                 if (ext) ext[0] = 0;</span>
<span class="lineNum">     964 </span><span class="lineNoCov">          0 :                 ext = strrchr(szExt, '#');</span>
<span class="lineNum">     965 </span><span class="lineNoCov">          0 :                 if (ext) ext[0] = 0;</span>
<span class="lineNum">     966 </span>            : 
<span class="lineNum">     967 </span><span class="lineNoCov">          0 :                 GF_LOG(GF_LOG_DEBUG, GF_LOG_MEDIA, (&quot;[Terminal] No mime type found - checking by extension %s\n&quot;, szExt));</span>
<span class="lineNum">     968 </span>            :                 assert( term &amp;&amp; term-&gt;user &amp;&amp; term-&gt;user-&gt;modules);
<span class="lineNum">     969 </span><span class="lineNoCov">          0 :                 keyCount = gf_cfg_get_key_count(term-&gt;user-&gt;config, &quot;MimeTypes&quot;);</span>
<span class="lineNum">     970 </span><span class="lineNoCov">          0 :                 for (i=0; i&lt;keyCount; i++) {</span>
<span class="lineNum">     971 </span>            :                         char *sPlug;
<span class="lineNum">     972 </span>            :                         const char *sKey;
<span class="lineNum">     973 </span>            :                         const char *sMime;
<span class="lineNum">     974 </span><span class="lineNoCov">          0 :                         sMime = gf_cfg_get_key_name(term-&gt;user-&gt;config, &quot;MimeTypes&quot;, i);</span>
<span class="lineNum">     975 </span><span class="lineNoCov">          0 :                         if (!sMime) continue;</span>
<span class="lineNum">     976 </span><span class="lineNoCov">          0 :                         sKey = gf_cfg_get_key(term-&gt;user-&gt;config, &quot;MimeTypes&quot;, sMime);</span>
<span class="lineNum">     977 </span><span class="lineNoCov">          0 :                         if (!sKey) continue;</span>
<span class="lineNum">     978 </span><span class="lineNoCov">          0 :                         if (!check_extension(sKey, szExt)) continue;</span>
<span class="lineNum">     979 </span><span class="lineNoCov">          0 :                         sPlug = strrchr(sKey, '&quot;');</span>
<span class="lineNum">     980 </span><span class="lineNoCov">          0 :                         if (!sPlug) continue;   /*bad format entry*/</span>
<span class="lineNum">     981 </span><span class="lineNoCov">          0 :                         sPlug += 2;</span>
<span class="lineNum">     982 </span>            : 
<span class="lineNum">     983 </span><span class="lineNoCov">          0 :                         GF_LOG(GF_LOG_DEBUG, GF_LOG_MEDIA, (&quot;[Terminal] Trying module[%i]=%s, mime=%s\n&quot;, i, sPlug, sMime));</span>
<span class="lineNum">     984 </span><span class="lineNoCov">          0 :                         ifce = (GF_InputService *) gf_modules_load_interface_by_name(term-&gt;user-&gt;modules, sPlug, GF_NET_CLIENT_INTERFACE);</span>
<span class="lineNum">     985 </span><span class="lineNoCov">          0 :                         if (!ifce) {</span>
<span class="lineNum">     986 </span><span class="lineNoCov">          0 :                                 GF_LOG(GF_LOG_DEBUG, GF_LOG_MEDIA, (&quot;[Terminal] module[%i]=%s, mime=%s, cannot be loaded for GF_NET_CLIENT_INTERFACE.\n&quot;, i, sPlug, sMime));</span>
<span class="lineNum">     987 </span>            :                                 continue;
<span class="lineNum">     988 </span>            :                         }
<span class="lineNum">     989 </span><span class="lineNoCov">          0 :                         if (force_module &amp;&amp; ifce &amp;&amp; !strstr(ifce-&gt;module_name, force_module)) {</span>
<span class="lineNum">     990 </span><span class="lineNoCov">          0 :                                 gf_modules_close_interface((GF_BaseInterface *) ifce);</span>
<span class="lineNum">     991 </span>            :                                 ifce = NULL;
<span class="lineNum">     992 </span><span class="lineNoCov">          0 :                                 continue;</span>
<span class="lineNum">     993 </span>            :                         }
<span class="lineNum">     994 </span><span class="lineNoCov">          0 :                         if (ifce &amp;&amp; !net_check_interface(ifce)) {</span>
<span class="lineNum">     995 </span><span class="lineNoCov">          0 :                                 gf_modules_close_interface((GF_BaseInterface *) ifce);</span>
<span class="lineNum">     996 </span>            :                                 ifce = NULL;
<span class="lineNum">     997 </span><span class="lineNoCov">          0 :                                 continue;</span>
<span class="lineNum">     998 </span>            :                         }
<span class="lineNum">     999 </span>            :                         break;
<span class="lineNum">    1000 </span>            :                 }
<span class="lineNum">    1001 </span>            :         }
<span class="lineNum">    1002 </span>            : 
<span class="lineNum">    1003 </span>            :         /*browse all modules*/
<span class="lineNum">    1004 </span><span class="lineNoCov">          0 :         if (!ifce) {</span>
<span class="lineNum">    1005 </span><span class="lineNoCov">          0 :                 GF_LOG(GF_LOG_DEBUG, GF_LOG_MEDIA, (&quot;[Terminal] Not found any interface, trying browsing all modules...\n&quot;));</span>
<span class="lineNum">    1006 </span><span class="lineNoCov">          0 :                 for (i=0; i&lt; gf_modules_get_count(term-&gt;user-&gt;modules); i++) {</span>
<span class="lineNum">    1007 </span><span class="lineNoCov">          0 :                         ifce = (GF_InputService *) gf_modules_load_interface(term-&gt;user-&gt;modules, i, GF_NET_CLIENT_INTERFACE);</span>
<span class="lineNum">    1008 </span><span class="lineNoCov">          0 :                         if (!ifce) continue;</span>
<span class="lineNum">    1009 </span><span class="lineNoCov">          0 :                         GF_LOG(GF_LOG_DEBUG, GF_LOG_MEDIA, (&quot;[Terminal] Checking if module %s supports URL %s\n&quot;, ifce-&gt;module_name, sURL));</span>
<span class="lineNum">    1010 </span><span class="lineNoCov">          0 :                         if (force_module &amp;&amp; ifce &amp;&amp; !strstr(ifce-&gt;module_name, force_module)) {</span>
<span class="lineNum">    1011 </span>            :                         }
<span class="lineNum">    1012 </span><span class="lineNoCov">          0 :                         else if (net_check_interface(ifce) &amp;&amp; ifce-&gt;CanHandleURL(ifce, sURL)) {</span>
<span class="lineNum">    1013 </span>            :                                 break;
<span class="lineNum">    1014 </span>            :                         }
<span class="lineNum">    1015 </span><span class="lineNoCov">          0 :                         gf_modules_close_interface((GF_BaseInterface *) ifce);</span>
<span class="lineNum">    1016 </span>            :                         ifce = NULL;
<span class="lineNum">    1017 </span><span class="lineNoCov">          0 :                 }</span>
<span class="lineNum">    1018 </span>            :         }
<span class="lineNum">    1019 </span>            : exit:
<span class="lineNum">    1020 </span><span class="lineNoCov">          0 :         if (!ifce) {</span>
<span class="lineNum">    1021 </span><span class="lineNoCov">          0 :                 if (*ret_code) {</span>
<span class="lineNum">    1022 </span><span class="lineNoCov">          0 :                         GF_LOG(GF_LOG_ERROR, GF_LOG_MEDIA, (&quot;[Terminal] Error fetching mime type for URL %s: %s\n&quot;, sURL ? sURL : url, gf_error_to_string(*ret_code) ));</span>
<span class="lineNum">    1023 </span>            :                 } else {
<span class="lineNum">    1024 </span><span class="lineNoCov">          0 :                         GF_LOG(GF_LOG_ERROR, GF_LOG_MEDIA, (&quot;[Terminal] Did not find any input plugin for URL %s (%s) \n&quot;, sURL ? sURL : url, mime_type ? mime_type : &quot;no mime type&quot;));</span>
<span class="lineNum">    1025 </span>            :                 }
<span class="lineNum">    1026 </span><span class="lineNoCov">          0 :                 if (sURL) gf_free(sURL);</span>
<span class="lineNum">    1027 </span><span class="lineNoCov">          0 :                 if ( (*ret_code) == GF_OK) (*ret_code) = GF_NOT_SUPPORTED;</span>
<span class="lineNum">    1028 </span><span class="lineNoCov">          0 :                 *out_url = NULL;</span>
<span class="lineNum">    1029 </span>            : 
<span class="lineNum">    1030 </span><span class="lineNoCov">          0 :                 if (the_session &amp;&amp; *the_session) {</span>
<span class="lineNum">    1031 </span><span class="lineNoCov">          0 :                         gf_dm_sess_del(*the_session);</span>
<span class="lineNum">    1032 </span><span class="lineNoCov">          0 :                 }</span>
<span class="lineNum">    1033 </span><span class="lineNoCov">          0 :                 if (mime_type) gf_free(mime_type);</span>
<span class="lineNum">    1034 </span>            :                 mime_type = NULL;
<span class="lineNum">    1035 </span><span class="lineNoCov">          0 :                 if (*out_mime_type) gf_free(*out_mime_type);</span>
<span class="lineNum">    1036 </span><span class="lineNoCov">          0 :                 *out_mime_type = NULL;</span>
<span class="lineNum">    1037 </span><span class="lineNoCov">          0 :         } else {</span>
<span class="lineNum">    1038 </span><span class="lineNoCov">          0 :                 *out_url = sURL;</span>
<span class="lineNum">    1039 </span><span class="lineNoCov">          0 :                 GF_LOG(GF_LOG_INFO, GF_LOG_MEDIA, (&quot;[Terminal] Found input plugin %s for URL %s (%s)\n&quot;, ifce-&gt;module_name, sURL, mime_type ? mime_type : &quot;no mime type&quot;));</span>
<span class="lineNum">    1040 </span>            :         }
<span class="lineNum">    1041 </span><span class="lineNoCov">          0 :         if (mime_type)</span>
<span class="lineNum">    1042 </span><span class="lineNoCov">          0 :                 *out_mime_type = mime_type;</span>
<span class="lineNum">    1043 </span>            :         return ifce;
<a name="1044"><span class="lineNum">    1044 </span><span class="lineNoCov">          0 : }</span></a>
<span class="lineNum">    1045 </span>            : 
<span class="lineNum">    1046 </span>            : GF_ClientService *gf_term_service_new(GF_Terminal *term, struct _od_manager *owner, const char *url, const char *parent_url, GF_Err *ret_code)
<span class="lineNum">    1047 </span>            : {
<span class="lineNum">    1048 </span><span class="lineNoCov">          0 :         GF_DownloadSession *download_session = NULL;</span>
<span class="lineNum">    1049 </span>            :         char *sURL;
<span class="lineNum">    1050 </span>            :         char *mime;
<span class="lineNum">    1051 </span>            :         GF_ClientService *serv;
<span class="lineNum">    1052 </span><span class="lineNoCov">          0 :         GF_InputService *ifce = gf_term_can_handle_service(term, url, parent_url, 0, &amp;sURL, ret_code, &amp;download_session, &amp;mime);</span>
<span class="lineNum">    1053 </span><span class="lineNoCov">          0 :         if (!ifce) {</span>
<span class="lineNum">    1054 </span><span class="lineNoCov">          0 :                 if (owner-&gt;subscene) gf_scene_notify_event(owner-&gt;subscene, GF_EVENT_SCENE_ATTACHED, NULL, NULL, *ret_code, GF_FALSE);</span>
<span class="lineNum">    1055 </span><span class="lineNoCov">          0 :                 return NULL;</span>
<span class="lineNum">    1056 </span>            :         }
<span class="lineNum">    1057 </span><span class="lineNoCov">          0 :         GF_SAFEALLOC(serv, GF_ClientService);</span>
<span class="lineNum">    1058 </span><span class="lineNoCov">          0 :         if (!serv) {</span>
<span class="lineNum">    1059 </span><span class="lineNoCov">          0 :                 GF_LOG(GF_LOG_ERROR, GF_LOG_MEDIA, (&quot;[Terminal] Failed to allocate network service\n&quot;));</span>
<span class="lineNum">    1060 </span><span class="lineNoCov">          0 :                 return NULL;</span>
<span class="lineNum">    1061 </span>            :         }
<span class="lineNum">    1062 </span><span class="lineNoCov">          0 :         serv-&gt;term = term;</span>
<span class="lineNum">    1063 </span><span class="lineNoCov">          0 :         serv-&gt;owner = owner;</span>
<span class="lineNum">    1064 </span><span class="lineNoCov">          0 :         serv-&gt;ifce = ifce;</span>
<span class="lineNum">    1065 </span><span class="lineNoCov">          0 :         serv-&gt;url = sURL;</span>
<span class="lineNum">    1066 </span><span class="lineNoCov">          0 :         serv-&gt;mime = mime;</span>
<span class="lineNum">    1067 </span><span class="lineNoCov">          0 :         serv-&gt;Clocks = gf_list_new();</span>
<span class="lineNum">    1068 </span><span class="lineNoCov">          0 :         serv-&gt;dnloads = gf_list_new();</span>
<span class="lineNum">    1069 </span><span class="lineNoCov">          0 :         serv-&gt;pending_service_session = download_session;</span>
<span class="lineNum">    1070 </span>            : 
<span class="lineNum">    1071 </span><span class="lineNoCov">          0 :         gf_term_lock_media_queue(term, 1);</span>
<span class="lineNum">    1072 </span><span class="lineNoCov">          0 :         gf_list_add(term-&gt;net_services, serv);</span>
<span class="lineNum">    1073 </span><span class="lineNoCov">          0 :         gf_term_lock_media_queue(term, 0);</span>
<span class="lineNum">    1074 </span>            : 
<span class="lineNum">    1075 </span>            : 
<span class="lineNum">    1076 </span><span class="lineNoCov">          0 :         serv-&gt;fn_connect_ack = term_on_connect;</span>
<span class="lineNum">    1077 </span><span class="lineNoCov">          0 :         serv-&gt;fn_disconnect_ack = term_on_disconnect;</span>
<span class="lineNum">    1078 </span><span class="lineNoCov">          0 :         serv-&gt;fn_command = term_on_command;</span>
<span class="lineNum">    1079 </span><span class="lineNoCov">          0 :         serv-&gt;fn_data_packet = term_on_data_packet;</span>
<span class="lineNum">    1080 </span><span class="lineNoCov">          0 :         serv-&gt;fn_add_media = term_on_media_add;</span>
<span class="lineNum">    1081 </span><span class="lineNoCov">          0 :         return serv;</span>
<span class="lineNum">    1082 </span><span class="lineNoCov">          0 : }</span>
<a name="1083"><span class="lineNum">    1083 </span>            : </a>
<span class="lineNum">    1084 </span>            : GF_EXPORT
<span class="lineNum">    1085 </span>            : Bool gf_term_is_supported_url(GF_Terminal *term, const char *fileName, Bool use_parent_url, Bool no_mime_check)
<span class="lineNum">    1086 </span>            : {
<span class="lineNum">    1087 </span>            :         GF_InputService *ifce;
<span class="lineNum">    1088 </span>            :         GF_Err e;
<span class="lineNum">    1089 </span>            :         char *sURL;
<span class="lineNum">    1090 </span><span class="lineNoCov">          0 :         char *mime=NULL;</span>
<span class="lineNum">    1091 </span>            :         char *parent_url = NULL;
<span class="lineNum">    1092 </span><span class="lineNoCov">          0 :         if (use_parent_url &amp;&amp; term-&gt;root_scene) parent_url = term-&gt;root_scene-&gt;root_od-&gt;net_service-&gt;url;</span>
<span class="lineNum">    1093 </span>            : 
<span class="lineNum">    1094 </span><span class="lineNoCov">          0 :         ifce = gf_term_can_handle_service(term, fileName, parent_url, no_mime_check, &amp;sURL, &amp;e, NULL, &amp;mime);</span>
<span class="lineNum">    1095 </span><span class="lineNoCov">          0 :         if (!ifce) return 0;</span>
<span class="lineNum">    1096 </span><span class="lineNoCov">          0 :         gf_modules_close_interface((GF_BaseInterface *) ifce);</span>
<span class="lineNum">    1097 </span><span class="lineNoCov">          0 :         gf_free(sURL);</span>
<span class="lineNum">    1098 </span><span class="lineNoCov">          0 :         if (mime) gf_free(mime);</span>
<span class="lineNum">    1099 </span><span class="lineNoCov">          0 :         return 1;</span>
<span class="lineNum">    1100 </span><span class="lineNoCov">          0 : }</span>
<a name="1101"><span class="lineNum">    1101 </span>            : </a>
<span class="lineNum">    1102 </span>            : 
<span class="lineNum">    1103 </span>            : Bool gf_term_service_can_handle_url(GF_ClientService *ns, char *url)
<span class="lineNum">    1104 </span>            : {
<span class="lineNum">    1105 </span>            :         /*if no owner attached the service is being deleted, don't query it*/
<span class="lineNum">    1106 </span><span class="lineNoCov">          0 :         if (!ns-&gt;owner || !ns-&gt;ifce-&gt;CanHandleURLInService) return 0;</span>
<span class="lineNum">    1107 </span><span class="lineNoCov">          0 :         return ns-&gt;ifce-&gt;CanHandleURLInService(ns-&gt;ifce, url);</span>
<span class="lineNum">    1108 </span><span class="lineNoCov">          0 : }</span>
<a name="1109"><span class="lineNum">    1109 </span>            : </a>
<span class="lineNum">    1110 </span>            : GF_EXPORT
<span class="lineNum">    1111 </span>            : GF_Err gf_term_service_command(GF_ClientService *ns, GF_NetworkCommand *com)
<span class="lineNum">    1112 </span>            : {
<span class="lineNum">    1113 </span><span class="lineNoCov">          0 :         if (ns) return ns-&gt;ifce-&gt;ServiceCommand(ns-&gt;ifce, com);</span>
<a name="1114"><span class="lineNum">    1114 </span><span class="lineNoCov">          0 :         return GF_OK;</span></a>
<span class="lineNum">    1115 </span><span class="lineNoCov">          0 : }</span>
<span class="lineNum">    1116 </span>            : GF_Err gf_term_channel_get_sl_packet(GF_ClientService *ns, LPNETCHANNEL channel, char **out_data_ptr, u32 *out_data_size, GF_SLHeader *out_sl_hdr, Bool *sl_compressed, GF_Err *out_reception_status, Bool *is_new_data)
<span class="lineNum">    1117 </span>            : {
<span class="lineNum">    1118 </span><span class="lineNoCov">          0 :         if (!ns-&gt;ifce-&gt;ChannelGetSLP) return GF_NOT_SUPPORTED;</span>
<a name="1119"><span class="lineNum">    1119 </span><span class="lineNoCov">          0 :         return ns-&gt;ifce-&gt;ChannelGetSLP(ns-&gt;ifce, channel, out_data_ptr, out_data_size, out_sl_hdr, sl_compressed, out_reception_status, is_new_data);</span></a>
<span class="lineNum">    1120 </span><span class="lineNoCov">          0 : }</span>
<span class="lineNum">    1121 </span>            : GF_Err gf_term_channel_release_sl_packet(GF_ClientService *ns, LPNETCHANNEL channel)
<span class="lineNum">    1122 </span>            : {
<span class="lineNum">    1123 </span><span class="lineNoCov">          0 :         if (!ns-&gt;ifce-&gt;ChannelGetSLP) return GF_NOT_SUPPORTED;</span>
<span class="lineNum">    1124 </span><span class="lineNoCov">          0 :         return ns-&gt;ifce-&gt;ChannelReleaseSLP(ns-&gt;ifce, channel);</span>
<span class="lineNum">    1125 </span><span class="lineNoCov">          0 : }</span>
<a name="1126"><span class="lineNum">    1126 </span>            : </a>
<span class="lineNum">    1127 </span>            : GF_EXPORT
<span class="lineNum">    1128 </span>            : void gf_service_connect_ack(GF_ClientService *service, LPNETCHANNEL ns, GF_Err response)
<span class="lineNum">    1129 </span>            : {
<span class="lineNum">    1130 </span>            :         assert(service);
<span class="lineNum">    1131 </span><span class="lineNoCov">          0 :         service-&gt;fn_connect_ack(service, ns, response);</span>
<span class="lineNum">    1132 </span><span class="lineNoCov">          0 : }</span>
<a name="1133"><span class="lineNum">    1133 </span>            : </a>
<span class="lineNum">    1134 </span>            : GF_EXPORT
<span class="lineNum">    1135 </span>            : void gf_service_disconnect_ack(GF_ClientService *service, LPNETCHANNEL ns, GF_Err response)
<span class="lineNum">    1136 </span>            : {
<span class="lineNum">    1137 </span>            :         assert(service);
<span class="lineNum">    1138 </span><span class="lineNoCov">          0 :         service-&gt;fn_disconnect_ack(service, ns, response);</span>
<a name="1139"><span class="lineNum">    1139 </span><span class="lineNoCov">          0 : }</span></a>
<span class="lineNum">    1140 </span>            : GF_EXPORT
<span class="lineNum">    1141 </span>            : void gf_service_command(GF_ClientService *service, GF_NetworkCommand *com, GF_Err response)
<span class="lineNum">    1142 </span>            : {
<span class="lineNum">    1143 </span>            :         assert(service);
<span class="lineNum">    1144 </span><span class="lineNoCov">          0 :         service-&gt;fn_command(service, com, response);</span>
<span class="lineNum">    1145 </span><span class="lineNoCov">          0 : }</span>
<a name="1146"><span class="lineNum">    1146 </span>            : </a>
<span class="lineNum">    1147 </span>            : GF_EXPORT
<span class="lineNum">    1148 </span>            : void gf_service_send_packet(GF_ClientService *service, LPNETCHANNEL ns, char *data, u32 data_size, GF_SLHeader *hdr, GF_Err reception_status)
<span class="lineNum">    1149 </span>            : {
<span class="lineNum">    1150 </span>            :         assert(service);
<span class="lineNum">    1151 </span><span class="lineNoCov">          0 :         service-&gt;fn_data_packet(service, ns, data, data_size, hdr, reception_status);</span>
<span class="lineNum">    1152 </span><span class="lineNoCov">          0 : }</span>
<a name="1153"><span class="lineNum">    1153 </span>            : </a>
<span class="lineNum">    1154 </span>            : GF_EXPORT
<span class="lineNum">    1155 </span>            : void gf_service_declare_media(GF_ClientService *service, GF_Descriptor *media_desc, Bool no_scene_check)
<span class="lineNum">    1156 </span>            : {
<span class="lineNum">    1157 </span>            :         assert(service);
<span class="lineNum">    1158 </span><span class="lineNoCov">          0 :         service-&gt;fn_add_media(service, media_desc, no_scene_check);</span>
<span class="lineNum">    1159 </span><span class="lineNoCov">          0 : }</span>
<a name="1160"><span class="lineNum">    1160 </span>            : </a>
<span class="lineNum">    1161 </span>            : GF_EXPORT
<span class="lineNum">    1162 </span>            : const char *gf_service_get_url(GF_ClientService *service)
<span class="lineNum">    1163 </span>            : {
<span class="lineNum">    1164 </span><span class="lineNoCov">          0 :         if (!service) return NULL;</span>
<span class="lineNum">    1165 </span><span class="lineNoCov">          0 :         return service-&gt;url;</span>
<a name="1166"><span class="lineNum">    1166 </span><span class="lineNoCov">          0 : }</span></a>
<span class="lineNum">    1167 </span>            : 
<span class="lineNum">    1168 </span>            : void gf_term_delete_net_service(GF_ClientService *ns)
<span class="lineNum">    1169 </span>            : {
<span class="lineNum">    1170 </span><span class="lineNoCov">          0 :         const char *sOpt = gf_cfg_get_key(ns-&gt;term-&gt;user-&gt;config, &quot;StreamingCache&quot;, &quot;AutoSave&quot;);</span>
<span class="lineNum">    1171 </span><span class="lineNoCov">          0 :         if (ns-&gt;cache) gf_term_service_cache_close(ns, (sOpt &amp;&amp; !stricmp(sOpt, &quot;yes&quot;)) ? 1 : 0);</span>
<span class="lineNum">    1172 </span>            : 
<span class="lineNum">    1173 </span><span class="lineNoCov">          0 :         if (ns-&gt;pending_service_session) gf_dm_sess_del(ns-&gt;pending_service_session);</span>
<span class="lineNum">    1174 </span>            : 
<span class="lineNum">    1175 </span>            :         assert(!ns-&gt;nb_odm_users);
<span class="lineNum">    1176 </span>            :         assert(!ns-&gt;nb_ch_users);
<span class="lineNum">    1177 </span>            :         assert(!ns-&gt;owner);
<span class="lineNum">    1178 </span>            : 
<span class="lineNum">    1179 </span><span class="lineNoCov">          0 :         gf_modules_close_interface((GF_BaseInterface *)ns-&gt;ifce);</span>
<span class="lineNum">    1180 </span><span class="lineNoCov">          0 :         gf_free(ns-&gt;url);</span>
<span class="lineNum">    1181 </span><span class="lineNoCov">          0 :         gf_free(ns-&gt;mime);</span>
<span class="lineNum">    1182 </span>            : 
<span class="lineNum">    1183 </span>            : 
<span class="lineNum">    1184 </span>            :         /*delete all the clocks*/
<span class="lineNum">    1185 </span><span class="lineNoCov">          0 :         while (gf_list_count(ns-&gt;Clocks)) {</span>
<span class="lineNum">    1186 </span><span class="lineNoCov">          0 :                 GF_Clock *ck = (GF_Clock *)gf_list_get(ns-&gt;Clocks, 0);</span>
<span class="lineNum">    1187 </span><span class="lineNoCov">          0 :                 gf_list_rem(ns-&gt;Clocks, 0);</span>
<span class="lineNum">    1188 </span><span class="lineNoCov">          0 :                 gf_clock_del(ck);</span>
<span class="lineNum">    1189 </span><span class="lineNoCov">          0 :         }</span>
<span class="lineNum">    1190 </span><span class="lineNoCov">          0 :         gf_list_del(ns-&gt;Clocks);</span>
<span class="lineNum">    1191 </span>            : 
<span class="lineNum">    1192 </span>            :         assert(!gf_list_count(ns-&gt;dnloads));
<span class="lineNum">    1193 </span><span class="lineNoCov">          0 :         gf_list_del(ns-&gt;dnloads);</span>
<span class="lineNum">    1194 </span><span class="lineNoCov">          0 :         gf_free(ns);</span>
<span class="lineNum">    1195 </span><span class="lineNoCov">          0 : }</span>
<a name="1196"><span class="lineNum">    1196 </span>            : </a>
<span class="lineNum">    1197 </span>            : GF_EXPORT
<span class="lineNum">    1198 </span>            : GF_InputService *gf_service_get_interface(GF_ClientService *serv)
<span class="lineNum">    1199 </span>            : {
<span class="lineNum">    1200 </span><span class="lineNoCov">          0 :         return serv ? serv-&gt;ifce : NULL;</span>
<span class="lineNum">    1201 </span>            : }
<a name="1202"><span class="lineNum">    1202 </span>            : </a>
<span class="lineNum">    1203 </span>            : GF_EXPORT
<span class="lineNum">    1204 </span>            : GF_DownloadSession *gf_service_download_new(GF_ClientService *service, const char *url, u32 flags, gf_dm_user_io user_io, void *cbk)
<span class="lineNum">    1205 </span>            : {
<span class="lineNum">    1206 </span>            :         GF_Err e;
<span class="lineNum">    1207 </span>            :         GF_DownloadSession * sess;
<span class="lineNum">    1208 </span>            :         char *sURL, *orig_url;
<span class="lineNum">    1209 </span><span class="lineNoCov">          0 :         if (!service) {</span>
<span class="lineNum">    1210 </span><span class="lineNoCov">          0 :                 GF_LOG(GF_LOG_ERROR, GF_LOG_NETWORK, (&quot;[HTTP] service is null, cannot create new download session for %s.\n&quot;, url));</span>
<span class="lineNum">    1211 </span><span class="lineNoCov">          0 :                 return NULL;</span>
<span class="lineNum">    1212 </span>            :         }
<span class="lineNum">    1213 </span>            : 
<span class="lineNum">    1214 </span><span class="lineNoCov">          0 :         sURL = gf_url_concatenate(service-&gt;url, url);</span>
<span class="lineNum">    1215 </span>            :         /*path was absolute*/
<span class="lineNum">    1216 </span><span class="lineNoCov">          0 :         if (!sURL) sURL = gf_strdup(url);</span>
<span class="lineNum">    1217 </span>            :         assert( service-&gt;term );
<span class="lineNum">    1218 </span>            : 
<span class="lineNum">    1219 </span><span class="lineNoCov">          0 :         orig_url = service-&gt;pending_service_session ? (char *) gf_dm_sess_get_original_resource_name(service-&gt;pending_service_session) : NULL;</span>
<span class="lineNum">    1220 </span>            :         /*this will take care of URL formatting (%20 etc ..) */
<span class="lineNum">    1221 </span><span class="lineNoCov">          0 :         if (orig_url) orig_url = gf_url_concatenate(service-&gt;url, orig_url);</span>
<span class="lineNum">    1222 </span>            : 
<span class="lineNum">    1223 </span><span class="lineNoCov">          0 :         if (orig_url &amp;&amp; !strcmp(orig_url, sURL)) {</span>
<span class="lineNum">    1224 </span><span class="lineNoCov">          0 :                 sess = service-&gt;pending_service_session;</span>
<span class="lineNum">    1225 </span><span class="lineNoCov">          0 :                 service-&gt;pending_service_session = NULL;</span>
<span class="lineNum">    1226 </span>            :                 /*resetup*/
<span class="lineNum">    1227 </span><span class="lineNoCov">          0 :                 gf_dm_sess_reassign(sess, flags, user_io, cbk);</span>
<span class="lineNum">    1228 </span><span class="lineNoCov">          0 :         } else {</span>
<span class="lineNum">    1229 </span><span class="lineNoCov">          0 :                 sess = gf_dm_sess_new(service-&gt;term-&gt;downloader, sURL, flags, user_io, cbk, &amp;e);</span>
<span class="lineNum">    1230 </span>            :         }
<span class="lineNum">    1231 </span><span class="lineNoCov">          0 :         if (orig_url) gf_free(orig_url);</span>
<span class="lineNum">    1232 </span>            : 
<span class="lineNum">    1233 </span><span class="lineNoCov">          0 :         if (!sess) {</span>
<span class="lineNum">    1234 </span><span class="lineNoCov">          0 :                 GF_LOG(GF_LOG_ERROR, GF_LOG_NETWORK, (&quot;[HTTP] session could not be created for %s : %s. service url=%s, url=%s.\n&quot;, sURL, gf_error_to_string(e), service-&gt;url, url));</span>
<span class="lineNum">    1235 </span><span class="lineNoCov">          0 :                 gf_free(sURL);</span>
<span class="lineNum">    1236 </span>            :                 sURL = NULL;
<span class="lineNum">    1237 </span><span class="lineNoCov">          0 :                 return NULL;</span>
<span class="lineNum">    1238 </span>            :         }
<span class="lineNum">    1239 </span><span class="lineNoCov">          0 :         gf_free(sURL);</span>
<span class="lineNum">    1240 </span>            :         sURL = NULL;
<span class="lineNum">    1241 </span><span class="lineNoCov">          0 :         gf_dm_sess_set_private(sess, service);</span>
<span class="lineNum">    1242 </span><span class="lineNoCov">          0 :         gf_list_add(service-&gt;dnloads, sess);</span>
<span class="lineNum">    1243 </span><span class="lineNoCov">          0 :         return sess;</span>
<span class="lineNum">    1244 </span><span class="lineNoCov">          0 : }</span>
<a name="1245"><span class="lineNum">    1245 </span>            : </a>
<span class="lineNum">    1246 </span>            : GF_EXPORT
<span class="lineNum">    1247 </span>            : void gf_service_download_del(GF_DownloadSession * sess)
<span class="lineNum">    1248 </span>            : {
<span class="lineNum">    1249 </span>            :         Bool locked;
<span class="lineNum">    1250 </span>            :         GF_ClientService *serv;
<span class="lineNum">    1251 </span><span class="lineNoCov">          0 :         if (!sess) return;</span>
<span class="lineNum">    1252 </span><span class="lineNoCov">          0 :         serv = (GF_ClientService *)gf_dm_sess_get_private(sess);</span>
<span class="lineNum">    1253 </span>            : 
<span class="lineNum">    1254 </span>            :         /*avoid sending data back to user*/
<span class="lineNum">    1255 </span><span class="lineNoCov">          0 :         gf_dm_sess_abort(sess);</span>
<span class="lineNum">    1256 </span>            : 
<span class="lineNum">    1257 </span><span class="lineNoCov">          0 :         locked = gf_mx_try_lock(serv-&gt;term-&gt;media_queue_mx);</span>
<span class="lineNum">    1258 </span>            : 
<span class="lineNum">    1259 </span>            :         /*unregister from service*/
<span class="lineNum">    1260 </span><span class="lineNoCov">          0 :         gf_list_del_item(serv-&gt;dnloads, sess);</span>
<span class="lineNum">    1261 </span>            : 
<span class="lineNum">    1262 </span>            :         /*same as service: this may be called in the downloader thread (typically when download fails)
<span class="lineNum">    1263 </span>            :         so we must queue the downloader and let the term delete it later on*/
<span class="lineNum">    1264 </span><span class="lineNoCov">          0 :         gf_list_add(serv-&gt;term-&gt;net_services_to_remove, sess);</span>
<span class="lineNum">    1265 </span>            : 
<span class="lineNum">    1266 </span><span class="lineNoCov">          0 :         if (locked)</span>
<span class="lineNum">    1267 </span><span class="lineNoCov">          0 :                 gf_term_lock_media_queue(serv-&gt;term, 0);</span>
<span class="lineNum">    1268 </span><span class="lineNoCov">          0 : }</span>
<a name="1269"><span class="lineNum">    1269 </span>            : </a>
<span class="lineNum">    1270 </span>            : GF_EXPORT
<span class="lineNum">    1271 </span>            : void gf_service_download_update_stats(GF_DownloadSession * sess)
<span class="lineNum">    1272 </span>            : {
<span class="lineNum">    1273 </span>            :         GF_ClientService *serv;
<span class="lineNum">    1274 </span>            :         const char *szURI;
<span class="lineNum">    1275 </span>            :         u32 total_size, bytes_done, bytes_per_sec;
<span class="lineNum">    1276 </span>            :         GF_NetIOStatus net_status;
<span class="lineNum">    1277 </span>            : 
<span class="lineNum">    1278 </span><span class="lineNoCov">          0 :         if (!sess) return;</span>
<span class="lineNum">    1279 </span>            : 
<span class="lineNum">    1280 </span><span class="lineNoCov">          0 :         gf_dm_sess_get_stats(sess, NULL, &amp;szURI, &amp;total_size, &amp;bytes_done, &amp;bytes_per_sec, &amp;net_status);</span>
<span class="lineNum">    1281 </span><span class="lineNoCov">          0 :         serv = (GF_ClientService *)gf_dm_sess_get_private(sess);</span>
<span class="lineNum">    1282 </span><span class="lineNoCov">          0 :         switch (net_status) {</span>
<span class="lineNum">    1283 </span>            :         case GF_NETIO_SETUP:
<span class="lineNum">    1284 </span><span class="lineNoCov">          0 :                 gf_term_message(serv-&gt;term, serv-&gt;url, &quot;Connecting&quot;, GF_OK);</span>
<span class="lineNum">    1285 </span><span class="lineNoCov">          0 :                 break;</span>
<span class="lineNum">    1286 </span>            :         case GF_NETIO_CONNECTED:
<span class="lineNum">    1287 </span><span class="lineNoCov">          0 :                 gf_term_message(serv-&gt;term, serv-&gt;url, &quot;Connected&quot;, GF_OK);</span>
<span class="lineNum">    1288 </span><span class="lineNoCov">          0 :                 break;</span>
<span class="lineNum">    1289 </span>            :         case GF_NETIO_WAIT_FOR_REPLY:
<span class="lineNum">    1290 </span><span class="lineNoCov">          0 :                 gf_term_message(serv-&gt;term, serv-&gt;url, &quot;Waiting for reply...&quot;, GF_OK);</span>
<span class="lineNum">    1291 </span><span class="lineNoCov">          0 :                 break;</span>
<span class="lineNum">    1292 </span>            :         case GF_NETIO_PARSE_REPLY:
<span class="lineNum">    1293 </span><span class="lineNoCov">          0 :                 gf_term_message(serv-&gt;term, serv-&gt;url, &quot;Starting download...&quot;, GF_OK);</span>
<span class="lineNum">    1294 </span><span class="lineNoCov">          0 :                 break;</span>
<span class="lineNum">    1295 </span>            :         case GF_NETIO_DATA_EXCHANGE:
<span class="lineNum">    1296 </span>            :                 /*notify some connection / ...*/
<span class="lineNum">    1297 </span><span class="lineNoCov">          0 :                 if (total_size) {</span>
<span class="lineNum">    1298 </span><span class="lineNoCov">          0 :                         GF_Event evt;</span>
<span class="lineNum">    1299 </span><span class="lineNoCov">          0 :                         evt.type = GF_EVENT_PROGRESS;</span>
<span class="lineNum">    1300 </span><span class="lineNoCov">          0 :                         evt.progress.progress_type = 1;</span>
<span class="lineNum">    1301 </span><span class="lineNoCov">          0 :                         evt.progress.service = szURI;</span>
<span class="lineNum">    1302 </span><span class="lineNoCov">          0 :                         evt.progress.total = total_size;</span>
<span class="lineNum">    1303 </span><span class="lineNoCov">          0 :                         evt.progress.done = bytes_done;</span>
<span class="lineNum">    1304 </span><span class="lineNoCov">          0 :                         evt.progress.bytes_per_seconds = bytes_per_sec;</span>
<span class="lineNum">    1305 </span><span class="lineNoCov">          0 :                         gf_term_send_event(serv-&gt;term, &amp;evt);</span>
<span class="lineNum">    1306 </span><span class="lineNoCov">          0 :                 }</span>
<span class="lineNum">    1307 </span><span class="lineNoCov">          0 :                 GF_LOG(GF_LOG_DEBUG, GF_LOG_NETWORK, (&quot;[HTTP] %s received %d / %d\n&quot;, szURI, bytes_done, total_size));</span>
<span class="lineNum">    1308 </span><span class="lineNoCov">          0 :                 gf_term_service_media_event_with_download(serv-&gt;owner, GF_EVENT_MEDIA_PROGRESS, bytes_done, total_size, bytes_per_sec);</span>
<span class="lineNum">    1309 </span><span class="lineNoCov">          0 :                 break;</span>
<span class="lineNum">    1310 </span>            :         case GF_NETIO_DATA_TRANSFERED:
<span class="lineNum">    1311 </span><span class="lineNoCov">          0 :                 gf_term_service_media_event(serv-&gt;owner, GF_EVENT_MEDIA_LOAD_DONE);</span>
<span class="lineNum">    1312 </span><span class="lineNoCov">          0 :                 if (serv-&gt;owner &amp;&amp; !(serv-&gt;owner-&gt;flags &amp; GF_ODM_DESTROYED) &amp;&amp; serv-&gt;owner-&gt;duration) {</span>
<span class="lineNum">    1313 </span><span class="lineNoCov">          0 :                         GF_Clock *ck = gf_odm_get_media_clock(serv-&gt;owner);</span>
<span class="lineNum">    1314 </span><span class="lineNoCov">          0 :                         if (!gf_clock_is_started(ck)) {</span>
<span class="lineNum">    1315 </span><span class="lineNoCov">          0 :                                 GF_LOG(GF_LOG_INFO, GF_LOG_NETWORK, (&quot;[HTTP Resource] Done retrieving file - resuming playback\n&quot;));</span>
<span class="lineNum">    1316 </span><span class="lineNoCov">          0 :                                 if (serv-&gt;is_paused) {</span>
<span class="lineNum">    1317 </span><span class="lineNoCov">          0 :                                         serv-&gt;is_paused = 0;</span>
<span class="lineNum">    1318 </span>            : #ifndef GPAC_DISABLE_VRML
<span class="lineNum">    1319 </span><span class="lineNoCov">          0 :                                         mediacontrol_resume(serv-&gt;owner, 0);</span>
<span class="lineNum">    1320 </span>            : #endif
<span class="lineNum">    1321 </span><span class="lineNoCov">          0 :                                 }</span>
<span class="lineNum">    1322 </span>            :                         }
<span class="lineNum">    1323 </span>            :                 }
<span class="lineNum">    1324 </span>            :                 break;
<span class="lineNum">    1325 </span>            :         default:
<span class="lineNum">    1326 </span>            :                 break;
<span class="lineNum">    1327 </span>            :         }
<a name="1328"><span class="lineNum">    1328 </span><span class="lineNoCov">          0 : }</span></a>
<span class="lineNum">    1329 </span>            : 
<span class="lineNum">    1330 </span>            : void gf_term_service_del(GF_ClientService *ns)
<span class="lineNum">    1331 </span>            : {
<span class="lineNum">    1332 </span>            :         /*this is a downloader session*/
<span class="lineNum">    1333 </span><span class="lineNoCov">          0 :         if (! * (u32 *) ns) {</span>
<span class="lineNum">    1334 </span><span class="lineNoCov">          0 :                 gf_dm_sess_del((GF_DownloadSession * ) ns);</span>
<span class="lineNum">    1335 </span><span class="lineNoCov">          0 :         } else {</span>
<span class="lineNum">    1336 </span><span class="lineNoCov">          0 :                 gf_term_delete_net_service(ns);</span>
<span class="lineNum">    1337 </span>            :         }
<span class="lineNum">    1338 </span><span class="lineNoCov">          0 : }</span>
<a name="1339"><span class="lineNum">    1339 </span>            : </a>
<span class="lineNum">    1340 </span>            : GF_EXPORT
<span class="lineNum">    1341 </span>            : void gf_service_register_mime(const GF_InputService *ifce, const char *mimeType, const char *extList, const char *description)
<span class="lineNum">    1342 </span>            : {
<span class="lineNum">    1343 </span>            :         u32 len;
<span class="lineNum">    1344 </span>            :         char *buf;
<span class="lineNum">    1345 </span><span class="lineNoCov">          0 :         if (!ifce || !mimeType || !extList || !description) return;</span>
<span class="lineNum">    1346 </span>            : 
<span class="lineNum">    1347 </span><span class="lineNoCov">          0 :         len = (u32) strlen(extList) + 3 + (u32) strlen(description) + 3 + (u32) strlen(ifce-&gt;module_name) + 1;</span>
<span class="lineNum">    1348 </span><span class="lineNoCov">          0 :         buf = (char*)gf_malloc(sizeof(char)*len);</span>
<span class="lineNum">    1349 </span><span class="lineNoCov">          0 :         sprintf(buf, &quot;\&quot;%s\&quot; &quot;, extList);</span>
<span class="lineNum">    1350 </span><span class="lineNoCov">          0 :         strlwr(buf);</span>
<span class="lineNum">    1351 </span><span class="lineNoCov">          0 :         strcat(buf, &quot;\&quot;&quot;);</span>
<span class="lineNum">    1352 </span><span class="lineNoCov">          0 :         strcat(buf, description);</span>
<span class="lineNum">    1353 </span><span class="lineNoCov">          0 :         strcat(buf, &quot;\&quot; &quot;);</span>
<span class="lineNum">    1354 </span><span class="lineNoCov">          0 :         strcat(buf, ifce-&gt;module_name);</span>
<span class="lineNum">    1355 </span><span class="lineNoCov">          0 :         gf_modules_set_option((GF_BaseInterface *)(GF_BaseInterface *)ifce, &quot;MimeTypes&quot;, mimeType, buf);</span>
<span class="lineNum">    1356 </span><span class="lineNoCov">          0 :         gf_free(buf);</span>
<span class="lineNum">    1357 </span><span class="lineNoCov">          0 : }</span>
<a name="1358"><span class="lineNum">    1358 </span>            : </a>
<span class="lineNum">    1359 </span>            : GF_EXPORT
<span class="lineNum">    1360 </span>            : Bool gf_service_check_mime_register(GF_InputService *ifce, const char *mimeType, const char *extList, const char *description, const char *fileExt)
<span class="lineNum">    1361 </span>            : {
<span class="lineNum">    1362 </span>            :         const char *szExtList;
<span class="lineNum">    1363 </span><span class="lineNoCov">          0 :         char *ext, szExt[500];</span>
<span class="lineNum">    1364 </span><span class="lineNoCov">          0 :         if (!ifce || !mimeType || !extList || !description || !fileExt) return 0;</span>
<span class="lineNum">    1365 </span><span class="lineNoCov">          0 :         memset(szExt, 0, sizeof(szExt));</span>
<span class="lineNum">    1366 </span>            :         /*this is a URL*/
<span class="lineNum">    1367 </span><span class="lineNoCov">          0 :         if ( (strlen(fileExt)&gt;20) || strchr(fileExt, '/')) return 0;</span>
<span class="lineNum">    1368 </span>            : 
<span class="lineNum">    1369 </span><span class="lineNoCov">          0 :         if (fileExt[0]=='.') fileExt++;</span>
<span class="lineNum">    1370 </span><span class="lineNoCov">          0 :         strcpy(szExt, fileExt);</span>
<span class="lineNum">    1371 </span><span class="lineNoCov">          0 :         strlwr(szExt);</span>
<span class="lineNum">    1372 </span><span class="lineNoCov">          0 :         ext = strchr(szExt, '#');</span>
<span class="lineNum">    1373 </span><span class="lineNoCov">          0 :         if (ext) ext[0]=0;</span>
<span class="lineNum">    1374 </span>            : 
<span class="lineNum">    1375 </span><span class="lineNoCov">          0 :         szExtList = gf_modules_get_option((GF_BaseInterface *)(GF_BaseInterface *)ifce, &quot;MimeTypes&quot;, mimeType);</span>
<span class="lineNum">    1376 </span><span class="lineNoCov">          0 :         if (!szExtList) {</span>
<span class="lineNum">    1377 </span><span class="lineNoCov">          0 :                 gf_service_register_mime(ifce, mimeType, extList, description);</span>
<span class="lineNum">    1378 </span><span class="lineNoCov">          0 :                 szExtList = gf_modules_get_option((GF_BaseInterface *)(GF_BaseInterface *)ifce, &quot;MimeTypes&quot;, mimeType);</span>
<span class="lineNum">    1379 </span><span class="lineNoCov">          0 :         }</span>
<span class="lineNum">    1380 </span><span class="lineNoCov">          0 :         if (!strstr(szExtList, ifce-&gt;module_name)) return 0;</span>
<span class="lineNum">    1381 </span><span class="lineNoCov">          0 :         return check_extension((char *)szExtList, szExt);</span>
<a name="1382"><span class="lineNum">    1382 </span><span class="lineNoCov">          0 : }</span></a>
<span class="lineNum">    1383 </span>            : 
<span class="lineNum">    1384 </span>            : GF_Err gf_term_service_cache_load(GF_ClientService *ns)
<span class="lineNum">    1385 </span>            : {
<span class="lineNum">    1386 </span>            :         GF_Err e;
<span class="lineNum">    1387 </span>            :         const char *sOpt;
<span class="lineNum">    1388 </span><span class="lineNoCov">          0 :         char szName[GF_MAX_PATH], szURL[1024];</span>
<span class="lineNum">    1389 </span><span class="lineNoCov">          0 :         GF_NetworkCommand com;</span>
<span class="lineNum">    1390 </span>            :         u32 i;
<span class="lineNum">    1391 </span>            :         GF_StreamingCache *mcache = NULL;
<span class="lineNum">    1392 </span>            : 
<span class="lineNum">    1393 </span>            :         /*is service cachable*/
<span class="lineNum">    1394 </span><span class="lineNoCov">          0 :         com.base.on_channel = NULL;</span>
<span class="lineNum">    1395 </span><span class="lineNoCov">          0 :         com.base.command_type = GF_NET_IS_CACHABLE;</span>
<span class="lineNum">    1396 </span><span class="lineNoCov">          0 :         if (ns-&gt;ifce-&gt;ServiceCommand(ns-&gt;ifce, &amp;com) != GF_OK) return GF_OK;</span>
<span class="lineNum">    1397 </span>            : 
<span class="lineNum">    1398 </span>            :         /*locate a cache*/
<span class="lineNum">    1399 </span><span class="lineNoCov">          0 :         for (i=0; i&lt; gf_modules_get_count(ns-&gt;term-&gt;user-&gt;modules); i++) {</span>
<span class="lineNum">    1400 </span><span class="lineNoCov">          0 :                 mcache = (GF_StreamingCache *) gf_modules_load_interface(ns-&gt;term-&gt;user-&gt;modules, i, GF_STREAMING_MEDIA_CACHE);</span>
<span class="lineNum">    1401 </span><span class="lineNoCov">          0 :                 if (mcache &amp;&amp; mcache-&gt;Open &amp;&amp; mcache-&gt;Close &amp;&amp; mcache-&gt;Write &amp;&amp; mcache-&gt;ChannelGetSLP &amp;&amp; mcache-&gt;ChannelReleaseSLP &amp;&amp; mcache-&gt;ServiceCommand) break;</span>
<span class="lineNum">    1402 </span><span class="lineNoCov">          0 :                 if (mcache) gf_modules_close_interface((GF_BaseInterface *)mcache);</span>
<span class="lineNum">    1403 </span>            :                 mcache = NULL;
<span class="lineNum">    1404 </span>            :         }
<span class="lineNum">    1405 </span><span class="lineNoCov">          0 :         if (!mcache) return GF_NOT_SUPPORTED;</span>
<span class="lineNum">    1406 </span>            : 
<span class="lineNum">    1407 </span><span class="lineNoCov">          0 :         sOpt = gf_cfg_get_key(ns-&gt;term-&gt;user-&gt;config, &quot;StreamingCache&quot;, &quot;RecordDirectory&quot;);</span>
<span class="lineNum">    1408 </span><span class="lineNoCov">          0 :         if (!sOpt) sOpt = gf_cfg_get_key(ns-&gt;term-&gt;user-&gt;config, &quot;General&quot;, &quot;CacheDirectory&quot;);</span>
<span class="lineNum">    1409 </span><span class="lineNoCov">          0 :         if (sOpt) {</span>
<span class="lineNum">    1410 </span><span class="lineNoCov">          0 :                 strcpy(szName, sOpt);</span>
<span class="lineNum">    1411 </span><span class="lineNoCov">          0 :                 if (szName[strlen(szName)-1]!='\\') strcat(szName, &quot;\\&quot;);</span>
<span class="lineNum">    1412 </span>            :         } else {
<span class="lineNum">    1413 </span><span class="lineNoCov">          0 :                 strcpy(szName, &quot;&quot;);</span>
<span class="lineNum">    1414 </span>            :         }
<span class="lineNum">    1415 </span><span class="lineNoCov">          0 :         sOpt = gf_cfg_get_key(ns-&gt;term-&gt;user-&gt;config, &quot;StreamingCache&quot;, &quot;BaseFileName&quot;);</span>
<span class="lineNum">    1416 </span><span class="lineNoCov">          0 :         if (sOpt) {</span>
<span class="lineNum">    1417 </span><span class="lineNoCov">          0 :                 strcat(szName, sOpt);</span>
<span class="lineNum">    1418 </span><span class="lineNoCov">          0 :         } else {</span>
<span class="lineNum">    1419 </span>            :                 char *sep;
<span class="lineNum">    1420 </span><span class="lineNoCov">          0 :                 strcat(szName, &quot;rec_&quot;);</span>
<span class="lineNum">    1421 </span><span class="lineNoCov">          0 :                 sOpt = strrchr(ns-&gt;url, '/');</span>
<span class="lineNum">    1422 </span><span class="lineNoCov">          0 :                 if (!sOpt) sOpt = strrchr(ns-&gt;url, '\\');</span>
<span class="lineNum">    1423 </span><span class="lineNoCov">          0 :                 if (sOpt) sOpt += 1;</span>
<span class="lineNum">    1424 </span>            :                 else {
<span class="lineNum">    1425 </span><span class="lineNoCov">          0 :                         sOpt = strstr(ns-&gt;url, &quot;://&quot;);</span>
<span class="lineNum">    1426 </span><span class="lineNoCov">          0 :                         if (sOpt) sOpt += 3;</span>
<span class="lineNum">    1427 </span><span class="lineNoCov">          0 :                         else sOpt = ns-&gt;url;</span>
<span class="lineNum">    1428 </span>            :                 }
<span class="lineNum">    1429 </span><span class="lineNoCov">          0 :                 strcpy(szURL, sOpt);</span>
<span class="lineNum">    1430 </span><span class="lineNoCov">          0 :                 sep = strrchr(szURL, '.');</span>
<span class="lineNum">    1431 </span><span class="lineNoCov">          0 :                 if (sep) sep[0] = 0;</span>
<span class="lineNum">    1432 </span><span class="lineNoCov">          0 :                 for (i=0; i&lt;strlen(szURL); i++) {</span>
<span class="lineNum">    1433 </span><span class="lineNoCov">          0 :                         switch (szURL[i]) {</span>
<span class="lineNum">    1434 </span>            :                         case '/':
<span class="lineNum">    1435 </span>            :                         case '\\':
<span class="lineNum">    1436 </span>            :                         case '.':
<span class="lineNum">    1437 </span>            :                         case ':':
<span class="lineNum">    1438 </span>            :                         case '?':
<span class="lineNum">    1439 </span><span class="lineNoCov">          0 :                                 szURL[i] = '_';</span>
<span class="lineNum">    1440 </span><span class="lineNoCov">          0 :                                 break;</span>
<span class="lineNum">    1441 </span>            :                         }
<span class="lineNum">    1442 </span>            :                 }
<span class="lineNum">    1443 </span><span class="lineNoCov">          0 :                 strcat(szName, szURL);</span>
<span class="lineNum">    1444 </span>            :         }
<span class="lineNum">    1445 </span>            : 
<span class="lineNum">    1446 </span><span class="lineNoCov">          0 :         sOpt = gf_cfg_get_key(ns-&gt;term-&gt;user-&gt;config, &quot;StreamingCache&quot;, &quot;KeepExistingFiles&quot;);</span>
<span class="lineNum">    1447 </span><span class="lineNoCov">          0 :         e = mcache-&gt;Open(mcache, ns, szName, (sOpt &amp;&amp; !stricmp(sOpt, &quot;yes&quot;)) ? 1 : 0);</span>
<span class="lineNum">    1448 </span><span class="lineNoCov">          0 :         if (e) {</span>
<span class="lineNum">    1449 </span><span class="lineNoCov">          0 :                 gf_modules_close_interface((GF_BaseInterface *)mcache);</span>
<span class="lineNum">    1450 </span><span class="lineNoCov">          0 :                 return e;</span>
<span class="lineNum">    1451 </span>            :         }
<span class="lineNum">    1452 </span><span class="lineNoCov">          0 :         ns-&gt;cache = mcache;</span>
<span class="lineNum">    1453 </span><span class="lineNoCov">          0 :         return GF_OK;</span>
<a name="1454"><span class="lineNum">    1454 </span><span class="lineNoCov">          0 : }</span></a>
<span class="lineNum">    1455 </span>            : 
<span class="lineNum">    1456 </span>            : GF_Err gf_term_service_cache_close(GF_ClientService *ns, Bool no_save)
<span class="lineNum">    1457 </span>            : {
<span class="lineNum">    1458 </span>            :         GF_Err e;
<span class="lineNum">    1459 </span><span class="lineNoCov">          0 :         if (!ns-&gt;cache) return GF_OK;</span>
<span class="lineNum">    1460 </span><span class="lineNoCov">          0 :         e = ns-&gt;cache-&gt;Close(ns-&gt;cache, no_save);</span>
<span class="lineNum">    1461 </span>            : 
<span class="lineNum">    1462 </span><span class="lineNoCov">          0 :         gf_modules_close_interface((GF_BaseInterface *)ns-&gt;cache);</span>
<span class="lineNum">    1463 </span><span class="lineNoCov">          0 :         ns-&gt;cache = NULL;</span>
<span class="lineNum">    1464 </span><span class="lineNoCov">          0 :         return e;</span>
<span class="lineNum">    1465 </span><span class="lineNoCov">          0 : }</span>
</pre>
      </td>
    </tr>
  </table>
  <br>

  <table width="100%" border=0 cellspacing=0 cellpadding=0>
    <tr><td class="ruler"><img src="../../glass.png" width=3 height=3 alt=""></td></tr>
    <tr><td class="versionInfo">Generated by: <a href="http://ltp.sourceforge.net/coverage/lcov.php" target="_parent">LCOV version 1.12</a></td></tr>
  </table>
  <br>

</body>
</html>
