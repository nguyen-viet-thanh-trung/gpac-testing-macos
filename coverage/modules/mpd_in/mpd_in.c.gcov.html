<!DOCTYPE HTML PUBLIC "-//W3C//DTD HTML 4.01 Transitional//EN">

<html lang="en">

<head>
  <meta http-equiv="Content-Type" content="text/html; charset=UTF-8">
  <title>LCOV - coverage.info - modules/mpd_in/mpd_in.c</title>
  <link rel="stylesheet" type="text/css" href="../../gcov.css">
</head>

<body>

  <table width="100%" border=0 cellspacing=0 cellpadding=0>
    <tr><td class="title">LCOV - code coverage report</td></tr>
    <tr><td class="ruler"><img src="../../glass.png" width=3 height=3 alt=""></td></tr>

    <tr>
      <td width="100%">
        <table cellpadding=1 border=0 width="100%">
          <tr>
            <td width="10%" class="headerItem">Current view:</td>
            <td width="35%" class="headerValue"><a href="../../index.html">top level</a> - <a href="index.html">modules/mpd_in</a> - mpd_in.c<span style="font-size: 80%;"> (source / <a href="mpd_in.c.func-sort-c.html">functions</a>)</span></td>
            <td width="5%"></td>
            <td width="15%"></td>
            <td width="10%" class="headerCovTableHead">Hit</td>
            <td width="10%" class="headerCovTableHead">Total</td>
            <td width="15%" class="headerCovTableHead">Coverage</td>
          </tr>
          <tr>
            <td class="headerItem">Test:</td>
            <td class="headerValue">coverage.info</td>
            <td></td>
            <td class="headerItem">Lines:</td>
            <td class="headerCovTableEntry">33</td>
            <td class="headerCovTableEntry">918</td>
            <td class="headerCovTableEntryLo">3.6 %</td>
          </tr>
          <tr>
            <td class="headerItem">Date:</td>
            <td class="headerValue">2016-06-07 10:36:32</td>
            <td></td>
            <td class="headerItem">Functions:</td>
            <td class="headerCovTableEntry">4</td>
            <td class="headerCovTableEntry">41</td>
            <td class="headerCovTableEntryLo">9.8 %</td>
          </tr>
          <tr><td><img src="../../glass.png" width=3 height=3 alt=""></td></tr>
        </table>
      </td>
    </tr>

    <tr><td class="ruler"><img src="../../glass.png" width=3 height=3 alt=""></td></tr>
  </table>

  <table cellpadding=0 cellspacing=0 border=0>
    <tr>
      <td><br></td>
    </tr>
    <tr>
      <td>
<pre class="sourceHeading">          Line data    Source code</pre>
<pre class="source">
<a name="1"><span class="lineNum">       1 </span>            : /*</a>
<span class="lineNum">       2 </span>            :  *                      GPAC - Multimedia Framework C SDK
<span class="lineNum">       3 </span>            :  *
<span class="lineNum">       4 </span>            :  *                      Authors: Cyril Concolato, Jean Le Feuvre
<span class="lineNum">       5 </span>            :  *                      Copyright (c) Telecom ParisTech 2010-
<span class="lineNum">       6 </span>            :  *                                      All rights reserved
<span class="lineNum">       7 </span>            :  *
<span class="lineNum">       8 </span>            :  *  This file is part of GPAC / 3GPP/MPEG Media Presentation Description input module
<span class="lineNum">       9 </span>            :  *
<span class="lineNum">      10 </span>            :  *  GPAC is free software; you can redistribute it and/or modify
<span class="lineNum">      11 </span>            :  *  it under the terms of the GNU Lesser General Public License as published by
<span class="lineNum">      12 </span>            :  *  the Free Software Foundation; either version 2, or (at your option)
<span class="lineNum">      13 </span>            :  *  any later version.
<span class="lineNum">      14 </span>            :  *
<span class="lineNum">      15 </span>            :  *  GPAC is distributed in the hope that it will be useful,
<span class="lineNum">      16 </span>            :  *  but WITHOUT ANY WARRANTY; without even the implied warranty of
<span class="lineNum">      17 </span>            :  *  MERCHANTABILITY or FITNESS FOR A PARTICULAR PURPOSE.  See the
<span class="lineNum">      18 </span>            :  *  GNU Lesser General Public License for more details.
<span class="lineNum">      19 </span>            :  *
<span class="lineNum">      20 </span>            :  *  You should have received a copy of the GNU Lesser General Public
<span class="lineNum">      21 </span>            :  *  License along with this library; see the file COPYING.  If not, write to
<span class="lineNum">      22 </span>            :  *  the Free Software Foundation, 675 Mass Ave, Cambridge, MA 02139, USA.
<span class="lineNum">      23 </span>            :  *
<span class="lineNum">      24 </span>            :  */
<span class="lineNum">      25 </span>            : 
<span class="lineNum">      26 </span>            : #include &lt;gpac/modules/service.h&gt;
<span class="lineNum">      27 </span>            : 
<span class="lineNum">      28 </span>            : #ifndef GPAC_DISABLE_DASH_CLIENT
<span class="lineNum">      29 </span>            : 
<span class="lineNum">      30 </span>            : #include &lt;gpac/dash.h&gt;
<span class="lineNum">      31 </span>            : #include &lt;gpac/internal/terminal_dev.h&gt;
<span class="lineNum">      32 </span>            : 
<span class="lineNum">      33 </span>            : typedef enum
<span class="lineNum">      34 </span>            : {
<span class="lineNum">      35 </span>            :         MPDIN_BUFFER_NONE=0,
<span class="lineNum">      36 </span>            :         MPDIN_BUFFER_MIN=1,
<span class="lineNum">      37 </span>            :         MPDIN_BUFFER_SEGMENTS=2
<span class="lineNum">      38 </span>            : } MpdInBuffer;
<span class="lineNum">      39 </span>            : 
<span class="lineNum">      40 </span>            : typedef struct __mpd_module
<span class="lineNum">      41 </span>            : {
<span class="lineNum">      42 </span>            :         /* GPAC Service object (i.e. how this module is seen by the terminal)*/
<span class="lineNum">      43 </span>            :         GF_ClientService *service;
<span class="lineNum">      44 </span>            :         GF_InputService *plug;
<span class="lineNum">      45 </span>            : 
<span class="lineNum">      46 </span>            :         GF_DashClient *dash;
<span class="lineNum">      47 </span>            :         Bool closed;
<span class="lineNum">      48 </span>            :         /*interface to mpd parser*/
<span class="lineNum">      49 </span>            :         GF_DASHFileIO dash_io;
<span class="lineNum">      50 </span>            : 
<span class="lineNum">      51 </span>            :         Bool connection_ack_sent;
<span class="lineNum">      52 </span>            :         Bool memory_storage;
<span class="lineNum">      53 </span>            :         Bool use_max_res, immediate_switch, allow_http_abort;
<span class="lineNum">      54 </span>            :         u32 use_low_latency;
<span class="lineNum">      55 </span>            :         MpdInBuffer buffer_mode;
<span class="lineNum">      56 </span>            :         u32 nb_playing;
<span class="lineNum">      57 </span>            : 
<span class="lineNum">      58 </span>            :         Bool buffer_adaptation;
<span class="lineNum">      59 </span>            : 
<span class="lineNum">      60 </span>            :         /*max width &amp; height in all active representations*/
<span class="lineNum">      61 </span>            :         u32 width, height;
<span class="lineNum">      62 </span>            : 
<span class="lineNum">      63 </span>            :         Double seek_request;
<span class="lineNum">      64 </span>            :         Double media_start_range;
<span class="lineNum">      65 </span>            :         //we store here all callbacks to the parent services we need to intercept, and we will override our own ones
<span class="lineNum">      66 </span>            :         void (*fn_connect_ack) (GF_ClientService *service, LPNETCHANNEL ns, GF_Err response);
<span class="lineNum">      67 </span>            :         void (*fn_data_packet) (GF_ClientService *service, LPNETCHANNEL ns, char *data, u32 data_size, GF_SLHeader *hdr, GF_Err reception_status);
<span class="lineNum">      68 </span>            : } GF_MPD_In;
<span class="lineNum">      69 </span>            : 
<span class="lineNum">      70 </span>            : typedef struct
<span class="lineNum">      71 </span>            : {
<span class="lineNum">      72 </span>            :         GF_MPD_In *mpdin;
<span class="lineNum">      73 </span>            :         GF_InputService *segment_ifce;
<span class="lineNum">      74 </span>            :         Bool service_connected;
<span class="lineNum">      75 </span>            :         Bool service_descriptor_fetched;
<span class="lineNum">      76 </span>            :         Bool netio_assigned;
<span class="lineNum">      77 </span>            :         Bool has_new_data;
<span class="lineNum">      78 </span>            :         u32 idx;
<span class="lineNum">      79 </span>            :         GF_DownloadSession *sess;
<span class="lineNum">      80 </span>            :         Bool is_timestamp_based, pto_setup;
<span class="lineNum">      81 </span>            :         u32 timescale;
<span class="lineNum">      82 </span>            :         s64 pto;
<span class="lineNum">      83 </span>            :         s64 max_cts_in_period;
<span class="lineNum">      84 </span>            :         bin128 key_IV;
<span class="lineNum">      85 </span>            : } GF_MPDGroup;
<span class="lineNum">      86 </span>            : 
<span class="lineNum">      87 </span>            : const char * MPD_MPD_DESC = &quot;MPEG-DASH Streaming&quot;;
<span class="lineNum">      88 </span>            : const char * MPD_MPD_EXT = &quot;3gm mpd&quot;;
<span class="lineNum">      89 </span>            : const char * MPD_M3U8_DESC = &quot;Apple HLS Streaming&quot;;
<a name="90"><span class="lineNum">      90 </span>            : const char * MPD_M3U8_EXT = &quot;m3u8 m3u&quot;;</a>
<span class="lineNum">      91 </span>            : 
<span class="lineNum">      92 </span>            : static u32 MPD_RegisterMimeTypes(const GF_InputService *plug)
<span class="lineNum">      93 </span>            : {
<span class="lineNum">      94 </span>            :         u32 i, c;
<span class="lineNum">      95 </span><span class="lineCov">         12 :         for (i=0; GF_DASH_MPD_MIME_TYPES[i]; i++)</span>
<span class="lineNum">      96 </span><span class="lineCov">          5 :                 gf_service_register_mime (plug, GF_DASH_MPD_MIME_TYPES[i], MPD_MPD_EXT, MPD_MPD_DESC);</span>
<span class="lineNum">      97 </span>            :         c = i;
<span class="lineNum">      98 </span><span class="lineCov">         10 :         for (i=0; GF_DASH_M3U8_MIME_TYPES[i]; i++)</span>
<span class="lineNum">      99 </span><span class="lineCov">          4 :                 gf_service_register_mime(plug, GF_DASH_M3U8_MIME_TYPES[i], MPD_M3U8_EXT, MPD_M3U8_DESC);</span>
<span class="lineNum">     100 </span><span class="lineCov">          1 :         return c+i;</span>
<a name="101"><span class="lineNum">     101 </span>            : }</a>
<span class="lineNum">     102 </span>            : 
<span class="lineNum">     103 </span>            : Bool MPD_CanHandleURL(GF_InputService *plug, const char *url)
<span class="lineNum">     104 </span>            : {
<span class="lineNum">     105 </span>            :         u32 i;
<span class="lineNum">     106 </span>            :         char *sExt;
<span class="lineNum">     107 </span><span class="lineNoCov">          0 :         if (!plug || !url)</span>
<span class="lineNum">     108 </span><span class="lineNoCov">          0 :                 return GF_FALSE;</span>
<span class="lineNum">     109 </span><span class="lineNoCov">          0 :         sExt = strrchr(url, '.');</span>
<span class="lineNum">     110 </span><span class="lineNoCov">          0 :         GF_LOG(GF_LOG_DEBUG, GF_LOG_DASH, (&quot;[MPD_IN] Received Can Handle URL request from terminal for %s\n&quot;, url));</span>
<span class="lineNum">     111 </span><span class="lineNoCov">          0 :         for (i=0; GF_DASH_MPD_MIME_TYPES[i]; i++) {</span>
<span class="lineNum">     112 </span><span class="lineNoCov">          0 :                 if (gf_service_check_mime_register(plug, GF_DASH_MPD_MIME_TYPES[i], MPD_MPD_EXT, MPD_MPD_DESC, sExt))</span>
<span class="lineNum">     113 </span><span class="lineNoCov">          0 :                         return GF_TRUE;</span>
<span class="lineNum">     114 </span>            :         }
<span class="lineNum">     115 </span><span class="lineNoCov">          0 :         for (i=0; GF_DASH_M3U8_MIME_TYPES[i]; i++) {</span>
<span class="lineNum">     116 </span><span class="lineNoCov">          0 :                 if (gf_service_check_mime_register(plug, GF_DASH_M3U8_MIME_TYPES[i], MPD_M3U8_EXT, MPD_M3U8_DESC, sExt))</span>
<span class="lineNum">     117 </span><span class="lineNoCov">          0 :                         return GF_TRUE;</span>
<span class="lineNum">     118 </span>            :         }
<span class="lineNum">     119 </span>            : 
<span class="lineNum">     120 </span><span class="lineNoCov">          0 :         return gf_dash_check_mpd_root_type(url);</span>
<span class="lineNum">     121 </span><span class="lineNoCov">          0 : }</span>
<a name="122"><span class="lineNum">     122 </span>            : </a>
<span class="lineNum">     123 </span>            : 
<span class="lineNum">     124 </span>            : static s32 gf_dash_get_group_idx_from_service(GF_MPD_In *mpdin, GF_InputService *ifce)
<span class="lineNum">     125 </span>            : {
<span class="lineNum">     126 </span>            :         s32 i;
<span class="lineNum">     127 </span>            : 
<span class="lineNum">     128 </span><span class="lineNoCov">          0 :         for (i=0; (u32) i &lt; gf_dash_get_group_count(mpdin-&gt;dash); i++) {</span>
<span class="lineNum">     129 </span><span class="lineNoCov">          0 :                 GF_MPDGroup *group = gf_dash_get_group_udta(mpdin-&gt;dash, i);</span>
<span class="lineNum">     130 </span><span class="lineNoCov">          0 :                 if (!group) continue;</span>
<span class="lineNum">     131 </span><span class="lineNoCov">          0 :                 if (group-&gt;segment_ifce == ifce) {</span>
<span class="lineNum">     132 </span><span class="lineNoCov">          0 :                         return i;</span>
<span class="lineNum">     133 </span>            :                 }
<span class="lineNum">     134 </span>            :         }
<span class="lineNum">     135 </span><span class="lineNoCov">          0 :         return -1;</span>
<span class="lineNum">     136 </span><span class="lineNoCov">          0 : }</span>
<a name="137"><span class="lineNum">     137 </span>            : </a>
<span class="lineNum">     138 </span>            : 
<span class="lineNum">     139 </span>            : static void mpdin_connect_ack(GF_ClientService *service, LPNETCHANNEL ns, GF_Err response)
<span class="lineNum">     140 </span>            : {
<span class="lineNum">     141 </span><span class="lineNoCov">          0 :         GF_MPD_In *mpdin = (GF_MPD_In*) service-&gt;ifce-&gt;priv;</span>
<span class="lineNum">     142 </span>            :         //do not send connect error, we may have other running services - this has to be clean up
<span class="lineNum">     143 </span><span class="lineNoCov">          0 :         if (response==GF_OK)</span>
<span class="lineNum">     144 </span><span class="lineNoCov">          0 :                 mpdin-&gt;fn_connect_ack(mpdin-&gt;service, ns, response);</span>
<a name="145"><span class="lineNum">     145 </span><span class="lineNoCov">          0 : }</span></a>
<span class="lineNum">     146 </span>            : 
<span class="lineNum">     147 </span>            : void mpdin_data_packet(GF_ClientService *service, LPNETCHANNEL ns, char *data, u32 data_size, GF_SLHeader *hdr, GF_Err reception_status)
<span class="lineNum">     148 </span>            : {
<span class="lineNum">     149 </span>            :         s32 i;
<span class="lineNum">     150 </span><span class="lineNoCov">          0 :         GF_MPD_In *mpdin = (GF_MPD_In*) service-&gt;ifce-&gt;priv;</span>
<span class="lineNum">     151 </span>            :         GF_Channel *ch;
<span class="lineNum">     152 </span>            :         GF_MPDGroup *group;
<span class="lineNum">     153 </span>            :         Bool do_map_time = GF_FALSE;
<span class="lineNum">     154 </span><span class="lineNoCov">          0 :         if (!ns || !hdr) {</span>
<span class="lineNum">     155 </span><span class="lineNoCov">          0 :                 mpdin-&gt;fn_data_packet(service, ns, data, data_size, hdr, reception_status);</span>
<span class="lineNum">     156 </span><span class="lineNoCov">          0 :                 return;</span>
<span class="lineNum">     157 </span>            :         }
<span class="lineNum">     158 </span>            : 
<span class="lineNum">     159 </span><span class="lineNoCov">          0 :         ch = (GF_Channel *) ns;</span>
<span class="lineNum">     160 </span>            :         assert(ch-&gt;odm &amp;&amp; ch-&gt;odm-&gt;OD);
<span class="lineNum">     161 </span>            : 
<span class="lineNum">     162 </span><span class="lineNoCov">          0 :         i = gf_dash_get_group_idx_from_service(mpdin,  (GF_InputService *) ch-&gt;odm-&gt;OD-&gt;service_ifce);</span>
<span class="lineNum">     163 </span><span class="lineNoCov">          0 :         if (i&lt;0) {</span>
<span class="lineNum">     164 </span><span class="lineNoCov">          0 :                 mpdin-&gt;fn_data_packet(service, ns, data, data_size, hdr, reception_status);</span>
<span class="lineNum">     165 </span><span class="lineNoCov">          0 :                 return;</span>
<span class="lineNum">     166 </span>            :         }
<span class="lineNum">     167 </span>            : 
<span class="lineNum">     168 </span><span class="lineNoCov">          0 :         group = gf_dash_get_group_udta(mpdin-&gt;dash, i);</span>
<span class="lineNum">     169 </span>            : 
<span class="lineNum">     170 </span><span class="lineNoCov">          0 :         if (gf_dash_is_m3u8(mpdin-&gt;dash)) {</span>
<span class="lineNum">     171 </span><span class="lineNoCov">          0 :                 mpdin-&gt;fn_data_packet(service, ns, data, data_size, hdr, reception_status);</span>
<span class="lineNum">     172 </span><span class="lineNoCov">          0 :                 if (!group-&gt;pto_setup) {</span>
<span class="lineNum">     173 </span><span class="lineNoCov">          0 :                         GF_NetworkCommand com;</span>
<span class="lineNum">     174 </span><span class="lineNoCov">          0 :                         memset(&amp;com, 0, sizeof(com));</span>
<span class="lineNum">     175 </span><span class="lineNoCov">          0 :                         com.command_type = GF_NET_CHAN_SET_MEDIA_TIME;</span>
<span class="lineNum">     176 </span><span class="lineNoCov">          0 :                         com.map_time.media_time = mpdin-&gt;media_start_range;</span>
<span class="lineNum">     177 </span><span class="lineNoCov">          0 :                         com.map_time.timestamp = hdr-&gt;compositionTimeStamp;</span>
<span class="lineNum">     178 </span><span class="lineNoCov">          0 :                         com.base.on_channel =  ns;</span>
<span class="lineNum">     179 </span><span class="lineNoCov">          0 :                         gf_service_command(service, &amp;com, GF_OK);</span>
<span class="lineNum">     180 </span><span class="lineNoCov">          0 :                         group-&gt;pto_setup = GF_TRUE;</span>
<span class="lineNum">     181 </span><span class="lineNoCov">          0 :                 }</span>
<span class="lineNum">     182 </span>            :                 return;
<span class="lineNum">     183 </span>            :         }
<span class="lineNum">     184 </span>            : 
<span class="lineNum">     185 </span>            :         //if sync is based on timestamps do not adjust the timestamps back
<span class="lineNum">     186 </span><span class="lineNoCov">          0 :         if (! group-&gt;is_timestamp_based) {</span>
<span class="lineNum">     187 </span><span class="lineNoCov">          0 :                 if (!group-&gt;pto_setup) {</span>
<span class="lineNum">     188 </span>            :                         Double scale;
<span class="lineNum">     189 </span>            :                         s64 start, dur;
<span class="lineNum">     190 </span>            :                         u64 pto;
<span class="lineNum">     191 </span><span class="lineNoCov">          0 :                         gf_dash_group_get_presentation_time_offset(mpdin-&gt;dash, i, &amp;pto, &amp;group-&gt;timescale);</span>
<span class="lineNum">     192 </span><span class="lineNoCov">          0 :                         group-&gt;pto = (s64) pto;</span>
<span class="lineNum">     193 </span><span class="lineNoCov">          0 :                         group-&gt;pto_setup = 1;</span>
<span class="lineNum">     194 </span>            : 
<span class="lineNum">     195 </span><span class="lineNoCov">          0 :                         if (group-&gt;timescale &amp;&amp; (group-&gt;timescale != ch-&gt;esd-&gt;slConfig-&gt;timestampResolution)) {</span>
<span class="lineNum">     196 </span><span class="lineNoCov">          0 :                                 group-&gt;pto *= ch-&gt;esd-&gt;slConfig-&gt;timestampResolution;</span>
<span class="lineNum">     197 </span><span class="lineNoCov">          0 :                                 group-&gt;pto /= group-&gt;timescale;</span>
<span class="lineNum">     198 </span><span class="lineNoCov">          0 :                         }</span>
<span class="lineNum">     199 </span><span class="lineNoCov">          0 :                         scale = ch-&gt;esd-&gt;slConfig-&gt;timestampResolution;</span>
<span class="lineNum">     200 </span><span class="lineNoCov">          0 :                         scale /= 1000;</span>
<span class="lineNum">     201 </span>            : 
<span class="lineNum">     202 </span><span class="lineNoCov">          0 :                         dur = (u64) (scale * gf_dash_get_period_duration(mpdin-&gt;dash));</span>
<span class="lineNum">     203 </span><span class="lineNoCov">          0 :                         if (dur) {</span>
<span class="lineNum">     204 </span><span class="lineNoCov">          0 :                                 group-&gt;max_cts_in_period = group-&gt;pto + dur;</span>
<span class="lineNum">     205 </span><span class="lineNoCov">          0 :                         } else {</span>
<span class="lineNum">     206 </span><span class="lineNoCov">          0 :                                 group-&gt;max_cts_in_period = 0;</span>
<span class="lineNum">     207 </span>            :                         }
<span class="lineNum">     208 </span>            : 
<span class="lineNum">     209 </span><span class="lineNoCov">          0 :                         start = (u64) (scale * gf_dash_get_period_start(mpdin-&gt;dash));</span>
<span class="lineNum">     210 </span><span class="lineNoCov">          0 :                         group-&gt;pto -= start;</span>
<span class="lineNum">     211 </span><span class="lineNoCov">          0 :                 }</span>
<span class="lineNum">     212 </span>            : 
<span class="lineNum">     213 </span>            :                 //filter any packet outside the current period
<span class="lineNum">     214 </span><span class="lineNoCov">          0 :                 if (group-&gt;max_cts_in_period &amp;&amp; (s64) hdr-&gt;compositionTimeStamp &gt; group-&gt;max_cts_in_period) {</span>
<span class="lineNum">     215 </span>            : //                      GF_LOG(GF_LOG_WARNING, GF_LOG_DASH, (&quot;[DASH] Packet timestamp &quot;LLU&quot; larger than max CTS in period &quot;LLU&quot; - skipping\n&quot;, hdr-&gt;compositionTimeStamp, group-&gt;max_cts_in_period));
<span class="lineNum">     216 </span>            : //                      return;
<span class="lineNum">     217 </span>            :                 }
<span class="lineNum">     218 </span>            : 
<span class="lineNum">     219 </span>            :                 //remap timestamps to our timeline
<span class="lineNum">     220 </span><span class="lineNoCov">          0 :                 if (hdr-&gt;decodingTimeStampFlag) {</span>
<span class="lineNum">     221 </span><span class="lineNoCov">          0 :                         if ((s64) hdr-&gt;decodingTimeStamp &gt;= group-&gt;pto)</span>
<span class="lineNum">     222 </span><span class="lineNoCov">          0 :                                 hdr-&gt;decodingTimeStamp -= group-&gt;pto;</span>
<span class="lineNum">     223 </span>            :                         else {
<span class="lineNum">     224 </span><span class="lineNoCov">          0 :                                 GF_LOG(GF_LOG_WARNING, GF_LOG_DASH, (&quot;[DASH] Packet DTS &quot;LLU&quot; less than PTO &quot;LLU&quot; - forcing DTS to 0\n&quot;, hdr-&gt;decodingTimeStamp, group-&gt;pto));</span>
<span class="lineNum">     225 </span><span class="lineNoCov">          0 :                                 hdr-&gt;decodingTimeStamp = 0;</span>
<span class="lineNum">     226 </span><span class="lineNoCov">          0 :                                 hdr-&gt;seekFlag = 1;</span>
<span class="lineNum">     227 </span>            :                         }
<span class="lineNum">     228 </span>            :                 }
<span class="lineNum">     229 </span><span class="lineNoCov">          0 :                 if (hdr-&gt;compositionTimeStampFlag) {</span>
<span class="lineNum">     230 </span><span class="lineNoCov">          0 :                         if ((s64) hdr-&gt;compositionTimeStamp &gt;= group-&gt;pto)</span>
<span class="lineNum">     231 </span><span class="lineNoCov">          0 :                                 hdr-&gt;compositionTimeStamp -= group-&gt;pto;</span>
<span class="lineNum">     232 </span>            :                         else {
<span class="lineNum">     233 </span><span class="lineNoCov">          0 :                                 GF_LOG(GF_LOG_WARNING, GF_LOG_DASH, (&quot;[DASH] Packet CTS &quot;LLU&quot; less than PTO &quot;LLU&quot; - forcing CTS to 0\n&quot;, hdr-&gt;compositionTimeStamp, group-&gt;pto));</span>
<span class="lineNum">     234 </span><span class="lineNoCov">          0 :                                 hdr-&gt;compositionTimeStamp = 0;</span>
<span class="lineNum">     235 </span><span class="lineNoCov">          0 :                                 hdr-&gt;seekFlag = 1;</span>
<span class="lineNum">     236 </span>            :                         }
<span class="lineNum">     237 </span>            :                 }
<span class="lineNum">     238 </span>            : 
<span class="lineNum">     239 </span><span class="lineNoCov">          0 :                 if (hdr-&gt;OCRflag) {</span>
<span class="lineNum">     240 </span><span class="lineNoCov">          0 :                         u32 scale = hdr-&gt;m2ts_pcr ? 300 : 1;</span>
<span class="lineNum">     241 </span><span class="lineNoCov">          0 :                         u64 pto = scale*group-&gt;pto;</span>
<span class="lineNum">     242 </span><span class="lineNoCov">          0 :                         if (hdr-&gt;objectClockReference &gt;= pto) {</span>
<span class="lineNum">     243 </span><span class="lineNoCov">          0 :                                 hdr-&gt;objectClockReference -= pto;</span>
<span class="lineNum">     244 </span><span class="lineNoCov">          0 :                         }</span>
<span class="lineNum">     245 </span>            :                         //keep 4 sec between the first received PCR and the first allowed PTS to be used in the period.
<span class="lineNum">     246 </span><span class="lineNoCov">          0 :                         else if (pto - hdr-&gt;objectClockReference &lt; 108000000) {</span>
<span class="lineNum">     247 </span><span class="lineNoCov">          0 :                                 hdr-&gt;objectClockReference = 0;</span>
<span class="lineNum">     248 </span>            :                         } else {
<span class="lineNum">     249 </span><span class="lineNoCov">          0 :                                 GF_LOG(GF_LOG_WARNING, GF_LOG_DASH, (&quot;[DASH] Packet OCR/PCR &quot;LLU&quot; less than PTO &quot;LLU&quot; - discarding PCR\n&quot;, hdr-&gt;objectClockReference/scale, group-&gt;pto));</span>
<span class="lineNum">     250 </span>            :                                 return;
<span class="lineNum">     251 </span>            :                         }
<span class="lineNum">     252 </span>            :                 }
<span class="lineNum">     253 </span>            : 
<span class="lineNum">     254 </span><span class="lineNoCov">          0 :         } else if (!group-&gt;pto_setup) {</span>
<span class="lineNum">     255 </span>            :                 do_map_time = 1;
<span class="lineNum">     256 </span><span class="lineNoCov">          0 :                 group-&gt;pto_setup = 1;</span>
<span class="lineNum">     257 </span><span class="lineNoCov">          0 :         }</span>
<span class="lineNum">     258 </span>            : 
<span class="lineNum">     259 </span><span class="lineNoCov">          0 :         mpdin-&gt;fn_data_packet(service, ns, data, data_size, hdr, reception_status);</span>
<span class="lineNum">     260 </span>            : 
<span class="lineNum">     261 </span><span class="lineNoCov">          0 :         if (do_map_time) {</span>
<span class="lineNum">     262 </span><span class="lineNoCov">          0 :                 GF_NetworkCommand com;</span>
<span class="lineNum">     263 </span><span class="lineNoCov">          0 :                 memset(&amp;com, 0, sizeof(com));</span>
<span class="lineNum">     264 </span><span class="lineNoCov">          0 :                 com.command_type = GF_NET_CHAN_SET_MEDIA_TIME;</span>
<span class="lineNum">     265 </span><span class="lineNoCov">          0 :                 com.map_time.media_time = mpdin-&gt;media_start_range;</span>
<span class="lineNum">     266 </span><span class="lineNoCov">          0 :                 com.map_time.timestamp = hdr-&gt;compositionTimeStamp;</span>
<span class="lineNum">     267 </span><span class="lineNoCov">          0 :                 com.base.on_channel =  ns;</span>
<span class="lineNum">     268 </span><span class="lineNoCov">          0 :                 gf_service_command(service, &amp;com, GF_OK);</span>
<span class="lineNum">     269 </span><span class="lineNoCov">          0 :         }</span>
<span class="lineNum">     270 </span><span class="lineNoCov">          0 : }</span>
<a name="271"><span class="lineNum">     271 </span>            : </a>
<span class="lineNum">     272 </span>            : 
<span class="lineNum">     273 </span>            : static void MPD_NotifyData(GF_MPDGroup *group, Bool chunk_flush)
<span class="lineNum">     274 </span>            : {
<span class="lineNum">     275 </span><span class="lineNoCov">          0 :         GF_NetworkCommand com;</span>
<span class="lineNum">     276 </span><span class="lineNoCov">          0 :         memset(&amp;com, 0, sizeof(GF_NetworkCommand));</span>
<span class="lineNum">     277 </span><span class="lineNoCov">          0 :         com.proxy_data.command_type = GF_NET_SERVICE_PROXY_DATA_RECEIVE;</span>
<span class="lineNum">     278 </span><span class="lineNoCov">          0 :         com.proxy_data.is_chunk = chunk_flush;</span>
<span class="lineNum">     279 </span><span class="lineNoCov">          0 :         com.proxy_data.is_live = gf_dash_is_dynamic_mpd(group-&gt;mpdin-&gt;dash);</span>
<span class="lineNum">     280 </span><span class="lineNoCov">          0 :         group-&gt;segment_ifce-&gt;ServiceCommand(group-&gt;segment_ifce, &amp;com);</span>
<a name="281"><span class="lineNum">     281 </span><span class="lineNoCov">          0 : }</span></a>
<span class="lineNum">     282 </span>            : 
<span class="lineNum">     283 </span>            : static GF_Err MPD_ClientQuery(GF_InputService *ifce, GF_NetworkCommand *param)
<span class="lineNum">     284 </span>            : {
<span class="lineNum">     285 </span>            :         u32 i;
<span class="lineNum">     286 </span>            :         GF_Err e;
<span class="lineNum">     287 </span><span class="lineNoCov">          0 :         GF_MPD_In *mpdin = (GF_MPD_In *) ifce-&gt;proxy_udta;</span>
<span class="lineNum">     288 </span><span class="lineNoCov">          0 :         if (!param || !ifce || !ifce-&gt;proxy_udta) return GF_BAD_PARAM;</span>
<span class="lineNum">     289 </span>            : 
<span class="lineNum">     290 </span>            :         /*gets byte range of init segment (for local validation)*/
<span class="lineNum">     291 </span><span class="lineNoCov">          0 :         if (param-&gt;command_type==GF_NET_SERVICE_QUERY_INIT_RANGE) {</span>
<span class="lineNum">     292 </span><span class="lineNoCov">          0 :                 param-&gt;url_query.next_url = NULL;</span>
<span class="lineNum">     293 </span><span class="lineNoCov">          0 :                 param-&gt;url_query.start_range = 0;</span>
<span class="lineNum">     294 </span><span class="lineNoCov">          0 :                 param-&gt;url_query.end_range = 0;</span>
<span class="lineNum">     295 </span>            : 
<span class="lineNum">     296 </span><span class="lineNoCov">          0 :                 for (i=0; i&lt;gf_dash_get_group_count(mpdin-&gt;dash); i++) {</span>
<span class="lineNum">     297 </span>            :                         GF_MPDGroup *group;
<span class="lineNum">     298 </span><span class="lineNoCov">          0 :                         if (!gf_dash_is_group_selectable(mpdin-&gt;dash, i)) continue;</span>
<span class="lineNum">     299 </span><span class="lineNoCov">          0 :                         group = gf_dash_get_group_udta(mpdin-&gt;dash, i);</span>
<span class="lineNum">     300 </span><span class="lineNoCov">          0 :                         if (!group) continue;</span>
<span class="lineNum">     301 </span>            : 
<span class="lineNum">     302 </span><span class="lineNoCov">          0 :                         if (group-&gt;segment_ifce == ifce) {</span>
<span class="lineNum">     303 </span><span class="lineNoCov">          0 :                                 gf_dash_group_get_segment_init_url(mpdin-&gt;dash, i, &amp;param-&gt;url_query.start_range, &amp;param-&gt;url_query.end_range);</span>
<span class="lineNum">     304 </span><span class="lineNoCov">          0 :                                 param-&gt;url_query.current_download = 0;</span>
<span class="lineNum">     305 </span>            : 
<span class="lineNum">     306 </span><span class="lineNoCov">          0 :                                 param-&gt;url_query.key_url = gf_dash_group_get_segment_init_keys(mpdin-&gt;dash, i, &amp;group-&gt;key_IV);</span>
<span class="lineNum">     307 </span><span class="lineNoCov">          0 :                                 if (param-&gt;url_query.key_url) {</span>
<span class="lineNum">     308 </span><span class="lineNoCov">          0 :                                         param-&gt;url_query.key_IV = &amp;group-&gt;key_IV;</span>
<span class="lineNum">     309 </span><span class="lineNoCov">          0 :                                 }</span>
<span class="lineNum">     310 </span><span class="lineNoCov">          0 :                                 return GF_OK;</span>
<span class="lineNum">     311 </span>            :                         }
<span class="lineNum">     312 </span>            :                 }
<span class="lineNum">     313 </span><span class="lineNoCov">          0 :                 return GF_SERVICE_ERROR;</span>
<span class="lineNum">     314 </span>            :         }
<span class="lineNum">     315 </span>            : 
<span class="lineNum">     316 </span>            :         /*gets URL and byte range of next segment - if needed, adds bitstream switching segment info*/
<span class="lineNum">     317 </span><span class="lineNoCov">          0 :         if (param-&gt;command_type==GF_NET_SERVICE_QUERY_NEXT) {</span>
<span class="lineNum">     318 </span>            :                 Bool group_done;
<span class="lineNum">     319 </span>            :                 u32 nb_segments_cached;
<span class="lineNum">     320 </span>            :                 u32 group_idx=0;
<span class="lineNum">     321 </span>            :                 GF_MPDGroup *group=NULL;
<span class="lineNum">     322 </span>            :                 const char *src_url;
<span class="lineNum">     323 </span><span class="lineNoCov">          0 :                 Bool discard_first_cache_entry = param-&gt;url_query.drop_first_segment;</span>
<span class="lineNum">     324 </span><span class="lineNoCov">          0 :                 Bool check_current_download = param-&gt;url_query.current_download;</span>
<span class="lineNum">     325 </span><span class="lineNoCov">          0 :                 u32 timer = gf_sys_clock();</span>
<span class="lineNum">     326 </span><span class="lineNoCov">          0 :                 GF_LOG(GF_LOG_DEBUG, GF_LOG_DASH, (&quot;[MPD_IN] Received Service Query Next request from input service %s\n&quot;, ifce-&gt;module_name));</span>
<span class="lineNum">     327 </span>            : 
<span class="lineNum">     328 </span>            : 
<span class="lineNum">     329 </span><span class="lineNoCov">          0 :                 param-&gt;url_query.current_download = 0;</span>
<span class="lineNum">     330 </span><span class="lineNoCov">          0 :                 param-&gt;url_query.discontinuity_type = 0;</span>
<span class="lineNum">     331 </span>            : 
<span class="lineNum">     332 </span><span class="lineNoCov">          0 :                 for (i=0; i&lt;gf_dash_get_group_count(mpdin-&gt;dash); i++) {</span>
<span class="lineNum">     333 </span><span class="lineNoCov">          0 :                         if (!gf_dash_is_group_selected(mpdin-&gt;dash, i)) continue;</span>
<span class="lineNum">     334 </span><span class="lineNoCov">          0 :                         group = gf_dash_get_group_udta(mpdin-&gt;dash, i);</span>
<span class="lineNum">     335 </span><span class="lineNoCov">          0 :                         if (group-&gt;segment_ifce == ifce) {</span>
<span class="lineNum">     336 </span>            :                                 group_idx = i;
<span class="lineNum">     337 </span><span class="lineNoCov">          0 :                                 break;</span>
<span class="lineNum">     338 </span>            :                         }
<span class="lineNum">     339 </span>            :                         group=NULL;
<span class="lineNum">     340 </span><span class="lineNoCov">          0 :                 }</span>
<span class="lineNum">     341 </span>            : 
<span class="lineNum">     342 </span><span class="lineNoCov">          0 :                 if (!group) {</span>
<span class="lineNum">     343 </span><span class="lineNoCov">          0 :                         return GF_SERVICE_ERROR;</span>
<span class="lineNum">     344 </span>            :                 }
<span class="lineNum">     345 </span>            : 
<span class="lineNum">     346 </span>            :                 //update group idx
<span class="lineNum">     347 </span><span class="lineNoCov">          0 :                 if (group-&gt;idx != group_idx) {</span>
<span class="lineNum">     348 </span><span class="lineNoCov">          0 :                         group-&gt;idx = group_idx;</span>
<span class="lineNum">     349 </span><span class="lineNoCov">          0 :                         GF_LOG(GF_LOG_DEBUG, GF_LOG_DASH, (&quot;[MPD_IN] New AdaptationSet detected after MPD update ?\n&quot;));</span>
<span class="lineNum">     350 </span>            :                 }
<span class="lineNum">     351 </span>            : 
<span class="lineNum">     352 </span><span class="lineNoCov">          0 :                 if (discard_first_cache_entry) {</span>
<span class="lineNum">     353 </span><span class="lineNoCov">          0 :                         GF_LOG(GF_LOG_DEBUG, GF_LOG_DASH, (&quot;[MPD_IN] Discarding first segment in cache\n&quot;));</span>
<span class="lineNum">     354 </span><span class="lineNoCov">          0 :                         gf_dash_group_discard_segment(mpdin-&gt;dash, group_idx);</span>
<span class="lineNum">     355 </span><span class="lineNoCov">          0 :                 }</span>
<span class="lineNum">     356 </span>            : 
<span class="lineNum">     357 </span><span class="lineNoCov">          0 :                 while (gf_dash_is_running(mpdin-&gt;dash)) {</span>
<span class="lineNum">     358 </span><span class="lineNoCov">          0 :                         group_done=0;</span>
<span class="lineNum">     359 </span><span class="lineNoCov">          0 :                         nb_segments_cached = gf_dash_group_get_num_segments_ready(mpdin-&gt;dash, group_idx, &amp;group_done);</span>
<span class="lineNum">     360 </span><span class="lineNoCov">          0 :                         if (nb_segments_cached&gt;=1)</span>
<span class="lineNum">     361 </span>            :                                 break;
<span class="lineNum">     362 </span>            : 
<span class="lineNum">     363 </span><span class="lineNoCov">          0 :                         if (group_done) {</span>
<span class="lineNum">     364 </span><span class="lineNoCov">          0 :                                 if (!gf_dash_get_period_switch_status(mpdin-&gt;dash) &amp;&amp; !gf_dash_in_last_period(mpdin-&gt;dash)) {</span>
<span class="lineNum">     365 </span><span class="lineNoCov">          0 :                                         GF_NetworkCommand com;</span>
<span class="lineNum">     366 </span><span class="lineNoCov">          0 :                                         param-&gt;url_query.in_end_of_period = 1;</span>
<span class="lineNum">     367 </span><span class="lineNoCov">          0 :                                         memset(&amp;com, 0, sizeof(GF_NetworkCommand));</span>
<span class="lineNum">     368 </span><span class="lineNoCov">          0 :                                         com.command_type = GF_NET_BUFFER_QUERY;</span>
<span class="lineNum">     369 </span><span class="lineNoCov">          0 :                                         if (gf_dash_get_period_switch_status(mpdin-&gt;dash) != 1) {</span>
<span class="lineNum">     370 </span><span class="lineNoCov">          0 :                                                 gf_service_command(mpdin-&gt;service, &amp;com, GF_OK);</span>
<span class="lineNum">     371 </span>            :                                                 //we only switch period once no more data is in our buffers
<span class="lineNum">     372 </span><span class="lineNoCov">          0 :                                                 if (!com.buffer.occupancy) {</span>
<span class="lineNum">     373 </span><span class="lineNoCov">          0 :                                                         param-&gt;url_query.in_end_of_period = 0;</span>
<span class="lineNum">     374 </span><span class="lineNoCov">          0 :                                                         gf_dash_request_period_switch(mpdin-&gt;dash);</span>
<span class="lineNum">     375 </span><span class="lineNoCov">          0 :                                                 }</span>
<span class="lineNum">     376 </span>            :                                         }
<span class="lineNum">     377 </span><span class="lineNoCov">          0 :                                         if (param-&gt;url_query.in_end_of_period)</span>
<span class="lineNum">     378 </span><span class="lineNoCov">          0 :                                                 return GF_BUFFER_TOO_SMALL;</span>
<span class="lineNum">     379 </span><span class="lineNoCov">          0 :                                 } else {</span>
<span class="lineNum">     380 </span><span class="lineNoCov">          0 :                                         return GF_EOS;</span>
<span class="lineNum">     381 </span>            :                                 }
<span class="lineNum">     382 </span>            :                         }
<span class="lineNum">     383 </span>            : 
<span class="lineNum">     384 </span><span class="lineNoCov">          0 :                         if (check_current_download &amp;&amp; mpdin-&gt;use_low_latency) {</span>
<span class="lineNum">     385 </span><span class="lineNoCov">          0 :                                 Bool is_switched=GF_FALSE;</span>
<span class="lineNum">     386 </span><span class="lineNoCov">          0 :                                 gf_dash_group_probe_current_download_segment_location(mpdin-&gt;dash, group_idx, &amp;param-&gt;url_query.next_url, NULL, &amp;param-&gt;url_query.next_url_init_or_switch_segment, &amp;src_url, &amp;is_switched);</span>
<span class="lineNum">     387 </span>            : 
<span class="lineNum">     388 </span><span class="lineNoCov">          0 :                                 if (param-&gt;url_query.next_url) {</span>
<span class="lineNum">     389 </span><span class="lineNoCov">          0 :                                         param-&gt;url_query.current_download = 1;</span>
<span class="lineNum">     390 </span><span class="lineNoCov">          0 :                                         param-&gt;url_query.has_new_data = group-&gt;has_new_data;</span>
<span class="lineNum">     391 </span><span class="lineNoCov">          0 :                                         param-&gt;url_query.discontinuity_type = is_switched ? 1 : 0;</span>
<span class="lineNum">     392 </span><span class="lineNoCov">          0 :                                         if (gf_dash_group_loop_detected(mpdin-&gt;dash, group_idx))</span>
<span class="lineNum">     393 </span><span class="lineNoCov">          0 :                                                 param-&gt;url_query.discontinuity_type = 2;</span>
<span class="lineNum">     394 </span><span class="lineNoCov">          0 :                                         group-&gt;has_new_data = 0;</span>
<span class="lineNum">     395 </span><span class="lineNoCov">          0 :                                         return GF_OK;</span>
<span class="lineNum">     396 </span>            :                                 }
<span class="lineNum">     397 </span><span class="lineNoCov">          0 :                                 return GF_BUFFER_TOO_SMALL;</span>
<span class="lineNum">     398 </span>            :                         }
<span class="lineNum">     399 </span><span class="lineNoCov">          0 :                         return GF_BUFFER_TOO_SMALL;</span>
<span class="lineNum">     400 </span>            :                 }
<span class="lineNum">     401 </span>            : 
<span class="lineNum">     402 </span><span class="lineNoCov">          0 :                 param-&gt;url_query.current_download = 0;</span>
<span class="lineNum">     403 </span><span class="lineNoCov">          0 :                 nb_segments_cached = gf_dash_group_get_num_segments_ready(mpdin-&gt;dash, group_idx, &amp;group_done);</span>
<span class="lineNum">     404 </span><span class="lineNoCov">          0 :                 if (nb_segments_cached &lt; 1) {</span>
<span class="lineNum">     405 </span><span class="lineNoCov">          0 :                         GF_LOG(GF_LOG_INFO, GF_LOG_DASH, (&quot;[MPD_IN] No more file in cache, EOS\n&quot;));</span>
<span class="lineNum">     406 </span><span class="lineNoCov">          0 :                         return GF_EOS;</span>
<span class="lineNum">     407 </span>            :                 } else {
<span class="lineNum">     408 </span><span class="lineNoCov">          0 :                         GF_LOG(GF_LOG_DEBUG, GF_LOG_DASH, (&quot;[MPD_IN] Had to wait for %u ms for the only cache file to be downloaded\n&quot;, (gf_sys_clock() - timer)));</span>
<span class="lineNum">     409 </span>            :                 }
<span class="lineNum">     410 </span>            : 
<span class="lineNum">     411 </span><span class="lineNoCov">          0 :                 e = gf_dash_group_get_next_segment_location(mpdin-&gt;dash, group_idx, param-&gt;url_query.dependent_representation_index, &amp;param-&gt;url_query.next_url, &amp;param-&gt;url_query.start_range, &amp;param-&gt;url_query.end_range,</span>
<span class="lineNum">     412 </span>            :                         NULL, &amp;param-&gt;url_query.next_url_init_or_switch_segment, &amp;param-&gt;url_query.switch_start_range , &amp;param-&gt;url_query.switch_end_range,
<span class="lineNum">     413 </span>            :                         &amp;src_url, &amp;param-&gt;url_query.has_next, &amp;param-&gt;url_query.key_url, &amp;group-&gt;key_IV);
<span class="lineNum">     414 </span><span class="lineNoCov">          0 :                 if (e)</span>
<span class="lineNum">     415 </span><span class="lineNoCov">          0 :                         return e;</span>
<span class="lineNum">     416 </span>            : 
<span class="lineNum">     417 </span><span class="lineNoCov">          0 :                 param-&gt;url_query.key_IV = &amp;group-&gt;key_IV;</span>
<span class="lineNum">     418 </span>            : 
<span class="lineNum">     419 </span><span class="lineNoCov">          0 :                 if (gf_dash_group_loop_detected(mpdin-&gt;dash, group_idx))</span>
<span class="lineNum">     420 </span><span class="lineNoCov">          0 :                         param-&gt;url_query.discontinuity_type = 2;</span>
<span class="lineNum">     421 </span>            : 
<span class="lineNum">     422 </span>            : 
<span class="lineNum">     423 </span>            : #ifndef GPAC_DISABLE_LOG
<span class="lineNum">     424 </span>            :                 {
<span class="lineNum">     425 </span><span class="lineNoCov">          0 :                         u32 timer2 = gf_sys_clock() - timer;</span>
<span class="lineNum">     426 </span><span class="lineNoCov">          0 :                         if (timer2 &gt; 1000) {</span>
<span class="lineNum">     427 </span><span class="lineNoCov">          0 :                                 GF_LOG(GF_LOG_DEBUG, GF_LOG_DASH, (&quot;[MPD_IN] Waiting for download to end took a long time : %u ms\n&quot;, timer2));</span>
<span class="lineNum">     428 </span>            :                         }
<span class="lineNum">     429 </span><span class="lineNoCov">          0 :                         if (param-&gt;url_query.end_range) {</span>
<span class="lineNum">     430 </span><span class="lineNoCov">          0 :                                 GF_LOG(GF_LOG_INFO, GF_LOG_DASH, (&quot;[MPD_IN] Next Segment is %s bytes &quot;LLD&quot;-&quot;LLD&quot;\n&quot;, src_url, param-&gt;url_query.start_range, param-&gt;url_query.end_range));</span>
<span class="lineNum">     431 </span>            :                         } else {
<span class="lineNum">     432 </span><span class="lineNoCov">          0 :                                 GF_LOG(GF_LOG_INFO, GF_LOG_DASH, (&quot;[MPD_IN] Next Segment is %s\n&quot;, src_url));</span>
<span class="lineNum">     433 </span>            :                         }
<span class="lineNum">     434 </span><span class="lineNoCov">          0 :                         GF_LOG(GF_LOG_DEBUG, GF_LOG_DASH, (&quot;[MPD_IN] Waited %d ms - Elements in cache: %u/%u\n\tCache file name %s\n\tsegment start time %g sec\n&quot;, timer2, gf_dash_group_get_num_segments_ready(mpdin-&gt;dash, group_idx, &amp;group_done), gf_dash_group_get_max_segments_in_cache(mpdin-&gt;dash, group_idx), param-&gt;url_query.next_url, gf_dash_group_current_segment_start_time(mpdin-&gt;dash, group_idx)));</span>
<span class="lineNum">     435 </span>            :                 }
<span class="lineNum">     436 </span>            : #endif
<span class="lineNum">     437 </span>            :         }
<span class="lineNum">     438 </span>            : 
<span class="lineNum">     439 </span>            : 
<span class="lineNum">     440 </span><span class="lineNoCov">          0 :         return GF_OK;</span>
<span class="lineNum">     441 </span><span class="lineNoCov">          0 : }</span>
<a name="442"><span class="lineNum">     442 </span>            : </a>
<span class="lineNum">     443 </span>            : /*locates input service (demuxer) based on mime type or segment name*/
<span class="lineNum">     444 </span>            : static GF_Err MPD_LoadMediaService(GF_MPD_In *mpdin, u32 group_index, const char *mime, const char *init_segment_name)
<span class="lineNum">     445 </span>            : {
<span class="lineNum">     446 </span>            :         GF_InputService *segment_ifce;
<span class="lineNum">     447 </span>            :         u32 i;
<span class="lineNum">     448 </span>            :         const char *sPlug;
<span class="lineNum">     449 </span><span class="lineNoCov">          0 :         if (mime) {</span>
<span class="lineNum">     450 </span>            :                 /* Check MIME type to start the right InputService */
<span class="lineNum">     451 </span><span class="lineNoCov">          0 :                 sPlug = gf_cfg_get_key(mpdin-&gt;service-&gt;term-&gt;user-&gt;config, &quot;MimeTypes&quot;, mime);</span>
<span class="lineNum">     452 </span><span class="lineNoCov">          0 :                 if (sPlug) sPlug = strrchr(sPlug, '&quot;');</span>
<span class="lineNum">     453 </span><span class="lineNoCov">          0 :                 if (sPlug) {</span>
<span class="lineNum">     454 </span><span class="lineNoCov">          0 :                         sPlug += 2;</span>
<span class="lineNum">     455 </span><span class="lineNoCov">          0 :                         segment_ifce = (GF_InputService *) gf_modules_load_interface_by_name(mpdin-&gt;service-&gt;term-&gt;user-&gt;modules, sPlug, GF_NET_CLIENT_INTERFACE);</span>
<span class="lineNum">     456 </span><span class="lineNoCov">          0 :                         if (segment_ifce) {</span>
<span class="lineNum">     457 </span>            :                                 GF_MPDGroup *group;
<span class="lineNum">     458 </span><span class="lineNoCov">          0 :                                 GF_SAFEALLOC(group, GF_MPDGroup);</span>
<span class="lineNum">     459 </span><span class="lineNoCov">          0 :                                 if (!group) return GF_OUT_OF_MEM;</span>
<span class="lineNum">     460 </span>            :                                 
<span class="lineNum">     461 </span><span class="lineNoCov">          0 :                                 group-&gt;segment_ifce = segment_ifce;</span>
<span class="lineNum">     462 </span><span class="lineNoCov">          0 :                                 group-&gt;segment_ifce-&gt;proxy_udta = mpdin;</span>
<span class="lineNum">     463 </span><span class="lineNoCov">          0 :                                 group-&gt;segment_ifce-&gt;query_proxy = MPD_ClientQuery;</span>
<span class="lineNum">     464 </span><span class="lineNoCov">          0 :                                 group-&gt;mpdin = mpdin;</span>
<span class="lineNum">     465 </span><span class="lineNoCov">          0 :                                 group-&gt;idx = group_index;</span>
<span class="lineNum">     466 </span><span class="lineNoCov">          0 :                                 gf_dash_set_group_udta(mpdin-&gt;dash, group_index, group);</span>
<span class="lineNum">     467 </span><span class="lineNoCov">          0 :                                 return GF_OK;</span>
<span class="lineNum">     468 </span>            :                         }
<span class="lineNum">     469 </span>            :                 }
<span class="lineNum">     470 </span>            :         }
<span class="lineNum">     471 </span><span class="lineNoCov">          0 :         if (init_segment_name) {</span>
<span class="lineNum">     472 </span><span class="lineNoCov">          0 :                 for (i=0; i&lt; gf_modules_get_count(mpdin-&gt;service-&gt;term-&gt;user-&gt;modules); i++) {</span>
<span class="lineNum">     473 </span><span class="lineNoCov">          0 :                         GF_InputService *ifce = (GF_InputService *) gf_modules_load_interface(mpdin-&gt;service-&gt;term-&gt;user-&gt;modules, i, GF_NET_CLIENT_INTERFACE);</span>
<span class="lineNum">     474 </span><span class="lineNoCov">          0 :                         if (!ifce) continue;</span>
<span class="lineNum">     475 </span>            : 
<span class="lineNum">     476 </span><span class="lineNoCov">          0 :                         if (ifce-&gt;CanHandleURL &amp;&amp; ifce-&gt;CanHandleURL(ifce, init_segment_name)) {</span>
<span class="lineNum">     477 </span>            :                                 GF_MPDGroup *group;
<span class="lineNum">     478 </span><span class="lineNoCov">          0 :                                 GF_SAFEALLOC(group, GF_MPDGroup);</span>
<span class="lineNum">     479 </span><span class="lineNoCov">          0 :                                 if (!group) return GF_OUT_OF_MEM;</span>
<span class="lineNum">     480 </span><span class="lineNoCov">          0 :                                 group-&gt;segment_ifce = ifce;</span>
<span class="lineNum">     481 </span><span class="lineNoCov">          0 :                                 group-&gt;segment_ifce-&gt;proxy_udta = mpdin;</span>
<span class="lineNum">     482 </span><span class="lineNoCov">          0 :                                 group-&gt;segment_ifce-&gt;query_proxy = MPD_ClientQuery;</span>
<span class="lineNum">     483 </span><span class="lineNoCov">          0 :                                 group-&gt;mpdin = mpdin;</span>
<span class="lineNum">     484 </span><span class="lineNoCov">          0 :                                 group-&gt;idx = group_index;</span>
<span class="lineNum">     485 </span><span class="lineNoCov">          0 :                                 gf_dash_set_group_udta(mpdin-&gt;dash, group_index, group);</span>
<span class="lineNum">     486 </span><span class="lineNoCov">          0 :                                 return GF_OK;</span>
<span class="lineNum">     487 </span>            :                         }
<span class="lineNum">     488 </span><span class="lineNoCov">          0 :                         gf_modules_close_interface((GF_BaseInterface *) ifce);</span>
<span class="lineNum">     489 </span><span class="lineNoCov">          0 :                 }</span>
<span class="lineNum">     490 </span>            :         }
<span class="lineNum">     491 </span><span class="lineNoCov">          0 :         GF_LOG(GF_LOG_ERROR, GF_LOG_DASH, (&quot;[MPD_IN] Error locating plugin for segment - mime type %s - name %s\n&quot;, mime, init_segment_name));</span>
<span class="lineNum">     492 </span><span class="lineNoCov">          0 :         return GF_CODEC_NOT_FOUND;</span>
<span class="lineNum">     493 </span><span class="lineNoCov">          0 : }</span>
<span class="lineNum">     494 </span>            : 
<a name="495"><span class="lineNum">     495 </span>            : </a>
<span class="lineNum">     496 </span>            : 
<span class="lineNum">     497 </span>            : GF_InputService *MPD_GetInputServiceForChannel(GF_MPD_In *mpdin, LPNETCHANNEL channel)
<span class="lineNum">     498 </span>            : {
<span class="lineNum">     499 </span>            :         GF_Channel *ch;
<span class="lineNum">     500 </span><span class="lineNoCov">          0 :         if (!channel) {</span>
<span class="lineNum">     501 </span>            :                 u32 i;
<span class="lineNum">     502 </span><span class="lineNoCov">          0 :                 for (i=0; i&lt;gf_dash_get_group_count(mpdin-&gt;dash); i++) {</span>
<span class="lineNum">     503 </span><span class="lineNoCov">          0 :                         if (gf_dash_is_group_selectable(mpdin-&gt;dash, i)) {</span>
<span class="lineNum">     504 </span><span class="lineNoCov">          0 :                                 GF_MPDGroup *mudta = gf_dash_get_group_udta(mpdin-&gt;dash, i);</span>
<span class="lineNum">     505 </span><span class="lineNoCov">          0 :                                 if (mudta &amp;&amp; mudta-&gt;segment_ifce) return mudta-&gt;segment_ifce;</span>
<span class="lineNum">     506 </span>            :                         }
<span class="lineNum">     507 </span>            :                 }
<span class="lineNum">     508 </span><span class="lineNoCov">          0 :                 return NULL;</span>
<span class="lineNum">     509 </span>            :         }
<span class="lineNum">     510 </span>            : 
<span class="lineNum">     511 </span><span class="lineNoCov">          0 :         ch = (GF_Channel *) channel;</span>
<span class="lineNum">     512 </span>            :         assert(ch-&gt;odm &amp;&amp; ch-&gt;odm-&gt;OD);
<span class="lineNum">     513 </span><span class="lineNoCov">          0 :         return (GF_InputService *) ch-&gt;odm-&gt;OD-&gt;service_ifce;</span>
<a name="514"><span class="lineNum">     514 </span><span class="lineNoCov">          0 : }</span></a>
<span class="lineNum">     515 </span>            : 
<span class="lineNum">     516 </span>            : s32 MPD_GetGroupIndexForChannel(GF_MPD_In *mpdin, LPNETCHANNEL channel)
<span class="lineNum">     517 </span>            : {
<span class="lineNum">     518 </span>            :         u32 i;
<span class="lineNum">     519 </span><span class="lineNoCov">          0 :         GF_InputService *ifce = MPD_GetInputServiceForChannel(mpdin, channel);</span>
<span class="lineNum">     520 </span><span class="lineNoCov">          0 :         if (!ifce) return -1;</span>
<span class="lineNum">     521 </span>            : 
<span class="lineNum">     522 </span><span class="lineNoCov">          0 :         for (i=0; i&lt;gf_dash_get_group_count(mpdin-&gt;dash); i++) {</span>
<span class="lineNum">     523 </span><span class="lineNoCov">          0 :                 GF_MPDGroup *group = gf_dash_get_group_udta(mpdin-&gt;dash, i);</span>
<span class="lineNum">     524 </span><span class="lineNoCov">          0 :                 if (!group) continue;</span>
<span class="lineNum">     525 </span><span class="lineNoCov">          0 :                 if (group-&gt;segment_ifce == ifce) return i;</span>
<span class="lineNum">     526 </span>            :         }
<span class="lineNum">     527 </span><span class="lineNoCov">          0 :         return -1;</span>
<a name="528"><span class="lineNum">     528 </span><span class="lineNoCov">          0 : }</span></a>
<span class="lineNum">     529 </span>            : 
<span class="lineNum">     530 </span>            : GF_Err MPD_ConnectChannel(GF_InputService *plug, LPNETCHANNEL channel, const char *url, Bool upstream)
<span class="lineNum">     531 </span>            : {
<span class="lineNum">     532 </span><span class="lineNoCov">          0 :         GF_MPD_In *mpdin = (GF_MPD_In*) plug-&gt;priv;</span>
<span class="lineNum">     533 </span><span class="lineNoCov">          0 :         GF_InputService *segment_ifce = MPD_GetInputServiceForChannel(mpdin, channel);</span>
<span class="lineNum">     534 </span><span class="lineNoCov">          0 :         if (!plug || !plug-&gt;priv || !segment_ifce) return GF_SERVICE_ERROR;</span>
<span class="lineNum">     535 </span><span class="lineNoCov">          0 :         GF_LOG(GF_LOG_DEBUG, GF_LOG_DASH, (&quot;[MPD_IN] Received Channel Connection (%p) request from terminal for %s\n&quot;, channel, url));</span>
<span class="lineNum">     536 </span><span class="lineNoCov">          0 :         return segment_ifce-&gt;ConnectChannel(segment_ifce, channel, url, upstream);</span>
<a name="537"><span class="lineNum">     537 </span><span class="lineNoCov">          0 : }</span></a>
<span class="lineNum">     538 </span>            : 
<span class="lineNum">     539 </span>            : GF_Err MPD_DisconnectChannel(GF_InputService *plug, LPNETCHANNEL channel)
<span class="lineNum">     540 </span>            : {
<span class="lineNum">     541 </span><span class="lineNoCov">          0 :         GF_MPD_In *mpdin = (GF_MPD_In*) plug-&gt;priv;</span>
<span class="lineNum">     542 </span><span class="lineNoCov">          0 :         GF_InputService *segment_ifce = MPD_GetInputServiceForChannel(mpdin, channel);</span>
<span class="lineNum">     543 </span><span class="lineNoCov">          0 :         if (!plug || !plug-&gt;priv || !segment_ifce) return GF_SERVICE_ERROR;</span>
<span class="lineNum">     544 </span><span class="lineNoCov">          0 :         GF_LOG(GF_LOG_DEBUG, GF_LOG_DASH, (&quot;[MPD_IN] Received Disconnect channel (%p) request from terminal \n&quot;, channel));</span>
<span class="lineNum">     545 </span>            : 
<span class="lineNum">     546 </span><span class="lineNoCov">          0 :         return segment_ifce-&gt;DisconnectChannel(segment_ifce, channel);</span>
<span class="lineNum">     547 </span><span class="lineNoCov">          0 : }</span>
<a name="548"><span class="lineNum">     548 </span>            : </a>
<span class="lineNum">     549 </span>            : 
<span class="lineNum">     550 </span>            : static void mpdin_dash_segment_netio(void *cbk, GF_NETIO_Parameter *param)
<span class="lineNum">     551 </span>            : {
<span class="lineNum">     552 </span><span class="lineNoCov">          0 :         GF_MPDGroup *group = (GF_MPDGroup *)cbk;</span>
<span class="lineNum">     553 </span>            : 
<span class="lineNum">     554 </span><span class="lineNoCov">          0 :         if (param-&gt;msg_type == GF_NETIO_PARSE_HEADER) {</span>
<span class="lineNum">     555 </span><span class="lineNoCov">          0 :                 if (!strcmp(param-&gt;name, &quot;Dash-Newest-Segment&quot;)) {</span>
<span class="lineNum">     556 </span><span class="lineNoCov">          0 :                         gf_dash_resync_to_segment(group-&gt;mpdin-&gt;dash, param-&gt;value, gf_dm_sess_get_header(param-&gt;sess, &quot;Dash-Oldest-Segment&quot;));</span>
<span class="lineNum">     557 </span><span class="lineNoCov">          0 :                 }</span>
<span class="lineNum">     558 </span>            :         }
<span class="lineNum">     559 </span>            : 
<span class="lineNum">     560 </span><span class="lineNoCov">          0 :         if (param-&gt;msg_type == GF_NETIO_DATA_EXCHANGE) {</span>
<span class="lineNum">     561 </span><span class="lineNoCov">          0 :                 group-&gt;has_new_data = 1;</span>
<span class="lineNum">     562 </span>            : 
<span class="lineNum">     563 </span><span class="lineNoCov">          0 :                 if (param-&gt;reply) {</span>
<span class="lineNum">     564 </span>            :                         u32 bytes_per_sec;
<span class="lineNum">     565 </span>            :                         const char *url;
<span class="lineNum">     566 </span><span class="lineNoCov">          0 :                         gf_dm_sess_get_stats(group-&gt;sess, NULL, &amp;url, NULL, NULL, &amp;bytes_per_sec, NULL);</span>
<span class="lineNum">     567 </span><span class="lineNoCov">          0 :                         GF_LOG(GF_LOG_DEBUG, GF_LOG_DASH, (&quot;[MPD_IN] End of chunk received for %s at UTC &quot;LLU&quot; ms - estimated bandwidth %d kbps - chunk start at UTC &quot;LLU&quot;\n&quot;, url, gf_net_get_utc(), 8*bytes_per_sec/1000, gf_dm_sess_get_utc_start(group-&gt;sess)));</span>
<span class="lineNum">     568 </span>            : 
<span class="lineNum">     569 </span><span class="lineNoCov">          0 :                         if (group-&gt;mpdin-&gt;use_low_latency)</span>
<span class="lineNum">     570 </span><span class="lineNoCov">          0 :                                 MPD_NotifyData(group, 1);</span>
<span class="lineNum">     571 </span><span class="lineNoCov">          0 :                 } else if (group-&gt;mpdin-&gt;use_low_latency==2) {</span>
<span class="lineNum">     572 </span><span class="lineNoCov">          0 :                         MPD_NotifyData(group, 1);</span>
<span class="lineNum">     573 </span><span class="lineNoCov">          0 :                 }</span>
<span class="lineNum">     574 </span>            : 
<span class="lineNum">     575 </span><span class="lineNoCov">          0 :                 if (group-&gt;mpdin-&gt;allow_http_abort)</span>
<span class="lineNum">     576 </span><span class="lineNoCov">          0 :                         gf_dash_group_check_bandwidth(group-&gt;mpdin-&gt;dash, group-&gt;idx);</span>
<span class="lineNum">     577 </span>            :         }
<span class="lineNum">     578 </span><span class="lineNoCov">          0 :         if (param-&gt;msg_type == GF_NETIO_DATA_TRANSFERED) {</span>
<span class="lineNum">     579 </span>            :                 u32 bytes_per_sec;
<span class="lineNum">     580 </span>            :                 const char *url;
<span class="lineNum">     581 </span><span class="lineNoCov">          0 :                 gf_dm_sess_get_stats(group-&gt;sess, NULL, &amp;url, NULL, NULL, &amp;bytes_per_sec, NULL);</span>
<span class="lineNum">     582 </span><span class="lineNoCov">          0 :                 GF_LOG(GF_LOG_DEBUG, GF_LOG_DASH, (&quot;[MPD_IN] End of file %s download at UTC &quot;LLU&quot; ms - estimated bandwidth %d kbps - started file or last chunk at UTC &quot;LLU&quot;\n&quot;, url, gf_net_get_utc(), 8*bytes_per_sec/1000, gf_dm_sess_get_utc_start(group-&gt;sess)));</span>
<span class="lineNum">     583 </span>            :         }
<a name="584"><span class="lineNum">     584 </span><span class="lineNoCov">          0 : }</span></a>
<span class="lineNum">     585 </span>            : 
<span class="lineNum">     586 </span>            : void mpdin_dash_io_delete_cache_file(GF_DASHFileIO *dashio, GF_DASHFileIOSession session, const char *cache_url)
<span class="lineNum">     587 </span>            : {
<span class="lineNum">     588 </span><span class="lineNoCov">          0 :         gf_dm_delete_cached_file_entry_session((GF_DownloadSession *)session, cache_url);</span>
<a name="589"><span class="lineNum">     589 </span><span class="lineNoCov">          0 : }</span></a>
<span class="lineNum">     590 </span>            : 
<span class="lineNum">     591 </span>            : GF_DASHFileIOSession mpdin_dash_io_create(GF_DASHFileIO *dashio, Bool persistent, const char *url, s32 group_idx)
<span class="lineNum">     592 </span>            : {
<span class="lineNum">     593 </span>            :         GF_MPDGroup *group = NULL;
<span class="lineNum">     594 </span>            :         GF_DownloadSession *sess;
<span class="lineNum">     595 </span>            :         u32 flags = GF_NETIO_SESSION_NOT_THREADED;
<span class="lineNum">     596 </span><span class="lineNoCov">          0 :         GF_MPD_In *mpdin = (GF_MPD_In *)dashio-&gt;udta;</span>
<span class="lineNum">     597 </span><span class="lineNoCov">          0 :         if (mpdin-&gt;memory_storage)</span>
<span class="lineNum">     598 </span><span class="lineNoCov">          0 :                 flags |= GF_NETIO_SESSION_MEMORY_CACHE;</span>
<span class="lineNum">     599 </span>            : 
<span class="lineNum">     600 </span><span class="lineNoCov">          0 :         if (persistent) flags |= GF_NETIO_SESSION_PERSISTENT;</span>
<span class="lineNum">     601 </span>            : 
<span class="lineNum">     602 </span><span class="lineNoCov">          0 :         if (group_idx&gt;=0) {</span>
<span class="lineNum">     603 </span><span class="lineNoCov">          0 :                 group = gf_dash_get_group_udta(mpdin-&gt;dash, group_idx);</span>
<span class="lineNum">     604 </span><span class="lineNoCov">          0 :         }</span>
<span class="lineNum">     605 </span><span class="lineNoCov">          0 :         if (group) {</span>
<span class="lineNum">     606 </span><span class="lineNoCov">          0 :                 group-&gt;netio_assigned = GF_TRUE;</span>
<span class="lineNum">     607 </span><span class="lineNoCov">          0 :                 group-&gt;sess = sess = gf_service_download_new(mpdin-&gt;service, url, flags, mpdin_dash_segment_netio, group);</span>
<span class="lineNum">     608 </span><span class="lineNoCov">          0 :         } else {</span>
<span class="lineNum">     609 </span><span class="lineNoCov">          0 :                 sess = gf_service_download_new(mpdin-&gt;service, url, flags, NULL, NULL);</span>
<span class="lineNum">     610 </span>            :         }
<a name="611"><span class="lineNum">     611 </span><span class="lineNoCov">          0 :         return (GF_DASHFileIOSession) sess;</span></a>
<span class="lineNum">     612 </span>            : }
<span class="lineNum">     613 </span>            : void mpdin_dash_io_del(GF_DASHFileIO *dashio, GF_DASHFileIOSession session)
<span class="lineNum">     614 </span>            : {
<a name="615"><span class="lineNum">     615 </span><span class="lineNoCov">          0 :         gf_service_download_del((GF_DownloadSession *)session);</span></a>
<span class="lineNum">     616 </span><span class="lineNoCov">          0 : }</span>
<span class="lineNum">     617 </span>            : void mpdin_dash_io_abort(GF_DASHFileIO *dashio, GF_DASHFileIOSession session)
<span class="lineNum">     618 </span>            : {
<a name="619"><span class="lineNum">     619 </span><span class="lineNoCov">          0 :         gf_dm_sess_abort((GF_DownloadSession *)session);</span></a>
<span class="lineNum">     620 </span><span class="lineNoCov">          0 : }</span>
<span class="lineNum">     621 </span>            : GF_Err mpdin_dash_io_setup_from_url(GF_DASHFileIO *dashio, GF_DASHFileIOSession session, const char *url, s32 group_idx)
<span class="lineNum">     622 </span>            : {
<span class="lineNum">     623 </span><span class="lineNoCov">          0 :         if (group_idx&gt;=0) {</span>
<span class="lineNum">     624 </span><span class="lineNoCov">          0 :                 GF_MPD_In *mpdin = (GF_MPD_In *)dashio-&gt;udta;</span>
<span class="lineNum">     625 </span><span class="lineNoCov">          0 :                 GF_MPDGroup *group = gf_dash_get_group_udta(mpdin-&gt;dash, group_idx);</span>
<span class="lineNum">     626 </span><span class="lineNoCov">          0 :                 if (group &amp;&amp; !group-&gt;netio_assigned) {</span>
<span class="lineNum">     627 </span><span class="lineNoCov">          0 :                         group-&gt;netio_assigned = GF_TRUE;</span>
<span class="lineNum">     628 </span><span class="lineNoCov">          0 :                         group-&gt;sess = (GF_DownloadSession *)session;</span>
<span class="lineNum">     629 </span><span class="lineNoCov">          0 :                         gf_dm_sess_reassign((GF_DownloadSession *)session, 0xFFFFFFFF, mpdin_dash_segment_netio, group);</span>
<span class="lineNum">     630 </span><span class="lineNoCov">          0 :                 }</span>
<span class="lineNum">     631 </span>            :         }
<a name="632"><span class="lineNum">     632 </span><span class="lineNoCov">          0 :         return gf_dm_sess_setup_from_url((GF_DownloadSession *)session, url);</span></a>
<span class="lineNum">     633 </span>            : }
<span class="lineNum">     634 </span>            : GF_Err mpdin_dash_io_set_range(GF_DASHFileIO *dashio, GF_DASHFileIOSession session, u64 start_range, u64 end_range, Bool discontinue_cache)
<span class="lineNum">     635 </span>            : {
<a name="636"><span class="lineNum">     636 </span><span class="lineNoCov">          0 :         return gf_dm_sess_set_range((GF_DownloadSession *)session, start_range, end_range, discontinue_cache);</span></a>
<span class="lineNum">     637 </span>            : }
<span class="lineNum">     638 </span>            : GF_Err mpdin_dash_io_init(GF_DASHFileIO *dashio, GF_DASHFileIOSession session)
<span class="lineNum">     639 </span>            : {
<a name="640"><span class="lineNum">     640 </span><span class="lineNoCov">          0 :         return gf_dm_sess_process_headers((GF_DownloadSession *)session);</span></a>
<span class="lineNum">     641 </span>            : }
<span class="lineNum">     642 </span>            : GF_Err mpdin_dash_io_run(GF_DASHFileIO *dashio, GF_DASHFileIOSession session)
<span class="lineNum">     643 </span>            : {
<a name="644"><span class="lineNum">     644 </span><span class="lineNoCov">          0 :         return gf_dm_sess_process((GF_DownloadSession *)session);</span></a>
<span class="lineNum">     645 </span>            : }
<span class="lineNum">     646 </span>            : const char *mpdin_dash_io_get_url(GF_DASHFileIO *dashio, GF_DASHFileIOSession session)
<span class="lineNum">     647 </span>            : {
<a name="648"><span class="lineNum">     648 </span><span class="lineNoCov">          0 :         return gf_dm_sess_get_resource_name((GF_DownloadSession *)session);</span></a>
<span class="lineNum">     649 </span>            : }
<span class="lineNum">     650 </span>            : const char *mpdin_dash_io_get_cache_name(GF_DASHFileIO *dashio, GF_DASHFileIOSession session)
<span class="lineNum">     651 </span>            : {
<a name="652"><span class="lineNum">     652 </span><span class="lineNoCov">          0 :         return gf_dm_sess_get_cache_name((GF_DownloadSession *)session);</span></a>
<span class="lineNum">     653 </span>            : }
<span class="lineNum">     654 </span>            : const char *mpdin_dash_io_get_mime(GF_DASHFileIO *dashio, GF_DASHFileIOSession session)
<span class="lineNum">     655 </span>            : {
<span class="lineNum">     656 </span><span class="lineNoCov">          0 :         return gf_dm_sess_mime_type((GF_DownloadSession *)session);</span>
<a name="657"><span class="lineNum">     657 </span>            : }</a>
<span class="lineNum">     658 </span>            : 
<span class="lineNum">     659 </span>            : const char *mpdin_dash_io_get_header_value(GF_DASHFileIO *dashio, GF_DASHFileIOSession session, const char *header_name)
<span class="lineNum">     660 </span>            : {
<span class="lineNum">     661 </span><span class="lineNoCov">          0 :         return gf_dm_sess_get_header((GF_DownloadSession *)session, header_name);</span>
<a name="662"><span class="lineNum">     662 </span>            : }</a>
<span class="lineNum">     663 </span>            : 
<span class="lineNum">     664 </span>            : u64 mpdin_dash_io_get_utc_start_time(GF_DASHFileIO *dashio, GF_DASHFileIOSession session)
<span class="lineNum">     665 </span>            : {
<span class="lineNum">     666 </span><span class="lineNoCov">          0 :         return gf_dm_sess_get_utc_start((GF_DownloadSession *)session);</span>
<span class="lineNum">     667 </span>            : }
<span class="lineNum">     668 </span>            : 
<a name="669"><span class="lineNum">     669 </span>            : </a>
<span class="lineNum">     670 </span>            : 
<span class="lineNum">     671 </span>            : u32 mpdin_dash_io_get_bytes_per_sec(GF_DASHFileIO *dashio, GF_DASHFileIOSession session)
<span class="lineNum">     672 </span>            : {
<span class="lineNum">     673 </span><span class="lineNoCov">          0 :         u32 bps=0;</span>
<span class="lineNum">     674 </span>            : //      GF_DownloadSession *sess = (GF_DownloadSession *)session;
<span class="lineNum">     675 </span><span class="lineNoCov">          0 :         if (session) {</span>
<span class="lineNum">     676 </span><span class="lineNoCov">          0 :                 gf_dm_sess_get_stats((GF_DownloadSession *)session, NULL, NULL, NULL, NULL, &amp;bps, NULL);</span>
<span class="lineNum">     677 </span><span class="lineNoCov">          0 :         } else {</span>
<span class="lineNum">     678 </span><span class="lineNoCov">          0 :                 GF_MPD_In *mpdin = (GF_MPD_In *)dashio-&gt;udta;</span>
<span class="lineNum">     679 </span><span class="lineNoCov">          0 :                 bps = gf_dm_get_data_rate(mpdin-&gt;service-&gt;term-&gt;downloader);</span>
<span class="lineNum">     680 </span><span class="lineNoCov">          0 :                 bps/=8;</span>
<span class="lineNum">     681 </span>            :         }
<a name="682"><span class="lineNum">     682 </span><span class="lineNoCov">          0 :         return bps;</span></a>
<span class="lineNum">     683 </span>            : }
<span class="lineNum">     684 </span>            : u32 mpdin_dash_io_get_total_size(GF_DASHFileIO *dashio, GF_DASHFileIOSession session)
<span class="lineNum">     685 </span>            : {
<span class="lineNum">     686 </span><span class="lineNoCov">          0 :         u32 size=0;</span>
<span class="lineNum">     687 </span>            : //      GF_DownloadSession *sess = (GF_DownloadSession *)session;
<span class="lineNum">     688 </span><span class="lineNoCov">          0 :         gf_dm_sess_get_stats((GF_DownloadSession *)session, NULL, NULL, &amp;size, NULL, NULL, NULL);</span>
<a name="689"><span class="lineNum">     689 </span><span class="lineNoCov">          0 :         return size;</span></a>
<span class="lineNum">     690 </span>            : }
<span class="lineNum">     691 </span>            : u32 mpdin_dash_io_get_bytes_done(GF_DASHFileIO *dashio, GF_DASHFileIOSession session)
<span class="lineNum">     692 </span>            : {
<span class="lineNum">     693 </span><span class="lineNoCov">          0 :         u32 size=0;</span>
<span class="lineNum">     694 </span>            : //      GF_DownloadSession *sess = (GF_DownloadSession *)session;
<span class="lineNum">     695 </span><span class="lineNoCov">          0 :         gf_dm_sess_get_stats((GF_DownloadSession *)session, NULL, NULL, NULL, &amp;size, NULL, NULL);</span>
<span class="lineNum">     696 </span><span class="lineNoCov">          0 :         return size;</span>
<span class="lineNum">     697 </span>            : }
<a name="698"><span class="lineNum">     698 </span>            : </a>
<span class="lineNum">     699 </span>            : 
<span class="lineNum">     700 </span>            : GF_Err mpdin_dash_io_on_dash_event(GF_DASHFileIO *dashio, GF_DASHEventType dash_evt, s32 group_idx, GF_Err error_code)
<span class="lineNum">     701 </span>            : {
<span class="lineNum">     702 </span>            :         GF_Err e;
<span class="lineNum">     703 </span>            :         u32 i;
<span class="lineNum">     704 </span><span class="lineNoCov">          0 :         GF_MPD_In *mpdin = (GF_MPD_In *)dashio-&gt;udta;</span>
<span class="lineNum">     705 </span>            : 
<span class="lineNum">     706 </span><span class="lineNoCov">          0 :         if (dash_evt==GF_DASH_EVENT_PERIOD_SETUP_ERROR) {</span>
<span class="lineNum">     707 </span><span class="lineNoCov">          0 :                 if (!mpdin-&gt;connection_ack_sent) {</span>
<span class="lineNum">     708 </span><span class="lineNoCov">          0 :                         mpdin-&gt;fn_connect_ack(mpdin-&gt;service, NULL, error_code);</span>
<span class="lineNum">     709 </span><span class="lineNoCov">          0 :                         mpdin-&gt;connection_ack_sent= GF_TRUE;</span>
<span class="lineNum">     710 </span><span class="lineNoCov">          0 :                 }</span>
<span class="lineNum">     711 </span><span class="lineNoCov">          0 :                 return GF_OK;</span>
<span class="lineNum">     712 </span>            :         }
<span class="lineNum">     713 </span>            : 
<span class="lineNum">     714 </span><span class="lineNoCov">          0 :         if (dash_evt==GF_DASH_EVENT_SELECT_GROUPS) {</span>
<span class="lineNum">     715 </span>            :                 const char *opt;
<span class="lineNum">     716 </span>            :                 //configure buffer in dynamic mode without low latency: we indicate how much the player will buffer
<span class="lineNum">     717 </span><span class="lineNoCov">          0 :                 if (gf_dash_is_dynamic_mpd(mpdin-&gt;dash) &amp;&amp; !mpdin-&gt;use_low_latency) {</span>
<span class="lineNum">     718 </span>            :                         u32 buffer_ms = 0;
<span class="lineNum">     719 </span><span class="lineNoCov">          0 :                         const char *opt = gf_modules_get_option((GF_BaseInterface *)mpdin-&gt;plug, &quot;Network&quot;, &quot;BufferLength&quot;);</span>
<span class="lineNum">     720 </span><span class="lineNoCov">          0 :                         if (opt) buffer_ms = atoi(opt);</span>
<span class="lineNum">     721 </span>            : 
<span class="lineNum">     722 </span>            :                         //use min buffer from MPD
<span class="lineNum">     723 </span><span class="lineNoCov">          0 :                         if (mpdin-&gt;buffer_mode&gt;=MPDIN_BUFFER_MIN) {</span>
<span class="lineNum">     724 </span><span class="lineNoCov">          0 :                                 u32 mpd_buffer_ms = gf_dash_get_min_buffer_time(mpdin-&gt;dash);</span>
<span class="lineNum">     725 </span><span class="lineNoCov">          0 :                                 if (mpd_buffer_ms &gt; buffer_ms)</span>
<span class="lineNum">     726 </span><span class="lineNoCov">          0 :                                         buffer_ms = mpd_buffer_ms;</span>
<span class="lineNum">     727 </span>            :                         }
<span class="lineNum">     728 </span>            : 
<span class="lineNum">     729 </span><span class="lineNoCov">          0 :                         if (buffer_ms) {</span>
<span class="lineNum">     730 </span><span class="lineNoCov">          0 :                                 gf_dash_set_user_buffer(mpdin-&gt;dash, buffer_ms);</span>
<span class="lineNum">     731 </span><span class="lineNoCov">          0 :                         }</span>
<span class="lineNum">     732 </span>            :                 }
<span class="lineNum">     733 </span>            :                 //let the player decide which group to play: we declare everything
<span class="lineNum">     734 </span>            : 
<span class="lineNum">     735 </span>            :                 //however select the default languague
<span class="lineNum">     736 </span><span class="lineNoCov">          0 :                 opt = gf_modules_get_option((GF_BaseInterface *)mpdin-&gt;plug, &quot;Systems&quot;, &quot;LanguageName&quot;);</span>
<span class="lineNum">     737 </span><span class="lineNoCov">          0 :                 if (opt)</span>
<span class="lineNum">     738 </span><span class="lineNoCov">          0 :                         gf_dash_groups_set_language(mpdin-&gt;dash, opt);</span>
<span class="lineNum">     739 </span>            : 
<span class="lineNum">     740 </span><span class="lineNoCov">          0 :                 return GF_OK;</span>
<span class="lineNum">     741 </span>            :         }
<span class="lineNum">     742 </span>            : 
<span class="lineNum">     743 </span>            :         /*for all selected groups, create input service and connect to init/first segment*/
<span class="lineNum">     744 </span><span class="lineNoCov">          0 :         if (dash_evt==GF_DASH_EVENT_CREATE_PLAYBACK) {</span>
<span class="lineNum">     745 </span>            :                 /*select input services if possible*/
<span class="lineNum">     746 </span><span class="lineNoCov">          0 :                 for (i=0; i&lt;gf_dash_get_group_count(mpdin-&gt;dash); i++) {</span>
<span class="lineNum">     747 </span>            :                         const char *mime, *init_segment;
<span class="lineNum">     748 </span>            :                         u32 j;
<span class="lineNum">     749 </span>            :                         Bool playable = GF_TRUE;
<span class="lineNum">     750 </span>            :                         //let the player decide which group to play
<span class="lineNum">     751 </span><span class="lineNoCov">          0 :                         if (!gf_dash_is_group_selectable(mpdin-&gt;dash, i))</span>
<span class="lineNum">     752 </span>            :                                 continue;
<span class="lineNum">     753 </span>            : 
<span class="lineNum">     754 </span>            :                         j=0;
<span class="lineNum">     755 </span><span class="lineNoCov">          0 :                         while (1) {</span>
<span class="lineNum">     756 </span>            :                                 const char *desc_id, *desc_scheme, *desc_value;
<span class="lineNum">     757 </span><span class="lineNoCov">          0 :                                 if (! gf_dash_group_enum_descriptor(mpdin-&gt;dash, i, GF_MPD_DESC_ESSENTIAL_PROPERTIES, j, &amp;desc_id, &amp;desc_scheme, &amp;desc_value))</span>
<span class="lineNum">     758 </span>            :                                         break;
<span class="lineNum">     759 </span><span class="lineNoCov">          0 :                                 j++;</span>
<span class="lineNum">     760 </span><span class="lineNoCov">          0 :                                 if (!strcmp(desc_scheme, &quot;urn:mpeg:dash:srd:2014&quot;)) {</span>
<span class="lineNum">     761 </span>            :                                 } else {
<span class="lineNum">     762 </span>            :                                         playable = GF_FALSE;
<span class="lineNum">     763 </span><span class="lineNoCov">          0 :                                         break;</span>
<span class="lineNum">     764 </span>            :                                 }
<span class="lineNum">     765 </span>            :                         }
<span class="lineNum">     766 </span><span class="lineNoCov">          0 :                         if (!playable) {</span>
<span class="lineNum">     767 </span><span class="lineNoCov">          0 :                                 gf_dash_group_select(mpdin-&gt;dash, i, GF_FALSE);</span>
<span class="lineNum">     768 </span><span class="lineNoCov">          0 :                                 continue;</span>
<span class="lineNum">     769 </span>            :                         }
<span class="lineNum">     770 </span>            : 
<span class="lineNum">     771 </span><span class="lineNoCov">          0 :                         if (gf_dash_group_has_dependent_group(mpdin-&gt;dash, i) &gt;=0 ) {</span>
<span class="lineNum">     772 </span><span class="lineNoCov">          0 :                                 gf_dash_group_select(mpdin-&gt;dash, i, GF_TRUE);</span>
<span class="lineNum">     773 </span><span class="lineNoCov">          0 :                                 continue;</span>
<span class="lineNum">     774 </span>            :                         }
<span class="lineNum">     775 </span>            : 
<span class="lineNum">     776 </span><span class="lineNoCov">          0 :                         mime = gf_dash_group_get_segment_mime(mpdin-&gt;dash, i);</span>
<span class="lineNum">     777 </span><span class="lineNoCov">          0 :                         init_segment = gf_dash_group_get_segment_init_url(mpdin-&gt;dash, i, NULL, NULL);</span>
<span class="lineNum">     778 </span><span class="lineNoCov">          0 :                         e = MPD_LoadMediaService(mpdin, i, mime, init_segment);</span>
<span class="lineNum">     779 </span><span class="lineNoCov">          0 :                         if (e != GF_OK) {</span>
<span class="lineNum">     780 </span><span class="lineNoCov">          0 :                                 gf_dash_group_select(mpdin-&gt;dash, i, GF_FALSE);</span>
<span class="lineNum">     781 </span><span class="lineNoCov">          0 :                         } else {</span>
<span class="lineNum">     782 </span>            :                                 u32 w, h;
<span class="lineNum">     783 </span>            :                                 /*connect our media service*/
<span class="lineNum">     784 </span><span class="lineNoCov">          0 :                                 GF_MPDGroup *group = gf_dash_get_group_udta(mpdin-&gt;dash, i);</span>
<span class="lineNum">     785 </span><span class="lineNoCov">          0 :                                 gf_dash_group_get_video_info(mpdin-&gt;dash, i, &amp;w, &amp;h);</span>
<span class="lineNum">     786 </span><span class="lineNoCov">          0 :                                 if (w &amp;&amp; h &amp;&amp; w&gt;mpdin-&gt;width &amp;&amp; h&gt;mpdin-&gt;height) {</span>
<span class="lineNum">     787 </span><span class="lineNoCov">          0 :                                         mpdin-&gt;width = w;</span>
<span class="lineNum">     788 </span><span class="lineNoCov">          0 :                                         mpdin-&gt;height = h;</span>
<span class="lineNum">     789 </span><span class="lineNoCov">          0 :                                 }</span>
<span class="lineNum">     790 </span><span class="lineNoCov">          0 :                                 if (gf_dash_group_get_srd_max_size_info(mpdin-&gt;dash, i, &amp;w, &amp;h)) {</span>
<span class="lineNum">     791 </span><span class="lineNoCov">          0 :                                         mpdin-&gt;width = w;</span>
<span class="lineNum">     792 </span><span class="lineNoCov">          0 :                                         mpdin-&gt;height = h;</span>
<span class="lineNum">     793 </span><span class="lineNoCov">          0 :                                 }</span>
<span class="lineNum">     794 </span>            : 
<span class="lineNum">     795 </span><span class="lineNoCov">          0 :                                 e = group-&gt;segment_ifce-&gt;ConnectService(group-&gt;segment_ifce, mpdin-&gt;service, init_segment);</span>
<span class="lineNum">     796 </span><span class="lineNoCov">          0 :                                 if (e) {</span>
<span class="lineNum">     797 </span><span class="lineNoCov">          0 :                                         GF_LOG(GF_LOG_WARNING, GF_LOG_DASH, (&quot;[MPD_IN] Unable to connect input service to %s\n&quot;, init_segment));</span>
<span class="lineNum">     798 </span><span class="lineNoCov">          0 :                                         gf_dash_group_select(mpdin-&gt;dash, i, GF_FALSE);</span>
<span class="lineNum">     799 </span><span class="lineNoCov">          0 :                                 } else {</span>
<span class="lineNum">     800 </span><span class="lineNoCov">          0 :                                         group-&gt;service_connected = 1;</span>
<span class="lineNum">     801 </span>            :                                 }
<span class="lineNum">     802 </span><span class="lineNoCov">          0 :                                 if (mpdin-&gt;closed) return GF_OK;</span>
<span class="lineNum">     803 </span>            :                         }
<span class="lineNum">     804 </span>            :                 }
<span class="lineNum">     805 </span>            : 
<span class="lineNum">     806 </span><span class="lineNoCov">          0 :                 if (!mpdin-&gt;connection_ack_sent) {</span>
<span class="lineNum">     807 </span><span class="lineNoCov">          0 :                         mpdin-&gt;fn_connect_ack(mpdin-&gt;service, NULL, GF_OK);</span>
<span class="lineNum">     808 </span><span class="lineNoCov">          0 :                         mpdin-&gt;connection_ack_sent=1;</span>
<span class="lineNum">     809 </span><span class="lineNoCov">          0 :                 }</span>
<span class="lineNum">     810 </span>            : 
<span class="lineNum">     811 </span>            :                 //we had a seek outside of the period we were setting up, during period setup !
<span class="lineNum">     812 </span>            :                 //request the seek again from the player
<span class="lineNum">     813 </span><span class="lineNoCov">          0 :                 if (mpdin-&gt;seek_request&gt;=0) {</span>
<span class="lineNum">     814 </span><span class="lineNoCov">          0 :                         GF_NetworkCommand com;</span>
<span class="lineNum">     815 </span><span class="lineNoCov">          0 :                         memset(&amp;com, 0, sizeof(GF_NetworkCommand));</span>
<span class="lineNum">     816 </span><span class="lineNoCov">          0 :                         com.command_type = GF_NET_SERVICE_SEEK;</span>
<span class="lineNum">     817 </span><span class="lineNoCov">          0 :                         com.play.start_range = mpdin-&gt;seek_request;</span>
<span class="lineNum">     818 </span><span class="lineNoCov">          0 :                         mpdin-&gt;seek_request = 0;</span>
<span class="lineNum">     819 </span><span class="lineNoCov">          0 :                         gf_service_command(mpdin-&gt;service, &amp;com, GF_OK);</span>
<span class="lineNum">     820 </span><span class="lineNoCov">          0 :                 }</span>
<span class="lineNum">     821 </span><span class="lineNoCov">          0 :                 return GF_OK;</span>
<span class="lineNum">     822 </span>            :         }
<span class="lineNum">     823 </span>            : 
<span class="lineNum">     824 </span>            :         /*for all running services, stop service*/
<span class="lineNum">     825 </span><span class="lineNoCov">          0 :         if (dash_evt==GF_DASH_EVENT_DESTROY_PLAYBACK) {</span>
<span class="lineNum">     826 </span>            : 
<span class="lineNum">     827 </span><span class="lineNoCov">          0 :                 mpdin-&gt;service-&gt;subservice_disconnect = 1;</span>
<span class="lineNum">     828 </span><span class="lineNoCov">          0 :                 gf_service_disconnect_ack(mpdin-&gt;service, NULL, GF_OK);</span>
<span class="lineNum">     829 </span><span class="lineNoCov">          0 :                 mpdin-&gt;service-&gt;subservice_disconnect = 2;</span>
<span class="lineNum">     830 </span>            : 
<span class="lineNum">     831 </span><span class="lineNoCov">          0 :                 for (i=0; i&lt;gf_dash_get_group_count(mpdin-&gt;dash); i++) {</span>
<span class="lineNum">     832 </span><span class="lineNoCov">          0 :                         GF_MPDGroup *group = gf_dash_get_group_udta(mpdin-&gt;dash, i);</span>
<span class="lineNum">     833 </span><span class="lineNoCov">          0 :                         if (!group) continue;</span>
<span class="lineNum">     834 </span><span class="lineNoCov">          0 :                         if (group-&gt;segment_ifce) {</span>
<span class="lineNum">     835 </span><span class="lineNoCov">          0 :                                 if (group-&gt;service_connected) {</span>
<span class="lineNum">     836 </span><span class="lineNoCov">          0 :                                         group-&gt;segment_ifce-&gt;CloseService(group-&gt;segment_ifce);</span>
<span class="lineNum">     837 </span><span class="lineNoCov">          0 :                                         group-&gt;service_connected = 0;</span>
<span class="lineNum">     838 </span><span class="lineNoCov">          0 :                                 }</span>
<span class="lineNum">     839 </span><span class="lineNoCov">          0 :                                 gf_modules_close_interface((GF_BaseInterface *) group-&gt;segment_ifce);</span>
<span class="lineNum">     840 </span><span class="lineNoCov">          0 :                         }</span>
<span class="lineNum">     841 </span><span class="lineNoCov">          0 :                         gf_free(group);</span>
<span class="lineNum">     842 </span><span class="lineNoCov">          0 :                         gf_dash_set_group_udta(mpdin-&gt;dash, i, NULL);</span>
<span class="lineNum">     843 </span><span class="lineNoCov">          0 :                 }</span>
<span class="lineNum">     844 </span><span class="lineNoCov">          0 :                 mpdin-&gt;service-&gt;subservice_disconnect = 0;</span>
<span class="lineNum">     845 </span><span class="lineNoCov">          0 :                 return GF_OK;</span>
<span class="lineNum">     846 </span>            :         }
<span class="lineNum">     847 </span>            : 
<span class="lineNum">     848 </span><span class="lineNoCov">          0 :         if (dash_evt==GF_DASH_EVENT_BUFFERING) {</span>
<span class="lineNum">     849 </span>            :                 u32 tot, done;
<span class="lineNum">     850 </span><span class="lineNoCov">          0 :                 gf_dash_get_buffer_info(mpdin-&gt;dash, &amp;tot, &amp;done);</span>
<span class="lineNum">     851 </span><span class="lineNoCov">          0 :                 return GF_OK;</span>
<span class="lineNum">     852 </span>            :         }
<span class="lineNum">     853 </span><span class="lineNoCov">          0 :         if (dash_evt==GF_DASH_EVENT_SEGMENT_AVAILABLE) {</span>
<span class="lineNum">     854 </span><span class="lineNoCov">          0 :                 if (group_idx&gt;=0) {</span>
<span class="lineNum">     855 </span><span class="lineNoCov">          0 :                         GF_MPDGroup *group = gf_dash_get_group_udta(mpdin-&gt;dash, group_idx);</span>
<span class="lineNum">     856 </span><span class="lineNoCov">          0 :                         if (group) MPD_NotifyData(group, 0);</span>
<span class="lineNum">     857 </span>            :                 }
<span class="lineNum">     858 </span><span class="lineNoCov">          0 :                 return GF_OK;</span>
<span class="lineNum">     859 </span>            :         }
<span class="lineNum">     860 </span><span class="lineNoCov">          0 :         if (dash_evt==GF_DASH_EVENT_QUALITY_SWITCH) {</span>
<span class="lineNum">     861 </span><span class="lineNoCov">          0 :                 if (group_idx&gt;=0) {</span>
<span class="lineNum">     862 </span><span class="lineNoCov">          0 :                         GF_MPDGroup *group = gf_dash_get_group_udta(mpdin-&gt;dash, group_idx);</span>
<span class="lineNum">     863 </span><span class="lineNoCov">          0 :                         if (!group) {</span>
<span class="lineNum">     864 </span><span class="lineNoCov">          0 :                                 group_idx = gf_dash_group_has_dependent_group(mpdin-&gt;dash, group_idx);</span>
<span class="lineNum">     865 </span><span class="lineNoCov">          0 :                                 group = gf_dash_get_group_udta(mpdin-&gt;dash, group_idx);</span>
<span class="lineNum">     866 </span><span class="lineNoCov">          0 :                         }</span>
<span class="lineNum">     867 </span><span class="lineNoCov">          0 :                         if (group) {</span>
<span class="lineNum">     868 </span><span class="lineNoCov">          0 :                                 GF_NetworkCommand com;</span>
<span class="lineNum">     869 </span><span class="lineNoCov">          0 :                                 memset(&amp;com, 0, sizeof(GF_NetworkCommand));</span>
<span class="lineNum">     870 </span>            : 
<span class="lineNum">     871 </span><span class="lineNoCov">          0 :                                 com.command_type = GF_NET_SERVICE_EVENT;</span>
<span class="lineNum">     872 </span><span class="lineNoCov">          0 :                                 com.send_event.evt.type = GF_EVENT_QUALITY_SWITCHED;</span>
<span class="lineNum">     873 </span><span class="lineNoCov">          0 :                                 gf_service_command(mpdin-&gt;service, &amp;com, GF_OK);</span>
<span class="lineNum">     874 </span><span class="lineNoCov">          0 :                         }</span>
<span class="lineNum">     875 </span>            :                 }
<span class="lineNum">     876 </span><span class="lineNoCov">          0 :                 return GF_OK;</span>
<span class="lineNum">     877 </span>            :         }
<span class="lineNum">     878 </span><span class="lineNoCov">          0 :         if (dash_evt==GF_DASH_EVENT_TIMESHIFT_OVERFLOW) {</span>
<span class="lineNum">     879 </span><span class="lineNoCov">          0 :                 GF_NetworkCommand com;</span>
<span class="lineNum">     880 </span><span class="lineNoCov">          0 :                 com.command_type = GF_NET_SERVICE_EVENT;</span>
<span class="lineNum">     881 </span><span class="lineNoCov">          0 :                 com.send_event.evt.type = (group_idx&gt;=0) ? GF_EVENT_TIMESHIFT_OVERFLOW : GF_EVENT_TIMESHIFT_UNDERRUN;</span>
<span class="lineNum">     882 </span><span class="lineNoCov">          0 :                 gf_service_command(mpdin-&gt;service, &amp;com, GF_OK);</span>
<span class="lineNum">     883 </span><span class="lineNoCov">          0 :         }</span>
<span class="lineNum">     884 </span><span class="lineNoCov">          0 :         if (dash_evt==GF_DASH_EVENT_TIMESHIFT_UPDATE) {</span>
<span class="lineNum">     885 </span><span class="lineNoCov">          0 :                 GF_NetworkCommand com;</span>
<span class="lineNum">     886 </span><span class="lineNoCov">          0 :                 com.command_type = GF_NET_SERVICE_EVENT;</span>
<span class="lineNum">     887 </span><span class="lineNoCov">          0 :                 com.send_event.evt.type = GF_EVENT_TIMESHIFT_UPDATE;</span>
<span class="lineNum">     888 </span><span class="lineNoCov">          0 :                 gf_service_command(mpdin-&gt;service, &amp;com, GF_OK);</span>
<span class="lineNum">     889 </span><span class="lineNoCov">          0 :         }</span>
<span class="lineNum">     890 </span>            : 
<span class="lineNum">     891 </span><span class="lineNoCov">          0 :         if (dash_evt==GF_DASH_EVENT_CODEC_STAT_QUERY) {</span>
<span class="lineNum">     892 </span><span class="lineNoCov">          0 :                 GF_NetworkCommand com;</span>
<span class="lineNum">     893 </span><span class="lineNoCov">          0 :                 memset(&amp;com, 0, sizeof(GF_NetworkCommand));</span>
<span class="lineNum">     894 </span><span class="lineNoCov">          0 :                 com.command_type = GF_NET_SERVICE_CODEC_STAT_QUERY;</span>
<span class="lineNum">     895 </span><span class="lineNoCov">          0 :                 gf_service_command(mpdin-&gt;service, &amp;com, GF_OK);</span>
<span class="lineNum">     896 </span><span class="lineNoCov">          0 :                 gf_dash_set_codec_stat(mpdin-&gt;dash, group_idx, com.codec_stat.avg_dec_time, com.codec_stat.max_dec_time, com.codec_stat.irap_avg_dec_time, com.codec_stat.irap_max_dec_time, com.codec_stat.codec_reset, com.codec_stat.decode_only_rap);</span>
<span class="lineNum">     897 </span>            : 
<span class="lineNum">     898 </span><span class="lineNoCov">          0 :                 if (mpdin-&gt;buffer_adaptation) {</span>
<span class="lineNum">     899 </span><span class="lineNoCov">          0 :                         memset(&amp;com, 0, sizeof(GF_NetworkCommand));</span>
<span class="lineNum">     900 </span><span class="lineNoCov">          0 :                         com.command_type = GF_NET_BUFFER_QUERY;</span>
<span class="lineNum">     901 </span><span class="lineNoCov">          0 :                         gf_service_command(mpdin-&gt;service, &amp;com, GF_OK);</span>
<span class="lineNum">     902 </span><span class="lineNoCov">          0 :                         gf_dash_set_buffer_levels(mpdin-&gt;dash, group_idx, com.buffer.min, com.buffer.max, com.buffer.occupancy);</span>
<span class="lineNum">     903 </span><span class="lineNoCov">          0 :                 }</span>
<span class="lineNum">     904 </span><span class="lineNoCov">          0 :         }</span>
<span class="lineNum">     905 </span>            : 
<span class="lineNum">     906 </span><span class="lineNoCov">          0 :         return GF_OK;</span>
<span class="lineNum">     907 </span><span class="lineNoCov">          0 : }</span>
<a name="908"><span class="lineNum">     908 </span>            : </a>
<span class="lineNum">     909 </span>            : /*check in all groups if the service can support reverse playback (speed&lt;0); return GF_OK only if service is supported in all groups*/
<span class="lineNum">     910 </span>            : static GF_Err mpdin_dash_can_reverse_playback(GF_MPD_In *mpdin)
<span class="lineNum">     911 </span>            : {
<span class="lineNum">     912 </span>            :         u32 i;
<span class="lineNum">     913 </span>            :         GF_Err e = GF_NOT_SUPPORTED;
<span class="lineNum">     914 </span><span class="lineNoCov">          0 :         for (i=0; i&lt;gf_dash_get_group_count(mpdin-&gt;dash); i++) {</span>
<span class="lineNum">     915 </span><span class="lineNoCov">          0 :                 if (gf_dash_is_group_selectable(mpdin-&gt;dash, i)) {</span>
<span class="lineNum">     916 </span><span class="lineNoCov">          0 :                         GF_MPDGroup *mudta = gf_dash_get_group_udta(mpdin-&gt;dash, i);</span>
<span class="lineNum">     917 </span><span class="lineNoCov">          0 :                         if (mudta &amp;&amp; mudta-&gt;segment_ifce) {</span>
<span class="lineNum">     918 </span><span class="lineNoCov">          0 :                                 GF_NetworkCommand com;</span>
<span class="lineNum">     919 </span><span class="lineNoCov">          0 :                                 com.command_type = GF_NET_SERVICE_CAN_REVERSE_PLAYBACK;</span>
<span class="lineNum">     920 </span><span class="lineNoCov">          0 :                                 e = mudta-&gt;segment_ifce-&gt;ServiceCommand(mudta-&gt;segment_ifce, &amp;com);</span>
<span class="lineNum">     921 </span><span class="lineNoCov">          0 :                                 if (GF_OK != e)</span>
<span class="lineNum">     922 </span><span class="lineNoCov">          0 :                                         return e;</span>
<span class="lineNum">     923 </span><span class="lineNoCov">          0 :                         }</span>
<span class="lineNum">     924 </span>            :                 }
<span class="lineNum">     925 </span>            :         }
<span class="lineNum">     926 </span>            : 
<span class="lineNum">     927 </span><span class="lineNoCov">          0 :         return e;</span>
<span class="lineNum">     928 </span><span class="lineNoCov">          0 : }</span>
<a name="929"><span class="lineNum">     929 </span>            : </a>
<span class="lineNum">     930 </span>            : 
<span class="lineNum">     931 </span>            : GF_Err MPD_ConnectService(GF_InputService *plug, GF_ClientService *serv, const char *url)
<span class="lineNum">     932 </span>            : {
<span class="lineNum">     933 </span><span class="lineNoCov">          0 :         GF_MPD_In *mpdin = (GF_MPD_In*) plug-&gt;priv;</span>
<span class="lineNum">     934 </span>            :         const char *opt;
<span class="lineNum">     935 </span>            :         GF_Err e;
<span class="lineNum">     936 </span>            :         s32 shift_utc_ms, debug_adaptation_set;
<span class="lineNum">     937 </span>            :         u32 max_cache_duration, auto_switch_count, init_timeshift, tiles_rate_decrease;
<span class="lineNum">     938 </span>            :         Bool use_server_utc;
<span class="lineNum">     939 </span>            :         GF_DASHInitialSelectionMode first_select_mode;
<span class="lineNum">     940 </span>            :         GF_DASHTileAdaptationMode tile_adapt_mode;
<span class="lineNum">     941 </span>            :         Bool keep_files, disable_switching, use_threads;
<span class="lineNum">     942 </span>            : 
<span class="lineNum">     943 </span><span class="lineNoCov">          0 :         GF_LOG(GF_LOG_DEBUG, GF_LOG_DASH, (&quot;[MPD_IN] Received Service Connection request (%p) from terminal for %s\n&quot;, serv, url));</span>
<span class="lineNum">     944 </span>            : 
<span class="lineNum">     945 </span><span class="lineNoCov">          0 :         if (!mpdin || !serv || !url)</span>
<span class="lineNum">     946 </span><span class="lineNoCov">          0 :                 return GF_BAD_PARAM;</span>
<span class="lineNum">     947 </span>            : 
<span class="lineNum">     948 </span><span class="lineNoCov">          0 :         mpdin-&gt;service = serv;</span>
<span class="lineNum">     949 </span><span class="lineNoCov">          0 :         mpdin-&gt;seek_request = -1;</span>
<span class="lineNum">     950 </span>            : 
<span class="lineNum">     951 </span><span class="lineNoCov">          0 :         mpdin-&gt;dash_io.udta = mpdin;</span>
<span class="lineNum">     952 </span><span class="lineNoCov">          0 :         mpdin-&gt;dash_io.delete_cache_file = mpdin_dash_io_delete_cache_file;</span>
<span class="lineNum">     953 </span><span class="lineNoCov">          0 :         mpdin-&gt;dash_io.create = mpdin_dash_io_create;</span>
<span class="lineNum">     954 </span><span class="lineNoCov">          0 :         mpdin-&gt;dash_io.del = mpdin_dash_io_del;</span>
<span class="lineNum">     955 </span><span class="lineNoCov">          0 :         mpdin-&gt;dash_io.abort = mpdin_dash_io_abort;</span>
<span class="lineNum">     956 </span><span class="lineNoCov">          0 :         mpdin-&gt;dash_io.setup_from_url = mpdin_dash_io_setup_from_url;</span>
<span class="lineNum">     957 </span><span class="lineNoCov">          0 :         mpdin-&gt;dash_io.set_range = mpdin_dash_io_set_range;</span>
<span class="lineNum">     958 </span><span class="lineNoCov">          0 :         mpdin-&gt;dash_io.init = mpdin_dash_io_init;</span>
<span class="lineNum">     959 </span><span class="lineNoCov">          0 :         mpdin-&gt;dash_io.run = mpdin_dash_io_run;</span>
<span class="lineNum">     960 </span><span class="lineNoCov">          0 :         mpdin-&gt;dash_io.get_url = mpdin_dash_io_get_url;</span>
<span class="lineNum">     961 </span><span class="lineNoCov">          0 :         mpdin-&gt;dash_io.get_cache_name = mpdin_dash_io_get_cache_name;</span>
<span class="lineNum">     962 </span><span class="lineNoCov">          0 :         mpdin-&gt;dash_io.get_mime = mpdin_dash_io_get_mime;</span>
<span class="lineNum">     963 </span><span class="lineNoCov">          0 :         mpdin-&gt;dash_io.get_header_value = mpdin_dash_io_get_header_value;</span>
<span class="lineNum">     964 </span><span class="lineNoCov">          0 :         mpdin-&gt;dash_io.get_utc_start_time = mpdin_dash_io_get_utc_start_time;</span>
<span class="lineNum">     965 </span><span class="lineNoCov">          0 :         mpdin-&gt;dash_io.get_bytes_per_sec = mpdin_dash_io_get_bytes_per_sec;</span>
<span class="lineNum">     966 </span><span class="lineNoCov">          0 :         mpdin-&gt;dash_io.get_total_size = mpdin_dash_io_get_total_size;</span>
<span class="lineNum">     967 </span><span class="lineNoCov">          0 :         mpdin-&gt;dash_io.get_bytes_done = mpdin_dash_io_get_bytes_done;</span>
<span class="lineNum">     968 </span><span class="lineNoCov">          0 :         mpdin-&gt;dash_io.on_dash_event = mpdin_dash_io_on_dash_event;</span>
<span class="lineNum">     969 </span>            : 
<span class="lineNum">     970 </span>            :         max_cache_duration = 0;
<span class="lineNum">     971 </span><span class="lineNoCov">          0 :         opt = gf_modules_get_option((GF_BaseInterface *)plug, &quot;Network&quot;, &quot;BufferLength&quot;);</span>
<span class="lineNum">     972 </span><span class="lineNoCov">          0 :         if (opt) max_cache_duration = atoi(opt);</span>
<span class="lineNum">     973 </span>            : 
<span class="lineNum">     974 </span>            :         auto_switch_count = 0;
<span class="lineNum">     975 </span><span class="lineNoCov">          0 :         opt = gf_modules_get_option((GF_BaseInterface *)plug, &quot;DASH&quot;, &quot;AutoSwitchCount&quot;);</span>
<span class="lineNum">     976 </span><span class="lineNoCov">          0 :         if (!opt) gf_modules_set_option((GF_BaseInterface *)plug, &quot;DASH&quot;, &quot;AutoSwitchCount&quot;, &quot;0&quot;);</span>
<span class="lineNum">     977 </span><span class="lineNoCov">          0 :         if (opt) auto_switch_count = atoi(opt);</span>
<span class="lineNum">     978 </span>            : 
<span class="lineNum">     979 </span>            :         keep_files = 0;
<span class="lineNum">     980 </span><span class="lineNoCov">          0 :         opt = gf_modules_get_option((GF_BaseInterface *)plug, &quot;DASH&quot;, &quot;KeepFiles&quot;);</span>
<span class="lineNum">     981 </span><span class="lineNoCov">          0 :         if (!opt) gf_modules_set_option((GF_BaseInterface *)plug, &quot;DASH&quot;, &quot;KeepFiles&quot;, &quot;no&quot;);</span>
<span class="lineNum">     982 </span><span class="lineNoCov">          0 :         if (opt &amp;&amp; !strcmp(opt, &quot;yes&quot;)) keep_files = 1;</span>
<span class="lineNum">     983 </span>            : 
<span class="lineNum">     984 </span>            :         disable_switching = 0;
<span class="lineNum">     985 </span><span class="lineNoCov">          0 :         opt = gf_modules_get_option((GF_BaseInterface *)plug, &quot;DASH&quot;, &quot;NetworkAdaptation&quot;);</span>
<span class="lineNum">     986 </span><span class="lineNoCov">          0 :         if (!opt) {</span>
<span class="lineNum">     987 </span>            :                 opt = &quot;buffer&quot;;
<span class="lineNum">     988 </span><span class="lineNoCov">          0 :                 gf_modules_set_option((GF_BaseInterface *)plug, &quot;DASH&quot;, &quot;NetworkAdaptation&quot;, opt);</span>
<span class="lineNum">     989 </span><span class="lineNoCov">          0 :         }</span>
<span class="lineNum">     990 </span><span class="lineNoCov">          0 :         if (!strcmp(opt, &quot;disabled&quot;)) disable_switching = 2;</span>
<span class="lineNum">     991 </span><span class="lineNoCov">          0 :         else if (!strcmp(opt, &quot;bandwidth&quot;)) mpdin-&gt;buffer_adaptation = GF_FALSE;</span>
<span class="lineNum">     992 </span><span class="lineNoCov">          0 :         else mpdin-&gt;buffer_adaptation = GF_TRUE;</span>
<span class="lineNum">     993 </span>            : 
<span class="lineNum">     994 </span><span class="lineNoCov">          0 :         opt = gf_modules_get_option((GF_BaseInterface *)plug, &quot;DASH&quot;, &quot;StartRepresentation&quot;);</span>
<span class="lineNum">     995 </span><span class="lineNoCov">          0 :         if (!opt) {</span>
<span class="lineNum">     996 </span><span class="lineNoCov">          0 :                 gf_modules_set_option((GF_BaseInterface *)plug, &quot;DASH&quot;, &quot;StartRepresentation&quot;, &quot;minBandwidth&quot;);</span>
<span class="lineNum">     997 </span>            :                 opt = &quot;minBandwidth&quot;;
<span class="lineNum">     998 </span><span class="lineNoCov">          0 :         }</span>
<span class="lineNum">     999 </span><span class="lineNoCov">          0 :         if (opt &amp;&amp; !strcmp(opt, &quot;maxBandwidth&quot;)) first_select_mode = GF_DASH_SELECT_BANDWIDTH_HIGHEST;</span>
<span class="lineNum">    1000 </span><span class="lineNoCov">          0 :         else if (opt &amp;&amp; !strcmp(opt, &quot;maxBandwidthTiles&quot;)) first_select_mode = GF_DASH_SELECT_BANDWIDTH_HIGHEST_TILES;</span>
<span class="lineNum">    1001 </span><span class="lineNoCov">          0 :         else if (opt &amp;&amp; !strcmp(opt, &quot;minQuality&quot;)) first_select_mode = GF_DASH_SELECT_QUALITY_LOWEST;</span>
<span class="lineNum">    1002 </span><span class="lineNoCov">          0 :         else if (opt &amp;&amp; !strcmp(opt, &quot;maxQuality&quot;)) first_select_mode = GF_DASH_SELECT_QUALITY_HIGHEST;</span>
<span class="lineNum">    1003 </span>            :         else first_select_mode = GF_DASH_SELECT_BANDWIDTH_LOWEST;
<span class="lineNum">    1004 </span>            : 
<span class="lineNum">    1005 </span><span class="lineNoCov">          0 :         opt = gf_modules_get_option((GF_BaseInterface *)plug, &quot;DASH&quot;, &quot;MemoryStorage&quot;);</span>
<span class="lineNum">    1006 </span><span class="lineNoCov">          0 :         if (!opt) gf_modules_set_option((GF_BaseInterface *)plug, &quot;DASH&quot;, &quot;MemoryStorage&quot;, &quot;yes&quot;);</span>
<span class="lineNum">    1007 </span><span class="lineNoCov">          0 :         mpdin-&gt;memory_storage = (opt &amp;&amp; !strcmp(opt, &quot;yes&quot;)) ? 1 : 0;</span>
<span class="lineNum">    1008 </span>            : 
<span class="lineNum">    1009 </span><span class="lineNoCov">          0 :         opt = gf_modules_get_option((GF_BaseInterface *)plug, &quot;DASH&quot;, &quot;UseMaxResolution&quot;);</span>
<span class="lineNum">    1010 </span><span class="lineNoCov">          0 :         if (!opt) {</span>
<span class="lineNum">    1011 </span>            :                 opt = &quot;yes&quot;;
<span class="lineNum">    1012 </span><span class="lineNoCov">          0 :                 gf_modules_set_option((GF_BaseInterface *)plug, &quot;DASH&quot;, &quot;UseMaxResolution&quot;, opt);</span>
<span class="lineNum">    1013 </span><span class="lineNoCov">          0 :         }</span>
<span class="lineNum">    1014 </span><span class="lineNoCov">          0 :         mpdin-&gt;use_max_res = !strcmp(opt, &quot;yes&quot;) ? 1 : 0;</span>
<span class="lineNum">    1015 </span>            : 
<span class="lineNum">    1016 </span><span class="lineNoCov">          0 :         opt = gf_modules_get_option((GF_BaseInterface *)plug, &quot;DASH&quot;, &quot;ImmediateSwitching&quot;);</span>
<span class="lineNum">    1017 </span><span class="lineNoCov">          0 :         if (!opt) gf_modules_set_option((GF_BaseInterface *)plug, &quot;DASH&quot;, &quot;ImmediateSwitching&quot;, &quot;no&quot;);</span>
<span class="lineNum">    1018 </span><span class="lineNoCov">          0 :         mpdin-&gt;immediate_switch = (opt &amp;&amp; !strcmp(opt, &quot;yes&quot;)) ? 1 : 0;</span>
<span class="lineNum">    1019 </span>            : 
<span class="lineNum">    1020 </span><span class="lineNoCov">          0 :         opt = gf_modules_get_option((GF_BaseInterface *)plug, &quot;DASH&quot;, &quot;BufferingMode&quot;);</span>
<span class="lineNum">    1021 </span><span class="lineNoCov">          0 :         if (!opt) gf_modules_set_option((GF_BaseInterface *)plug, &quot;DASH&quot;, &quot;BufferingMode&quot;, &quot;minBuffer&quot;);</span>
<span class="lineNum">    1022 </span>            : 
<span class="lineNum">    1023 </span><span class="lineNoCov">          0 :         if (opt &amp;&amp; !strcmp(opt, &quot;segments&quot;)) mpdin-&gt;buffer_mode = MPDIN_BUFFER_SEGMENTS;</span>
<span class="lineNum">    1024 </span><span class="lineNoCov">          0 :         else if (opt &amp;&amp; !strcmp(opt, &quot;none&quot;)) mpdin-&gt;buffer_mode = MPDIN_BUFFER_NONE;</span>
<span class="lineNum">    1025 </span><span class="lineNoCov">          0 :         else mpdin-&gt;buffer_mode = MPDIN_BUFFER_MIN;</span>
<span class="lineNum">    1026 </span>            :         
<span class="lineNum">    1027 </span><span class="lineNoCov">          0 :         opt = gf_modules_get_option((GF_BaseInterface *)plug, &quot;DASH&quot;, &quot;LowLatency&quot;);</span>
<span class="lineNum">    1028 </span><span class="lineNoCov">          0 :         if (!opt) gf_modules_set_option((GF_BaseInterface *)plug, &quot;DASH&quot;, &quot;LowLatency&quot;, &quot;no&quot;);</span>
<span class="lineNum">    1029 </span>            : 
<span class="lineNum">    1030 </span><span class="lineNoCov">          0 :         if (opt &amp;&amp; !strcmp(opt, &quot;chunk&quot;)) mpdin-&gt;use_low_latency = 1;</span>
<span class="lineNum">    1031 </span><span class="lineNoCov">          0 :         else if (opt &amp;&amp; !strcmp(opt, &quot;always&quot;)) mpdin-&gt;use_low_latency = 2;</span>
<span class="lineNum">    1032 </span><span class="lineNoCov">          0 :         else mpdin-&gt;use_low_latency = 0;</span>
<span class="lineNum">    1033 </span>            : 
<span class="lineNum">    1034 </span>            :         
<span class="lineNum">    1035 </span>            :         use_threads = GF_FALSE;
<span class="lineNum">    1036 </span><span class="lineNoCov">          0 :         opt = gf_modules_get_option((GF_BaseInterface *)plug, &quot;DASH&quot;, &quot;ThreadedDownload&quot;);</span>
<span class="lineNum">    1037 </span><span class="lineNoCov">          0 :         if (!opt) gf_modules_set_option((GF_BaseInterface *)plug, &quot;DASH&quot;, &quot;ThreadedDownload&quot;, &quot;no&quot;);</span>
<span class="lineNum">    1038 </span><span class="lineNoCov">          0 :         if (opt &amp;&amp; !strcmp(opt, &quot;yes&quot;)) use_threads = GF_TRUE;</span>
<span class="lineNum">    1039 </span>            : 
<span class="lineNum">    1040 </span><span class="lineNoCov">          0 :         if (mpdin-&gt;use_low_latency) use_threads = GF_TRUE;</span>
<span class="lineNum">    1041 </span>            :         
<span class="lineNum">    1042 </span><span class="lineNoCov">          0 :         opt = gf_modules_get_option((GF_BaseInterface *)plug, &quot;DASH&quot;, &quot;AllowAbort&quot;);</span>
<span class="lineNum">    1043 </span><span class="lineNoCov">          0 :         if (!opt) gf_modules_set_option((GF_BaseInterface *)plug, &quot;DASH&quot;, &quot;AllowAbort&quot;, &quot;no&quot;);</span>
<span class="lineNum">    1044 </span><span class="lineNoCov">          0 :         mpdin-&gt;allow_http_abort = (opt &amp;&amp; !strcmp(opt, &quot;yes&quot;)) ? GF_TRUE : GF_FALSE;</span>
<span class="lineNum">    1045 </span>            : 
<span class="lineNum">    1046 </span><span class="lineNoCov">          0 :         opt = gf_modules_get_option((GF_BaseInterface *)plug, &quot;DASH&quot;, &quot;ShiftClock&quot;);</span>
<span class="lineNum">    1047 </span><span class="lineNoCov">          0 :         if (!opt) gf_modules_set_option((GF_BaseInterface *)plug, &quot;DASH&quot;, &quot;ShiftClock&quot;, &quot;0&quot;);</span>
<span class="lineNum">    1048 </span><span class="lineNoCov">          0 :         shift_utc_ms = opt ? atoi(opt) : 0;</span>
<span class="lineNum">    1049 </span>            : 
<span class="lineNum">    1050 </span><span class="lineNoCov">          0 :         opt = gf_modules_get_option((GF_BaseInterface *)plug, &quot;DASH&quot;, &quot;UseServerUTC&quot;);</span>
<span class="lineNum">    1051 </span><span class="lineNoCov">          0 :         if (!opt) gf_modules_set_option((GF_BaseInterface *)plug, &quot;DASH&quot;, &quot;UseServerUTC&quot;, &quot;yes&quot;);</span>
<span class="lineNum">    1052 </span><span class="lineNoCov">          0 :         use_server_utc = (opt &amp;&amp; !strcmp(opt, &quot;yes&quot;)) ? 1 : 0;</span>
<span class="lineNum">    1053 </span>            : 
<span class="lineNum">    1054 </span><span class="lineNoCov">          0 :         mpdin-&gt;nb_playing = 0;</span>
<span class="lineNum">    1055 </span>            : 
<span class="lineNum">    1056 </span>            :         init_timeshift = 0;
<span class="lineNum">    1057 </span><span class="lineNoCov">          0 :         opt = gf_modules_get_option((GF_BaseInterface *)plug, &quot;DASH&quot;, &quot;InitialTimeshift&quot;);</span>
<span class="lineNum">    1058 </span><span class="lineNoCov">          0 :         if (!opt) gf_modules_set_option((GF_BaseInterface *)plug, &quot;DASH&quot;, &quot;InitialTimeshift&quot;, &quot;0&quot;);</span>
<span class="lineNum">    1059 </span><span class="lineNoCov">          0 :         if (opt) init_timeshift = atoi(opt);</span>
<span class="lineNum">    1060 </span>            : 
<span class="lineNum">    1061 </span><span class="lineNoCov">          0 :         opt = gf_modules_get_option((GF_BaseInterface *)plug, &quot;DASH&quot;, &quot;TileAdaptation&quot;);</span>
<span class="lineNum">    1062 </span><span class="lineNoCov">          0 :         if (!opt) {</span>
<span class="lineNum">    1063 </span><span class="lineNoCov">          0 :                 gf_modules_set_option((GF_BaseInterface *)plug, &quot;DASH&quot;, &quot;TileAdaptation&quot;, &quot;none&quot;);</span>
<span class="lineNum">    1064 </span>            :                 opt = &quot;none&quot;;
<span class="lineNum">    1065 </span><span class="lineNoCov">          0 :         }</span>
<span class="lineNum">    1066 </span><span class="lineNoCov">          0 :         if (!strcmp(opt, &quot;none&quot;)) tile_adapt_mode = GF_DASH_ADAPT_TILE_NONE;</span>
<span class="lineNum">    1067 </span><span class="lineNoCov">          0 :         else if (!strcmp(opt, &quot;rows&quot;)) tile_adapt_mode = GF_DASH_ADAPT_TILE_ROWS;</span>
<span class="lineNum">    1068 </span><span class="lineNoCov">          0 :         else if (!strcmp(opt, &quot;reverseRows&quot;)) tile_adapt_mode = GF_DASH_ADAPT_TILE_ROWS_REVERSE;</span>
<span class="lineNum">    1069 </span><span class="lineNoCov">          0 :         else if (!strcmp(opt, &quot;middleRows&quot;)) tile_adapt_mode = GF_DASH_ADAPT_TILE_ROWS_MIDDLE;</span>
<span class="lineNum">    1070 </span><span class="lineNoCov">          0 :         else if (!strcmp(opt, &quot;columns&quot;)) tile_adapt_mode = GF_DASH_ADAPT_TILE_COLUMNS;</span>
<span class="lineNum">    1071 </span><span class="lineNoCov">          0 :         else if (!strcmp(opt, &quot;reverseColumns&quot;)) tile_adapt_mode = GF_DASH_ADAPT_TILE_COLUMNS_REVERSE;</span>
<span class="lineNum">    1072 </span><span class="lineNoCov">          0 :         else if (!strcmp(opt, &quot;middleColumns&quot;)) tile_adapt_mode = GF_DASH_ADAPT_TILE_COLUMNS_MIDDLE;</span>
<span class="lineNum">    1073 </span><span class="lineNoCov">          0 :         else if (!strcmp(opt, &quot;center&quot;)) tile_adapt_mode = GF_DASH_ADAPT_TILE_CENTER;</span>
<span class="lineNum">    1074 </span><span class="lineNoCov">          0 :         else if (!strcmp(opt, &quot;edges&quot;)) tile_adapt_mode = GF_DASH_ADAPT_TILE_EDGES;</span>
<span class="lineNum">    1075 </span>            :         else {
<span class="lineNum">    1076 </span><span class="lineNoCov">          0 :                 GF_LOG(GF_LOG_WARNING, GF_LOG_DASH, (&quot;[MPDIn] Unrecognized tile adaptation mode %s - defaulting to none\n&quot;, opt));</span>
<span class="lineNum">    1077 </span>            :                 tile_adapt_mode = GF_DASH_ADAPT_TILE_NONE;
<span class="lineNum">    1078 </span>            :         }
<span class="lineNum">    1079 </span>            : 
<span class="lineNum">    1080 </span><span class="lineNoCov">          0 :         opt = gf_modules_get_option((GF_BaseInterface *)plug, &quot;DASH&quot;, &quot;TileRateDecrease&quot;);</span>
<span class="lineNum">    1081 </span><span class="lineNoCov">          0 :         if (!opt) {</span>
<span class="lineNum">    1082 </span><span class="lineNoCov">          0 :                 gf_modules_set_option((GF_BaseInterface *)plug, &quot;DASH&quot;, &quot;TileRateDecrease&quot;, &quot;100&quot;);</span>
<span class="lineNum">    1083 </span>            :                 opt = &quot;100&quot;;
<span class="lineNum">    1084 </span><span class="lineNoCov">          0 :         }</span>
<span class="lineNum">    1085 </span><span class="lineNoCov">          0 :         tiles_rate_decrease = atoi(opt);</span>
<span class="lineNum">    1086 </span>            : 
<span class="lineNum">    1087 </span>            :         //override all service callbacks
<span class="lineNum">    1088 </span><span class="lineNoCov">          0 :         mpdin-&gt;fn_connect_ack = serv-&gt;fn_connect_ack;</span>
<span class="lineNum">    1089 </span><span class="lineNoCov">          0 :         serv-&gt;fn_connect_ack = mpdin_connect_ack;</span>
<span class="lineNum">    1090 </span><span class="lineNoCov">          0 :         mpdin-&gt;fn_data_packet = serv-&gt;fn_data_packet;</span>
<span class="lineNum">    1091 </span><span class="lineNoCov">          0 :         serv-&gt;fn_data_packet = mpdin_data_packet;</span>
<span class="lineNum">    1092 </span>            : 
<span class="lineNum">    1093 </span><span class="lineNoCov">          0 :         mpdin-&gt;dash = gf_dash_new(&amp;mpdin-&gt;dash_io, max_cache_duration, auto_switch_count, keep_files, disable_switching, first_select_mode, (mpdin-&gt;buffer_mode == MPDIN_BUFFER_SEGMENTS) ? 1 : 0, init_timeshift);</span>
<span class="lineNum">    1094 </span>            : 
<span class="lineNum">    1095 </span><span class="lineNoCov">          0 :         if (!mpdin-&gt;dash) {</span>
<span class="lineNum">    1096 </span><span class="lineNoCov">          0 :                 GF_LOG(GF_LOG_ERROR, GF_LOG_DASH, (&quot;[MPD_IN] Error - cannot create DASH Client for %s\n&quot;, url));</span>
<span class="lineNum">    1097 </span><span class="lineNoCov">          0 :                 mpdin-&gt;fn_connect_ack(mpdin-&gt;service, NULL, GF_IO_ERR);</span>
<span class="lineNum">    1098 </span><span class="lineNoCov">          0 :                 return GF_OK;</span>
<span class="lineNum">    1099 </span>            :         }
<span class="lineNum">    1100 </span>            : 
<span class="lineNum">    1101 </span><span class="lineNoCov">          0 :         gf_dash_set_utc_shift(mpdin-&gt;dash, shift_utc_ms);</span>
<span class="lineNum">    1102 </span><span class="lineNoCov">          0 :         gf_dash_enable_utc_drift_compensation(mpdin-&gt;dash, use_server_utc);</span>
<span class="lineNum">    1103 </span><span class="lineNoCov">          0 :         gf_dash_set_tile_adaptation_mode(mpdin-&gt;dash, tile_adapt_mode, tiles_rate_decrease);</span>
<span class="lineNum">    1104 </span><span class="lineNoCov">          0 :         gf_dash_set_threaded_download(mpdin-&gt;dash, use_threads);</span>
<span class="lineNum">    1105 </span>            : 
<span class="lineNum">    1106 </span><span class="lineNoCov">          0 :         opt = gf_modules_get_option((GF_BaseInterface *)plug, &quot;DASH&quot;, &quot;UseScreenResolution&quot;);</span>
<span class="lineNum">    1107 </span>            :         //default mode is no for the time being
<span class="lineNum">    1108 </span><span class="lineNoCov">          0 :         if (!opt) gf_modules_set_option((GF_BaseInterface *)plug, &quot;DASH&quot;, &quot;UseScreenResolution&quot;, &quot;no&quot;);</span>
<span class="lineNum">    1109 </span><span class="lineNoCov">          0 :         if (!opt || !strcmp(opt, &quot;yes&quot;)) {</span>
<span class="lineNum">    1110 </span><span class="lineNoCov">          0 :                 GF_NetworkCommand com;</span>
<span class="lineNum">    1111 </span><span class="lineNoCov">          0 :                 memset(&amp;com, 0, sizeof(GF_NetworkCommand));</span>
<span class="lineNum">    1112 </span><span class="lineNoCov">          0 :                 com.base.command_type = GF_NET_SERVICE_MEDIA_CAP_QUERY;</span>
<span class="lineNum">    1113 </span><span class="lineNoCov">          0 :                 gf_service_command(serv, &amp;com, GF_OK);</span>
<span class="lineNum">    1114 </span>            : 
<span class="lineNum">    1115 </span><span class="lineNoCov">          0 :                 if (com.mcaps.width &amp;&amp; com.mcaps.height) {</span>
<span class="lineNum">    1116 </span><span class="lineNoCov">          0 :                         gf_dash_set_max_resolution(mpdin-&gt;dash, com.mcaps.width, com.mcaps.height, com.mcaps.display_bit_depth);</span>
<span class="lineNum">    1117 </span><span class="lineNoCov">          0 :                 }</span>
<span class="lineNum">    1118 </span><span class="lineNoCov">          0 :         }</span>
<span class="lineNum">    1119 </span>            : 
<span class="lineNum">    1120 </span><span class="lineNoCov">          0 :         opt = gf_modules_get_option((GF_BaseInterface *)plug, &quot;DASH&quot;, &quot;TimeBetween404&quot;);</span>
<span class="lineNum">    1121 </span><span class="lineNoCov">          0 :         if (opt) {</span>
<span class="lineNum">    1122 </span><span class="lineNoCov">          0 :                 gf_dash_set_min_timeout_between_404(mpdin-&gt;dash, atoi(opt));</span>
<span class="lineNum">    1123 </span><span class="lineNoCov">          0 :         }</span>
<span class="lineNum">    1124 </span>            : 
<span class="lineNum">    1125 </span><span class="lineNoCov">          0 :         opt = gf_modules_get_option((GF_BaseInterface *)plug, &quot;DASH&quot;, &quot;SegmentExpirationThreshold&quot;);</span>
<span class="lineNum">    1126 </span><span class="lineNoCov">          0 :         if (opt) {</span>
<span class="lineNum">    1127 </span><span class="lineNoCov">          0 :                 gf_dash_set_segment_expiration_threshold(mpdin-&gt;dash, atoi(opt));</span>
<span class="lineNum">    1128 </span><span class="lineNoCov">          0 :         }</span>
<span class="lineNum">    1129 </span>            : 
<span class="lineNum">    1130 </span><span class="lineNoCov">          0 :         opt = gf_modules_get_option((GF_BaseInterface *)plug, &quot;DASH&quot;, &quot;SwitchProbeCount&quot;);</span>
<span class="lineNum">    1131 </span><span class="lineNoCov">          0 :         if (opt) {</span>
<span class="lineNum">    1132 </span><span class="lineNoCov">          0 :                 gf_dash_set_switching_probe_count(mpdin-&gt;dash, atoi(opt));</span>
<span class="lineNum">    1133 </span><span class="lineNoCov">          0 :         } else {</span>
<span class="lineNum">    1134 </span><span class="lineNoCov">          0 :                 gf_modules_set_option((GF_BaseInterface *)plug, &quot;DASH&quot;, &quot;SwitchProbeCount&quot;, &quot;1&quot;);</span>
<span class="lineNum">    1135 </span>            :         }
<span class="lineNum">    1136 </span>            : 
<span class="lineNum">    1137 </span><span class="lineNoCov">          0 :         opt = gf_modules_get_option((GF_BaseInterface *)plug, &quot;DASH&quot;, &quot;AgressiveSwitching&quot;);</span>
<span class="lineNum">    1138 </span><span class="lineNoCov">          0 :         if (!opt) gf_modules_set_option((GF_BaseInterface *)plug, &quot;DASH&quot;, &quot;AgressiveSwitching&quot;, &quot;no&quot;);</span>
<span class="lineNum">    1139 </span><span class="lineNoCov">          0 :         gf_dash_set_agressive_adaptation(mpdin-&gt;dash,  (opt &amp;&amp; !strcmp(opt, &quot;yes&quot;)) ? GF_TRUE : GF_FALSE);</span>
<span class="lineNum">    1140 </span>            : 
<span class="lineNum">    1141 </span><span class="lineNoCov">          0 :         opt = gf_modules_get_option((GF_BaseInterface *)plug, &quot;DASH&quot;, &quot;DebugAdaptationSet&quot;);</span>
<span class="lineNum">    1142 </span><span class="lineNoCov">          0 :         if (!opt) gf_modules_set_option((GF_BaseInterface *)plug, &quot;DASH&quot;, &quot;DebugAdaptationSet&quot;, &quot;-1&quot;);</span>
<span class="lineNum">    1143 </span><span class="lineNoCov">          0 :         debug_adaptation_set = opt ? atoi(opt) : -1;</span>
<span class="lineNum">    1144 </span>            : 
<span class="lineNum">    1145 </span><span class="lineNoCov">          0 :         gf_dash_debug_group(mpdin-&gt;dash, debug_adaptation_set);</span>
<span class="lineNum">    1146 </span>            : 
<span class="lineNum">    1147 </span>            :         /*by default, speed adaptation and display adaptation are enable*/
<span class="lineNum">    1148 </span><span class="lineNoCov">          0 :         opt = gf_modules_get_option((GF_BaseInterface *)plug, &quot;DASH&quot;, &quot;SpeedAdaptation&quot;);</span>
<span class="lineNum">    1149 </span><span class="lineNoCov">          0 :         if (opt &amp;&amp; !strcmp(opt, &quot;yes&quot;))</span>
<span class="lineNum">    1150 </span><span class="lineNoCov">          0 :                 gf_dash_disable_speed_adaptation(mpdin-&gt;dash, GF_FALSE);</span>
<span class="lineNum">    1151 </span>            :         else
<span class="lineNum">    1152 </span><span class="lineNoCov">          0 :                 gf_dash_disable_speed_adaptation(mpdin-&gt;dash, GF_TRUE);</span>
<span class="lineNum">    1153 </span>            : 
<span class="lineNum">    1154 </span>            : 
<span class="lineNum">    1155 </span>            :         /*dash thread starts at the end of gf_dash_open */
<span class="lineNum">    1156 </span><span class="lineNoCov">          0 :         e = gf_dash_open(mpdin-&gt;dash, url);</span>
<span class="lineNum">    1157 </span><span class="lineNoCov">          0 :         if (e) {</span>
<span class="lineNum">    1158 </span><span class="lineNoCov">          0 :                 GF_LOG(GF_LOG_ERROR, GF_LOG_DASH, (&quot;[MPD_IN] Error - cannot initialize DASH Client for %s: %s\n&quot;, url, gf_error_to_string(e)));</span>
<span class="lineNum">    1159 </span><span class="lineNoCov">          0 :                 mpdin-&gt;fn_connect_ack(mpdin-&gt;service, NULL, e);</span>
<span class="lineNum">    1160 </span><span class="lineNoCov">          0 :                 return GF_OK;</span>
<span class="lineNum">    1161 </span>            :         }
<span class="lineNum">    1162 </span><span class="lineNoCov">          0 :         return GF_OK;</span>
<a name="1163"><span class="lineNum">    1163 </span><span class="lineNoCov">          0 : }</span></a>
<span class="lineNum">    1164 </span>            : 
<span class="lineNum">    1165 </span>            : static GF_Descriptor *MPD_GetServiceDesc(GF_InputService *plug, u32 expect_type, const char *sub_url)
<span class="lineNum">    1166 </span>            : {
<span class="lineNum">    1167 </span>            :         u32 i;
<span class="lineNum">    1168 </span><span class="lineNoCov">          0 :         GF_MPD_In *mpdin = (GF_MPD_In*) plug-&gt;priv;</span>
<span class="lineNum">    1169 </span><span class="lineNoCov">          0 :         GF_LOG(GF_LOG_DEBUG, GF_LOG_DASH, (&quot;[MPD_IN] Received Service Description request from terminal for %s\n&quot;, sub_url));</span>
<span class="lineNum">    1170 </span><span class="lineNoCov">          0 :         for (i=0; i&lt;gf_dash_get_group_count(mpdin-&gt;dash); i++) {</span>
<span class="lineNum">    1171 </span>            :                 GF_Descriptor *desc;
<span class="lineNum">    1172 </span>            :                 GF_MPDGroup *mudta;
<span class="lineNum">    1173 </span>            : #if 0
<span class="lineNum">    1174 </span>            :                 if (!gf_dash_is_group_selected(mpdin-&gt;dash, i))
<span class="lineNum">    1175 </span>            :                         continue;
<span class="lineNum">    1176 </span>            : #endif
<span class="lineNum">    1177 </span><span class="lineNoCov">          0 :                 mudta = gf_dash_get_group_udta(mpdin-&gt;dash, i);</span>
<span class="lineNum">    1178 </span><span class="lineNoCov">          0 :                 if (!mudta) continue;</span>
<span class="lineNum">    1179 </span><span class="lineNoCov">          0 :                 if (mudta-&gt;service_descriptor_fetched) continue;</span>
<span class="lineNum">    1180 </span>            : 
<span class="lineNum">    1181 </span><span class="lineNoCov">          0 :                 desc = mudta-&gt;segment_ifce-&gt;GetServiceDescriptor(mudta-&gt;segment_ifce, expect_type, sub_url);</span>
<span class="lineNum">    1182 </span><span class="lineNoCov">          0 :                 if (desc) mudta-&gt;service_descriptor_fetched = 1;</span>
<span class="lineNum">    1183 </span><span class="lineNoCov">          0 :                 gf_odf_desc_del(desc);</span>
<span class="lineNum">    1184 </span><span class="lineNoCov">          0 :         }</span>
<span class="lineNum">    1185 </span><span class="lineNoCov">          0 :         return NULL;</span>
<span class="lineNum">    1186 </span>            : }
<a name="1187"><span class="lineNum">    1187 </span>            : </a>
<span class="lineNum">    1188 </span>            : 
<span class="lineNum">    1189 </span>            : GF_Err MPD_CloseService(GF_InputService *plug)
<span class="lineNum">    1190 </span>            : {
<span class="lineNum">    1191 </span><span class="lineNoCov">          0 :         GF_MPD_In *mpdin = (GF_MPD_In*) plug-&gt;priv;</span>
<span class="lineNum">    1192 </span>            :         assert(mpdin);
<span class="lineNum">    1193 </span><span class="lineNoCov">          0 :         GF_LOG(GF_LOG_DEBUG, GF_LOG_DASH, (&quot;[MPD_IN] Received Close Service (%p) request from terminal\n&quot;, mpdin-&gt;service));</span>
<span class="lineNum">    1194 </span>            : 
<span class="lineNum">    1195 </span><span class="lineNoCov">          0 :         mpdin-&gt;closed = 1;</span>
<span class="lineNum">    1196 </span>            : 
<span class="lineNum">    1197 </span><span class="lineNoCov">          0 :         if (mpdin-&gt;dash)</span>
<span class="lineNum">    1198 </span><span class="lineNoCov">          0 :                 gf_dash_close(mpdin-&gt;dash);</span>
<span class="lineNum">    1199 </span>            : 
<span class="lineNum">    1200 </span><span class="lineNoCov">          0 :         gf_service_disconnect_ack(mpdin-&gt;service, NULL, GF_OK);</span>
<span class="lineNum">    1201 </span>            : 
<span class="lineNum">    1202 </span><span class="lineNoCov">          0 :         return GF_OK;</span>
<a name="1203"><span class="lineNum">    1203 </span>            : }</a>
<span class="lineNum">    1204 </span>            : 
<span class="lineNum">    1205 </span>            : GF_Err MPD_ServiceCommand(GF_InputService *plug, GF_NetworkCommand *com)
<span class="lineNum">    1206 </span>            : {
<span class="lineNum">    1207 </span>            :         s32 idx;
<span class="lineNum">    1208 </span>            :         GF_Err e;
<span class="lineNum">    1209 </span><span class="lineNoCov">          0 :         GF_MPD_In *mpdin = (GF_MPD_In*) plug-&gt;priv;</span>
<span class="lineNum">    1210 </span>            :         GF_InputService *segment_ifce = NULL;
<span class="lineNum">    1211 </span>            : 
<span class="lineNum">    1212 </span><span class="lineNoCov">          0 :         if (!plug || !plug-&gt;priv || !com) return GF_SERVICE_ERROR;</span>
<span class="lineNum">    1213 </span>            : 
<span class="lineNum">    1214 </span><span class="lineNoCov">          0 :         segment_ifce = MPD_GetInputServiceForChannel(mpdin, com-&gt;base.on_channel);</span>
<span class="lineNum">    1215 </span>            : 
<span class="lineNum">    1216 </span><span class="lineNoCov">          0 :         switch (com-&gt;command_type) {</span>
<span class="lineNum">    1217 </span>            :         case GF_NET_SERVICE_INFO:
<span class="lineNum">    1218 </span>            :         {
<span class="lineNum">    1219 </span>            :                 s32 idx;
<span class="lineNum">    1220 </span><span class="lineNoCov">          0 :                 GF_LOG(GF_LOG_DEBUG, GF_LOG_DASH, (&quot;[MPD_IN] Received Info command from terminal on Service (%p)\n&quot;, mpdin-&gt;service));</span>
<span class="lineNum">    1221 </span>            : 
<span class="lineNum">    1222 </span>            :                 e = GF_OK;
<span class="lineNum">    1223 </span><span class="lineNoCov">          0 :                 if (segment_ifce) {</span>
<span class="lineNum">    1224 </span>            :                         /* defer to the real input service */
<span class="lineNum">    1225 </span><span class="lineNoCov">          0 :                         e = segment_ifce-&gt;ServiceCommand(segment_ifce, com);</span>
<span class="lineNum">    1226 </span><span class="lineNoCov">          0 :                 }</span>
<span class="lineNum">    1227 </span>            : 
<span class="lineNum">    1228 </span><span class="lineNoCov">          0 :                 if (e!= GF_OK || !com-&gt;info.name || 2 &gt; strlen(com-&gt;info.name)) {</span>
<span class="lineNum">    1229 </span><span class="lineNoCov">          0 :                         gf_dash_get_info(mpdin-&gt;dash, &amp;com-&gt;info.name, &amp;com-&gt;info.comment);</span>
<span class="lineNum">    1230 </span><span class="lineNoCov">          0 :                 }</span>
<span class="lineNum">    1231 </span><span class="lineNoCov">          0 :                 idx = MPD_GetGroupIndexForChannel(mpdin, com-&gt;play.on_channel);</span>
<span class="lineNum">    1232 </span><span class="lineNoCov">          0 :                 if (idx&gt;=0) {</span>
<span class="lineNum">    1233 </span>            :                         //gather role and co
<span class="lineNum">    1234 </span><span class="lineNoCov">          0 :                         if (!com-&gt;info.role) {</span>
<span class="lineNum">    1235 </span><span class="lineNoCov">          0 :                                 gf_dash_group_enum_descriptor(mpdin-&gt;dash, idx, GF_MPD_DESC_ROLE, 0, NULL, NULL, &amp;com-&gt;info.role);</span>
<span class="lineNum">    1236 </span><span class="lineNoCov">          0 :                         }</span>
<span class="lineNum">    1237 </span><span class="lineNoCov">          0 :                         if (!com-&gt;info.accessibility) {</span>
<span class="lineNum">    1238 </span><span class="lineNoCov">          0 :                                 gf_dash_group_enum_descriptor(mpdin-&gt;dash, idx, GF_MPD_DESC_ACCESSIBILITY, 0, NULL, NULL, &amp;com-&gt;info.accessibility);</span>
<span class="lineNum">    1239 </span><span class="lineNoCov">          0 :                         }</span>
<span class="lineNum">    1240 </span><span class="lineNoCov">          0 :                         if (!com-&gt;info.rating) {</span>
<span class="lineNum">    1241 </span><span class="lineNoCov">          0 :                                 gf_dash_group_enum_descriptor(mpdin-&gt;dash, idx, GF_MPD_DESC_RATING, 0, NULL, NULL, &amp;com-&gt;info.rating);</span>
<span class="lineNum">    1242 </span><span class="lineNoCov">          0 :                         }</span>
<span class="lineNum">    1243 </span>            :                 }
<span class="lineNum">    1244 </span><span class="lineNoCov">          0 :                 return GF_OK;</span>
<span class="lineNum">    1245 </span>            :         }
<span class="lineNum">    1246 </span>            :         /*we could get it from MPD*/
<span class="lineNum">    1247 </span>            :         case GF_NET_SERVICE_HAS_AUDIO:
<span class="lineNum">    1248 </span>            :         case GF_NET_SERVICE_FLUSH_DATA:
<span class="lineNum">    1249 </span><span class="lineNoCov">          0 :                 if (segment_ifce) {</span>
<span class="lineNum">    1250 </span>            :                         /* defer to the real input service */
<span class="lineNum">    1251 </span><span class="lineNoCov">          0 :                         return segment_ifce-&gt;ServiceCommand(segment_ifce, com);</span>
<span class="lineNum">    1252 </span>            :                 }
<span class="lineNum">    1253 </span><span class="lineNoCov">          0 :                 return GF_NOT_SUPPORTED;</span>
<span class="lineNum">    1254 </span>            : 
<span class="lineNum">    1255 </span>            :         case GF_NET_SERVICE_HAS_FORCED_VIDEO_SIZE:
<span class="lineNum">    1256 </span><span class="lineNoCov">          0 :                 com-&gt;par.width = mpdin-&gt;use_max_res ? mpdin-&gt;width : 0;</span>
<span class="lineNum">    1257 </span><span class="lineNoCov">          0 :                 com-&gt;par.height = mpdin-&gt;use_max_res ? mpdin-&gt;height : 0;</span>
<span class="lineNum">    1258 </span><span class="lineNoCov">          0 :                 return GF_OK;</span>
<span class="lineNum">    1259 </span>            : 
<span class="lineNum">    1260 </span>            :         case GF_NET_SERVICE_QUALITY_SWITCH:
<span class="lineNum">    1261 </span><span class="lineNoCov">          0 :                 if (com-&gt;switch_quality.set_tile_mode_plus_one) {</span>
<span class="lineNum">    1262 </span><span class="lineNoCov">          0 :                         GF_BaseInterface *pl = (GF_BaseInterface *)plug;</span>
<span class="lineNum">    1263 </span><span class="lineNoCov">          0 :                         GF_DASHTileAdaptationMode tile_mode = com-&gt;switch_quality.set_tile_mode_plus_one - 1;</span>
<span class="lineNum">    1264 </span><span class="lineNoCov">          0 :                         gf_dash_set_tile_adaptation_mode(mpdin-&gt;dash, tile_mode, 100);</span>
<span class="lineNum">    1265 </span>            :                         
<span class="lineNum">    1266 </span><span class="lineNoCov">          0 :                         switch (tile_mode) {</span>
<span class="lineNum">    1267 </span><span class="lineNoCov">          0 :                         case GF_DASH_ADAPT_TILE_ROWS: gf_modules_set_option(pl,  &quot;DASH&quot;, &quot;TileAdaptation&quot;, &quot;rows&quot;); break;</span>
<span class="lineNum">    1268 </span><span class="lineNoCov">          0 :                         case GF_DASH_ADAPT_TILE_ROWS_REVERSE: gf_modules_set_option(pl,  &quot;DASH&quot;, &quot;TileAdaptation&quot;, &quot;reverseRows&quot;); break;</span>
<span class="lineNum">    1269 </span><span class="lineNoCov">          0 :                         case GF_DASH_ADAPT_TILE_ROWS_MIDDLE: gf_modules_set_option(pl,  &quot;DASH&quot;, &quot;TileAdaptation&quot;, &quot;middleRows&quot;); break;</span>
<span class="lineNum">    1270 </span><span class="lineNoCov">          0 :                         case GF_DASH_ADAPT_TILE_COLUMNS: gf_modules_set_option(pl,  &quot;DASH&quot;, &quot;TileAdaptation&quot;, &quot;columns&quot;); break;</span>
<span class="lineNum">    1271 </span><span class="lineNoCov">          0 :                         case GF_DASH_ADAPT_TILE_COLUMNS_REVERSE: gf_modules_set_option(pl,  &quot;DASH&quot;, &quot;TileAdaptation&quot;, &quot;reverseColumns&quot;); break;</span>
<span class="lineNum">    1272 </span><span class="lineNoCov">          0 :                         case GF_DASH_ADAPT_TILE_COLUMNS_MIDDLE: gf_modules_set_option(pl,  &quot;DASH&quot;, &quot;TileAdaptation&quot;, &quot;middleColumns&quot;); break;</span>
<span class="lineNum">    1273 </span><span class="lineNoCov">          0 :                         case GF_DASH_ADAPT_TILE_CENTER: gf_modules_set_option(pl,  &quot;DASH&quot;, &quot;TileAdaptation&quot;, &quot;center&quot;); break;</span>
<span class="lineNum">    1274 </span><span class="lineNoCov">          0 :                         case GF_DASH_ADAPT_TILE_EDGES: gf_modules_set_option(pl,  &quot;DASH&quot;, &quot;TileAdaptation&quot;, &quot;edges&quot;); break;</span>
<span class="lineNum">    1275 </span>            :                         case GF_DASH_ADAPT_TILE_NONE:
<span class="lineNum">    1276 </span>            :                         default:
<span class="lineNum">    1277 </span><span class="lineNoCov">          0 :                                 gf_modules_set_option(pl,  &quot;DASH&quot;, &quot;TileAdaptation&quot;, &quot;none&quot;);</span>
<span class="lineNum">    1278 </span><span class="lineNoCov">          0 :                                 break;</span>
<span class="lineNum">    1279 </span>            :                         }
<span class="lineNum">    1280 </span><span class="lineNoCov">          0 :                 } else if (com-&gt;switch_quality.set_auto) {</span>
<span class="lineNum">    1281 </span><span class="lineNoCov">          0 :                         gf_dash_set_automatic_switching(mpdin-&gt;dash, 1);</span>
<span class="lineNum">    1282 </span><span class="lineNoCov">          0 :                 } else if (com-&gt;base.on_channel) {</span>
<span class="lineNum">    1283 </span><span class="lineNoCov">          0 :                                 segment_ifce = MPD_GetInputServiceForChannel(mpdin, com-&gt;base.on_channel);</span>
<span class="lineNum">    1284 </span><span class="lineNoCov">          0 :                                 if (!segment_ifce) return GF_NOT_SUPPORTED;</span>
<span class="lineNum">    1285 </span><span class="lineNoCov">          0 :                                 idx = MPD_GetGroupIndexForChannel(mpdin, com-&gt;play.on_channel);</span>
<span class="lineNum">    1286 </span><span class="lineNoCov">          0 :                                 if (idx &lt; 0) return GF_BAD_PARAM;</span>
<span class="lineNum">    1287 </span>            :                         
<span class="lineNum">    1288 </span><span class="lineNoCov">          0 :                                 if (com-&gt;switch_quality.dependent_group_index) {</span>
<span class="lineNum">    1289 </span><span class="lineNoCov">          0 :                                         if (com-&gt;switch_quality.dependent_group_index &gt; gf_dash_group_get_num_groups_depending_on(mpdin-&gt;dash, idx))</span>
<span class="lineNum">    1290 </span><span class="lineNoCov">          0 :                                                 return GF_BAD_PARAM;</span>
<span class="lineNum">    1291 </span>            :                         
<span class="lineNum">    1292 </span><span class="lineNoCov">          0 :                                         idx = gf_dash_get_dependent_group_index(mpdin-&gt;dash, idx, com-&gt;switch_quality.dependent_group_index-1);</span>
<span class="lineNum">    1293 </span><span class="lineNoCov">          0 :                                         if (idx==-1) return GF_BAD_PARAM;</span>
<span class="lineNum">    1294 </span>            :                                 }
<span class="lineNum">    1295 </span>            : 
<span class="lineNum">    1296 </span><span class="lineNoCov">          0 :                                 gf_dash_set_automatic_switching(mpdin-&gt;dash, 0);</span>
<span class="lineNum">    1297 </span><span class="lineNoCov">          0 :                                 gf_dash_group_select_quality(mpdin-&gt;dash, idx, com-&gt;switch_quality.ID);</span>
<span class="lineNum">    1298 </span><span class="lineNoCov">          0 :                 } else {</span>
<span class="lineNum">    1299 </span><span class="lineNoCov">          0 :                         gf_dash_switch_quality(mpdin-&gt;dash, com-&gt;switch_quality.up, mpdin-&gt;immediate_switch);</span>
<span class="lineNum">    1300 </span>            :                 }
<span class="lineNum">    1301 </span><span class="lineNoCov">          0 :                 return GF_OK;</span>
<span class="lineNum">    1302 </span>            : 
<span class="lineNum">    1303 </span>            :         case GF_NET_GET_TIMESHIFT:
<span class="lineNum">    1304 </span><span class="lineNoCov">          0 :                 com-&gt;timeshift.time = gf_dash_get_timeshift_buffer_pos(mpdin-&gt;dash);</span>
<span class="lineNum">    1305 </span><span class="lineNoCov">          0 :                 return GF_OK;</span>
<span class="lineNum">    1306 </span>            :         case GF_NET_SERVICE_CAN_REVERSE_PLAYBACK:
<span class="lineNum">    1307 </span><span class="lineNoCov">          0 :                 return mpdin_dash_can_reverse_playback(mpdin);</span>
<span class="lineNum">    1308 </span>            : 
<span class="lineNum">    1309 </span>            :         case GF_NET_ASSOCIATED_CONTENT_TIMING:
<span class="lineNum">    1310 </span><span class="lineNoCov">          0 :                 gf_dash_override_ntp(mpdin-&gt;dash, com-&gt;addon_time.ntp);</span>
<span class="lineNum">    1311 </span><span class="lineNoCov">          0 :                 return GF_OK;</span>
<span class="lineNum">    1312 </span>            :         default:
<span class="lineNum">    1313 </span>            :                 break;
<span class="lineNum">    1314 </span>            :         }
<span class="lineNum">    1315 </span>            :         /*not supported*/
<span class="lineNum">    1316 </span><span class="lineNoCov">          0 :         if (!com-&gt;base.on_channel) return GF_NOT_SUPPORTED;</span>
<span class="lineNum">    1317 </span>            : 
<span class="lineNum">    1318 </span><span class="lineNoCov">          0 :         segment_ifce = MPD_GetInputServiceForChannel(mpdin, com-&gt;base.on_channel);</span>
<span class="lineNum">    1319 </span><span class="lineNoCov">          0 :         if (!segment_ifce) return GF_NOT_SUPPORTED;</span>
<span class="lineNum">    1320 </span>            : 
<span class="lineNum">    1321 </span><span class="lineNoCov">          0 :         switch (com-&gt;command_type) {</span>
<span class="lineNum">    1322 </span>            :         case GF_NET_CHAN_INTERACTIVE:
<span class="lineNum">    1323 </span>            :                 /* TODO - we are interactive if not live without timeshift */
<span class="lineNum">    1324 </span><span class="lineNoCov">          0 :                 return GF_OK;</span>
<span class="lineNum">    1325 </span>            : 
<span class="lineNum">    1326 </span>            :         case GF_NET_CHAN_GET_SRD:
<span class="lineNum">    1327 </span>            :         {
<span class="lineNum">    1328 </span>            :                 Bool res;
<span class="lineNum">    1329 </span><span class="lineNoCov">          0 :                 idx = MPD_GetGroupIndexForChannel(mpdin, com-&gt;base.on_channel);</span>
<span class="lineNum">    1330 </span><span class="lineNoCov">          0 :                 if (idx &lt; 0) return GF_BAD_PARAM;</span>
<span class="lineNum">    1331 </span><span class="lineNoCov">          0 :                 if (com-&gt;srd.dependent_group_index) {</span>
<span class="lineNum">    1332 </span><span class="lineNoCov">          0 :                         if (com-&gt;srd.dependent_group_index &gt; gf_dash_group_get_num_groups_depending_on(mpdin-&gt;dash, idx))</span>
<span class="lineNum">    1333 </span><span class="lineNoCov">          0 :                                 return GF_BAD_PARAM;</span>
<span class="lineNum">    1334 </span>            :                         
<span class="lineNum">    1335 </span><span class="lineNoCov">          0 :                         idx = gf_dash_get_dependent_group_index(mpdin-&gt;dash, idx, com-&gt;srd.dependent_group_index-1);</span>
<span class="lineNum">    1336 </span><span class="lineNoCov">          0 :                 }               </span>
<span class="lineNum">    1337 </span><span class="lineNoCov">          0 :                 res = gf_dash_group_get_srd_info(mpdin-&gt;dash, idx, NULL, &amp;com-&gt;srd.x, &amp;com-&gt;srd.y, &amp;com-&gt;srd.w, &amp;com-&gt;srd.h, &amp;com-&gt;srd.width, &amp;com-&gt;srd.height);</span>
<span class="lineNum">    1338 </span><span class="lineNoCov">          0 :                 return res ? GF_OK : GF_NOT_SUPPORTED;</span>
<span class="lineNum">    1339 </span>            :         }
<span class="lineNum">    1340 </span>            : 
<span class="lineNum">    1341 </span>            :         case GF_NET_GET_STATS:
<span class="lineNum">    1342 </span>            :         {
<span class="lineNum">    1343 </span><span class="lineNoCov">          0 :                 idx = MPD_GetGroupIndexForChannel(mpdin, com-&gt;base.on_channel);</span>
<span class="lineNum">    1344 </span><span class="lineNoCov">          0 :                 if (idx &lt; 0) return GF_BAD_PARAM;</span>
<span class="lineNum">    1345 </span><span class="lineNoCov">          0 :                 com-&gt;net_stats.bw_down = 8 * gf_dash_group_get_download_rate(mpdin-&gt;dash, idx);</span>
<span class="lineNum">    1346 </span>            :         }
<span class="lineNum">    1347 </span><span class="lineNoCov">          0 :         return GF_OK;</span>
<span class="lineNum">    1348 </span>            : 
<span class="lineNum">    1349 </span>            :         case GF_NET_SERVICE_QUALITY_QUERY:
<span class="lineNum">    1350 </span>            :         {
<span class="lineNum">    1351 </span><span class="lineNoCov">          0 :                 GF_DASHQualityInfo qinfo;</span>
<span class="lineNum">    1352 </span>            :                 GF_Err e;
<span class="lineNum">    1353 </span>            :                 u32 count, g_idx;
<span class="lineNum">    1354 </span><span class="lineNoCov">          0 :                 idx = MPD_GetGroupIndexForChannel(mpdin, com-&gt;quality_query.on_channel);</span>
<span class="lineNum">    1355 </span><span class="lineNoCov">          0 :                 if (idx &lt; 0) return GF_BAD_PARAM;</span>
<span class="lineNum">    1356 </span><span class="lineNoCov">          0 :                 count = gf_dash_group_get_num_qualities(mpdin-&gt;dash, idx);</span>
<span class="lineNum">    1357 </span><span class="lineNoCov">          0 :                 if (!com-&gt;quality_query.index &amp;&amp; !com-&gt;quality_query.dependent_group_index) {</span>
<span class="lineNum">    1358 </span><span class="lineNoCov">          0 :                         com-&gt;quality_query.index = count;</span>
<span class="lineNum">    1359 </span><span class="lineNoCov">          0 :                         com-&gt;quality_query.dependent_group_index = gf_dash_group_get_num_groups_depending_on(mpdin-&gt;dash, idx);</span>
<span class="lineNum">    1360 </span><span class="lineNoCov">          0 :                         return GF_OK;</span>
<span class="lineNum">    1361 </span>            :                 }
<span class="lineNum">    1362 </span><span class="lineNoCov">          0 :                 if (com-&gt;quality_query.dependent_group_index) {</span>
<span class="lineNum">    1363 </span><span class="lineNoCov">          0 :                         if (com-&gt;quality_query.dependent_group_index &gt; gf_dash_group_get_num_groups_depending_on(mpdin-&gt;dash, idx))</span>
<span class="lineNum">    1364 </span><span class="lineNoCov">          0 :                                 return GF_BAD_PARAM;</span>
<span class="lineNum">    1365 </span>            :                         
<span class="lineNum">    1366 </span><span class="lineNoCov">          0 :                         g_idx = gf_dash_get_dependent_group_index(mpdin-&gt;dash, idx, com-&gt;quality_query.dependent_group_index-1);</span>
<span class="lineNum">    1367 </span><span class="lineNoCov">          0 :                         if (g_idx==(u32)-1) return GF_BAD_PARAM;</span>
<span class="lineNum">    1368 </span><span class="lineNoCov">          0 :                         count = gf_dash_group_get_num_qualities(mpdin-&gt;dash, g_idx);</span>
<span class="lineNum">    1369 </span><span class="lineNoCov">          0 :                         if (com-&gt;quality_query.index&gt;count) return GF_BAD_PARAM;</span>
<span class="lineNum">    1370 </span>            :                 } else {
<span class="lineNum">    1371 </span><span class="lineNoCov">          0 :                         if (com-&gt;quality_query.index&gt;count) return GF_BAD_PARAM;</span>
<span class="lineNum">    1372 </span>            :                         g_idx = idx;
<span class="lineNum">    1373 </span>            :                 }
<span class="lineNum">    1374 </span>            : 
<span class="lineNum">    1375 </span><span class="lineNoCov">          0 :                 e = gf_dash_group_get_quality_info(mpdin-&gt;dash, g_idx, com-&gt;quality_query.index-1, &amp;qinfo);</span>
<span class="lineNum">    1376 </span><span class="lineNoCov">          0 :                 if (e) return e;</span>
<span class="lineNum">    1377 </span>            :                 
<span class="lineNum">    1378 </span><span class="lineNoCov">          0 :                 com-&gt;quality_query.bandwidth = qinfo.bandwidth;</span>
<span class="lineNum">    1379 </span><span class="lineNoCov">          0 :                 com-&gt;quality_query.ID = qinfo.ID;</span>
<span class="lineNum">    1380 </span><span class="lineNoCov">          0 :                 com-&gt;quality_query.mime = qinfo.mime;</span>
<span class="lineNum">    1381 </span><span class="lineNoCov">          0 :                 com-&gt;quality_query.codec = qinfo.codec;</span>
<span class="lineNum">    1382 </span><span class="lineNoCov">          0 :                 com-&gt;quality_query.width = qinfo.width;</span>
<span class="lineNum">    1383 </span><span class="lineNoCov">          0 :                 com-&gt;quality_query.height = qinfo.height;</span>
<span class="lineNum">    1384 </span><span class="lineNoCov">          0 :                 com-&gt;quality_query.interlaced = qinfo.interlaced;</span>
<span class="lineNum">    1385 </span><span class="lineNoCov">          0 :                 if (qinfo.fps_den) {</span>
<span class="lineNum">    1386 </span><span class="lineNoCov">          0 :                         com-&gt;quality_query.fps = qinfo.fps_num;</span>
<span class="lineNum">    1387 </span><span class="lineNoCov">          0 :                         com-&gt;quality_query.fps /= qinfo.fps_den;</span>
<span class="lineNum">    1388 </span><span class="lineNoCov">          0 :                 } else {</span>
<span class="lineNum">    1389 </span>            :                         com-&gt;quality_query.fps = qinfo.fps_num;
<span class="lineNum">    1390 </span>            :                 }
<span class="lineNum">    1391 </span><span class="lineNoCov">          0 :                 com-&gt;quality_query.par_num = qinfo.par_num;</span>
<span class="lineNum">    1392 </span><span class="lineNoCov">          0 :                 com-&gt;quality_query.par_den = qinfo.par_den;</span>
<span class="lineNum">    1393 </span><span class="lineNoCov">          0 :                 com-&gt;quality_query.sample_rate = qinfo.sample_rate;</span>
<span class="lineNum">    1394 </span><span class="lineNoCov">          0 :                 com-&gt;quality_query.nb_channels = qinfo.nb_channels;</span>
<span class="lineNum">    1395 </span><span class="lineNoCov">          0 :                 com-&gt;quality_query.disabled = qinfo.disabled;</span>
<span class="lineNum">    1396 </span><span class="lineNoCov">          0 :                 com-&gt;quality_query.is_selected = qinfo.is_selected;</span>
<span class="lineNum">    1397 </span><span class="lineNoCov">          0 :                 com-&gt;quality_query.automatic = gf_dash_get_automatic_switching(mpdin-&gt;dash);</span>
<span class="lineNum">    1398 </span><span class="lineNoCov">          0 :                 com-&gt;quality_query.tile_adaptation_mode = (u32) gf_dash_get_tile_adaptation_mode(mpdin-&gt;dash);</span>
<span class="lineNum">    1399 </span><span class="lineNoCov">          0 :                 return GF_OK;</span>
<span class="lineNum">    1400 </span><span class="lineNoCov">          0 :         }</span>
<span class="lineNum">    1401 </span>            : 
<span class="lineNum">    1402 </span>            :         break;
<span class="lineNum">    1403 </span>            : 
<span class="lineNum">    1404 </span>            :         case GF_NET_CHAN_BUFFER:
<span class="lineNum">    1405 </span>            :                 /*get it from MPD minBufferTime - if not in low latency mode, indicate the value given in MPD (not possible to fetch segments earlier) - to be more precise we should get the min segment duration for this group*/
<span class="lineNum">    1406 </span><span class="lineNoCov">          0 :                 if (/* !mpdin-&gt;use_low_latency &amp;&amp; */ (mpdin-&gt;buffer_mode&gt;=MPDIN_BUFFER_MIN)) {</span>
<span class="lineNum">    1407 </span><span class="lineNoCov">          0 :                         u32 max = gf_dash_get_min_buffer_time(mpdin-&gt;dash);</span>
<span class="lineNum">    1408 </span><span class="lineNoCov">          0 :                         if (max&gt;com-&gt;buffer.max)</span>
<span class="lineNum">    1409 </span><span class="lineNoCov">          0 :                                 com-&gt;buffer.max = max;</span>
<span class="lineNum">    1410 </span>            : 
<span class="lineNum">    1411 </span><span class="lineNoCov">          0 :                         if (!com-&gt;buffer.min &amp;&amp; ! gf_dash_is_dynamic_mpd(mpdin-&gt;dash)) {</span>
<span class="lineNum">    1412 </span><span class="lineNoCov">          0 :                                 com-&gt;buffer.min = 1;</span>
<span class="lineNum">    1413 </span><span class="lineNoCov">          0 :                         }</span>
<span class="lineNum">    1414 </span>            :                 }
<span class="lineNum">    1415 </span><span class="lineNoCov">          0 :                 return GF_OK;</span>
<span class="lineNum">    1416 </span>            : 
<span class="lineNum">    1417 </span>            :         case GF_NET_CHAN_DURATION:
<span class="lineNum">    1418 </span><span class="lineNoCov">          0 :                 com-&gt;duration.duration = gf_dash_get_duration(mpdin-&gt;dash);</span>
<span class="lineNum">    1419 </span><span class="lineNoCov">          0 :                 idx = MPD_GetGroupIndexForChannel(mpdin, com-&gt;play.on_channel);</span>
<span class="lineNum">    1420 </span><span class="lineNoCov">          0 :                 if (idx &gt;= 0) {</span>
<span class="lineNum">    1421 </span><span class="lineNoCov">          0 :                         com-&gt;duration.time_shift_buffer = gf_dash_group_get_time_shift_buffer_depth(mpdin-&gt;dash, idx);</span>
<span class="lineNum">    1422 </span><span class="lineNoCov">          0 :                 }</span>
<span class="lineNum">    1423 </span><span class="lineNoCov">          0 :                 return GF_OK;</span>
<span class="lineNum">    1424 </span>            : 
<span class="lineNum">    1425 </span>            :         case GF_NET_CHAN_PLAY:
<span class="lineNum">    1426 </span>            : 
<span class="lineNum">    1427 </span><span class="lineNoCov">          0 :                 idx = MPD_GetGroupIndexForChannel(mpdin, com-&gt;play.on_channel);</span>
<span class="lineNum">    1428 </span><span class="lineNoCov">          0 :                 if (idx &lt; 0) return GF_BAD_PARAM;</span>
<span class="lineNum">    1429 </span>            : 
<span class="lineNum">    1430 </span>            :                 //adjust play range from media timestamps to MPD time
<span class="lineNum">    1431 </span><span class="lineNoCov">          0 :                 if (com-&gt;play.timestamp_based) {</span>
<span class="lineNum">    1432 </span>            :                         u32 timescale;
<span class="lineNum">    1433 </span>            :                         u64 pto;
<span class="lineNum">    1434 </span>            :                         Double offset;
<span class="lineNum">    1435 </span><span class="lineNoCov">          0 :                         GF_MPDGroup *group = gf_dash_get_group_udta(mpdin-&gt;dash, idx);</span>
<span class="lineNum">    1436 </span>            : 
<span class="lineNum">    1437 </span><span class="lineNoCov">          0 :                         if (com-&gt;play.timestamp_based==1) {</span>
<span class="lineNum">    1438 </span><span class="lineNoCov">          0 :                                 gf_dash_group_get_presentation_time_offset(mpdin-&gt;dash, idx, &amp;pto, &amp;timescale);</span>
<span class="lineNum">    1439 </span><span class="lineNoCov">          0 :                                 offset = (Double) pto;</span>
<span class="lineNum">    1440 </span><span class="lineNoCov">          0 :                                 offset /= timescale;</span>
<span class="lineNum">    1441 </span><span class="lineNoCov">          0 :                                 com-&gt;play.start_range -= offset;</span>
<span class="lineNum">    1442 </span><span class="lineNoCov">          0 :                                 if (com-&gt;play.start_range &lt; 0) com-&gt;play.start_range = 0;</span>
<span class="lineNum">    1443 </span>            :                         }
<span class="lineNum">    1444 </span>            : 
<span class="lineNum">    1445 </span><span class="lineNoCov">          0 :                         group-&gt;is_timestamp_based = 1;</span>
<span class="lineNum">    1446 </span><span class="lineNoCov">          0 :                         group-&gt;pto_setup = 0;</span>
<span class="lineNum">    1447 </span><span class="lineNoCov">          0 :                         mpdin-&gt;media_start_range = com-&gt;play.start_range;</span>
<span class="lineNum">    1448 </span><span class="lineNoCov">          0 :                 } else {</span>
<span class="lineNum">    1449 </span>            :                         GF_MPDGroup *group = gf_dash_get_group_udta(mpdin-&gt;dash, idx);
<span class="lineNum">    1450 </span><span class="lineNoCov">          0 :                         group-&gt;is_timestamp_based = 0;</span>
<span class="lineNum">    1451 </span><span class="lineNoCov">          0 :                         group-&gt;pto_setup = 0;</span>
<span class="lineNum">    1452 </span><span class="lineNoCov">          0 :                         if (com-&gt;play.start_range&lt;0) com-&gt;play.start_range = 0;</span>
<span class="lineNum">    1453 </span>            :                         //in m3u8, we need also media start time for mapping time
<span class="lineNum">    1454 </span><span class="lineNoCov">          0 :                         if (gf_dash_is_m3u8(mpdin-&gt;dash))</span>
<span class="lineNum">    1455 </span><span class="lineNoCov">          0 :                                 mpdin-&gt;media_start_range = com-&gt;play.start_range;</span>
<span class="lineNum">    1456 </span>            :                 }
<span class="lineNum">    1457 </span>            : 
<span class="lineNum">    1458 </span>            :                 //we cannot handle seek request outside of a period being setup, this messes up our internal service setup
<span class="lineNum">    1459 </span>            :                 //we postpone the seek and will request it later on ...
<span class="lineNum">    1460 </span><span class="lineNoCov">          0 :                 if (gf_dash_in_period_setup(mpdin-&gt;dash)) {</span>
<span class="lineNum">    1461 </span><span class="lineNoCov">          0 :                         u64 p_end = gf_dash_get_period_duration(mpdin-&gt;dash);</span>
<span class="lineNum">    1462 </span><span class="lineNoCov">          0 :                         if (p_end) {</span>
<span class="lineNum">    1463 </span><span class="lineNoCov">          0 :                                 p_end += gf_dash_get_period_start(mpdin-&gt;dash);</span>
<span class="lineNum">    1464 </span><span class="lineNoCov">          0 :                                 if (p_end&lt;1000*com-&gt;play.start_range) {</span>
<span class="lineNum">    1465 </span><span class="lineNoCov">          0 :                                         mpdin-&gt;seek_request = com-&gt;play.start_range;</span>
<span class="lineNum">    1466 </span><span class="lineNoCov">          0 :                                         return GF_OK;</span>
<span class="lineNum">    1467 </span>            :                                 }
<span class="lineNum">    1468 </span>            :                         }
<span class="lineNum">    1469 </span>            :                 }
<span class="lineNum">    1470 </span>            : 
<span class="lineNum">    1471 </span>            : 
<span class="lineNum">    1472 </span><span class="lineNoCov">          0 :                 gf_dash_set_speed(mpdin-&gt;dash, com-&gt;play.speed);</span>
<span class="lineNum">    1473 </span>            : 
<span class="lineNum">    1474 </span>            :                 /*don't seek if this command is the first PLAY request of objects declared by the subservice, unless start range is not default one (0) */
<span class="lineNum">    1475 </span><span class="lineNoCov">          0 :                 if (!mpdin-&gt;nb_playing &amp;&amp; (!com-&gt;play.initial_broadcast_play || (com-&gt;play.start_range&gt;1.0) )) {</span>
<span class="lineNum">    1476 </span><span class="lineNoCov">          0 :                         GF_LOG(GF_LOG_DEBUG, GF_LOG_DASH, (&quot;[MPD_IN] Received Play command from terminal on channel %p on Service (%p)\n&quot;, com-&gt;base.on_channel, mpdin-&gt;service));</span>
<span class="lineNum">    1477 </span>            : 
<span class="lineNum">    1478 </span><span class="lineNoCov">          0 :                         if (com-&gt;play.end_range&lt;=0) {</span>
<span class="lineNum">    1479 </span><span class="lineNoCov">          0 :                                 u32 ms = (u32) ( 1000 * (-com-&gt;play.end_range) );</span>
<span class="lineNum">    1480 </span><span class="lineNoCov">          0 :                                 if (ms&lt;1000) ms = 0;</span>
<span class="lineNum">    1481 </span><span class="lineNoCov">          0 :                                 gf_dash_set_timeshift(mpdin-&gt;dash, ms);</span>
<span class="lineNum">    1482 </span><span class="lineNoCov">          0 :                         }</span>
<span class="lineNum">    1483 </span><span class="lineNoCov">          0 :                         gf_dash_seek(mpdin-&gt;dash, com-&gt;play.start_range);</span>
<span class="lineNum">    1484 </span>            : 
<span class="lineNum">    1485 </span>            :                         //to remove once we manage to keep the service alive
<span class="lineNum">    1486 </span>            :                         /*don't forward commands if a switch of period is to be scheduled, we are killing the service anyway ...*/
<span class="lineNum">    1487 </span><span class="lineNoCov">          0 :                         if (gf_dash_get_period_switch_status(mpdin-&gt;dash)) return GF_OK;</span>
<span class="lineNum">    1488 </span>            :                 }
<span class="lineNum">    1489 </span>            : 
<span class="lineNum">    1490 </span>            :                 //check if current segment playback should be aborted
<span class="lineNum">    1491 </span><span class="lineNoCov">          0 :                 com-&gt;play.dash_segment_switch = gf_dash_group_segment_switch_forced(mpdin-&gt;dash, idx);</span>
<span class="lineNum">    1492 </span>            : 
<span class="lineNum">    1493 </span><span class="lineNoCov">          0 :                 gf_dash_group_select(mpdin-&gt;dash, idx, GF_TRUE);</span>
<span class="lineNum">    1494 </span><span class="lineNoCov">          0 :                 gf_dash_set_group_done(mpdin-&gt;dash, (u32) idx, 0);</span>
<span class="lineNum">    1495 </span>            : 
<span class="lineNum">    1496 </span>            :                 //adjust start range from MPD time to media time
<span class="lineNum">    1497 </span>            :                 {
<span class="lineNum">    1498 </span>            :                         u64 pto;
<span class="lineNum">    1499 </span>            :                         u32 timescale;
<span class="lineNum">    1500 </span><span class="lineNoCov">          0 :                         com-&gt;play.start_range = gf_dash_group_get_start_range(mpdin-&gt;dash, idx);</span>
<span class="lineNum">    1501 </span><span class="lineNoCov">          0 :                         gf_dash_group_get_presentation_time_offset(mpdin-&gt;dash, idx, &amp;pto, &amp;timescale);</span>
<span class="lineNum">    1502 </span><span class="lineNoCov">          0 :                         com-&gt;play.start_range += ((Double)pto) / timescale;</span>
<span class="lineNum">    1503 </span>            :                 }
<span class="lineNum">    1504 </span>            : 
<span class="lineNum">    1505 </span><span class="lineNoCov">          0 :                 mpdin-&gt;nb_playing++;</span>
<span class="lineNum">    1506 </span><span class="lineNoCov">          0 :                 return segment_ifce-&gt;ServiceCommand(segment_ifce, com);</span>
<span class="lineNum">    1507 </span>            : 
<span class="lineNum">    1508 </span>            :         case GF_NET_CHAN_STOP:
<span class="lineNum">    1509 </span>            :         {
<span class="lineNum">    1510 </span><span class="lineNoCov">          0 :                 s32 idx = MPD_GetGroupIndexForChannel(mpdin, com-&gt;play.on_channel);</span>
<span class="lineNum">    1511 </span><span class="lineNoCov">          0 :                 if (idx&gt;=0) {</span>
<span class="lineNum">    1512 </span><span class="lineNoCov">          0 :                         gf_dash_set_group_done(mpdin-&gt;dash, (u32) idx, 1);</span>
<span class="lineNum">    1513 </span><span class="lineNoCov">          0 :                 }</span>
<span class="lineNum">    1514 </span><span class="lineNoCov">          0 :                 if (mpdin-&gt;nb_playing)</span>
<span class="lineNum">    1515 </span><span class="lineNoCov">          0 :                         mpdin-&gt;nb_playing--;</span>
<span class="lineNum">    1516 </span>            :         }
<span class="lineNum">    1517 </span><span class="lineNoCov">          0 :         return segment_ifce-&gt;ServiceCommand(segment_ifce, com);</span>
<span class="lineNum">    1518 </span>            : 
<span class="lineNum">    1519 </span>            :         /*we could get it from MPD*/
<span class="lineNum">    1520 </span>            :         case GF_NET_CHAN_GET_PIXEL_AR:
<span class="lineNum">    1521 </span>            :                 /* defer to the real input service */
<span class="lineNum">    1522 </span><span class="lineNoCov">          0 :                 return segment_ifce-&gt;ServiceCommand(segment_ifce, com);</span>
<span class="lineNum">    1523 </span>            : 
<span class="lineNum">    1524 </span>            :         case GF_NET_CHAN_SET_SPEED:
<span class="lineNum">    1525 </span><span class="lineNoCov">          0 :                 gf_dash_set_speed(mpdin-&gt;dash, com-&gt;play.speed);</span>
<span class="lineNum">    1526 </span><span class="lineNoCov">          0 :                 return segment_ifce-&gt;ServiceCommand(segment_ifce, com);</span>
<span class="lineNum">    1527 </span>            : 
<span class="lineNum">    1528 </span>            :         default:
<span class="lineNum">    1529 </span><span class="lineNoCov">          0 :                 return segment_ifce-&gt;ServiceCommand(segment_ifce, com);</span>
<span class="lineNum">    1530 </span>            :         }
<a name="1531"><span class="lineNum">    1531 </span><span class="lineNoCov">          0 : }</span></a>
<span class="lineNum">    1532 </span>            : 
<span class="lineNum">    1533 </span>            : GF_Err MPD_ChannelGetSLP(GF_InputService *plug, LPNETCHANNEL channel, char **out_data_ptr, u32 *out_data_size, GF_SLHeader *out_sl_hdr, Bool *sl_compressed, GF_Err *out_reception_status, Bool *is_new_data)
<span class="lineNum">    1534 </span>            : {
<span class="lineNum">    1535 </span><span class="lineNoCov">          0 :         GF_MPD_In *mpdin = (GF_MPD_In*) plug-&gt;priv;</span>
<span class="lineNum">    1536 </span><span class="lineNoCov">          0 :         GF_InputService *segment_ifce = MPD_GetInputServiceForChannel(mpdin, channel);</span>
<span class="lineNum">    1537 </span><span class="lineNoCov">          0 :         if (!plug || !plug-&gt;priv || !segment_ifce) return GF_SERVICE_ERROR;</span>
<span class="lineNum">    1538 </span><span class="lineNoCov">          0 :         return segment_ifce-&gt;ChannelGetSLP(segment_ifce, channel, out_data_ptr, out_data_size, out_sl_hdr, sl_compressed, out_reception_status, is_new_data);</span>
<a name="1539"><span class="lineNum">    1539 </span><span class="lineNoCov">          0 : }</span></a>
<span class="lineNum">    1540 </span>            : 
<span class="lineNum">    1541 </span>            : GF_Err MPD_ChannelReleaseSLP(GF_InputService *plug, LPNETCHANNEL channel)
<span class="lineNum">    1542 </span>            : {
<span class="lineNum">    1543 </span><span class="lineNoCov">          0 :         GF_MPD_In *mpdin = (GF_MPD_In*) plug-&gt;priv;</span>
<span class="lineNum">    1544 </span><span class="lineNoCov">          0 :         GF_InputService *segment_ifce = MPD_GetInputServiceForChannel(mpdin, channel);</span>
<span class="lineNum">    1545 </span><span class="lineNoCov">          0 :         if (!plug || !plug-&gt;priv || !segment_ifce) return GF_SERVICE_ERROR;</span>
<span class="lineNum">    1546 </span><span class="lineNoCov">          0 :         return segment_ifce-&gt;ChannelReleaseSLP(segment_ifce, channel);</span>
<a name="1547"><span class="lineNum">    1547 </span><span class="lineNoCov">          0 : }</span></a>
<span class="lineNum">    1548 </span>            : 
<span class="lineNum">    1549 </span>            : Bool MPD_CanHandleURLInService(GF_InputService *plug, const char *url)
<span class="lineNum">    1550 </span>            : {
<span class="lineNum">    1551 </span>            :         /**
<span class="lineNum">    1552 </span>            :         * May arrive when using pid:// URLs into a TS stream
<span class="lineNum">    1553 </span>            :         */
<span class="lineNum">    1554 </span><span class="lineNoCov">          0 :         GF_MPD_In *mpdin = (GF_MPD_In*) plug-&gt;priv;</span>
<span class="lineNum">    1555 </span><span class="lineNoCov">          0 :         GF_LOG(GF_LOG_DEBUG, GF_LOG_DASH, (&quot;[MPD_IN] Received Can Handle URL In Service (%p) request from terminal for %s\n&quot;, mpdin-&gt;service, url));</span>
<span class="lineNum">    1556 </span><span class="lineNoCov">          0 :         if (!plug || !plug-&gt;priv || !mpdin-&gt;dash) return GF_FALSE;</span>
<span class="lineNum">    1557 </span><span class="lineNoCov">          0 :         if (gf_dash_get_url(mpdin-&gt;dash) &amp;&amp; !strcmp(gf_dash_get_url(mpdin-&gt;dash) , url)) {</span>
<span class="lineNum">    1558 </span><span class="lineNoCov">          0 :                 return 1;</span>
<span class="lineNum">    1559 </span>            :         } else {
<span class="lineNum">    1560 </span>            :                 GF_MPDGroup *mudta;
<span class="lineNum">    1561 </span>            :                 u32 i;
<span class="lineNum">    1562 </span><span class="lineNoCov">          0 :                 for (i=0; i&lt;gf_dash_get_group_count(mpdin-&gt;dash); i++) {</span>
<span class="lineNum">    1563 </span><span class="lineNoCov">          0 :                         if (!gf_dash_is_group_selected(mpdin-&gt;dash, i)) continue;</span>
<span class="lineNum">    1564 </span>            : 
<span class="lineNum">    1565 </span><span class="lineNoCov">          0 :                         mudta = gf_dash_get_group_udta(mpdin-&gt;dash, i);</span>
<span class="lineNum">    1566 </span><span class="lineNoCov">          0 :                         if (mudta &amp;&amp; mudta-&gt;segment_ifce &amp;&amp; mudta-&gt;segment_ifce-&gt;CanHandleURLInService) {</span>
<span class="lineNum">    1567 </span><span class="lineNoCov">          0 :                                 return mudta-&gt;segment_ifce-&gt;CanHandleURLInService(plug, url);</span>
<span class="lineNum">    1568 </span>            :                         }
<span class="lineNum">    1569 </span>            :                 }
<span class="lineNum">    1570 </span><span class="lineNoCov">          0 :                 return 0;</span>
<span class="lineNum">    1571 </span>            :         }
<span class="lineNum">    1572 </span><span class="lineNoCov">          0 : }</span>
<a name="1573"><span class="lineNum">    1573 </span>            : </a>
<span class="lineNum">    1574 </span>            : GPAC_MODULE_EXPORT
<span class="lineNum">    1575 </span>            : const u32 *QueryInterfaces()
<span class="lineNum">    1576 </span>            : {
<span class="lineNum">    1577 </span>            :         static u32 si [] = {
<span class="lineNum">    1578 </span>            :                 GF_NET_CLIENT_INTERFACE,
<span class="lineNum">    1579 </span>            :                 0
<span class="lineNum">    1580 </span>            :         };
<span class="lineNum">    1581 </span><span class="lineCov">          2 :         return si;</span>
<span class="lineNum">    1582 </span>            : }
<a name="1583"><span class="lineNum">    1583 </span>            : </a>
<span class="lineNum">    1584 </span>            : GPAC_MODULE_EXPORT
<span class="lineNum">    1585 </span>            : GF_BaseInterface *LoadInterface(u32 InterfaceType)
<span class="lineNum">    1586 </span>            : {
<span class="lineNum">    1587 </span>            :         GF_MPD_In *mpdin;
<span class="lineNum">    1588 </span>            :         GF_InputService *plug;
<span class="lineNum">    1589 </span><span class="lineCov">          1 :         if (InterfaceType != GF_NET_CLIENT_INTERFACE) return NULL;</span>
<span class="lineNum">    1590 </span>            : 
<span class="lineNum">    1591 </span><span class="lineCov">          2 :         GF_SAFEALLOC(plug, GF_InputService);</span>
<span class="lineNum">    1592 </span><span class="lineCov">          1 :         if (!plug) return NULL;</span>
<span class="lineNum">    1593 </span><span class="lineCov">          1 :         GF_REGISTER_MODULE_INTERFACE(plug, GF_NET_CLIENT_INTERFACE, &quot;GPAC MPD Loader&quot;, &quot;gpac distribution&quot;)</span>
<span class="lineNum">    1594 </span>            :         
<span class="lineNum">    1595 </span><span class="lineCov">          2 :         GF_SAFEALLOC(mpdin, GF_MPD_In);</span>
<span class="lineNum">    1596 </span><span class="lineCov">          1 :         if (!mpdin) {</span>
<span class="lineNum">    1597 </span><span class="lineNoCov">          0 :                 gf_free(plug);</span>
<span class="lineNum">    1598 </span><span class="lineNoCov">          0 :                 return NULL;</span>
<span class="lineNum">    1599 </span>            :         }
<span class="lineNum">    1600 </span><span class="lineCov">          1 :         plug-&gt;priv = mpdin;</span>
<span class="lineNum">    1601 </span><span class="lineCov">          1 :         mpdin-&gt;plug = plug;</span>
<span class="lineNum">    1602 </span>            :         
<span class="lineNum">    1603 </span><span class="lineCov">          1 :         plug-&gt;RegisterMimeTypes = MPD_RegisterMimeTypes;</span>
<span class="lineNum">    1604 </span><span class="lineCov">          1 :         plug-&gt;CanHandleURL = MPD_CanHandleURL;</span>
<span class="lineNum">    1605 </span><span class="lineCov">          1 :         plug-&gt;ConnectService = MPD_ConnectService;</span>
<span class="lineNum">    1606 </span><span class="lineCov">          1 :         plug-&gt;CloseService = MPD_CloseService;</span>
<span class="lineNum">    1607 </span><span class="lineCov">          1 :         plug-&gt;GetServiceDescriptor = MPD_GetServiceDesc;</span>
<span class="lineNum">    1608 </span><span class="lineCov">          1 :         plug-&gt;ConnectChannel = MPD_ConnectChannel;</span>
<span class="lineNum">    1609 </span><span class="lineCov">          1 :         plug-&gt;DisconnectChannel = MPD_DisconnectChannel;</span>
<span class="lineNum">    1610 </span><span class="lineCov">          1 :         plug-&gt;ServiceCommand = MPD_ServiceCommand;</span>
<span class="lineNum">    1611 </span><span class="lineCov">          1 :         plug-&gt;CanHandleURLInService = MPD_CanHandleURLInService;</span>
<span class="lineNum">    1612 </span><span class="lineCov">          1 :         plug-&gt;ChannelGetSLP = MPD_ChannelGetSLP;</span>
<span class="lineNum">    1613 </span><span class="lineCov">          1 :         plug-&gt;ChannelReleaseSLP = MPD_ChannelReleaseSLP;</span>
<span class="lineNum">    1614 </span>            : 
<span class="lineNum">    1615 </span><span class="lineCov">          1 :         return (GF_BaseInterface *)plug;</span>
<span class="lineNum">    1616 </span><span class="lineCov">          1 : }</span>
<a name="1617"><span class="lineNum">    1617 </span>            : </a>
<span class="lineNum">    1618 </span>            : GPAC_MODULE_EXPORT
<span class="lineNum">    1619 </span>            : void ShutdownInterface(GF_BaseInterface *bi)
<span class="lineNum">    1620 </span>            : {
<span class="lineNum">    1621 </span>            :         GF_MPD_In *mpdin;
<span class="lineNum">    1622 </span>            : 
<span class="lineNum">    1623 </span><span class="lineCov">          1 :         if (bi-&gt;InterfaceType!=GF_NET_CLIENT_INTERFACE) return;</span>
<span class="lineNum">    1624 </span>            : 
<span class="lineNum">    1625 </span><span class="lineCov">          1 :         mpdin = (GF_MPD_In*) ((GF_InputService*)bi)-&gt;priv;</span>
<span class="lineNum">    1626 </span>            :         assert(mpdin);
<span class="lineNum">    1627 </span>            : 
<span class="lineNum">    1628 </span><span class="lineCov">          1 :         if (mpdin-&gt;dash)</span>
<span class="lineNum">    1629 </span><span class="lineNoCov">          0 :                 gf_dash_del(mpdin-&gt;dash);</span>
<span class="lineNum">    1630 </span>            : 
<span class="lineNum">    1631 </span><span class="lineCov">          1 :         gf_free(mpdin);</span>
<span class="lineNum">    1632 </span><span class="lineCov">          1 :         gf_free(bi);</span>
<span class="lineNum">    1633 </span><span class="lineCov">          2 : }</span>
<span class="lineNum">    1634 </span>            : 
<span class="lineNum">    1635 </span>            : 
<span class="lineNum">    1636 </span>            : GPAC_MODULE_STATIC_DECLARATION( mpd_in )
<span class="lineNum">    1637 </span>            : 
<span class="lineNum">    1638 </span>            : #endif //GPAC_DISABLE_DASH_CLIENT
</pre>
      </td>
    </tr>
  </table>
  <br>

  <table width="100%" border=0 cellspacing=0 cellpadding=0>
    <tr><td class="ruler"><img src="../../glass.png" width=3 height=3 alt=""></td></tr>
    <tr><td class="versionInfo">Generated by: <a href="http://ltp.sourceforge.net/coverage/lcov.php" target="_parent">LCOV version 1.12</a></td></tr>
  </table>
  <br>

</body>
</html>
