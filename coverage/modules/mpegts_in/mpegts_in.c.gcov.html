<!DOCTYPE HTML PUBLIC "-//W3C//DTD HTML 4.01 Transitional//EN">

<html lang="en">

<head>
  <meta http-equiv="Content-Type" content="text/html; charset=UTF-8">
  <title>LCOV - coverage.info - modules/mpegts_in/mpegts_in.c</title>
  <link rel="stylesheet" type="text/css" href="../../gcov.css">
</head>

<body>

  <table width="100%" border=0 cellspacing=0 cellpadding=0>
    <tr><td class="title">LCOV - code coverage report</td></tr>
    <tr><td class="ruler"><img src="../../glass.png" width=3 height=3 alt=""></td></tr>

    <tr>
      <td width="100%">
        <table cellpadding=1 border=0 width="100%">
          <tr>
            <td width="10%" class="headerItem">Current view:</td>
            <td width="35%" class="headerValue"><a href="../../index.html">top level</a> - <a href="index.html">modules/mpegts_in</a> - mpegts_in.c<span style="font-size: 80%;"> (source / <a href="mpegts_in.c.func-sort-c.html">functions</a>)</span></td>
            <td width="5%"></td>
            <td width="15%"></td>
            <td width="10%" class="headerCovTableHead">Hit</td>
            <td width="10%" class="headerCovTableHead">Total</td>
            <td width="15%" class="headerCovTableHead">Coverage</td>
          </tr>
          <tr>
            <td class="headerItem">Test:</td>
            <td class="headerValue">coverage.info</td>
            <td></td>
            <td class="headerItem">Lines:</td>
            <td class="headerCovTableEntry">60</td>
            <td class="headerCovTableEntry">966</td>
            <td class="headerCovTableEntryLo">6.2 %</td>
          </tr>
          <tr>
            <td class="headerItem">Date:</td>
            <td class="headerValue">2016-06-07 10:36:32</td>
            <td></td>
            <td class="headerItem">Functions:</td>
            <td class="headerCovTableEntry">6</td>
            <td class="headerCovTableEntry">31</td>
            <td class="headerCovTableEntryLo">19.4 %</td>
          </tr>
          <tr><td><img src="../../glass.png" width=3 height=3 alt=""></td></tr>
        </table>
      </td>
    </tr>

    <tr><td class="ruler"><img src="../../glass.png" width=3 height=3 alt=""></td></tr>
  </table>

  <table cellpadding=0 cellspacing=0 border=0>
    <tr>
      <td><br></td>
    </tr>
    <tr>
      <td>
<pre class="sourceHeading">          Line data    Source code</pre>
<pre class="source">
<a name="1"><span class="lineNum">       1 </span>            : /*</a>
<span class="lineNum">       2 </span>            :  *                      GPAC - Multimedia Framework C SDK
<span class="lineNum">       3 </span>            :  *
<span class="lineNum">       4 </span>            :  *                      Authors: Jean Le Feuvre, Cyril Concolato, Romain Bouqueau
<span class="lineNum">       5 </span>            :  *                      Copyright (c) Telecom ParisTech 2005-2012
<span class="lineNum">       6 </span>            :  *                                      All rights reserved
<span class="lineNum">       7 </span>            :  *
<span class="lineNum">       8 </span>            :  *  This file is part of GPAC / M2TS reader module
<span class="lineNum">       9 </span>            :  *
<span class="lineNum">      10 </span>            :  *  GPAC is free software; you can redistribute it and/or modify
<span class="lineNum">      11 </span>            :  *  it under the terms of the GNU Lesser General Public License as published by
<span class="lineNum">      12 </span>            :  *  the Free Software Foundation; either version 2, or (at your option)
<span class="lineNum">      13 </span>            :  *  any later version.
<span class="lineNum">      14 </span>            :  *
<span class="lineNum">      15 </span>            :  *  GPAC is distributed in the hope that it will be useful,
<span class="lineNum">      16 </span>            :  *  but WITHOUT ANY WARRANTY; without even the implied warranty of
<span class="lineNum">      17 </span>            :  *  MERCHANTABILITY or FITNESS FOR A PARTICULAR PURPOSE.  See the
<span class="lineNum">      18 </span>            :  *  GNU Lesser General Public License for more details.
<span class="lineNum">      19 </span>            :  *
<span class="lineNum">      20 </span>            :  *  You should have received a copy of the GNU Lesser General Public
<span class="lineNum">      21 </span>            :  *  License along with this library; see the file COPYING.  If not, write to
<span class="lineNum">      22 </span>            :  *  the Free Software Foundation, 675 Mass Ave, Cambridge, MA 02139, USA.
<span class="lineNum">      23 </span>            :  *
<span class="lineNum">      24 </span>            :  */
<span class="lineNum">      25 </span>            : 
<span class="lineNum">      26 </span>            : #include &lt;gpac/modules/service.h&gt;
<span class="lineNum">      27 </span>            : #include &lt;gpac/modules/codec.h&gt;
<span class="lineNum">      28 </span>            : #include &lt;gpac/mpegts.h&gt;
<span class="lineNum">      29 </span>            : #include &lt;gpac/thread.h&gt;
<span class="lineNum">      30 </span>            : #include &lt;gpac/network.h&gt;
<span class="lineNum">      31 </span>            : #include &lt;gpac/constants.h&gt;
<span class="lineNum">      32 </span>            : 
<span class="lineNum">      33 </span>            : #ifndef GPAC_DISABLE_MPEG2TS
<span class="lineNum">      34 </span>            : 
<span class="lineNum">      35 </span>            : static const char * MIMES[] = { &quot;video/mpeg-2&quot;, &quot;video/mp2t&quot;, &quot;video/mpeg&quot;, NULL};
<span class="lineNum">      36 </span>            : static const char * M2TS_EXTENSIONS = &quot;ts m2t mts dmb trp&quot;;
<span class="lineNum">      37 </span>            : 
<span class="lineNum">      38 </span>            : //when regulating data rate from file using PCR, this is the maximum sleep we tolerate
<span class="lineNum">      39 </span>            : #define M2TS_MAX_SLEEP 200
<span class="lineNum">      40 </span>            : 
<span class="lineNum">      41 </span>            : typedef struct {
<span class="lineNum">      42 </span>            :         char *fragment;
<span class="lineNum">      43 </span>            :         u32 id;
<span class="lineNum">      44 </span>            :         /*if only pid is requested*/
<span class="lineNum">      45 </span>            :         u32 pid;
<span class="lineNum">      46 </span>            : } M2TSIn_Prog;
<span class="lineNum">      47 </span>            : 
<span class="lineNum">      48 </span>            : typedef struct
<span class="lineNum">      49 </span>            : {
<span class="lineNum">      50 </span>            :         GF_M2TS_Demuxer *ts;
<span class="lineNum">      51 </span>            : 
<span class="lineNum">      52 </span>            :         GF_InputService *owner;
<span class="lineNum">      53 </span>            : 
<span class="lineNum">      54 </span>            :         GF_ClientService *service;
<span class="lineNum">      55 </span>            : 
<span class="lineNum">      56 </span>            :         Bool ts_setup;
<span class="lineNum">      57 </span>            :         Bool request_all_pids;
<span class="lineNum">      58 </span>            :         Bool is_connected;
<span class="lineNum">      59 </span>            :         Bool low_latency_mode;
<span class="lineNum">      60 </span>            :         Bool in_segment_download, first_chunk_in_seg_parsed;
<span class="lineNum">      61 </span>            :         Bool first_segment_fetched;
<span class="lineNum">      62 </span>            : 
<span class="lineNum">      63 </span>            :         Bool epg_requested;
<span class="lineNum">      64 </span>            :         Bool has_eit;
<span class="lineNum">      65 </span>            :         LPNETCHANNEL eit_channel;
<span class="lineNum">      66 </span>            : 
<span class="lineNum">      67 </span>            :         GF_Mutex *mx;
<span class="lineNum">      68 </span>            : 
<span class="lineNum">      69 </span>            :         Bool mpeg4on2_scene_only;
<span class="lineNum">      70 </span>            :         char * network_buffer;
<span class="lineNum">      71 </span>            :         u32 network_buffer_size;
<span class="lineNum">      72 </span>            : 
<span class="lineNum">      73 </span>            :         /*pick first pcr pid for regulation*/
<span class="lineNum">      74 </span>            :         u32 regulation_pcr_pid;
<span class="lineNum">      75 </span>            : 
<span class="lineNum">      76 </span>            :         Bool skip_regulation;
<span class="lineNum">      77 </span>            :         Bool has_pending_segments;
<span class="lineNum">      78 </span>            : 
<span class="lineNum">      79 </span>            :         Bool in_data_flush;
<span class="lineNum">      80 </span>            : 
<span class="lineNum">      81 </span>            :         Bool hybrid_on;
<span class="lineNum">      82 </span>            : 
<span class="lineNum">      83 </span>            :         Bool flush_sdt;
<span class="lineNum">      84 </span>            : 
<span class="lineNum">      85 </span>            :         u64 pcr_last;
<span class="lineNum">      86 </span>            :         u32 stb_at_last_pcr;
<span class="lineNum">      87 </span>            : 
<span class="lineNum">      88 </span>            :         u32 nb_paused;
<span class="lineNum">      89 </span>            :         Bool file_regulate;
<span class="lineNum">      90 </span>            :         u32 nb_playing;
<span class="lineNum">      91 </span>            :         u32 nb_prog_to_setup;
<span class="lineNum">      92 </span>            : 
<span class="lineNum">      93 </span>            :         u32 map_media_time_on_prog_id;
<span class="lineNum">      94 </span>            :         Double media_start_range;
<span class="lineNum">      95 </span>            : 
<span class="lineNum">      96 </span>            :         const char *force_temi_url;
<span class="lineNum">      97 </span>            : } M2TSIn;
<span class="lineNum">      98 </span>            : 
<span class="lineNum">      99 </span>            : 
<a name="100"><span class="lineNum">     100 </span>            : static void M2TS_GetNetworkType(GF_InputService *plug,M2TSIn *reader);</a>
<span class="lineNum">     101 </span>            : 
<span class="lineNum">     102 </span>            : static Bool M2TS_CanHandleURL(GF_InputService *plug, const char *url)
<span class="lineNum">     103 </span>            : {
<span class="lineNum">     104 </span>            :         char *sExt;
<span class="lineNum">     105 </span><span class="lineNoCov">          0 :         if (!plug || !url)</span>
<span class="lineNum">     106 </span><span class="lineNoCov">          0 :                 return 0;</span>
<span class="lineNum">     107 </span><span class="lineNoCov">          0 :         if (!strnicmp(url, &quot;udp://&quot;, 6)</span>
<span class="lineNum">     108 </span><span class="lineNoCov">          0 :                 || !strnicmp(url, &quot;mpegts-udp://&quot;, 13)</span>
<span class="lineNum">     109 </span><span class="lineNoCov">          0 :                 || !strnicmp(url, &quot;mpegts-tcp://&quot;, 13)</span>
<span class="lineNum">     110 </span>            : #ifdef GPAC_HAS_LINUX_DVB
<span class="lineNum">     111 </span>            :                 || !strnicmp(url, &quot;dvb://&quot;, 6)
<span class="lineNum">     112 </span>            : #endif
<span class="lineNum">     113 </span>            :            ) {
<span class="lineNum">     114 </span><span class="lineNoCov">          0 :                 return 1;</span>
<span class="lineNum">     115 </span>            :         }
<span class="lineNum">     116 </span>            : 
<span class="lineNum">     117 </span><span class="lineNoCov">          0 :         sExt = strrchr(url, '.');</span>
<span class="lineNum">     118 </span>            :         {
<span class="lineNum">     119 </span>            :                 int i=0;
<span class="lineNum">     120 </span><span class="lineNoCov">          0 :                 for (i = 0 ; NULL != MIMES[i]; i++)</span>
<span class="lineNum">     121 </span><span class="lineNoCov">          0 :                         if (gf_service_check_mime_register(plug, MIMES[i], M2TS_EXTENSIONS, &quot;MPEG-2 TS&quot;, sExt))</span>
<span class="lineNum">     122 </span><span class="lineNoCov">          0 :                                 return 1;</span>
<span class="lineNum">     123 </span>            :         }
<span class="lineNum">     124 </span><span class="lineNoCov">          0 :         return 0;</span>
<a name="125"><span class="lineNum">     125 </span><span class="lineNoCov">          0 : }</span></a>
<span class="lineNum">     126 </span>            : 
<span class="lineNum">     127 </span>            : static Bool M2TS_CanHandleURLInService(GF_InputService *plug, const char *url)
<span class="lineNum">     128 </span>            : {
<span class="lineNum">     129 </span>            :         Bool ret = 0;
<span class="lineNum">     130 </span>            :         M2TSIn *m2ts;
<span class="lineNum">     131 </span>            : 
<span class="lineNum">     132 </span><span class="lineNoCov">          0 :         if (!plug || !url)</span>
<span class="lineNum">     133 </span><span class="lineNoCov">          0 :                 return 0;</span>
<span class="lineNum">     134 </span><span class="lineNoCov">          0 :         m2ts = (M2TSIn *)plug-&gt;priv;</span>
<span class="lineNum">     135 </span><span class="lineNoCov">          0 :         if (!m2ts)</span>
<span class="lineNum">     136 </span><span class="lineNoCov">          0 :                 return 0;</span>
<span class="lineNum">     137 </span>            : 
<span class="lineNum">     138 </span><span class="lineNoCov">          0 :         if (!strnicmp(url, &quot;pid://&quot;, 6)) {</span>
<span class="lineNum">     139 </span><span class="lineNoCov">          0 :                 u32 pid = atoi(url+6);</span>
<span class="lineNum">     140 </span><span class="lineNoCov">          0 :                 if (pid&gt;=GF_M2TS_MAX_STREAMS) return 0;</span>
<span class="lineNum">     141 </span><span class="lineNoCov">          0 :                 if (m2ts-&gt;ts-&gt;ess[pid]) return 1;</span>
<span class="lineNum">     142 </span><span class="lineNoCov">          0 :                 return 0;</span>
<span class="lineNum">     143 </span>            :         }
<span class="lineNum">     144 </span>            : 
<span class="lineNum">     145 </span>            : #ifdef GPAC_HAS_LINUX_DVB
<span class="lineNum">     146 </span>            :         if (!stricmp(url, &quot;dvb://EPG&quot;)) return 1;
<span class="lineNum">     147 </span>            :         if (!strnicmp(url, &quot;dvb://&quot;, 6)) {
<span class="lineNum">     148 </span>            :                 GF_LOG(GF_LOG_DEBUG, GF_LOG_CONTAINER, (&quot;[DVBIn] Checking reuse of the same tuner for %s\n&quot;, url));
<span class="lineNum">     149 </span>            :                 const char *chan_conf = gf_modules_get_option((GF_BaseInterface *)plug, &quot;DVB&quot;, &quot;ChannelsFile&quot;);
<span class="lineNum">     150 </span>            :                 if (!chan_conf) {
<span class="lineNum">     151 </span>            :                         GF_LOG(GF_LOG_ERROR, GF_LOG_CONTAINER, (&quot;[DVBIn] Cannot locate channel configuration file\n&quot;));
<span class="lineNum">     152 </span>            :                         ret = 0;
<span class="lineNum">     153 </span>            :                 }
<span class="lineNum">     154 </span>            : 
<span class="lineNum">     155 </span>            :                 /* if the tuner is already tuned to the same frequence, nothing needs to be done */
<span class="lineNum">     156 </span>            :                 else if (m2ts-&gt;ts-&gt;tuner-&gt;freq != 0) {
<span class="lineNum">     157 </span>            :                         char *frag = strchr(url, '#');
<span class="lineNum">     158 </span>            :                         if (frag) frag[0] = 0;
<span class="lineNum">     159 </span>            :                         if (m2ts-&gt;ts-&gt;tuner-&gt;freq == gf_dvb_get_freq_from_url(chan_conf, url)) {
<span class="lineNum">     160 </span>            :                                 GF_LOG(GF_LOG_DEBUG, GF_LOG_CONTAINER, (&quot;[DVBIn] Reusing the same tuner for %s\n&quot;, url));
<span class="lineNum">     161 </span>            :                                 ret = 1;
<span class="lineNum">     162 </span>            :                         }
<span class="lineNum">     163 </span>            :                         if (frag) frag[0] = '#';
<span class="lineNum">     164 </span>            :                 }
<span class="lineNum">     165 </span>            :         } else
<span class="lineNum">     166 </span>            : #endif
<span class="lineNum">     167 </span><span class="lineNoCov">          0 :                 if (!strnicmp(url, &quot;udp://&quot;, 6)</span>
<span class="lineNum">     168 </span><span class="lineNoCov">          0 :                         || !strnicmp(url, &quot;mpegts-udp://&quot;, 13)</span>
<span class="lineNum">     169 </span><span class="lineNoCov">          0 :                         || !strnicmp(url, &quot;mpegts-tcp://&quot;, 13))</span>
<span class="lineNum">     170 </span>            :                 {
<span class="lineNum">     171 </span>            :                         /* TODO: check IP address ...*/
<span class="lineNum">     172 </span>            :                         ret = 0;
<span class="lineNum">     173 </span><span class="lineNoCov">          0 :                 } else {</span>
<span class="lineNum">     174 </span><span class="lineNoCov">          0 :                         char *frag = strchr(url, '#');</span>
<span class="lineNum">     175 </span><span class="lineNoCov">          0 :                         if (frag) frag[0] = 0;</span>
<span class="lineNum">     176 </span><span class="lineNoCov">          0 :                         if (!strlen(url) || !strcmp(url, m2ts-&gt;ts-&gt;filename)) {</span>
<span class="lineNum">     177 </span><span class="lineNoCov">          0 :                                 GF_LOG(GF_LOG_DEBUG, GF_LOG_CONTAINER, (&quot;[DVBIn] Reusing the same input file for %s\n&quot;, url));</span>
<span class="lineNum">     178 </span>            :                                 ret = 1;
<span class="lineNum">     179 </span><span class="lineNoCov">          0 :                         }</span>
<span class="lineNum">     180 </span><span class="lineNoCov">          0 :                         if (frag) frag[0] = '#';</span>
<span class="lineNum">     181 </span>            :                 }
<span class="lineNum">     182 </span><span class="lineNoCov">          0 :         return ret;</span>
<a name="183"><span class="lineNum">     183 </span><span class="lineNoCov">          0 : }</span></a>
<span class="lineNum">     184 </span>            : 
<span class="lineNum">     185 </span>            : static GF_ESD *MP2TS_GetESD(M2TSIn *m2ts, GF_M2TS_PES *stream, char *dsi, u32 dsi_size)
<span class="lineNum">     186 </span>            : {
<span class="lineNum">     187 </span>            :         GF_ESD *esd;
<span class="lineNum">     188 </span>            : 
<span class="lineNum">     189 </span><span class="lineNoCov">          0 :         esd = gf_odf_desc_esd_new(0);</span>
<span class="lineNum">     190 </span><span class="lineNoCov">          0 :         esd-&gt;ESID = stream-&gt;mpeg4_es_id ? stream-&gt;mpeg4_es_id : stream-&gt;pid;</span>
<span class="lineNum">     191 </span>            : 
<span class="lineNum">     192 </span><span class="lineNoCov">          0 :         switch (stream-&gt;stream_type) {</span>
<span class="lineNum">     193 </span>            :         case GF_M2TS_VIDEO_MPEG1:
<span class="lineNum">     194 </span><span class="lineNoCov">          0 :                 esd-&gt;decoderConfig-&gt;streamType = GF_STREAM_VISUAL;</span>
<span class="lineNum">     195 </span><span class="lineNoCov">          0 :                 esd-&gt;decoderConfig-&gt;objectTypeIndication = GPAC_OTI_VIDEO_MPEG1;</span>
<span class="lineNum">     196 </span><span class="lineNoCov">          0 :                 break;</span>
<span class="lineNum">     197 </span>            :         case GF_M2TS_VIDEO_MPEG2:
<span class="lineNum">     198 </span>            :         case GF_M2TS_VIDEO_DCII:
<span class="lineNum">     199 </span><span class="lineNoCov">          0 :                 esd-&gt;decoderConfig-&gt;streamType = GF_STREAM_VISUAL;</span>
<span class="lineNum">     200 </span><span class="lineNoCov">          0 :                 esd-&gt;decoderConfig-&gt;objectTypeIndication = GPAC_OTI_VIDEO_MPEG2_422;</span>
<span class="lineNum">     201 </span><span class="lineNoCov">          0 :                 break;</span>
<span class="lineNum">     202 </span>            :         case GF_M2TS_VIDEO_MPEG4:
<span class="lineNum">     203 </span><span class="lineNoCov">          0 :                 esd-&gt;decoderConfig-&gt;streamType = GF_STREAM_VISUAL;</span>
<span class="lineNum">     204 </span><span class="lineNoCov">          0 :                 esd-&gt;decoderConfig-&gt;objectTypeIndication = GPAC_OTI_VIDEO_MPEG4_PART2;</span>
<span class="lineNum">     205 </span><span class="lineNoCov">          0 :                 break;</span>
<span class="lineNum">     206 </span>            :         case GF_M2TS_VIDEO_H264:
<span class="lineNum">     207 </span><span class="lineNoCov">          0 :                 esd-&gt;decoderConfig-&gt;streamType = GF_STREAM_VISUAL;</span>
<span class="lineNum">     208 </span><span class="lineNoCov">          0 :                 esd-&gt;decoderConfig-&gt;objectTypeIndication = GPAC_OTI_VIDEO_AVC;</span>
<span class="lineNum">     209 </span><span class="lineNoCov">          0 :                 break;</span>
<span class="lineNum">     210 </span>            :         case GF_M2TS_VIDEO_SVC:
<span class="lineNum">     211 </span><span class="lineNoCov">          0 :                 esd-&gt;decoderConfig-&gt;streamType = GF_STREAM_VISUAL;</span>
<span class="lineNum">     212 </span><span class="lineNoCov">          0 :                 esd-&gt;decoderConfig-&gt;objectTypeIndication = GPAC_OTI_VIDEO_SVC;</span>
<span class="lineNum">     213 </span><span class="lineNoCov">          0 :                 break;</span>
<span class="lineNum">     214 </span>            :         case GF_M2TS_VIDEO_HEVC:
<span class="lineNum">     215 </span><span class="lineNoCov">          0 :                 esd-&gt;decoderConfig-&gt;streamType = GF_STREAM_VISUAL;</span>
<span class="lineNum">     216 </span><span class="lineNoCov">          0 :                 esd-&gt;decoderConfig-&gt;objectTypeIndication = GPAC_OTI_VIDEO_HEVC;</span>
<span class="lineNum">     217 </span><span class="lineNoCov">          0 :                 break;</span>
<span class="lineNum">     218 </span>            :         case GF_M2TS_VIDEO_SHVC:
<span class="lineNum">     219 </span><span class="lineNoCov">          0 :                 esd-&gt;decoderConfig-&gt;streamType = GF_STREAM_VISUAL;</span>
<span class="lineNum">     220 </span><span class="lineNoCov">          0 :                 esd-&gt;decoderConfig-&gt;objectTypeIndication = GPAC_OTI_VIDEO_SHVC;</span>
<span class="lineNum">     221 </span><span class="lineNoCov">          0 :                 break;</span>
<span class="lineNum">     222 </span>            :         case GF_M2TS_AUDIO_MPEG1:
<span class="lineNum">     223 </span><span class="lineNoCov">          0 :                 esd-&gt;decoderConfig-&gt;streamType = GF_STREAM_AUDIO;</span>
<span class="lineNum">     224 </span><span class="lineNoCov">          0 :                 esd-&gt;decoderConfig-&gt;objectTypeIndication = GPAC_OTI_AUDIO_MPEG1;</span>
<span class="lineNum">     225 </span><span class="lineNoCov">          0 :                 break;</span>
<span class="lineNum">     226 </span>            :         case GF_M2TS_AUDIO_MPEG2:
<span class="lineNum">     227 </span><span class="lineNoCov">          0 :                 esd-&gt;decoderConfig-&gt;streamType = GF_STREAM_AUDIO;</span>
<span class="lineNum">     228 </span><span class="lineNoCov">          0 :                 esd-&gt;decoderConfig-&gt;objectTypeIndication = GPAC_OTI_AUDIO_MPEG2_PART3;</span>
<span class="lineNum">     229 </span><span class="lineNoCov">          0 :                 break;</span>
<span class="lineNum">     230 </span>            :         case GF_M2TS_AUDIO_LATM_AAC:
<span class="lineNum">     231 </span>            :         case GF_M2TS_AUDIO_AAC:
<span class="lineNum">     232 </span>            :         case GPAC_OTI_AUDIO_AAC_MPEG2_MP:
<span class="lineNum">     233 </span>            :         case GPAC_OTI_AUDIO_AAC_MPEG2_LCP:
<span class="lineNum">     234 </span>            :         case GPAC_OTI_AUDIO_AAC_MPEG2_SSRP:
<span class="lineNum">     235 </span><span class="lineNoCov">          0 :                 if (!dsi) {</span>
<span class="lineNum">     236 </span>            :                         /*turn on parsing to get AAC config
<span class="lineNum">     237 </span>            :                                 NB: we removed &quot;no file regulation&quot; since we may get broken files where PMT declares an AAC stream but no AAC PID is in the MUX
<span class="lineNum">     238 </span>            :                                 (filtered out). In this case, &quot;no regulation&quot; will make the entire TS to be read as fast as possible
<span class="lineNum">     239 </span>            :                         */
<span class="lineNum">     240 </span><span class="lineNoCov">          0 :                         if (m2ts-&gt;ts-&gt;file) {</span>
<span class="lineNum">     241 </span><span class="lineNoCov">          0 :                                 m2ts-&gt;file_regulate = 2;</span>
<span class="lineNum">     242 </span><span class="lineNoCov">          0 :                                 gf_m2ts_pause_demux(m2ts-&gt;ts, 0);</span>
<span class="lineNum">     243 </span><span class="lineNoCov">          0 :                         }</span>
<span class="lineNum">     244 </span><span class="lineNoCov">          0 :                         gf_m2ts_set_pes_framing(stream, GF_M2TS_PES_FRAMING_DEFAULT);</span>
<span class="lineNum">     245 </span><span class="lineNoCov">          0 :                         gf_odf_desc_del((GF_Descriptor *)esd);</span>
<span class="lineNum">     246 </span><span class="lineNoCov">          0 :                         return NULL;</span>
<span class="lineNum">     247 </span>            :                 }
<span class="lineNum">     248 </span><span class="lineNoCov">          0 :                 esd-&gt;decoderConfig-&gt;streamType = GF_STREAM_AUDIO;</span>
<span class="lineNum">     249 </span><span class="lineNoCov">          0 :                 esd-&gt;decoderConfig-&gt;objectTypeIndication = GPAC_OTI_AUDIO_AAC_MPEG4;</span>
<span class="lineNum">     250 </span><span class="lineNoCov">          0 :                 break;</span>
<span class="lineNum">     251 </span>            :         case GF_M2TS_AUDIO_AC3:
<span class="lineNum">     252 </span><span class="lineNoCov">          0 :                 esd-&gt;decoderConfig-&gt;streamType = GF_STREAM_AUDIO;</span>
<span class="lineNum">     253 </span><span class="lineNoCov">          0 :                 esd-&gt;decoderConfig-&gt;objectTypeIndication = GPAC_OTI_AUDIO_AC3;</span>
<span class="lineNum">     254 </span><span class="lineNoCov">          0 :                 break;</span>
<span class="lineNum">     255 </span>            :         case GF_M2TS_AUDIO_EC3:
<span class="lineNum">     256 </span><span class="lineNoCov">          0 :                 esd-&gt;decoderConfig-&gt;streamType = GF_STREAM_AUDIO;</span>
<span class="lineNum">     257 </span><span class="lineNoCov">          0 :                 esd-&gt;decoderConfig-&gt;objectTypeIndication = GPAC_OTI_AUDIO_EAC3;</span>
<span class="lineNum">     258 </span><span class="lineNoCov">          0 :                 break;</span>
<span class="lineNum">     259 </span>            :         case GF_M2TS_SYSTEMS_MPEG4_SECTIONS:
<span class="lineNum">     260 </span>            :         default:
<span class="lineNum">     261 </span><span class="lineNoCov">          0 :                 gf_odf_desc_del((GF_Descriptor *)esd);</span>
<span class="lineNum">     262 </span><span class="lineNoCov">          0 :                 return NULL;</span>
<span class="lineNum">     263 </span>            :         }
<span class="lineNum">     264 </span><span class="lineNoCov">          0 :         esd-&gt;decoderConfig-&gt;bufferSizeDB = 0;</span>
<span class="lineNum">     265 </span>            : 
<span class="lineNum">     266 </span>            :         /*we only use AUstart indicator*/
<span class="lineNum">     267 </span><span class="lineNoCov">          0 :         esd-&gt;slConfig-&gt;useAccessUnitStartFlag = 1;</span>
<span class="lineNum">     268 </span><span class="lineNoCov">          0 :         esd-&gt;slConfig-&gt;useAccessUnitEndFlag = 0;</span>
<span class="lineNum">     269 </span><span class="lineNoCov">          0 :         esd-&gt;slConfig-&gt;useRandomAccessPointFlag = 1;</span>
<span class="lineNum">     270 </span><span class="lineNoCov">          0 :         esd-&gt;slConfig-&gt;AUSeqNumLength = 0;</span>
<span class="lineNum">     271 </span><span class="lineNoCov">          0 :         esd-&gt;slConfig-&gt;timestampResolution = 90000;</span>
<span class="lineNum">     272 </span>            : 
<span class="lineNum">     273 </span>            :         /*ASSIGN PCR here*/
<span class="lineNum">     274 </span><span class="lineNoCov">          0 :         esd-&gt;OCRESID = stream-&gt;program-&gt;pcr_pid;</span>
<span class="lineNum">     275 </span><span class="lineNoCov">          0 :         if (stream-&gt;pid == stream-&gt;program-&gt;pcr_pid) {</span>
<span class="lineNum">     276 </span><span class="lineNoCov">          0 :                 esd-&gt;slConfig-&gt;OCRResolution = 27000000;</span>
<span class="lineNum">     277 </span><span class="lineNoCov">          0 :         }</span>
<span class="lineNum">     278 </span>            : 
<span class="lineNum">     279 </span>            :         /*decoder config*/
<span class="lineNum">     280 </span><span class="lineNoCov">          0 :         if (dsi) {</span>
<span class="lineNum">     281 </span><span class="lineNoCov">          0 :                 esd-&gt;decoderConfig-&gt;decoderSpecificInfo-&gt;data = gf_malloc(sizeof(char)*dsi_size);</span>
<span class="lineNum">     282 </span><span class="lineNoCov">          0 :                 memcpy(esd-&gt;decoderConfig-&gt;decoderSpecificInfo-&gt;data, dsi, sizeof(char)*dsi_size);</span>
<span class="lineNum">     283 </span><span class="lineNoCov">          0 :                 esd-&gt;decoderConfig-&gt;decoderSpecificInfo-&gt;dataLength = dsi_size;</span>
<span class="lineNum">     284 </span><span class="lineNoCov">          0 :         }</span>
<span class="lineNum">     285 </span><span class="lineNoCov">          0 :         return esd;</span>
<a name="286"><span class="lineNum">     286 </span><span class="lineNoCov">          0 : }</span></a>
<span class="lineNum">     287 </span>            : 
<span class="lineNum">     288 </span>            : static GF_ObjectDescriptor *MP2TS_GetOD(M2TSIn *m2ts, GF_M2TS_PES *stream, char *dsi, u32 dsi_size, u32 *streamType)
<span class="lineNum">     289 </span>            : {
<span class="lineNum">     290 </span>            :         GF_ObjectDescriptor *od;
<span class="lineNum">     291 </span>            :         GF_ESD *esd;
<span class="lineNum">     292 </span>            :         u32 cur_ES, i, count;
<span class="lineNum">     293 </span>            : 
<span class="lineNum">     294 </span>            :         /*create a stream description for this channel*/
<span class="lineNum">     295 </span><span class="lineNoCov">          0 :         esd = MP2TS_GetESD(m2ts, stream, dsi, dsi_size);</span>
<span class="lineNum">     296 </span><span class="lineNoCov">          0 :         if (!esd) return NULL;</span>
<span class="lineNum">     297 </span>            : 
<span class="lineNum">     298 </span><span class="lineNoCov">          0 :         if (stream-&gt;program-&gt;is_scalable)</span>
<span class="lineNum">     299 </span><span class="lineNoCov">          0 :                 esd-&gt;has_ref_base = GF_TRUE;</span>
<span class="lineNum">     300 </span>            : 
<span class="lineNum">     301 </span>            :         /*declare object to terminal*/
<span class="lineNum">     302 </span><span class="lineNoCov">          0 :         od = (GF_ObjectDescriptor*)gf_odf_desc_new(GF_ODF_OD_TAG);</span>
<span class="lineNum">     303 </span><span class="lineNoCov">          0 :         gf_list_add(od-&gt;ESDescriptors, esd);</span>
<span class="lineNum">     304 </span><span class="lineNoCov">          0 :         od-&gt;objectDescriptorID = 0;</span>
<span class="lineNum">     305 </span><span class="lineNoCov">          0 :         if (streamType) *streamType = esd-&gt;decoderConfig-&gt;streamType;</span>
<span class="lineNum">     306 </span>            :         /*remember program number for service/program selection*/
<span class="lineNum">     307 </span><span class="lineNoCov">          0 :         od-&gt;ServiceID = stream-&gt;program-&gt;number;</span>
<span class="lineNum">     308 </span><span class="lineNoCov">          0 :         od-&gt;service_ifce = m2ts-&gt;owner;</span>
<span class="lineNum">     309 </span>            : 
<span class="lineNum">     310 </span>            :         /*create a stream description for the channels depending on this channel, set esd-&gt;dependsOnESID and add to od*/
<span class="lineNum">     311 </span><span class="lineNoCov">          0 :         cur_ES = esd-&gt;ESID;</span>
<span class="lineNum">     312 </span><span class="lineNoCov">          0 :         count = gf_list_count(stream-&gt;program-&gt;streams);</span>
<span class="lineNum">     313 </span><span class="lineNoCov">          0 :         for (i = 0; i &lt; count; i++) {</span>
<span class="lineNum">     314 </span><span class="lineNoCov">          0 :                 GF_M2TS_ES *es = (GF_M2TS_ES *)gf_list_get(stream-&gt;program-&gt;streams, i);</span>
<span class="lineNum">     315 </span><span class="lineNoCov">          0 :                 if ((es-&gt;flags &amp; GF_M2TS_ES_IS_PES) &amp;&amp; ( ((GF_M2TS_PES *)es)-&gt;depends_on_pid == cur_ES)) {</span>
<span class="lineNum">     316 </span>            :                         GF_ESD *the_esd;
<span class="lineNum">     317 </span><span class="lineNoCov">          0 :                         the_esd = MP2TS_GetESD(m2ts, (GF_M2TS_PES *)es, dsi, dsi_size);</span>
<span class="lineNum">     318 </span><span class="lineNoCov">          0 :                         if (the_esd) {</span>
<span class="lineNum">     319 </span><span class="lineNoCov">          0 :                                 the_esd-&gt;dependsOnESID = cur_ES;</span>
<span class="lineNum">     320 </span><span class="lineNoCov">          0 :                                 the_esd-&gt;has_ref_base = GF_TRUE;</span>
<span class="lineNum">     321 </span><span class="lineNoCov">          0 :                                 gf_list_add(od-&gt;ESDescriptors, the_esd);</span>
<span class="lineNum">     322 </span><span class="lineNoCov">          0 :                         }</span>
<span class="lineNum">     323 </span><span class="lineNoCov">          0 :                         cur_ES = the_esd-&gt;ESID;</span>
<span class="lineNum">     324 </span><span class="lineNoCov">          0 :                 }</span>
<span class="lineNum">     325 </span>            :         }
<span class="lineNum">     326 </span>            : 
<span class="lineNum">     327 </span><span class="lineNoCov">          0 :         return od;</span>
<a name="328"><span class="lineNum">     328 </span><span class="lineNoCov">          0 : }</span></a>
<span class="lineNum">     329 </span>            : 
<span class="lineNum">     330 </span>            : static void MP2TS_DeclareStream(M2TSIn *m2ts, GF_M2TS_PES *stream, char *dsi, u32 dsi_size)
<span class="lineNum">     331 </span>            : {
<span class="lineNum">     332 </span><span class="lineNoCov">          0 :         GF_ObjectDescriptor *od = MP2TS_GetOD(m2ts, stream, dsi, dsi_size, NULL);</span>
<span class="lineNum">     333 </span><span class="lineNoCov">          0 :         if (!od) return;</span>
<span class="lineNum">     334 </span>            :         /*declare but don't regenerate scene*/
<span class="lineNum">     335 </span><span class="lineNoCov">          0 :         gf_service_declare_media(m2ts-&gt;service, (GF_Descriptor*)od, 1);</span>
<a name="336"><span class="lineNum">     336 </span><span class="lineNoCov">          0 : }</span></a>
<span class="lineNum">     337 </span>            : 
<span class="lineNum">     338 </span>            : static void MP2TS_SetupProgram(M2TSIn *m2ts, GF_M2TS_Program *prog, Bool regenerate_scene, Bool no_declare)
<span class="lineNum">     339 </span>            : {
<span class="lineNum">     340 </span>            :         u32 i, count;
<span class="lineNum">     341 </span>            : 
<span class="lineNum">     342 </span><span class="lineNoCov">          0 :         count = gf_list_count(prog-&gt;streams);</span>
<span class="lineNum">     343 </span>            : #ifdef GPAC_HAS_LINUX_DVB
<span class="lineNum">     344 </span>            :         if (m2ts-&gt;ts-&gt;tuner) {
<span class="lineNum">     345 </span>            :                 Bool found = 0;
<span class="lineNum">     346 </span>            :                 for (i=0; i&lt;count; i++) {
<span class="lineNum">     347 </span>            :                         GF_M2TS_PES *pes = gf_list_get(prog-&gt;streams, i);
<span class="lineNum">     348 </span>            :                         if (pes-&gt;pid==m2ts-&gt;ts-&gt;tuner-&gt;vpid) found = 1;
<span class="lineNum">     349 </span>            :                         else if (pes-&gt;pid==m2ts-&gt;ts-&gt;tuner-&gt;apid) found = 1;
<span class="lineNum">     350 </span>            :                 }
<span class="lineNum">     351 </span>            :                 if (!found) return;
<span class="lineNum">     352 </span>            :         }
<span class="lineNum">     353 </span>            : #endif
<span class="lineNum">     354 </span>            : 
<span class="lineNum">     355 </span>            :         /*TS is a file, start regulation regardless of how the TS is access (with or without fragment URI)*/
<span class="lineNum">     356 </span><span class="lineNoCov">          0 :         if (m2ts-&gt;ts-&gt;file || m2ts-&gt;ts-&gt;dnload) {</span>
<span class="lineNum">     357 </span><span class="lineNoCov">          0 :                 m2ts-&gt;file_regulate = 1;</span>
<span class="lineNum">     358 </span><span class="lineNoCov">          0 :                 if (!m2ts-&gt;nb_playing) gf_m2ts_pause_demux(m2ts-&gt;ts, 1);</span>
<span class="lineNum">     359 </span>            :         }
<span class="lineNum">     360 </span>            : 
<span class="lineNum">     361 </span><span class="lineNoCov">          0 :         for (i=0; i&lt;count; i++) {</span>
<span class="lineNum">     362 </span><span class="lineNoCov">          0 :                 GF_M2TS_ES *es = gf_list_get(prog-&gt;streams, i);</span>
<span class="lineNum">     363 </span><span class="lineNoCov">          0 :                 if (es-&gt;pid==prog-&gt;pmt_pid) continue;</span>
<span class="lineNum">     364 </span><span class="lineNoCov">          0 :                 if (((GF_M2TS_PES *)es)-&gt;depends_on_pid ) {</span>
<span class="lineNum">     365 </span><span class="lineNoCov">          0 :                         prog-&gt;is_scalable = GF_TRUE;</span>
<span class="lineNum">     366 </span><span class="lineNoCov">          0 :                         break;</span>
<span class="lineNum">     367 </span>            :                 }
<span class="lineNum">     368 </span>            :         }
<span class="lineNum">     369 </span>            : 
<span class="lineNum">     370 </span><span class="lineNoCov">          0 :         for (i=0; i&lt;count; i++) {</span>
<span class="lineNum">     371 </span><span class="lineNoCov">          0 :                 GF_M2TS_ES *es = gf_list_get(prog-&gt;streams, i);</span>
<span class="lineNum">     372 </span><span class="lineNoCov">          0 :                 if (es-&gt;pid==prog-&gt;pmt_pid) continue;</span>
<span class="lineNum">     373 </span><span class="lineNoCov">          0 :                 if ((es-&gt;flags &amp; GF_M2TS_ES_IS_PES) &amp;&amp; ((GF_M2TS_PES *)es)-&gt;depends_on_pid )</span>
<span class="lineNum">     374 </span>            :                         continue;
<span class="lineNum">     375 </span>            : 
<span class="lineNum">     376 </span>            :                 /*move to skip mode for all ES until asked for playback*/
<span class="lineNum">     377 </span><span class="lineNoCov">          0 :                 if (!es-&gt;user)</span>
<span class="lineNum">     378 </span><span class="lineNoCov">          0 :                         gf_m2ts_set_pes_framing((GF_M2TS_PES *)es, GF_M2TS_PES_FRAMING_SKIP);</span>
<span class="lineNum">     379 </span>            : 
<span class="lineNum">     380 </span><span class="lineNoCov">          0 :                 if (!prog-&gt;pmt_iod &amp;&amp; !no_declare) {</span>
<span class="lineNum">     381 </span><span class="lineNoCov">          0 :                         if (! (es-&gt;flags &amp; GF_M2TS_ES_ALREADY_DECLARED)) {</span>
<span class="lineNum">     382 </span><span class="lineNoCov">          0 :                                 MP2TS_DeclareStream(m2ts, (GF_M2TS_PES *)es, NULL, 0);</span>
<span class="lineNum">     383 </span><span class="lineNoCov">          0 :                                 es-&gt;flags |= GF_M2TS_ES_ALREADY_DECLARED;</span>
<span class="lineNum">     384 </span><span class="lineNoCov">          0 :                         }</span>
<span class="lineNum">     385 </span>            :                 }
<span class="lineNum">     386 </span>            :                 /*if IOD, streams not declared through OD framework are refered to by pid:// scheme, and will be declared upon
<span class="lineNum">     387 </span>            :                 request by the terminal through GetServiceDesc*/
<span class="lineNum">     388 </span>            :         }
<span class="lineNum">     389 </span>            : 
<span class="lineNum">     390 </span>            :         /*force scene regeneration*/
<span class="lineNum">     391 </span><span class="lineNoCov">          0 :         if (!prog-&gt;pmt_iod &amp;&amp; regenerate_scene)</span>
<span class="lineNum">     392 </span><span class="lineNoCov">          0 :                 gf_service_declare_media(m2ts-&gt;service, NULL, 0);</span>
<span class="lineNum">     393 </span>            : 
<span class="lineNum">     394 </span>            : 
<span class="lineNum">     395 </span><span class="lineNoCov">          0 :         if (m2ts-&gt;nb_prog_to_setup) {</span>
<span class="lineNum">     396 </span><span class="lineNoCov">          0 :                 m2ts-&gt;nb_prog_to_setup--;</span>
<span class="lineNum">     397 </span><span class="lineNoCov">          0 :         }</span>
<a name="398"><span class="lineNum">     398 </span><span class="lineNoCov">          0 : }</span></a>
<span class="lineNum">     399 </span>            : 
<span class="lineNum">     400 </span>            : static void MP2TS_SendPacket(M2TSIn *m2ts, GF_M2TS_PES_PCK *pck)
<span class="lineNum">     401 </span>            : {
<span class="lineNum">     402 </span><span class="lineNoCov">          0 :         GF_SLHeader slh;</span>
<span class="lineNum">     403 </span>            : 
<span class="lineNum">     404 </span>            :         /*pcr not initialized, don't send any data*/
<span class="lineNum">     405 </span><span class="lineNoCov">          0 :         if (! pck-&gt;stream-&gt;program-&gt;first_dts) return;</span>
<span class="lineNum">     406 </span><span class="lineNoCov">          0 :         if (!pck-&gt;stream-&gt;user) return;</span>
<span class="lineNum">     407 </span>            : 
<span class="lineNum">     408 </span><span class="lineNoCov">          0 :         memset(&amp;slh, 0, sizeof(GF_SLHeader));</span>
<span class="lineNum">     409 </span><span class="lineNoCov">          0 :         slh.accessUnitStartFlag = (pck-&gt;flags &amp; GF_M2TS_PES_PCK_AU_START) ? 1 : 0;</span>
<span class="lineNum">     410 </span><span class="lineNoCov">          0 :         if (slh.accessUnitStartFlag) {</span>
<span class="lineNum">     411 </span><span class="lineNoCov">          0 :                 slh.compositionTimeStampFlag = 1;</span>
<span class="lineNum">     412 </span><span class="lineNoCov">          0 :                 slh.compositionTimeStamp = pck-&gt;PTS;</span>
<span class="lineNum">     413 </span><span class="lineNoCov">          0 :                 if (pck-&gt;DTS != pck-&gt;PTS) {</span>
<span class="lineNum">     414 </span><span class="lineNoCov">          0 :                         slh.decodingTimeStampFlag = 1;</span>
<span class="lineNum">     415 </span><span class="lineNoCov">          0 :                         slh.decodingTimeStamp = pck-&gt;DTS;</span>
<span class="lineNum">     416 </span><span class="lineNoCov">          0 :                 }</span>
<span class="lineNum">     417 </span><span class="lineNoCov">          0 :                 slh.randomAccessPointFlag = (pck-&gt;flags &amp; GF_M2TS_PES_PCK_RAP) ? 1 : 0;</span>
<span class="lineNum">     418 </span><span class="lineNoCov">          0 :         }</span>
<span class="lineNum">     419 </span><span class="lineNoCov">          0 :         gf_service_send_packet(m2ts-&gt;service, pck-&gt;stream-&gt;user, pck-&gt;data, pck-&gt;data_len, &amp;slh, GF_OK);</span>
<span class="lineNum">     420 </span>            : 
<a name="421"><span class="lineNum">     421 </span><span class="lineNoCov">          0 : }</span></a>
<span class="lineNum">     422 </span>            : 
<span class="lineNum">     423 </span>            : static GFINLINE void MP2TS_SendSLPacket(M2TSIn *m2ts, GF_M2TS_SL_PCK *pck)
<span class="lineNum">     424 </span>            : {
<span class="lineNum">     425 </span><span class="lineNoCov">          0 :         GF_SLHeader SLHeader, *slh = NULL;</span>
<span class="lineNum">     426 </span><span class="lineNoCov">          0 :         u32 SLHdrLen = 0;</span>
<span class="lineNum">     427 </span>            : 
<span class="lineNum">     428 </span>            :         /*build a SL Header*/
<span class="lineNum">     429 </span><span class="lineNoCov">          0 :         if (((GF_M2TS_ES*)pck-&gt;stream)-&gt;slcfg) {</span>
<span class="lineNum">     430 </span><span class="lineNoCov">          0 :                 gf_sl_depacketize(((GF_M2TS_ES*)pck-&gt;stream)-&gt;slcfg, &amp;SLHeader, pck-&gt;data, pck-&gt;data_len, &amp;SLHdrLen);</span>
<span class="lineNum">     431 </span><span class="lineNoCov">          0 :                 SLHeader.m2ts_version_number_plus_one = pck-&gt;version_number + 1;</span>
<span class="lineNum">     432 </span>            :                 slh = &amp;SLHeader;
<span class="lineNum">     433 </span><span class="lineNoCov">          0 :         }</span>
<span class="lineNum">     434 </span><span class="lineNoCov">          0 :         gf_service_send_packet(m2ts-&gt;service, pck-&gt;stream-&gt;user, pck-&gt;data+SLHdrLen, pck-&gt;data_len-SLHdrLen, slh, GF_OK);</span>
<a name="435"><span class="lineNum">     435 </span><span class="lineNoCov">          0 : }</span></a>
<span class="lineNum">     436 </span>            : 
<span class="lineNum">     437 </span>            : static GF_ObjectDescriptor *M2TS_GenerateEPG_OD(M2TSIn *m2ts)
<span class="lineNum">     438 </span>            : {
<span class="lineNum">     439 </span>            :         /* declaring a special stream for displaying eit */
<span class="lineNum">     440 </span>            :         GF_ObjectDescriptor *od;
<span class="lineNum">     441 </span>            :         GF_ESD *esd;
<span class="lineNum">     442 </span>            : 
<span class="lineNum">     443 </span>            :         /*create a stream description for this channel*/
<span class="lineNum">     444 </span><span class="lineNoCov">          0 :         esd = gf_odf_desc_esd_new(0);</span>
<span class="lineNum">     445 </span><span class="lineNoCov">          0 :         esd-&gt;ESID = GF_M2TS_PID_EIT_ST_CIT;</span>
<span class="lineNum">     446 </span><span class="lineNoCov">          0 :         esd-&gt;OCRESID = GF_M2TS_PID_EIT_ST_CIT;</span>
<span class="lineNum">     447 </span><span class="lineNoCov">          0 :         esd-&gt;decoderConfig-&gt;streamType = GF_STREAM_PRIVATE_SCENE;</span>
<span class="lineNum">     448 </span><span class="lineNoCov">          0 :         esd-&gt;decoderConfig-&gt;objectTypeIndication = GPAC_OTI_PRIVATE_SCENE_EPG;</span>
<span class="lineNum">     449 </span><span class="lineNoCov">          0 :         esd-&gt;decoderConfig-&gt;bufferSizeDB = 0;</span>
<span class="lineNum">     450 </span>            : 
<span class="lineNum">     451 </span>            :         /*we only use AUstart indicator*/
<span class="lineNum">     452 </span><span class="lineNoCov">          0 :         esd-&gt;slConfig-&gt;useAccessUnitStartFlag = 1;</span>
<span class="lineNum">     453 </span><span class="lineNoCov">          0 :         esd-&gt;slConfig-&gt;useRandomAccessPointFlag = 1;</span>
<span class="lineNum">     454 </span><span class="lineNoCov">          0 :         esd-&gt;slConfig-&gt;timestampResolution = 90000;</span>
<span class="lineNum">     455 </span>            : 
<span class="lineNum">     456 </span>            :         /*declare object to terminal*/
<span class="lineNum">     457 </span><span class="lineNoCov">          0 :         od = (GF_ObjectDescriptor*)gf_odf_desc_new(GF_ODF_OD_TAG);</span>
<span class="lineNum">     458 </span><span class="lineNoCov">          0 :         gf_list_add(od-&gt;ESDescriptors, esd);</span>
<span class="lineNum">     459 </span><span class="lineNoCov">          0 :         od-&gt;objectDescriptorID = 0;</span>
<span class="lineNum">     460 </span><span class="lineNoCov">          0 :         od-&gt;service_ifce = m2ts-&gt;owner;</span>
<span class="lineNum">     461 </span><span class="lineNoCov">          0 :         return od;</span>
<a name="462"><span class="lineNum">     462 </span>            : }</a>
<span class="lineNum">     463 </span>            : 
<span class="lineNum">     464 </span>            : static void M2TS_FlushRequested(M2TSIn *m2ts)
<span class="lineNum">     465 </span>            : {
<span class="lineNum">     466 </span>            :         u32 i, j, req_prog_count, count, prog_id, found;
<span class="lineNum">     467 </span>            : 
<span class="lineNum">     468 </span><span class="lineNoCov">          0 :         gf_mx_p(m2ts-&gt;mx);</span>
<span class="lineNum">     469 </span>            : 
<span class="lineNum">     470 </span><span class="lineNoCov">          0 :         count = gf_list_count(m2ts-&gt;ts-&gt;programs);</span>
<span class="lineNum">     471 </span><span class="lineNoCov">          0 :         for (j=0; j&lt;count; j++) {</span>
<span class="lineNum">     472 </span><span class="lineNoCov">          0 :                 GF_M2TS_Program *ts_prog = gf_list_get(m2ts-&gt;ts-&gt;programs, j);</span>
<span class="lineNum">     473 </span>            :                 //PMT not yet received, do not allow playback regulation
<span class="lineNum">     474 </span><span class="lineNoCov">          0 :                 if (!ts_prog-&gt;pcr_pid) {</span>
<span class="lineNum">     475 </span><span class="lineNoCov">          0 :                         m2ts-&gt;file_regulate = 0;</span>
<span class="lineNum">     476 </span><span class="lineNoCov">          0 :                         gf_m2ts_pause_demux(m2ts-&gt;ts, 0);</span>
<span class="lineNum">     477 </span><span class="lineNoCov">          0 :                         gf_mx_v(m2ts-&gt;mx);</span>
<span class="lineNum">     478 </span><span class="lineNoCov">          0 :                         return;</span>
<span class="lineNum">     479 </span>            :                 }
<span class="lineNum">     480 </span>            :         }
<span class="lineNum">     481 </span>            : 
<span class="lineNum">     482 </span>            : 
<span class="lineNum">     483 </span>            :         found = 0;
<span class="lineNum">     484 </span><span class="lineNoCov">          0 :         count = gf_list_count(m2ts-&gt;ts-&gt;requested_pids);</span>
<span class="lineNum">     485 </span><span class="lineNoCov">          0 :         for (i=0; i&lt;count; i++) {</span>
<span class="lineNum">     486 </span><span class="lineNoCov">          0 :                 M2TSIn_Prog *req_pid = gf_list_get(m2ts-&gt;ts-&gt;requested_pids, i);</span>
<span class="lineNum">     487 </span><span class="lineNoCov">          0 :                 GF_M2TS_ES *es = m2ts-&gt;ts-&gt;ess[req_pid-&gt;pid];</span>
<span class="lineNum">     488 </span><span class="lineNoCov">          0 :                 if (es==NULL) continue;</span>
<span class="lineNum">     489 </span>            : 
<span class="lineNum">     490 </span>            :                 /*move to skip mode for all PES until asked for playback*/
<span class="lineNum">     491 </span><span class="lineNoCov">          0 :                 if (!(es-&gt;flags &amp; GF_M2TS_ES_IS_SECTION) &amp;&amp; !es-&gt;user)</span>
<span class="lineNum">     492 </span><span class="lineNoCov">          0 :                         gf_m2ts_set_pes_framing((GF_M2TS_PES *)es, GF_M2TS_PES_FRAMING_SKIP);</span>
<span class="lineNum">     493 </span><span class="lineNoCov">          0 :                 MP2TS_DeclareStream(m2ts, (GF_M2TS_PES *)es, NULL, 0);</span>
<span class="lineNum">     494 </span><span class="lineNoCov">          0 :                 gf_list_rem(m2ts-&gt;ts-&gt;requested_pids, i);</span>
<span class="lineNum">     495 </span><span class="lineNoCov">          0 :                 gf_free(req_pid);</span>
<span class="lineNum">     496 </span><span class="lineNoCov">          0 :                 i--;</span>
<span class="lineNum">     497 </span><span class="lineNoCov">          0 :                 count--;</span>
<span class="lineNum">     498 </span><span class="lineNoCov">          0 :                 found++;</span>
<span class="lineNum">     499 </span><span class="lineNoCov">          0 :         }</span>
<span class="lineNum">     500 </span><span class="lineNoCov">          0 :         req_prog_count = gf_list_count(m2ts-&gt;ts-&gt;requested_progs);</span>
<span class="lineNum">     501 </span><span class="lineNoCov">          0 :         for (i = 0; i &lt; req_prog_count; i++) {</span>
<span class="lineNum">     502 </span><span class="lineNoCov">          0 :                 M2TSIn_Prog *req_prog = gf_list_get(m2ts-&gt;ts-&gt;requested_progs, i);</span>
<span class="lineNum">     503 </span>            : 
<span class="lineNum">     504 </span><span class="lineNoCov">          0 :                 prog_id = atoi(req_prog-&gt;fragment);</span>
<span class="lineNum">     505 </span><span class="lineNoCov">          0 :                 count = gf_list_count(m2ts-&gt;ts-&gt;SDTs);</span>
<span class="lineNum">     506 </span><span class="lineNoCov">          0 :                 for (j=0; j&lt;count; j++) {</span>
<span class="lineNum">     507 </span><span class="lineNoCov">          0 :                         GF_M2TS_SDT *sdt = gf_list_get(m2ts-&gt;ts-&gt;SDTs, j);</span>
<span class="lineNum">     508 </span><span class="lineNoCov">          0 :                         if (!stricmp((const char *) sdt-&gt;service, req_prog-&gt;fragment)) req_prog-&gt;id = sdt-&gt;service_id;</span>
<span class="lineNum">     509 </span><span class="lineNoCov">          0 :                         else if (sdt-&gt;service_id==prog_id)  req_prog-&gt;id = sdt-&gt;service_id;</span>
<span class="lineNum">     510 </span>            :                 }
<span class="lineNum">     511 </span><span class="lineNoCov">          0 :                 if (!req_prog-&gt;id) {</span>
<span class="lineNum">     512 </span><span class="lineNoCov">          0 :                         count = gf_list_count(m2ts-&gt;ts-&gt;programs);</span>
<span class="lineNum">     513 </span><span class="lineNoCov">          0 :                         for (j=0; j&lt;count; j++) {</span>
<span class="lineNum">     514 </span><span class="lineNoCov">          0 :                                 GF_M2TS_Program *ts_prog = gf_list_get(m2ts-&gt;ts-&gt;programs, j);</span>
<span class="lineNum">     515 </span><span class="lineNoCov">          0 :                                 if (prog_id==ts_prog-&gt;number) {</span>
<span class="lineNum">     516 </span><span class="lineNoCov">          0 :                                         req_prog-&gt;id = prog_id;</span>
<span class="lineNum">     517 </span><span class="lineNoCov">          0 :                                         break;</span>
<span class="lineNum">     518 </span>            :                                 }
<span class="lineNum">     519 </span>            :                         }
<span class="lineNum">     520 </span>            :                 }
<span class="lineNum">     521 </span><span class="lineNoCov">          0 :                 if (req_prog-&gt;id) {</span>
<span class="lineNum">     522 </span>            :                         GF_M2TS_Program *ts_prog;
<span class="lineNum">     523 </span><span class="lineNoCov">          0 :                         count = gf_list_count(m2ts-&gt;ts-&gt;programs);</span>
<span class="lineNum">     524 </span><span class="lineNoCov">          0 :                         for (j=0; j&lt;count; j++) {</span>
<span class="lineNum">     525 </span><span class="lineNoCov">          0 :                                 ts_prog = gf_list_get(m2ts-&gt;ts-&gt;programs, j);</span>
<span class="lineNum">     526 </span><span class="lineNoCov">          0 :                                 if (ts_prog-&gt;number==req_prog-&gt;id) {</span>
<span class="lineNum">     527 </span><span class="lineNoCov">          0 :                                         MP2TS_SetupProgram(m2ts, ts_prog, 0, 0);</span>
<span class="lineNum">     528 </span><span class="lineNoCov">          0 :                                         found++;</span>
<span class="lineNum">     529 </span><span class="lineNoCov">          0 :                                         gf_free(req_prog-&gt;fragment);</span>
<span class="lineNum">     530 </span><span class="lineNoCov">          0 :                                         gf_free(req_prog);</span>
<span class="lineNum">     531 </span><span class="lineNoCov">          0 :                                         gf_list_rem(m2ts-&gt;ts-&gt;requested_progs, i);</span>
<span class="lineNum">     532 </span><span class="lineNoCov">          0 :                                         req_prog_count--;</span>
<span class="lineNum">     533 </span><span class="lineNoCov">          0 :                                         i--;</span>
<span class="lineNum">     534 </span><span class="lineNoCov">          0 :                                         break;</span>
<span class="lineNum">     535 </span>            :                                 }
<span class="lineNum">     536 </span>            :                         }
<span class="lineNum">     537 </span>            :                 }
<span class="lineNum">     538 </span>            :         }
<span class="lineNum">     539 </span>            : 
<span class="lineNum">     540 </span><span class="lineNoCov">          0 :         if (m2ts-&gt;epg_requested) {</span>
<span class="lineNum">     541 </span><span class="lineNoCov">          0 :                 if (!m2ts-&gt;has_eit) {</span>
<span class="lineNum">     542 </span><span class="lineNoCov">          0 :                         GF_ObjectDescriptor *od = M2TS_GenerateEPG_OD(m2ts);</span>
<span class="lineNum">     543 </span>            :                         /*declare but don't regenerate scene*/
<span class="lineNum">     544 </span><span class="lineNoCov">          0 :                         gf_service_declare_media(m2ts-&gt;service, (GF_Descriptor*)od, 0);</span>
<span class="lineNum">     545 </span><span class="lineNoCov">          0 :                         m2ts-&gt;has_eit = 1;</span>
<span class="lineNum">     546 </span><span class="lineNoCov">          0 :                 }</span>
<span class="lineNum">     547 </span>            :         } else {
<span class="lineNum">     548 </span>            :                 /*force scene regeneration only when EPG is not requested*/
<span class="lineNum">     549 </span><span class="lineNoCov">          0 :                 if (found)</span>
<span class="lineNum">     550 </span><span class="lineNoCov">          0 :                         gf_service_declare_media(m2ts-&gt;service, NULL, 0);</span>
<span class="lineNum">     551 </span>            :         }
<span class="lineNum">     552 </span>            : 
<span class="lineNum">     553 </span><span class="lineNoCov">          0 :         gf_mx_v(m2ts-&gt;mx);</span>
<a name="554"><span class="lineNum">     554 </span><span class="lineNoCov">          0 : }</span></a>
<span class="lineNum">     555 </span>            : 
<span class="lineNum">     556 </span>            : static void forward_m2ts_event(M2TSIn *m2ts, u32 evt_type, void *param)
<span class="lineNum">     557 </span>            : {
<span class="lineNum">     558 </span><span class="lineNoCov">          0 :         GF_NetworkCommand com;</span>
<span class="lineNum">     559 </span><span class="lineNoCov">          0 :         memset(&amp;com, 0, sizeof(com));</span>
<span class="lineNum">     560 </span>            : 
<span class="lineNum">     561 </span><span class="lineNoCov">          0 :         com.command_type = GF_NET_SERVICE_EVENT;</span>
<span class="lineNum">     562 </span><span class="lineNoCov">          0 :         com.send_event.evt.type = GF_EVENT_FROM_SERVICE;</span>
<span class="lineNum">     563 </span><span class="lineNoCov">          0 :         com.send_event.evt.from_service.forward_type = GF_EVT_MPEG2;</span>
<span class="lineNum">     564 </span><span class="lineNoCov">          0 :         com.send_event.evt.from_service.service_event_type = evt_type;</span>
<span class="lineNum">     565 </span><span class="lineNoCov">          0 :         com.send_event.evt.from_service.param = param;</span>
<span class="lineNum">     566 </span><span class="lineNoCov">          0 :         gf_service_command(m2ts-&gt;service, &amp;com, GF_OK);</span>
<a name="567"><span class="lineNum">     567 </span><span class="lineNoCov">          0 : }</span></a>
<span class="lineNum">     568 </span>            : 
<span class="lineNum">     569 </span>            : static void M2TS_OnEvent(GF_M2TS_Demuxer *ts, u32 evt_type, void *param)
<span class="lineNum">     570 </span>            : {
<span class="lineNum">     571 </span><span class="lineNoCov">          0 :         M2TSIn *m2ts = (M2TSIn *) ts-&gt;user;</span>
<span class="lineNum">     572 </span>            : 
<span class="lineNum">     573 </span><span class="lineNoCov">          0 :         switch (evt_type) {</span>
<span class="lineNum">     574 </span>            :         case GF_M2TS_EVT_PAT_UPDATE:
<span class="lineNum">     575 </span>            :                 /*      example code showing how to forward an event from MPEG-2 TS input service to GPAC user*/
<span class="lineNum">     576 </span>            : #if 0
<span class="lineNum">     577 </span>            :                 send_m2ts_event(m2ts, evt_type, param);
<span class="lineNum">     578 </span>            : #endif
<span class="lineNum">     579 </span>            :                 break;
<span class="lineNum">     580 </span>            :         case GF_M2TS_EVT_AIT_FOUND:
<span class="lineNum">     581 </span><span class="lineNoCov">          0 :                 forward_m2ts_event(m2ts, evt_type, param);</span>
<span class="lineNum">     582 </span><span class="lineNoCov">          0 :                 break;</span>
<span class="lineNum">     583 </span>            :         case GF_M2TS_EVT_PAT_FOUND:
<span class="lineNum">     584 </span>            :                 /* In case the TS has one program, wait for the PMT to send connect, in case of IOD in PMT */
<span class="lineNum">     585 </span><span class="lineNoCov">          0 :                 if (gf_list_count(m2ts-&gt;ts-&gt;programs) != 1) {</span>
<span class="lineNum">     586 </span><span class="lineNoCov">          0 :                         gf_service_connect_ack(m2ts-&gt;service, NULL, GF_OK);</span>
<span class="lineNum">     587 </span><span class="lineNoCov">          0 :                         m2ts-&gt;is_connected = 1;</span>
<span class="lineNum">     588 </span><span class="lineNoCov">          0 :                 }</span>
<span class="lineNum">     589 </span>            :                 /* Send the TS to the a user if needed. Useful to check the number of received programs*/
<span class="lineNum">     590 </span><span class="lineNoCov">          0 :                 forward_m2ts_event(m2ts, evt_type, param);</span>
<span class="lineNum">     591 </span>            : 
<span class="lineNum">     592 </span><span class="lineNoCov">          0 :                 m2ts-&gt;nb_prog_to_setup = gf_list_count(m2ts-&gt;ts-&gt;programs) ;</span>
<span class="lineNum">     593 </span>            : 
<span class="lineNum">     594 </span><span class="lineNoCov">          0 :                 break;</span>
<span class="lineNum">     595 </span>            :         case GF_M2TS_EVT_DSMCC_FOUND:
<span class="lineNum">     596 </span><span class="lineNoCov">          0 :                 forward_m2ts_event(m2ts, evt_type, param);</span>
<span class="lineNum">     597 </span><span class="lineNoCov">          0 :                 break;</span>
<span class="lineNum">     598 </span>            :         case GF_M2TS_EVT_PMT_FOUND:
<span class="lineNum">     599 </span><span class="lineNoCov">          0 :                 if (gf_list_count(m2ts-&gt;ts-&gt;programs) == 1) {</span>
<span class="lineNum">     600 </span><span class="lineNoCov">          0 :                         gf_service_connect_ack(m2ts-&gt;service, NULL, GF_OK);</span>
<span class="lineNum">     601 </span><span class="lineNoCov">          0 :                         m2ts-&gt;is_connected = 1;</span>
<span class="lineNum">     602 </span><span class="lineNoCov">          0 :                 }</span>
<span class="lineNum">     603 </span>            :                 /*do not declare if  single program was requested for playback*/
<span class="lineNum">     604 </span><span class="lineNoCov">          0 :                 MP2TS_SetupProgram(m2ts, param, m2ts-&gt;request_all_pids, m2ts-&gt;request_all_pids ? 0 : 1);</span>
<span class="lineNum">     605 </span><span class="lineNoCov">          0 :                 M2TS_FlushRequested(m2ts);</span>
<span class="lineNum">     606 </span>            :                 /* Send the TS to the a user if needed. Useful to check the number of received programs*/
<span class="lineNum">     607 </span><span class="lineNoCov">          0 :                 forward_m2ts_event(m2ts, evt_type, param);</span>
<span class="lineNum">     608 </span><span class="lineNoCov">          0 :                 break;</span>
<span class="lineNum">     609 </span>            :         case GF_M2TS_EVT_PMT_REPEAT:
<span class="lineNum">     610 </span><span class="lineNoCov">          0 :                 M2TS_FlushRequested(m2ts);</span>
<span class="lineNum">     611 </span><span class="lineNoCov">          0 :                 break;</span>
<span class="lineNum">     612 </span>            :         case GF_M2TS_EVT_PMT_UPDATE:
<span class="lineNum">     613 </span><span class="lineNoCov">          0 :                 MP2TS_SetupProgram(m2ts, param, GF_TRUE, GF_FALSE);</span>
<span class="lineNum">     614 </span><span class="lineNoCov">          0 :                 break;</span>
<span class="lineNum">     615 </span>            : 
<span class="lineNum">     616 </span>            :         case GF_M2TS_EVT_SDT_FOUND:
<span class="lineNum">     617 </span>            :         case GF_M2TS_EVT_SDT_UPDATE:
<span class="lineNum">     618 </span><span class="lineNoCov">          0 :                 m2ts-&gt;flush_sdt = 1;</span>
<span class="lineNum">     619 </span>            :         case GF_M2TS_EVT_SDT_REPEAT:
<span class="lineNum">     620 </span><span class="lineNoCov">          0 :                 M2TS_FlushRequested(m2ts);</span>
<span class="lineNum">     621 </span><span class="lineNoCov">          0 :                 if (m2ts-&gt;flush_sdt) {</span>
<span class="lineNum">     622 </span><span class="lineNoCov">          0 :                         GF_NetworkCommand com;</span>
<span class="lineNum">     623 </span><span class="lineNoCov">          0 :                         m2ts-&gt;flush_sdt = 0;</span>
<span class="lineNum">     624 </span><span class="lineNoCov">          0 :                         memset(&amp;com, 0, sizeof(GF_NetworkCommand));</span>
<span class="lineNum">     625 </span><span class="lineNoCov">          0 :                         com.base.command_type = GF_NET_SERVICE_INFO;</span>
<span class="lineNum">     626 </span><span class="lineNoCov">          0 :                         gf_service_command(m2ts-&gt;service, &amp;com, GF_OK);</span>
<span class="lineNum">     627 </span><span class="lineNoCov">          0 :                 }</span>
<span class="lineNum">     628 </span>            :                 break;
<span class="lineNum">     629 </span>            :         case GF_M2TS_EVT_DVB_GENERAL:
<span class="lineNum">     630 </span><span class="lineNoCov">          0 :                 if (m2ts-&gt;eit_channel) {</span>
<span class="lineNum">     631 </span><span class="lineNoCov">          0 :                         GF_M2TS_SL_PCK *pck = (GF_M2TS_SL_PCK *)param;</span>
<span class="lineNum">     632 </span><span class="lineNoCov">          0 :                         gf_service_send_packet(m2ts-&gt;service, m2ts-&gt;eit_channel, pck-&gt;data, pck-&gt;data_len, NULL, GF_OK);</span>
<span class="lineNum">     633 </span><span class="lineNoCov">          0 :                 }</span>
<span class="lineNum">     634 </span>            :                 break;
<span class="lineNum">     635 </span>            :         case GF_M2TS_EVT_PES_PCK:
<span class="lineNum">     636 </span><span class="lineNoCov">          0 :                 MP2TS_SendPacket(m2ts, param);</span>
<span class="lineNum">     637 </span><span class="lineNoCov">          0 :                 break;</span>
<span class="lineNum">     638 </span>            :         case GF_M2TS_EVT_SL_PCK: /* DMB specific */
<span class="lineNum">     639 </span><span class="lineNoCov">          0 :                 MP2TS_SendSLPacket(m2ts, param);</span>
<span class="lineNum">     640 </span><span class="lineNoCov">          0 :                 break;</span>
<span class="lineNum">     641 </span>            :         case GF_M2TS_EVT_EOS:
<span class="lineNum">     642 </span><span class="lineNoCov">          0 :                 gf_service_send_packet(m2ts-&gt;service, ((GF_M2TS_PES *)param)-&gt;user, NULL, 0, NULL, GF_EOS);</span>
<span class="lineNum">     643 </span><span class="lineNoCov">          0 :                 break;</span>
<span class="lineNum">     644 </span>            :         case GF_M2TS_EVT_AAC_CFG:
<span class="lineNum">     645 </span>            :         {
<span class="lineNum">     646 </span><span class="lineNoCov">          0 :                 GF_M2TS_PES_PCK *pck = (GF_M2TS_PES_PCK*)param;</span>
<span class="lineNum">     647 </span><span class="lineNoCov">          0 :                 if (!pck-&gt;stream-&gt;first_dts) {</span>
<span class="lineNum">     648 </span><span class="lineNoCov">          0 :                         gf_m2ts_set_pes_framing(pck-&gt;stream, GF_M2TS_PES_FRAMING_SKIP_NO_RESET);</span>
<span class="lineNum">     649 </span><span class="lineNoCov">          0 :                         MP2TS_DeclareStream(m2ts, pck-&gt;stream, pck-&gt;data, pck-&gt;data_len);</span>
<span class="lineNum">     650 </span><span class="lineNoCov">          0 :                         if (ts-&gt;file || ts-&gt;dnload) {</span>
<span class="lineNum">     651 </span><span class="lineNoCov">          0 :                                 m2ts-&gt;file_regulate = 1;</span>
<span class="lineNum">     652 </span><span class="lineNoCov">          0 :                                 if (!m2ts-&gt;nb_playing) gf_m2ts_pause_demux(m2ts-&gt;ts, 1);</span>
<span class="lineNum">     653 </span>            : 
<span class="lineNum">     654 </span>            :                         }
<span class="lineNum">     655 </span><span class="lineNoCov">          0 :                         pck-&gt;stream-&gt;first_dts=1;</span>
<span class="lineNum">     656 </span>            :                         /*force scene regeneration*/
<span class="lineNum">     657 </span><span class="lineNoCov">          0 :                         gf_service_declare_media(m2ts-&gt;service, NULL, 0);</span>
<span class="lineNum">     658 </span><span class="lineNoCov">          0 :                 }</span>
<span class="lineNum">     659 </span>            :         }
<span class="lineNum">     660 </span>            :         break;
<span class="lineNum">     661 </span>            :         case GF_M2TS_EVT_PES_PCR:
<span class="lineNum">     662 </span>            :         {
<span class="lineNum">     663 </span><span class="lineNoCov">          0 :                 Bool discontinuity = ( ((GF_M2TS_PES_PCK *) param)-&gt;flags &amp; GF_M2TS_PES_PCK_DISCONTINUITY) ? 1 : 0;</span>
<span class="lineNum">     664 </span>            :                 GF_M2TS_PES_PCK *pck;
<span class="lineNum">     665 </span>            :                 /*send pcr*/
<span class="lineNum">     666 </span><span class="lineNoCov">          0 :                 if (((GF_M2TS_PES_PCK *) param)-&gt;stream &amp;&amp; ((GF_M2TS_PES_PCK *) param)-&gt;stream-&gt;user) {</span>
<span class="lineNum">     667 </span><span class="lineNoCov">          0 :                         GF_SLHeader slh;</span>
<span class="lineNum">     668 </span><span class="lineNoCov">          0 :                         memset(&amp;slh, 0, sizeof(GF_SLHeader) );</span>
<span class="lineNum">     669 </span><span class="lineNoCov">          0 :                         slh.OCRflag = 1;</span>
<span class="lineNum">     670 </span><span class="lineNoCov">          0 :                         slh.m2ts_pcr = discontinuity ? 2 : 1;</span>
<span class="lineNum">     671 </span><span class="lineNoCov">          0 :                         slh.objectClockReference = ((GF_M2TS_PES_PCK *) param)-&gt;PTS;</span>
<span class="lineNum">     672 </span>            : 
<span class="lineNum">     673 </span>            :                         //check if our buffer level is low enough otherwise we would send the OCR_disc way too early
<span class="lineNum">     674 </span>            :                         //we have to do this because the terminal doesn't &quot;queue&quot; clock discontinuities
<span class="lineNum">     675 </span><span class="lineNoCov">          0 :                         if (m2ts-&gt;file_regulate &amp;&amp; discontinuity) {</span>
<span class="lineNum">     676 </span>            :                                 /*query buffer level, don't sleep if too low*/
<span class="lineNum">     677 </span><span class="lineNoCov">          0 :                                 GF_NetworkCommand com;</span>
<span class="lineNum">     678 </span><span class="lineNoCov">          0 :                                 memset(&amp;com, 0, sizeof(GF_NetworkCommand));</span>
<span class="lineNum">     679 </span><span class="lineNoCov">          0 :                                 com.command_type = GF_NET_BUFFER_QUERY;</span>
<span class="lineNum">     680 </span><span class="lineNoCov">          0 :                                 com.base.on_channel = NULL;</span>
<span class="lineNum">     681 </span><span class="lineNoCov">          0 :                                 while (ts-&gt;run_state) {</span>
<span class="lineNum">     682 </span><span class="lineNoCov">          0 :                                         gf_service_command(m2ts-&gt;service, &amp;com, GF_OK);</span>
<span class="lineNum">     683 </span><span class="lineNoCov">          0 :                                         if (!com.buffer.occupancy || com.buffer.buffering) {</span>
<span class="lineNum">     684 </span>            :                                                 break;
<span class="lineNum">     685 </span>            :                                         }
<span class="lineNum">     686 </span><span class="lineNoCov">          0 :                                         gf_sleep(1);</span>
<span class="lineNum">     687 </span><span class="lineNoCov">          0 :                                 }</span>
<span class="lineNum">     688 </span><span class="lineNoCov">          0 :                         }</span>
<span class="lineNum">     689 </span>            : 
<span class="lineNum">     690 </span><span class="lineNoCov">          0 :                         gf_service_send_packet(m2ts-&gt;service, ((GF_M2TS_PES_PCK *) param)-&gt;stream-&gt;user, NULL, 0, &amp;slh, GF_OK);</span>
<span class="lineNum">     691 </span>            : 
<span class="lineNum">     692 </span><span class="lineNoCov">          0 :                         if ( m2ts-&gt;map_media_time_on_prog_id &amp;&amp; !ts-&gt;start_range &amp;&amp; (m2ts-&gt;map_media_time_on_prog_id==((GF_M2TS_PES_PCK *) param)-&gt;stream-&gt;program-&gt;number)) {</span>
<span class="lineNum">     693 </span><span class="lineNoCov">          0 :                                 GF_NetworkCommand com;</span>
<span class="lineNum">     694 </span><span class="lineNoCov">          0 :                                 memset(&amp;com, 0, sizeof(com));</span>
<span class="lineNum">     695 </span><span class="lineNoCov">          0 :                                 com.command_type = GF_NET_CHAN_SET_MEDIA_TIME;</span>
<span class="lineNum">     696 </span><span class="lineNoCov">          0 :                                 com.map_time.media_time = m2ts-&gt;media_start_range;</span>
<span class="lineNum">     697 </span><span class="lineNoCov">          0 :                                 com.map_time.timestamp = slh.objectClockReference / 300;</span>
<span class="lineNum">     698 </span><span class="lineNoCov">          0 :                                 com.base.on_channel = ((GF_M2TS_PES_PCK *) param)-&gt;stream-&gt;user;</span>
<span class="lineNum">     699 </span><span class="lineNoCov">          0 :                                 gf_service_command(m2ts-&gt;service, &amp;com, GF_OK);</span>
<span class="lineNum">     700 </span><span class="lineNoCov">          0 :                                 m2ts-&gt;map_media_time_on_prog_id = 0;</span>
<span class="lineNum">     701 </span><span class="lineNoCov">          0 :                                 m2ts-&gt;pcr_last = 0;</span>
<span class="lineNum">     702 </span><span class="lineNoCov">          0 :                         }</span>
<span class="lineNum">     703 </span><span class="lineNoCov">          0 :                 }</span>
<span class="lineNum">     704 </span>            :                 pck = (GF_M2TS_PES_PCK *) param;
<span class="lineNum">     705 </span><span class="lineNoCov">          0 :                 if (pck-&gt;stream &amp;&amp; pck-&gt;stream-&gt;program) pck-&gt;stream-&gt;program-&gt;first_dts = 1;</span>
<span class="lineNum">     706 </span>            : 
<span class="lineNum">     707 </span><span class="lineNoCov">          0 :                 if (discontinuity) {</span>
<span class="lineNum">     708 </span><span class="lineNoCov">          0 :                         GF_LOG(GF_LOG_WARNING, GF_LOG_CONTAINER, (&quot;[M2TS In] PCR discontinuity - switching from old STB &quot;LLD&quot; to new one &quot;LLD&quot;\n&quot;, m2ts-&gt;pcr_last, ((GF_M2TS_PES_PCK *) param)-&gt;PTS));</span>
<span class="lineNum">     709 </span><span class="lineNoCov">          0 :                         if (m2ts-&gt;pcr_last) {</span>
<span class="lineNum">     710 </span><span class="lineNoCov">          0 :                                 m2ts-&gt;pcr_last = pck-&gt;PTS;</span>
<span class="lineNum">     711 </span><span class="lineNoCov">          0 :                                 m2ts-&gt;stb_at_last_pcr = gf_sys_clock();</span>
<span class="lineNum">     712 </span><span class="lineNoCov">          0 :                         }</span>
<span class="lineNum">     713 </span>            :                         /*FIXME - we need to find a way to treat PCR discontinuities correctly while ignoring broken PCR discontinuities
<span class="lineNum">     714 </span>            :                         seen in many HLS solutions*/
<span class="lineNum">     715 </span>            :                         return;
<span class="lineNum">     716 </span>            :                 }
<span class="lineNum">     717 </span>            : 
<span class="lineNum">     718 </span><span class="lineNoCov">          0 :                 if (m2ts-&gt;file_regulate) {</span>
<span class="lineNum">     719 </span><span class="lineNoCov">          0 :                         u64 pcr = pck-&gt;PTS;</span>
<span class="lineNum">     720 </span><span class="lineNoCov">          0 :                         u32 stb = gf_sys_clock();</span>
<span class="lineNum">     721 </span>            : 
<span class="lineNum">     722 </span><span class="lineNoCov">          0 :                         if (pck-&gt;stream) {</span>
<span class="lineNum">     723 </span><span class="lineNoCov">          0 :                                 if (m2ts-&gt;regulation_pcr_pid==0) {</span>
<span class="lineNum">     724 </span>            :                                         /*we pick the first PCR PID for file regulation - we don't need to make sure this is the PCR of a program being played as we
<span class="lineNum">     725 </span>            :                                         only check buffer levels, not DTS/PTS of the streams in the regulation step*/
<span class="lineNum">     726 </span><span class="lineNoCov">          0 :                                         m2ts-&gt;regulation_pcr_pid = pck-&gt;stream-&gt;pid;</span>
<span class="lineNum">     727 </span><span class="lineNoCov">          0 :                                 } else if (m2ts-&gt;regulation_pcr_pid != pck-&gt;stream-&gt;pid) {</span>
<span class="lineNum">     728 </span>            :                                         return;
<span class="lineNum">     729 </span>            :                                 }
<span class="lineNum">     730 </span>            :                         }
<span class="lineNum">     731 </span>            : 
<span class="lineNum">     732 </span>            : 
<span class="lineNum">     733 </span><span class="lineNoCov">          0 :                         if (m2ts-&gt;pcr_last) {</span>
<span class="lineNum">     734 </span>            :                                 s32 diff;
<span class="lineNum">     735 </span><span class="lineNoCov">          0 :                                 if (pcr &lt; m2ts-&gt;pcr_last) {</span>
<span class="lineNum">     736 </span><span class="lineNoCov">          0 :                                         GF_LOG(GF_LOG_WARNING, GF_LOG_CONTAINER, (&quot;[M2TS In] PCR &quot;LLU&quot; less than previous PCR &quot;LLU&quot;\n&quot;, ((GF_M2TS_PES_PCK *) param)-&gt;PTS, m2ts-&gt;pcr_last));</span>
<span class="lineNum">     737 </span><span class="lineNoCov">          0 :                                         m2ts-&gt;pcr_last = pcr;</span>
<span class="lineNum">     738 </span><span class="lineNoCov">          0 :                                         m2ts-&gt;stb_at_last_pcr = gf_sys_clock();</span>
<span class="lineNum">     739 </span>            :                                         diff = 0;
<span class="lineNum">     740 </span><span class="lineNoCov">          0 :                                 } else {</span>
<span class="lineNum">     741 </span><span class="lineNoCov">          0 :                                         u64 pcr_diff = (pcr - m2ts-&gt;pcr_last);</span>
<span class="lineNum">     742 </span><span class="lineNoCov">          0 :                                         pcr_diff /= 27000;</span>
<span class="lineNum">     743 </span><span class="lineNoCov">          0 :                                         if (pcr_diff&gt;1000) {</span>
<span class="lineNum">     744 </span><span class="lineNoCov">          0 :                                                 GF_LOG(GF_LOG_WARNING, GF_LOG_CONTAINER, (&quot;[M2TS In] PCR diff too big: &quot;LLU&quot; ms - PCR &quot;LLU&quot; - previous PCR &quot;LLU&quot; - error in TS ?\n&quot;, pcr_diff, ((GF_M2TS_PES_PCK *) param)-&gt;PTS, m2ts-&gt;pcr_last));</span>
<span class="lineNum">     745 </span>            :                                                 diff = 100;
<span class="lineNum">     746 </span><span class="lineNoCov">          0 :                                         } else {</span>
<span class="lineNum">     747 </span><span class="lineNoCov">          0 :                                                 diff = (u32) pcr_diff - (stb - m2ts-&gt;stb_at_last_pcr);</span>
<span class="lineNum">     748 </span>            :                                         }
<span class="lineNum">     749 </span>            :                                 }
<span class="lineNum">     750 </span><span class="lineNoCov">          0 :                                 if (diff&lt;-400) {</span>
<span class="lineNum">     751 </span><span class="lineNoCov">          0 :                                         GF_LOG(GF_LOG_WARNING, GF_LOG_CONTAINER, (&quot;[M2TS In] Demux not going fast enough according to PCR (drift %d, pcr: &quot;LLU&quot;, last pcr: &quot;LLU&quot;)\n&quot;, diff, pcr, m2ts-&gt;pcr_last));</span>
<span class="lineNum">     752 </span><span class="lineNoCov">          0 :                                 } else if (diff&gt;0) {</span>
<span class="lineNum">     753 </span>            :                                         u32 sleep_for=1;
<span class="lineNum">     754 </span>            : #ifndef GPAC_DISABLE_LOG
<span class="lineNum">     755 </span>            :                                         u32 nb_sleep=0;
<span class="lineNum">     756 </span>            : #endif
<span class="lineNum">     757 </span>            :                                         /*query buffer level, don't sleep if too low*/
<span class="lineNum">     758 </span><span class="lineNoCov">          0 :                                         GF_NetworkCommand com;</span>
<span class="lineNum">     759 </span><span class="lineNoCov">          0 :                                         com.command_type = GF_NET_BUFFER_QUERY;</span>
<span class="lineNum">     760 </span><span class="lineNoCov">          0 :                                         com.base.on_channel = NULL;</span>
<span class="lineNum">     761 </span><span class="lineNoCov">          0 :                                         while (ts-&gt;run_state) {</span>
<span class="lineNum">     762 </span><span class="lineNoCov">          0 :                                                 gf_service_command(m2ts-&gt;service, &amp;com, GF_OK);</span>
<span class="lineNum">     763 </span><span class="lineNoCov">          0 :                                                 if (!com.buffer.occupancy || (com.buffer.occupancy &lt; com.buffer.max)) {</span>
<span class="lineNum">     764 </span><span class="lineNoCov">          0 :                                                         GF_LOG(GF_LOG_INFO, GF_LOG_CONTAINER, (&quot;[M2TS In] Demux not going to sleep: buffer occupancy %d ms\n&quot;, com.buffer.occupancy));</span>
<span class="lineNum">     765 </span>            :                                                         break;
<span class="lineNum">     766 </span>            :                                                 }
<span class="lineNum">     767 </span>            :                                                 /*We don't sleep for the entire buffer occupancy, because we would take
<span class="lineNum">     768 </span>            :                                                 the risk of starving the audio chains. We try to keep buffers half full*/
<span class="lineNum">     769 </span><span class="lineNoCov">          0 :                                                 sleep_for = MIN(com.buffer.occupancy/2, M2TS_MAX_SLEEP);</span>
<span class="lineNum">     770 </span>            : 
<span class="lineNum">     771 </span>            : #ifndef GPAC_DISABLE_LOG
<span class="lineNum">     772 </span><span class="lineNoCov">          0 :                                                 if (!nb_sleep) {</span>
<span class="lineNum">     773 </span><span class="lineNoCov">          0 :                                                         GF_LOG(GF_LOG_INFO, GF_LOG_CONTAINER, (&quot;[M2TS In] Demux going to sleep for %d ms (buffer occupancy %d ms)\n&quot;, sleep_for, com.buffer.occupancy));</span>
<span class="lineNum">     774 </span>            :                                                 }
<span class="lineNum">     775 </span><span class="lineNoCov">          0 :                                                 nb_sleep++;</span>
<span class="lineNum">     776 </span>            : #endif
<span class="lineNum">     777 </span><span class="lineNoCov">          0 :                                                 gf_sleep(sleep_for);</span>
<span class="lineNum">     778 </span><span class="lineNoCov">          0 :                                         }</span>
<span class="lineNum">     779 </span>            : #ifndef GPAC_DISABLE_LOG
<span class="lineNum">     780 </span><span class="lineNoCov">          0 :                                         if (nb_sleep) {</span>
<span class="lineNum">     781 </span><span class="lineNoCov">          0 :                                                 GF_LOG(GF_LOG_INFO, GF_LOG_CONTAINER, (&quot;[M2TS In] Demux resume after %d ms - current buffer occupancy %d ms\n&quot;, sleep_for*nb_sleep, com.buffer.occupancy));</span>
<span class="lineNum">     782 </span>            :                                         }
<span class="lineNum">     783 </span>            : #endif
<span class="lineNum">     784 </span><span class="lineNoCov">          0 :                                         m2ts-&gt;pcr_last = pcr;</span>
<span class="lineNum">     785 </span><span class="lineNoCov">          0 :                                         m2ts-&gt;stb_at_last_pcr = gf_sys_clock();</span>
<span class="lineNum">     786 </span><span class="lineNoCov">          0 :                                 } else {</span>
<span class="lineNum">     787 </span><span class="lineNoCov">          0 :                                         GF_LOG(GF_LOG_INFO, GF_LOG_CONTAINER, (&quot;[M2TS In] Demux drift according to PCR (drift %d, pcr: &quot;LLD&quot;, last pcr: &quot;LLD&quot;)\n&quot;, diff, pcr, m2ts-&gt;pcr_last));</span>
<span class="lineNum">     788 </span>            :                                 }
<span class="lineNum">     789 </span>            :                         } else {
<span class="lineNum">     790 </span><span class="lineNoCov">          0 :                                 m2ts-&gt;pcr_last = pcr;</span>
<span class="lineNum">     791 </span><span class="lineNoCov">          0 :                                 m2ts-&gt;stb_at_last_pcr = gf_sys_clock();</span>
<span class="lineNum">     792 </span>            :                         }
<span class="lineNum">     793 </span>            :                 }
<span class="lineNum">     794 </span>            :         }
<span class="lineNum">     795 </span>            :         break;
<span class="lineNum">     796 </span>            :         case GF_M2TS_EVT_TDT:
<span class="lineNum">     797 </span><span class="lineNoCov">          0 :                 if (m2ts-&gt;hybrid_on) {</span>
<span class="lineNum">     798 </span>            :                         u32 i, count;
<span class="lineNum">     799 </span><span class="lineNoCov">          0 :                         GF_M2TS_TDT_TOT *tdt = (GF_M2TS_TDT_TOT *)param;</span>
<span class="lineNum">     800 </span><span class="lineNoCov">          0 :                         GF_NetworkCommand com;</span>
<span class="lineNum">     801 </span><span class="lineNoCov">          0 :                         memset(&amp;com, 0, sizeof(com));</span>
<span class="lineNum">     802 </span><span class="lineNoCov">          0 :                         com.command_type = GF_NET_CHAN_MAP_TIME;</span>
<span class="lineNum">     803 </span><span class="lineNoCov">          0 :                         com.map_time.media_time = tdt-&gt;hour*3600+tdt-&gt;minute*60+tdt-&gt;second;</span>
<span class="lineNum">     804 </span><span class="lineNoCov">          0 :                         com.map_time.reset_buffers = 0;</span>
<span class="lineNum">     805 </span><span class="lineNoCov">          0 :                         count = gf_list_count(ts-&gt;programs);</span>
<span class="lineNum">     806 </span><span class="lineNoCov">          0 :                         for (i=0; i&lt;count; i++) {</span>
<span class="lineNum">     807 </span><span class="lineNoCov">          0 :                                 GF_M2TS_Program *prog = gf_list_get(ts-&gt;programs, i);</span>
<span class="lineNum">     808 </span>            :                                 u32 j, count2;
<span class="lineNum">     809 </span><span class="lineNoCov">          0 :                                 if (prog-&gt;tdt_found || !prog-&gt;last_pcr_value) /*map TDT one time, after we received a PCR*/</span>
<span class="lineNum">     810 </span>            :                                         continue;
<span class="lineNum">     811 </span><span class="lineNoCov">          0 :                                 prog-&gt;tdt_found = 1;</span>
<span class="lineNum">     812 </span><span class="lineNoCov">          0 :                                 count2 = gf_list_count(prog-&gt;streams);</span>
<span class="lineNum">     813 </span><span class="lineNoCov">          0 :                                 com.map_time.timestamp = prog-&gt;last_pcr_value/300;</span>
<span class="lineNum">     814 </span><span class="lineNoCov">          0 :                                 for (j=0; j&lt;count2; j++) {</span>
<span class="lineNum">     815 </span><span class="lineNoCov">          0 :                                         GF_M2TS_ES * stream = gf_list_get(prog-&gt;streams, j);</span>
<span class="lineNum">     816 </span><span class="lineNoCov">          0 :                                         if (stream-&gt;user) {</span>
<span class="lineNum">     817 </span><span class="lineNoCov">          0 :                                                 com.base.on_channel = stream-&gt;user;</span>
<span class="lineNum">     818 </span><span class="lineNoCov">          0 :                                                 gf_service_command(m2ts-&gt;service, &amp;com, GF_OK);</span>
<span class="lineNum">     819 </span><span class="lineNoCov">          0 :                                         }</span>
<span class="lineNum">     820 </span>            :                                 }
<span class="lineNum">     821 </span><span class="lineNoCov">          0 :                                 GF_LOG(GF_LOG_INFO, GF_LOG_CONTAINER, (&quot;[M2TS In] Mapping TDT Time %04d/%02d/%02d %02d:%02d:%02d and PCR time &quot;LLD&quot; on program %d\n&quot;,</span>
<span class="lineNum">     822 </span>            :                                                                        tdt-&gt;year, tdt-&gt;month, tdt-&gt;day, tdt-&gt;hour, tdt-&gt;minute, tdt-&gt;second, com.map_time.timestamp, prog-&gt;number));
<span class="lineNum">     823 </span>            :                         }
<span class="lineNum">     824 </span><span class="lineNoCov">          0 :                 }</span>
<span class="lineNum">     825 </span>            :                 break;
<span class="lineNum">     826 </span>            :         case GF_M2TS_EVT_TOT:
<span class="lineNum">     827 </span>            :                 break;
<span class="lineNum">     828 </span>            : 
<span class="lineNum">     829 </span>            :         case GF_M2TS_EVT_DURATION_ESTIMATED:
<span class="lineNum">     830 </span>            :         {
<span class="lineNum">     831 </span>            :                 u32 i, count;
<span class="lineNum">     832 </span><span class="lineNoCov">          0 :                 GF_NetworkCommand com;</span>
<span class="lineNum">     833 </span><span class="lineNoCov">          0 :                 memset(&amp;com, 0, sizeof(com));</span>
<span class="lineNum">     834 </span><span class="lineNoCov">          0 :                 com.command_type = GF_NET_CHAN_DURATION;</span>
<span class="lineNum">     835 </span><span class="lineNoCov">          0 :                 com.duration.duration = (Double) ((GF_M2TS_PES_PCK *) param)-&gt;PTS;</span>
<span class="lineNum">     836 </span><span class="lineNoCov">          0 :                 com.duration.duration /= 1000;</span>
<span class="lineNum">     837 </span><span class="lineNoCov">          0 :                 count = gf_list_count(ts-&gt;programs);</span>
<span class="lineNum">     838 </span><span class="lineNoCov">          0 :                 for (i=0; i&lt;count; i++) {</span>
<span class="lineNum">     839 </span><span class="lineNoCov">          0 :                         GF_M2TS_Program *prog = gf_list_get(ts-&gt;programs, i);</span>
<span class="lineNum">     840 </span>            :                         u32 j, count2;
<span class="lineNum">     841 </span><span class="lineNoCov">          0 :                         count2 = gf_list_count(prog-&gt;streams);</span>
<span class="lineNum">     842 </span><span class="lineNoCov">          0 :                         for (j=0; j&lt;count2; j++) {</span>
<span class="lineNum">     843 </span><span class="lineNoCov">          0 :                                 GF_M2TS_ES * stream = gf_list_get(prog-&gt;streams, j);</span>
<span class="lineNum">     844 </span><span class="lineNoCov">          0 :                                 if (stream-&gt;user) {</span>
<span class="lineNum">     845 </span><span class="lineNoCov">          0 :                                         com.base.on_channel = stream-&gt;user;</span>
<span class="lineNum">     846 </span><span class="lineNoCov">          0 :                                         gf_service_command(m2ts-&gt;service, &amp;com, GF_OK);</span>
<span class="lineNum">     847 </span><span class="lineNoCov">          0 :                                 }</span>
<span class="lineNum">     848 </span>            :                         }
<span class="lineNum">     849 </span>            :                 }
<span class="lineNum">     850 </span><span class="lineNoCov">          0 :         }</span>
<span class="lineNum">     851 </span><span class="lineNoCov">          0 :         break;</span>
<span class="lineNum">     852 </span>            : 
<span class="lineNum">     853 </span>            :         case GF_M2TS_EVT_TEMI_LOCATION:
<span class="lineNum">     854 </span>            :         {
<span class="lineNum">     855 </span><span class="lineNoCov">          0 :                 GF_NetworkCommand com;</span>
<span class="lineNum">     856 </span><span class="lineNoCov">          0 :                 memset(&amp;com, 0, sizeof(com));</span>
<span class="lineNum">     857 </span><span class="lineNoCov">          0 :                 com.addon_info.command_type = GF_NET_ASSOCIATED_CONTENT_LOCATION;</span>
<span class="lineNum">     858 </span><span class="lineNoCov">          0 :                 com.addon_info.external_URL = ((GF_M2TS_TemiLocationDescriptor*)param)-&gt;external_URL;</span>
<span class="lineNum">     859 </span><span class="lineNoCov">          0 :                 if (m2ts-&gt;force_temi_url)</span>
<span class="lineNum">     860 </span><span class="lineNoCov">          0 :                         com.addon_info.external_URL = m2ts-&gt;force_temi_url;</span>
<span class="lineNum">     861 </span><span class="lineNoCov">          0 :                 com.addon_info.is_announce = ((GF_M2TS_TemiLocationDescriptor*)param)-&gt;is_announce;</span>
<span class="lineNum">     862 </span><span class="lineNoCov">          0 :                 com.addon_info.is_splicing = ((GF_M2TS_TemiLocationDescriptor*)param)-&gt;is_splicing;</span>
<span class="lineNum">     863 </span><span class="lineNoCov">          0 :                 com.addon_info.activation_countdown = ((GF_M2TS_TemiLocationDescriptor*)param)-&gt;activation_countdown;</span>
<span class="lineNum">     864 </span><span class="lineNoCov">          0 :                 com.addon_info.reload_external = ((GF_M2TS_TemiLocationDescriptor*)param)-&gt;reload_external;</span>
<span class="lineNum">     865 </span><span class="lineNoCov">          0 :                 com.addon_info.timeline_id = ((GF_M2TS_TemiLocationDescriptor*)param)-&gt;timeline_id;</span>
<span class="lineNum">     866 </span><span class="lineNoCov">          0 :                 gf_service_command(m2ts-&gt;service, &amp;com, GF_OK);</span>
<span class="lineNum">     867 </span><span class="lineNoCov">          0 :         }</span>
<span class="lineNum">     868 </span><span class="lineNoCov">          0 :         break;</span>
<span class="lineNum">     869 </span>            :         case GF_M2TS_EVT_TEMI_TIMECODE:
<span class="lineNum">     870 </span>            :         {
<span class="lineNum">     871 </span><span class="lineNoCov">          0 :                 GF_NetworkCommand com;</span>
<span class="lineNum">     872 </span><span class="lineNoCov">          0 :                 memset(&amp;com, 0, sizeof(com));</span>
<span class="lineNum">     873 </span><span class="lineNoCov">          0 :                 com.addon_time.command_type = GF_NET_ASSOCIATED_CONTENT_TIMING;</span>
<span class="lineNum">     874 </span><span class="lineNoCov">          0 :                 com.addon_time.timeline_id = ((GF_M2TS_TemiTimecodeDescriptor*)param)-&gt;timeline_id;</span>
<span class="lineNum">     875 </span><span class="lineNoCov">          0 :                 com.addon_time.media_pts = ((GF_M2TS_TemiTimecodeDescriptor*)param)-&gt;pes_pts;</span>
<span class="lineNum">     876 </span><span class="lineNoCov">          0 :                 com.addon_time.media_timescale = ((GF_M2TS_TemiTimecodeDescriptor*)param)-&gt;media_timescale;</span>
<span class="lineNum">     877 </span><span class="lineNoCov">          0 :                 com.addon_time.media_timestamp = ((GF_M2TS_TemiTimecodeDescriptor*)param)-&gt;media_timestamp;</span>
<span class="lineNum">     878 </span><span class="lineNoCov">          0 :                 com.addon_time.force_reload = ((GF_M2TS_TemiTimecodeDescriptor*)param)-&gt;force_reload;</span>
<span class="lineNum">     879 </span><span class="lineNoCov">          0 :                 com.addon_time.is_paused = ((GF_M2TS_TemiTimecodeDescriptor*)param)-&gt;is_paused;</span>
<span class="lineNum">     880 </span><span class="lineNoCov">          0 :                 com.addon_time.ntp = ((GF_M2TS_TemiTimecodeDescriptor*)param)-&gt;ntp;</span>
<span class="lineNum">     881 </span><span class="lineNoCov">          0 :                 gf_service_command(m2ts-&gt;service, &amp;com, GF_OK);</span>
<span class="lineNum">     882 </span><span class="lineNoCov">          0 :         }</span>
<span class="lineNum">     883 </span><span class="lineNoCov">          0 :         break;</span>
<span class="lineNum">     884 </span>            :         }
<a name="885"><span class="lineNum">     885 </span><span class="lineNoCov">          0 : }</span></a>
<span class="lineNum">     886 </span>            : 
<span class="lineNum">     887 </span>            : void m2ts_net_io(void *cbk, GF_NETIO_Parameter *param)
<span class="lineNum">     888 </span>            : {
<span class="lineNum">     889 </span>            :         GF_Err e;
<span class="lineNum">     890 </span><span class="lineNoCov">          0 :         M2TSIn *m2ts = (M2TSIn *) cbk;</span>
<span class="lineNum">     891 </span>            :         assert( m2ts );
<span class="lineNum">     892 </span>            :         /*handle service message*/
<span class="lineNum">     893 </span><span class="lineNoCov">          0 :         gf_service_download_update_stats(m2ts-&gt;ts-&gt;dnload);</span>
<span class="lineNum">     894 </span>            : 
<span class="lineNum">     895 </span><span class="lineNoCov">          0 :         if (param-&gt;msg_type==GF_NETIO_DATA_TRANSFERED) {</span>
<span class="lineNum">     896 </span>            :                 e = GF_EOS;
<span class="lineNum">     897 </span><span class="lineNoCov">          0 :         } else if (param-&gt;msg_type==GF_NETIO_DATA_EXCHANGE) {</span>
<span class="lineNum">     898 </span>            :                 e = GF_OK;
<span class="lineNum">     899 </span>            :                 assert( m2ts-&gt;ts);
<span class="lineNum">     900 </span><span class="lineNoCov">          0 :                 if (param-&gt;size &gt; 0) {</span>
<span class="lineNum">     901 </span>            :                         /*process chunk*/
<span class="lineNum">     902 </span>            :                         assert(param-&gt;data);
<span class="lineNum">     903 </span><span class="lineNoCov">          0 :                         if (m2ts-&gt;network_buffer_size &lt; param-&gt;size) {</span>
<span class="lineNum">     904 </span><span class="lineNoCov">          0 :                                 m2ts-&gt;network_buffer = gf_realloc(m2ts-&gt;network_buffer, sizeof(char) * param-&gt;size);</span>
<span class="lineNum">     905 </span><span class="lineNoCov">          0 :                                 m2ts-&gt;network_buffer_size = param-&gt;size;</span>
<span class="lineNum">     906 </span><span class="lineNoCov">          0 :                         }</span>
<span class="lineNum">     907 </span>            :                         assert( m2ts-&gt;network_buffer );
<span class="lineNum">     908 </span><span class="lineNoCov">          0 :                         memcpy(m2ts-&gt;network_buffer, param-&gt;data, param-&gt;size);</span>
<span class="lineNum">     909 </span><span class="lineNoCov">          0 :                         gf_m2ts_process_data(m2ts-&gt;ts, m2ts-&gt;network_buffer, param-&gt;size);</span>
<span class="lineNum">     910 </span><span class="lineNoCov">          0 :                 }</span>
<span class="lineNum">     911 </span>            : 
<span class="lineNum">     912 </span>            :                 /*if asked to regulate, wait until we get a play request*/
<span class="lineNum">     913 </span><span class="lineNoCov">          0 :                 if (m2ts-&gt;ts-&gt;paused) {</span>
<span class="lineNum">     914 </span><span class="lineNoCov">          0 :                         while (m2ts-&gt;ts-&gt;run_state &amp;&amp; m2ts-&gt;ts-&gt;paused ) {</span>
<span class="lineNum">     915 </span><span class="lineNoCov">          0 :                                 gf_sleep(50);</span>
<span class="lineNum">     916 </span><span class="lineNoCov">          0 :                                 continue;</span>
<span class="lineNum">     917 </span>            :                         }
<span class="lineNum">     918 </span>            :                 } else {
<span class="lineNum">     919 </span><span class="lineNoCov">          0 :                         gf_sleep(1);</span>
<span class="lineNum">     920 </span>            :                 }
<span class="lineNum">     921 </span>            : #if 1 //see commit 3642: crashes when reload quickly with http
<span class="lineNum">     922 </span><span class="lineNoCov">          0 :                 if (!m2ts-&gt;ts-&gt;run_state) {</span>
<span class="lineNum">     923 </span><span class="lineNoCov">          0 :                         if (m2ts-&gt;ts-&gt;dnload)</span>
<span class="lineNum">     924 </span><span class="lineNoCov">          0 :                                 gf_service_download_del( m2ts-&gt;ts-&gt;dnload );</span>
<span class="lineNum">     925 </span><span class="lineNoCov">          0 :                         m2ts-&gt;ts-&gt;dnload = NULL;</span>
<span class="lineNum">     926 </span><span class="lineNoCov">          0 :                 }</span>
<span class="lineNum">     927 </span>            : #endif
<span class="lineNum">     928 </span>            : 
<span class="lineNum">     929 </span>            :         } else {
<span class="lineNum">     930 </span><span class="lineNoCov">          0 :                 e = param-&gt;error;</span>
<span class="lineNum">     931 </span>            :         }
<span class="lineNum">     932 </span>            : 
<span class="lineNum">     933 </span><span class="lineNoCov">          0 :         switch (e) {</span>
<span class="lineNum">     934 </span>            :         case GF_EOS:
<span class="lineNum">     935 </span><span class="lineNoCov">          0 :                 if (!m2ts-&gt;is_connected) {</span>
<span class="lineNum">     936 </span><span class="lineNoCov">          0 :                         gf_service_connect_ack(m2ts-&gt;service, NULL, GF_OK);</span>
<span class="lineNum">     937 </span><span class="lineNoCov">          0 :                 }</span>
<span class="lineNum">     938 </span>            :                 return;
<span class="lineNum">     939 </span>            :         case GF_OK:
<span class="lineNum">     940 </span>            :                 return;
<span class="lineNum">     941 </span>            :         default:
<span class="lineNum">     942 </span><span class="lineNoCov">          0 :                 if (!m2ts-&gt;ts_setup) {</span>
<span class="lineNum">     943 </span><span class="lineNoCov">          0 :                         m2ts-&gt;ts_setup = 1;</span>
<span class="lineNum">     944 </span><span class="lineNoCov">          0 :                 }</span>
<span class="lineNum">     945 </span><span class="lineNoCov">          0 :                 GF_LOG(GF_LOG_ERROR, GF_LOG_CONTAINER,(&quot;[MPEGTSIn] : Error while getting data : %s\n&quot;, gf_error_to_string(e)));</span>
<span class="lineNum">     946 </span><span class="lineNoCov">          0 :                 gf_service_connect_ack(m2ts-&gt;service, NULL, e);</span>
<span class="lineNum">     947 </span><span class="lineNoCov">          0 :         }</span>
<span class="lineNum">     948 </span><span class="lineNoCov">          0 : }</span>
<span class="lineNum">     949 </span>            : 
<span class="lineNum">     950 </span>            : /*for DASH - query_type is:
<span class="lineNum">     951 </span>            :         0: query init range
<span class="lineNum">     952 </span>            :         1: query next segment
<span class="lineNum">     953 </span>            :         2: query next segment except currently downloading one
<span class="lineNum">     954 </span>            :         3: drop next segment
<span class="lineNum">     955 </span>            : */
<span class="lineNum">     956 </span>            : typedef enum {
<span class="lineNum">     957 </span>            :         INIT_RANGE = 0,
<span class="lineNum">     958 </span>            :         NEXT_SEGMENT,
<span class="lineNum">     959 </span>            :         NEXT_SEGMENT_EXCEPT_DL,
<a name="960"><span class="lineNum">     960 </span>            :         DROP_NEXT_SEGMENT,</a>
<span class="lineNum">     961 </span>            : } DASHQueryType;
<span class="lineNum">     962 </span>            : static GF_Err M2TS_QueryNextFile(void *udta, DASHQueryType query_type, const char **out_url, u64 *out_start_range, u64 *out_end_range, u32 *refresh_type)
<span class="lineNum">     963 </span>            : {
<span class="lineNum">     964 </span><span class="lineNoCov">          0 :         GF_NetworkCommand param;</span>
<span class="lineNum">     965 </span>            :         GF_Err query_ret;
<span class="lineNum">     966 </span><span class="lineNoCov">          0 :         M2TSIn *m2ts = (M2TSIn *) udta;</span>
<span class="lineNum">     967 </span>            :         assert(m2ts-&gt;owner);
<span class="lineNum">     968 </span>            :         assert( m2ts-&gt;owner-&gt;query_proxy);
<span class="lineNum">     969 </span>            : 
<span class="lineNum">     970 </span><span class="lineNoCov">          0 :         if (out_url) *out_url = NULL;</span>
<span class="lineNum">     971 </span><span class="lineNoCov">          0 :         if (out_start_range) *out_start_range = 0;</span>
<span class="lineNum">     972 </span><span class="lineNoCov">          0 :         if (out_end_range) *out_end_range = 0;</span>
<span class="lineNum">     973 </span>            : 
<span class="lineNum">     974 </span><span class="lineNoCov">          0 :         memset(&amp;param, 0, sizeof(GF_NetworkCommand));</span>
<span class="lineNum">     975 </span><span class="lineNoCov">          0 :         param.command_type = (query_type == INIT_RANGE) ? GF_NET_SERVICE_QUERY_INIT_RANGE : GF_NET_SERVICE_QUERY_NEXT;</span>
<span class="lineNum">     976 </span><span class="lineNoCov">          0 :         param.url_query.drop_first_segment = (query_type == DROP_NEXT_SEGMENT) ? 1 : 0;</span>
<span class="lineNum">     977 </span><span class="lineNoCov">          0 :         param.url_query.current_download = (query_type == NEXT_SEGMENT_EXCEPT_DL) ? 0 : 1;</span>
<span class="lineNum">     978 </span>            : 
<span class="lineNum">     979 </span>            :         //we are downloading the segment we play, don't delete it
<span class="lineNum">     980 </span><span class="lineNoCov">          0 :         if (m2ts-&gt;in_segment_download)</span>
<span class="lineNum">     981 </span><span class="lineNoCov">          0 :                 param.url_query.drop_first_segment = 0;</span>
<span class="lineNum">     982 </span>            : 
<span class="lineNum">     983 </span><span class="lineNoCov">          0 :         query_ret = m2ts-&gt;owner-&gt;query_proxy(m2ts-&gt;owner, &amp;param);</span>
<span class="lineNum">     984 </span>            : 
<span class="lineNum">     985 </span><span class="lineNoCov">          0 :         if ((query_ret==GF_BUFFER_TOO_SMALL) &amp;&amp; query_type &amp;&amp; !param.url_query.next_url) {</span>
<span class="lineNum">     986 </span><span class="lineNoCov">          0 :                 GF_LOG(GF_LOG_DEBUG, GF_LOG_DASH, (&quot;[M2TS In] Cannot query next file: not yet downloaded\n&quot;));</span>
<span class="lineNum">     987 </span><span class="lineNoCov">          0 :         } else if ((query_ret==GF_OK) &amp;&amp; query_type &amp;&amp; !param.url_query.next_url) {</span>
<span class="lineNum">     988 </span><span class="lineNoCov">          0 :                 GF_LOG(GF_LOG_INFO, GF_LOG_DASH, (&quot;[M2TS In] Cannot query next file: no file provided but no error raised\n&quot;));</span>
<span class="lineNum">     989 </span><span class="lineNoCov">          0 :         } else if (query_ret) {</span>
<span class="lineNum">     990 </span><span class="lineNoCov">          0 :                 GF_LOG((query_ret&lt;0) ? GF_LOG_ERROR : GF_LOG_INFO, GF_LOG_DASH, (&quot;[M2TS In] Cannot query next file: error: %s\n&quot;, gf_error_to_string(query_ret)));</span>
<span class="lineNum">     991 </span>            :         } else {
<span class="lineNum">     992 </span><span class="lineNoCov">          0 :                 if (out_url) *out_url = param.url_query.next_url;</span>
<span class="lineNum">     993 </span><span class="lineNoCov">          0 :                 if (out_start_range) *out_start_range = param.url_query.start_range;</span>
<span class="lineNum">     994 </span><span class="lineNoCov">          0 :                 if (out_end_range) *out_end_range = param.url_query.end_range;</span>
<span class="lineNum">     995 </span>            : 
<span class="lineNum">     996 </span>            :                 /*the segment is being downloaded now, start monitoring refresh*/
<span class="lineNum">     997 </span><span class="lineNoCov">          0 :                 if (param.url_query.current_download) {</span>
<span class="lineNum">     998 </span><span class="lineNoCov">          0 :                         m2ts-&gt;low_latency_mode = 1;</span>
<span class="lineNum">     999 </span><span class="lineNoCov">          0 :                         if (refresh_type) *refresh_type = 1;</span>
<span class="lineNum">    1000 </span><span class="lineNoCov">          0 :                         if (!m2ts-&gt;in_segment_download || param.url_query.has_new_data) {</span>
<span class="lineNum">    1001 </span><span class="lineNoCov">          0 :                                 GF_LOG(GF_LOG_INFO, GF_LOG_DASH, (&quot;[M2TS In] progressive loading of TS segments\n&quot;));</span>
<span class="lineNum">    1002 </span>            :                         }
<span class="lineNum">    1003 </span>            :                         //state &quot;in progress&quot;
<span class="lineNum">    1004 </span><span class="lineNoCov">          0 :                         m2ts-&gt;in_segment_download = 1;</span>
<span class="lineNum">    1005 </span><span class="lineNoCov">          0 :                         if (!m2ts-&gt;first_chunk_in_seg_parsed) {</span>
<span class="lineNum">    1006 </span><span class="lineNoCov">          0 :                                 m2ts-&gt;first_chunk_in_seg_parsed=1;</span>
<span class="lineNum">    1007 </span><span class="lineNoCov">          0 :                                 m2ts-&gt;ts-&gt;pos_in_stream = 0;</span>
<span class="lineNum">    1008 </span><span class="lineNoCov">          0 :                         }</span>
<span class="lineNum">    1009 </span>            :                 } else {
<span class="lineNum">    1010 </span><span class="lineNoCov">          0 :                         if (refresh_type) {</span>
<span class="lineNum">    1011 </span>            :                                 //segment done downloading but was in progress mode: do a final refresh
<span class="lineNum">    1012 </span><span class="lineNoCov">          0 :                                 if (m2ts-&gt;in_segment_download) {</span>
<span class="lineNum">    1013 </span><span class="lineNoCov">          0 :                                         GF_LOG(GF_LOG_INFO, GF_LOG_DASH, (&quot;[M2TS In] End of progressive loading of TS segments\n&quot;));</span>
<span class="lineNum">    1014 </span><span class="lineNoCov">          0 :                                         *refresh_type = 2;</span>
<span class="lineNum">    1015 </span><span class="lineNoCov">          0 :                                 } else {</span>
<span class="lineNum">    1016 </span><span class="lineNoCov">          0 :                                         *refresh_type = 0;</span>
<span class="lineNum">    1017 </span>            :                                 }
<span class="lineNum">    1018 </span>            :                         }
<span class="lineNum">    1019 </span><span class="lineNoCov">          0 :                         m2ts-&gt;first_chunk_in_seg_parsed=0;</span>
<span class="lineNum">    1020 </span><span class="lineNoCov">          0 :                         m2ts-&gt;in_segment_download = 0;</span>
<span class="lineNum">    1021 </span>            :                 }
<span class="lineNum">    1022 </span>            :         }
<span class="lineNum">    1023 </span>            :         return query_ret;
<span class="lineNum">    1024 </span><span class="lineNoCov">          0 : }</span>
<span class="lineNum">    1025 </span>            : 
<span class="lineNum">    1026 </span>            : enum
<span class="lineNum">    1027 </span>            : {
<span class="lineNum">    1028 </span>            :         GF_M2TS_PUSH_SEGMENT,
<span class="lineNum">    1029 </span>            :         GF_M2TS_PUSH_CHUNK,
<span class="lineNum">    1030 </span>            :         GF_M2TS_FLUSH_DATA
<a name="1031"><span class="lineNum">    1031 </span>            : };</a>
<span class="lineNum">    1032 </span>            : 
<span class="lineNum">    1033 </span>            : void m2ts_flush_data(M2TSIn *m2ts, u32 flush_type)
<span class="lineNum">    1034 </span>            : {
<span class="lineNum">    1035 </span>            :         u64 start_byterange, end_byterange;
<span class="lineNum">    1036 </span>            :         GF_Err e = GF_OK;
<span class="lineNum">    1037 </span><span class="lineNoCov">          0 :         u32 refresh_type = 0;</span>
<span class="lineNum">    1038 </span>            :         const char *url;
<span class="lineNum">    1039 </span>            : 
<span class="lineNum">    1040 </span><span class="lineNoCov">          0 :         if (m2ts-&gt;in_data_flush) {</span>
<span class="lineNum">    1041 </span><span class="lineNoCov">          0 :                 if (flush_type==GF_M2TS_PUSH_SEGMENT)</span>
<span class="lineNum">    1042 </span><span class="lineNoCov">          0 :                         m2ts-&gt;has_pending_segments++;</span>
<span class="lineNum">    1043 </span>            :                 return;
<span class="lineNum">    1044 </span>            :         }
<span class="lineNum">    1045 </span><span class="lineNoCov">          0 :         if (! gf_mx_try_lock(m2ts-&gt;mx)) {</span>
<span class="lineNum">    1046 </span><span class="lineNoCov">          0 :                 if (flush_type==GF_M2TS_PUSH_SEGMENT)</span>
<span class="lineNum">    1047 </span><span class="lineNoCov">          0 :                         m2ts-&gt;has_pending_segments++;</span>
<span class="lineNum">    1048 </span>            :                 return;
<span class="lineNum">    1049 </span>            :         }
<span class="lineNum">    1050 </span><span class="lineNoCov">          0 :         m2ts-&gt;in_data_flush = 1;</span>
<span class="lineNum">    1051 </span>            : 
<span class="lineNum">    1052 </span>            :         //check buffer level when start of new segment
<span class="lineNum">    1053 </span><span class="lineNoCov">          0 :         if (flush_type&lt;=GF_M2TS_PUSH_CHUNK) {</span>
<span class="lineNum">    1054 </span><span class="lineNoCov">          0 :                 GF_NetworkCommand com;</span>
<span class="lineNum">    1055 </span>            :                 /*query buffer level on each channel, don't sleep if too low*/
<span class="lineNum">    1056 </span><span class="lineNoCov">          0 :                 memset(&amp;com, 0, sizeof(GF_NetworkCommand));</span>
<span class="lineNum">    1057 </span><span class="lineNoCov">          0 :                 com.command_type = GF_NET_BUFFER_QUERY;</span>
<span class="lineNum">    1058 </span><span class="lineNoCov">          0 :                 gf_service_command(m2ts-&gt;service, &amp;com, GF_OK);</span>
<span class="lineNum">    1059 </span><span class="lineNoCov">          0 :                 if (com.buffer.occupancy &amp;&amp; (com.buffer.occupancy &gt;= com.buffer.max)) {</span>
<span class="lineNum">    1060 </span>            :                         //count completed segment that were not dispatched
<span class="lineNum">    1061 </span><span class="lineNoCov">          0 :                         if (flush_type==GF_M2TS_PUSH_SEGMENT)</span>
<span class="lineNum">    1062 </span><span class="lineNoCov">          0 :                                 m2ts-&gt;has_pending_segments++;</span>
<span class="lineNum">    1063 </span>            : 
<span class="lineNum">    1064 </span><span class="lineNoCov">          0 :                         m2ts-&gt;in_data_flush = 0;</span>
<span class="lineNum">    1065 </span><span class="lineNoCov">          0 :                         gf_mx_v(m2ts-&gt;mx);</span>
<span class="lineNum">    1066 </span><span class="lineNoCov">          0 :                         return;</span>
<span class="lineNum">    1067 </span>            :                 }
<span class="lineNum">    1068 </span><span class="lineNoCov">          0 :         }</span>
<span class="lineNum">    1069 </span>            :         else if (0 &amp;&amp; flush_type==GF_M2TS_FLUSH_DATA) {
<span class="lineNum">    1070 </span>            :                 if (! m2ts-&gt;has_pending_segments) {
<span class="lineNum">    1071 </span>            :                         m2ts-&gt;in_data_flush = 0;
<span class="lineNum">    1072 </span>            :                         gf_mx_v(m2ts-&gt;mx);
<span class="lineNum">    1073 </span>            :                         return;
<span class="lineNum">    1074 </span>            :                 }
<span class="lineNum">    1075 </span>            :         }
<span class="lineNum">    1076 </span>            : 
<span class="lineNum">    1077 </span><span class="lineNoCov">          0 :         e = M2TS_QueryNextFile(m2ts, (flush_type==GF_M2TS_FLUSH_DATA) ? NEXT_SEGMENT_EXCEPT_DL : NEXT_SEGMENT, &amp;url, &amp;start_byterange, &amp;end_byterange, &amp;refresh_type);</span>
<span class="lineNum">    1078 </span><span class="lineNoCov">          0 :         if (e) {</span>
<span class="lineNum">    1079 </span><span class="lineNoCov">          0 :                 m2ts-&gt;in_data_flush = 0;</span>
<span class="lineNum">    1080 </span><span class="lineNoCov">          0 :                 if (e==GF_EOS) {</span>
<span class="lineNum">    1081 </span><span class="lineNoCov">          0 :                         gf_m2ts_demux_file(m2ts-&gt;ts, NULL, 0, 0, 0, 1);</span>
<span class="lineNum">    1082 </span><span class="lineNoCov">          0 :                 }</span>
<span class="lineNum">    1083 </span><span class="lineNoCov">          0 :                 gf_mx_v(m2ts-&gt;mx);</span>
<span class="lineNum">    1084 </span><span class="lineNoCov">          0 :                 return;</span>
<span class="lineNum">    1085 </span>            :         }
<span class="lineNum">    1086 </span><span class="lineNoCov">          0 :         gf_m2ts_demux_file(m2ts-&gt;ts, url, start_byterange, end_byterange, refresh_type, 0);</span>
<span class="lineNum">    1087 </span>            : 
<span class="lineNum">    1088 </span>            :         //done, drop segment
<span class="lineNum">    1089 </span><span class="lineNoCov">          0 :         if (!m2ts-&gt;in_segment_download) {</span>
<span class="lineNum">    1090 </span><span class="lineNoCov">          0 :                 e = M2TS_QueryNextFile(m2ts, DROP_NEXT_SEGMENT, &amp;url, &amp;start_byterange, &amp;end_byterange, &amp;refresh_type);</span>
<span class="lineNum">    1091 </span>            : 
<span class="lineNum">    1092 </span><span class="lineNoCov">          0 :                 if (m2ts-&gt;has_pending_segments)</span>
<span class="lineNum">    1093 </span><span class="lineNoCov">          0 :                         m2ts-&gt;has_pending_segments--;</span>
<span class="lineNum">    1094 </span>            : 
<span class="lineNum">    1095 </span><span class="lineNoCov">          0 :                 if (e==GF_EOS) {</span>
<span class="lineNum">    1096 </span><span class="lineNoCov">          0 :                         gf_m2ts_demux_file(m2ts-&gt;ts, NULL, 0, 0, 0, 1);</span>
<span class="lineNum">    1097 </span><span class="lineNoCov">          0 :                 }</span>
<span class="lineNum">    1098 </span>            :                 //we are currently downloading this segment, parse it ONLY IF WE ARE CALLED FROM THE PROXY THREAD
<span class="lineNum">    1099 </span>            :                 //TODO: we should fix this to allow concurrent access to gmem://
<span class="lineNum">    1100 </span><span class="lineNoCov">          0 :                 else if (m2ts-&gt;in_segment_download &amp;&amp; (flush_type != GF_M2TS_FLUSH_DATA) ) {</span>
<span class="lineNum">    1101 </span><span class="lineNoCov">          0 :                         gf_m2ts_demux_file(m2ts-&gt;ts, url, start_byterange, end_byterange, refresh_type, 0);</span>
<span class="lineNum">    1102 </span><span class="lineNoCov">          0 :                 }</span>
<span class="lineNum">    1103 </span>            : 
<span class="lineNum">    1104 </span>            :         }
<span class="lineNum">    1105 </span><span class="lineNoCov">          0 :         m2ts-&gt;in_data_flush = 0;</span>
<span class="lineNum">    1106 </span><span class="lineNoCov">          0 :         gf_mx_v(m2ts-&gt;mx);</span>
<a name="1107"><span class="lineNum">    1107 </span><span class="lineNoCov">          0 : }</span></a>
<span class="lineNum">    1108 </span>            : 
<span class="lineNum">    1109 </span>            : static GF_Err M2TS_ConnectService(GF_InputService *plug, GF_ClientService *serv, const char *url)
<span class="lineNum">    1110 </span>            : {
<span class="lineNum">    1111 </span>            :         GF_Err e;
<span class="lineNum">    1112 </span>            :         const char *opt;
<span class="lineNum">    1113 </span><span class="lineNoCov">          0 :         M2TSIn *m2ts = plug-&gt;priv;</span>
<span class="lineNum">    1114 </span>            : 
<span class="lineNum">    1115 </span><span class="lineNoCov">          0 :         M2TS_GetNetworkType(plug,m2ts);</span>
<span class="lineNum">    1116 </span>            : 
<span class="lineNum">    1117 </span><span class="lineNoCov">          0 :         m2ts-&gt;owner = plug;</span>
<span class="lineNum">    1118 </span>            : 
<span class="lineNum">    1119 </span><span class="lineNoCov">          0 :         opt = gf_modules_get_option((GF_BaseInterface *)m2ts-&gt;owner, &quot;HybRadio&quot;, &quot;Activated&quot;);</span>
<span class="lineNum">    1120 </span><span class="lineNoCov">          0 :         if (opt &amp;&amp; !strcmp(opt, &quot;true&quot;)) {</span>
<span class="lineNum">    1121 </span><span class="lineNoCov">          0 :                 m2ts-&gt;hybrid_on = 1;</span>
<span class="lineNum">    1122 </span><span class="lineNoCov">          0 :         }</span>
<span class="lineNum">    1123 </span>            : 
<span class="lineNum">    1124 </span><span class="lineNoCov">          0 :         m2ts-&gt;ts-&gt;record_to = gf_modules_get_option((GF_BaseInterface *)m2ts-&gt;owner, &quot;M2TS&quot;, &quot;RecordTo&quot;);</span>
<span class="lineNum">    1125 </span>            : 
<span class="lineNum">    1126 </span><span class="lineNoCov">          0 :         m2ts-&gt;service = serv;</span>
<span class="lineNum">    1127 </span>            : 
<span class="lineNum">    1128 </span><span class="lineNoCov">          0 :         m2ts-&gt;force_temi_url = gf_modules_get_option((GF_BaseInterface *)m2ts-&gt;owner, &quot;M2TS&quot;, &quot;ForceTEMILocation&quot;);</span>
<span class="lineNum">    1129 </span><span class="lineNoCov">          0 :         if (m2ts-&gt;force_temi_url &amp;&amp; !strlen(m2ts-&gt;force_temi_url)) m2ts-&gt;force_temi_url = NULL;</span>
<span class="lineNum">    1130 </span>            : 
<span class="lineNum">    1131 </span><span class="lineNoCov">          0 :         opt = gf_modules_get_option((GF_BaseInterface *)m2ts-&gt;owner, &quot;DSMCC&quot;, &quot;Activated&quot;);</span>
<span class="lineNum">    1132 </span><span class="lineNoCov">          0 :         if (opt &amp;&amp; !strcmp(opt, &quot;yes&quot;)) {</span>
<span class="lineNum">    1133 </span><span class="lineNoCov">          0 :                 gf_m2ts_demux_dmscc_init(m2ts-&gt;ts);</span>
<span class="lineNum">    1134 </span><span class="lineNoCov">          0 :         }</span>
<span class="lineNum">    1135 </span>            : 
<span class="lineNum">    1136 </span><span class="lineNoCov">          0 :         if (url &amp;&amp; !strnicmp(url, &quot;http://&quot;, 7)) {</span>
<span class="lineNum">    1137 </span><span class="lineNoCov">          0 :                 m2ts-&gt;ts-&gt;dnload = gf_service_download_new(m2ts-&gt;service, url, GF_NETIO_SESSION_NOT_THREADED | GF_NETIO_SESSION_NOT_CACHED | GF_NETIO_SESSION_NOTIFY_DATA, m2ts_net_io, m2ts);</span>
<span class="lineNum">    1138 </span><span class="lineNoCov">          0 :                 if (!m2ts-&gt;ts-&gt;dnload) {</span>
<span class="lineNum">    1139 </span><span class="lineNoCov">          0 :                         gf_service_connect_ack(m2ts-&gt;service, NULL, GF_NOT_SUPPORTED);</span>
<span class="lineNum">    1140 </span><span class="lineNoCov">          0 :                         return GF_OK;</span>
<span class="lineNum">    1141 </span>            :                 } else {
<span class="lineNum">    1142 </span><span class="lineNoCov">          0 :                         e = gf_m2ts_demuxer_play(m2ts-&gt;ts);</span>
<span class="lineNum">    1143 </span>            :                 }
<span class="lineNum">    1144 </span><span class="lineNoCov">          0 :         } else {</span>
<span class="lineNum">    1145 </span>            :                 //dash &amp; HLS - run in non-threaded mode
<span class="lineNum">    1146 </span><span class="lineNoCov">          0 :                 if (plug-&gt;query_proxy) {</span>
<span class="lineNum">    1147 </span>            :                         //get byte range if any (local playback)
<span class="lineNum">    1148 </span><span class="lineNoCov">          0 :                         if (url) {</span>
<span class="lineNum">    1149 </span>            :                                 u64 start_byterange, end_byterange;
<span class="lineNum">    1150 </span><span class="lineNoCov">          0 :                                 gf_mx_p(m2ts-&gt;mx);</span>
<span class="lineNum">    1151 </span><span class="lineNoCov">          0 :                                 m2ts-&gt;in_data_flush = 1;</span>
<span class="lineNum">    1152 </span><span class="lineNoCov">          0 :                                 M2TS_QueryNextFile(m2ts, INIT_RANGE, NULL, &amp;start_byterange, &amp;end_byterange, NULL);</span>
<span class="lineNum">    1153 </span><span class="lineNoCov">          0 :                                 e = gf_m2ts_demux_file(m2ts-&gt;ts, url, start_byterange, end_byterange, 0, 0);</span>
<span class="lineNum">    1154 </span><span class="lineNoCov">          0 :                                 M2TS_QueryNextFile(m2ts, DROP_NEXT_SEGMENT, NULL, NULL, NULL, NULL);</span>
<span class="lineNum">    1155 </span><span class="lineNoCov">          0 :                                 m2ts-&gt;in_data_flush = 0;</span>
<span class="lineNum">    1156 </span><span class="lineNoCov">          0 :                                 gf_mx_v(m2ts-&gt;mx);</span>
<span class="lineNum">    1157 </span><span class="lineNoCov">          0 :                         } else {</span>
<span class="lineNum">    1158 </span>            :                                 e = GF_OK;
<span class="lineNum">    1159 </span>            :                         }
<span class="lineNum">    1160 </span><span class="lineNoCov">          0 :                         m2ts-&gt;ts-&gt;run_state = 1;</span>
<span class="lineNum">    1161 </span><span class="lineNoCov">          0 :                 } else {</span>
<span class="lineNum">    1162 </span><span class="lineNoCov">          0 :                         e = gf_m2ts_demuxer_setup(m2ts-&gt;ts,url,0);</span>
<span class="lineNum">    1163 </span>            :                 }
<span class="lineNum">    1164 </span>            :         }
<span class="lineNum">    1165 </span>            : 
<span class="lineNum">    1166 </span><span class="lineNoCov">          0 :         if (e) {</span>
<span class="lineNum">    1167 </span><span class="lineNoCov">          0 :                 gf_service_connect_ack(m2ts-&gt;service, NULL, e);</span>
<span class="lineNum">    1168 </span><span class="lineNoCov">          0 :         }</span>
<span class="lineNum">    1169 </span><span class="lineNoCov">          0 :         return e;</span>
<a name="1170"><span class="lineNum">    1170 </span><span class="lineNoCov">          0 : }</span></a>
<span class="lineNum">    1171 </span>            : 
<span class="lineNum">    1172 </span>            : static GF_Err M2TS_CloseService(GF_InputService *plug)
<span class="lineNum">    1173 </span>            : {
<span class="lineNum">    1174 </span><span class="lineNoCov">          0 :         M2TSIn *m2ts = plug-&gt;priv;</span>
<span class="lineNum">    1175 </span><span class="lineNoCov">          0 :         GF_M2TS_Demuxer* ts = m2ts-&gt;ts;</span>
<span class="lineNum">    1176 </span>            : 
<span class="lineNum">    1177 </span><span class="lineNoCov">          0 :         if (!plug-&gt;query_proxy)</span>
<span class="lineNum">    1178 </span><span class="lineNoCov">          0 :                 gf_m2ts_demuxer_close(ts);</span>
<span class="lineNum">    1179 </span>            : 
<span class="lineNum">    1180 </span><span class="lineNoCov">          0 :         m2ts-&gt;ts-&gt;run_state = 0;</span>
<span class="lineNum">    1181 </span>            : 
<span class="lineNum">    1182 </span><span class="lineNoCov">          0 :         if (ts-&gt;dnload) gf_service_download_del(ts-&gt;dnload);</span>
<span class="lineNum">    1183 </span><span class="lineNoCov">          0 :         ts-&gt;dnload = NULL;</span>
<span class="lineNum">    1184 </span>            : 
<span class="lineNum">    1185 </span><span class="lineNoCov">          0 :         gf_service_disconnect_ack(m2ts-&gt;service, NULL, GF_OK);</span>
<span class="lineNum">    1186 </span><span class="lineNoCov">          0 :         return GF_OK;</span>
<a name="1187"><span class="lineNum">    1187 </span>            : }</a>
<span class="lineNum">    1188 </span>            : 
<span class="lineNum">    1189 </span>            : static GF_Descriptor *M2TS_GetServiceDesc(GF_InputService *plug, u32 expect_type, const char *sub_url)
<span class="lineNum">    1190 </span>            : {
<span class="lineNum">    1191 </span><span class="lineNoCov">          0 :         M2TSIn *m2ts = plug-&gt;priv;</span>
<span class="lineNum">    1192 </span><span class="lineNoCov">          0 :         GF_Descriptor *desc = NULL;</span>
<span class="lineNum">    1193 </span>            :         char *frag;
<span class="lineNum">    1194 </span>            :         M2TSIn_Prog *prog;
<span class="lineNum">    1195 </span>            : 
<span class="lineNum">    1196 </span><span class="lineNoCov">          0 :         if (sub_url &amp;&amp; !strnicmp(sub_url, &quot;pid://&quot;, 6)) {</span>
<span class="lineNum">    1197 </span>            :                 GF_ObjectDescriptor *od;
<span class="lineNum">    1198 </span><span class="lineNoCov">          0 :                 u32 pid = atoi(sub_url+6);</span>
<span class="lineNum">    1199 </span><span class="lineNoCov">          0 :                 if (pid&gt;=GF_M2TS_MAX_STREAMS) return NULL;</span>
<span class="lineNum">    1200 </span><span class="lineNoCov">          0 :                 od = MP2TS_GetOD(m2ts, (GF_M2TS_PES*) m2ts-&gt;ts-&gt;ess[pid], NULL, 0, NULL);</span>
<span class="lineNum">    1201 </span><span class="lineNoCov">          0 :                 return (GF_Descriptor *) od;</span>
<span class="lineNum">    1202 </span>            :         }
<span class="lineNum">    1203 </span>            : 
<span class="lineNum">    1204 </span><span class="lineNoCov">          0 :         frag = sub_url ? strrchr(sub_url, '#') : NULL;</span>
<span class="lineNum">    1205 </span><span class="lineNoCov">          0 :         if (frag) frag++;</span>
<span class="lineNum">    1206 </span>            : 
<span class="lineNum">    1207 </span>            :         /* consider the channel name in DVB URL as a fragment */
<span class="lineNum">    1208 </span><span class="lineNoCov">          0 :         if (!frag &amp;&amp; sub_url &amp;&amp; !strncmp(sub_url, &quot;dvb://&quot;, 6)) {</span>
<span class="lineNum">    1209 </span><span class="lineNoCov">          0 :                 frag = (char*)sub_url + 6;</span>
<span class="lineNum">    1210 </span><span class="lineNoCov">          0 :         }</span>
<span class="lineNum">    1211 </span>            : 
<span class="lineNum">    1212 </span><span class="lineNoCov">          0 :         if (!frag) {</span>
<span class="lineNum">    1213 </span><span class="lineNoCov">          0 :                 m2ts-&gt;request_all_pids = 1;</span>
<span class="lineNum">    1214 </span><span class="lineNoCov">          0 :         } else {</span>
<span class="lineNum">    1215 </span>            :                 /*we need exclusive access*/
<span class="lineNum">    1216 </span><span class="lineNoCov">          0 :                 gf_mx_p(m2ts-&gt;mx);</span>
<span class="lineNum">    1217 </span><span class="lineNoCov">          0 :                 if (!strnicmp(frag, &quot;pid=&quot;, 4)) {</span>
<span class="lineNum">    1218 </span><span class="lineNoCov">          0 :                         GF_SAFEALLOC(prog, M2TSIn_Prog);</span>
<span class="lineNum">    1219 </span><span class="lineNoCov">          0 :                         if (!prog) {</span>
<span class="lineNum">    1220 </span><span class="lineNoCov">          0 :                                 GF_LOG(GF_LOG_ERROR, GF_LOG_CONTAINER, (&quot;[M2TSIn] Fail to allocate pid playback request&quot;));</span>
<span class="lineNum">    1221 </span><span class="lineNoCov">          0 :                                 return NULL;</span>
<span class="lineNum">    1222 </span>            :                         }
<span class="lineNum">    1223 </span><span class="lineNoCov">          0 :                         prog-&gt;pid = atoi(frag+4);</span>
<span class="lineNum">    1224 </span><span class="lineNoCov">          0 :                         gf_list_add(m2ts-&gt;ts-&gt;requested_pids, prog);</span>
<span class="lineNum">    1225 </span><span class="lineNoCov">          0 :                 } else if (!strnicmp(frag, &quot;EPG&quot;, 3)) {</span>
<span class="lineNum">    1226 </span><span class="lineNoCov">          0 :                         m2ts-&gt;epg_requested = 1;</span>
<span class="lineNum">    1227 </span><span class="lineNoCov">          0 :                 } else {</span>
<span class="lineNum">    1228 </span>            :                         u32 i, count;
<span class="lineNum">    1229 </span><span class="lineNoCov">          0 :                         count = gf_list_count(m2ts-&gt;ts-&gt;requested_progs);</span>
<span class="lineNum">    1230 </span>            :                         prog = NULL;
<span class="lineNum">    1231 </span><span class="lineNoCov">          0 :                         for (i=0; i&lt;count; i++) {</span>
<span class="lineNum">    1232 </span><span class="lineNoCov">          0 :                                 prog = gf_list_get(m2ts-&gt;ts-&gt;requested_progs, i);</span>
<span class="lineNum">    1233 </span><span class="lineNoCov">          0 :                                 if (!strcmp(prog-&gt;fragment, frag))</span>
<span class="lineNum">    1234 </span>            :                                         break;
<span class="lineNum">    1235 </span>            :                                 prog = NULL;
<span class="lineNum">    1236 </span>            :                         }
<span class="lineNum">    1237 </span><span class="lineNoCov">          0 :                         if (!prog) {</span>
<span class="lineNum">    1238 </span><span class="lineNoCov">          0 :                                 GF_SAFEALLOC(prog, M2TSIn_Prog);</span>
<span class="lineNum">    1239 </span><span class="lineNoCov">          0 :                                 if (!prog) {</span>
<span class="lineNum">    1240 </span><span class="lineNoCov">          0 :                                         GF_LOG(GF_LOG_ERROR, GF_LOG_CONTAINER, (&quot;[M2TSIn] Fail to allocate URI fragment playback request&quot;));</span>
<span class="lineNum">    1241 </span><span class="lineNoCov">          0 :                                         return NULL;</span>
<span class="lineNum">    1242 </span>            :                                 }
<span class="lineNum">    1243 </span><span class="lineNoCov">          0 :                                 gf_list_add(m2ts-&gt;ts-&gt;requested_progs, prog);</span>
<span class="lineNum">    1244 </span><span class="lineNoCov">          0 :                                 prog-&gt;fragment = gf_strdup(frag);</span>
<span class="lineNum">    1245 </span><span class="lineNoCov">          0 :                         }</span>
<span class="lineNum">    1246 </span>            :                 }
<span class="lineNum">    1247 </span><span class="lineNoCov">          0 :                 gf_mx_v(m2ts-&gt;mx);</span>
<span class="lineNum">    1248 </span>            :         }
<span class="lineNum">    1249 </span>            : 
<span class="lineNum">    1250 </span>            :         /*if type is undefined, check the PMT for an IOD*/
<span class="lineNum">    1251 </span><span class="lineNoCov">          0 :         if (expect_type&lt;=GF_MEDIA_OBJECT_SCENE) {</span>
<span class="lineNum">    1252 </span><span class="lineNoCov">          0 :                 if (gf_list_count(m2ts-&gt;ts-&gt;programs) == 1) {</span>
<span class="lineNum">    1253 </span><span class="lineNoCov">          0 :                         GF_M2TS_Program *prog = gf_list_get(m2ts-&gt;ts-&gt;programs, 0);</span>
<span class="lineNum">    1254 </span><span class="lineNoCov">          0 :                         if (prog-&gt;pmt_iod) {</span>
<span class="lineNum">    1255 </span><span class="lineNoCov">          0 :                                 m2ts-&gt;request_all_pids = 0;</span>
<span class="lineNum">    1256 </span><span class="lineNoCov">          0 :                                 gf_odf_desc_copy((GF_Descriptor *)prog-&gt;pmt_iod, &amp;desc);</span>
<span class="lineNum">    1257 </span><span class="lineNoCov">          0 :                                 ((GF_InitialObjectDescriptor *)desc)-&gt;service_ifce = m2ts-&gt;owner;</span>
<span class="lineNum">    1258 </span><span class="lineNoCov">          0 :                                 return desc;</span>
<span class="lineNum">    1259 </span>            :                         }
<span class="lineNum">    1260 </span>            :                 }
<span class="lineNum">    1261 </span>            :                 /*if we expect scene, return NULL and repost a connection ack when we get the PMT*/
<span class="lineNum">    1262 </span><span class="lineNoCov">          0 :                 if (expect_type==GF_MEDIA_OBJECT_SCENE)</span>
<span class="lineNum">    1263 </span><span class="lineNoCov">          0 :                         return NULL;</span>
<span class="lineNum">    1264 </span><span class="lineNoCov">          0 :                 if (m2ts-&gt;epg_requested) {</span>
<span class="lineNum">    1265 </span><span class="lineNoCov">          0 :                         GF_ObjectDescriptor *od = M2TS_GenerateEPG_OD(m2ts);</span>
<span class="lineNum">    1266 </span><span class="lineNoCov">          0 :                         m2ts-&gt;epg_requested = 0;</span>
<span class="lineNum">    1267 </span><span class="lineNoCov">          0 :                         return (GF_Descriptor *)od;</span>
<span class="lineNum">    1268 </span>            :                 } else {
<span class="lineNum">    1269 </span>            :                         /*returning an empty IOD means &quot;no scene description&quot;, let the terminal handle all media objects*/
<span class="lineNum">    1270 </span><span class="lineNoCov">          0 :                         desc = gf_odf_desc_new(GF_ODF_IOD_TAG);</span>
<span class="lineNum">    1271 </span><span class="lineNoCov">          0 :                         ((GF_ObjectDescriptor *) desc)-&gt;objectDescriptorID = 1;</span>
<span class="lineNum">    1272 </span><span class="lineNoCov">          0 :                         return desc;</span>
<span class="lineNum">    1273 </span>            :                 }
<span class="lineNum">    1274 </span>            :         }
<span class="lineNum">    1275 </span>            : 
<span class="lineNum">    1276 </span>            :         /* restart the thread if the same service is reused and if the previous thread terminated */
<span class="lineNum">    1277 </span><span class="lineNoCov">          0 :         if (!plug-&gt;query_proxy) {</span>
<span class="lineNum">    1278 </span><span class="lineNoCov">          0 :                 if (m2ts-&gt;ts-&gt;run_state == 2) {</span>
<span class="lineNum">    1279 </span><span class="lineNoCov">          0 :                         m2ts-&gt;file_regulate = 0;</span>
<span class="lineNum">    1280 </span><span class="lineNoCov">          0 :                         gf_m2ts_demuxer_play(m2ts-&gt;ts);</span>
<span class="lineNum">    1281 </span><span class="lineNoCov">          0 :                 }</span>
<span class="lineNum">    1282 </span>            :         }
<span class="lineNum">    1283 </span><span class="lineNoCov">          0 :         return NULL;</span>
<a name="1284"><span class="lineNum">    1284 </span><span class="lineNoCov">          0 : }</span></a>
<span class="lineNum">    1285 </span>            : 
<span class="lineNum">    1286 </span>            : static GF_Err M2TS_ConnectChannel(GF_InputService *plug, LPNETCHANNEL channel, const char *url, Bool upstream)
<span class="lineNum">    1287 </span>            : {
<span class="lineNum">    1288 </span>            :         u32 ES_ID;
<span class="lineNum">    1289 </span>            :         GF_Err e;
<span class="lineNum">    1290 </span><span class="lineNoCov">          0 :         M2TSIn *m2ts = plug-&gt;priv;</span>
<span class="lineNum">    1291 </span>            : 
<span class="lineNum">    1292 </span>            :         e = GF_STREAM_NOT_FOUND;
<span class="lineNum">    1293 </span><span class="lineNoCov">          0 :         if (strstr(url, &quot;ES_ID&quot;)) {</span>
<span class="lineNum">    1294 </span><span class="lineNoCov">          0 :                 sscanf(url, &quot;ES_ID=%d&quot;, &amp;ES_ID);</span>
<span class="lineNum">    1295 </span>            : 
<span class="lineNum">    1296 </span>            :                 /* In case there is a real IOD, we need to translate PID into ESID */
<span class="lineNum">    1297 </span><span class="lineNoCov">          0 :                 if (gf_list_count(m2ts-&gt;ts-&gt;programs) == 1) {</span>
<span class="lineNum">    1298 </span><span class="lineNoCov">          0 :                         GF_M2TS_Program *prog = gf_list_get(m2ts-&gt;ts-&gt;programs, 0);</span>
<span class="lineNum">    1299 </span><span class="lineNoCov">          0 :                         if (prog-&gt;pmt_iod) {</span>
<span class="lineNum">    1300 </span>            :                                 /* IOD is present */
<span class="lineNum">    1301 </span>            :                                 u32 i;
<span class="lineNum">    1302 </span><span class="lineNoCov">          0 :                                 for (i=0; i&lt;GF_M2TS_MAX_STREAMS; i++) {</span>
<span class="lineNum">    1303 </span><span class="lineNoCov">          0 :                                         GF_M2TS_PES *pes = (GF_M2TS_PES *)m2ts-&gt;ts-&gt;ess[i];</span>
<span class="lineNum">    1304 </span><span class="lineNoCov">          0 :                                         if (!pes || (pes-&gt;pid==pes-&gt;program-&gt;pmt_pid)) continue;</span>
<span class="lineNum">    1305 </span><span class="lineNoCov">          0 :                                         if ((pes-&gt;mpeg4_es_id == ES_ID)</span>
<span class="lineNum">    1306 </span>            :                                                 /*for pid:// url*/
<span class="lineNum">    1307 </span>            :                                                 || (!pes-&gt;mpeg4_es_id &amp;&amp; (pes-&gt;pid == ES_ID))
<span class="lineNum">    1308 </span>            :                                            ) {
<span class="lineNum">    1309 </span><span class="lineNoCov">          0 :                                                 if (pes-&gt;user) {</span>
<span class="lineNum">    1310 </span>            :                                                         e = GF_SERVICE_ERROR;
<span class="lineNum">    1311 </span><span class="lineNoCov">          0 :                                                         gf_service_connect_ack(m2ts-&gt;service, channel, e);</span>
<span class="lineNum">    1312 </span><span class="lineNoCov">          0 :                                                         return e;</span>
<span class="lineNum">    1313 </span>            :                                                 } else {
<span class="lineNum">    1314 </span><span class="lineNoCov">          0 :                                                         pes-&gt;user = channel;</span>
<span class="lineNum">    1315 </span>            :                                                         e = GF_OK;
<span class="lineNum">    1316 </span><span class="lineNoCov">          0 :                                                         gf_service_connect_ack(m2ts-&gt;service, channel, e);</span>
<span class="lineNum">    1317 </span><span class="lineNoCov">          0 :                                                         return e;</span>
<span class="lineNum">    1318 </span>            :                                                 }
<span class="lineNum">    1319 </span>            :                                         }
<span class="lineNum">    1320 </span>            :                                 }
<span class="lineNum">    1321 </span>            :                                 /* Stream not found */
<span class="lineNum">    1322 </span><span class="lineNoCov">          0 :                                 return e;</span>
<span class="lineNum">    1323 </span>            :                         }
<span class="lineNum">    1324 </span>            :                 }
<span class="lineNum">    1325 </span>            : 
<span class="lineNum">    1326 </span>            :                 /* No IOD */
<span class="lineNum">    1327 </span><span class="lineNoCov">          0 :                 if ((ES_ID == 18) &amp;&amp; (!m2ts-&gt;ts-&gt;ess[18] || !(m2ts-&gt;ts-&gt;ess[18]-&gt;flags &amp; GF_M2TS_ES_IS_PES)) ) {</span>
<span class="lineNum">    1328 </span>            :                         e = GF_OK; /* 18 is the PID of EIT packets */
<span class="lineNum">    1329 </span><span class="lineNoCov">          0 :                         m2ts-&gt;eit_channel = channel;</span>
<span class="lineNum">    1330 </span><span class="lineNoCov">          0 :                 } else if (ES_ID&lt;GF_M2TS_MAX_STREAMS) {</span>
<span class="lineNum">    1331 </span>            :                         u32 i, j, count, count2;
<span class="lineNum">    1332 </span>            :                         e = GF_SERVICE_ERROR;
<span class="lineNum">    1333 </span><span class="lineNoCov">          0 :                         count = gf_list_count(m2ts-&gt;ts-&gt;programs);</span>
<span class="lineNum">    1334 </span><span class="lineNoCov">          0 :                         for (i=0; i&lt;count; i++) {</span>
<span class="lineNum">    1335 </span><span class="lineNoCov">          0 :                                 GF_M2TS_Program *prog = gf_list_get(m2ts-&gt;ts-&gt;programs, i);</span>
<span class="lineNum">    1336 </span><span class="lineNoCov">          0 :                                 count2 = gf_list_count(prog-&gt;streams);</span>
<span class="lineNum">    1337 </span><span class="lineNoCov">          0 :                                 for (j=0; j&lt;count2; j++) {</span>
<span class="lineNum">    1338 </span><span class="lineNoCov">          0 :                                         GF_M2TS_PES *pes = (GF_M2TS_PES *)gf_list_get(prog-&gt;streams, j);</span>
<span class="lineNum">    1339 </span><span class="lineNoCov">          0 :                                         if ((pes-&gt;pid == ES_ID) &amp;&amp; !pes-&gt;user) {</span>
<span class="lineNum">    1340 </span><span class="lineNoCov">          0 :                                                 pes-&gt;user = channel;</span>
<span class="lineNum">    1341 </span>            :                                                 /*we try to play the highest layer*/
<span class="lineNum">    1342 </span><span class="lineNoCov">          0 :                                                 if (pes-&gt;program-&gt;pid_playing &lt; pes-&gt;pid)</span>
<span class="lineNum">    1343 </span><span class="lineNoCov">          0 :                                                         pes-&gt;program-&gt;pid_playing = pes-&gt;pid;</span>
<span class="lineNum">    1344 </span>            :                                                 e = GF_OK;
<span class="lineNum">    1345 </span><span class="lineNoCov">          0 :                                                 break;</span>
<span class="lineNum">    1346 </span>            :                                         }
<span class="lineNum">    1347 </span>            :                                 }
<span class="lineNum">    1348 </span>            :                         }
<span class="lineNum">    1349 </span>            :                 }
<span class="lineNum">    1350 </span>            :         }
<span class="lineNum">    1351 </span><span class="lineNoCov">          0 :         gf_service_connect_ack(m2ts-&gt;service, channel, e);</span>
<span class="lineNum">    1352 </span><span class="lineNoCov">          0 :         return e;</span>
<a name="1353"><span class="lineNum">    1353 </span><span class="lineNoCov">          0 : }</span></a>
<span class="lineNum">    1354 </span>            : 
<span class="lineNum">    1355 </span>            : static GF_M2TS_PES *M2TS_GetChannel(M2TSIn *m2ts, LPNETCHANNEL channel)
<span class="lineNum">    1356 </span>            : {
<span class="lineNum">    1357 </span>            :         u32 i, j, count, count2;
<span class="lineNum">    1358 </span><span class="lineNoCov">          0 :         count = gf_list_count(m2ts-&gt;ts-&gt;programs);</span>
<span class="lineNum">    1359 </span><span class="lineNoCov">          0 :         for (i=0; i&lt;count; i++) {</span>
<span class="lineNum">    1360 </span><span class="lineNoCov">          0 :                 GF_M2TS_Program *prog = gf_list_get(m2ts-&gt;ts-&gt;programs, i);</span>
<span class="lineNum">    1361 </span><span class="lineNoCov">          0 :                 count2 = gf_list_count(prog-&gt;streams);</span>
<span class="lineNum">    1362 </span><span class="lineNoCov">          0 :                 for (j=0; j&lt;count2; j++) {</span>
<span class="lineNum">    1363 </span><span class="lineNoCov">          0 :                         GF_M2TS_PES *pes = (GF_M2TS_PES *)gf_list_get(prog-&gt;streams, j);</span>
<span class="lineNum">    1364 </span><span class="lineNoCov">          0 :                         if (pes-&gt;user == channel) return pes;</span>
<span class="lineNum">    1365 </span>            :                 }
<span class="lineNum">    1366 </span>            :         }
<span class="lineNum">    1367 </span><span class="lineNoCov">          0 :         return NULL;</span>
<a name="1368"><span class="lineNum">    1368 </span><span class="lineNoCov">          0 : }</span></a>
<span class="lineNum">    1369 </span>            : 
<span class="lineNum">    1370 </span>            : static GF_M2TS_PES *M2TS_GetFirstRunningChannel(M2TSIn *m2ts)
<span class="lineNum">    1371 </span>            : {
<span class="lineNum">    1372 </span>            :         u32 i;
<span class="lineNum">    1373 </span><span class="lineNoCov">          0 :         for (i=0; i&lt;GF_M2TS_MAX_STREAMS; i++) {</span>
<span class="lineNum">    1374 </span><span class="lineNoCov">          0 :                 GF_M2TS_PES *pes = (GF_M2TS_PES *)m2ts-&gt;ts-&gt;ess[i];</span>
<span class="lineNum">    1375 </span><span class="lineNoCov">          0 :                 if (!pes || (pes-&gt;pid==pes-&gt;program-&gt;pmt_pid)) continue;</span>
<span class="lineNum">    1376 </span><span class="lineNoCov">          0 :                 if (!pes-&gt;user) continue;</span>
<span class="lineNum">    1377 </span>            : 
<span class="lineNum">    1378 </span><span class="lineNoCov">          0 :                 if (gf_m2ts_pes_get_framing_mode(pes) &gt;= GF_M2TS_PES_FRAMING_DEFAULT)</span>
<span class="lineNum">    1379 </span><span class="lineNoCov">          0 :                         return pes;</span>
<span class="lineNum">    1380 </span>            :         }
<span class="lineNum">    1381 </span><span class="lineNoCov">          0 :         return NULL;</span>
<a name="1382"><span class="lineNum">    1382 </span><span class="lineNoCov">          0 : }</span></a>
<span class="lineNum">    1383 </span>            : 
<span class="lineNum">    1384 </span>            : static GF_Err M2TS_DisconnectChannel(GF_InputService *plug, LPNETCHANNEL channel)
<span class="lineNum">    1385 </span>            : {
<span class="lineNum">    1386 </span><span class="lineNoCov">          0 :         M2TSIn *m2ts = plug-&gt;priv;</span>
<span class="lineNum">    1387 </span>            :         GF_Err e = GF_STREAM_NOT_FOUND;
<span class="lineNum">    1388 </span><span class="lineNoCov">          0 :         GF_M2TS_PES *pes = M2TS_GetChannel(m2ts, channel);</span>
<span class="lineNum">    1389 </span><span class="lineNoCov">          0 :         if (pes) {</span>
<span class="lineNum">    1390 </span><span class="lineNoCov">          0 :                 pes-&gt;user = NULL;</span>
<span class="lineNum">    1391 </span>            :                 e = GF_OK;
<span class="lineNum">    1392 </span><span class="lineNoCov">          0 :         }</span>
<span class="lineNum">    1393 </span><span class="lineNoCov">          0 :         gf_service_disconnect_ack(m2ts-&gt;service, channel, e);</span>
<span class="lineNum">    1394 </span><span class="lineNoCov">          0 :         return GF_OK;</span>
<a name="1395"><span class="lineNum">    1395 </span>            : }</a>
<span class="lineNum">    1396 </span>            : 
<span class="lineNum">    1397 </span>            : static void gf_m2ts_switch_quality(GF_M2TS_Program *prog, GF_M2TS_Demuxer *ts, Bool switch_up)
<span class="lineNum">    1398 </span>            : {
<span class="lineNum">    1399 </span>            :         GF_M2TS_ES *es;
<span class="lineNum">    1400 </span>            :         u32 i, count;
<span class="lineNum">    1401 </span><span class="lineNoCov">          0 :         GF_NetworkCommand com;</span>
<span class="lineNum">    1402 </span>            : 
<span class="lineNum">    1403 </span><span class="lineNoCov">          0 :         if (!prog-&gt;is_scalable)</span>
<span class="lineNum">    1404 </span><span class="lineNoCov">          0 :                 return;</span>
<span class="lineNum">    1405 </span>            : 
<span class="lineNum">    1406 </span><span class="lineNoCov">          0 :         if (switch_up) {</span>
<span class="lineNum">    1407 </span><span class="lineNoCov">          0 :                 for (i = 0; i &lt; GF_M2TS_MAX_STREAMS; i++) {</span>
<span class="lineNum">    1408 </span><span class="lineNoCov">          0 :                         es = ts-&gt;ess[i];</span>
<span class="lineNum">    1409 </span><span class="lineNoCov">          0 :                         if (es &amp;&amp; (es-&gt;flags &amp; GF_M2TS_ES_IS_PES) &amp;&amp; (((GF_M2TS_PES *)es)-&gt;depends_on_pid == prog-&gt;pid_playing)) {</span>
<span class="lineNum">    1410 </span><span class="lineNoCov">          0 :                                 GF_LOG(GF_LOG_DEBUG, GF_LOG_CODEC, (&quot;Turn on ES%d\n&quot;, es-&gt;pid));</span>
<span class="lineNum">    1411 </span><span class="lineNoCov">          0 :                                 gf_m2ts_set_pes_framing((GF_M2TS_PES *)ts-&gt;ess[es-&gt;pid], GF_M2TS_PES_FRAMING_DEFAULT);</span>
<span class="lineNum">    1412 </span><span class="lineNoCov">          0 :                                 prog-&gt;pid_playing = es-&gt;pid;</span>
<span class="lineNum">    1413 </span><span class="lineNoCov">          0 :                                 return;</span>
<span class="lineNum">    1414 </span>            :                         }
<span class="lineNum">    1415 </span>            :                 }
<span class="lineNum">    1416 </span>            :         }
<span class="lineNum">    1417 </span>            :         else {
<span class="lineNum">    1418 </span><span class="lineNoCov">          0 :                 count = gf_list_count(prog-&gt;streams);</span>
<span class="lineNum">    1419 </span><span class="lineNoCov">          0 :                 for (i = 0; i &lt; count; i++) {</span>
<span class="lineNum">    1420 </span><span class="lineNoCov">          0 :                         es = (GF_M2TS_ES *)gf_list_get(prog-&gt;streams, i);</span>
<span class="lineNum">    1421 </span><span class="lineNoCov">          0 :                         if (es &amp;&amp; (es-&gt;pid == prog-&gt;pid_playing) &amp;&amp; ((GF_M2TS_PES *)es)-&gt;depends_on_pid) {</span>
<span class="lineNum">    1422 </span><span class="lineNoCov">          0 :                                 GF_LOG(GF_LOG_DEBUG, GF_LOG_CODEC, (&quot;Turn off ES%d - playing ES%d\n&quot;, es-&gt;pid, ((GF_M2TS_PES *)es)-&gt;depends_on_pid));</span>
<span class="lineNum">    1423 </span><span class="lineNoCov">          0 :                                 gf_m2ts_set_pes_framing((GF_M2TS_PES *)ts-&gt;ess[es-&gt;pid], GF_M2TS_PES_FRAMING_SKIP);</span>
<span class="lineNum">    1424 </span><span class="lineNoCov">          0 :                                 memset(&amp;com, 0, sizeof(com));</span>
<span class="lineNum">    1425 </span><span class="lineNoCov">          0 :                                 com.command_type = GF_NET_CHAN_RESET;</span>
<span class="lineNum">    1426 </span><span class="lineNoCov">          0 :                                 com.base.on_channel = ((GF_M2TS_PES *)es)-&gt;user;</span>
<span class="lineNum">    1427 </span><span class="lineNoCov">          0 :                                 gf_service_command(((M2TSIn *)ts-&gt;user)-&gt;service, &amp;com, GF_OK);</span>
<span class="lineNum">    1428 </span><span class="lineNoCov">          0 :                                 prog-&gt;pid_playing = ((GF_M2TS_PES *)es)-&gt;depends_on_pid;</span>
<span class="lineNum">    1429 </span><span class="lineNoCov">          0 :                                 return;</span>
<span class="lineNum">    1430 </span>            :                         }
<span class="lineNum">    1431 </span>            :                 }
<span class="lineNum">    1432 </span>            :         }
<a name="1433"><span class="lineNum">    1433 </span><span class="lineNoCov">          0 : }</span></a>
<span class="lineNum">    1434 </span>            : 
<span class="lineNum">    1435 </span>            : static GF_Err M2TS_ServiceCommand(GF_InputService *plug, GF_NetworkCommand *com)
<span class="lineNum">    1436 </span>            : {
<span class="lineNum">    1437 </span>            :         GF_M2TS_PES *pes;
<span class="lineNum">    1438 </span><span class="lineNoCov">          0 :         M2TSIn *m2ts = plug-&gt;priv;</span>
<span class="lineNum">    1439 </span><span class="lineNoCov">          0 :         GF_M2TS_Demuxer *ts = m2ts-&gt;ts;</span>
<span class="lineNum">    1440 </span>            : 
<span class="lineNum">    1441 </span><span class="lineNoCov">          0 :         if (com-&gt;command_type==GF_NET_SERVICE_HAS_AUDIO) {</span>
<span class="lineNum">    1442 </span><span class="lineNoCov">          0 :                 char *frag = strchr(com-&gt;audio.base_url, '#');</span>
<span class="lineNum">    1443 </span><span class="lineNoCov">          0 :                 if (frag &amp;&amp; !strnicmp(frag, &quot;#pid=&quot;, 5)) return GF_NOT_SUPPORTED;</span>
<span class="lineNum">    1444 </span><span class="lineNoCov">          0 :                 return GF_OK;</span>
<span class="lineNum">    1445 </span>            :         }
<span class="lineNum">    1446 </span><span class="lineNoCov">          0 :         if (com-&gt;command_type == GF_NET_SERVICE_QUALITY_SWITCH) {</span>
<span class="lineNum">    1447 </span>            :                 u32 i, count;
<span class="lineNum">    1448 </span><span class="lineNoCov">          0 :                 count = gf_list_count(ts-&gt;programs);</span>
<span class="lineNum">    1449 </span><span class="lineNoCov">          0 :                 for (i = 0; i &lt; count; i++) {</span>
<span class="lineNum">    1450 </span><span class="lineNoCov">          0 :                         GF_M2TS_Program *prog = (GF_M2TS_Program *)gf_list_get(ts-&gt;programs, i);</span>
<span class="lineNum">    1451 </span><span class="lineNoCov">          0 :                         gf_m2ts_switch_quality(prog, ts, com-&gt;switch_quality.up);</span>
<span class="lineNum">    1452 </span>            :                 }
<span class="lineNum">    1453 </span><span class="lineNoCov">          0 :                 return GF_OK;</span>
<span class="lineNum">    1454 </span>            :         }
<span class="lineNum">    1455 </span><span class="lineNoCov">          0 :         if (com-&gt;command_type == GF_NET_SERVICE_PROXY_DATA_RECEIVE) {</span>
<span class="lineNum">    1456 </span><span class="lineNoCov">          0 :                 m2ts_flush_data(m2ts, com-&gt;proxy_data.is_chunk ? GF_M2TS_PUSH_CHUNK : GF_M2TS_PUSH_SEGMENT);</span>
<span class="lineNum">    1457 </span><span class="lineNoCov">          0 :                 return GF_OK;</span>
<span class="lineNum">    1458 </span>            :         }
<span class="lineNum">    1459 </span><span class="lineNoCov">          0 :         if (com-&gt;command_type == GF_NET_SERVICE_FLUSH_DATA) {</span>
<span class="lineNum">    1460 </span><span class="lineNoCov">          0 :                 if (plug-&gt;query_proxy)</span>
<span class="lineNum">    1461 </span><span class="lineNoCov">          0 :                         m2ts_flush_data(m2ts, GF_M2TS_FLUSH_DATA);</span>
<span class="lineNum">    1462 </span><span class="lineNoCov">          0 :                 return GF_OK;</span>
<span class="lineNum">    1463 </span>            :         }
<span class="lineNum">    1464 </span>            :         //get info on the first running program
<span class="lineNum">    1465 </span><span class="lineNoCov">          0 :         if (com-&gt;command_type==GF_NET_SERVICE_INFO) {</span>
<span class="lineNum">    1466 </span><span class="lineNoCov">          0 :                 u32 id = com-&gt;info.service_id;</span>
<span class="lineNum">    1467 </span><span class="lineNoCov">          0 :                 if (!id) {</span>
<span class="lineNum">    1468 </span><span class="lineNoCov">          0 :                         pes = M2TS_GetFirstRunningChannel(m2ts);</span>
<span class="lineNum">    1469 </span><span class="lineNoCov">          0 :                         if (pes) id = pes-&gt;program-&gt;number;</span>
<span class="lineNum">    1470 </span>            :                 }
<span class="lineNum">    1471 </span><span class="lineNoCov">          0 :                 if (id) {</span>
<span class="lineNum">    1472 </span><span class="lineNoCov">          0 :                         GF_M2TS_SDT *sdt = gf_m2ts_get_sdt_info(ts, id);</span>
<span class="lineNum">    1473 </span><span class="lineNoCov">          0 :                         if (sdt) {</span>
<span class="lineNum">    1474 </span><span class="lineNoCov">          0 :                                 com-&gt;info.name = sdt-&gt;service;</span>
<span class="lineNum">    1475 </span><span class="lineNoCov">          0 :                                 com-&gt;info.provider = sdt-&gt;provider;</span>
<span class="lineNum">    1476 </span><span class="lineNoCov">          0 :                         }</span>
<span class="lineNum">    1477 </span>            :                 } else {
<span class="lineNum">    1478 </span><span class="lineNoCov">          0 :                         m2ts-&gt;flush_sdt = 1;</span>
<span class="lineNum">    1479 </span>            :                 }
<span class="lineNum">    1480 </span><span class="lineNoCov">          0 :                 return GF_OK;</span>
<span class="lineNum">    1481 </span>            :         }
<span class="lineNum">    1482 </span>            : 
<span class="lineNum">    1483 </span>            : 
<span class="lineNum">    1484 </span><span class="lineNoCov">          0 :         if (!com-&gt;base.on_channel) return GF_NOT_SUPPORTED;</span>
<span class="lineNum">    1485 </span><span class="lineNoCov">          0 :         switch (com-&gt;command_type) {</span>
<span class="lineNum">    1486 </span>            :         /*we cannot pull complete AUs from the stream*/
<span class="lineNum">    1487 </span>            :         case GF_NET_CHAN_SET_PULL:
<span class="lineNum">    1488 </span><span class="lineNoCov">          0 :                 return GF_NOT_SUPPORTED;</span>
<span class="lineNum">    1489 </span>            :         /*we cannot seek stream by stream*/
<span class="lineNum">    1490 </span>            :         case GF_NET_CHAN_INTERACTIVE:
<span class="lineNum">    1491 </span><span class="lineNoCov">          0 :                 if (m2ts-&gt;ts-&gt;file) return GF_OK;</span>
<span class="lineNum">    1492 </span><span class="lineNoCov">          0 :                 return GF_NOT_SUPPORTED;</span>
<span class="lineNum">    1493 </span>            :         case GF_NET_CHAN_BUFFER:
<span class="lineNum">    1494 </span>            :                 //do not override config
<span class="lineNum">    1495 </span><span class="lineNoCov">          0 :                 if (ts-&gt;dnload || plug-&gt;query_proxy) {</span>
<span class="lineNum">    1496 </span><span class="lineNoCov">          0 :                         if (!com-&gt;buffer.max) com-&gt;buffer.max = 1000;</span>
<span class="lineNum">    1497 </span>            :                 }
<span class="lineNum">    1498 </span><span class="lineNoCov">          0 :                 return GF_OK;</span>
<span class="lineNum">    1499 </span>            :         case GF_NET_CHAN_DURATION:
<span class="lineNum">    1500 </span><span class="lineNoCov">          0 :                 com-&gt;duration.duration = ts-&gt;duration;</span>
<span class="lineNum">    1501 </span><span class="lineNoCov">          0 :                 return GF_OK;</span>
<span class="lineNum">    1502 </span>            :         case GF_NET_CHAN_PLAY:
<span class="lineNum">    1503 </span><span class="lineNoCov">          0 :                 pes = M2TS_GetChannel(m2ts, com-&gt;base.on_channel);</span>
<span class="lineNum">    1504 </span><span class="lineNoCov">          0 :                 if (!pes) {</span>
<span class="lineNum">    1505 </span><span class="lineNoCov">          0 :                         if (com-&gt;base.on_channel == m2ts-&gt;eit_channel) {</span>
<span class="lineNum">    1506 </span><span class="lineNoCov">          0 :                                 return GF_OK;</span>
<span class="lineNum">    1507 </span>            :                         }
<span class="lineNum">    1508 </span><span class="lineNoCov">          0 :                         return GF_STREAM_NOT_FOUND;</span>
<span class="lineNum">    1509 </span>            :                 }
<span class="lineNum">    1510 </span>            :                 /*mark pcr as not initialized*/
<span class="lineNum">    1511 </span><span class="lineNoCov">          0 :                 if (pes-&gt;program-&gt;pcr_pid==pes-&gt;pid) pes-&gt;program-&gt;first_dts=0;</span>
<span class="lineNum">    1512 </span><span class="lineNoCov">          0 :                 gf_m2ts_set_pes_framing(pes, GF_M2TS_PES_FRAMING_DEFAULT);</span>
<span class="lineNum">    1513 </span><span class="lineNoCov">          0 :                 GF_LOG(GF_LOG_INFO, GF_LOG_CONTAINER, (&quot;[M2TSIn] Setting default reframing for PID %d\n&quot;, pes-&gt;pid));</span>
<span class="lineNum">    1514 </span>            :                 /*this is a multplex, only trigger the play command for the first stream activated*/
<span class="lineNum">    1515 </span><span class="lineNoCov">          0 :                 if (!m2ts-&gt;nb_playing) {</span>
<span class="lineNum">    1516 </span><span class="lineNoCov">          0 :                         if (ts-&gt;file) {</span>
<span class="lineNum">    1517 </span><span class="lineNoCov">          0 :                                 ts-&gt;start_range = (u32) (com-&gt;play.start_range*1000);</span>
<span class="lineNum">    1518 </span><span class="lineNoCov">          0 :                                 ts-&gt;end_range = (com-&gt;play.end_range&gt;0) ? (u32) (com-&gt;play.end_range*1000) : 0;</span>
<span class="lineNum">    1519 </span><span class="lineNoCov">          0 :                                 m2ts-&gt;media_start_range = com-&gt;play.start_range;</span>
<span class="lineNum">    1520 </span><span class="lineNoCov">          0 :                         }</span>
<span class="lineNum">    1521 </span><span class="lineNoCov">          0 :                         if (!m2ts-&gt;map_media_time_on_prog_id)</span>
<span class="lineNum">    1522 </span><span class="lineNoCov">          0 :                                 m2ts-&gt;map_media_time_on_prog_id = pes-&gt;program-&gt;number;</span>
<span class="lineNum">    1523 </span>            : 
<span class="lineNum">    1524 </span><span class="lineNoCov">          0 :                         if (com-&gt;play.dash_segment_switch) {</span>
<span class="lineNum">    1525 </span>            :                                 /*this is used in case of HLS stream while we need update media start time for mapping*/
<span class="lineNum">    1526 </span><span class="lineNoCov">          0 :                                 m2ts-&gt;media_start_range = com-&gt;play.start_range;</span>
<span class="lineNum">    1527 </span><span class="lineNoCov">          0 :                                 gf_m2ts_abort_parsing(ts, GF_TRUE);</span>
<span class="lineNum">    1528 </span><span class="lineNoCov">          0 :                         }</span>
<span class="lineNum">    1529 </span>            : 
<span class="lineNum">    1530 </span>            :                         /*start demuxer*/
<span class="lineNum">    1531 </span><span class="lineNoCov">          0 :                         if (!plug-&gt;query_proxy) {</span>
<span class="lineNum">    1532 </span><span class="lineNoCov">          0 :                                 if (ts-&gt;run_state!=1) {</span>
<span class="lineNum">    1533 </span><span class="lineNoCov">          0 :                                         gf_m2ts_demuxer_play(ts);</span>
<span class="lineNum">    1534 </span><span class="lineNoCov">          0 :                                 }</span>
<span class="lineNum">    1535 </span>            :                         }
<span class="lineNum">    1536 </span>            :                 }
<span class="lineNum">    1537 </span>            :                 //remap media time for this program
<span class="lineNum">    1538 </span><span class="lineNoCov">          0 :                 else if (!m2ts-&gt;map_media_time_on_prog_id) {</span>
<span class="lineNum">    1539 </span><span class="lineNoCov">          0 :                         m2ts-&gt;media_start_range = com-&gt;play.start_range;</span>
<span class="lineNum">    1540 </span><span class="lineNoCov">          0 :                         m2ts-&gt;map_media_time_on_prog_id = pes-&gt;program-&gt;number;</span>
<span class="lineNum">    1541 </span><span class="lineNoCov">          0 :                 }</span>
<span class="lineNum">    1542 </span><span class="lineNoCov">          0 :                 if (!m2ts-&gt;nb_playing) {</span>
<span class="lineNum">    1543 </span><span class="lineNoCov">          0 :                         gf_m2ts_pause_demux(ts, 0);</span>
<span class="lineNum">    1544 </span><span class="lineNoCov">          0 :                 }</span>
<span class="lineNum">    1545 </span><span class="lineNoCov">          0 :                 m2ts-&gt;nb_playing++;</span>
<span class="lineNum">    1546 </span><span class="lineNoCov">          0 :                 return GF_OK;</span>
<span class="lineNum">    1547 </span>            :         case GF_NET_CHAN_STOP:
<span class="lineNum">    1548 </span><span class="lineNoCov">          0 :                 pes = M2TS_GetChannel(m2ts, com-&gt;base.on_channel);</span>
<span class="lineNum">    1549 </span><span class="lineNoCov">          0 :                 if (!pes) {</span>
<span class="lineNum">    1550 </span><span class="lineNoCov">          0 :                         if (com-&gt;base.on_channel == m2ts-&gt;eit_channel) {</span>
<span class="lineNum">    1551 </span><span class="lineNoCov">          0 :                                 return GF_OK;</span>
<span class="lineNum">    1552 </span>            :                         }
<span class="lineNum">    1553 </span><span class="lineNoCov">          0 :                         return GF_STREAM_NOT_FOUND;</span>
<span class="lineNum">    1554 </span>            :                 }
<span class="lineNum">    1555 </span>            :                 /* In case of EOS, we may receive a stop command after no one is playing */
<span class="lineNum">    1556 </span><span class="lineNoCov">          0 :                 if (m2ts-&gt;nb_playing)</span>
<span class="lineNum">    1557 </span><span class="lineNoCov">          0 :                         m2ts-&gt;nb_playing--;</span>
<span class="lineNum">    1558 </span>            :                 /*stop demuxer*/
<span class="lineNum">    1559 </span><span class="lineNoCov">          0 :                 if (!plug-&gt;query_proxy) {</span>
<span class="lineNum">    1560 </span><span class="lineNoCov">          0 :                         if (!m2ts-&gt;nb_playing &amp;&amp; (ts-&gt;run_state==1) &amp;&amp; !m2ts-&gt;nb_prog_to_setup) {</span>
<span class="lineNum">    1561 </span><span class="lineNoCov">          0 :                                 ts-&gt;run_state=0;</span>
<span class="lineNum">    1562 </span><span class="lineNoCov">          0 :                                 while (ts-&gt;run_state!=2) gf_sleep(2);</span>
<span class="lineNum">    1563 </span><span class="lineNoCov">          0 :                                 if (gf_list_count(m2ts-&gt;ts-&gt;requested_progs)) {</span>
<span class="lineNum">    1564 </span><span class="lineNoCov">          0 :                                         m2ts-&gt;file_regulate = 0;</span>
<span class="lineNum">    1565 </span><span class="lineNoCov">          0 :                                         gf_m2ts_set_pes_framing(pes, GF_M2TS_PES_FRAMING_SKIP);</span>
<span class="lineNum">    1566 </span><span class="lineNoCov">          0 :                                         return gf_m2ts_demuxer_play(ts);</span>
<span class="lineNum">    1567 </span>            :                                 }
<span class="lineNum">    1568 </span>            :                         }
<span class="lineNum">    1569 </span>            :                 }
<span class="lineNum">    1570 </span><span class="lineNoCov">          0 :                 gf_m2ts_set_pes_framing(pes, GF_M2TS_PES_FRAMING_SKIP);</span>
<span class="lineNum">    1571 </span><span class="lineNoCov">          0 :                 return GF_OK;</span>
<span class="lineNum">    1572 </span>            :         case GF_NET_CHAN_CONFIG:
<span class="lineNum">    1573 </span><span class="lineNoCov">          0 :                 pes = M2TS_GetChannel(m2ts, com-&gt;base.on_channel);</span>
<span class="lineNum">    1574 </span>            :                 /*filter all sections carrying SL data for the app to signal the version number of the section*/
<span class="lineNum">    1575 </span><span class="lineNoCov">          0 :                 if (pes &amp;&amp; pes-&gt;flags &amp; GF_M2TS_ES_IS_SECTION) {</span>
<span class="lineNum">    1576 </span><span class="lineNoCov">          0 :                         if (pes-&gt;slcfg) gf_free(pes-&gt;slcfg);</span>
<span class="lineNum">    1577 </span><span class="lineNoCov">          0 :                         pes-&gt;slcfg = gf_malloc(sizeof(GF_SLConfig));</span>
<span class="lineNum">    1578 </span><span class="lineNoCov">          0 :                         memcpy(pes-&gt;slcfg, &amp;com-&gt;cfg.sl_config, sizeof(GF_SLConfig));</span>
<span class="lineNum">    1579 </span><span class="lineNoCov">          0 :                         com-&gt;cfg.use_m2ts_sections = 1;</span>
<span class="lineNum">    1580 </span><span class="lineNoCov">          0 :                         pes-&gt;flags |= GF_M2TS_ES_SEND_REPEATED_SECTIONS;</span>
<span class="lineNum">    1581 </span><span class="lineNoCov">          0 :                 }</span>
<span class="lineNum">    1582 </span><span class="lineNoCov">          0 :                 return GF_OK;</span>
<span class="lineNum">    1583 </span>            :         case GF_NET_CHAN_PAUSE:
<span class="lineNum">    1584 </span><span class="lineNoCov">          0 :                 if (!m2ts-&gt;nb_paused) {</span>
<span class="lineNum">    1585 </span><span class="lineNoCov">          0 :                         gf_m2ts_pause_demux(m2ts-&gt;ts, 1);</span>
<span class="lineNum">    1586 </span><span class="lineNoCov">          0 :                 }</span>
<span class="lineNum">    1587 </span><span class="lineNoCov">          0 :                 m2ts-&gt;nb_paused++;</span>
<span class="lineNum">    1588 </span><span class="lineNoCov">          0 :                 return GF_OK;</span>
<span class="lineNum">    1589 </span>            :         case GF_NET_CHAN_RESUME:
<span class="lineNum">    1590 </span><span class="lineNoCov">          0 :                 if (m2ts-&gt;nb_paused) {</span>
<span class="lineNum">    1591 </span><span class="lineNoCov">          0 :                         m2ts-&gt;nb_paused--;</span>
<span class="lineNum">    1592 </span><span class="lineNoCov">          0 :                         if (!m2ts-&gt;nb_paused) {</span>
<span class="lineNum">    1593 </span><span class="lineNoCov">          0 :                                 m2ts-&gt;pcr_last = 0;</span>
<span class="lineNum">    1594 </span><span class="lineNoCov">          0 :                                 gf_m2ts_pause_demux(m2ts-&gt;ts, 0);</span>
<span class="lineNum">    1595 </span>            : 
<span class="lineNum">    1596 </span><span class="lineNoCov">          0 :                         }</span>
<span class="lineNum">    1597 </span>            :                 }
<span class="lineNum">    1598 </span><span class="lineNoCov">          0 :                 return GF_OK;</span>
<span class="lineNum">    1599 </span>            : 
<span class="lineNum">    1600 </span>            :         default:
<span class="lineNum">    1601 </span><span class="lineNoCov">          0 :                 return GF_OK;</span>
<span class="lineNum">    1602 </span>            :         }
<a name="1603"><span class="lineNum">    1603 </span><span class="lineNoCov">          0 : }</span></a>
<span class="lineNum">    1604 </span>            : 
<span class="lineNum">    1605 </span>            : static u32 M2TS_RegisterMimeTypes(const GF_InputService * service) {
<span class="lineNum">    1606 </span>            :         int i;
<span class="lineNum">    1607 </span><span class="lineCov">          1 :         if (service == NULL)</span>
<span class="lineNum">    1608 </span><span class="lineNoCov">          0 :                 return 0;</span>
<span class="lineNum">    1609 </span><span class="lineCov">          8 :         for (i = 0 ; MIMES[i]; i++)</span>
<span class="lineNum">    1610 </span><span class="lineCov">          3 :                 gf_service_register_mime( service, MIMES[i], M2TS_EXTENSIONS, &quot;MPEG-2 TS&quot;);</span>
<span class="lineNum">    1611 </span><span class="lineCov">          1 :         return i;</span>
<a name="1612"><span class="lineNum">    1612 </span><span class="lineCov">          1 : }</span></a>
<span class="lineNum">    1613 </span>            : 
<span class="lineNum">    1614 </span>            : static void M2TS_GetNetworkType(GF_InputService *plug,M2TSIn *reader)
<span class="lineNum">    1615 </span>            : {
<span class="lineNum">    1616 </span>            :         const char *mob_on;
<span class="lineNum">    1617 </span>            :         const char *mcast_ifce;
<span class="lineNum">    1618 </span>            : 
<span class="lineNum">    1619 </span><span class="lineNoCov">          0 :         mob_on = gf_modules_get_option((GF_BaseInterface*)plug, &quot;Network&quot;, &quot;MobileIPEnabled&quot;);</span>
<span class="lineNum">    1620 </span><span class="lineNoCov">          0 :         if(mob_on &amp;&amp; !strcmp(mob_on, &quot;yes&quot;)) {</span>
<span class="lineNum">    1621 </span><span class="lineNoCov">          0 :                 reader-&gt;ts-&gt;MobileIPEnabled = 1;</span>
<span class="lineNum">    1622 </span><span class="lineNoCov">          0 :                 reader-&gt;ts-&gt;network_type = gf_modules_get_option((GF_BaseInterface*)plug, &quot;Network&quot;, &quot;MobileIP&quot;);</span>
<span class="lineNum">    1623 </span><span class="lineNoCov">          0 :         }</span>
<span class="lineNum">    1624 </span>            : 
<span class="lineNum">    1625 </span><span class="lineNoCov">          0 :         mcast_ifce = gf_modules_get_option((GF_BaseInterface*)plug, &quot;Network&quot;, &quot;DefaultMCastInterface&quot;);</span>
<span class="lineNum">    1626 </span><span class="lineNoCov">          0 :         if(mcast_ifce) reader-&gt;ts-&gt;network_type = mcast_ifce;</span>
<a name="1627"><span class="lineNum">    1627 </span><span class="lineNoCov">          0 : }</span></a>
<span class="lineNum">    1628 </span>            : 
<span class="lineNum">    1629 </span>            : GF_InputService *NewM2TSReader()
<span class="lineNum">    1630 </span>            : {
<span class="lineNum">    1631 </span>            :         M2TSIn *reader;
<span class="lineNum">    1632 </span><span class="lineCov">          1 :         GF_InputService *plug = gf_malloc(sizeof(GF_InputService));</span>
<span class="lineNum">    1633 </span><span class="lineCov">          1 :         memset(plug, 0, sizeof(GF_InputService));</span>
<span class="lineNum">    1634 </span><span class="lineCov">          1 :         GF_REGISTER_MODULE_INTERFACE(plug, GF_NET_CLIENT_INTERFACE, &quot;GPAC MPEG-2 TS Reader&quot;, &quot;gpac distribution&quot;)</span>
<span class="lineNum">    1635 </span>            : 
<span class="lineNum">    1636 </span><span class="lineCov">          1 :         plug-&gt;CanHandleURL = M2TS_CanHandleURL;</span>
<span class="lineNum">    1637 </span><span class="lineCov">          1 :         plug-&gt;CanHandleURLInService = M2TS_CanHandleURLInService;</span>
<span class="lineNum">    1638 </span><span class="lineCov">          1 :         plug-&gt;ConnectService = M2TS_ConnectService;</span>
<span class="lineNum">    1639 </span><span class="lineCov">          1 :         plug-&gt;CloseService = M2TS_CloseService;</span>
<span class="lineNum">    1640 </span><span class="lineCov">          1 :         plug-&gt;GetServiceDescriptor = M2TS_GetServiceDesc;</span>
<span class="lineNum">    1641 </span><span class="lineCov">          1 :         plug-&gt;ConnectChannel = M2TS_ConnectChannel;</span>
<span class="lineNum">    1642 </span><span class="lineCov">          1 :         plug-&gt;DisconnectChannel = M2TS_DisconnectChannel;</span>
<span class="lineNum">    1643 </span><span class="lineCov">          1 :         plug-&gt;ServiceCommand = M2TS_ServiceCommand;</span>
<span class="lineNum">    1644 </span><span class="lineCov">          1 :         plug-&gt;RegisterMimeTypes = M2TS_RegisterMimeTypes;</span>
<span class="lineNum">    1645 </span>            : 
<span class="lineNum">    1646 </span><span class="lineCov">          1 :         reader = gf_malloc(sizeof(M2TSIn));</span>
<span class="lineNum">    1647 </span><span class="lineCov">          1 :         memset(reader, 0, sizeof(M2TSIn));</span>
<span class="lineNum">    1648 </span><span class="lineCov">          1 :         plug-&gt;priv = reader;</span>
<span class="lineNum">    1649 </span><span class="lineCov">          1 :         reader-&gt;ts = gf_m2ts_demux_new();</span>
<span class="lineNum">    1650 </span><span class="lineCov">          1 :         reader-&gt;ts-&gt;on_event = M2TS_OnEvent;</span>
<span class="lineNum">    1651 </span><span class="lineCov">          1 :         reader-&gt;ts-&gt;user = reader;</span>
<span class="lineNum">    1652 </span><span class="lineCov">          1 :         reader-&gt;ts-&gt;demux_and_play = 1;</span>
<span class="lineNum">    1653 </span><span class="lineCov">          1 :         reader-&gt;ts-&gt;th = gf_th_new(&quot;MPEG-2 TS Demux&quot;);</span>
<span class="lineNum">    1654 </span>            : 
<span class="lineNum">    1655 </span><span class="lineCov">          1 :         reader-&gt;mx = gf_mx_new(&quot;MPEG2 Demux&quot;);</span>
<span class="lineNum">    1656 </span>            : 
<span class="lineNum">    1657 </span><span class="lineCov">          1 :         return plug;</span>
<a name="1658"><span class="lineNum">    1658 </span>            : }</a>
<span class="lineNum">    1659 </span>            : 
<span class="lineNum">    1660 </span>            : void DeleteM2TSReader(void *ifce)
<span class="lineNum">    1661 </span>            : {
<span class="lineNum">    1662 </span>            :         u32 i, count;
<span class="lineNum">    1663 </span>            :         M2TSIn *m2ts;
<span class="lineNum">    1664 </span><span class="lineCov">          1 :         GF_InputService *plug = (GF_InputService *) ifce;</span>
<span class="lineNum">    1665 </span><span class="lineCov">          1 :         if (!ifce)</span>
<span class="lineNum">    1666 </span>            :                 return;
<span class="lineNum">    1667 </span><span class="lineCov">          1 :         m2ts = plug-&gt;priv;</span>
<span class="lineNum">    1668 </span><span class="lineCov">          1 :         if (!m2ts)</span>
<span class="lineNum">    1669 </span>            :                 return;
<span class="lineNum">    1670 </span><span class="lineCov">          1 :         if( m2ts-&gt;ts-&gt;requested_progs ) {</span>
<span class="lineNum">    1671 </span><span class="lineCov">          1 :                 count = gf_list_count(m2ts-&gt;ts-&gt;requested_progs);</span>
<span class="lineNum">    1672 </span><span class="lineCov">          3 :                 for (i = 0; i &lt; count; i++) {</span>
<span class="lineNum">    1673 </span><span class="lineCov">          1 :                         M2TSIn_Prog *prog = gf_list_get(m2ts-&gt;ts-&gt;requested_progs, i);</span>
<span class="lineNum">    1674 </span><span class="lineNoCov">          0 :                         gf_free(prog-&gt;fragment);</span>
<span class="lineNum">    1675 </span><span class="lineNoCov">          0 :                         gf_free(prog);</span>
<span class="lineNum">    1676 </span>            :                 }
<span class="lineNum">    1677 </span><span class="lineCov">          1 :                 gf_list_del(m2ts-&gt;ts-&gt;requested_progs);</span>
<span class="lineNum">    1678 </span><span class="lineCov">          1 :                 m2ts-&gt;ts-&gt;requested_progs = NULL;</span>
<span class="lineNum">    1679 </span><span class="lineCov">          1 :         }</span>
<span class="lineNum">    1680 </span><span class="lineCov">          1 :         if( m2ts-&gt;ts-&gt;requested_pids ) {</span>
<span class="lineNum">    1681 </span><span class="lineCov">          1 :                 count = gf_list_count(m2ts-&gt;ts-&gt;requested_pids);</span>
<span class="lineNum">    1682 </span><span class="lineCov">          3 :                 for (i = 0; i &lt; count; i++) {</span>
<span class="lineNum">    1683 </span><span class="lineCov">          1 :                         M2TSIn_Prog *prog = gf_list_get(m2ts-&gt;ts-&gt;requested_pids, i);</span>
<span class="lineNum">    1684 </span><span class="lineNoCov">          0 :                         gf_free(prog);</span>
<span class="lineNum">    1685 </span>            :                 }
<span class="lineNum">    1686 </span><span class="lineCov">          1 :                 gf_list_del(m2ts-&gt;ts-&gt;requested_pids);</span>
<span class="lineNum">    1687 </span><span class="lineCov">          1 :                 m2ts-&gt;ts-&gt;requested_pids = NULL;</span>
<span class="lineNum">    1688 </span><span class="lineCov">          1 :         }</span>
<span class="lineNum">    1689 </span><span class="lineCov">          1 :         if (m2ts-&gt;network_buffer)</span>
<span class="lineNum">    1690 </span><span class="lineNoCov">          0 :                 gf_free(m2ts-&gt;network_buffer);</span>
<span class="lineNum">    1691 </span>            : 
<span class="lineNum">    1692 </span><span class="lineCov">          1 :         m2ts-&gt;network_buffer = NULL;</span>
<span class="lineNum">    1693 </span><span class="lineCov">          1 :         gf_m2ts_demux_del(m2ts-&gt;ts);</span>
<span class="lineNum">    1694 </span><span class="lineCov">          1 :         gf_mx_del(m2ts-&gt;mx);</span>
<span class="lineNum">    1695 </span><span class="lineCov">          1 :         gf_free(m2ts);</span>
<span class="lineNum">    1696 </span>            : 
<span class="lineNum">    1697 </span><span class="lineCov">          1 :         gf_free(plug);</span>
<span class="lineNum">    1698 </span><span class="lineCov">          2 : }</span>
<span class="lineNum">    1699 </span>            : 
<span class="lineNum">    1700 </span>            : #endif
<span class="lineNum">    1701 </span>            : 
<a name="1702"><span class="lineNum">    1702 </span>            : </a>
<span class="lineNum">    1703 </span>            : GPAC_MODULE_EXPORT
<span class="lineNum">    1704 </span>            : const u32 *QueryInterfaces()
<span class="lineNum">    1705 </span>            : {
<span class="lineNum">    1706 </span>            :         static u32 si [] = {
<span class="lineNum">    1707 </span>            : #ifndef GPAC_DISABLE_MPEG2TS
<span class="lineNum">    1708 </span>            :                 GF_NET_CLIENT_INTERFACE,
<span class="lineNum">    1709 </span>            : #endif
<span class="lineNum">    1710 </span>            :                 0
<span class="lineNum">    1711 </span>            :         };
<span class="lineNum">    1712 </span><span class="lineCov">          2 :         return si;</span>
<span class="lineNum">    1713 </span>            : }
<a name="1714"><span class="lineNum">    1714 </span>            : </a>
<span class="lineNum">    1715 </span>            : GPAC_MODULE_EXPORT
<span class="lineNum">    1716 </span>            : GF_BaseInterface *LoadInterface(u32 InterfaceType)
<span class="lineNum">    1717 </span>            : {
<span class="lineNum">    1718 </span><span class="lineCov">          1 :         switch (InterfaceType) {</span>
<span class="lineNum">    1719 </span>            : #ifndef GPAC_DISABLE_MPEG2TS
<span class="lineNum">    1720 </span>            :         case GF_NET_CLIENT_INTERFACE:
<span class="lineNum">    1721 </span><span class="lineCov">          1 :                 return (GF_BaseInterface *) NewM2TSReader();</span>
<span class="lineNum">    1722 </span>            : #endif
<span class="lineNum">    1723 </span>            :         default:
<span class="lineNum">    1724 </span><span class="lineNoCov">          0 :                 return NULL;</span>
<span class="lineNum">    1725 </span>            :         }
<span class="lineNum">    1726 </span><span class="lineCov">          1 : }</span>
<a name="1727"><span class="lineNum">    1727 </span>            : </a>
<span class="lineNum">    1728 </span>            : GPAC_MODULE_EXPORT
<span class="lineNum">    1729 </span>            : void ShutdownInterface(GF_BaseInterface *ifce)
<span class="lineNum">    1730 </span>            : {
<span class="lineNum">    1731 </span><span class="lineCov">          1 :         switch (ifce-&gt;InterfaceType) {</span>
<span class="lineNum">    1732 </span>            : #ifndef GPAC_DISABLE_MPEG2TS
<span class="lineNum">    1733 </span>            :         case GF_NET_CLIENT_INTERFACE:
<span class="lineNum">    1734 </span><span class="lineCov">          1 :                 DeleteM2TSReader(ifce);</span>
<span class="lineNum">    1735 </span><span class="lineCov">          1 :                 break;</span>
<span class="lineNum">    1736 </span>            : #endif
<span class="lineNum">    1737 </span>            :         }
<span class="lineNum">    1738 </span><span class="lineCov">          1 : }</span>
<span class="lineNum">    1739 </span>            : 
<span class="lineNum">    1740 </span>            : GPAC_MODULE_STATIC_DECLARATION( mpegts_in )
</pre>
      </td>
    </tr>
  </table>
  <br>

  <table width="100%" border=0 cellspacing=0 cellpadding=0>
    <tr><td class="ruler"><img src="../../glass.png" width=3 height=3 alt=""></td></tr>
    <tr><td class="versionInfo">Generated by: <a href="http://ltp.sourceforge.net/coverage/lcov.php" target="_parent">LCOV version 1.12</a></td></tr>
  </table>
  <br>

</body>
</html>
