<!DOCTYPE HTML PUBLIC "-//W3C//DTD HTML 4.01 Transitional//EN">

<html lang="en">

<head>
  <meta http-equiv="Content-Type" content="text/html; charset=UTF-8">
  <title>LCOV - coverage.info - modules/widgetman/widgetman.c</title>
  <link rel="stylesheet" type="text/css" href="../../gcov.css">
</head>

<body>

  <table width="100%" border=0 cellspacing=0 cellpadding=0>
    <tr><td class="title">LCOV - code coverage report</td></tr>
    <tr><td class="ruler"><img src="../../glass.png" width=3 height=3 alt=""></td></tr>

    <tr>
      <td width="100%">
        <table cellpadding=1 border=0 width="100%">
          <tr>
            <td width="10%" class="headerItem">Current view:</td>
            <td width="35%" class="headerValue"><a href="../../index.html">top level</a> - <a href="index.html">modules/widgetman</a> - widgetman.c<span style="font-size: 80%;"> (source / <a href="widgetman.c.func-sort-c.html">functions</a>)</span></td>
            <td width="5%"></td>
            <td width="15%"></td>
            <td width="10%" class="headerCovTableHead">Hit</td>
            <td width="10%" class="headerCovTableHead">Total</td>
            <td width="15%" class="headerCovTableHead">Coverage</td>
          </tr>
          <tr>
            <td class="headerItem">Test:</td>
            <td class="headerValue">coverage.info</td>
            <td></td>
            <td class="headerItem">Lines:</td>
            <td class="headerCovTableEntry">1</td>
            <td class="headerCovTableEntry">3</td>
            <td class="headerCovTableEntryLo">33.3 %</td>
          </tr>
          <tr>
            <td class="headerItem">Date:</td>
            <td class="headerValue">2016-06-07 10:36:32</td>
            <td></td>
            <td class="headerItem">Functions:</td>
            <td class="headerCovTableEntry">1</td>
            <td class="headerCovTableEntry">3</td>
            <td class="headerCovTableEntryLo">33.3 %</td>
          </tr>
          <tr><td><img src="../../glass.png" width=3 height=3 alt=""></td></tr>
        </table>
      </td>
    </tr>

    <tr><td class="ruler"><img src="../../glass.png" width=3 height=3 alt=""></td></tr>
  </table>

  <table cellpadding=0 cellspacing=0 border=0>
    <tr>
      <td><br></td>
    </tr>
    <tr>
      <td>
<pre class="sourceHeading">          Line data    Source code</pre>
<pre class="source">
<a name="1"><span class="lineNum">       1 </span>            : //This software module was originally developed by TelecomParisTech in the</a>
<span class="lineNum">       2 </span>            : //course of the development of MPEG-U Widgets (ISO/IEC 23007-1) standard.
<span class="lineNum">       3 </span>            : //
<span class="lineNum">       4 </span>            : //This software module is an implementation of a part of one or
<span class="lineNum">       5 </span>            : //more MPEG-U Widgets (ISO/IEC 23007-1) tools as specified by the MPEG-U Widgets
<span class="lineNum">       6 </span>            : //(ISO/IEC 23007-1) standard. ISO/IEC gives users of the MPEG-U Widgets
<span class="lineNum">       7 </span>            : //(ISO/IEC 23007-1) free license to this software module or modifications
<span class="lineNum">       8 </span>            : //thereof for use in hardware or software products claiming conformance to
<span class="lineNum">       9 </span>            : //the MPEG-U Widgets (ISO/IEC 23007-1). Those intending to use this software
<span class="lineNum">      10 </span>            : //module in hardware or software products are advised that its use may
<span class="lineNum">      11 </span>            : //infringe existing patents.
<span class="lineNum">      12 </span>            : //The original developer of this software module and his/her company, the
<span class="lineNum">      13 </span>            : //subsequent editors and their companies, and ISO/IEC have no liability
<span class="lineNum">      14 </span>            : //for use of this software module or modifications thereof in an implementation.
<span class="lineNum">      15 </span>            : //Copyright is not released for non MPEG-U Widgets (ISO/IEC 23007-1) conforming
<span class="lineNum">      16 </span>            : //products.
<span class="lineNum">      17 </span>            : //Telecom ParisTech retains full right to use the code for his/her own purpose,
<span class="lineNum">      18 </span>            : //assign or donate the code to a third party and to inhibit third parties from
<span class="lineNum">      19 </span>            : //using the code for non MPEG-U Widgets (ISO/IEC 23007-1) conforming products.
<span class="lineNum">      20 </span>            : //
<span class="lineNum">      21 </span>            : //This copyright notice must be included in all copies or derivative works.
<span class="lineNum">      22 </span>            : //
<span class="lineNum">      23 </span>            : //Copyright (c) 2009 Telecom ParisTech.
<span class="lineNum">      24 </span>            : //
<span class="lineNum">      25 </span>            : // Alternatively, this software module may be redistributed and/or modified
<span class="lineNum">      26 </span>            : //  it under the terms of the GNU Lesser General Public License as published by
<span class="lineNum">      27 </span>            : //  the Free Software Foundation; either version 2, or (at your option)
<span class="lineNum">      28 </span>            : //  any later version.
<span class="lineNum">      29 </span>            : //
<span class="lineNum">      30 </span>            : /////////////////////////////////////////////////////////////////////////////////
<span class="lineNum">      31 </span>            : 
<span class="lineNum">      32 </span>            : 
<span class="lineNum">      33 </span>            : /////////////////////////////////////////////////////////////////////////////////
<span class="lineNum">      34 </span>            : //
<span class="lineNum">      35 </span>            : //      Authors:
<span class="lineNum">      36 </span>            : //                                      Jean Le Feuvre, Telecom ParisTech
<span class="lineNum">      37 </span>            : //                                      Cyril Concolato, Telecom ParisTech
<span class="lineNum">      38 </span>            : //
<span class="lineNum">      39 </span>            : /////////////////////////////////////////////////////////////////////////////////
<span class="lineNum">      40 </span>            : 
<span class="lineNum">      41 </span>            : #include &quot;widgetman.h&quot;
<span class="lineNum">      42 </span>            : 
<span class="lineNum">      43 </span>            : #ifdef GPAC_HAS_SPIDERMONKEY
<span class="lineNum">      44 </span>            : 
<span class="lineNum">      45 </span>            : #if !defined(__GNUC__)
<span class="lineNum">      46 </span>            : # if defined(_WIN32_WCE)
<span class="lineNum">      47 </span>            : #  pragma comment(lib, &quot;js32&quot;)
<span class="lineNum">      48 </span>            : # elif defined (_WIN64)
<span class="lineNum">      49 </span>            : #  pragma comment(lib, &quot;js&quot;)
<span class="lineNum">      50 </span>            : # elif defined (WIN32)
<span class="lineNum">      51 </span>            : #  pragma comment(lib, &quot;js&quot;)
<span class="lineNum">      52 </span>            : # endif
<span class="lineNum">      53 </span>            : #endif
<span class="lineNum">      54 </span>            : 
<span class="lineNum">      55 </span>            : 
<span class="lineNum">      56 </span>            : JSBool gf_sg_js_event_add_listener(JSContext *c, JSObject *obj, uintN argc, jsval *argv, jsval *rval, GF_Node *vrml_node);
<span class="lineNum">      57 </span>            : JSBool gf_sg_js_event_remove_listener(JSContext *c, JSObject *obj, uintN argc, jsval *argv, jsval *rval, GF_Node *vrml_node);
<span class="lineNum">      58 </span>            : 
<span class="lineNum">      59 </span>            : 
<span class="lineNum">      60 </span>            : 
<span class="lineNum">      61 </span>            : static Bool is_same_path(const char *p1, const char *p2, u32 len)
<span class="lineNum">      62 </span>            : {
<span class="lineNum">      63 </span>            :         char c1, c2;
<span class="lineNum">      64 </span>            :         u32 i=0;
<span class="lineNum">      65 </span>            :         do {
<span class="lineNum">      66 </span>            :                 if (len &amp;&amp; (i==len))
<span class="lineNum">      67 </span>            :                         break;
<span class="lineNum">      68 </span>            :                 c1 = p1[i];
<span class="lineNum">      69 </span>            :                 c2 = p2[i];
<span class="lineNum">      70 </span>            :                 if (p1[i] != p2[i]) {
<span class="lineNum">      71 </span>            :                         if ((c1=='/') &amp;&amp; (c2=='\\')) {}
<span class="lineNum">      72 </span>            :                         else if ((c1=='\\') &amp;&amp; (c2=='/')) {}
<span class="lineNum">      73 </span>            :                         else return GF_FALSE;
<span class="lineNum">      74 </span>            :                 }
<span class="lineNum">      75 </span>            :                 i++;
<span class="lineNum">      76 </span>            :         } while (c1);
<span class="lineNum">      77 </span>            : 
<span class="lineNum">      78 </span>            :         return GF_TRUE;
<span class="lineNum">      79 </span>            : }
<span class="lineNum">      80 </span>            : 
<span class="lineNum">      81 </span>            : static void widget_package_extract_file(GF_WidgetPackage *wpack, GF_WidgetPackageResource *res)
<span class="lineNum">      82 </span>            : {
<span class="lineNum">      83 </span>            :         u32 i;
<span class="lineNum">      84 </span>            : 
<span class="lineNum">      85 </span>            :         if (wpack-&gt;is_zip) {
<span class="lineNum">      86 </span>            :                 unz_global_info gi;
<span class="lineNum">      87 </span>            :                 unzFile uf = unzOpen2(wpack-&gt;package_path, NULL);
<span class="lineNum">      88 </span>            :                 if (!uf) return;
<span class="lineNum">      89 </span>            : 
<span class="lineNum">      90 </span>            :                 unzGetGlobalInfo(uf, &amp;gi);
<span class="lineNum">      91 </span>            :                 for (i=0; i&lt;gi.number_entry; i++)  {
<span class="lineNum">      92 </span>            :                         char buf[8192];
<span class="lineNum">      93 </span>            :                         int err;
<span class="lineNum">      94 </span>            :                         FILE *fout;
<span class="lineNum">      95 </span>            :                         char filename_inzip[256];
<span class="lineNum">      96 </span>            : 
<span class="lineNum">      97 </span>            :                         unz_file_info file_info;
<span class="lineNum">      98 </span>            :                         unzGetCurrentFileInfo(uf, &amp;file_info, filename_inzip,sizeof(filename_inzip),NULL,0,NULL,0);
<span class="lineNum">      99 </span>            : 
<span class="lineNum">     100 </span>            :                         if (strcmp(res-&gt;inner_path, filename_inzip)) {
<span class="lineNum">     101 </span>            :                                 if ((i+1)&lt;gi.number_entry)
<span class="lineNum">     102 </span>            :                                         unzGoToNextFile(uf);
<span class="lineNum">     103 </span>            :                                 continue;
<span class="lineNum">     104 </span>            :                         }
<span class="lineNum">     105 </span>            : 
<span class="lineNum">     106 </span>            :                         unzOpenCurrentFile3(uf, NULL, NULL, 0, NULL/*password*/);
<span class="lineNum">     107 </span>            : 
<span class="lineNum">     108 </span>            :                         fout=gf_fopen(res-&gt;extracted_path, &quot;wb&quot;);
<span class="lineNum">     109 </span>            :                         if (!fout) break;
<span class="lineNum">     110 </span>            :                         do {
<span class="lineNum">     111 </span>            :                                 err = unzReadCurrentFile(uf,buf,8192);
<span class="lineNum">     112 </span>            :                                 if (err&lt;0) break;
<span class="lineNum">     113 </span>            :                                 if (err&gt;0)
<span class="lineNum">     114 </span>            :                                         if (gf_fwrite(buf,err,1,fout)!=1) {
<span class="lineNum">     115 </span>            :                                                 //err=UNZ_ERRNO;
<span class="lineNum">     116 </span>            :                                                 break;
<span class="lineNum">     117 </span>            :                                         }
<span class="lineNum">     118 </span>            :                         } while (err&gt;0);
<span class="lineNum">     119 </span>            :                         if (fout) gf_fclose(fout);
<span class="lineNum">     120 </span>            : 
<span class="lineNum">     121 </span>            :                         res-&gt;extracted = GF_TRUE;
<span class="lineNum">     122 </span>            :                         break;
<span class="lineNum">     123 </span>            :                 }
<span class="lineNum">     124 </span>            :                 unzClose(uf);
<span class="lineNum">     125 </span>            : #ifndef GPAC_DISABLE_ISOM
<span class="lineNum">     126 </span>            :         } else {
<span class="lineNum">     127 </span>            :                 u32 count;
<span class="lineNum">     128 </span>            :                 GF_ISOFile *isom = gf_isom_open(wpack-&gt;package_path, GF_ISOM_OPEN_READ, 0);
<span class="lineNum">     129 </span>            :                 if (!isom ) return;
<span class="lineNum">     130 </span>            : 
<span class="lineNum">     131 </span>            :                 count = gf_isom_get_meta_item_count(isom, GF_TRUE, 0);
<span class="lineNum">     132 </span>            :                 for (i=0; i&lt;count; i++)  {
<span class="lineNum">     133 </span>            :                         u32 ID;
<span class="lineNum">     134 </span>            :                         const char *url, *urn, *enc;
<span class="lineNum">     135 </span>            :                         Bool self_ref;
<span class="lineNum">     136 </span>            :                         const char *item_name;
<span class="lineNum">     137 </span>            : 
<span class="lineNum">     138 </span>            :                         gf_isom_get_meta_item_info(isom, GF_TRUE, 0, i+1, &amp;ID, NULL, &amp;self_ref, &amp;item_name, NULL, &amp;enc, &amp;url, &amp;urn);
<span class="lineNum">     139 </span>            :                         if (strcmp(res-&gt;inner_path, item_name)) continue;
<span class="lineNum">     140 </span>            : 
<span class="lineNum">     141 </span>            :                         gf_isom_extract_meta_item(isom, GF_TRUE, 0, ID, res-&gt;extracted_path);
<span class="lineNum">     142 </span>            :                         res-&gt;extracted = GF_TRUE;
<span class="lineNum">     143 </span>            :                         break;
<span class="lineNum">     144 </span>            :                 }
<span class="lineNum">     145 </span>            :                 gf_isom_close(isom);
<span class="lineNum">     146 </span>            : #endif /*GPAC_DISABLE_ISOM*/
<span class="lineNum">     147 </span>            :         }
<span class="lineNum">     148 </span>            : 
<span class="lineNum">     149 </span>            : }
<span class="lineNum">     150 </span>            : 
<span class="lineNum">     151 </span>            : static Bool package_find_res(GF_WidgetPackage *wpack, char *res_path, char *relocated_path, char *localized_rel_path)
<span class="lineNum">     152 </span>            : {
<span class="lineNum">     153 </span>            :         u32 count, i;
<span class="lineNum">     154 </span>            :         count = gf_list_count(wpack-&gt;resources);
<span class="lineNum">     155 </span>            :         for (i=0; i&lt;count; i++) {
<span class="lineNum">     156 </span>            :                 GF_WidgetPackageResource *pack_res = (GF_WidgetPackageResource*)gf_list_get(wpack-&gt;resources, i);
<span class="lineNum">     157 </span>            :                 if (is_same_path(res_path, pack_res-&gt;inner_path, 0)) {
<span class="lineNum">     158 </span>            :                         strcpy(localized_rel_path, res_path);
<span class="lineNum">     159 </span>            :                         strcpy(relocated_path, pack_res-&gt;extracted_path);
<span class="lineNum">     160 </span>            :                         if (!pack_res-&gt;extracted) widget_package_extract_file(wpack, pack_res);
<span class="lineNum">     161 </span>            :                         return GF_TRUE;
<span class="lineNum">     162 </span>            :                 }
<span class="lineNum">     163 </span>            :         }
<span class="lineNum">     164 </span>            :         return GF_FALSE;
<span class="lineNum">     165 </span>            : }
<span class="lineNum">     166 </span>            : 
<span class="lineNum">     167 </span>            : /* Checks if a resource in the package has the given rel_path, potentially in a localized sub-folder */
<span class="lineNum">     168 </span>            : static Bool widget_package_relocate_uri(void *__self, const char *parent_uri, const char *rel_path, char *relocated_path, char *localized_rel_path)
<span class="lineNum">     169 </span>            : {
<span class="lineNum">     170 </span>            :         char path[GF_MAX_PATH];
<span class="lineNum">     171 </span>            :         const char *opt;
<span class="lineNum">     172 </span>            :         GF_WidgetPackage *wpack = (GF_WidgetPackage *)__self;
<span class="lineNum">     173 </span>            : 
<span class="lineNum">     174 </span>            :         assert(parent_uri);
<span class="lineNum">     175 </span>            :         /*resource belongs to our archive*/
<span class="lineNum">     176 </span>            :         if (strstr(rel_path, wpack-&gt;archive_id)) {
<span class="lineNum">     177 </span>            :                 rel_path = strstr(rel_path, wpack-&gt;archive_id) + strlen(wpack-&gt;archive_id);
<span class="lineNum">     178 </span>            :         }
<span class="lineNum">     179 </span>            :         /*parent resource belongs to our archive*/
<span class="lineNum">     180 </span>            :         else if (strstr(parent_uri, wpack-&gt;archive_id)) {
<span class="lineNum">     181 </span>            :         }
<span class="lineNum">     182 </span>            :         /*resource doesn't belong to our archive*/
<span class="lineNum">     183 </span>            :         else {
<span class="lineNum">     184 </span>            :                 return GF_FALSE;
<span class="lineNum">     185 </span>            :         }
<span class="lineNum">     186 </span>            : 
<span class="lineNum">     187 </span>            :         /* First try to locate the resource in the locales folder */
<span class="lineNum">     188 </span>            :         opt = gf_cfg_get_key(wpack-&gt;wm-&gt;term-&gt;user-&gt;config, &quot;Systems&quot;, &quot;Language2CC&quot;);
<span class="lineNum">     189 </span>            :         if (opt) {
<span class="lineNum">     190 </span>            :                 if (!strcmp(opt, &quot;*&quot;) || !strcmp(opt, &quot;un&quot;) )
<span class="lineNum">     191 </span>            :                         opt = NULL;
<span class="lineNum">     192 </span>            :         }
<span class="lineNum">     193 </span>            : 
<span class="lineNum">     194 </span>            :         while (opt) {
<span class="lineNum">     195 </span>            :                 char lan[100];
<span class="lineNum">     196 </span>            :                 char *sep;
<span class="lineNum">     197 </span>            :                 char *sep_lang = strchr(opt, ';');
<span class="lineNum">     198 </span>            :                 if (sep_lang) sep_lang[0] = 0;
<span class="lineNum">     199 </span>            : 
<span class="lineNum">     200 </span>            :                 while (strchr(&quot; \t&quot;, opt[0]))
<span class="lineNum">     201 </span>            :                         opt++;
<span class="lineNum">     202 </span>            :                 strcpy(lan, opt);
<span class="lineNum">     203 </span>            : 
<span class="lineNum">     204 </span>            :                 if (sep_lang) {
<span class="lineNum">     205 </span>            :                         sep_lang[0] = ';';
<span class="lineNum">     206 </span>            :                         opt = sep_lang+1;
<span class="lineNum">     207 </span>            :                 } else {
<span class="lineNum">     208 </span>            :                         opt = NULL;
<span class="lineNum">     209 </span>            :                 }
<span class="lineNum">     210 </span>            : 
<span class="lineNum">     211 </span>            :                 while (1) {
<span class="lineNum">     212 </span>            :                         sep = strstr(lan, &quot;-*&quot;);
<span class="lineNum">     213 </span>            :                         if (!sep) break;
<span class="lineNum">     214 </span>            :                         strncpy(sep, sep+2, strlen(sep)-2);
<span class="lineNum">     215 </span>            :                 }
<span class="lineNum">     216 </span>            : 
<span class="lineNum">     217 </span>            :                 sprintf(path, &quot;locales/%s/%s&quot;, lan, rel_path);
<span class="lineNum">     218 </span>            :                 if (package_find_res(wpack, path, relocated_path, localized_rel_path))
<span class="lineNum">     219 </span>            :                         return GF_TRUE;
<span class="lineNum">     220 </span>            : 
<span class="lineNum">     221 </span>            :                 /*recursively remove region (sub)tags*/
<span class="lineNum">     222 </span>            :                 while (1) {
<span class="lineNum">     223 </span>            :                         sep = strrchr(lan, '-');
<span class="lineNum">     224 </span>            :                         if (!sep) break;
<span class="lineNum">     225 </span>            :                         sep[0] = 0;
<span class="lineNum">     226 </span>            :                         sprintf(path, &quot;locales/%s/%s&quot;, lan, rel_path);
<span class="lineNum">     227 </span>            :                         if (package_find_res(wpack, path, relocated_path, localized_rel_path))
<span class="lineNum">     228 </span>            :                                 return GF_TRUE;
<span class="lineNum">     229 </span>            :                 }
<span class="lineNum">     230 </span>            :         }
<span class="lineNum">     231 </span>            : 
<span class="lineNum">     232 </span>            :         /*no locale*/
<span class="lineNum">     233 </span>            :         if (package_find_res(wpack, (char*)rel_path, relocated_path, localized_rel_path))
<span class="lineNum">     234 </span>            :                 return GF_TRUE;
<span class="lineNum">     235 </span>            : 
<span class="lineNum">     236 </span>            :         strcpy(localized_rel_path, &quot;&quot;);
<span class="lineNum">     237 </span>            :         strcpy(relocated_path, &quot;&quot;);
<span class="lineNum">     238 </span>            :         return GF_FALSE;
<span class="lineNum">     239 </span>            : }
<span class="lineNum">     240 </span>            : 
<span class="lineNum">     241 </span>            : 
<span class="lineNum">     242 </span>            : static GF_WidgetPackage *widget_isom_new(GF_WidgetManager *wm, const char *path)
<span class="lineNum">     243 </span>            : {
<span class="lineNum">     244 </span>            : #ifdef GPAC_DISABLE_ISOM
<span class="lineNum">     245 </span>            :         GF_LOG(GF_LOG_ERROR, GF_LOG_MODULE, (&quot;[Widgetman] GPAC was compiled without ISO File Format support\n&quot;));
<span class="lineNum">     246 </span>            :         return NULL;
<span class="lineNum">     247 </span>            : #else
<span class="lineNum">     248 </span>            :         GF_WidgetPackageResource *pack_res;
<span class="lineNum">     249 </span>            :         char szPath[GF_MAX_PATH];
<span class="lineNum">     250 </span>            :         const char *dir;
<span class="lineNum">     251 </span>            :         GF_WidgetPackage *wzip;
<span class="lineNum">     252 </span>            :         u32 brand = 0;
<span class="lineNum">     253 </span>            :         u32 i, count;
<span class="lineNum">     254 </span>            :         GF_ISOFile *isom = gf_isom_open(path, GF_ISOM_OPEN_READ, 0);
<span class="lineNum">     255 </span>            :         if (!isom ) return NULL;
<span class="lineNum">     256 </span>            : 
<span class="lineNum">     257 </span>            :         brand = gf_isom_get_meta_type(isom, GF_TRUE, 0);
<span class="lineNum">     258 </span>            :         if ((brand!=GF_4CC('m','w','g','t') )           || !gf_isom_has_meta_xml(isom, GF_TRUE, 0) ) {
<span class="lineNum">     259 </span>            :                 gf_isom_close(isom);
<span class="lineNum">     260 </span>            :                 return NULL;
<span class="lineNum">     261 </span>            :         }
<span class="lineNum">     262 </span>            : 
<span class="lineNum">     263 </span>            :         GF_SAFEALLOC(wzip, GF_WidgetPackage);
<span class="lineNum">     264 </span>            :         if (!wzip) return NULL;
<span class="lineNum">     265 </span>            : 
<span class="lineNum">     266 </span>            :         wzip-&gt;wm = wm;
<span class="lineNum">     267 </span>            :         wzip-&gt;relocate_uri = widget_package_relocate_uri;
<span class="lineNum">     268 </span>            :         wzip-&gt;resources = gf_list_new();
<span class="lineNum">     269 </span>            :         dir = gf_cfg_get_key(wm-&gt;term-&gt;user-&gt;config, &quot;General&quot;, &quot;CacheDirectory&quot;);
<span class="lineNum">     270 </span>            :         /* create the extracted path for the package root using:
<span class="lineNum">     271 </span>            :            the cache dir + a CRC of the file path and the instance*/
<span class="lineNum">     272 </span>            :         sprintf(wzip-&gt;root_extracted_path, &quot;%s%p&quot;, path, wzip);
<span class="lineNum">     273 </span>            :         i = gf_crc_32((char *)wzip-&gt;root_extracted_path, (u32) strlen(wzip-&gt;root_extracted_path));
<span class="lineNum">     274 </span>            :         sprintf(wzip-&gt;archive_id, &quot;GWM_%08X_&quot;, i);
<span class="lineNum">     275 </span>            :         sprintf(wzip-&gt;root_extracted_path, &quot;%s/%s&quot;, dir, wzip-&gt;archive_id);
<span class="lineNum">     276 </span>            : 
<span class="lineNum">     277 </span>            : 
<span class="lineNum">     278 </span>            :         strcpy(szPath, wzip-&gt;root_extracted_path);
<span class="lineNum">     279 </span>            :         strcat(szPath, &quot;config.xml&quot;);
<span class="lineNum">     280 </span>            :         if (gf_isom_extract_meta_xml(isom, GF_TRUE, 0, szPath, NULL) != GF_OK) {
<span class="lineNum">     281 </span>            :                 gf_list_del(wzip-&gt;resources);
<span class="lineNum">     282 </span>            :                 gf_free(wzip);
<span class="lineNum">     283 </span>            :                 gf_isom_close(isom);
<span class="lineNum">     284 </span>            :                 return NULL;
<span class="lineNum">     285 </span>            :         }
<span class="lineNum">     286 </span>            : 
<span class="lineNum">     287 </span>            :         wzip-&gt;package_path = gf_strdup(path);
<span class="lineNum">     288 </span>            : 
<span class="lineNum">     289 </span>            :         GF_SAFEALLOC(pack_res, GF_WidgetPackageResource);
<span class="lineNum">     290 </span>            :         if (!pack_res) {
<span class="lineNum">     291 </span>            :                 gf_list_del(wzip-&gt;resources);
<span class="lineNum">     292 </span>            :                 gf_free(wzip);
<span class="lineNum">     293 </span>            :                 gf_isom_close(isom);
<span class="lineNum">     294 </span>            :                 return NULL;
<span class="lineNum">     295 </span>            :         }
<span class="lineNum">     296 </span>            :         pack_res-&gt;extracted_path = gf_strdup(szPath);
<span class="lineNum">     297 </span>            :         pack_res-&gt;inner_path = gf_strdup(&quot;config.xml&quot;);
<span class="lineNum">     298 </span>            :         pack_res-&gt;extracted = GF_TRUE;
<span class="lineNum">     299 </span>            :         gf_list_add(wzip-&gt;resources, pack_res);
<span class="lineNum">     300 </span>            : 
<span class="lineNum">     301 </span>            : 
<span class="lineNum">     302 </span>            :         count = gf_isom_get_meta_item_count(isom, GF_TRUE, 0);
<span class="lineNum">     303 </span>            :         for (i=0; i&lt;count; i++)  {
<span class="lineNum">     304 </span>            :                 u32 ID;
<span class="lineNum">     305 </span>            :                 const char *url, *urn, *enc;
<span class="lineNum">     306 </span>            :                 Bool self_ref;
<span class="lineNum">     307 </span>            :                 char *sep;
<span class="lineNum">     308 </span>            :                 const char *item_name;
<span class="lineNum">     309 </span>            : 
<span class="lineNum">     310 </span>            :                 gf_isom_get_meta_item_info(isom, GF_TRUE, 0, i+1, &amp;ID, NULL, &amp;self_ref, &amp;item_name, NULL, &amp;enc, &amp;url, &amp;urn);
<span class="lineNum">     311 </span>            : 
<span class="lineNum">     312 </span>            :                 sep = strrchr(item_name, '/');
<span class="lineNum">     313 </span>            :                 if (!sep) sep = strrchr(item_name, '\\');
<span class="lineNum">     314 </span>            :                 if (sep) {
<span class="lineNum">     315 </span>            :                         sep[0] = 0;
<span class="lineNum">     316 </span>            :                         sprintf(szPath, &quot;%s_%08X_%s&quot;, wzip-&gt;root_extracted_path, gf_crc_32((char*)item_name, (u32) strlen(item_name)), sep+1);
<span class="lineNum">     317 </span>            :                         sep[0] = '/';
<span class="lineNum">     318 </span>            :                 } else {
<span class="lineNum">     319 </span>            :                         strcpy(szPath, wzip-&gt;root_extracted_path);
<span class="lineNum">     320 </span>            :                         strcat(szPath, item_name);
<span class="lineNum">     321 </span>            :                 }
<span class="lineNum">     322 </span>            :                 GF_SAFEALLOC(pack_res, GF_WidgetPackageResource);
<span class="lineNum">     323 </span>            :                 if (!pack_res) {
<span class="lineNum">     324 </span>            :                         GF_LOG(GF_LOG_ERROR, GF_LOG_CONTAINER, (&quot;[WidgetMan] Failed to allocate widget resource\n&quot;));
<span class="lineNum">     325 </span>            :                         continue;
<span class="lineNum">     326 </span>            :                 }
<span class="lineNum">     327 </span>            :                 pack_res-&gt;extracted_path = gf_strdup(szPath);
<span class="lineNum">     328 </span>            :                 pack_res-&gt;inner_path = gf_strdup(item_name);
<span class="lineNum">     329 </span>            :                 pack_res-&gt;extracted = GF_FALSE;
<span class="lineNum">     330 </span>            :                 gf_list_add(wzip-&gt;resources, pack_res);
<span class="lineNum">     331 </span>            :         }
<span class="lineNum">     332 </span>            :         gf_isom_close(isom);
<span class="lineNum">     333 </span>            : 
<span class="lineNum">     334 </span>            : 
<span class="lineNum">     335 </span>            :         /* register this widget package as a relocator to enable localization of resources inside this package */
<span class="lineNum">     336 </span>            :         gf_mx_p(wm-&gt;term-&gt;net_mx);
<span class="lineNum">     337 </span>            :         gf_list_add(wm-&gt;term-&gt;uri_relocators, wzip);
<span class="lineNum">     338 </span>            :         gf_mx_v(wm-&gt;term-&gt;net_mx);
<span class="lineNum">     339 </span>            :         return wzip;
<span class="lineNum">     340 </span>            : #endif /*GPAC_DISABLE_ISOM*/
<span class="lineNum">     341 </span>            : }
<span class="lineNum">     342 </span>            : 
<span class="lineNum">     343 </span>            : static GF_WidgetPackage *widget_zip_new(GF_WidgetManager *wm, const char *path)
<span class="lineNum">     344 </span>            : {
<span class="lineNum">     345 </span>            :         unz_global_info gi;
<span class="lineNum">     346 </span>            :         const char *dir;
<span class="lineNum">     347 </span>            :         u32 i;
<span class="lineNum">     348 </span>            :         GF_WidgetPackage *wzip;
<span class="lineNum">     349 </span>            :         unzFile uf = unzOpen2(path, NULL);
<span class="lineNum">     350 </span>            :         if (!uf) return NULL;
<span class="lineNum">     351 </span>            : 
<span class="lineNum">     352 </span>            :         GF_SAFEALLOC(wzip, GF_WidgetPackage);
<span class="lineNum">     353 </span>            :         if (!wzip) return NULL;
<span class="lineNum">     354 </span>            : 
<span class="lineNum">     355 </span>            :         wzip-&gt;wm = wm;
<span class="lineNum">     356 </span>            :         wzip-&gt;is_zip = GF_TRUE;
<span class="lineNum">     357 </span>            :         wzip-&gt;relocate_uri = widget_package_relocate_uri;
<span class="lineNum">     358 </span>            :         wzip-&gt;resources = gf_list_new();
<span class="lineNum">     359 </span>            :         wzip-&gt;package_path = gf_strdup(path);
<span class="lineNum">     360 </span>            :         dir = gf_cfg_get_key(wm-&gt;term-&gt;user-&gt;config, &quot;General&quot;, &quot;CacheDirectory&quot;);
<span class="lineNum">     361 </span>            :         /* create the extracted path for the package root using:
<span class="lineNum">     362 </span>            :            the cache dir + a CRC of the file path and the instance*/
<span class="lineNum">     363 </span>            :         sprintf(wzip-&gt;root_extracted_path, &quot;%s%p&quot;, path, wzip);
<span class="lineNum">     364 </span>            :         i = gf_crc_32((char *)wzip-&gt;root_extracted_path, (u32) strlen(wzip-&gt;root_extracted_path));
<span class="lineNum">     365 </span>            :         sprintf(wzip-&gt;archive_id, &quot;GWM_%08X_&quot;, i);
<span class="lineNum">     366 </span>            :         sprintf(wzip-&gt;root_extracted_path, &quot;%s/%s&quot;, dir, wzip-&gt;archive_id);
<span class="lineNum">     367 </span>            : 
<span class="lineNum">     368 </span>            :         unzGetGlobalInfo(uf, &amp;gi);
<span class="lineNum">     369 </span>            :         for (i=0; i&lt;gi.number_entry; i++)  {
<span class="lineNum">     370 </span>            :                 char szPath[GF_MAX_PATH];
<span class="lineNum">     371 </span>            :                 char *sep;
<span class="lineNum">     372 </span>            :                 GF_WidgetPackageResource *pack_res;
<span class="lineNum">     373 </span>            :                 char filename_inzip[256];
<span class="lineNum">     374 </span>            :                 unz_file_info file_info;
<span class="lineNum">     375 </span>            :                 unzGetCurrentFileInfo(uf, &amp;file_info, filename_inzip,sizeof(filename_inzip),NULL,0,NULL,0);
<span class="lineNum">     376 </span>            : 
<span class="lineNum">     377 </span>            :                 sep = strrchr(filename_inzip, '/');
<span class="lineNum">     378 </span>            :                 if (!sep) sep = strrchr(filename_inzip, '\\');
<span class="lineNum">     379 </span>            :                 if (sep) {
<span class="lineNum">     380 </span>            :                         sep[0] = 0;
<span class="lineNum">     381 </span>            :                         sprintf(szPath, &quot;%s_%08X_%s&quot;, wzip-&gt;root_extracted_path, gf_crc_32(filename_inzip, (u32) strlen(filename_inzip)), sep+1);
<span class="lineNum">     382 </span>            :                         sep[0] = '/';
<span class="lineNum">     383 </span>            :                 } else {
<span class="lineNum">     384 </span>            :                         strcpy(szPath, wzip-&gt;root_extracted_path);
<span class="lineNum">     385 </span>            :                         strcat(szPath, filename_inzip);
<span class="lineNum">     386 </span>            :                 }
<span class="lineNum">     387 </span>            : 
<span class="lineNum">     388 </span>            : 
<span class="lineNum">     389 </span>            :                 if (!strcmp(filename_inzip, &quot;config.xml&quot;)) {
<span class="lineNum">     390 </span>            :                         int err;
<span class="lineNum">     391 </span>            :                         char buf[8192];
<span class="lineNum">     392 </span>            :                         FILE *fout;
<span class="lineNum">     393 </span>            :                         unzOpenCurrentFile3(uf, NULL, NULL, 0, NULL/*password*/);
<span class="lineNum">     394 </span>            : 
<span class="lineNum">     395 </span>            :                         fout=gf_fopen(szPath,&quot;wb&quot;);
<span class="lineNum">     396 </span>            :                         if (!fout) return NULL;
<span class="lineNum">     397 </span>            : 
<span class="lineNum">     398 </span>            :                         do {
<span class="lineNum">     399 </span>            :                                 err = unzReadCurrentFile(uf,buf,8192);
<span class="lineNum">     400 </span>            :                                 if (err&lt;0) break;
<span class="lineNum">     401 </span>            : 
<span class="lineNum">     402 </span>            :                                 if (err&gt;0)
<span class="lineNum">     403 </span>            :                                         if (gf_fwrite(buf,err,1,fout)!=1) {
<span class="lineNum">     404 </span>            :                                                 err=UNZ_ERRNO;
<span class="lineNum">     405 </span>            :                                                 break;
<span class="lineNum">     406 </span>            :                                         }
<span class="lineNum">     407 </span>            :                         } while (err&gt;0);
<span class="lineNum">     408 </span>            :                         if (fout) gf_fclose(fout);
<span class="lineNum">     409 </span>            :                         if (err==0) {
<span class="lineNum">     410 </span>            :                                 GF_SAFEALLOC(pack_res, GF_WidgetPackageResource);
<span class="lineNum">     411 </span>            :                                 if (!pack_res) {
<span class="lineNum">     412 </span>            :                                         GF_LOG(GF_LOG_ERROR, GF_LOG_CONTAINER, (&quot;[WidgetMan] Failed to allocate widget resource\n&quot;));
<span class="lineNum">     413 </span>            :                                         continue;
<span class="lineNum">     414 </span>            :                                 }
<span class="lineNum">     415 </span>            :                                 
<span class="lineNum">     416 </span>            :                                 pack_res-&gt;extracted_path = gf_strdup(szPath);
<span class="lineNum">     417 </span>            :                                 pack_res-&gt;inner_path = gf_strdup(filename_inzip);
<span class="lineNum">     418 </span>            :                                 pack_res-&gt;extracted = GF_TRUE;
<span class="lineNum">     419 </span>            :                                 gf_list_add(wzip-&gt;resources, pack_res);
<span class="lineNum">     420 </span>            :                         }
<span class="lineNum">     421 </span>            :                 } else {
<span class="lineNum">     422 </span>            :                         GF_SAFEALLOC(pack_res, GF_WidgetPackageResource);
<span class="lineNum">     423 </span>            :                         if (!pack_res) {
<span class="lineNum">     424 </span>            :                                 GF_LOG(GF_LOG_ERROR, GF_LOG_CONTAINER, (&quot;[WidgetMan] Failed to allocate widget resource\n&quot;));
<span class="lineNum">     425 </span>            :                                 continue;
<span class="lineNum">     426 </span>            :                         }
<span class="lineNum">     427 </span>            :                         pack_res-&gt;extracted_path = gf_strdup(szPath);
<span class="lineNum">     428 </span>            :                         pack_res-&gt;inner_path = gf_strdup(filename_inzip);
<span class="lineNum">     429 </span>            :                         pack_res-&gt;extracted = GF_FALSE;
<span class="lineNum">     430 </span>            :                         gf_list_add(wzip-&gt;resources, pack_res);
<span class="lineNum">     431 </span>            :                 }
<span class="lineNum">     432 </span>            : 
<span class="lineNum">     433 </span>            :                 if ((i+1)&lt;gi.number_entry)
<span class="lineNum">     434 </span>            :                         unzGoToNextFile(uf);
<span class="lineNum">     435 </span>            :         }
<span class="lineNum">     436 </span>            :         unzClose(uf);
<span class="lineNum">     437 </span>            : 
<span class="lineNum">     438 </span>            :         /* register this widget package as a relocator to enable localization of resources inside this package */
<span class="lineNum">     439 </span>            :         gf_mx_p(wm-&gt;term-&gt;net_mx);
<span class="lineNum">     440 </span>            :         gf_list_add(wm-&gt;term-&gt;uri_relocators, wzip);
<span class="lineNum">     441 </span>            :         gf_mx_v(wm-&gt;term-&gt;net_mx);
<span class="lineNum">     442 </span>            :         return wzip;
<span class="lineNum">     443 </span>            : }
<span class="lineNum">     444 </span>            : 
<span class="lineNum">     445 </span>            : GF_WidgetPackage *widget_package_new(GF_WidgetManager *wm, const char *path)
<span class="lineNum">     446 </span>            : {
<span class="lineNum">     447 </span>            :         if (gf_unzip_probe(path)) {
<span class="lineNum">     448 </span>            :                 return widget_zip_new(wm, path);
<span class="lineNum">     449 </span>            :         }
<span class="lineNum">     450 </span>            : #ifndef GPAC_DISABLE_ISOM
<span class="lineNum">     451 </span>            :         /*ISOFF-based packaged widget */
<span class="lineNum">     452 </span>            :         else if (gf_isom_probe_file(path)) {
<span class="lineNum">     453 </span>            :                 return widget_isom_new(wm, path);
<span class="lineNum">     454 </span>            :         }
<span class="lineNum">     455 </span>            : #endif
<span class="lineNum">     456 </span>            :         return NULL;
<span class="lineNum">     457 </span>            : }
<span class="lineNum">     458 </span>            : 
<span class="lineNum">     459 </span>            : static void widget_package_del(GF_WidgetManager *wm, GF_WidgetPackage *wpackage)
<span class="lineNum">     460 </span>            : {
<span class="lineNum">     461 </span>            :         gf_mx_p(wm-&gt;term-&gt;net_mx);
<span class="lineNum">     462 </span>            :         gf_list_del_item(wm-&gt;term-&gt;uri_relocators, wpackage);
<span class="lineNum">     463 </span>            :         gf_mx_v(wm-&gt;term-&gt;net_mx);
<span class="lineNum">     464 </span>            : 
<span class="lineNum">     465 </span>            :         while (gf_list_count(wpackage-&gt;resources)) {
<span class="lineNum">     466 </span>            :                 GF_WidgetPackageResource *wu = (GF_WidgetPackageResource*)gf_list_get(wpackage-&gt;resources, 0);
<span class="lineNum">     467 </span>            :                 gf_list_rem(wpackage-&gt;resources, 0);
<span class="lineNum">     468 </span>            :                 gf_delete_file(wu-&gt;extracted_path);
<span class="lineNum">     469 </span>            :                 gf_free(wu-&gt;extracted_path);
<span class="lineNum">     470 </span>            :                 gf_free(wu-&gt;inner_path);
<span class="lineNum">     471 </span>            :                 gf_free(wu);
<span class="lineNum">     472 </span>            :         }
<span class="lineNum">     473 </span>            :         gf_list_del(wpackage-&gt;resources);
<span class="lineNum">     474 </span>            :         if (wpackage-&gt;sess) gf_dm_sess_del(wpackage-&gt;sess);
<span class="lineNum">     475 </span>            :         gf_free(wpackage-&gt;package_path);
<span class="lineNum">     476 </span>            :         gf_free(wpackage);
<span class="lineNum">     477 </span>            : }
<span class="lineNum">     478 </span>            : 
<span class="lineNum">     479 </span>            : 
<span class="lineNum">     480 </span>            : 
<span class="lineNum">     481 </span>            : static void wm_delete_message_param(GF_WidgetPin *mp)
<span class="lineNum">     482 </span>            : {
<span class="lineNum">     483 </span>            :         if (!mp) return;
<span class="lineNum">     484 </span>            :         if (mp-&gt;node) gf_free(mp-&gt;node);
<span class="lineNum">     485 </span>            :         if (mp-&gt;attribute) gf_free(mp-&gt;attribute);
<span class="lineNum">     486 </span>            :         if (mp-&gt;default_value) gf_free(mp-&gt;default_value);
<span class="lineNum">     487 </span>            :         if (mp-&gt;name) gf_free(mp-&gt;name);
<span class="lineNum">     488 </span>            :         gf_free(mp);
<span class="lineNum">     489 </span>            : }
<span class="lineNum">     490 </span>            : 
<span class="lineNum">     491 </span>            : static void wm_delete_widget_content(GF_WidgetContent *content)
<span class="lineNum">     492 </span>            : {
<span class="lineNum">     493 </span>            :         if (!content) return;
<span class="lineNum">     494 </span>            : 
<span class="lineNum">     495 </span>            :         while (gf_list_count(content-&gt;interfaces)) {
<span class="lineNum">     496 </span>            :                 GF_WidgetInterface *ifce = (GF_WidgetInterface*)gf_list_last(content-&gt;interfaces);
<span class="lineNum">     497 </span>            :                 gf_list_rem_last(content-&gt;interfaces);
<span class="lineNum">     498 </span>            : 
<span class="lineNum">     499 </span>            :                 while (gf_list_count(ifce-&gt;messages)) {
<span class="lineNum">     500 </span>            :                         GF_WidgetMessage *msg = (GF_WidgetMessage*)gf_list_last(ifce-&gt;messages);
<span class="lineNum">     501 </span>            :                         gf_list_rem_last(ifce-&gt;messages);
<span class="lineNum">     502 </span>            : 
<span class="lineNum">     503 </span>            :                         while (gf_list_count(msg-&gt;params)) {
<span class="lineNum">     504 </span>            :                                 GF_WidgetPin *par = (GF_WidgetPin*)gf_list_last(msg-&gt;params);
<span class="lineNum">     505 </span>            :                                 gf_list_rem_last(msg-&gt;params);
<span class="lineNum">     506 </span>            :                                 wm_delete_message_param(par);
<span class="lineNum">     507 </span>            :                         }
<span class="lineNum">     508 </span>            :                         gf_list_del(msg-&gt;params);
<span class="lineNum">     509 </span>            : 
<span class="lineNum">     510 </span>            :                         wm_delete_message_param(msg-&gt;input_action);
<span class="lineNum">     511 </span>            :                         wm_delete_message_param(msg-&gt;output_trigger);
<span class="lineNum">     512 </span>            :                         gf_free(msg-&gt;name);
<span class="lineNum">     513 </span>            :                         gf_free(msg);
<span class="lineNum">     514 </span>            :                 }
<span class="lineNum">     515 </span>            :                 gf_list_del(ifce-&gt;messages);
<span class="lineNum">     516 </span>            :                 wm_delete_message_param(ifce-&gt;bind_action);
<span class="lineNum">     517 </span>            :                 wm_delete_message_param(ifce-&gt;unbind_action);
<span class="lineNum">     518 </span>            :                 if (ifce-&gt;obj) gf_js_remove_root(ifce-&gt;content-&gt;widget-&gt;wm-&gt;ctx, &amp;ifce-&gt;obj, GF_JSGC_OBJECT);
<span class="lineNum">     519 </span>            : 
<span class="lineNum">     520 </span>            :                 if (ifce-&gt;connectTo) gf_free(ifce-&gt;connectTo);
<span class="lineNum">     521 </span>            :                 gf_free(ifce-&gt;type);
<span class="lineNum">     522 </span>            :                 gf_free(ifce);
<span class="lineNum">     523 </span>            :         }
<span class="lineNum">     524 </span>            :         gf_list_del(content-&gt;interfaces);
<span class="lineNum">     525 </span>            : 
<span class="lineNum">     526 </span>            :         while (gf_list_count(content-&gt;components)) {
<span class="lineNum">     527 </span>            :                 GF_WidgetComponent *comp = (GF_WidgetComponent*)gf_list_last(content-&gt;components);
<span class="lineNum">     528 </span>            :                 gf_list_rem_last(content-&gt;components);
<span class="lineNum">     529 </span>            : 
<span class="lineNum">     530 </span>            :                 wm_delete_message_param(comp-&gt;activateTrigger);
<span class="lineNum">     531 </span>            :                 wm_delete_message_param(comp-&gt;deactivateTrigger);
<span class="lineNum">     532 </span>            : 
<span class="lineNum">     533 </span>            :                 while (gf_list_count(comp-&gt;required_interfaces)) {
<span class="lineNum">     534 </span>            :                         char *type = (char*)gf_list_last(comp-&gt;required_interfaces);
<span class="lineNum">     535 </span>            :                         gf_list_rem_last(comp-&gt;required_interfaces);
<span class="lineNum">     536 </span>            :                         if (type) gf_free(type);
<span class="lineNum">     537 </span>            :                 }
<span class="lineNum">     538 </span>            :                 gf_list_del(comp-&gt;required_interfaces);
<span class="lineNum">     539 </span>            :                 if (comp-&gt;id) gf_free(comp-&gt;id);
<span class="lineNum">     540 </span>            :                 if (comp-&gt;src) gf_free(comp-&gt;src);
<span class="lineNum">     541 </span>            :                 gf_free(comp);
<span class="lineNum">     542 </span>            :         }
<span class="lineNum">     543 </span>            :         gf_list_del(content-&gt;components);
<span class="lineNum">     544 </span>            : 
<span class="lineNum">     545 </span>            :         while (gf_list_count(content-&gt;preferences)) {
<span class="lineNum">     546 </span>            :                 GF_WidgetPreference *pref = (GF_WidgetPreference*)gf_list_last(content-&gt;preferences);
<span class="lineNum">     547 </span>            :                 gf_list_rem_last(content-&gt;preferences);
<span class="lineNum">     548 </span>            : 
<span class="lineNum">     549 </span>            :                 wm_delete_message_param(pref-&gt;connectTo);
<span class="lineNum">     550 </span>            :                 if (pref-&gt;value) gf_free(pref-&gt;value);
<span class="lineNum">     551 </span>            :                 gf_free(pref-&gt;name);
<span class="lineNum">     552 </span>            :                 gf_free(pref);
<span class="lineNum">     553 </span>            :         }
<span class="lineNum">     554 </span>            :         gf_list_del(content-&gt;preferences);
<span class="lineNum">     555 </span>            : 
<span class="lineNum">     556 </span>            :         wm_delete_message_param(content-&gt;saveTrigger);
<span class="lineNum">     557 </span>            :         wm_delete_message_param(content-&gt;restoreTrigger);
<span class="lineNum">     558 </span>            :         wm_delete_message_param(content-&gt;savedAction);
<span class="lineNum">     559 </span>            :         wm_delete_message_param(content-&gt;restoredAction);
<span class="lineNum">     560 </span>            : 
<span class="lineNum">     561 </span>            :         gf_free(content-&gt;src);
<span class="lineNum">     562 </span>            :         gf_free(content-&gt;relocated_src);
<span class="lineNum">     563 </span>            :         gf_free(content-&gt;mimetype);
<span class="lineNum">     564 </span>            :         gf_free(content-&gt;encoding);
<span class="lineNum">     565 </span>            :         gf_free(content);
<span class="lineNum">     566 </span>            : }
<span class="lineNum">     567 </span>            : 
<span class="lineNum">     568 </span>            : static void wm_delete_widget(GF_WidgetManager *wm, GF_Widget *wid)
<span class="lineNum">     569 </span>            : {
<span class="lineNum">     570 </span>            :         gf_list_del_item(wm-&gt;widgets, wid);
<span class="lineNum">     571 </span>            : 
<span class="lineNum">     572 </span>            :         if (wid-&gt;url) gf_free(wid-&gt;url);
<span class="lineNum">     573 </span>            :         if (wid-&gt;manifest_path) gf_free(wid-&gt;manifest_path);
<span class="lineNum">     574 </span>            :         wm_delete_widget_content(wid-&gt;main);
<span class="lineNum">     575 </span>            :         if (wid-&gt;local_path) gf_free(wid-&gt;local_path);
<span class="lineNum">     576 </span>            :         if (wid-&gt;name) gf_free(wid-&gt;name);
<span class="lineNum">     577 </span>            :         if (wid-&gt;shortname) gf_free(wid-&gt;shortname);
<span class="lineNum">     578 </span>            :         if (wid-&gt;identifier) gf_free(wid-&gt;identifier);
<span class="lineNum">     579 </span>            :         if (wid-&gt;authorName) gf_free(wid-&gt;authorName);
<span class="lineNum">     580 </span>            :         if (wid-&gt;authorEmail) gf_free(wid-&gt;authorEmail);
<span class="lineNum">     581 </span>            :         if (wid-&gt;authorHref) gf_free(wid-&gt;authorHref);
<span class="lineNum">     582 </span>            :         if (wid-&gt;description) gf_free(wid-&gt;description);
<span class="lineNum">     583 </span>            :         if (wid-&gt;license) gf_free(wid-&gt;license);
<span class="lineNum">     584 </span>            :         if (wid-&gt;licenseHref) gf_free(wid-&gt;licenseHref);
<span class="lineNum">     585 </span>            :         if (wid-&gt;viewmodes) gf_free(wid-&gt;viewmodes);
<span class="lineNum">     586 </span>            :         if (wid-&gt;version) gf_free(wid-&gt;version);
<span class="lineNum">     587 </span>            :         if (wid-&gt;uuid) gf_free(wid-&gt;uuid);
<span class="lineNum">     588 </span>            : 
<span class="lineNum">     589 </span>            : 
<span class="lineNum">     590 </span>            :         while (gf_list_count(wid-&gt;icons)) {
<span class="lineNum">     591 </span>            :                 GF_WidgetContent *icon = (GF_WidgetContent*)gf_list_get(wid-&gt;icons, 0);
<span class="lineNum">     592 </span>            :                 gf_list_rem(wid-&gt;icons, 0);
<span class="lineNum">     593 </span>            :                 wm_delete_widget_content(icon);
<span class="lineNum">     594 </span>            :         }
<span class="lineNum">     595 </span>            :         gf_list_del(wid-&gt;icons);
<span class="lineNum">     596 </span>            : 
<span class="lineNum">     597 </span>            :         while (gf_list_count(wid-&gt;features)) {
<span class="lineNum">     598 </span>            :                 GF_WidgetFeature *f = (GF_WidgetFeature*)gf_list_get(wid-&gt;features, 0);
<span class="lineNum">     599 </span>            :                 gf_list_rem(wid-&gt;features, 0);
<span class="lineNum">     600 </span>            :                 if (f-&gt;name) gf_free(f-&gt;name);
<span class="lineNum">     601 </span>            :                 while (gf_list_count(f-&gt;params)) {
<span class="lineNum">     602 </span>            :                         GF_WidgetFeatureParam *p = (GF_WidgetFeatureParam*)gf_list_get(f-&gt;params, 0);
<span class="lineNum">     603 </span>            :                         gf_list_rem(f-&gt;params, 0);
<span class="lineNum">     604 </span>            :                         if (p-&gt;name) gf_free(p-&gt;name);
<span class="lineNum">     605 </span>            :                         if (p-&gt;value) gf_free(p-&gt;value);
<span class="lineNum">     606 </span>            :                         gf_free(p);
<span class="lineNum">     607 </span>            :                 }
<span class="lineNum">     608 </span>            :                 gf_free(f);
<span class="lineNum">     609 </span>            :         }
<span class="lineNum">     610 </span>            :         gf_list_del(wid-&gt;features);
<span class="lineNum">     611 </span>            : 
<span class="lineNum">     612 </span>            :         if (wid-&gt;wpack) widget_package_del(wm, wid-&gt;wpack);
<span class="lineNum">     613 </span>            :         gf_free(wid);
<span class="lineNum">     614 </span>            : }
<span class="lineNum">     615 </span>            : 
<span class="lineNum">     616 </span>            : static void wm_delete_interface_instance(GF_WidgetManager *wm, GF_WidgetInterfaceInstance *bifce)
<span class="lineNum">     617 </span>            : {
<span class="lineNum">     618 </span>            :         if (bifce-&gt;hostname) gf_free(bifce-&gt;hostname);
<span class="lineNum">     619 </span>            :         if (bifce-&gt;obj) {
<span class="lineNum">     620 </span>            :                 SMJS_SET_PRIVATE(wm-&gt;ctx, bifce-&gt;obj, NULL);
<span class="lineNum">     621 </span>            :                 gf_js_remove_root(wm-&gt;ctx, &amp;bifce-&gt;obj, GF_JSGC_OBJECT);
<span class="lineNum">     622 </span>            :         }
<span class="lineNum">     623 </span>            :         gf_free(bifce);
<span class="lineNum">     624 </span>            : }
<span class="lineNum">     625 </span>            : 
<span class="lineNum">     626 </span>            : static void wm_delete_widget_instance(GF_WidgetManager *wm, GF_WidgetInstance *widg)
<span class="lineNum">     627 </span>            : {
<span class="lineNum">     628 </span>            : 
<span class="lineNum">     629 </span>            :         while (gf_list_count(widg-&gt;components)) {
<span class="lineNum">     630 </span>            :                 GF_WidgetComponentInstance *comp = (GF_WidgetComponentInstance*)gf_list_get(widg-&gt;components, 0);
<span class="lineNum">     631 </span>            :                 gf_list_rem(widg-&gt;components, 0);
<span class="lineNum">     632 </span>            :                 if (comp-&gt;wid) wm_delete_widget_instance(wm, comp-&gt;wid);
<span class="lineNum">     633 </span>            :                 gf_free(comp);
<span class="lineNum">     634 </span>            :         }
<span class="lineNum">     635 </span>            :         gf_list_del(widg-&gt;components);
<span class="lineNum">     636 </span>            : 
<span class="lineNum">     637 </span>            :         while (gf_list_count(widg-&gt;bound_ifces)) {
<span class="lineNum">     638 </span>            :                 GF_WidgetInterfaceInstance *bifce = (GF_WidgetInterfaceInstance*)gf_list_get(widg-&gt;bound_ifces, 0);
<span class="lineNum">     639 </span>            :                 gf_list_rem(widg-&gt;bound_ifces, 0);
<span class="lineNum">     640 </span>            :                 wm_delete_interface_instance(wm, bifce);
<span class="lineNum">     641 </span>            :         }
<span class="lineNum">     642 </span>            :         gf_list_del(widg-&gt;bound_ifces);
<span class="lineNum">     643 </span>            : 
<span class="lineNum">     644 </span>            :         gf_list_del(widg-&gt;output_triggers);
<span class="lineNum">     645 </span>            : 
<span class="lineNum">     646 </span>            :         if (widg-&gt;obj) {
<span class="lineNum">     647 </span>            :                 SMJS_SET_PRIVATE(wm-&gt;ctx, widg-&gt;obj, NULL);
<span class="lineNum">     648 </span>            :                 gf_js_remove_root(wm-&gt;ctx, &amp;widg-&gt;obj, GF_JSGC_OBJECT);
<span class="lineNum">     649 </span>            :         }
<span class="lineNum">     650 </span>            :         gf_list_del_item(wm-&gt;widget_instances, widg);
<span class="lineNum">     651 </span>            :         widg-&gt;widget-&gt;nb_instances--;
<span class="lineNum">     652 </span>            :         if (!widg-&gt;widget-&gt;nb_instances) wm_delete_widget(wm, widg-&gt;widget);
<span class="lineNum">     653 </span>            : 
<span class="lineNum">     654 </span>            :         if (!widg-&gt;permanent) {
<span class="lineNum">     655 </span>            :                 gf_cfg_del_section(wm-&gt;term-&gt;user-&gt;config, (const char *)widg-&gt;secname);
<span class="lineNum">     656 </span>            :                 gf_cfg_set_key(wm-&gt;term-&gt;user-&gt;config, &quot;Widgets&quot;, (const char *)widg-&gt;secname, NULL);
<span class="lineNum">     657 </span>            :         }
<span class="lineNum">     658 </span>            :         if (widg-&gt;mpegu_context) gf_xml_dom_del(widg-&gt;mpegu_context);
<span class="lineNum">     659 </span>            : 
<span class="lineNum">     660 </span>            :         gf_free(widg);
<span class="lineNum">     661 </span>            : }
<span class="lineNum">     662 </span>            : 
<span class="lineNum">     663 </span>            : 
<span class="lineNum">     664 </span>            : 
<span class="lineNum">     665 </span>            : static JSBool wm_widget_call_script(GF_WidgetInstance *wid, GF_WidgetPin *pin, uintN argc, jsval *argv, jsval *rval)
<span class="lineNum">     666 </span>            : {
<span class="lineNum">     667 </span>            :         jsval fval;
<span class="lineNum">     668 </span>            :         if (!wid-&gt;scene_context || !wid-&gt;scene_global) return JS_FALSE;
<span class="lineNum">     669 </span>            : 
<span class="lineNum">     670 </span>            :         /*if on_load property is assigned to this widget, add an event listener on the root.*/
<span class="lineNum">     671 </span>            :         JS_LookupProperty(wid-&gt;scene_context, wid-&gt;scene_global, pin-&gt;node, &amp;fval);
<span class="lineNum">     672 </span>            :         if (JSVAL_IS_OBJECT(fval)) {
<span class="lineNum">     673 </span>            :                 JS_CallFunctionValue(wid-&gt;scene_context, wid-&gt;scene_global, fval, argc, argv, rval);
<span class="lineNum">     674 </span>            :         }
<span class="lineNum">     675 </span>            :         return JS_TRUE;
<span class="lineNum">     676 </span>            : }
<span class="lineNum">     677 </span>            : 
<span class="lineNum">     678 </span>            : static JSBool wm_widget_set_scene_input_value(JSContext *c, JSObject *obj, uintN argc, jsval *argv, jsval *rval, u32 type, GF_WidgetInstance *wid, GF_WidgetPin *param, const char *value)
<span class="lineNum">     679 </span>            : {
<span class="lineNum">     680 </span>            :         char *str_val;
<span class="lineNum">     681 </span>            :         GF_Node *n;
<span class="lineNum">     682 </span>            :         GF_FieldInfo info;
<span class="lineNum">     683 </span>            :         GF_WidgetMessage *msg;
<span class="lineNum">     684 </span>            :         GF_WidgetInterface *ifce;
<span class="lineNum">     685 </span>            : 
<span class="lineNum">     686 </span>            :         if (!wid &amp;&amp; obj) wid = (GF_WidgetInstance *)SMJS_GET_PRIVATE(c, obj);
<span class="lineNum">     687 </span>            :         if (!wid) return JS_FALSE;
<span class="lineNum">     688 </span>            :         if (!wid-&gt;scene) return JS_TRUE;
<span class="lineNum">     689 </span>            : 
<span class="lineNum">     690 </span>            :         if (!param) {
<span class="lineNum">     691 </span>            :                 if (!JSVAL_IS_OBJECT(argv[0])) return JS_TRUE;
<span class="lineNum">     692 </span>            : 
<span class="lineNum">     693 </span>            :                 switch (type) {
<span class="lineNum">     694 </span>            :                 /*set_input*/
<span class="lineNum">     695 </span>            :                 case 0:
<span class="lineNum">     696 </span>            :                         if (argc!=2) return JS_FALSE;
<span class="lineNum">     697 </span>            :                         param = SMJS_GET_PRIVATE(c, JSVAL_TO_OBJECT(argv[0]) );
<span class="lineNum">     698 </span>            :                         break;
<span class="lineNum">     699 </span>            :                 /*call_input_action*/
<span class="lineNum">     700 </span>            :                 case 1:
<span class="lineNum">     701 </span>            :                         msg = SMJS_GET_PRIVATE(c, JSVAL_TO_OBJECT(argv[0]) );
<span class="lineNum">     702 </span>            :                         param = msg ? msg-&gt;input_action : NULL;
<span class="lineNum">     703 </span>            :                         break;
<span class="lineNum">     704 </span>            :                 /*bind_interface*/
<span class="lineNum">     705 </span>            :                 case 2:
<span class="lineNum">     706 </span>            :                         ifce = SMJS_GET_PRIVATE(c, JSVAL_TO_OBJECT(argv[0]) );
<span class="lineNum">     707 </span>            :                         param = ifce ? ifce-&gt;bind_action : NULL;
<span class="lineNum">     708 </span>            :                         break;
<span class="lineNum">     709 </span>            :                 /*unbind_interface*/
<span class="lineNum">     710 </span>            :                 case 3:
<span class="lineNum">     711 </span>            :                         ifce = SMJS_GET_PRIVATE(c, JSVAL_TO_OBJECT(argv[0]) );
<span class="lineNum">     712 </span>            :                         param = ifce ? ifce-&gt;unbind_action : NULL;
<span class="lineNum">     713 </span>            :                         break;
<span class="lineNum">     714 </span>            :                 }
<span class="lineNum">     715 </span>            :         }
<span class="lineNum">     716 </span>            : 
<span class="lineNum">     717 </span>            :         if (!param  || !param-&gt;node) return JS_TRUE;
<span class="lineNum">     718 </span>            :         /*this is a script call*/
<span class="lineNum">     719 </span>            :         if (!param-&gt;attribute) {
<span class="lineNum">     720 </span>            :                 return wm_widget_call_script(wid, param, 0, NULL, rval);
<span class="lineNum">     721 </span>            :         }
<span class="lineNum">     722 </span>            : 
<span class="lineNum">     723 </span>            :         n = gf_sg_find_node_by_name(wid-&gt;scene, param-&gt;node);
<span class="lineNum">     724 </span>            :         if (!n) return JS_TRUE;
<span class="lineNum">     725 </span>            : 
<span class="lineNum">     726 </span>            :         if (param-&gt;in_action) return JS_TRUE;
<span class="lineNum">     727 </span>            : 
<span class="lineNum">     728 </span>            :         param-&gt;in_action = GF_TRUE;
<span class="lineNum">     729 </span>            : 
<span class="lineNum">     730 </span>            : #ifndef GPAC_DISABLE_SVG
<span class="lineNum">     731 </span>            :         if (n-&gt;sgprivate-&gt;tag &gt;= GF_NODE_FIRST_DOM_NODE_TAG) {
<span class="lineNum">     732 </span>            :                 u32 evt_type;
<span class="lineNum">     733 </span>            :                 if (!type) {
<span class="lineNum">     734 </span>            :                         char *_str_val = NULL;
<span class="lineNum">     735 </span>            :                         if (value) {
<span class="lineNum">     736 </span>            :                                 str_val = (char *)value;
<span class="lineNum">     737 </span>            :                         } else {
<span class="lineNum">     738 </span>            :                                 if (!JSVAL_IS_STRING(argv[1])) goto exit;
<span class="lineNum">     739 </span>            :                                 str_val = _str_val = SMJS_CHARS(c, argv[1]);
<span class="lineNum">     740 </span>            :                         }
<span class="lineNum">     741 </span>            : 
<span class="lineNum">     742 </span>            :                         /* first check if the set_input refers to an attribute name or to an event name */
<span class="lineNum">     743 </span>            :                         evt_type = gf_dom_event_type_by_name(param-&gt;attribute);
<span class="lineNum">     744 </span>            : 
<span class="lineNum">     745 </span>            :                         /*events are not allowed for &lt;input&gt; and &lt;output&gt;*/
<span class="lineNum">     746 </span>            :                         if (evt_type == GF_EVENT_UNKNOWN) {
<span class="lineNum">     747 </span>            :                                 /* modify an attribute */
<span class="lineNum">     748 </span>            :                                 if (!strcmp(param-&gt;attribute, &quot;textContent&quot;)) {
<span class="lineNum">     749 </span>            :                                         gf_dom_set_textContent(n, (char *)str_val);
<span class="lineNum">     750 </span>            :                                         gf_node_changed(n, NULL);
<span class="lineNum">     751 </span>            :                                 }
<span class="lineNum">     752 </span>            :                                 else {
<span class="lineNum">     753 </span>            :                                         if (gf_node_get_attribute_by_name(n, param-&gt;attribute, 0, GF_TRUE, GF_FALSE, &amp;info)==GF_OK) {
<span class="lineNum">     754 </span>            :                                                 gf_svg_parse_attribute(n, &amp;info, (char *)str_val, 0);
<span class="lineNum">     755 </span>            :                                                 if (info.fieldType==XMLRI_datatype) gf_node_dirty_set(n, GF_SG_SVG_XLINK_HREF_DIRTY, GF_FALSE);
<span class="lineNum">     756 </span>            :                                                 gf_node_changed(n, &amp;info);
<span class="lineNum">     757 </span>            :                                         }
<span class="lineNum">     758 </span>            :                                 }
<span class="lineNum">     759 </span>            :                         }
<span class="lineNum">     760 </span>            :                         SMJS_FREE(c, _str_val);
<span class="lineNum">     761 </span>            : 
<span class="lineNum">     762 </span>            :                 } else {
<span class="lineNum">     763 </span>            :                         GF_DOM_Event evt;
<span class="lineNum">     764 </span>            :                         memset(&amp;evt, 0, sizeof(GF_DOM_Event));
<span class="lineNum">     765 </span>            :                         /* first check if the set_input refers to an attribute name or to an event name */
<span class="lineNum">     766 </span>            :                         evt_type = gf_dom_event_type_by_name(param-&gt;attribute);
<span class="lineNum">     767 </span>            :                         /* launch an event */
<span class="lineNum">     768 </span>            :                         if (evt_type != GF_EVENT_UNKNOWN) {
<span class="lineNum">     769 </span>            :                                 evt.type = evt_type;
<span class="lineNum">     770 </span>            :                                 gf_dom_event_fire(n, &amp;evt);
<span class="lineNum">     771 </span>            :                         } else {
<span class="lineNum">     772 </span>            :                                 /*should we fire a DOMAttrModified event ? to clarify in the spec*/
<span class="lineNum">     773 </span>            : 
<span class="lineNum">     774 </span>            :                                 if (gf_node_get_attribute_by_name(n, param-&gt;attribute, 0, GF_TRUE, GF_FALSE, &amp;info)==GF_OK) {
<span class="lineNum">     775 </span>            :                                         evt.bubbles = 1;
<span class="lineNum">     776 </span>            :                                         evt.type = GF_EVENT_ATTR_MODIFIED;
<span class="lineNum">     777 </span>            :                                         evt.attr = &amp;info;
<span class="lineNum">     778 </span>            :                                         gf_dom_event_fire(n, &amp;evt);
<span class="lineNum">     779 </span>            :                                 }
<span class="lineNum">     780 </span>            :                         }
<span class="lineNum">     781 </span>            :                 }
<span class="lineNum">     782 </span>            :         } else
<span class="lineNum">     783 </span>            : #endif
<span class="lineNum">     784 </span>            : 
<span class="lineNum">     785 </span>            : 
<span class="lineNum">     786 </span>            : #ifndef GPAC_DISABLE_VRML
<span class="lineNum">     787 </span>            :         {
<span class="lineNum">     788 </span>            :                 if (gf_node_get_field_by_name(n, param-&gt;attribute, &amp;info) != GF_OK) return JS_TRUE;
<span class="lineNum">     789 </span>            : 
<span class="lineNum">     790 </span>            :                 if (!type) {
<span class="lineNum">     791 </span>            :                         char *_str_val = NULL;
<span class="lineNum">     792 </span>            :                         jsdouble val;
<span class="lineNum">     793 </span>            : 
<span class="lineNum">     794 </span>            :                         switch (info.fieldType) {
<span class="lineNum">     795 </span>            :                         case GF_SG_VRML_SFSTRING:
<span class="lineNum">     796 </span>            :                                 if (value) {
<span class="lineNum">     797 </span>            :                                         str_val = (char *)value;
<span class="lineNum">     798 </span>            :                                 } else {
<span class="lineNum">     799 </span>            :                                         if (!JSVAL_IS_STRING(argv[1]))goto exit;
<span class="lineNum">     800 </span>            :                                         str_val = SMJS_CHARS(c, argv[1]);
<span class="lineNum">     801 </span>            :                                 }
<span class="lineNum">     802 </span>            :                                 if ( ((SFString*)info.far_ptr)-&gt;buffer) gf_free(((SFString*)info.far_ptr)-&gt;buffer);
<span class="lineNum">     803 </span>            :                                 ((SFString*)info.far_ptr)-&gt;buffer = str_val ? gf_strdup(str_val) : NULL;
<span class="lineNum">     804 </span>            :                                 break;
<span class="lineNum">     805 </span>            :                         case GF_SG_VRML_SFBOOL:
<span class="lineNum">     806 </span>            :                                 if (value) *((SFBool*)info.far_ptr) = (!strcmp(value, &quot;true&quot;)) ? 1 : 0;
<span class="lineNum">     807 </span>            :                                 else if (JSVAL_IS_BOOLEAN(argv[1])) *((SFBool*)info.far_ptr) = JSVAL_TO_BOOLEAN(argv[1]);
<span class="lineNum">     808 </span>            :                                 else if (JSVAL_IS_INT(argv[1])) *((SFBool*)info.far_ptr) = JSVAL_TO_INT(argv[1]);
<span class="lineNum">     809 </span>            :                                 else if (JSVAL_IS_STRING(argv[1])) {
<span class="lineNum">     810 </span>            :                                         str_val = SMJS_CHARS(c, argv[1]);
<span class="lineNum">     811 </span>            :                                         *((SFBool*)info.far_ptr) = (str_val &amp;&amp; !strcmp(str_val, &quot;true&quot;)) ? 1 : 0;
<span class="lineNum">     812 </span>            :                                         SMJS_FREE(c, str_val);
<span class="lineNum">     813 </span>            :                                 } else
<span class="lineNum">     814 </span>            :                                         goto exit;
<span class="lineNum">     815 </span>            :                                 break;
<span class="lineNum">     816 </span>            :                         case GF_SG_VRML_SFINT32:
<span class="lineNum">     817 </span>            :                                 if (value) *((SFInt32*)info.far_ptr) = (s32) atof(value);
<span class="lineNum">     818 </span>            :                                 else if (JSVAL_IS_INT(argv[1])) *((SFInt32*)info.far_ptr) = JSVAL_TO_INT(argv[1]);
<span class="lineNum">     819 </span>            :                                 else if (JSVAL_IS_NUMBER(argv[1])) {
<span class="lineNum">     820 </span>            :                                         JS_ValueToNumber(c, argv[1], &amp;val);
<span class="lineNum">     821 </span>            :                                         *((SFInt32*)info.far_ptr) = (s32) val;
<span class="lineNum">     822 </span>            :                                 } else if (JSVAL_IS_STRING(argv[1])) {
<span class="lineNum">     823 </span>            :                                         Double a_val;
<span class="lineNum">     824 </span>            :                                         str_val = SMJS_CHARS(c, argv[1]);
<span class="lineNum">     825 </span>            :                                         a_val = str_val ? atof(str_val) : 0;
<span class="lineNum">     826 </span>            :                                         *((SFInt32*)info.far_ptr) = (s32) a_val;
<span class="lineNum">     827 </span>            :                                         SMJS_FREE(c, str_val);
<span class="lineNum">     828 </span>            :                                 } else
<span class="lineNum">     829 </span>            :                                         goto exit;
<span class="lineNum">     830 </span>            :                                 break;
<span class="lineNum">     831 </span>            :                         case GF_SG_VRML_SFFLOAT:
<span class="lineNum">     832 </span>            :                                 if (value) *((SFFloat*)info.far_ptr) = FLT2FIX(atof(value));
<span class="lineNum">     833 </span>            :                                 else if (JSVAL_IS_INT(argv[1])) *((SFFloat *)info.far_ptr) = INT2FIX( JSVAL_TO_INT(argv[1]) );
<span class="lineNum">     834 </span>            :                                 else if (JSVAL_IS_NUMBER(argv[1])) {
<span class="lineNum">     835 </span>            :                                         JS_ValueToNumber(c, argv[1], &amp;val);
<span class="lineNum">     836 </span>            :                                         *((SFFloat *)info.far_ptr) = FLT2FIX( val );
<span class="lineNum">     837 </span>            :                                 } else if (JSVAL_IS_STRING(argv[1])) {
<span class="lineNum">     838 </span>            :                                         Double a_val;
<span class="lineNum">     839 </span>            :                                         str_val = SMJS_CHARS(c, argv[1]);
<span class="lineNum">     840 </span>            :                                         a_val = str_val ? atof(str_val) : 0;
<span class="lineNum">     841 </span>            :                                         *((SFFloat*)info.far_ptr) = FLT2FIX(a_val);
<span class="lineNum">     842 </span>            :                                         SMJS_FREE(c, str_val);
<span class="lineNum">     843 </span>            :                                 } else
<span class="lineNum">     844 </span>            :                                         goto exit;
<span class="lineNum">     845 </span>            :                                 break;
<span class="lineNum">     846 </span>            :                         case GF_SG_VRML_SFTIME:
<span class="lineNum">     847 </span>            :                                 if (value) *((SFTime*)info.far_ptr) = atof(value);
<span class="lineNum">     848 </span>            :                                 else if (JSVAL_IS_INT(argv[1])) *((SFTime *)info.far_ptr) = JSVAL_TO_INT(argv[1]);
<span class="lineNum">     849 </span>            :                                 else if (JSVAL_IS_NUMBER(argv[1])) {
<span class="lineNum">     850 </span>            :                                         JS_ValueToNumber(c, argv[1], &amp;val);
<span class="lineNum">     851 </span>            :                                         *((SFTime *)info.far_ptr) = val;
<span class="lineNum">     852 </span>            :                                 } else if (JSVAL_IS_STRING(argv[1])) {
<span class="lineNum">     853 </span>            :                                         Double a_val;
<span class="lineNum">     854 </span>            :                                         str_val = SMJS_CHARS(c, argv[1]);
<span class="lineNum">     855 </span>            :                                         a_val = str_val ? atof(str_val) : 0;
<span class="lineNum">     856 </span>            :                                         *((SFTime *)info.far_ptr) = a_val;
<span class="lineNum">     857 </span>            :                                         SMJS_FREE(c, str_val);
<span class="lineNum">     858 </span>            :                                 } else
<span class="lineNum">     859 </span>            :                                         goto exit;
<span class="lineNum">     860 </span>            :                                 break;
<span class="lineNum">     861 </span>            :                         case GF_SG_VRML_MFSTRING:
<span class="lineNum">     862 </span>            :                                 if (value) {
<span class="lineNum">     863 </span>            :                                         str_val = (char *)value;
<span class="lineNum">     864 </span>            :                                 } else {
<span class="lineNum">     865 </span>            :                                         if (!JSVAL_IS_STRING(argv[1])) goto exit;
<span class="lineNum">     866 </span>            :                                         str_val = _str_val = SMJS_CHARS(c, argv[1]);
<span class="lineNum">     867 </span>            :                                 }
<span class="lineNum">     868 </span>            :                                 if ( ((GenMFField *)info.far_ptr)-&gt;count != 1) {
<span class="lineNum">     869 </span>            :                                         gf_sg_vrml_mf_reset(info.far_ptr, GF_SG_VRML_MFSTRING);
<span class="lineNum">     870 </span>            :                                         gf_sg_vrml_mf_alloc(info.far_ptr, GF_SG_VRML_MFSTRING, 1);
<span class="lineNum">     871 </span>            :                                 }
<span class="lineNum">     872 </span>            :                                 if ( ((MFString*)info.far_ptr)-&gt;vals[0]) gf_free( ((MFString*)info.far_ptr)-&gt;vals[0] );
<span class="lineNum">     873 </span>            :                                 ((MFString*)info.far_ptr)-&gt;vals[0] = str_val ? gf_strdup(str_val) : NULL;
<span class="lineNum">     874 </span>            : 
<span class="lineNum">     875 </span>            :                                 SMJS_FREE(c, _str_val);
<span class="lineNum">     876 </span>            :                                 break;
<span class="lineNum">     877 </span>            :                         }
<span class="lineNum">     878 </span>            :                 }
<span class="lineNum">     879 </span>            : 
<span class="lineNum">     880 </span>            :                 //if this is a script eventIn call directly script
<span class="lineNum">     881 </span>            :                 if ((n-&gt;sgprivate-&gt;tag==TAG_MPEG4_Script)
<span class="lineNum">     882 </span>            : #ifndef GPAC_DISABLE_X3D
<span class="lineNum">     883 </span>            :                         || (n-&gt;sgprivate-&gt;tag==TAG_X3D_Script)
<span class="lineNum">     884 </span>            : #endif
<span class="lineNum">     885 </span>            :                    )
<span class="lineNum">     886 </span>            :                         gf_sg_script_event_in(n, &amp;info);
<span class="lineNum">     887 </span>            : 
<span class="lineNum">     888 </span>            :                 gf_node_changed(n, &amp;info);
<span class="lineNum">     889 </span>            : 
<span class="lineNum">     890 </span>            :                 /*if this is an exposedField, route it*/
<span class="lineNum">     891 </span>            :                 if (info.eventType==GF_SG_EVENT_EXPOSED_FIELD) {
<span class="lineNum">     892 </span>            :                         gf_node_event_out(n, info.fieldIndex);
<span class="lineNum">     893 </span>            :                 }
<span class="lineNum">     894 </span>            :         }
<span class="lineNum">     895 </span>            : #endif /*GPAC_DISABLE_VRML*/
<span class="lineNum">     896 </span>            : 
<span class="lineNum">     897 </span>            : exit:
<span class="lineNum">     898 </span>            :         param-&gt;in_action = GF_FALSE;
<span class="lineNum">     899 </span>            :         return JS_TRUE;
<span class="lineNum">     900 </span>            : }
<span class="lineNum">     901 </span>            : 
<span class="lineNum">     902 </span>            : 
<span class="lineNum">     903 </span>            : static JSBool SMJS_FUNCTION(wm_widget_set_input)
<span class="lineNum">     904 </span>            : {
<span class="lineNum">     905 </span>            :         SMJS_OBJ
<span class="lineNum">     906 </span>            :         SMJS_ARGS
<span class="lineNum">     907 </span>            :         SMJS_DECL_RVAL
<span class="lineNum">     908 </span>            :         return wm_widget_set_scene_input_value(c, obj, argc, argv, rval, 0, NULL, NULL, NULL);
<span class="lineNum">     909 </span>            : }
<span class="lineNum">     910 </span>            : static JSBool SMJS_FUNCTION(wm_widget_call_input_action)
<span class="lineNum">     911 </span>            : {
<span class="lineNum">     912 </span>            :         SMJS_OBJ
<span class="lineNum">     913 </span>            :         SMJS_ARGS
<span class="lineNum">     914 </span>            :         SMJS_DECL_RVAL
<span class="lineNum">     915 </span>            :         return wm_widget_set_scene_input_value(c, obj, 1, argv, rval, 1, NULL, NULL, NULL);
<span class="lineNum">     916 </span>            : }
<span class="lineNum">     917 </span>            : 
<span class="lineNum">     918 </span>            : 
<span class="lineNum">     919 </span>            : static JSBool SMJS_FUNCTION(wm_widget_call_input_script)
<span class="lineNum">     920 </span>            : {
<span class="lineNum">     921 </span>            :         GF_WidgetMessage *msg;
<span class="lineNum">     922 </span>            :         GF_WidgetPin *param;
<span class="lineNum">     923 </span>            :         SMJS_OBJ
<span class="lineNum">     924 </span>            :         SMJS_ARGS
<span class="lineNum">     925 </span>            :         GF_WidgetInstance *wid = (GF_WidgetInstance *)SMJS_GET_PRIVATE(c, obj);
<span class="lineNum">     926 </span>            :         if (!wid || (argc!=2) ) return JS_FALSE;
<span class="lineNum">     927 </span>            :         if (!wid-&gt;scene) return JS_TRUE;
<span class="lineNum">     928 </span>            : 
<span class="lineNum">     929 </span>            :         if (!JSVAL_IS_OBJECT(argv[0])) return JS_TRUE;
<span class="lineNum">     930 </span>            :         msg = SMJS_GET_PRIVATE(c, JSVAL_TO_OBJECT(argv[0]) );
<span class="lineNum">     931 </span>            :         param = msg ? msg-&gt;input_action : NULL;
<span class="lineNum">     932 </span>            :         if (!param || !param-&gt;node || param-&gt;attribute) return JS_FALSE;
<span class="lineNum">     933 </span>            : 
<span class="lineNum">     934 </span>            :         if (JSVAL_IS_OBJECT(argv[1])) {
<span class="lineNum">     935 </span>            :                 jsval *args;
<span class="lineNum">     936 </span>            :                 JSObject *list = JSVAL_TO_OBJECT(argv[1]);
<span class="lineNum">     937 </span>            :                 u32 i, count;
<span class="lineNum">     938 </span>            :                 JS_GetArrayLength(c, list, (jsuint*) &amp;count);
<span class="lineNum">     939 </span>            :                 args = (jsval*)gf_malloc(sizeof(jsval)*count);
<span class="lineNum">     940 </span>            :                 for (i=0; i&lt;count; i++) {
<span class="lineNum">     941 </span>            :                         JS_GetElement(c, list, (jsint) i, &amp;args[i] );
<span class="lineNum">     942 </span>            :                 }
<span class="lineNum">     943 </span>            : 
<span class="lineNum">     944 </span>            :                 wm_widget_call_script(wid, param, count, args, SMJS_GET_RVAL);
<span class="lineNum">     945 </span>            : 
<span class="lineNum">     946 </span>            :                 gf_free(args);
<span class="lineNum">     947 </span>            :         }
<span class="lineNum">     948 </span>            :         return JS_TRUE;
<span class="lineNum">     949 </span>            : }
<span class="lineNum">     950 </span>            : 
<span class="lineNum">     951 </span>            : 
<span class="lineNum">     952 </span>            : static void wm_handler_destroy(GF_Node *node, void *rs, Bool is_destroy)
<span class="lineNum">     953 </span>            : {
<span class="lineNum">     954 </span>            :         if (is_destroy) {
<span class="lineNum">     955 </span>            :                 SVG_handlerElement *handler = (SVG_handlerElement *)node;
<span class="lineNum">     956 </span>            :                 if (handler-&gt;js_fun_val) {
<span class="lineNum">     957 </span>            :                         gf_js_remove_root(handler-&gt;js_context, &amp;handler-&gt;js_fun_val, GF_JSGC_VAL);
<span class="lineNum">     958 </span>            :                         handler-&gt;js_fun_val=0;
<span class="lineNum">     959 </span>            :                 }
<span class="lineNum">     960 </span>            :         }
<span class="lineNum">     961 </span>            : }
<span class="lineNum">     962 </span>            : 
<span class="lineNum">     963 </span>            : static SVG_handlerElement *wm_create_scene_listener(GF_WidgetInstance *wid, GF_WidgetPin *param)
<span class="lineNum">     964 </span>            : {
<span class="lineNum">     965 </span>            :         /*FIXME - we need to split SVG and base DOM !!*/
<span class="lineNum">     966 </span>            : #ifdef GPAC_DISABLE_SVG
<span class="lineNum">     967 </span>            :         return NULL;
<span class="lineNum">     968 </span>            : #else
<span class="lineNum">     969 </span>            :         u32 evt_type, att_name;
<span class="lineNum">     970 </span>            :         GF_Node *listener;
<span class="lineNum">     971 </span>            :         GF_FieldInfo info;
<span class="lineNum">     972 </span>            :         GF_Node *n = NULL;
<span class="lineNum">     973 </span>            :         SVG_handlerElement *handler;
<span class="lineNum">     974 </span>            : 
<span class="lineNum">     975 </span>            :         evt_type = GF_EVENT_ATTR_MODIFIED;
<span class="lineNum">     976 </span>            :         n = gf_sg_find_node_by_name(wid-&gt;scene, param-&gt;node);
<span class="lineNum">     977 </span>            :         if (!n)
<span class="lineNum">     978 </span>            :                 return NULL;
<span class="lineNum">     979 </span>            : 
<span class="lineNum">     980 </span>            :         att_name = 0;
<span class="lineNum">     981 </span>            : 
<span class="lineNum">     982 </span>            : #ifndef GPAC_DISABLE_SVG
<span class="lineNum">     983 </span>            :         if (n-&gt;sgprivate-&gt;tag &gt;= GF_NODE_FIRST_DOM_NODE_TAG) {
<span class="lineNum">     984 </span>            :                 /* first check if the set_input refers to an attribute name or to an event name */
<span class="lineNum">     985 </span>            :                 evt_type = gf_dom_event_type_by_name(param-&gt;attribute);
<span class="lineNum">     986 </span>            :                 if (evt_type == GF_EVENT_UNKNOWN) {
<span class="lineNum">     987 </span>            :                         evt_type = GF_EVENT_ATTR_MODIFIED;
<span class="lineNum">     988 </span>            : 
<span class="lineNum">     989 </span>            :                         /* modify textContent */
<span class="lineNum">     990 </span>            :                         if (!strcmp(param-&gt;attribute, &quot;textContent&quot;)) {
<span class="lineNum">     991 </span>            :                                 att_name = (u32) -1;
<span class="lineNum">     992 </span>            :                         }
<span class="lineNum">     993 </span>            :                         /* modify an attribute */
<span class="lineNum">     994 </span>            :                         else if (gf_node_get_attribute_by_name(n, param-&gt;attribute, 0, GF_TRUE, GF_FALSE, &amp;info)==GF_OK) {
<span class="lineNum">     995 </span>            :                                 att_name = info.fieldIndex;
<span class="lineNum">     996 </span>            :                         }
<span class="lineNum">     997 </span>            :                         else {
<span class="lineNum">     998 </span>            :                                 return NULL;
<span class="lineNum">     999 </span>            :                         }
<span class="lineNum">    1000 </span>            :                 }
<span class="lineNum">    1001 </span>            :         } else
<span class="lineNum">    1002 </span>            : #endif
<span class="lineNum">    1003 </span>            :         {
<span class="lineNum">    1004 </span>            :                 if (gf_node_get_field_by_name(n, param-&gt;attribute, &amp;info) != GF_OK)
<span class="lineNum">    1005 </span>            :                         return NULL;
<span class="lineNum">    1006 </span>            :                 att_name = info.fieldIndex;
<span class="lineNum">    1007 </span>            :         }
<span class="lineNum">    1008 </span>            : 
<span class="lineNum">    1009 </span>            :         listener = gf_node_new(wid-&gt;scene, TAG_SVG_listener);
<span class="lineNum">    1010 </span>            : 
<span class="lineNum">    1011 </span>            :         handler = (SVG_handlerElement *) gf_node_new(wid-&gt;scene, TAG_SVG_handler);
<span class="lineNum">    1012 </span>            :         /*we register the handler with the listener node to avoid modifying the DOM*/
<span class="lineNum">    1013 </span>            :         gf_node_register((GF_Node *)handler, listener);
<span class="lineNum">    1014 </span>            :         gf_node_list_add_child(&amp; ((GF_ParentNode *)listener)-&gt;children, (GF_Node*)handler);
<span class="lineNum">    1015 </span>            :         handler-&gt;sgprivate-&gt;UserCallback = wm_handler_destroy;
<span class="lineNum">    1016 </span>            : 
<span class="lineNum">    1017 </span>            :         /*create attributes if needed*/
<span class="lineNum">    1018 </span>            :         gf_node_get_attribute_by_tag(listener, TAG_XMLEV_ATT_event, GF_TRUE, GF_FALSE, &amp;info);
<span class="lineNum">    1019 </span>            :         ((XMLEV_Event*)info.far_ptr)-&gt;type = evt_type;
<span class="lineNum">    1020 </span>            :         ((XMLEV_Event*)info.far_ptr)-&gt;parameter = att_name;
<span class="lineNum">    1021 </span>            :         gf_node_get_attribute_by_tag(listener, TAG_XMLEV_ATT_handler, GF_TRUE, GF_FALSE, &amp;info);
<span class="lineNum">    1022 </span>            :         ((XMLRI*)info.far_ptr)-&gt;target = (GF_Node*)handler;
<span class="lineNum">    1023 </span>            :         gf_node_get_attribute_by_tag(listener, TAG_XMLEV_ATT_target, GF_TRUE, GF_FALSE, &amp;info);
<span class="lineNum">    1024 </span>            :         ((XMLRI*)info.far_ptr)-&gt;target = n;
<span class="lineNum">    1025 </span>            : 
<span class="lineNum">    1026 </span>            :         gf_node_get_attribute_by_tag((GF_Node*)handler, TAG_XMLEV_ATT_event, GF_TRUE, GF_FALSE, &amp;info);
<span class="lineNum">    1027 </span>            :         ((XMLEV_Event*)info.far_ptr)-&gt;type = evt_type;
<span class="lineNum">    1028 </span>            :         ((XMLEV_Event*)info.far_ptr)-&gt;parameter = att_name;
<span class="lineNum">    1029 </span>            : 
<span class="lineNum">    1030 </span>            :         gf_node_dom_listener_add((GF_Node *) n, listener);
<span class="lineNum">    1031 </span>            : 
<span class="lineNum">    1032 </span>            :         return handler;
<span class="lineNum">    1033 </span>            : #endif
<span class="lineNum">    1034 </span>            : }
<span class="lineNum">    1035 </span>            : 
<span class="lineNum">    1036 </span>            : static void wm_component_activation_event(GF_Node *hdl, GF_DOM_Event *evt, GF_Node *observer, Bool unload)
<span class="lineNum">    1037 </span>            : {
<span class="lineNum">    1038 </span>            :         JSObject *obj;
<span class="lineNum">    1039 </span>            :         JSContext *c;
<span class="lineNum">    1040 </span>            :         GF_WidgetInstance *wid;
<span class="lineNum">    1041 </span>            :         GF_WidgetComponent *comp;
<span class="lineNum">    1042 </span>            :         SVG_handlerElement *handler = (SVG_handlerElement *)hdl;
<span class="lineNum">    1043 </span>            : 
<span class="lineNum">    1044 </span>            :         c = (JSContext*)handler-&gt;js_context;
<span class="lineNum">    1045 </span>            :         obj = (JSObject*)handler-&gt;evt_listen_obj;
<span class="lineNum">    1046 </span>            :         if (!c || !obj) return;
<span class="lineNum">    1047 </span>            :         wid = (GF_WidgetInstance *)SMJS_GET_PRIVATE(c, obj);
<span class="lineNum">    1048 </span>            :         if (!wid) return;
<span class="lineNum">    1049 </span>            : 
<span class="lineNum">    1050 </span>            :         comp = (GF_WidgetComponent *)handler-&gt;js_fun;
<span class="lineNum">    1051 </span>            :         if (unload) {
<span class="lineNum">    1052 </span>            :                 wm_deactivate_component(c, wid, comp, NULL);
<span class="lineNum">    1053 </span>            :         } else {
<span class="lineNum">    1054 </span>            :                 wm_activate_component(c, wid, comp, GF_FALSE);
<span class="lineNum">    1055 </span>            :         }
<span class="lineNum">    1056 </span>            : }
<span class="lineNum">    1057 </span>            : static void wm_component_activate_event(GF_Node *hdl, GF_DOM_Event *evt, GF_Node *observer)
<span class="lineNum">    1058 </span>            : {
<span class="lineNum">    1059 </span>            :         wm_component_activation_event(hdl, evt, observer, GF_FALSE);
<span class="lineNum">    1060 </span>            : }
<span class="lineNum">    1061 </span>            : static void wm_component_deactivate_event(GF_Node *hdl, GF_DOM_Event *evt, GF_Node *observer)
<span class="lineNum">    1062 </span>            : {
<span class="lineNum">    1063 </span>            :         wm_component_activation_event(hdl, evt, observer, GF_TRUE);
<span class="lineNum">    1064 </span>            : }
<span class="lineNum">    1065 </span>            : 
<span class="lineNum">    1066 </span>            : static void wm_widget_set_pref_event(GF_Node *hdl, GF_DOM_Event *evt, GF_Node *observer)
<span class="lineNum">    1067 </span>            : {
<span class="lineNum">    1068 </span>            :         char *att;
<span class="lineNum">    1069 </span>            :         SVG_handlerElement *handler = (SVG_handlerElement *)hdl;
<span class="lineNum">    1070 </span>            :         GF_WidgetInstance *wid = (GF_WidgetInstance *) handler-&gt;evt_listen_obj;
<span class="lineNum">    1071 </span>            :         GF_WidgetPreference *pref = (GF_WidgetPreference *) handler-&gt;js_fun;
<span class="lineNum">    1072 </span>            : 
<span class="lineNum">    1073 </span>            :         if (evt-&gt;type != GF_EVENT_ATTR_MODIFIED) return;
<span class="lineNum">    1074 </span>            : 
<span class="lineNum">    1075 </span>            :         if (evt-&gt;detail == (u32) -1) {
<span class="lineNum">    1076 </span>            : #ifndef GPAC_DISABLE_SVG
<span class="lineNum">    1077 </span>            :                 att = gf_dom_flatten_textContent(evt-&gt;target);
<span class="lineNum">    1078 </span>            : #endif
<span class="lineNum">    1079 </span>            :         } else {
<span class="lineNum">    1080 </span>            :                 att = gf_node_dump_attribute(evt-&gt;target, evt-&gt;attr);
<span class="lineNum">    1081 </span>            :         }
<span class="lineNum">    1082 </span>            :         if (!att) return;
<span class="lineNum">    1083 </span>            :         gf_cfg_set_key(wid-&gt;widget-&gt;wm-&gt;term-&gt;user-&gt;config, (const char *)wid-&gt;secname, pref-&gt;name, att);
<span class="lineNum">    1084 </span>            :         gf_free(att);
<span class="lineNum">    1085 </span>            : }
<span class="lineNum">    1086 </span>            : 
<span class="lineNum">    1087 </span>            : static void on_widget_activated(JSContext *c, JSObject *obj)
<span class="lineNum">    1088 </span>            : {
<span class="lineNum">    1089 </span>            :         jsval funval, rval;
<span class="lineNum">    1090 </span>            :         u32 i, count;
<span class="lineNum">    1091 </span>            :         GF_XMLNode *context = NULL;
<span class="lineNum">    1092 </span>            :         GF_WidgetInstance *wid = (GF_WidgetInstance *)SMJS_GET_PRIVATE(c, obj);
<span class="lineNum">    1093 </span>            :         if (!wid || wid-&gt;activated) return;
<span class="lineNum">    1094 </span>            : 
<span class="lineNum">    1095 </span>            :         /*widget is now activated*/
<span class="lineNum">    1096 </span>            :         wid-&gt;activated = GF_TRUE;
<span class="lineNum">    1097 </span>            : 
<span class="lineNum">    1098 </span>            :         /*for all components, setup bindings on activateTrigger &amp; deactivateTrigger*/
<span class="lineNum">    1099 </span>            :         count = gf_list_count(wid-&gt;widget-&gt;main-&gt;components);
<span class="lineNum">    1100 </span>            :         for (i=0; i&lt;count; i++) {
<span class="lineNum">    1101 </span>            :                 GF_WidgetComponent *comp = (GF_WidgetComponent*)gf_list_get(wid-&gt;widget-&gt;main-&gt;components, i);
<span class="lineNum">    1102 </span>            :                 /*setup listener*/
<span class="lineNum">    1103 </span>            :                 if (comp-&gt;activateTrigger &amp;&amp; comp-&gt;activateTrigger-&gt;attribute) {
<span class="lineNum">    1104 </span>            :                         SVG_handlerElement *a_hdl = wm_create_scene_listener(wid, comp-&gt;activateTrigger);
<span class="lineNum">    1105 </span>            :                         if (!a_hdl) return;
<span class="lineNum">    1106 </span>            :                         a_hdl-&gt;evt_listen_obj = obj;
<span class="lineNum">    1107 </span>            :                         a_hdl-&gt;js_context = c;
<span class="lineNum">    1108 </span>            :                         a_hdl-&gt;js_fun = comp;
<span class="lineNum">    1109 </span>            :                         a_hdl-&gt;handle_event = wm_component_activate_event;
<span class="lineNum">    1110 </span>            :                 }
<span class="lineNum">    1111 </span>            :                 /*setup listener*/
<span class="lineNum">    1112 </span>            :                 if (comp-&gt;deactivateTrigger &amp;&amp; comp-&gt;deactivateTrigger-&gt;attribute) {
<span class="lineNum">    1113 </span>            :                         SVG_handlerElement *a_hdl = wm_create_scene_listener(wid, comp-&gt;deactivateTrigger);
<span class="lineNum">    1114 </span>            :                         if (!a_hdl) continue;
<span class="lineNum">    1115 </span>            :                         a_hdl-&gt;evt_listen_obj = obj;
<span class="lineNum">    1116 </span>            :                         a_hdl-&gt;js_context = c;
<span class="lineNum">    1117 </span>            :                         a_hdl-&gt;js_fun = comp;
<span class="lineNum">    1118 </span>            :                         a_hdl-&gt;handle_event = wm_component_deactivate_event;
<span class="lineNum">    1119 </span>            :                 }
<span class="lineNum">    1120 </span>            :         }
<span class="lineNum">    1121 </span>            : 
<span class="lineNum">    1122 </span>            :         if (wid-&gt;mpegu_context)
<span class="lineNum">    1123 </span>            :                 context = gf_xml_dom_get_root(wid-&gt;mpegu_context);
<span class="lineNum">    1124 </span>            : 
<span class="lineNum">    1125 </span>            :         /*load preferences*/
<span class="lineNum">    1126 </span>            :         count = gf_list_count(wid-&gt;widget-&gt;main-&gt;preferences);
<span class="lineNum">    1127 </span>            :         for (i=0; i&lt;count; i++) {
<span class="lineNum">    1128 </span>            :                 const char *value;
<span class="lineNum">    1129 </span>            :                 GF_WidgetPreference *pref = (GF_WidgetPreference*)gf_list_get(wid-&gt;widget-&gt;main-&gt;preferences, i);
<span class="lineNum">    1130 </span>            : 
<span class="lineNum">    1131 </span>            : 
<span class="lineNum">    1132 </span>            :                 /*get stored value for this preference*/
<span class="lineNum">    1133 </span>            :                 value = gf_cfg_get_key(wid-&gt;widget-&gt;wm-&gt;term-&gt;user-&gt;config, (const char *)wid-&gt;secname, pref-&gt;name);
<span class="lineNum">    1134 </span>            :                 /*if none found, use preference*/
<span class="lineNum">    1135 </span>            :                 if (!value) value = pref-&gt;value;
<span class="lineNum">    1136 </span>            : 
<span class="lineNum">    1137 </span>            :                 /*and overload with migrated context*/
<span class="lineNum">    1138 </span>            :                 if (context) {
<span class="lineNum">    1139 </span>            :                         GF_XMLNode *pref_node;
<span class="lineNum">    1140 </span>            :                         u32 j=0;
<span class="lineNum">    1141 </span>            :                         while ((pref_node = (GF_XMLNode*)gf_list_enum(context-&gt;content, &amp;j))) {
<span class="lineNum">    1142 </span>            :                                 const char *att;
<span class="lineNum">    1143 </span>            :                                 if (pref_node-&gt;type != GF_XML_NODE_TYPE) continue;
<span class="lineNum">    1144 </span>            :                                 if (strcmp(pref_node-&gt;name, &quot;preference&quot;)) continue;
<span class="lineNum">    1145 </span>            :                                 att = wm_xml_get_attr(pref_node, &quot;name&quot;);
<span class="lineNum">    1146 </span>            :                                 if (!att) continue;
<span class="lineNum">    1147 </span>            :                                 if (strcmp(att, pref-&gt;name)) continue;
<span class="lineNum">    1148 </span>            : 
<span class="lineNum">    1149 </span>            :                                 att = wm_xml_get_attr(pref_node, &quot;value&quot;);
<span class="lineNum">    1150 </span>            :                                 if (att) value = att;
<span class="lineNum">    1151 </span>            :                                 break;
<span class="lineNum">    1152 </span>            :                         }
<span class="lineNum">    1153 </span>            :                 }
<span class="lineNum">    1154 </span>            : 
<span class="lineNum">    1155 </span>            :                 if (pref-&gt;connectTo) {
<span class="lineNum">    1156 </span>            :                         SVG_handlerElement *hdl;
<span class="lineNum">    1157 </span>            : 
<span class="lineNum">    1158 </span>            :                         if (value)
<span class="lineNum">    1159 </span>            :                                 wm_widget_set_scene_input_value(NULL, NULL, 0, 0, 0, 0, wid, pref-&gt;connectTo, value);
<span class="lineNum">    1160 </span>            : 
<span class="lineNum">    1161 </span>            :                         /*preference is read only, do not setup listener*/
<span class="lineNum">    1162 </span>            :                         if (pref-&gt;flags &amp; GF_WM_PREF_READONLY) continue;
<span class="lineNum">    1163 </span>            :                         /*preference is migratable only, do not setup listener*/
<span class="lineNum">    1164 </span>            :                         if (!(pref-&gt;flags &amp; GF_WM_PREF_SAVE)) continue;
<span class="lineNum">    1165 </span>            : 
<span class="lineNum">    1166 </span>            :                         /*create the listener*/
<span class="lineNum">    1167 </span>            :                         hdl = wm_create_scene_listener(wid, pref-&gt;connectTo);
<span class="lineNum">    1168 </span>            :                         if (!hdl) continue;
<span class="lineNum">    1169 </span>            : 
<span class="lineNum">    1170 </span>            :                         hdl-&gt;evt_listen_obj = wid;
<span class="lineNum">    1171 </span>            :                         hdl-&gt;js_fun = pref;
<span class="lineNum">    1172 </span>            :                         hdl-&gt;handle_event = wm_widget_set_pref_event;
<span class="lineNum">    1173 </span>            : 
<span class="lineNum">    1174 </span>            :                 }
<span class="lineNum">    1175 </span>            :         }
<span class="lineNum">    1176 </span>            :         if (count &amp;&amp; wid-&gt;widget-&gt;main-&gt;restoredAction) {
<span class="lineNum">    1177 </span>            :                 wm_widget_set_scene_input_value(wid-&gt;widget-&gt;wm-&gt;ctx, wid-&gt;obj, 0, NULL, &amp;rval, 0, wid, wid-&gt;widget-&gt;main-&gt;restoredAction, NULL);
<span class="lineNum">    1178 </span>            :         }
<span class="lineNum">    1179 </span>            : 
<span class="lineNum">    1180 </span>            :         if (wid-&gt;mpegu_context) {
<span class="lineNum">    1181 </span>            :                 gf_xml_dom_del(wid-&gt;mpegu_context);
<span class="lineNum">    1182 </span>            :                 wid-&gt;mpegu_context = NULL;
<span class="lineNum">    1183 </span>            :         }
<span class="lineNum">    1184 </span>            : 
<span class="lineNum">    1185 </span>            :         gf_sg_lock_javascript(wid-&gt;widget-&gt;wm-&gt;ctx, GF_TRUE);
<span class="lineNum">    1186 </span>            :         /*refresh all interface bindings*/
<span class="lineNum">    1187 </span>            :         JS_LookupProperty(wid-&gt;widget-&gt;wm-&gt;ctx, wid-&gt;widget-&gt;wm-&gt;obj, &quot;check_bindings&quot;, &amp;funval);
<span class="lineNum">    1188 </span>            :         if (JSVAL_IS_OBJECT(funval)) {
<span class="lineNum">    1189 </span>            :                 JS_CallFunctionValue(wid-&gt;widget-&gt;wm-&gt;ctx, wid-&gt;widget-&gt;wm-&gt;obj, funval, 0, 0, &amp;rval);
<span class="lineNum">    1190 </span>            :         }
<span class="lineNum">    1191 </span>            : 
<span class="lineNum">    1192 </span>            :         /*if on_load property is assigned to this widget, call it.*/
<span class="lineNum">    1193 </span>            :         JS_LookupProperty(c, obj, &quot;on_load&quot;, &amp;funval);
<span class="lineNum">    1194 </span>            :         if (JSVAL_IS_OBJECT(funval)) {
<span class="lineNum">    1195 </span>            :                 JS_CallFunctionValue(wid-&gt;widget-&gt;wm-&gt;ctx, wid-&gt;obj, funval, 0, 0, &amp;rval);
<span class="lineNum">    1196 </span>            :         }
<span class="lineNum">    1197 </span>            :         gf_sg_lock_javascript(wid-&gt;widget-&gt;wm-&gt;ctx, GF_FALSE);
<span class="lineNum">    1198 </span>            : }
<span class="lineNum">    1199 </span>            : 
<span class="lineNum">    1200 </span>            : 
<span class="lineNum">    1201 </span>            : static void wm_widget_load_event(GF_Node *hdl, GF_DOM_Event *evt, GF_Node *observer)
<span class="lineNum">    1202 </span>            : {
<span class="lineNum">    1203 </span>            :         JSObject *obj;
<span class="lineNum">    1204 </span>            :         JSContext *c;
<span class="lineNum">    1205 </span>            :         SVG_handlerElement *handler = (SVG_handlerElement *)hdl;
<span class="lineNum">    1206 </span>            : 
<span class="lineNum">    1207 </span>            :         c = (JSContext*)handler-&gt;js_context;
<span class="lineNum">    1208 </span>            :         obj = (JSObject*)handler-&gt;evt_listen_obj;
<span class="lineNum">    1209 </span>            :         if (!c || !obj) return;
<span class="lineNum">    1210 </span>            : 
<span class="lineNum">    1211 </span>            :         on_widget_activated(c, obj);
<span class="lineNum">    1212 </span>            : }
<span class="lineNum">    1213 </span>            : 
<span class="lineNum">    1214 </span>            : 
<span class="lineNum">    1215 </span>            : static JSBool SMJS_FUNCTION(wm_widget_activate)
<span class="lineNum">    1216 </span>            : {
<span class="lineNum">    1217 </span>            : #ifndef GPAC_DISABLE_SVG
<span class="lineNum">    1218 </span>            :         SVG_handlerElement *handler;
<span class="lineNum">    1219 </span>            : #endif
<span class="lineNum">    1220 </span>            :         GF_MediaObject *mo;
<span class="lineNum">    1221 </span>            :         Bool direct_trigger = GF_FALSE;
<span class="lineNum">    1222 </span>            :         MFURL url;
<span class="lineNum">    1223 </span>            :         SFURL _url;
<span class="lineNum">    1224 </span>            :         GF_Node *inl;
<span class="lineNum">    1225 </span>            :         SMJS_OBJ
<span class="lineNum">    1226 </span>            :         SMJS_ARGS
<span class="lineNum">    1227 </span>            :         GF_WidgetInstance *wid = (GF_WidgetInstance *)SMJS_GET_PRIVATE(c, obj);
<span class="lineNum">    1228 </span>            :         if (!wid || !argc) return JS_FALSE;
<span class="lineNum">    1229 </span>            : 
<span class="lineNum">    1230 </span>            :         if (!JSVAL_IS_OBJECT(argv[0])) return JS_FALSE;
<span class="lineNum">    1231 </span>            : 
<span class="lineNum">    1232 </span>            :         inl = gf_sg_js_get_node(c, JSVAL_TO_OBJECT(argv[0]) );
<span class="lineNum">    1233 </span>            :         if (!inl) return JS_FALSE;
<span class="lineNum">    1234 </span>            : 
<span class="lineNum">    1235 </span>            :         _url.OD_ID = 0;
<span class="lineNum">    1236 </span>            :         _url.url = gf_url_concatenate(wid-&gt;widget-&gt;url, wid-&gt;widget-&gt;main-&gt;relocated_src);
<span class="lineNum">    1237 </span>            :         url.count = 1;
<span class="lineNum">    1238 </span>            :         url.vals = &amp;_url;
<span class="lineNum">    1239 </span>            :         mo = gf_mo_register(inl, &amp;url, GF_FALSE, GF_TRUE);
<span class="lineNum">    1240 </span>            :         if (mo) {
<span class="lineNum">    1241 </span>            :                 wid-&gt;scene = gf_mo_get_scenegraph(mo);
<span class="lineNum">    1242 </span>            :                 if (wid-&gt;scene &amp;&amp; gf_sg_get_root_node(wid-&gt;scene)) direct_trigger = GF_TRUE;
<span class="lineNum">    1243 </span>            :         }
<span class="lineNum">    1244 </span>            :         if (_url.url) gf_free(_url.url);
<span class="lineNum">    1245 </span>            : 
<span class="lineNum">    1246 </span>            :         wid-&gt;anchor = inl;
<span class="lineNum">    1247 </span>            : 
<span class="lineNum">    1248 </span>            :         if (direct_trigger) {
<span class="lineNum">    1249 </span>            :                 on_widget_activated(c, obj);
<span class="lineNum">    1250 </span>            :         } else {
<span class="lineNum">    1251 </span>            : #ifndef GPAC_DISABLE_SVG
<span class="lineNum">    1252 </span>            :                 handler = gf_dom_listener_build(inl, GF_EVENT_SCENE_ATTACHED, 0);
<span class="lineNum">    1253 </span>            :                 handler-&gt;handle_event = wm_widget_load_event;
<span class="lineNum">    1254 </span>            :                 handler-&gt;js_context = c;
<span class="lineNum">    1255 </span>            :                 handler-&gt;evt_listen_obj = obj;
<span class="lineNum">    1256 </span>            : #endif
<span class="lineNum">    1257 </span>            :         }
<span class="lineNum">    1258 </span>            : 
<span class="lineNum">    1259 </span>            :         return JS_TRUE;
<span class="lineNum">    1260 </span>            : }
<span class="lineNum">    1261 </span>            : 
<span class="lineNum">    1262 </span>            : 
<span class="lineNum">    1263 </span>            : static void wm_handle_dom_event(GF_Node *hdl, GF_DOM_Event *event, GF_Node *observer)
<span class="lineNum">    1264 </span>            : {
<span class="lineNum">    1265 </span>            :         GF_FieldInfo info;
<span class="lineNum">    1266 </span>            :         GF_Node *n;
<span class="lineNum">    1267 </span>            :         jsval argv[1], rval, jsfun;
<span class="lineNum">    1268 </span>            :         SVG_handlerElement *handler = (SVG_handlerElement *) hdl;
<span class="lineNum">    1269 </span>            :         GF_WidgetPin *param = (GF_WidgetPin*)handler-&gt;js_fun;
<span class="lineNum">    1270 </span>            :         GF_WidgetInstance *wid = (GF_WidgetInstance *)handler-&gt;evt_listen_obj;
<span class="lineNum">    1271 </span>            : 
<span class="lineNum">    1272 </span>            :         if (!wid-&gt;scene)
<span class="lineNum">    1273 </span>            :                 return;
<span class="lineNum">    1274 </span>            : 
<span class="lineNum">    1275 </span>            :         n = gf_sg_find_node_by_name(wid-&gt;scene, param-&gt;node);
<span class="lineNum">    1276 </span>            :         if (!n) return;
<span class="lineNum">    1277 </span>            : 
<span class="lineNum">    1278 </span>            :         /*this is a regular event output*/
<span class="lineNum">    1279 </span>            :         if (event-&gt;type != GF_EVENT_ATTR_MODIFIED) {
<span class="lineNum">    1280 </span>            :                 jsfun = (jsval) handler-&gt;js_fun_val;
<span class="lineNum">    1281 </span>            :                 if (JSVAL_IS_OBJECT(jsfun))
<span class="lineNum">    1282 </span>            :                         JS_CallFunctionValue(handler-&gt;js_context, wid-&gt;obj, (jsval) handler-&gt;js_fun_val, 0, 0, &amp;rval);
<span class="lineNum">    1283 </span>            :                 return;
<span class="lineNum">    1284 </span>            :         }
<span class="lineNum">    1285 </span>            : 
<span class="lineNum">    1286 </span>            :         /*otherwise this is a node.attr output through DOMAttributeModified*/
<span class="lineNum">    1287 </span>            :         argv[0] = JSVAL_NULL;
<span class="lineNum">    1288 </span>            : 
<span class="lineNum">    1289 </span>            : #ifndef GPAC_DISABLE_SVG
<span class="lineNum">    1290 </span>            :         if (n-&gt;sgprivate-&gt;tag &gt;= GF_NODE_FIRST_DOM_NODE_TAG) {
<span class="lineNum">    1291 </span>            :                 if (!strcmp(param-&gt;attribute, &quot;textContent&quot;)) {
<span class="lineNum">    1292 </span>            :                         char *txt = gf_dom_flatten_textContent(n);
<span class="lineNum">    1293 </span>            :                         argv[0] = STRING_TO_JSVAL( JS_NewStringCopyZ(handler-&gt;js_context, txt ? txt : &quot;&quot;) );
<span class="lineNum">    1294 </span>            :                         if (txt) gf_free(txt);
<span class="lineNum">    1295 </span>            :                 } else if (gf_node_get_attribute_by_name(n, param-&gt;attribute, 0, GF_TRUE, GF_FALSE, &amp;info)==GF_OK) {
<span class="lineNum">    1296 </span>            :                         char *attValue;
<span class="lineNum">    1297 </span>            :                         if (event-&gt;attr-&gt;fieldIndex != info.fieldIndex) return;
<span class="lineNum">    1298 </span>            : 
<span class="lineNum">    1299 </span>            :                         attValue = gf_node_dump_attribute(n, &amp;info);
<span class="lineNum">    1300 </span>            :                         argv[0] = STRING_TO_JSVAL( JS_NewStringCopyZ(handler-&gt;js_context, attValue) );
<span class="lineNum">    1301 </span>            :                         if (attValue) gf_free(attValue);
<span class="lineNum">    1302 </span>            :                 } else {
<span class="lineNum">    1303 </span>            :                         return;
<span class="lineNum">    1304 </span>            :                 }
<span class="lineNum">    1305 </span>            :         } else
<span class="lineNum">    1306 </span>            : #endif
<span class="lineNum">    1307 </span>            :         {
<span class="lineNum">    1308 </span>            :                 if (gf_node_get_field_by_name(n, param-&gt;attribute, &amp;info) != GF_OK) return;
<span class="lineNum">    1309 </span>            :                 if (event-&gt;attr-&gt;fieldIndex != info.fieldIndex) return;
<span class="lineNum">    1310 </span>            : 
<span class="lineNum">    1311 </span>            :                 switch (info.fieldType) {
<span class="lineNum">    1312 </span>            :                 case GF_SG_VRML_SFSTRING:
<span class="lineNum">    1313 </span>            :                         argv[0] = STRING_TO_JSVAL( JS_NewStringCopyZ(handler-&gt;js_context, ((SFString*)info.far_ptr)-&gt;buffer ) );
<span class="lineNum">    1314 </span>            :                         break;
<span class="lineNum">    1315 </span>            :                 case GF_SG_VRML_SFINT32:
<span class="lineNum">    1316 </span>            :                         argv[0] = INT_TO_JSVAL( *((SFInt32*)info.far_ptr) );
<span class="lineNum">    1317 </span>            :                         break;
<span class="lineNum">    1318 </span>            :                 case GF_SG_VRML_SFBOOL:
<span class="lineNum">    1319 </span>            :                         argv[0] = BOOLEAN_TO_JSVAL( *((SFBool*)info.far_ptr) );
<span class="lineNum">    1320 </span>            :                         break;
<span class="lineNum">    1321 </span>            :                 case GF_SG_VRML_SFFLOAT:
<span class="lineNum">    1322 </span>            :                         argv[0] = DOUBLE_TO_JSVAL( JS_NewDouble(handler-&gt;js_context, FIX2FLT( *((SFFloat*)info.far_ptr) ) ) );
<span class="lineNum">    1323 </span>            :                         break;
<span class="lineNum">    1324 </span>            :                 case GF_SG_VRML_SFTIME:
<span class="lineNum">    1325 </span>            :                         argv[0] = DOUBLE_TO_JSVAL( JS_NewDouble(handler-&gt;js_context, *((SFTime *)info.far_ptr) ) );
<span class="lineNum">    1326 </span>            :                         break;
<span class="lineNum">    1327 </span>            :                 }
<span class="lineNum">    1328 </span>            :         }
<span class="lineNum">    1329 </span>            : 
<span class="lineNum">    1330 </span>            :         jsfun = (jsval) handler-&gt;js_fun_val;
<span class="lineNum">    1331 </span>            :         if (JSVAL_IS_OBJECT(jsfun))
<span class="lineNum">    1332 </span>            :                 JS_CallFunctionValue(handler-&gt;js_context, wid-&gt;obj, (jsval) handler-&gt;js_fun_val, 1, argv, &amp;rval);
<span class="lineNum">    1333 </span>            : }
<span class="lineNum">    1334 </span>            : 
<span class="lineNum">    1335 </span>            : static JSBool SMJS_FUNCTION(wm_widget_get_param_value)
<span class="lineNum">    1336 </span>            : {
<span class="lineNum">    1337 </span>            :         GF_Node *n;
<span class="lineNum">    1338 </span>            :         GF_FieldInfo info;
<span class="lineNum">    1339 </span>            :         GF_WidgetPin *param;
<span class="lineNum">    1340 </span>            :         SMJS_OBJ
<span class="lineNum">    1341 </span>            :         SMJS_ARGS
<span class="lineNum">    1342 </span>            :         GF_WidgetInstance *wid = (GF_WidgetInstance *)SMJS_GET_PRIVATE(c, obj);
<span class="lineNum">    1343 </span>            :         if (!wid || !wid-&gt;scene || !argc || !JSVAL_IS_OBJECT(argv[0]) ) return JS_FALSE;
<span class="lineNum">    1344 </span>            : 
<span class="lineNum">    1345 </span>            :         param = SMJS_GET_PRIVATE(c, JSVAL_TO_OBJECT(argv[0]) );
<span class="lineNum">    1346 </span>            :         if (!param) return JS_FALSE;
<span class="lineNum">    1347 </span>            : 
<span class="lineNum">    1348 </span>            :         if (!param-&gt;node) {
<span class="lineNum">    1349 </span>            :                 if (param-&gt;default_value) {
<span class="lineNum">    1350 </span>            :                         SMJS_SET_RVAL( STRING_TO_JSVAL( JS_NewStringCopyZ(c, param-&gt;default_value) ) );
<span class="lineNum">    1351 </span>            :                         return JS_TRUE;
<span class="lineNum">    1352 </span>            :                 }
<span class="lineNum">    1353 </span>            :                 return JS_FALSE;
<span class="lineNum">    1354 </span>            :         }
<span class="lineNum">    1355 </span>            : 
<span class="lineNum">    1356 </span>            :         n = gf_sg_find_node_by_name(wid-&gt;scene, param-&gt;node);
<span class="lineNum">    1357 </span>            :         if (!n) return JS_FALSE;
<span class="lineNum">    1358 </span>            : 
<span class="lineNum">    1359 </span>            : #ifndef GPAC_DISABLE_SVG
<span class="lineNum">    1360 </span>            :         if (n-&gt;sgprivate-&gt;tag &gt;= GF_NODE_FIRST_DOM_NODE_TAG) {
<span class="lineNum">    1361 </span>            :                 if (!strcmp(param-&gt;attribute, &quot;textContent&quot;)) {
<span class="lineNum">    1362 </span>            :                         char *txt = gf_dom_flatten_textContent(n);
<span class="lineNum">    1363 </span>            :                         SMJS_SET_RVAL( STRING_TO_JSVAL( JS_NewStringCopyZ(c, txt ? txt : &quot;&quot;) ));
<span class="lineNum">    1364 </span>            :                         if (txt) gf_free(txt);
<span class="lineNum">    1365 </span>            :                 } else if (gf_node_get_attribute_by_name(n, param-&gt;attribute, 0, GF_TRUE, GF_FALSE, &amp;info)==GF_OK) {
<span class="lineNum">    1366 </span>            :                         char *attValue = gf_node_dump_attribute(n, &amp;info);
<span class="lineNum">    1367 </span>            :                         SMJS_SET_RVAL( STRING_TO_JSVAL( JS_NewStringCopyZ(c, attValue) ));
<span class="lineNum">    1368 </span>            :                         if (attValue) gf_free(attValue);
<span class="lineNum">    1369 </span>            :                 } else {
<span class="lineNum">    1370 </span>            :                         return JS_FALSE;
<span class="lineNum">    1371 </span>            :                 }
<span class="lineNum">    1372 </span>            :         } else
<span class="lineNum">    1373 </span>            : #endif
<span class="lineNum">    1374 </span>            :         {
<span class="lineNum">    1375 </span>            :                 if (gf_node_get_field_by_name(n, param-&gt;attribute, &amp;info) != GF_OK) return JS_FALSE;
<span class="lineNum">    1376 </span>            : 
<span class="lineNum">    1377 </span>            :                 switch (info.fieldType) {
<span class="lineNum">    1378 </span>            :                 case GF_SG_VRML_SFSTRING:
<span class="lineNum">    1379 </span>            :                         SMJS_SET_RVAL( STRING_TO_JSVAL( JS_NewStringCopyZ(c, ((SFString*)info.far_ptr)-&gt;buffer ) ) );
<span class="lineNum">    1380 </span>            :                         break;
<span class="lineNum">    1381 </span>            :                 case GF_SG_VRML_SFINT32:
<span class="lineNum">    1382 </span>            :                         SMJS_SET_RVAL( INT_TO_JSVAL( *((SFInt32*)info.far_ptr) ));
<span class="lineNum">    1383 </span>            :                         break;
<span class="lineNum">    1384 </span>            :                 case GF_SG_VRML_SFBOOL:
<span class="lineNum">    1385 </span>            :                         SMJS_SET_RVAL(BOOLEAN_TO_JSVAL( *((SFBool*)info.far_ptr) ));
<span class="lineNum">    1386 </span>            :                         break;
<span class="lineNum">    1387 </span>            :                 case GF_SG_VRML_SFFLOAT:
<span class="lineNum">    1388 </span>            :                         SMJS_SET_RVAL( DOUBLE_TO_JSVAL( JS_NewDouble(c, FIX2FLT( *((SFFloat*)info.far_ptr) ) ) ));
<span class="lineNum">    1389 </span>            :                         break;
<span class="lineNum">    1390 </span>            :                 case GF_SG_VRML_SFTIME:
<span class="lineNum">    1391 </span>            :                         SMJS_SET_RVAL( DOUBLE_TO_JSVAL( JS_NewDouble(c, *((SFTime *)info.far_ptr) ) ));
<span class="lineNum">    1392 </span>            :                         break;
<span class="lineNum">    1393 </span>            :                 }
<span class="lineNum">    1394 </span>            :         }
<span class="lineNum">    1395 </span>            : 
<span class="lineNum">    1396 </span>            :         return JS_TRUE;
<span class="lineNum">    1397 </span>            : }
<span class="lineNum">    1398 </span>            : 
<span class="lineNum">    1399 </span>            : static JSBool SMJS_FUNCTION(wm_widget_get_message_param)
<span class="lineNum">    1400 </span>            : {
<span class="lineNum">    1401 </span>            :         GF_WidgetPin *par = NULL;
<span class="lineNum">    1402 </span>            :         SMJS_OBJ
<span class="lineNum">    1403 </span>            :         SMJS_ARGS
<span class="lineNum">    1404 </span>            :         GF_WidgetMessage *msg = (GF_WidgetMessage *)SMJS_GET_PRIVATE(c, obj);
<span class="lineNum">    1405 </span>            :         if (!msg || !argc  ) return JS_FALSE;
<span class="lineNum">    1406 </span>            : 
<span class="lineNum">    1407 </span>            :         if (JSVAL_IS_INT(argv[0])) {
<span class="lineNum">    1408 </span>            :                 u32 idx = JSVAL_TO_INT(argv[0]);
<span class="lineNum">    1409 </span>            :                 par = gf_list_get(msg-&gt;params, idx);
<span class="lineNum">    1410 </span>            :         } else if (JSVAL_IS_STRING(argv[0])) {
<span class="lineNum">    1411 </span>            :                 u32 i, count = gf_list_count(msg-&gt;params);
<span class="lineNum">    1412 </span>            :                 char *name =  SMJS_CHARS(c, argv[0]);
<span class="lineNum">    1413 </span>            :                 for (i=0; i&lt;count; i++) {
<span class="lineNum">    1414 </span>            :                         par = gf_list_get(msg-&gt;params, i);
<span class="lineNum">    1415 </span>            :                         if (!strcmp(par-&gt;name, name)) break;
<span class="lineNum">    1416 </span>            :                         par = NULL;
<span class="lineNum">    1417 </span>            :                 }
<span class="lineNum">    1418 </span>            :                 SMJS_FREE(c, name);
<span class="lineNum">    1419 </span>            :         }
<span class="lineNum">    1420 </span>            : 
<span class="lineNum">    1421 </span>            :         if (par) {
<span class="lineNum">    1422 </span>            :                 JSObject *obj = JS_NewObject(c, &amp;msg-&gt;ifce-&gt;content-&gt;widget-&gt;wm-&gt;widgetAnyClass._class, 0, 0);
<span class="lineNum">    1423 </span>            :                 SMJS_SET_PRIVATE(c, obj, par);
<span class="lineNum">    1424 </span>            :                 JS_DefineProperty(c, obj, &quot;name&quot;, STRING_TO_JSVAL( JS_NewStringCopyZ(c, par-&gt;name) ), 0, 0, JSPROP_READONLY | JSPROP_PERMANENT);
<span class="lineNum">    1425 </span>            :                 JS_DefineProperty(c, obj, &quot;is_input&quot;, BOOLEAN_TO_JSVAL( (par-&gt;type == GF_WM_PARAM_OUTPUT) ? JS_FALSE : JS_TRUE), 0, 0, JSPROP_READONLY | JSPROP_PERMANENT);
<span class="lineNum">    1426 </span>            :                 switch (par-&gt;script_type) {
<span class="lineNum">    1427 </span>            :                 case GF_WM_PARAM_SCRIPT_BOOL:
<span class="lineNum">    1428 </span>            :                         JS_DefineProperty(c, obj, &quot;script_type&quot;, STRING_TO_JSVAL( JS_NewStringCopyZ(c, &quot;boolean&quot;) ), 0, 0, JSPROP_READONLY | JSPROP_PERMANENT);
<span class="lineNum">    1429 </span>            :                         break;
<span class="lineNum">    1430 </span>            :                 case GF_WM_PARAM_SCRIPT_NUMBER:
<span class="lineNum">    1431 </span>            :                         JS_DefineProperty(c, obj, &quot;script_type&quot;, STRING_TO_JSVAL( JS_NewStringCopyZ(c, &quot;number&quot;) ), 0, 0, JSPROP_READONLY | JSPROP_PERMANENT);
<span class="lineNum">    1432 </span>            :                         break;
<span class="lineNum">    1433 </span>            :                 case GF_WM_PARAM_SCRIPT_STRING:
<span class="lineNum">    1434 </span>            :                 default:
<span class="lineNum">    1435 </span>            :                         JS_DefineProperty(c, obj, &quot;script_type&quot;, STRING_TO_JSVAL( JS_NewStringCopyZ(c, &quot;string&quot;) ), 0, 0, JSPROP_READONLY | JSPROP_PERMANENT);
<span class="lineNum">    1436 </span>            :                         break;
<span class="lineNum">    1437 </span>            :                 }
<span class="lineNum">    1438 </span>            :                 SMJS_SET_RVAL( OBJECT_TO_JSVAL(obj) );
<span class="lineNum">    1439 </span>            :         }
<span class="lineNum">    1440 </span>            :         return JS_TRUE;
<span class="lineNum">    1441 </span>            : }
<span class="lineNum">    1442 </span>            : 
<span class="lineNum">    1443 </span>            : static JSBool SMJS_FUNCTION(wm_widget_get_message)
<span class="lineNum">    1444 </span>            : {
<span class="lineNum">    1445 </span>            :         GF_WidgetMessage *msg;
<span class="lineNum">    1446 </span>            :         SMJS_OBJ
<span class="lineNum">    1447 </span>            :         SMJS_ARGS
<span class="lineNum">    1448 </span>            :         GF_WidgetInterface *ifce = (GF_WidgetInterface*)SMJS_GET_PRIVATE(c, obj);
<span class="lineNum">    1449 </span>            :         if (!ifce || !argc) return JS_FALSE;
<span class="lineNum">    1450 </span>            :         msg = NULL;
<span class="lineNum">    1451 </span>            : 
<span class="lineNum">    1452 </span>            :         if (JSVAL_IS_INT(argv[0])) {
<span class="lineNum">    1453 </span>            :                 u32 idx;
<span class="lineNum">    1454 </span>            :                 idx = JSVAL_TO_INT(argv[0]);
<span class="lineNum">    1455 </span>            :                 msg = (GF_WidgetMessage*)gf_list_get(ifce-&gt;messages, idx);
<span class="lineNum">    1456 </span>            :         } else if (JSVAL_IS_STRING(argv[0])) {
<span class="lineNum">    1457 </span>            :                 u32 i, count = gf_list_count(ifce-&gt;messages);
<span class="lineNum">    1458 </span>            :                 char *name = SMJS_CHARS(c, argv[0]);
<span class="lineNum">    1459 </span>            :                 for (i=0; i&lt;count; i++) {
<span class="lineNum">    1460 </span>            :                         msg = (GF_WidgetMessage*)gf_list_get(ifce-&gt;messages, i);
<span class="lineNum">    1461 </span>            :                         if (!strcmp(msg-&gt;name, name)) break;
<span class="lineNum">    1462 </span>            :                         msg = NULL;
<span class="lineNum">    1463 </span>            :                 }
<span class="lineNum">    1464 </span>            :                 SMJS_FREE(c, name);
<span class="lineNum">    1465 </span>            :         }
<span class="lineNum">    1466 </span>            :         if (msg) {
<span class="lineNum">    1467 </span>            :                 JSObject *obj = JS_NewObject(c, &amp;ifce-&gt;content-&gt;widget-&gt;wm-&gt;widgetAnyClass._class, 0, 0);
<span class="lineNum">    1468 </span>            :                 SMJS_SET_PRIVATE(c, obj, msg);
<span class="lineNum">    1469 </span>            :                 JS_DefineProperty(c, obj, &quot;num_params&quot;, INT_TO_JSVAL( gf_list_count(msg-&gt;params) ), 0, 0, JSPROP_READONLY | JSPROP_PERMANENT);
<span class="lineNum">    1470 </span>            :                 JS_DefineProperty(c, obj, &quot;name&quot;, STRING_TO_JSVAL( JS_NewStringCopyZ(c, msg-&gt;name) ), 0, 0, JSPROP_READONLY | JSPROP_PERMANENT);
<span class="lineNum">    1471 </span>            :                 JS_DefineProperty(c, obj, &quot;is_input&quot;, BOOLEAN_TO_JSVAL( msg-&gt;is_output ? JS_FALSE : JS_TRUE ) , 0, 0, JSPROP_READONLY | JSPROP_PERMANENT);
<span class="lineNum">    1472 </span>            :                 JS_DefineProperty(c, obj, &quot;has_output_trigger&quot;, BOOLEAN_TO_JSVAL( msg-&gt;output_trigger ? JS_TRUE : JS_FALSE) , 0, 0, JSPROP_READONLY | JSPROP_PERMANENT);
<span class="lineNum">    1473 </span>            :                 JS_DefineProperty(c, obj, &quot;has_input_action&quot;, BOOLEAN_TO_JSVAL( (msg-&gt;input_action &amp;&amp; msg-&gt;input_action-&gt;attribute) ? JS_TRUE : JS_FALSE) , 0, 0, JSPROP_READONLY | JSPROP_PERMANENT);
<span class="lineNum">    1474 </span>            :                 JS_DefineProperty(c, obj, &quot;has_script_input&quot;, BOOLEAN_TO_JSVAL( (msg-&gt;input_action &amp;&amp; !msg-&gt;input_action-&gt;attribute) ? JS_TRUE : JS_FALSE) , 0, 0, JSPROP_READONLY | JSPROP_PERMANENT);
<span class="lineNum">    1475 </span>            :                 JS_DefineFunction(c, obj, &quot;get_param&quot;, wm_widget_get_message_param, 1, 0);
<span class="lineNum">    1476 </span>            : 
<span class="lineNum">    1477 </span>            :                 SMJS_SET_RVAL( OBJECT_TO_JSVAL(obj) );
<span class="lineNum">    1478 </span>            :         }
<span class="lineNum">    1479 </span>            :         return JS_TRUE;
<span class="lineNum">    1480 </span>            : }
<span class="lineNum">    1481 </span>            : 
<span class="lineNum">    1482 </span>            : static JSBool SMJS_FUNCTION(wm_widget_get_component)
<span class="lineNum">    1483 </span>            : {
<span class="lineNum">    1484 </span>            :         char *comp_id;
<span class="lineNum">    1485 </span>            :         u32 i, count;
<span class="lineNum">    1486 </span>            :         GF_WidgetComponentInstance *comp_inst;
<span class="lineNum">    1487 </span>            :         SMJS_OBJ
<span class="lineNum">    1488 </span>            :         SMJS_ARGS
<span class="lineNum">    1489 </span>            :         GF_WidgetInstance *wid = (GF_WidgetInstance *)SMJS_GET_PRIVATE(c, obj);
<span class="lineNum">    1490 </span>            :         if (!wid || !argc || !JSVAL_IS_STRING(argv[0]) ) return JS_FALSE;
<span class="lineNum">    1491 </span>            : 
<span class="lineNum">    1492 </span>            :         comp_id = SMJS_CHARS(c, argv[0]);
<span class="lineNum">    1493 </span>            :         count = gf_list_count(wid-&gt;components);
<span class="lineNum">    1494 </span>            :         for (i=0; i&lt;count; i++) {
<span class="lineNum">    1495 </span>            :                 comp_inst = (GF_WidgetComponentInstance*)gf_list_get(wid-&gt;components, i);
<span class="lineNum">    1496 </span>            :                 if (comp_inst-&gt;comp-&gt;id &amp;&amp; !strcmp(comp_inst-&gt;comp-&gt;id, comp_id)) {
<span class="lineNum">    1497 </span>            :                         SMJS_SET_RVAL( OBJECT_TO_JSVAL(comp_inst-&gt;wid-&gt;obj) );
<span class="lineNum">    1498 </span>            :                         SMJS_FREE(c, comp_id);
<span class="lineNum">    1499 </span>            :                         return JS_TRUE;
<span class="lineNum">    1500 </span>            :                 }
<span class="lineNum">    1501 </span>            :         }
<span class="lineNum">    1502 </span>            :         /*if requested load the component*/
<span class="lineNum">    1503 </span>            :         if ((argc==2) &amp;&amp; JSVAL_IS_BOOLEAN(argv[1]) &amp;&amp; (JSVAL_TO_BOOLEAN(argv[1])==JS_TRUE) ) {
<span class="lineNum">    1504 </span>            :                 count = gf_list_count(wid-&gt;widget-&gt;main-&gt;components);
<span class="lineNum">    1505 </span>            :                 for (i=0; i&lt;count; i++) {
<span class="lineNum">    1506 </span>            :                         GF_WidgetComponent *comp = (GF_WidgetComponent*)gf_list_get(wid-&gt;widget-&gt;main-&gt;components, i);
<span class="lineNum">    1507 </span>            :                         if (!comp-&gt;id  || strcmp(comp-&gt;id, comp_id)) continue;
<span class="lineNum">    1508 </span>            : 
<span class="lineNum">    1509 </span>            :                         comp_inst = wm_activate_component(c, wid, comp, GF_TRUE);
<span class="lineNum">    1510 </span>            :                         if (comp_inst) {
<span class="lineNum">    1511 </span>            :                                 SMJS_SET_RVAL( OBJECT_TO_JSVAL(comp_inst-&gt;wid-&gt;obj) );
<span class="lineNum">    1512 </span>            :                                 SMJS_FREE(c, comp_id);
<span class="lineNum">    1513 </span>            :                                 return JS_TRUE;
<span class="lineNum">    1514 </span>            :                         }
<span class="lineNum">    1515 </span>            :                         SMJS_FREE(c, comp_id);
<span class="lineNum">    1516 </span>            :                         return JS_TRUE;
<span class="lineNum">    1517 </span>            :                 }
<span class="lineNum">    1518 </span>            :         }
<span class="lineNum">    1519 </span>            : 
<span class="lineNum">    1520 </span>            :         SMJS_FREE(c, comp_id);
<span class="lineNum">    1521 </span>            :         return JS_TRUE;
<span class="lineNum">    1522 </span>            : }
<span class="lineNum">    1523 </span>            : 
<span class="lineNum">    1524 </span>            : static JSBool SMJS_FUNCTION(wm_widget_get_interface)
<span class="lineNum">    1525 </span>            : {
<span class="lineNum">    1526 </span>            :         u32 idx;
<span class="lineNum">    1527 </span>            :         GF_WidgetInterface *ifce;
<span class="lineNum">    1528 </span>            :         SMJS_OBJ
<span class="lineNum">    1529 </span>            :         SMJS_ARGS
<span class="lineNum">    1530 </span>            :         GF_WidgetInstance *wid = (GF_WidgetInstance *)SMJS_GET_PRIVATE(c, obj);
<span class="lineNum">    1531 </span>            :         if (!wid || !argc || !JSVAL_IS_INT(argv[0]) ) return JS_FALSE;
<span class="lineNum">    1532 </span>            : 
<span class="lineNum">    1533 </span>            :         idx = JSVAL_TO_INT(argv[0]);
<span class="lineNum">    1534 </span>            :         ifce = (GF_WidgetInterface*)gf_list_get(wid-&gt;widget-&gt;main-&gt;interfaces, idx);
<span class="lineNum">    1535 </span>            : 
<span class="lineNum">    1536 </span>            :         if (ifce) {
<span class="lineNum">    1537 </span>            :                 if (!ifce-&gt;obj) {
<span class="lineNum">    1538 </span>            :                         ifce-&gt;obj = JS_NewObject(c, &amp;wid-&gt;widget-&gt;wm-&gt;widgetAnyClass._class, 0, 0);
<span class="lineNum">    1539 </span>            :                         SMJS_SET_PRIVATE(c, ifce-&gt;obj, ifce);
<span class="lineNum">    1540 </span>            :                         JS_DefineProperty(c, ifce-&gt;obj, &quot;num_messages&quot;, INT_TO_JSVAL( gf_list_count(ifce-&gt;messages) ), 0, 0, JSPROP_READONLY | JSPROP_PERMANENT);
<span class="lineNum">    1541 </span>            :                         JS_DefineProperty(c, ifce-&gt;obj, &quot;type&quot;, STRING_TO_JSVAL( JS_NewStringCopyZ(c, ifce-&gt;type) ), 0, 0, JSPROP_READONLY | JSPROP_PERMANENT);
<span class="lineNum">    1542 </span>            :                         JS_DefineProperty(c, ifce-&gt;obj, &quot;serviceProvider&quot;, BOOLEAN_TO_JSVAL( ifce-&gt;provider ? JS_TRUE : JS_FALSE ), 0, 0, JSPROP_READONLY | JSPROP_PERMANENT);
<span class="lineNum">    1543 </span>            :                         JS_DefineProperty(c, ifce-&gt;obj, &quot;multipleBinding&quot;, BOOLEAN_TO_JSVAL( ifce-&gt;multiple_binding ? JS_TRUE : JS_FALSE ), 0, 0, JSPROP_READONLY | JSPROP_PERMANENT);
<span class="lineNum">    1544 </span>            :                         JS_DefineFunction(c, ifce-&gt;obj, &quot;get_message&quot;, wm_widget_get_message, 1, 0);
<span class="lineNum">    1545 </span>            :                         gf_js_add_root(c, &amp;ifce-&gt;obj, GF_JSGC_OBJECT);
<span class="lineNum">    1546 </span>            :                 }
<span class="lineNum">    1547 </span>            :                 SMJS_SET_RVAL( OBJECT_TO_JSVAL(ifce-&gt;obj) );
<span class="lineNum">    1548 </span>            :         }
<span class="lineNum">    1549 </span>            :         return JS_TRUE;
<span class="lineNum">    1550 </span>            : }
<span class="lineNum">    1551 </span>            : 
<span class="lineNum">    1552 </span>            : static JSBool SMJS_FUNCTION(wm_widget_bind_output_trigger)
<span class="lineNum">    1553 </span>            : {
<span class="lineNum">    1554 </span>            :         GF_WidgetMessage *msg;
<span class="lineNum">    1555 </span>            :         GF_WidgetPin *param;
<span class="lineNum">    1556 </span>            :         SVG_handlerElement *handler;
<span class="lineNum">    1557 </span>            :         SMJS_OBJ
<span class="lineNum">    1558 </span>            :         SMJS_ARGS
<span class="lineNum">    1559 </span>            :         GF_WidgetInstance *wid = (GF_WidgetInstance *)SMJS_GET_PRIVATE(c, obj);
<span class="lineNum">    1560 </span>            : 
<span class="lineNum">    1561 </span>            :         SMJS_SET_RVAL( BOOLEAN_TO_JSVAL(JS_FALSE) );
<span class="lineNum">    1562 </span>            :         if (!wid || !wid-&gt;scene || (argc!=3)) return JS_TRUE;
<span class="lineNum">    1563 </span>            : 
<span class="lineNum">    1564 </span>            :         if (!JSVAL_IS_OBJECT(argv[0])) return JS_TRUE;
<span class="lineNum">    1565 </span>            :         if (!JSVAL_IS_OBJECT(argv[1])) return JS_TRUE;
<span class="lineNum">    1566 </span>            :         if (!JSVAL_IS_OBJECT(argv[2])) return JS_TRUE;
<span class="lineNum">    1567 </span>            : 
<span class="lineNum">    1568 </span>            :         msg = (GF_WidgetMessage *)SMJS_GET_PRIVATE(c, JSVAL_TO_OBJECT(argv[0]));
<span class="lineNum">    1569 </span>            :         if (!msg) return JS_TRUE;
<span class="lineNum">    1570 </span>            :         param = msg-&gt;output_trigger;
<span class="lineNum">    1571 </span>            :         if (!param) return JS_TRUE;
<span class="lineNum">    1572 </span>            : 
<span class="lineNum">    1573 </span>            : 
<span class="lineNum">    1574 </span>            :         handler = wm_create_scene_listener(wid, param);
<span class="lineNum">    1575 </span>            :         if (!handler) return JS_TRUE;
<span class="lineNum">    1576 </span>            :         handler-&gt;js_fun_val = * (u64 *) &amp; argv[1];
<span class="lineNum">    1577 </span>            :         gf_js_add_root(c, &amp;handler-&gt;js_fun_val, GF_JSGC_VAL);
<span class="lineNum">    1578 </span>            :         handler-&gt;evt_listen_obj = wid;
<span class="lineNum">    1579 </span>            :         handler-&gt;js_fun = param;
<span class="lineNum">    1580 </span>            :         handler-&gt;js_context = c;
<span class="lineNum">    1581 </span>            :         handler-&gt;handle_event = wm_handle_dom_event;
<span class="lineNum">    1582 </span>            :         handler-&gt;sgprivate-&gt;UserPrivate = JSVAL_TO_OBJECT(argv[2]);
<span class="lineNum">    1583 </span>            : 
<span class="lineNum">    1584 </span>            :         gf_list_add(wid-&gt;output_triggers, handler);
<span class="lineNum">    1585 </span>            :         SMJS_SET_RVAL( BOOLEAN_TO_JSVAL(JS_TRUE) );
<span class="lineNum">    1586 </span>            : 
<span class="lineNum">    1587 </span>            :         return JS_TRUE;
<span class="lineNum">    1588 </span>            : }
<span class="lineNum">    1589 </span>            : 
<span class="lineNum">    1590 </span>            : static JSBool SMJS_FUNCTION(wm_widget_get_context)
<span class="lineNum">    1591 </span>            : {
<span class="lineNum">    1592 </span>            :         GF_BitStream *bs;
<span class="lineNum">    1593 </span>            :         u32 i, count;
<span class="lineNum">    1594 </span>            :         const char *str;
<span class="lineNum">    1595 </span>            :         char *att;
<span class="lineNum">    1596 </span>            :         SMJS_OBJ
<span class="lineNum">    1597 </span>            :         //SMJS_ARGS
<span class="lineNum">    1598 </span>            :         GF_WidgetInstance *wid = (GF_WidgetInstance *)SMJS_GET_PRIVATE(c, obj);
<span class="lineNum">    1599 </span>            :         if (!wid) return JS_FALSE;
<span class="lineNum">    1600 </span>            :         if (!wid-&gt;scene) {
<span class="lineNum">    1601 </span>            :                 SMJS_SET_RVAL(JSVAL_NULL);
<span class="lineNum">    1602 </span>            :                 return JS_TRUE;
<span class="lineNum">    1603 </span>            :         }
<span class="lineNum">    1604 </span>            : 
<span class="lineNum">    1605 </span>            :         bs = gf_bs_new(NULL, 0, GF_BITSTREAM_WRITE);
<span class="lineNum">    1606 </span>            :         str = &quot;&lt;?xml version=\&quot;1.0\&quot; encoding=\&quot;UTF-8\&quot;?&gt;\n&lt;contextInformation xmlns=\&quot;urn:mpeg:mpegu:schema:widgets:contextinfo:2010\&quot;&gt;\n&quot;;
<span class="lineNum">    1607 </span>            :         gf_bs_write_data(bs, (const char *) str, (u32) strlen(str) );
<span class="lineNum">    1608 </span>            : 
<span class="lineNum">    1609 </span>            :         count = gf_list_count(wid-&gt;widget-&gt;main-&gt;preferences);
<span class="lineNum">    1610 </span>            :         for (i=0; i&lt;count; i++) {
<span class="lineNum">    1611 </span>            :                 GF_WidgetPreference *pref = (GF_WidgetPreference*)gf_list_get(wid-&gt;widget-&gt;main-&gt;preferences, i);
<span class="lineNum">    1612 </span>            : 
<span class="lineNum">    1613 </span>            :                 /*preference is read only, do not include in context*/
<span class="lineNum">    1614 </span>            :                 if (pref-&gt;flags &amp; GF_WM_PREF_READONLY) continue;
<span class="lineNum">    1615 </span>            :                 /*preference is not migratable, do not include in context*/
<span class="lineNum">    1616 </span>            :                 if (!(pref-&gt;flags &amp; GF_WM_PREF_MIGRATE)) continue;
<span class="lineNum">    1617 </span>            : 
<span class="lineNum">    1618 </span>            :                 str = &quot; &lt;preference name=\&quot;&quot;;
<span class="lineNum">    1619 </span>            :                 gf_bs_write_data(bs, (const char *) str, (u32) strlen(str) );
<span class="lineNum">    1620 </span>            : 
<span class="lineNum">    1621 </span>            :                 gf_bs_write_data(bs, (const char *) pref-&gt;name, (u32) strlen(pref-&gt;name) );
<span class="lineNum">    1622 </span>            : 
<span class="lineNum">    1623 </span>            :                 str = &quot;\&quot; value=\&quot;&quot;;
<span class="lineNum">    1624 </span>            :                 gf_bs_write_data(bs, (const char *) str, (u32) strlen(str) );
<span class="lineNum">    1625 </span>            : 
<span class="lineNum">    1626 </span>            :                 /*read from node*/
<span class="lineNum">    1627 </span>            :                 if (pref-&gt;connectTo &amp;&amp; pref-&gt;connectTo-&gt;attribute) {
<span class="lineNum">    1628 </span>            :                         GF_FieldInfo info;
<span class="lineNum">    1629 </span>            :                         GF_Node *n = gf_sg_find_node_by_name(wid-&gt;scene, pref-&gt;connectTo-&gt;node);
<span class="lineNum">    1630 </span>            :                         if (n) {
<span class="lineNum">    1631 </span>            : 
<span class="lineNum">    1632 </span>            : #ifndef GPAC_DISABLE_SVG
<span class="lineNum">    1633 </span>            :                                 if ((n-&gt;sgprivate-&gt;tag &gt;= GF_NODE_FIRST_DOM_NODE_TAG) &amp;&amp; !strcmp(pref-&gt;connectTo-&gt;attribute, &quot;textContent&quot;)) {
<span class="lineNum">    1634 </span>            :                                         char *txt = gf_dom_flatten_textContent(n);
<span class="lineNum">    1635 </span>            :                                         gf_bs_write_data(bs, (const char *) txt, (u32) strlen(txt) );
<span class="lineNum">    1636 </span>            :                                 } else
<span class="lineNum">    1637 </span>            : #endif
<span class="lineNum">    1638 </span>            :                                         if (gf_node_get_field_by_name(n, pref-&gt;connectTo-&gt;attribute, &amp;info)==GF_OK) {
<span class="lineNum">    1639 </span>            :                                                 att = gf_node_dump_attribute(n, &amp;info);
<span class="lineNum">    1640 </span>            :                                                 if (att) {
<span class="lineNum">    1641 </span>            :                                                         gf_bs_write_data(bs, (const char *)  att, (u32) strlen(att) );
<span class="lineNum">    1642 </span>            :                                                         gf_free(att);
<span class="lineNum">    1643 </span>            :                                                 }
<span class="lineNum">    1644 </span>            :                                         }
<span class="lineNum">    1645 </span>            :                         }
<span class="lineNum">    1646 </span>            :                 }
<span class="lineNum">    1647 </span>            :                 /*read from config*/
<span class="lineNum">    1648 </span>            :                 else {
<span class="lineNum">    1649 </span>            :                         att = (char *)gf_cfg_get_key(wid-&gt;widget-&gt;wm-&gt;term-&gt;user-&gt;config, (const char *) wid-&gt;secname, pref-&gt;name);
<span class="lineNum">    1650 </span>            :                         if (!att) att = pref-&gt;value;
<span class="lineNum">    1651 </span>            : 
<span class="lineNum">    1652 </span>            :                         if (att) gf_bs_write_data(bs, (const char *) att, (u32) strlen(att) );
<span class="lineNum">    1653 </span>            :                 }
<span class="lineNum">    1654 </span>            : 
<span class="lineNum">    1655 </span>            :                 str = &quot;\&quot;/&gt;\n&quot;;
<span class="lineNum">    1656 </span>            :                 gf_bs_write_data(bs, (const char *)  str, (u32) strlen(str) );
<span class="lineNum">    1657 </span>            :         }
<span class="lineNum">    1658 </span>            :         str = &quot;&lt;/contextInformation&gt;\n&quot;;
<span class="lineNum">    1659 </span>            :         gf_bs_write_data(bs, (const char *)  str, (u32) strlen(str) );
<span class="lineNum">    1660 </span>            : 
<span class="lineNum">    1661 </span>            :         gf_bs_write_u8(bs, 0);
<span class="lineNum">    1662 </span>            :         att = NULL;
<span class="lineNum">    1663 </span>            :         gf_bs_get_content(bs, &amp;att, &amp;count);
<span class="lineNum">    1664 </span>            :         gf_bs_del(bs);
<span class="lineNum">    1665 </span>            : 
<span class="lineNum">    1666 </span>            :         SMJS_SET_RVAL( STRING_TO_JSVAL( JS_NewStringCopyZ(c, att) ) );
<span class="lineNum">    1667 </span>            :         gf_free(att);
<span class="lineNum">    1668 </span>            : 
<span class="lineNum">    1669 </span>            :         return JS_TRUE;
<span class="lineNum">    1670 </span>            : }
<span class="lineNum">    1671 </span>            : 
<span class="lineNum">    1672 </span>            : 
<span class="lineNum">    1673 </span>            : static SMJS_FUNC_PROP_GET( wm_widget_getProperty)
<span class="lineNum">    1674 </span>            : 
<span class="lineNum">    1675 </span>            : JSString *s;
<span class="lineNum">    1676 </span>            : char *prop_name;
<span class="lineNum">    1677 </span>            : const char *opt;
<span class="lineNum">    1678 </span>            : GF_WidgetInstance *wid = (GF_WidgetInstance *)SMJS_GET_PRIVATE(c, obj);
<span class="lineNum">    1679 </span>            : if (!wid) return JS_FALSE;
<span class="lineNum">    1680 </span>            : 
<span class="lineNum">    1681 </span>            : if (!SMJS_ID_IS_STRING(id)) return JS_TRUE;
<span class="lineNum">    1682 </span>            : prop_name = SMJS_CHARS_FROM_STRING(c, SMJS_ID_TO_STRING(id));
<span class="lineNum">    1683 </span>            : if (!prop_name) return JS_FALSE;
<span class="lineNum">    1684 </span>            : 
<span class="lineNum">    1685 </span>            : /*
<span class="lineNum">    1686 </span>            :                 Manifest properties
<span class="lineNum">    1687 </span>            : */
<span class="lineNum">    1688 </span>            : if (!strcmp(prop_name, &quot;manifest&quot;)) {
<span class="lineNum">    1689 </span>            :         s = JS_NewStringCopyZ(c, wid-&gt;widget-&gt;manifest_path);
<span class="lineNum">    1690 </span>            :         *vp = STRING_TO_JSVAL(s);
<span class="lineNum">    1691 </span>            : }
<span class="lineNum">    1692 </span>            : else if (!strcmp(prop_name, &quot;url&quot;)) {
<span class="lineNum">    1693 </span>            :         s = JS_NewStringCopyZ(c, wid-&gt;widget-&gt;local_path ? wid-&gt;widget-&gt;local_path : wid-&gt;widget-&gt;url);
<span class="lineNum">    1694 </span>            :         *vp = STRING_TO_JSVAL(s);
<span class="lineNum">    1695 </span>            : }
<span class="lineNum">    1696 </span>            : else if (!strcmp(prop_name, &quot;main&quot;)) {
<span class="lineNum">    1697 </span>            :         s = JS_NewStringCopyZ(c, wid-&gt;widget-&gt;main-&gt;relocated_src);
<span class="lineNum">    1698 </span>            :         *vp = STRING_TO_JSVAL(s);
<span class="lineNum">    1699 </span>            : }
<span class="lineNum">    1700 </span>            : else if (!strcmp(prop_name, &quot;localizedSrc&quot;)) {
<span class="lineNum">    1701 </span>            :         s = JS_NewStringCopyZ(c, wid-&gt;widget-&gt;main-&gt;src);
<span class="lineNum">    1702 </span>            :         *vp = STRING_TO_JSVAL(s);
<span class="lineNum">    1703 </span>            : }
<span class="lineNum">    1704 </span>            : else if (!strcmp(prop_name, &quot;mainEncoding&quot;)) {
<span class="lineNum">    1705 </span>            :         s = JS_NewStringCopyZ(c, wid-&gt;widget-&gt;main-&gt;encoding);
<span class="lineNum">    1706 </span>            :         *vp = STRING_TO_JSVAL(s);
<span class="lineNum">    1707 </span>            : }
<span class="lineNum">    1708 </span>            : else if (!strcmp(prop_name, &quot;mainMimeType&quot;)) {
<span class="lineNum">    1709 </span>            :         s = JS_NewStringCopyZ(c, wid-&gt;widget-&gt;main-&gt;mimetype);
<span class="lineNum">    1710 </span>            :         *vp = STRING_TO_JSVAL(s);
<span class="lineNum">    1711 </span>            : }
<span class="lineNum">    1712 </span>            : else if (!strcmp(prop_name, &quot;defaultWidth&quot;)) {
<span class="lineNum">    1713 </span>            :         *vp = INT_TO_JSVAL(wid-&gt;widget-&gt;width);
<span class="lineNum">    1714 </span>            : }
<span class="lineNum">    1715 </span>            : else if (!strcmp(prop_name, &quot;defaultHeight&quot;)) {
<span class="lineNum">    1716 </span>            :         *vp = INT_TO_JSVAL(wid-&gt;widget-&gt;height);
<span class="lineNum">    1717 </span>            : }
<span class="lineNum">    1718 </span>            : else if (!strcmp(prop_name, &quot;icons&quot;)) {
<span class="lineNum">    1719 </span>            :         u32 i, count;
<span class="lineNum">    1720 </span>            :         JSObject *arr;
<span class="lineNum">    1721 </span>            :         count = gf_list_count(wid-&gt;widget-&gt;icons);
<span class="lineNum">    1722 </span>            :         arr = JS_NewArrayObject(c, count, NULL);
<span class="lineNum">    1723 </span>            :         for (i = 0; i&lt;count; i++) {
<span class="lineNum">    1724 </span>            :                 GF_WidgetContent *icon = (GF_WidgetContent*)gf_list_get(wid-&gt;widget-&gt;icons, i);
<span class="lineNum">    1725 </span>            :                 if (icon) {
<span class="lineNum">    1726 </span>            :                         char *abs_reloc_url;
<span class="lineNum">    1727 </span>            :                         jsval icon_obj_val;
<span class="lineNum">    1728 </span>            :                         JSObject *icon_obj = JS_NewObject(c, &amp;wid-&gt;widget-&gt;wm-&gt;widgetAnyClass._class, 0, 0);
<span class="lineNum">    1729 </span>            :                         SMJS_SET_PRIVATE(c, icon_obj, icon);
<span class="lineNum">    1730 </span>            :                         JS_DefineProperty(c, icon_obj, &quot;src&quot;, STRING_TO_JSVAL( JS_NewStringCopyZ(c, icon-&gt;src) ), 0, 0, JSPROP_READONLY | JSPROP_PERMANENT);
<span class="lineNum">    1731 </span>            :                         if (strlen(icon-&gt;relocated_src)) abs_reloc_url = gf_url_concatenate(wid-&gt;widget-&gt;url, icon-&gt;relocated_src);
<span class="lineNum">    1732 </span>            :                         else abs_reloc_url = gf_strdup(&quot;&quot;);
<span class="lineNum">    1733 </span>            :                         JS_DefineProperty(c, icon_obj, &quot;relocated_src&quot;, STRING_TO_JSVAL( JS_NewStringCopyZ(c, abs_reloc_url) ), 0, 0, JSPROP_READONLY | JSPROP_PERMANENT);
<span class="lineNum">    1734 </span>            :                         JS_DefineProperty(c, icon_obj, &quot;width&quot;, INT_TO_JSVAL( icon-&gt;width ), 0, 0, JSPROP_READONLY | JSPROP_PERMANENT);
<span class="lineNum">    1735 </span>            :                         JS_DefineProperty(c, icon_obj, &quot;height&quot;, INT_TO_JSVAL( icon-&gt;height ), 0, 0, JSPROP_READONLY | JSPROP_PERMANENT);
<span class="lineNum">    1736 </span>            :                         icon_obj_val = OBJECT_TO_JSVAL(icon_obj);
<span class="lineNum">    1737 </span>            :                         JS_SetElement(c, arr, i, &amp;icon_obj_val);
<span class="lineNum">    1738 </span>            :                         gf_free(abs_reloc_url);
<span class="lineNum">    1739 </span>            :                 }
<span class="lineNum">    1740 </span>            :         }
<span class="lineNum">    1741 </span>            :         *vp = OBJECT_TO_JSVAL(arr);
<span class="lineNum">    1742 </span>            : }
<span class="lineNum">    1743 </span>            : else if (!strcmp(prop_name, &quot;preferences&quot;)) {
<span class="lineNum">    1744 </span>            :         u32 i, count;
<span class="lineNum">    1745 </span>            :         JSObject *arr;
<span class="lineNum">    1746 </span>            :         count = gf_list_count(wid-&gt;widget-&gt;main-&gt;preferences);
<span class="lineNum">    1747 </span>            :         arr = JS_NewArrayObject(c, count, NULL);
<span class="lineNum">    1748 </span>            :         for (i = 0; i&lt;count; i++) {
<span class="lineNum">    1749 </span>            :                 GF_WidgetPreference *pref = (GF_WidgetPreference*)gf_list_get(wid-&gt;widget-&gt;main-&gt;preferences, i);
<span class="lineNum">    1750 </span>            :                 if (pref) {
<span class="lineNum">    1751 </span>            :                         jsval pref_obj_val;
<span class="lineNum">    1752 </span>            :                         JSObject *pref_obj = JS_NewObject(c, &amp;wid-&gt;widget-&gt;wm-&gt;widgetAnyClass._class, 0, 0);
<span class="lineNum">    1753 </span>            :                         SMJS_SET_PRIVATE(c, pref_obj, pref);
<span class="lineNum">    1754 </span>            :                         JS_DefineProperty(c, pref_obj, &quot;name&quot;, STRING_TO_JSVAL( JS_NewStringCopyZ(c, pref-&gt;name) ), 0, 0, JSPROP_READONLY | JSPROP_PERMANENT);
<span class="lineNum">    1755 </span>            :                         JS_DefineProperty(c, pref_obj, &quot;value&quot;, STRING_TO_JSVAL( JS_NewStringCopyZ(c, pref-&gt;value) ), 0, 0, JSPROP_READONLY | JSPROP_PERMANENT);
<span class="lineNum">    1756 </span>            :                         JS_DefineProperty(c, pref_obj, &quot;readonly&quot;, STRING_TO_JSVAL( JS_NewStringCopyZ(c, ((pref-&gt;flags &amp; GF_WM_PREF_READONLY)?&quot;true&quot;:&quot;false&quot;)) ), 0, 0, JSPROP_READONLY | JSPROP_PERMANENT);
<span class="lineNum">    1757 </span>            :                         pref_obj_val = OBJECT_TO_JSVAL(pref_obj);
<span class="lineNum">    1758 </span>            :                         JS_SetElement(c, arr, i, &amp;pref_obj_val);
<span class="lineNum">    1759 </span>            :                 }
<span class="lineNum">    1760 </span>            :         }
<span class="lineNum">    1761 </span>            :         *vp = OBJECT_TO_JSVAL(arr);
<span class="lineNum">    1762 </span>            : }
<span class="lineNum">    1763 </span>            : else if (!strcmp(prop_name, &quot;features&quot;)) {
<span class="lineNum">    1764 </span>            :         u32 i, count;
<span class="lineNum">    1765 </span>            :         JSObject *arr;
<span class="lineNum">    1766 </span>            :         count = gf_list_count(wid-&gt;widget-&gt;features);
<span class="lineNum">    1767 </span>            :         arr = JS_NewArrayObject(c, count, NULL);
<span class="lineNum">    1768 </span>            :         for (i = 0; i&lt;count; i++) {
<span class="lineNum">    1769 </span>            :                 GF_WidgetFeature *feat = (GF_WidgetFeature*)gf_list_get(wid-&gt;widget-&gt;features, i);
<span class="lineNum">    1770 </span>            :                 if (feat) {
<span class="lineNum">    1771 </span>            :                         jsval feat_obj_val;
<span class="lineNum">    1772 </span>            :                         JSObject *feat_obj = JS_NewObject(c, &amp;wid-&gt;widget-&gt;wm-&gt;widgetAnyClass._class, 0, 0);
<span class="lineNum">    1773 </span>            :                         SMJS_SET_PRIVATE(c, feat_obj, feat);
<span class="lineNum">    1774 </span>            :                         JS_DefineProperty(c, feat_obj, &quot;name&quot;, STRING_TO_JSVAL( JS_NewStringCopyZ(c, feat-&gt;name) ), 0, 0, JSPROP_READONLY | JSPROP_PERMANENT);
<span class="lineNum">    1775 </span>            :                         JS_DefineProperty(c, feat_obj, &quot;required&quot;, BOOLEAN_TO_JSVAL( (feat-&gt;required? JS_TRUE : JS_FALSE) ), 0, 0, JSPROP_READONLY | JSPROP_PERMANENT);
<span class="lineNum">    1776 </span>            :                         {
<span class="lineNum">    1777 </span>            :                                 u32 j, pcount;
<span class="lineNum">    1778 </span>            :                                 JSObject *params_arr;
<span class="lineNum">    1779 </span>            :                                 pcount = gf_list_count(feat-&gt;params);
<span class="lineNum">    1780 </span>            :                                 params_arr = JS_NewArrayObject(c, pcount, NULL);
<span class="lineNum">    1781 </span>            :                                 for (j=0; j &lt; pcount; j++) {
<span class="lineNum">    1782 </span>            :                                         GF_WidgetFeatureParam *param = (GF_WidgetFeatureParam*)gf_list_get(feat-&gt;params, j);
<span class="lineNum">    1783 </span>            :                                         JSObject *param_obj = JS_NewObject(c, &amp;wid-&gt;widget-&gt;wm-&gt;widgetAnyClass._class, 0, 0);
<span class="lineNum">    1784 </span>            :                                         jsval param_obj_val;
<span class="lineNum">    1785 </span>            :                                         SMJS_SET_PRIVATE(c, param_obj, param);
<span class="lineNum">    1786 </span>            :                                         JS_DefineProperty(c, param_obj, &quot;name&quot;, STRING_TO_JSVAL( JS_NewStringCopyZ(c, param-&gt;name) ), 0, 0, JSPROP_READONLY | JSPROP_PERMANENT);
<span class="lineNum">    1787 </span>            :                                         JS_DefineProperty(c, param_obj, &quot;value&quot;, STRING_TO_JSVAL( JS_NewStringCopyZ(c, param-&gt;value) ), 0, 0, JSPROP_READONLY | JSPROP_PERMANENT);
<span class="lineNum">    1788 </span>            :                                         param_obj_val = OBJECT_TO_JSVAL(param_obj);
<span class="lineNum">    1789 </span>            :                                         JS_SetElement(c, params_arr, j, &amp;param_obj_val);
<span class="lineNum">    1790 </span>            :                                 }
<span class="lineNum">    1791 </span>            :                                 JS_DefineProperty(c, feat_obj, &quot;params&quot;, OBJECT_TO_JSVAL(params_arr), 0, 0, JSPROP_READONLY | JSPROP_PERMANENT);
<span class="lineNum">    1792 </span>            :                         }
<span class="lineNum">    1793 </span>            :                         feat_obj_val = OBJECT_TO_JSVAL(feat_obj);
<span class="lineNum">    1794 </span>            :                         JS_SetElement(c, arr, i, &amp;feat_obj_val);
<span class="lineNum">    1795 </span>            :                 }
<span class="lineNum">    1796 </span>            :         }
<span class="lineNum">    1797 </span>            :         *vp = OBJECT_TO_JSVAL(arr);
<span class="lineNum">    1798 </span>            : }
<span class="lineNum">    1799 </span>            : 
<span class="lineNum">    1800 </span>            : else if (!strcmp(prop_name, &quot;components&quot;)) {
<span class="lineNum">    1801 </span>            :         u32 i, count;
<span class="lineNum">    1802 </span>            :         jsval val;
<span class="lineNum">    1803 </span>            :         JSObject *arr;
<span class="lineNum">    1804 </span>            :         count = gf_list_count(wid-&gt;components);
<span class="lineNum">    1805 </span>            :         arr = JS_NewArrayObject(c, count, NULL);
<span class="lineNum">    1806 </span>            :         for (i = 0; i&lt;count; i++) {
<span class="lineNum">    1807 </span>            :                 GF_WidgetComponentInstance *comp = (GF_WidgetComponentInstance*)gf_list_get(wid-&gt;components, i);
<span class="lineNum">    1808 </span>            :                 val = OBJECT_TO_JSVAL(comp-&gt;wid-&gt;obj);
<span class="lineNum">    1809 </span>            :                 JS_SetElement(c, arr, i, &amp;val);
<span class="lineNum">    1810 </span>            :         }
<span class="lineNum">    1811 </span>            :         *vp = OBJECT_TO_JSVAL(arr);
<span class="lineNum">    1812 </span>            : }
<span class="lineNum">    1813 </span>            : else if (!strcmp(prop_name, &quot;identifier&quot;)) {
<span class="lineNum">    1814 </span>            :         s = JS_NewStringCopyZ(c, wid-&gt;widget-&gt;identifier);
<span class="lineNum">    1815 </span>            :         *vp = STRING_TO_JSVAL(s);
<span class="lineNum">    1816 </span>            : }
<span class="lineNum">    1817 </span>            : else if (!strcmp(prop_name, &quot;name&quot;)) {
<span class="lineNum">    1818 </span>            :         s = JS_NewStringCopyZ(c, wid-&gt;widget-&gt;name);
<span class="lineNum">    1819 </span>            :         *vp = STRING_TO_JSVAL(s);
<span class="lineNum">    1820 </span>            : }
<span class="lineNum">    1821 </span>            : else if (!strcmp(prop_name, &quot;shortName&quot;)) {
<span class="lineNum">    1822 </span>            :         s = JS_NewStringCopyZ(c, wid-&gt;widget-&gt;shortname);
<span class="lineNum">    1823 </span>            :         *vp = STRING_TO_JSVAL(s);
<span class="lineNum">    1824 </span>            : }
<span class="lineNum">    1825 </span>            : else if (!strcmp(prop_name, &quot;authorName&quot;)) {
<span class="lineNum">    1826 </span>            :         s = JS_NewStringCopyZ(c, wid-&gt;widget-&gt;authorName);
<span class="lineNum">    1827 </span>            :         *vp = STRING_TO_JSVAL(s);
<span class="lineNum">    1828 </span>            : }
<span class="lineNum">    1829 </span>            : else if (!strcmp(prop_name, &quot;authorEmail&quot;)) {
<span class="lineNum">    1830 </span>            :         s = JS_NewStringCopyZ(c, wid-&gt;widget-&gt;authorEmail);
<span class="lineNum">    1831 </span>            :         *vp = STRING_TO_JSVAL(s);
<span class="lineNum">    1832 </span>            : }
<span class="lineNum">    1833 </span>            : else if (!strcmp(prop_name, &quot;authorHref&quot;)) {
<span class="lineNum">    1834 </span>            :         s = JS_NewStringCopyZ(c, wid-&gt;widget-&gt;authorHref);
<span class="lineNum">    1835 </span>            :         *vp = STRING_TO_JSVAL(s);
<span class="lineNum">    1836 </span>            : }
<span class="lineNum">    1837 </span>            : else if (!strcmp(prop_name, &quot;description&quot;)) {
<span class="lineNum">    1838 </span>            :         s = JS_NewStringCopyZ(c, wid-&gt;widget-&gt;description);
<span class="lineNum">    1839 </span>            :         *vp = STRING_TO_JSVAL(s);
<span class="lineNum">    1840 </span>            : }
<span class="lineNum">    1841 </span>            : else if (!strcmp(prop_name, &quot;viewmodes&quot;)) {
<span class="lineNum">    1842 </span>            :         if (wid-&gt;widget-&gt;viewmodes) s = JS_NewStringCopyZ(c, wid-&gt;widget-&gt;viewmodes);
<span class="lineNum">    1843 </span>            :         else s = JS_NewStringCopyZ(c, &quot;&quot;);
<span class="lineNum">    1844 </span>            :         *vp = STRING_TO_JSVAL(s);
<span class="lineNum">    1845 </span>            : }
<span class="lineNum">    1846 </span>            : else if (!strcmp(prop_name, &quot;license&quot;)) {
<span class="lineNum">    1847 </span>            :         s = JS_NewStringCopyZ(c, wid-&gt;widget-&gt;license);
<span class="lineNum">    1848 </span>            :         *vp = STRING_TO_JSVAL(s);
<span class="lineNum">    1849 </span>            : }
<span class="lineNum">    1850 </span>            : else if (!strcmp(prop_name, &quot;licenseHref&quot;)) {
<span class="lineNum">    1851 </span>            :         s = JS_NewStringCopyZ(c, wid-&gt;widget-&gt;licenseHref);
<span class="lineNum">    1852 </span>            :         *vp = STRING_TO_JSVAL(s);
<span class="lineNum">    1853 </span>            : }
<span class="lineNum">    1854 </span>            : else if (!strcmp(prop_name, &quot;version&quot;)) {
<span class="lineNum">    1855 </span>            :         s = JS_NewStringCopyZ(c, wid-&gt;widget-&gt;version);
<span class="lineNum">    1856 </span>            :         *vp = STRING_TO_JSVAL(s);
<span class="lineNum">    1857 </span>            : }
<span class="lineNum">    1858 </span>            : else if (!strcmp(prop_name, &quot;uuid&quot;)) {
<span class="lineNum">    1859 </span>            :         s = JS_NewStringCopyZ(c, wid-&gt;widget-&gt;uuid);
<span class="lineNum">    1860 </span>            :         *vp = STRING_TO_JSVAL(s);
<span class="lineNum">    1861 </span>            : }
<span class="lineNum">    1862 </span>            : else if (!strcmp(prop_name, &quot;discardable&quot;)) {
<span class="lineNum">    1863 </span>            :         *vp = BOOLEAN_TO_JSVAL( wid-&gt;widget-&gt;discardable ? JS_TRUE : JS_FALSE);
<span class="lineNum">    1864 </span>            : }
<span class="lineNum">    1865 </span>            : else if (!strcmp(prop_name, &quot;multipleInstances&quot;)) {
<span class="lineNum">    1866 </span>            :         *vp = BOOLEAN_TO_JSVAL( wid-&gt;widget-&gt;multipleInstance ? JS_TRUE : JS_FALSE);
<span class="lineNum">    1867 </span>            : }
<span class="lineNum">    1868 </span>            : 
<span class="lineNum">    1869 </span>            : /*
<span class="lineNum">    1870 </span>            :                 Widget Manager special properties (common to all implementations)
<span class="lineNum">    1871 </span>            : */
<span class="lineNum">    1872 </span>            : else if (!strcmp(prop_name, &quot;permanent&quot;)) {
<span class="lineNum">    1873 </span>            :         *vp = BOOLEAN_TO_JSVAL( wid-&gt;permanent ? JS_TRUE : JS_FALSE);
<span class="lineNum">    1874 </span>            : }
<span class="lineNum">    1875 </span>            : else if (!strcmp(prop_name, &quot;is_component&quot;)) {
<span class="lineNum">    1876 </span>            :         *vp = BOOLEAN_TO_JSVAL( wid-&gt;parent ? JS_TRUE : JS_FALSE);
<span class="lineNum">    1877 </span>            : }
<span class="lineNum">    1878 </span>            : else if (!strcmp(prop_name, &quot;parent&quot;)) {
<span class="lineNum">    1879 </span>            :         *vp = wid-&gt;parent ? OBJECT_TO_JSVAL(wid-&gt;parent-&gt;obj) : JSVAL_NULL;
<span class="lineNum">    1880 </span>            : }
<span class="lineNum">    1881 </span>            : else if (!strcmp(prop_name, &quot;activated&quot;)) {
<span class="lineNum">    1882 </span>            :         *vp = BOOLEAN_TO_JSVAL( wid-&gt;activated ? JS_TRUE : JS_FALSE);
<span class="lineNum">    1883 </span>            : }
<span class="lineNum">    1884 </span>            : else if (!strcmp(prop_name, &quot;section&quot;)) {
<span class="lineNum">    1885 </span>            :         s = JS_NewStringCopyZ(c, (const char *) wid-&gt;secname);
<span class="lineNum">    1886 </span>            :         *vp = STRING_TO_JSVAL(s);
<span class="lineNum">    1887 </span>            : }
<span class="lineNum">    1888 </span>            : else if (!strcmp(prop_name, &quot;num_instances&quot;)) {
<span class="lineNum">    1889 </span>            :         *vp = INT_TO_JSVAL( wid-&gt;widget-&gt;nb_instances);
<span class="lineNum">    1890 </span>            : }
<span class="lineNum">    1891 </span>            : else if (!strcmp(prop_name, &quot;num_interfaces&quot;)) {
<span class="lineNum">    1892 </span>            :         *vp = INT_TO_JSVAL( gf_list_count(wid-&gt;widget-&gt;main-&gt;interfaces));
<span class="lineNum">    1893 </span>            : }
<span class="lineNum">    1894 </span>            : else if (!strcmp(prop_name, &quot;num_components&quot;)) {
<span class="lineNum">    1895 </span>            :         *vp = INT_TO_JSVAL( gf_list_count(wid-&gt;components));
<span class="lineNum">    1896 </span>            : }
<span class="lineNum">    1897 </span>            : else if (!strcmp(prop_name, &quot;num_bound_interfaces&quot;)) {
<span class="lineNum">    1898 </span>            :         *vp = INT_TO_JSVAL( gf_list_count(wid-&gt;bound_ifces));
<span class="lineNum">    1899 </span>            : }
<span class="lineNum">    1900 </span>            : /*all variables used by the WidgetManager script but not stored*/
<span class="lineNum">    1901 </span>            : else if (!strcmp(prop_name, &quot;originating_device_ip&quot;)
<span class="lineNum">    1902 </span>            :          || !strcmp(prop_name, &quot;originating_device&quot;)
<span class="lineNum">    1903 </span>            :          || !strcmp(prop_name, &quot;device&quot;)
<span class="lineNum">    1904 </span>            :         ) {
<span class="lineNum">    1905 </span>            : }
<span class="lineNum">    1906 </span>            : /*
<span class="lineNum">    1907 </span>            :                 Widget properties, common to each implementation
<span class="lineNum">    1908 </span>            : */
<span class="lineNum">    1909 </span>            : else {
<span class="lineNum">    1910 </span>            :         char szName[1024];
<span class="lineNum">    1911 </span>            :         sprintf(szName, &quot;WM:%s&quot;, prop_name);
<span class="lineNum">    1912 </span>            :         opt = gf_cfg_get_key(wid-&gt;widget-&gt;wm-&gt;term-&gt;user-&gt;config, (const char *) wid-&gt;secname, szName);
<span class="lineNum">    1913 </span>            :         if (opt) {
<span class="lineNum">    1914 </span>            :                 Double val=0;
<span class="lineNum">    1915 </span>            :                 if (!strcmp(opt, &quot;true&quot;)) *vp = BOOLEAN_TO_JSVAL(JS_TRUE);
<span class="lineNum">    1916 </span>            :                 else if (!strcmp(opt, &quot;false&quot;)) *vp = BOOLEAN_TO_JSVAL(JS_FALSE);
<span class="lineNum">    1917 </span>            :                 else if (sscanf(opt, &quot;%lf&quot;, &amp;val)==1) {
<span class="lineNum">    1918 </span>            :                         *vp = DOUBLE_TO_JSVAL( JS_NewDouble(c, val) );
<span class="lineNum">    1919 </span>            :                 } else {
<span class="lineNum">    1920 </span>            :                         s = JS_NewStringCopyZ(c, opt);
<span class="lineNum">    1921 </span>            :                         *vp = STRING_TO_JSVAL(s);
<span class="lineNum">    1922 </span>            :                 }
<span class="lineNum">    1923 </span>            :         }
<span class="lineNum">    1924 </span>            : }
<span class="lineNum">    1925 </span>            : SMJS_FREE(c, prop_name);
<span class="lineNum">    1926 </span>            : return JS_TRUE;
<span class="lineNum">    1927 </span>            : }
<span class="lineNum">    1928 </span>            : 
<span class="lineNum">    1929 </span>            : static SMJS_FUNC_PROP_SET( wm_widget_setProperty)
<span class="lineNum">    1930 </span>            : 
<span class="lineNum">    1931 </span>            : char szVal[32];
<span class="lineNum">    1932 </span>            : jsdouble val;
<span class="lineNum">    1933 </span>            : char *prop_name;
<span class="lineNum">    1934 </span>            : GF_WidgetInstance *wid = (GF_WidgetInstance *)SMJS_GET_PRIVATE(c, obj);
<span class="lineNum">    1935 </span>            : if (!wid) return JS_FALSE;
<span class="lineNum">    1936 </span>            : 
<span class="lineNum">    1937 </span>            : if (!SMJS_ID_IS_STRING(id)) return JS_TRUE;
<span class="lineNum">    1938 </span>            : prop_name = SMJS_CHARS_FROM_STRING(c, SMJS_ID_TO_STRING(id));
<span class="lineNum">    1939 </span>            : 
<span class="lineNum">    1940 </span>            : /*internal to WidgetManager, never stored*/
<span class="lineNum">    1941 </span>            : if (!strcmp(prop_name, &quot;permanent&quot;)) {
<span class="lineNum">    1942 </span>            :         wid-&gt;permanent = (JSVAL_TO_BOOLEAN(*vp)==JS_TRUE) ? GF_TRUE : GF_FALSE;
<span class="lineNum">    1943 </span>            : }
<span class="lineNum">    1944 </span>            : 
<span class="lineNum">    1945 </span>            : /*any widget properties*/
<span class="lineNum">    1946 </span>            : else {
<span class="lineNum">    1947 </span>            :         char szName[1024], *value, *_val = NULL;
<span class="lineNum">    1948 </span>            : 
<span class="lineNum">    1949 </span>            :         if (JSVAL_IS_STRING(*vp)) {
<span class="lineNum">    1950 </span>            :                 value = _val = SMJS_CHARS(c, *vp);
<span class="lineNum">    1951 </span>            :                 if (!value) value = &quot;&quot;;
<span class="lineNum">    1952 </span>            :         }
<span class="lineNum">    1953 </span>            :         else if (JSVAL_IS_BOOLEAN(*vp)) {
<span class="lineNum">    1954 </span>            :                 strcpy(szVal, (JSVAL_TO_BOOLEAN(*vp)==JS_TRUE) ? &quot;true&quot; : &quot;false&quot;);
<span class="lineNum">    1955 </span>            :                 value = szVal;
<span class="lineNum">    1956 </span>            :         }
<span class="lineNum">    1957 </span>            :         else if (JSVAL_IS_NUMBER(*vp)) {
<span class="lineNum">    1958 </span>            :                 JS_ValueToNumber(c, *vp, &amp;val);
<span class="lineNum">    1959 </span>            :                 sprintf(szVal, &quot;%f&quot;, val);
<span class="lineNum">    1960 </span>            :                 value = szVal;
<span class="lineNum">    1961 </span>            :         } else {
<span class="lineNum">    1962 </span>            :                 SMJS_FREE(c, prop_name);
<span class="lineNum">    1963 </span>            :                 return JS_TRUE;
<span class="lineNum">    1964 </span>            :         }
<span class="lineNum">    1965 </span>            : 
<span class="lineNum">    1966 </span>            :         sprintf(szName, &quot;WM:%s&quot;, prop_name);
<span class="lineNum">    1967 </span>            :         gf_cfg_set_key(wid-&gt;widget-&gt;wm-&gt;term-&gt;user-&gt;config, (const char *) wid-&gt;secname, szName, value);
<span class="lineNum">    1968 </span>            :         SMJS_FREE(c, _val);
<span class="lineNum">    1969 </span>            : }
<span class="lineNum">    1970 </span>            : 
<span class="lineNum">    1971 </span>            : SMJS_FREE(c, prop_name);
<span class="lineNum">    1972 </span>            : return JS_TRUE;
<span class="lineNum">    1973 </span>            : }
<span class="lineNum">    1974 </span>            : 
<span class="lineNum">    1975 </span>            : 
<span class="lineNum">    1976 </span>            : 
<span class="lineNum">    1977 </span>            : static JSBool wm_widget_bind_interface_ex(JSContext *c, JSObject *obj, uintN argc, jsval *argv, jsval *rval, Bool is_unbind)
<span class="lineNum">    1978 </span>            : {
<span class="lineNum">    1979 </span>            :         u32 i, count;
<span class="lineNum">    1980 </span>            :         GF_WidgetInterfaceInstance *bifce;
<span class="lineNum">    1981 </span>            :         GF_WidgetInterface *ifce;
<span class="lineNum">    1982 </span>            :         GF_WidgetInstance *wid = (GF_WidgetInstance *)SMJS_GET_PRIVATE(c, obj);
<span class="lineNum">    1983 </span>            :         if (!wid || !wid-&gt;scene) return JS_FALSE;
<span class="lineNum">    1984 </span>            : 
<span class="lineNum">    1985 </span>            :         ifce = NULL;
<span class="lineNum">    1986 </span>            :         if (argc) {
<span class="lineNum">    1987 </span>            :                 if (!JSVAL_IS_OBJECT(argv[0])) return JS_FALSE;
<span class="lineNum">    1988 </span>            :                 ifce = SMJS_GET_PRIVATE(c, JSVAL_TO_OBJECT(argv[0]) );
<span class="lineNum">    1989 </span>            :                 if (!ifce) return JS_FALSE;
<span class="lineNum">    1990 </span>            :         }
<span class="lineNum">    1991 </span>            : 
<span class="lineNum">    1992 </span>            :         if (!is_unbind) {
<span class="lineNum">    1993 </span>            :                 char *hostname;
<span class="lineNum">    1994 </span>            :                 JSObject *cookie;
<span class="lineNum">    1995 </span>            :                 if ((argc&lt;3) || !JSVAL_IS_OBJECT(argv[1]) || !JSVAL_IS_STRING(argv[2])) return JS_FALSE;
<span class="lineNum">    1996 </span>            : 
<span class="lineNum">    1997 </span>            :                 cookie = JSVAL_TO_OBJECT(argv[1]);
<span class="lineNum">    1998 </span>            :                 hostname = SMJS_CHARS(c, argv[2]);
<span class="lineNum">    1999 </span>            :                 count = gf_list_count(wid-&gt;bound_ifces);
<span class="lineNum">    2000 </span>            :                 for (i=0; i&lt;count; i++) {
<span class="lineNum">    2001 </span>            :                         bifce = (GF_WidgetInterfaceInstance*)gf_list_get(wid-&gt;bound_ifces, i);
<span class="lineNum">    2002 </span>            :                         if (!strcmp(bifce-&gt;ifce-&gt;type, ifce-&gt;type) &amp;&amp; (bifce-&gt;cookie==cookie) ) {
<span class="lineNum">    2003 </span>            :                                 SMJS_FREE(c, hostname);
<span class="lineNum">    2004 </span>            :                                 return JS_TRUE;
<span class="lineNum">    2005 </span>            :                         }
<span class="lineNum">    2006 </span>            :                 }
<span class="lineNum">    2007 </span>            :                 GF_SAFEALLOC(bifce, GF_WidgetInterfaceInstance);
<span class="lineNum">    2008 </span>            :                 bifce-&gt;wid = wid;
<span class="lineNum">    2009 </span>            :                 bifce-&gt;ifce = ifce;
<span class="lineNum">    2010 </span>            :                 bifce-&gt;cookie = cookie;
<span class="lineNum">    2011 </span>            :                 bifce-&gt;hostname = gf_strdup(hostname);
<span class="lineNum">    2012 </span>            :                 SMJS_FREE(c, hostname);
<span class="lineNum">    2013 </span>            :                 gf_list_add(wid-&gt;bound_ifces, bifce);
<span class="lineNum">    2014 </span>            : 
<span class="lineNum">    2015 </span>            :                 if (ifce-&gt;bind_action) {
<span class="lineNum">    2016 </span>            :                         return wm_widget_set_scene_input_value(c, obj, 1, argv, rval, 2, NULL, NULL, NULL);
<span class="lineNum">    2017 </span>            :                 } else {
<span class="lineNum">    2018 </span>            :                         widget_on_interface_bind(bifce, GF_FALSE);
<span class="lineNum">    2019 </span>            :                 }
<span class="lineNum">    2020 </span>            :         } else {
<span class="lineNum">    2021 </span>            :                 JSObject *cookie = NULL;
<span class="lineNum">    2022 </span>            :                 if ((argc==2) &amp;&amp; JSVAL_IS_OBJECT(argv[1])) cookie = JSVAL_TO_OBJECT(argv[1]);
<span class="lineNum">    2023 </span>            : 
<span class="lineNum">    2024 </span>            :                 count = gf_list_count(wid-&gt;bound_ifces);
<span class="lineNum">    2025 </span>            :                 for (i=0; i&lt;count; i++) {
<span class="lineNum">    2026 </span>            :                         bifce = (GF_WidgetInterfaceInstance*)gf_list_get(wid-&gt;bound_ifces, i);
<span class="lineNum">    2027 </span>            :                         if (!ifce || ( !strcmp(bifce-&gt;ifce-&gt;type, ifce-&gt;type) &amp;&amp; (bifce-&gt;cookie==cookie)) ) {
<span class="lineNum">    2028 </span>            :                                 gf_list_rem(wid-&gt;bound_ifces, i);
<span class="lineNum">    2029 </span>            :                                 if (bifce-&gt;ifce-&gt;unbind_action) {
<span class="lineNum">    2030 </span>            :                                         wm_widget_set_scene_input_value(c, NULL, 0, NULL, rval, 3, wid, bifce-&gt;ifce-&gt;unbind_action, NULL);
<span class="lineNum">    2031 </span>            :                                 } else {
<span class="lineNum">    2032 </span>            :                                         widget_on_interface_bind(bifce, GF_TRUE);
<span class="lineNum">    2033 </span>            :                                 }
<span class="lineNum">    2034 </span>            :                                 if (ifce) {
<span class="lineNum">    2035 </span>            :                                         /*unregister our message handlers*/
<span class="lineNum">    2036 </span>            :                                         count = gf_list_count(wid-&gt;output_triggers);
<span class="lineNum">    2037 </span>            :                                         for (i=0; i&lt;count; i++) {
<span class="lineNum">    2038 </span>            :                                                 u32 j, c2, found;
<span class="lineNum">    2039 </span>            :                                                 GF_DOMHandler *handler = (GF_DOMHandler*)gf_list_get(wid-&gt;output_triggers, i);
<span class="lineNum">    2040 </span>            :                                                 GF_WidgetPin *param = (GF_WidgetPin*)handler-&gt;js_fun;
<span class="lineNum">    2041 </span>            : 
<span class="lineNum">    2042 </span>            :                                                 if (handler-&gt;sgprivate-&gt;UserPrivate != cookie) continue;
<span class="lineNum">    2043 </span>            :                                                 found = 0;
<span class="lineNum">    2044 </span>            :                                                 c2 = gf_list_count(bifce-&gt;ifce-&gt;messages);
<span class="lineNum">    2045 </span>            :                                                 for (j=0; j&lt;c2; j++) {
<span class="lineNum">    2046 </span>            :                                                         GF_WidgetMessage *msg = (GF_WidgetMessage*)gf_list_get(bifce-&gt;ifce-&gt;messages, j);
<span class="lineNum">    2047 </span>            :                                                         if (msg-&gt;output_trigger == param) {
<span class="lineNum">    2048 </span>            :                                                                 found = 1;
<span class="lineNum">    2049 </span>            :                                                                 break;
<span class="lineNum">    2050 </span>            :                                                         }
<span class="lineNum">    2051 </span>            :                                                 }
<span class="lineNum">    2052 </span>            :                                                 if (found) {
<span class="lineNum">    2053 </span>            : #ifndef GPAC_DISABLE_SVG
<span class="lineNum">    2054 </span>            :                                                         GF_Node *listener = handler-&gt;sgprivate-&gt;parents-&gt;node;
<span class="lineNum">    2055 </span>            :                                                         gf_dom_listener_del(listener, listener-&gt;sgprivate-&gt;UserPrivate);
<span class="lineNum">    2056 </span>            : #endif
<span class="lineNum">    2057 </span>            :                                                         gf_list_rem(wid-&gt;output_triggers, i);
<span class="lineNum">    2058 </span>            :                                                         i--;
<span class="lineNum">    2059 </span>            :                                                         count--;
<span class="lineNum">    2060 </span>            :                                                 }
<span class="lineNum">    2061 </span>            :                                         }
<span class="lineNum">    2062 </span>            :                                 }
<span class="lineNum">    2063 </span>            :                                 wm_delete_interface_instance(wid-&gt;widget-&gt;wm, bifce);
<span class="lineNum">    2064 </span>            :                                 if (ifce) return JS_TRUE;
<span class="lineNum">    2065 </span>            :                                 i--;
<span class="lineNum">    2066 </span>            :                                 count--;
<span class="lineNum">    2067 </span>            :                         }
<span class="lineNum">    2068 </span>            :                 }
<span class="lineNum">    2069 </span>            :         }
<span class="lineNum">    2070 </span>            :         return JS_TRUE;
<span class="lineNum">    2071 </span>            : }
<span class="lineNum">    2072 </span>            : 
<span class="lineNum">    2073 </span>            : static JSBool SMJS_FUNCTION(wm_widget_bind_interface)
<span class="lineNum">    2074 </span>            : {
<span class="lineNum">    2075 </span>            :         SMJS_OBJ
<span class="lineNum">    2076 </span>            :         SMJS_ARGS
<span class="lineNum">    2077 </span>            :         SMJS_DECL_RVAL
<span class="lineNum">    2078 </span>            :         return wm_widget_bind_interface_ex(c, obj, argc, argv, rval, GF_FALSE);
<span class="lineNum">    2079 </span>            : }
<span class="lineNum">    2080 </span>            : static JSBool SMJS_FUNCTION(wm_widget_unbind_interface)
<span class="lineNum">    2081 </span>            : {
<span class="lineNum">    2082 </span>            :         SMJS_OBJ
<span class="lineNum">    2083 </span>            :         SMJS_ARGS
<span class="lineNum">    2084 </span>            :         SMJS_DECL_RVAL
<span class="lineNum">    2085 </span>            :         return wm_widget_bind_interface_ex(c, obj, argc, argv, rval, GF_TRUE);
<span class="lineNum">    2086 </span>            : }
<span class="lineNum">    2087 </span>            : 
<span class="lineNum">    2088 </span>            : 
<span class="lineNum">    2089 </span>            : static JSBool SMJS_FUNCTION(wm_widget_deactivate)
<span class="lineNum">    2090 </span>            : {
<span class="lineNum">    2091 </span>            :         u32 i, count;
<span class="lineNum">    2092 </span>            :         jsval funval;
<span class="lineNum">    2093 </span>            :         SMJS_OBJ
<span class="lineNum">    2094 </span>            :         GF_WidgetInstance *wid = (GF_WidgetInstance *)SMJS_GET_PRIVATE(c, obj);
<span class="lineNum">    2095 </span>            :         if (!wid) return JS_FALSE;
<span class="lineNum">    2096 </span>            : 
<span class="lineNum">    2097 </span>            :         /*widget is a component of another widget, unregister*/
<span class="lineNum">    2098 </span>            :         if (wid-&gt;parent) {
<span class="lineNum">    2099 </span>            :                 GF_WidgetInstance *par_wid = wid-&gt;parent;
<span class="lineNum">    2100 </span>            :                 count = gf_list_count(par_wid-&gt;components);
<span class="lineNum">    2101 </span>            :                 for (i=0; i&lt;count; i++) {
<span class="lineNum">    2102 </span>            :                         GF_WidgetComponentInstance *comp = (GF_WidgetComponentInstance*)gf_list_get(par_wid-&gt;components, i);
<span class="lineNum">    2103 </span>            :                         if (comp-&gt;wid == wid) {
<span class="lineNum">    2104 </span>            :                                 gf_list_rem(par_wid-&gt;components, i);
<span class="lineNum">    2105 </span>            :                                 gf_free(comp);
<span class="lineNum">    2106 </span>            :                                 break;
<span class="lineNum">    2107 </span>            :                         }
<span class="lineNum">    2108 </span>            :                 }
<span class="lineNum">    2109 </span>            :                 wid-&gt;parent = NULL;
<span class="lineNum">    2110 </span>            :         }
<span class="lineNum">    2111 </span>            : 
<span class="lineNum">    2112 </span>            :         /*remove all components*/
<span class="lineNum">    2113 </span>            :         while (gf_list_count(wid-&gt;components)) {
<span class="lineNum">    2114 </span>            :                 GF_WidgetComponentInstance *comp = (GF_WidgetComponentInstance*)gf_list_get(wid-&gt;components, 0);
<span class="lineNum">    2115 </span>            :                 wm_deactivate_component(c, wid, NULL, comp);
<span class="lineNum">    2116 </span>            :                 gf_list_rem(wid-&gt;components, 0);
<span class="lineNum">    2117 </span>            :         }
<span class="lineNum">    2118 </span>            : 
<span class="lineNum">    2119 </span>            :         /*mark the widget as deactivated, so it is no longer valid when checking all widgets bindings*/
<span class="lineNum">    2120 </span>            :         wid-&gt;activated = GF_FALSE;
<span class="lineNum">    2121 </span>            : 
<span class="lineNum">    2122 </span>            :         /*unbind existing widgets*/
<span class="lineNum">    2123 </span>            :         JS_LookupProperty(wid-&gt;widget-&gt;wm-&gt;ctx, wid-&gt;widget-&gt;wm-&gt;obj, &quot;unbind_widget&quot;, &amp;funval);
<span class="lineNum">    2124 </span>            :         if (JSVAL_IS_OBJECT(funval)) {
<span class="lineNum">    2125 </span>            :                 jsval an_argv[1];
<span class="lineNum">    2126 </span>            :                 an_argv[0] = OBJECT_TO_JSVAL(obj);
<span class="lineNum">    2127 </span>            :                 JS_CallFunctionValue(wid-&gt;widget-&gt;wm-&gt;ctx, wid-&gt;widget-&gt;wm-&gt;obj, funval, 1, an_argv, SMJS_GET_RVAL );
<span class="lineNum">    2128 </span>            :         }
<span class="lineNum">    2129 </span>            : 
<span class="lineNum">    2130 </span>            :         /*unbind all interfaces of this widget*/
<span class="lineNum">    2131 </span>            :         wm_widget_bind_interface_ex(c, obj, 0, NULL, SMJS_GET_RVAL, GF_TRUE);
<span class="lineNum">    2132 </span>            : 
<span class="lineNum">    2133 </span>            :         /*detach scene now that all unbind events have been sent*/
<span class="lineNum">    2134 </span>            :         wid-&gt;scene = NULL;
<span class="lineNum">    2135 </span>            :         return JS_TRUE;
<span class="lineNum">    2136 </span>            : }
<span class="lineNum">    2137 </span>            : 
<span class="lineNum">    2138 </span>            : 
<span class="lineNum">    2139 </span>            : static void wm_widget_jsbind(GF_WidgetManager *wm, GF_WidgetInstance *wid)
<span class="lineNum">    2140 </span>            : {
<span class="lineNum">    2141 </span>            :         if (wid-&gt;obj)
<span class="lineNum">    2142 </span>            :                 return;
<span class="lineNum">    2143 </span>            :         wid-&gt;obj = JS_NewObject(wm-&gt;ctx, &amp;wm-&gt;wmWidgetClass._class, 0, 0);
<span class="lineNum">    2144 </span>            :         SMJS_SET_PRIVATE(wm-&gt;ctx, wid-&gt;obj, wid);
<span class="lineNum">    2145 </span>            :         /*protect from GC*/
<span class="lineNum">    2146 </span>            :         gf_js_add_root(wm-&gt;ctx, &amp;wid-&gt;obj, GF_JSGC_OBJECT);
<span class="lineNum">    2147 </span>            : }
<span class="lineNum">    2148 </span>            : 
<span class="lineNum">    2149 </span>            : void wm_deactivate_component(JSContext *c, GF_WidgetInstance *wid, GF_WidgetComponent *comp, GF_WidgetComponentInstance *comp_inst)
<span class="lineNum">    2150 </span>            : {
<span class="lineNum">    2151 </span>            :         jsval fval, rval;
<span class="lineNum">    2152 </span>            : 
<span class="lineNum">    2153 </span>            :         if (!comp_inst) {
<span class="lineNum">    2154 </span>            :                 u32 i=0;
<span class="lineNum">    2155 </span>            :                 while ((comp_inst = (GF_WidgetComponentInstance*)gf_list_enum(wid-&gt;components, &amp;i))) {
<span class="lineNum">    2156 </span>            :                         if (comp_inst-&gt;comp == comp) break;
<span class="lineNum">    2157 </span>            :                         comp_inst = NULL;
<span class="lineNum">    2158 </span>            :                 }
<span class="lineNum">    2159 </span>            :         }
<span class="lineNum">    2160 </span>            :         if (!comp_inst) return;
<span class="lineNum">    2161 </span>            : 
<span class="lineNum">    2162 </span>            :         if ((JS_LookupProperty(c, wid-&gt;widget-&gt;wm-&gt;obj, &quot;on_widget_remove&quot;, &amp;fval)==JS_TRUE) &amp;&amp; JSVAL_IS_OBJECT(fval)) {
<span class="lineNum">    2163 </span>            :                 jsval argv[1];
<span class="lineNum">    2164 </span>            :                 argv[0] = OBJECT_TO_JSVAL(comp_inst-&gt;wid-&gt;obj);
<span class="lineNum">    2165 </span>            :                 JS_CallFunctionValue(wid-&gt;widget-&gt;wm-&gt;ctx, wid-&gt;obj, fval, 1, argv, &amp;rval);
<span class="lineNum">    2166 </span>            :         }
<span class="lineNum">    2167 </span>            : }
<span class="lineNum">    2168 </span>            : 
<span class="lineNum">    2169 </span>            : GF_WidgetComponentInstance *wm_activate_component(JSContext *c, GF_WidgetInstance *wid, GF_WidgetComponent *comp, Bool skip_wm_notification)
<span class="lineNum">    2170 </span>            : {
<span class="lineNum">    2171 </span>            :         u32 i, count;
<span class="lineNum">    2172 </span>            :         const char *fun_name = NULL;
<span class="lineNum">    2173 </span>            :         jsval fval, rval;
<span class="lineNum">    2174 </span>            :         GF_WidgetComponentInstance *comp_inst;
<span class="lineNum">    2175 </span>            :         GF_WidgetInstance *comp_wid;
<span class="lineNum">    2176 </span>            : 
<span class="lineNum">    2177 </span>            :         comp_wid = NULL;
<span class="lineNum">    2178 </span>            :         if (comp-&gt;src) {
<span class="lineNum">    2179 </span>            :                 char *url = gf_url_concatenate(wid-&gt;widget-&gt;url, comp-&gt;src);
<span class="lineNum">    2180 </span>            : 
<span class="lineNum">    2181 </span>            :                 count = gf_list_count(wid-&gt;widget-&gt;wm-&gt;widget_instances);
<span class="lineNum">    2182 </span>            :                 for (i=0; i&lt;count; i++) {
<span class="lineNum">    2183 </span>            :                         comp_wid = (GF_WidgetInstance*)gf_list_get(wid-&gt;widget-&gt;wm-&gt;widget_instances, i);
<span class="lineNum">    2184 </span>            :                         if (!strcmp(comp_wid-&gt;widget-&gt;url, url) &amp;&amp; !comp_wid-&gt;parent) break;
<span class="lineNum">    2185 </span>            :                         comp_wid = NULL;
<span class="lineNum">    2186 </span>            :                 }
<span class="lineNum">    2187 </span>            :                 if (!comp_wid) {
<span class="lineNum">    2188 </span>            :                         comp_wid = wm_load_widget(wid-&gt;widget-&gt;wm, url, 0, GF_FALSE);
<span class="lineNum">    2189 </span>            :                         if (comp_wid) comp_wid-&gt;permanent = GF_FALSE;
<span class="lineNum">    2190 </span>            :                 }
<span class="lineNum">    2191 </span>            :                 gf_free(url);
<span class="lineNum">    2192 </span>            :         }
<span class="lineNum">    2193 </span>            :         if (!comp_wid) return NULL;
<span class="lineNum">    2194 </span>            : 
<span class="lineNum">    2195 </span>            :         if (!comp_wid-&gt;activated)
<span class="lineNum">    2196 </span>            :                 fun_name = &quot;on_widget_add&quot;;
<span class="lineNum">    2197 </span>            : 
<span class="lineNum">    2198 </span>            :         GF_SAFEALLOC(comp_inst, GF_WidgetComponentInstance);
<span class="lineNum">    2199 </span>            :         if (!comp_inst) return NULL;
<span class="lineNum">    2200 </span>            :         comp_inst-&gt;comp = comp;
<span class="lineNum">    2201 </span>            :         comp_inst-&gt;wid = comp_wid;
<span class="lineNum">    2202 </span>            :         comp_wid-&gt;parent = wid;
<span class="lineNum">    2203 </span>            : 
<span class="lineNum">    2204 </span>            :         gf_list_add(wid-&gt;components, comp_inst);
<span class="lineNum">    2205 </span>            : 
<span class="lineNum">    2206 </span>            :         if (!comp_inst-&gt;wid-&gt;obj) wm_widget_jsbind(wid-&gt;widget-&gt;wm, comp_inst-&gt;wid);
<span class="lineNum">    2207 </span>            : 
<span class="lineNum">    2208 </span>            :         if (!skip_wm_notification &amp;&amp; fun_name &amp;&amp; (JS_LookupProperty(c, wid-&gt;widget-&gt;wm-&gt;obj, fun_name, &amp;fval)==JS_TRUE) &amp;&amp; JSVAL_IS_OBJECT(fval)) {
<span class="lineNum">    2209 </span>            :                 jsval argv[1];
<span class="lineNum">    2210 </span>            :                 argv[0] = OBJECT_TO_JSVAL(comp_inst-&gt;wid-&gt;obj);
<span class="lineNum">    2211 </span>            :                 JS_CallFunctionValue(wid-&gt;widget-&gt;wm-&gt;ctx, wid-&gt;obj, fval, 1, argv, &amp;rval);
<span class="lineNum">    2212 </span>            :         }
<span class="lineNum">    2213 </span>            :         if (comp_inst) return comp_inst;
<span class="lineNum">    2214 </span>            :         return NULL;
<span class="lineNum">    2215 </span>            : }
<span class="lineNum">    2216 </span>            : 
<span class="lineNum">    2217 </span>            : static JSBool SMJS_FUNCTION(wm_widget_is_interface_bound)
<span class="lineNum">    2218 </span>            : {
<span class="lineNum">    2219 </span>            :         u32 i, count;
<span class="lineNum">    2220 </span>            :         JSObject *cookie;
<span class="lineNum">    2221 </span>            :         GF_WidgetInterface *ifce;
<span class="lineNum">    2222 </span>            :         SMJS_OBJ
<span class="lineNum">    2223 </span>            :         SMJS_ARGS
<span class="lineNum">    2224 </span>            :         GF_WidgetInstance *wid = (GF_WidgetInstance *)SMJS_GET_PRIVATE(c, obj);
<span class="lineNum">    2225 </span>            :         if (!wid || !wid-&gt;scene || (argc&lt;1) || !JSVAL_IS_OBJECT(argv[0]) ) return JS_FALSE;
<span class="lineNum">    2226 </span>            : 
<span class="lineNum">    2227 </span>            :         ifce = SMJS_GET_PRIVATE(c, JSVAL_TO_OBJECT(argv[0]) );
<span class="lineNum">    2228 </span>            :         if (!ifce) return JS_FALSE;
<span class="lineNum">    2229 </span>            :         cookie = NULL;
<span class="lineNum">    2230 </span>            :         if ((argc==2) &amp;&amp; JSVAL_IS_OBJECT(argv[1]) )
<span class="lineNum">    2231 </span>            :                 cookie = JSVAL_TO_OBJECT(argv[1]);
<span class="lineNum">    2232 </span>            : 
<span class="lineNum">    2233 </span>            :         SMJS_SET_RVAL(BOOLEAN_TO_JSVAL(JS_FALSE));
<span class="lineNum">    2234 </span>            :         count = gf_list_count(wid-&gt;bound_ifces);
<span class="lineNum">    2235 </span>            :         for (i=0; i&lt;count; i++) {
<span class="lineNum">    2236 </span>            :                 GF_WidgetInterfaceInstance *bifce = (GF_WidgetInterfaceInstance*)gf_list_get(wid-&gt;bound_ifces, i);
<span class="lineNum">    2237 </span>            :                 if (!strcmp(bifce-&gt;ifce-&gt;type, ifce-&gt;type) &amp;&amp; (!cookie || (bifce-&gt;cookie==cookie))) {
<span class="lineNum">    2238 </span>            :                         SMJS_SET_RVAL( BOOLEAN_TO_JSVAL(JS_TRUE) );
<span class="lineNum">    2239 </span>            :                         break;
<span class="lineNum">    2240 </span>            :                 }
<span class="lineNum">    2241 </span>            :         }
<span class="lineNum">    2242 </span>            :         return JS_TRUE;
<span class="lineNum">    2243 </span>            : }
<span class="lineNum">    2244 </span>            : 
<span class="lineNum">    2245 </span>            : 
<span class="lineNum">    2246 </span>            : static JSBool SMJS_FUNCTION(wm_load)
<span class="lineNum">    2247 </span>            : {
<span class="lineNum">    2248 </span>            :         u32 i, count;
<span class="lineNum">    2249 </span>            :         char *manifest, *url, *widget_ctx;
<span class="lineNum">    2250 </span>            :         GF_WidgetInstance *wid;
<span class="lineNum">    2251 </span>            :         SMJS_OBJ
<span class="lineNum">    2252 </span>            :         SMJS_ARGS
<span class="lineNum">    2253 </span>            :         GF_WidgetManager *wm = (GF_WidgetManager *)SMJS_GET_PRIVATE(c, obj);
<span class="lineNum">    2254 </span>            :         if (!argc || !JSVAL_IS_STRING(argv[0])) return JS_TRUE;
<span class="lineNum">    2255 </span>            : 
<span class="lineNum">    2256 </span>            :         manifest = SMJS_CHARS(c, argv[0]);
<span class="lineNum">    2257 </span>            : 
<span class="lineNum">    2258 </span>            :         url = NULL;
<span class="lineNum">    2259 </span>            :         if ((argc==2) &amp;&amp; ! JSVAL_IS_NULL(argv[1]) &amp;&amp; JSVAL_IS_OBJECT(argv[1])) {
<span class="lineNum">    2260 </span>            :                 GF_WidgetInstance *parent_widget;
<span class="lineNum">    2261 </span>            :                 if (!GF_JS_InstanceOf(c, JSVAL_TO_OBJECT(argv[1]), &amp;wm-&gt;wmWidgetClass, NULL) ) return JS_FALSE;
<span class="lineNum">    2262 </span>            :                 parent_widget = (GF_WidgetInstance *)SMJS_GET_PRIVATE(c, JSVAL_TO_OBJECT(argv[1]) );
<span class="lineNum">    2263 </span>            : 
<span class="lineNum">    2264 </span>            :                 if (parent_widget-&gt;widget-&gt;url) url = gf_url_concatenate(parent_widget-&gt;widget-&gt;url, manifest);
<span class="lineNum">    2265 </span>            :         }
<span class="lineNum">    2266 </span>            : 
<span class="lineNum">    2267 </span>            :         widget_ctx = NULL;
<span class="lineNum">    2268 </span>            :         if ((argc==3) &amp;&amp; !JSVAL_IS_NULL(argv[2]) &amp;&amp; JSVAL_IS_STRING(argv[2])) {
<span class="lineNum">    2269 </span>            :                 widget_ctx = SMJS_CHARS(c, argv[2]);
<span class="lineNum">    2270 </span>            :         }
<span class="lineNum">    2271 </span>            : 
<span class="lineNum">    2272 </span>            :         if (!url) {
<span class="lineNum">    2273 </span>            :                 url = gf_strdup(manifest);
<span class="lineNum">    2274 </span>            :         }
<span class="lineNum">    2275 </span>            : 
<span class="lineNum">    2276 </span>            :         wid=NULL;
<span class="lineNum">    2277 </span>            :         count = gf_list_count(wm-&gt;widget_instances);
<span class="lineNum">    2278 </span>            :         for (i=0; i&lt;count; i++) {
<span class="lineNum">    2279 </span>            :                 wid = (GF_WidgetInstance*)gf_list_get(wm-&gt;widget_instances, i);
<span class="lineNum">    2280 </span>            :                 if (!strcmp(wid-&gt;widget-&gt;url, url) &amp;&amp; !wid-&gt;activated) break;
<span class="lineNum">    2281 </span>            :                 wid = NULL;
<span class="lineNum">    2282 </span>            :         }
<span class="lineNum">    2283 </span>            :         if (!wid) {
<span class="lineNum">    2284 </span>            :                 wid = wm_load_widget(wm, url, 0, GF_TRUE);
<span class="lineNum">    2285 </span>            :         }
<span class="lineNum">    2286 </span>            :         if (url) gf_free(url);
<span class="lineNum">    2287 </span>            : 
<span class="lineNum">    2288 </span>            :         /*parse context if any*/
<span class="lineNum">    2289 </span>            :         if (wid &amp;&amp; wid-&gt;mpegu_context) {
<span class="lineNum">    2290 </span>            :                 gf_xml_dom_del(wid-&gt;mpegu_context);
<span class="lineNum">    2291 </span>            :                 wid-&gt;mpegu_context = NULL;
<span class="lineNum">    2292 </span>            :         }
<span class="lineNum">    2293 </span>            :         if (wid &amp;&amp; widget_ctx &amp;&amp; strlen(widget_ctx)) {
<span class="lineNum">    2294 </span>            :                 GF_Err e;
<span class="lineNum">    2295 </span>            :                 GF_XMLNode *context = NULL;
<span class="lineNum">    2296 </span>            :                 wid-&gt;mpegu_context = gf_xml_dom_new();
<span class="lineNum">    2297 </span>            :                 e = gf_xml_dom_parse_string(wid-&gt;mpegu_context, widget_ctx);
<span class="lineNum">    2298 </span>            :                 if (!e) {
<span class="lineNum">    2299 </span>            :                         context = gf_xml_dom_get_root(wid-&gt;mpegu_context);
<span class="lineNum">    2300 </span>            :                         if (strcmp(context-&gt;name, &quot;contextInformation&quot;)) context = NULL;
<span class="lineNum">    2301 </span>            :                 } else {
<span class="lineNum">    2302 </span>            :                 }
<span class="lineNum">    2303 </span>            : 
<span class="lineNum">    2304 </span>            :                 if (!context &amp;&amp; wid-&gt;mpegu_context) {
<span class="lineNum">    2305 </span>            :                         gf_xml_dom_del(wid-&gt;mpegu_context);
<span class="lineNum">    2306 </span>            :                         wid-&gt;mpegu_context = NULL;
<span class="lineNum">    2307 </span>            :                 }
<span class="lineNum">    2308 </span>            :         }
<span class="lineNum">    2309 </span>            : 
<span class="lineNum">    2310 </span>            :         if (wid) {
<span class="lineNum">    2311 </span>            :                 wm_widget_jsbind(wm, wid);
<span class="lineNum">    2312 </span>            :                 SMJS_SET_RVAL(OBJECT_TO_JSVAL(wid-&gt;obj));
<span class="lineNum">    2313 </span>            :         }
<span class="lineNum">    2314 </span>            :         SMJS_FREE(c, manifest);
<span class="lineNum">    2315 </span>            :         SMJS_FREE(c, widget_ctx);
<span class="lineNum">    2316 </span>            :         return JS_TRUE;
<span class="lineNum">    2317 </span>            : }
<span class="lineNum">    2318 </span>            : 
<span class="lineNum">    2319 </span>            : static JSBool SMJS_FUNCTION(wm_unload)
<span class="lineNum">    2320 </span>            : {
<span class="lineNum">    2321 </span>            :         GF_WidgetInstance *wid;
<span class="lineNum">    2322 </span>            :         SMJS_OBJ
<span class="lineNum">    2323 </span>            :         SMJS_ARGS
<span class="lineNum">    2324 </span>            :         GF_WidgetManager *wm = (GF_WidgetManager *)SMJS_GET_PRIVATE(c, obj);
<span class="lineNum">    2325 </span>            :         if (!argc || !JSVAL_IS_OBJECT(argv[0])) return JS_TRUE;
<span class="lineNum">    2326 </span>            : 
<span class="lineNum">    2327 </span>            :         if (!GF_JS_InstanceOf(c, JSVAL_TO_OBJECT(argv[0]), &amp;wm-&gt;wmWidgetClass, NULL) ) return JS_FALSE;
<span class="lineNum">    2328 </span>            :         wid = (GF_WidgetInstance *)SMJS_GET_PRIVATE(c, JSVAL_TO_OBJECT(argv[0]) );
<span class="lineNum">    2329 </span>            :         if (!wid) return JS_TRUE;
<span class="lineNum">    2330 </span>            : 
<span class="lineNum">    2331 </span>            :         /*unless explecetely requested, remove the section*/
<span class="lineNum">    2332 </span>            :         if ((argc!=2) || !JSVAL_IS_BOOLEAN(argv[1]) || (JSVAL_TO_BOOLEAN(argv[1])==JS_TRUE) ) {
<span class="lineNum">    2333 </span>            :                 /*create section*/
<span class="lineNum">    2334 </span>            :                 gf_cfg_del_section(wm-&gt;term-&gt;user-&gt;config, (const char *) wid-&gt;secname);
<span class="lineNum">    2335 </span>            :                 gf_cfg_set_key(wm-&gt;term-&gt;user-&gt;config, &quot;Widgets&quot;, (const char *) wid-&gt;secname, NULL);
<span class="lineNum">    2336 </span>            :         }
<span class="lineNum">    2337 </span>            :         wm_delete_widget_instance(wm, wid);
<span class="lineNum">    2338 </span>            :         return JS_TRUE;
<span class="lineNum">    2339 </span>            : }
<span class="lineNum">    2340 </span>            : 
<span class="lineNum">    2341 </span>            : 
<span class="lineNum">    2342 </span>            : 
<span class="lineNum">    2343 </span>            : static SMJS_FUNC_PROP_GET( wm_getProperty)
<span class="lineNum">    2344 </span>            : 
<span class="lineNum">    2345 </span>            : char *prop_name;
<span class="lineNum">    2346 </span>            : GF_WidgetManager *wm = (GF_WidgetManager *)SMJS_GET_PRIVATE(c, obj);
<span class="lineNum">    2347 </span>            : if (!wm) return JS_FALSE;
<span class="lineNum">    2348 </span>            : 
<span class="lineNum">    2349 </span>            : if (!SMJS_ID_IS_STRING(id)) return JS_TRUE;
<span class="lineNum">    2350 </span>            : prop_name = SMJS_CHARS_FROM_STRING(c, SMJS_ID_TO_STRING(id));
<span class="lineNum">    2351 </span>            : if (!prop_name) return JS_FALSE;
<span class="lineNum">    2352 </span>            : 
<span class="lineNum">    2353 </span>            : if (!strcmp(prop_name, &quot;num_widgets&quot;)) {
<span class="lineNum">    2354 </span>            :         *vp = INT_TO_JSVAL(gf_list_count(wm-&gt;widget_instances));
<span class="lineNum">    2355 </span>            : }
<span class="lineNum">    2356 </span>            : else if (!strcmp(prop_name, &quot;last_widget_dir&quot;)) {
<span class="lineNum">    2357 </span>            :         const char *opt = gf_cfg_get_key(wm-&gt;term-&gt;user-&gt;config, &quot;Widgets&quot;, &quot;last_widget_dir&quot;);
<span class="lineNum">    2358 </span>            :         if (!opt) opt = &quot;/&quot;;
<span class="lineNum">    2359 </span>            :         *vp = STRING_TO_JSVAL(JS_NewStringCopyZ(c, opt));
<span class="lineNum">    2360 </span>            : }
<span class="lineNum">    2361 </span>            : SMJS_FREE(c, prop_name);
<span class="lineNum">    2362 </span>            : return JS_TRUE;
<span class="lineNum">    2363 </span>            : }
<span class="lineNum">    2364 </span>            : 
<span class="lineNum">    2365 </span>            : 
<span class="lineNum">    2366 </span>            : static SMJS_FUNC_PROP_SET( wm_setProperty)
<span class="lineNum">    2367 </span>            : 
<span class="lineNum">    2368 </span>            : char *prop_name;
<span class="lineNum">    2369 </span>            : GF_WidgetManager *wm = (GF_WidgetManager *)SMJS_GET_PRIVATE(c, obj);
<span class="lineNum">    2370 </span>            : if (!wm) return JS_FALSE;
<span class="lineNum">    2371 </span>            : 
<span class="lineNum">    2372 </span>            : if (!JSVAL_IS_STRING(*vp)) return JS_TRUE;
<span class="lineNum">    2373 </span>            : if (!SMJS_ID_IS_STRING(id)) return JS_TRUE;
<span class="lineNum">    2374 </span>            : prop_name = SMJS_CHARS_FROM_STRING(c, SMJS_ID_TO_STRING(id));
<span class="lineNum">    2375 </span>            : 
<span class="lineNum">    2376 </span>            : if (!strcmp(prop_name, &quot;last_widget_dir&quot;)) {
<span class="lineNum">    2377 </span>            :         char *v = SMJS_CHARS(c, *vp);
<span class="lineNum">    2378 </span>            :         gf_cfg_set_key(wm-&gt;term-&gt;user-&gt;config, &quot;Widgets&quot;, &quot;last_widget_dir&quot;, v);
<span class="lineNum">    2379 </span>            :         SMJS_FREE(c, v);
<span class="lineNum">    2380 </span>            : }
<span class="lineNum">    2381 </span>            : SMJS_FREE(c, prop_name);
<span class="lineNum">    2382 </span>            : return JS_TRUE;
<span class="lineNum">    2383 </span>            : }
<span class="lineNum">    2384 </span>            : 
<span class="lineNum">    2385 </span>            : static JSBool SMJS_FUNCTION(wm_get)
<span class="lineNum">    2386 </span>            : {
<span class="lineNum">    2387 </span>            :         u32 i;
<span class="lineNum">    2388 </span>            :         GF_WidgetInstance *wid;
<span class="lineNum">    2389 </span>            :         SMJS_OBJ
<span class="lineNum">    2390 </span>            :         SMJS_ARGS
<span class="lineNum">    2391 </span>            :         GF_WidgetManager *wm = (GF_WidgetManager *)SMJS_GET_PRIVATE(c, obj);
<span class="lineNum">    2392 </span>            :         if (!argc || !JSVAL_IS_INT(argv[0])) return JS_TRUE;
<span class="lineNum">    2393 </span>            : 
<span class="lineNum">    2394 </span>            :         i = JSVAL_TO_INT(argv[0]);
<span class="lineNum">    2395 </span>            :         wid = (GF_WidgetInstance*)gf_list_get(wm-&gt;widget_instances, i);
<span class="lineNum">    2396 </span>            :         if (wid) SMJS_SET_RVAL( OBJECT_TO_JSVAL(wid-&gt;obj) );
<span class="lineNum">    2397 </span>            :         return JS_TRUE;
<span class="lineNum">    2398 </span>            : }
<span class="lineNum">    2399 </span>            : 
<span class="lineNum">    2400 </span>            : static JSBool SMJS_FUNCTION(wm_find_interface)
<span class="lineNum">    2401 </span>            : {
<span class="lineNum">    2402 </span>            :         char *ifce_name;
<span class="lineNum">    2403 </span>            :         u32 i;
<span class="lineNum">    2404 </span>            :         GF_WidgetInstance *wid;
<span class="lineNum">    2405 </span>            :         SMJS_OBJ
<span class="lineNum">    2406 </span>            :         SMJS_ARGS
<span class="lineNum">    2407 </span>            :         GF_WidgetManager *wm = (GF_WidgetManager *)SMJS_GET_PRIVATE(c, obj);
<span class="lineNum">    2408 </span>            :         if (!argc || !JSVAL_IS_STRING(argv[0])) return JS_TRUE;
<span class="lineNum">    2409 </span>            : 
<span class="lineNum">    2410 </span>            :         ifce_name = SMJS_CHARS(c, argv[0]);
<span class="lineNum">    2411 </span>            :         i=0;
<span class="lineNum">    2412 </span>            :         while ( (wid = (GF_WidgetInstance*)gf_list_enum(wm-&gt;widget_instances, &amp;i) )) {
<span class="lineNum">    2413 </span>            :                 u32 j=0;
<span class="lineNum">    2414 </span>            :                 GF_WidgetInterface *wid_ifce;
<span class="lineNum">    2415 </span>            :                 while ((wid_ifce = (GF_WidgetInterface*)gf_list_enum(wid-&gt;widget-&gt;main-&gt;interfaces, &amp;j))) {
<span class="lineNum">    2416 </span>            :                         if (!strcmp(wid_ifce-&gt;type, ifce_name)) {
<span class="lineNum">    2417 </span>            :                                 SMJS_SET_RVAL( OBJECT_TO_JSVAL(wid-&gt;obj) );
<span class="lineNum">    2418 </span>            :                                 SMJS_FREE(c, ifce_name);
<span class="lineNum">    2419 </span>            :                                 return JS_TRUE;
<span class="lineNum">    2420 </span>            :                         }
<span class="lineNum">    2421 </span>            :                 }
<span class="lineNum">    2422 </span>            :         }
<span class="lineNum">    2423 </span>            :         SMJS_FREE(c, ifce_name);
<span class="lineNum">    2424 </span>            :         return JS_TRUE;
<span class="lineNum">    2425 </span>            : }
<span class="lineNum">    2426 </span>            : 
<span class="lineNum">    2427 </span>            : 
<span class="lineNum">    2428 </span>            : const char *wm_xml_get_attr(GF_XMLNode *root, const char *name)
<span class="lineNum">    2429 </span>            : {
<span class="lineNum">    2430 </span>            : 
<span class="lineNum">    2431 </span>            :         u32 i, count;
<span class="lineNum">    2432 </span>            :         count = gf_list_count(root-&gt;attributes);
<span class="lineNum">    2433 </span>            :         for (i=0; i&lt;count; i++) {
<span class="lineNum">    2434 </span>            :                 char *sep;
<span class="lineNum">    2435 </span>            :                 GF_XMLAttribute *att = gf_list_get(root-&gt;attributes, i);
<span class="lineNum">    2436 </span>            :                 if (!att-&gt;name) continue;
<span class="lineNum">    2437 </span>            :                 if (!strcmp(att-&gt;name, name)) return att-&gt;value;
<span class="lineNum">    2438 </span>            :                 sep = strchr(att-&gt;name, ':');
<span class="lineNum">    2439 </span>            :                 if (sep &amp;&amp; !strcmp(sep+1, name)) return att-&gt;value;
<span class="lineNum">    2440 </span>            :         }
<span class="lineNum">    2441 </span>            :         return NULL;
<span class="lineNum">    2442 </span>            : }
<span class="lineNum">    2443 </span>            : 
<span class="lineNum">    2444 </span>            : /* TODO Implement real language check according to BCP 47*/
<span class="lineNum">    2445 </span>            : static Bool wm_check_language(const char *xml_lang_value, const char *user_locale)
<span class="lineNum">    2446 </span>            : {
<span class="lineNum">    2447 </span>            :         Bool ret = GF_FALSE;
<span class="lineNum">    2448 </span>            :         char *sep, *val;
<span class="lineNum">    2449 </span>            :         val = (char*)xml_lang_value;
<span class="lineNum">    2450 </span>            :         while (!ret) {
<span class="lineNum">    2451 </span>            :                 sep = strchr(val, ';');
<span class="lineNum">    2452 </span>            :                 if (sep) sep[0] = 0;
<span class="lineNum">    2453 </span>            :                 if (strstr(user_locale, val)) ret = GF_TRUE;
<span class="lineNum">    2454 </span>            :                 if (sep) {
<span class="lineNum">    2455 </span>            :                         sep[0] = ';';
<span class="lineNum">    2456 </span>            :                         val = sep+1;
<span class="lineNum">    2457 </span>            :                 } else {
<span class="lineNum">    2458 </span>            :                         break;
<span class="lineNum">    2459 </span>            :                 }
<span class="lineNum">    2460 </span>            :         }
<span class="lineNum">    2461 </span>            :         return ret;
<span class="lineNum">    2462 </span>            : }
<span class="lineNum">    2463 </span>            : 
<span class="lineNum">    2464 </span>            : static GF_XMLNode *wm_xml_find(GF_XMLNode *root, const char *ns_prefix, const char *name, const char *user_locale)
<span class="lineNum">    2465 </span>            : {
<span class="lineNum">    2466 </span>            :         GF_XMLNode *localized = NULL;
<span class="lineNum">    2467 </span>            :         GF_XMLNode *non_localized = NULL;
<span class="lineNum">    2468 </span>            :         u32 i, count;
<span class="lineNum">    2469 </span>            : 
<span class="lineNum">    2470 </span>            :         if (!root) return NULL;
<span class="lineNum">    2471 </span>            : 
<span class="lineNum">    2472 </span>            :         count = gf_list_count(root-&gt;content);
<span class="lineNum">    2473 </span>            :         for (i=0; i&lt;count; i++) {
<span class="lineNum">    2474 </span>            :                 GF_XMLNode *n = (GF_XMLNode*)gf_list_get(root-&gt;content, i);
<span class="lineNum">    2475 </span>            :                 if (n-&gt;type==GF_XML_NODE_TYPE &amp;&amp; n-&gt;name &amp;&amp; !strcmp(n-&gt;name, name) &amp;&amp; ((!ns_prefix &amp;&amp; !n-&gt;ns) || (ns_prefix &amp;&amp; n-&gt;ns &amp;&amp; !strcmp(ns_prefix, n-&gt;ns)))) {
<span class="lineNum">    2476 </span>            :                         const char *lang = wm_xml_get_attr(n, &quot;xml:lang&quot;);
<span class="lineNum">    2477 </span>            :                         if (!lang) {
<span class="lineNum">    2478 </span>            :                                 if (!non_localized) non_localized = n;
<span class="lineNum">    2479 </span>            :                         } else {
<span class="lineNum">    2480 </span>            :                                 if (user_locale &amp;&amp; wm_check_language(lang, user_locale) &amp;&amp; !localized) localized = n;
<span class="lineNum">    2481 </span>            :                         }
<span class="lineNum">    2482 </span>            :                 }
<span class="lineNum">    2483 </span>            :         }
<span class="lineNum">    2484 </span>            :         if (localized) return localized;
<span class="lineNum">    2485 </span>            :         else return non_localized;
<span class="lineNum">    2486 </span>            : }
<span class="lineNum">    2487 </span>            : 
<span class="lineNum">    2488 </span>            : static GF_WidgetPin *wm_parse_pin(const char *value, u16 type, const char *pin_name, const char *scriptType, const char *default_value)
<span class="lineNum">    2489 </span>            : {
<span class="lineNum">    2490 </span>            :         GF_WidgetPin *pin;
<span class="lineNum">    2491 </span>            :         char *sep;
<span class="lineNum">    2492 </span>            : 
<span class="lineNum">    2493 </span>            :         if (!value &amp;&amp; !scriptType &amp;&amp; !default_value) return NULL;
<span class="lineNum">    2494 </span>            : 
<span class="lineNum">    2495 </span>            :         GF_SAFEALLOC(pin, GF_WidgetPin);
<span class="lineNum">    2496 </span>            :         if (!pin) return NULL;
<span class="lineNum">    2497 </span>            :         
<span class="lineNum">    2498 </span>            :         pin-&gt;type = type;
<span class="lineNum">    2499 </span>            :         if (pin_name) pin-&gt;name = gf_strdup(pin_name);
<span class="lineNum">    2500 </span>            : 
<span class="lineNum">    2501 </span>            :         if (value) {
<span class="lineNum">    2502 </span>            :                 sep = strrchr(value, '.');
<span class="lineNum">    2503 </span>            :                 if (!sep &amp;&amp; (type==GF_WM_PREF_CONNECT)) {
<span class="lineNum">    2504 </span>            :                         gf_free(pin);
<span class="lineNum">    2505 </span>            :                         return NULL;
<span class="lineNum">    2506 </span>            :                 }
<span class="lineNum">    2507 </span>            : 
<span class="lineNum">    2508 </span>            :                 /*node.event || node.attribute*/
<span class="lineNum">    2509 </span>            :                 if (sep) {
<span class="lineNum">    2510 </span>            :                         sep[0] = 0;
<span class="lineNum">    2511 </span>            :                         pin-&gt;node = gf_strdup(value);
<span class="lineNum">    2512 </span>            :                         pin-&gt;attribute = gf_strdup(sep+1);
<span class="lineNum">    2513 </span>            :                         sep[0] = '.';
<span class="lineNum">    2514 </span>            :                 }
<span class="lineNum">    2515 </span>            :                 /*script function*/
<span class="lineNum">    2516 </span>            :                 else {
<span class="lineNum">    2517 </span>            :                         pin-&gt;node = gf_strdup(value);
<span class="lineNum">    2518 </span>            :                 }
<span class="lineNum">    2519 </span>            :         }
<span class="lineNum">    2520 </span>            : 
<span class="lineNum">    2521 </span>            :         if (scriptType) {
<span class="lineNum">    2522 </span>            :                 if (!strcmp(scriptType, &quot;boolean&quot;)) pin-&gt;script_type = GF_WM_PARAM_SCRIPT_BOOL;
<span class="lineNum">    2523 </span>            :                 else if (!strcmp(scriptType, &quot;number&quot;)) pin-&gt;script_type = GF_WM_PARAM_SCRIPT_NUMBER;
<span class="lineNum">    2524 </span>            :         } else if (default_value) {
<span class="lineNum">    2525 </span>            :                 pin-&gt;default_value = gf_strdup(default_value);
<span class="lineNum">    2526 </span>            :         }
<span class="lineNum">    2527 </span>            :         return pin;
<span class="lineNum">    2528 </span>            : }
<span class="lineNum">    2529 </span>            : 
<span class="lineNum">    2530 </span>            : static void wm_parse_mpegu_content_element(GF_WidgetContent *content, GF_XMLNode *root, const char *ns_prefix, GF_List *global_prefs)
<span class="lineNum">    2531 </span>            : {
<span class="lineNum">    2532 </span>            :         GF_XMLNode *ifces, *context, *pref_node;
<span class="lineNum">    2533 </span>            :         GF_WidgetMessage *msg;
<span class="lineNum">    2534 </span>            :         GF_WidgetInterface *ifce;
<span class="lineNum">    2535 </span>            :         GF_XMLNode *ifce_node;
<span class="lineNum">    2536 </span>            :         GF_WidgetPreference *pref;
<span class="lineNum">    2537 </span>            :         const char *att;
<span class="lineNum">    2538 </span>            :         u32 i = 0;
<span class="lineNum">    2539 </span>            : 
<span class="lineNum">    2540 </span>            :         ifces = wm_xml_find(root, ns_prefix, &quot;interfaces&quot;, NULL);
<span class="lineNum">    2541 </span>            :         if (ifces) {
<span class="lineNum">    2542 </span>            : 
<span class="lineNum">    2543 </span>            :                 /*get all interface element*/
<span class="lineNum">    2544 </span>            :                 while ((ifce_node = (GF_XMLNode*)gf_list_enum(ifces-&gt;content, &amp;i))) {
<span class="lineNum">    2545 </span>            :                         GF_XMLNode *msg_node;
<span class="lineNum">    2546 </span>            :                         u32 j;
<span class="lineNum">    2547 </span>            :                         const char *ifce_type, *act;
<span class="lineNum">    2548 </span>            :                         if (ifce_node-&gt;type != GF_XML_NODE_TYPE) continue;
<span class="lineNum">    2549 </span>            :                         if (strcmp(ifce_node-&gt;name, &quot;interface&quot;)) continue;
<span class="lineNum">    2550 </span>            :                         ifce_type = wm_xml_get_attr(ifce_node, &quot;type&quot;);
<span class="lineNum">    2551 </span>            :                         if (!ifce_type) continue;
<span class="lineNum">    2552 </span>            : 
<span class="lineNum">    2553 </span>            :                         GF_SAFEALLOC(ifce, GF_WidgetInterface);
<span class="lineNum">    2554 </span>            :                         ifce-&gt;type = gf_strdup(ifce_type);
<span class="lineNum">    2555 </span>            :                         ifce-&gt;messages = gf_list_new();
<span class="lineNum">    2556 </span>            :                         ifce-&gt;content = content;
<span class="lineNum">    2557 </span>            :                         gf_list_add(content-&gt;interfaces, ifce);
<span class="lineNum">    2558 </span>            : 
<span class="lineNum">    2559 </span>            :                         act = wm_xml_get_attr(ifce_node, &quot;serviceProvider&quot;);
<span class="lineNum">    2560 </span>            :                         if (act &amp;&amp; !strcmp(act, &quot;true&quot;)) ifce-&gt;provider = GF_TRUE;
<span class="lineNum">    2561 </span>            : 
<span class="lineNum">    2562 </span>            :                         act = wm_xml_get_attr(ifce_node, &quot;multipleBindings&quot;);
<span class="lineNum">    2563 </span>            :                         if (act &amp;&amp; !strcmp(act, &quot;true&quot;)) ifce-&gt;multiple_binding = GF_TRUE;
<span class="lineNum">    2564 </span>            : 
<span class="lineNum">    2565 </span>            :                         act = wm_xml_get_attr(ifce_node, &quot;required&quot;);
<span class="lineNum">    2566 </span>            :                         if (act &amp;&amp; !strcmp(act, &quot;true&quot;)) ifce-&gt;required = GF_TRUE;
<span class="lineNum">    2567 </span>            : 
<span class="lineNum">    2568 </span>            :                         act = wm_xml_get_attr(ifce_node, &quot;connectTo&quot;);
<span class="lineNum">    2569 </span>            :                         if (act) ifce-&gt;connectTo = gf_strdup(act);
<span class="lineNum">    2570 </span>            : 
<span class="lineNum">    2571 </span>            :                         act = wm_xml_get_attr(ifce_node, &quot;bindAction&quot;);
<span class="lineNum">    2572 </span>            :                         if (act) {
<span class="lineNum">    2573 </span>            :                                 ifce-&gt;bind_action = wm_parse_pin(act, GF_WM_BIND_ACTION, NULL, NULL, NULL);
<span class="lineNum">    2574 </span>            :                         }
<span class="lineNum">    2575 </span>            :                         act = wm_xml_get_attr(ifce_node, &quot;unbindAction&quot;);
<span class="lineNum">    2576 </span>            :                         if (act) {
<span class="lineNum">    2577 </span>            :                                 ifce-&gt;unbind_action = wm_parse_pin(act, GF_WM_UNBIND_ACTION, NULL, NULL, NULL);
<span class="lineNum">    2578 </span>            :                         }
<span class="lineNum">    2579 </span>            : 
<span class="lineNum">    2580 </span>            :                         j=0;
<span class="lineNum">    2581 </span>            :                         while ((msg_node = (GF_XMLNode*)gf_list_enum(ifce_node-&gt;content, &amp;j))) {
<span class="lineNum">    2582 </span>            :                                 u32 k;
<span class="lineNum">    2583 </span>            :                                 GF_XMLNode *par_node;
<span class="lineNum">    2584 </span>            :                                 const char *msg_name, *action;
<span class="lineNum">    2585 </span>            :                                 if (msg_node-&gt;type != GF_XML_NODE_TYPE) continue;
<span class="lineNum">    2586 </span>            :                                 if (strcmp(msg_node-&gt;name, &quot;messageIn&quot;) &amp;&amp; strcmp(msg_node-&gt;name, &quot;messageOut&quot;)) continue;
<span class="lineNum">    2587 </span>            : 
<span class="lineNum">    2588 </span>            :                                 msg_name = wm_xml_get_attr(msg_node, &quot;name&quot;);
<span class="lineNum">    2589 </span>            :                                 if (!msg_name) continue;
<span class="lineNum">    2590 </span>            :                                 GF_SAFEALLOC(msg, GF_WidgetMessage);
<span class="lineNum">    2591 </span>            :                                 msg-&gt;name = gf_strdup(msg_name);
<span class="lineNum">    2592 </span>            :                                 msg-&gt;params = gf_list_new();
<span class="lineNum">    2593 </span>            :                                 msg-&gt;ifce = ifce;
<span class="lineNum">    2594 </span>            :                                 if (!strcmp(msg_node-&gt;name, &quot;messageOut&quot;)) msg-&gt;is_output = 1;
<span class="lineNum">    2595 </span>            : 
<span class="lineNum">    2596 </span>            :                                 gf_list_add(ifce-&gt;messages, msg);
<span class="lineNum">    2597 </span>            : 
<span class="lineNum">    2598 </span>            :                                 /*get inputAction*/
<span class="lineNum">    2599 </span>            :                                 action = wm_xml_get_attr(msg_node, &quot;inputAction&quot;);
<span class="lineNum">    2600 </span>            :                                 if (action) {
<span class="lineNum">    2601 </span>            :                                         msg-&gt;input_action = wm_parse_pin(action, GF_WM_INPUT_ACTION, NULL, NULL, NULL);
<span class="lineNum">    2602 </span>            :                                 }
<span class="lineNum">    2603 </span>            : 
<span class="lineNum">    2604 </span>            :                                 /*get outputTrigger*/
<span class="lineNum">    2605 </span>            :                                 action = wm_xml_get_attr(msg_node, &quot;outputTrigger&quot;);
<span class="lineNum">    2606 </span>            :                                 if (action) {
<span class="lineNum">    2607 </span>            :                                         msg-&gt;output_trigger = wm_parse_pin(action, GF_WM_OUTPUT_TRIGGER, NULL, NULL, NULL);
<span class="lineNum">    2608 </span>            :                                 }
<span class="lineNum">    2609 </span>            : 
<span class="lineNum">    2610 </span>            :                                 /*get params*/
<span class="lineNum">    2611 </span>            :                                 k=0;
<span class="lineNum">    2612 </span>            :                                 while ((par_node=gf_list_enum(msg_node-&gt;content, &amp;k))) {
<span class="lineNum">    2613 </span>            :                                         GF_WidgetPin *wpin;
<span class="lineNum">    2614 </span>            :                                         u16 type;
<span class="lineNum">    2615 </span>            :                                         const char *par_name, *att_name;
<span class="lineNum">    2616 </span>            :                                         if (par_node-&gt;type != GF_XML_NODE_TYPE) continue;
<span class="lineNum">    2617 </span>            :                                         if (strcmp(par_node-&gt;name, &quot;input&quot;) &amp;&amp; strcmp(par_node-&gt;name, &quot;output&quot;)) continue;
<span class="lineNum">    2618 </span>            : 
<span class="lineNum">    2619 </span>            : 
<span class="lineNum">    2620 </span>            :                                         par_name = wm_xml_get_attr(par_node, &quot;name&quot;);
<span class="lineNum">    2621 </span>            :                                         /*invalid param, discard message*/
<span class="lineNum">    2622 </span>            :                                         if (!par_name) {
<span class="lineNum">    2623 </span>            :                                                 gf_list_del_item(ifce-&gt;messages, msg);
<span class="lineNum">    2624 </span>            :                                                 gf_list_del(msg-&gt;params);
<span class="lineNum">    2625 </span>            :                                                 gf_free(msg-&gt;name);
<span class="lineNum">    2626 </span>            :                                                 gf_free(msg);
<span class="lineNum">    2627 </span>            :                                                 break;
<span class="lineNum">    2628 </span>            :                                         }
<span class="lineNum">    2629 </span>            : 
<span class="lineNum">    2630 </span>            :                                         if (!strcmp(par_node-&gt;name, &quot;output&quot;)) {
<span class="lineNum">    2631 </span>            :                                                 type = GF_WM_PARAM_OUTPUT;
<span class="lineNum">    2632 </span>            :                                                 att_name = wm_xml_get_attr(par_node, &quot;attributeModified&quot;);
<span class="lineNum">    2633 </span>            :                                         } else {
<span class="lineNum">    2634 </span>            :                                                 type = GF_WM_PARAM_INPUT;
<span class="lineNum">    2635 </span>            :                                                 att_name = wm_xml_get_attr(par_node, &quot;setAttribute&quot;);
<span class="lineNum">    2636 </span>            :                                         }
<span class="lineNum">    2637 </span>            :                                         wpin = wm_parse_pin(att_name, type, par_name, wm_xml_get_attr(par_node, &quot;scriptParamType&quot;), wm_xml_get_attr(par_node, &quot;default&quot;));
<span class="lineNum">    2638 </span>            :                                         if (!wpin) continue;
<span class="lineNum">    2639 </span>            :                                         wpin-&gt;msg = msg;
<span class="lineNum">    2640 </span>            : 
<span class="lineNum">    2641 </span>            :                                         gf_list_add(msg-&gt;params, wpin);
<span class="lineNum">    2642 </span>            :                                 }
<span class="lineNum">    2643 </span>            :                         }
<span class="lineNum">    2644 </span>            :                 }
<span class="lineNum">    2645 </span>            :         }
<span class="lineNum">    2646 </span>            : 
<span class="lineNum">    2647 </span>            :         /*get all component elements*/
<span class="lineNum">    2648 </span>            :         i=0;
<span class="lineNum">    2649 </span>            :         while (root &amp;&amp; (ifce_node = gf_list_enum(root-&gt;content, &amp;i))) {
<span class="lineNum">    2650 </span>            :                 GF_XMLNode *req_node;
<span class="lineNum">    2651 </span>            :                 u32 j;
<span class="lineNum">    2652 </span>            :                 const char *src, *id, *act;
<span class="lineNum">    2653 </span>            :                 GF_WidgetComponent *comp;
<span class="lineNum">    2654 </span>            :                 if (ifce_node-&gt;type != GF_XML_NODE_TYPE) continue;
<span class="lineNum">    2655 </span>            :                 if (strcmp(ifce_node-&gt;name, &quot;component&quot;)) continue;
<span class="lineNum">    2656 </span>            :                 src = wm_xml_get_attr(ifce_node, &quot;src&quot;);
<span class="lineNum">    2657 </span>            :                 id = wm_xml_get_attr(ifce_node, &quot;id&quot;);
<span class="lineNum">    2658 </span>            : 
<span class="lineNum">    2659 </span>            :                 GF_SAFEALLOC(comp, GF_WidgetComponent);
<span class="lineNum">    2660 </span>            :                 comp-&gt;required_interfaces = gf_list_new();
<span class="lineNum">    2661 </span>            :                 comp-&gt;content = content;
<span class="lineNum">    2662 </span>            :                 if (id) comp-&gt;id = gf_strdup(id);
<span class="lineNum">    2663 </span>            :                 if (src) comp-&gt;src = gf_strdup(src);
<span class="lineNum">    2664 </span>            :                 j=0;
<span class="lineNum">    2665 </span>            :                 while ((req_node=gf_list_enum(ifce_node-&gt;content, &amp;j))) {
<span class="lineNum">    2666 </span>            :                         const char *ifce_type;
<span class="lineNum">    2667 </span>            :                         if (req_node-&gt;type != GF_XML_NODE_TYPE) continue;
<span class="lineNum">    2668 </span>            :                         if (strcmp(req_node-&gt;name, &quot;requiredInterface&quot;)) continue;
<span class="lineNum">    2669 </span>            :                         ifce_type = wm_xml_get_attr(req_node, &quot;type&quot;);
<span class="lineNum">    2670 </span>            :                         if (!ifce_type) continue;
<span class="lineNum">    2671 </span>            :                         gf_list_add(comp-&gt;required_interfaces, gf_strdup(ifce_type));
<span class="lineNum">    2672 </span>            :                 }
<span class="lineNum">    2673 </span>            : 
<span class="lineNum">    2674 </span>            :                 act = wm_xml_get_attr(ifce_node, &quot;activateTrigger&quot;);
<span class="lineNum">    2675 </span>            :                 if (act) comp-&gt;activateTrigger = wm_parse_pin(act, GF_WM_ACTIVATE_TRIGGER, NULL, NULL, NULL);
<span class="lineNum">    2676 </span>            :                 act = wm_xml_get_attr(ifce_node, &quot;deactivateTrigger&quot;);
<span class="lineNum">    2677 </span>            :                 if (act) comp-&gt;deactivateTrigger = wm_parse_pin(act, GF_WM_DEACTIVATE_TRIGGER, NULL, NULL, NULL);
<span class="lineNum">    2678 </span>            : 
<span class="lineNum">    2679 </span>            :                 gf_list_add(content-&gt;components, comp);
<span class="lineNum">    2680 </span>            :         }
<span class="lineNum">    2681 </span>            : 
<span class="lineNum">    2682 </span>            :         /*clone global prefs for this content*/
<span class="lineNum">    2683 </span>            :         i=0;
<span class="lineNum">    2684 </span>            :         while ((pref = gf_list_enum(global_prefs, &amp;i))) {
<span class="lineNum">    2685 </span>            :                 GF_WidgetPreference *apref;
<span class="lineNum">    2686 </span>            :                 GF_SAFEALLOC(apref, GF_WidgetPreference);
<span class="lineNum">    2687 </span>            :                 apref-&gt;name = gf_strdup(pref-&gt;name);
<span class="lineNum">    2688 </span>            :                 if (pref-&gt;value) apref-&gt;value = gf_strdup(pref-&gt;value);
<span class="lineNum">    2689 </span>            :                 apref-&gt;flags = pref-&gt;flags;
<span class="lineNum">    2690 </span>            :                 gf_list_add(content-&gt;preferences, apref);
<span class="lineNum">    2691 </span>            :         }
<span class="lineNum">    2692 </span>            : 
<span class="lineNum">    2693 </span>            :         context = wm_xml_find(root, ns_prefix, &quot;contextConfiguration&quot;, NULL);
<span class="lineNum">    2694 </span>            :         if (context) {
<span class="lineNum">    2695 </span>            :                 u32 j;
<span class="lineNum">    2696 </span>            :                 /*get all preference elements*/
<span class="lineNum">    2697 </span>            :                 i=0;
<span class="lineNum">    2698 </span>            :                 while ((pref_node = gf_list_enum(context-&gt;content, &amp;i))) {
<span class="lineNum">    2699 </span>            :                         const char *att;
<span class="lineNum">    2700 </span>            :                         if (pref_node-&gt;type != GF_XML_NODE_TYPE) continue;
<span class="lineNum">    2701 </span>            :                         if (strcmp(pref_node-&gt;name, &quot;preferenceConnect&quot;)) continue;
<span class="lineNum">    2702 </span>            :                         att = wm_xml_get_attr(pref_node, &quot;name&quot;);
<span class="lineNum">    2703 </span>            :                         if (!att) continue;
<span class="lineNum">    2704 </span>            : 
<span class="lineNum">    2705 </span>            :                         j=0;
<span class="lineNum">    2706 </span>            :                         while ((pref = gf_list_enum(content-&gt;preferences, &amp;j))) {
<span class="lineNum">    2707 </span>            :                                 if (!strcmp(pref-&gt;name, att) &amp;&amp; !pref-&gt;connectTo) break;
<span class="lineNum">    2708 </span>            :                         }
<span class="lineNum">    2709 </span>            : 
<span class="lineNum">    2710 </span>            :                         if (!pref) {
<span class="lineNum">    2711 </span>            :                                 GF_SAFEALLOC(pref, GF_WidgetPreference);
<span class="lineNum">    2712 </span>            :                                 if (!pref) {
<span class="lineNum">    2713 </span>            :                                         GF_LOG(GF_LOG_ERROR, GF_LOG_CONTAINER, (&quot;[WidgetMan] Failed to allocate widget preference\n&quot;));
<span class="lineNum">    2714 </span>            :                                         continue;
<span class="lineNum">    2715 </span>            :                                 }
<span class="lineNum">    2716 </span>            : 
<span class="lineNum">    2717 </span>            :                                 pref-&gt;name = gf_strdup(att);
<span class="lineNum">    2718 </span>            :                                 gf_list_add(content-&gt;preferences, pref);
<span class="lineNum">    2719 </span>            :                         }
<span class="lineNum">    2720 </span>            :                         att = wm_xml_get_attr(pref_node, &quot;value&quot;);
<span class="lineNum">    2721 </span>            :                         if (att) {
<span class="lineNum">    2722 </span>            :                                 if (pref-&gt;value) gf_free(pref-&gt;value);
<span class="lineNum">    2723 </span>            :                                 pref-&gt;value = gf_strdup(att);
<span class="lineNum">    2724 </span>            :                         }
<span class="lineNum">    2725 </span>            :                         att = wm_xml_get_attr(pref_node, &quot;readOnly&quot;);
<span class="lineNum">    2726 </span>            :                         if (att &amp;&amp; !strcmp(att, &quot;true&quot;)) pref-&gt;flags |= GF_WM_PREF_READONLY;
<span class="lineNum">    2727 </span>            :                         att = wm_xml_get_attr(pref_node, &quot;migratable&quot;);
<span class="lineNum">    2728 </span>            :                         if (att &amp;&amp; !strcmp(att, &quot;saveOnly&quot;)) pref-&gt;flags |= GF_WM_PREF_SAVE;
<span class="lineNum">    2729 </span>            :                         else if (att &amp;&amp; !strcmp(att, &quot;migrateOnly&quot;)) pref-&gt;flags |= GF_WM_PREF_MIGRATE;
<span class="lineNum">    2730 </span>            :                         else pref-&gt;flags |= GF_WM_PREF_SAVE | GF_WM_PREF_MIGRATE;
<span class="lineNum">    2731 </span>            : 
<span class="lineNum">    2732 </span>            :                         att = wm_xml_get_attr(pref_node, &quot;connectTo&quot;);
<span class="lineNum">    2733 </span>            :                         if (att) pref-&gt;connectTo = wm_parse_pin(att, GF_WM_PREF_CONNECT, NULL, NULL, NULL);
<span class="lineNum">    2734 </span>            :                 }
<span class="lineNum">    2735 </span>            : 
<span class="lineNum">    2736 </span>            :                 att = wm_xml_get_attr(context, &quot;savedAction&quot;);
<span class="lineNum">    2737 </span>            :                 if (att) content-&gt;savedAction = wm_parse_pin(att, GF_WM_PREF_SAVEDACTION, NULL, NULL, NULL);
<span class="lineNum">    2738 </span>            :                 att = wm_xml_get_attr(context, &quot;restoredAction&quot;);
<span class="lineNum">    2739 </span>            :                 if (att) content-&gt;restoredAction = wm_parse_pin(att, GF_WM_PREF_RESTOREDACTION, NULL, NULL, NULL);
<span class="lineNum">    2740 </span>            :                 att = wm_xml_get_attr(context, &quot;saveTrigger&quot;);
<span class="lineNum">    2741 </span>            :                 if (att) content-&gt;saveTrigger = wm_parse_pin(att, GF_WM_PREF_SAVETRIGGER, NULL, NULL, NULL);
<span class="lineNum">    2742 </span>            :                 att = wm_xml_get_attr(context, &quot;restoreTrigger&quot;);
<span class="lineNum">    2743 </span>            :                 if (att) content-&gt;restoreTrigger = wm_parse_pin(att, GF_WM_PREF_RESTORETRIGGER, NULL, NULL, NULL);
<span class="lineNum">    2744 </span>            :         }
<span class="lineNum">    2745 </span>            : }
<span class="lineNum">    2746 </span>            : 
<span class="lineNum">    2747 </span>            : /* Implements the W3C P&amp;C rule for getting a single attribute value
<span class="lineNum">    2748 </span>            :    see http://www.w3.org/TR/widgets/#rule-for-getting-a-single-attribute-valu0
<span class="lineNum">    2749 </span>            :    should be different from getting normalized text but for now it's ok
<span class="lineNum">    2750 </span>            :    */
<span class="lineNum">    2751 </span>            : static char *wm_get_single_attribute(const char *input) {
<span class="lineNum">    2752 </span>            :         u32 i, j, len;
<span class="lineNum">    2753 </span>            :         char *output;
<span class="lineNum">    2754 </span>            :         Bool first_space_copied;
<span class="lineNum">    2755 </span>            : 
<span class="lineNum">    2756 </span>            :         if (!input) return gf_strdup(&quot;&quot;);
<span class="lineNum">    2757 </span>            : 
<span class="lineNum">    2758 </span>            :         len = (u32) strlen(input);
<span class="lineNum">    2759 </span>            :         output = gf_malloc(len+1);
<span class="lineNum">    2760 </span>            : 
<span class="lineNum">    2761 </span>            :         first_space_copied = 1;
<span class="lineNum">    2762 </span>            :         j = 0;
<span class="lineNum">    2763 </span>            :         for (i = 0; i&lt;len; i++) {
<span class="lineNum">    2764 </span>            :                 switch (input[i]) {
<span class="lineNum">    2765 </span>            :                 case ' ':
<span class="lineNum">    2766 </span>            :                 case '\t':
<span class="lineNum">    2767 </span>            :                 case '\r':
<span class="lineNum">    2768 </span>            :                 case '\n':
<span class="lineNum">    2769 </span>            :                         if (!first_space_copied) {
<span class="lineNum">    2770 </span>            :                                 output[j] = ' ';
<span class="lineNum">    2771 </span>            :                                 j++;
<span class="lineNum">    2772 </span>            :                                 first_space_copied = 1;
<span class="lineNum">    2773 </span>            :                         }
<span class="lineNum">    2774 </span>            :                         break;
<span class="lineNum">    2775 </span>            :                 default:
<span class="lineNum">    2776 </span>            :                         output[j] = input[i];
<span class="lineNum">    2777 </span>            :                         j++;
<span class="lineNum">    2778 </span>            :                         first_space_copied = 0;
<span class="lineNum">    2779 </span>            :                 }
<span class="lineNum">    2780 </span>            :         }
<span class="lineNum">    2781 </span>            :         if (j &amp;&amp; output[j-1] == ' ') output[j-1] = 0;
<span class="lineNum">    2782 </span>            :         output[j] = 0;
<span class="lineNum">    2783 </span>            :         return output;
<span class="lineNum">    2784 </span>            : }
<span class="lineNum">    2785 </span>            : 
<span class="lineNum">    2786 </span>            : /* Implements the W3C P&amp;C rule for getting a single attribute value
<span class="lineNum">    2787 </span>            :    see http://www.w3.org/TR/widgets/#rule-for-getting-a-single-attribute-valu0 */
<span class="lineNum">    2788 </span>            : static u32 wm_parse_non_neg(const char *input) {
<span class="lineNum">    2789 </span>            :         u32 result = 0;
<span class="lineNum">    2790 </span>            :         if (strlen(input) &amp;&amp; !strchr(input, '-')) {
<span class="lineNum">    2791 </span>            :                 if (sscanf(input, &quot;%u&quot;, &amp;result) != 1) result = 0;
<span class="lineNum">    2792 </span>            :         }
<span class="lineNum">    2793 </span>            :         return result;
<span class="lineNum">    2794 </span>            : }
<span class="lineNum">    2795 </span>            : 
<span class="lineNum">    2796 </span>            : /* returns the localized concatenated text content
<span class="lineNum">    2797 </span>            : see http://www.w3.org/TR/2004/REC-DOM-Level-3-Core-20040407/core.html#Node3-textContent
<span class="lineNum">    2798 </span>            : and http://www.w3.org/TR/widgets/#rule-for-getting-text-content0
<span class="lineNum">    2799 </span>            : */
<span class="lineNum">    2800 </span>            : static char *wm_get_text_content(GF_XMLNode *node, char *inherited_locale, const char *user_locale) {
<span class="lineNum">    2801 </span>            :         if (node-&gt;type == GF_XML_TEXT_TYPE) {
<span class="lineNum">    2802 </span>            :                 if (node-&gt;name) return gf_strdup(node-&gt;name);
<span class="lineNum">    2803 </span>            :                 else return gf_strdup(&quot;&quot;);
<span class="lineNum">    2804 </span>            :         } else {
<span class="lineNum">    2805 </span>            :                 char *xml_lang = (char *)wm_xml_get_attr(node, &quot;xml:lang&quot;);
<span class="lineNum">    2806 </span>            :                 if (!xml_lang) xml_lang = inherited_locale;
<span class="lineNum">    2807 </span>            :                 /*
<span class="lineNum">    2808 </span>            :                 if (xml_lang &amp;&amp; user_locale &amp;&amp; wm_check_language(xml_lang, user_locale))
<span class="lineNum">    2809 </span>            :                 */
<span class="lineNum">    2810 </span>            :                 {
<span class="lineNum">    2811 </span>            :                         u32 i, count;
<span class="lineNum">    2812 </span>            :                         char *text_content;
<span class="lineNum">    2813 </span>            :                         u32 text_content_len = 0;
<span class="lineNum">    2814 </span>            :                         text_content = gf_strdup(&quot;&quot;);
<span class="lineNum">    2815 </span>            :                         count = gf_list_count(node-&gt;content);
<span class="lineNum">    2816 </span>            :                         for (i=0; i&lt;count; i++) {
<span class="lineNum">    2817 </span>            :                                 GF_XMLNode *child = (GF_XMLNode *)gf_list_get(node-&gt;content, i);
<span class="lineNum">    2818 </span>            :                                 char *child_content = wm_get_text_content(child, xml_lang, user_locale);
<span class="lineNum">    2819 </span>            :                                 u32 child_content_len = (u32) strlen(child_content);
<span class="lineNum">    2820 </span>            :                                 text_content = gf_realloc(text_content, text_content_len+child_content_len+1);
<span class="lineNum">    2821 </span>            :                                 memcpy(text_content+text_content_len, child_content, child_content_len);
<span class="lineNum">    2822 </span>            :                                 text_content[text_content_len+child_content_len] = 0;
<span class="lineNum">    2823 </span>            :                                 text_content_len+=child_content_len;
<span class="lineNum">    2824 </span>            :                                 gf_free(child_content);
<span class="lineNum">    2825 </span>            :                         }
<span class="lineNum">    2826 </span>            :                         return text_content;
<span class="lineNum">    2827 </span>            :                 }
<span class="lineNum">    2828 </span>            :                 /*
<span class="lineNum">    2829 </span>            :                 } else {
<span class="lineNum">    2830 </span>            :                         return gf_strdup(&quot;&quot;);
<span class="lineNum">    2831 </span>            :                 */
<span class="lineNum">    2832 </span>            :         }
<span class="lineNum">    2833 </span>            : }
<span class="lineNum">    2834 </span>            : 
<span class="lineNum">    2835 </span>            : static char *wm_get_normalized_text_content(GF_XMLNode *node, char *inherited_locale, const char *user_locale) {
<span class="lineNum">    2836 </span>            :         char *text_content, *result;
<span class="lineNum">    2837 </span>            :         /* first aggregate text content */
<span class="lineNum">    2838 </span>            :         text_content = wm_get_text_content(node, inherited_locale, user_locale);
<span class="lineNum">    2839 </span>            :         /* calling normalization of text content */
<span class="lineNum">    2840 </span>            :         result = wm_get_single_attribute(text_content);
<span class="lineNum">    2841 </span>            :         gf_free(text_content);
<span class="lineNum">    2842 </span>            :         return result;
<span class="lineNum">    2843 </span>            : }
<span class="lineNum">    2844 </span>            : 
<span class="lineNum">    2845 </span>            : /* When relocating resources over HTTP, we check if the resources for a given locale exists
<span class="lineNum">    2846 </span>            :   on the server by sending a HEAD message with an Accept-Language header. */
<span class="lineNum">    2847 </span>            : void wm_relocate_proc(void *usr_cbk, GF_NETIO_Parameter *parameter)
<span class="lineNum">    2848 </span>            : {
<span class="lineNum">    2849 </span>            :         switch (parameter-&gt;msg_type) {
<span class="lineNum">    2850 </span>            :         case GF_NETIO_GET_METHOD:
<span class="lineNum">    2851 </span>            :                 parameter-&gt;name = &quot;HEAD&quot;;
<span class="lineNum">    2852 </span>            :                 break;
<span class="lineNum">    2853 </span>            :         default:
<span class="lineNum">    2854 </span>            :                 return;
<span class="lineNum">    2855 </span>            :         }
<span class="lineNum">    2856 </span>            : }
<span class="lineNum">    2857 </span>            : 
<span class="lineNum">    2858 </span>            : /* relocate the given resource name (res_name) using registered relocators (e.g. locales, package folder)
<span class="lineNum">    2859 </span>            :    The result is the path of the file, possibly uncompressed, possibly localized.
<span class="lineNum">    2860 </span>            :    The parameter widget_path provides the path for converting relative resource paths into absolute paths.*/
<span class="lineNum">    2861 </span>            : static Bool wm_relocate_url(GF_WidgetManager *wm, const char *widget_path, const char *res_name, char *relocated_name, char *localized_res_name)
<span class="lineNum">    2862 </span>            : {
<span class="lineNum">    2863 </span>            :         Bool ok = 0;
<span class="lineNum">    2864 </span>            :         char *res_url;
<span class="lineNum">    2865 </span>            :         Bool result = gf_term_relocate_url(wm-&gt;term, res_name, widget_path, relocated_name, localized_res_name);
<span class="lineNum">    2866 </span>            :         if (result) return result;
<span class="lineNum">    2867 </span>            : 
<span class="lineNum">    2868 </span>            :         res_url = gf_url_concatenate(widget_path, res_name);
<span class="lineNum">    2869 </span>            : 
<span class="lineNum">    2870 </span>            :         /*try with HTTP HEAD */
<span class="lineNum">    2871 </span>            :         if (!strnicmp(widget_path, &quot;http&quot;, 4)) {
<span class="lineNum">    2872 </span>            :                 GF_Err e;
<span class="lineNum">    2873 </span>            :                 /*fetch the remote widget manifest synchronously and load it */
<span class="lineNum">    2874 </span>            :                 GF_DownloadSession *sess = gf_dm_sess_new(wm-&gt;term-&gt;downloader, (char *)res_url, GF_NETIO_SESSION_NOT_THREADED, wm_relocate_proc, NULL, &amp;e);
<span class="lineNum">    2875 </span>            :                 if (sess) {
<span class="lineNum">    2876 </span>            :                         e = gf_dm_sess_process(sess);
<span class="lineNum">    2877 </span>            :                         gf_dm_sess_del(sess);
<span class="lineNum">    2878 </span>            :                         if (e==GF_OK) {
<span class="lineNum">    2879 </span>            :                                 const char *opt = gf_cfg_get_key(wm-&gt;term-&gt;user-&gt;config, &quot;Systems&quot;, &quot;Language2CC&quot;);
<span class="lineNum">    2880 </span>            :                                 strcpy(relocated_name, res_url);
<span class="lineNum">    2881 </span>            :                                 if (opt)
<span class="lineNum">    2882 </span>            :                                         sprintf(localized_res_name, &quot;%s/%s&quot;, opt, res_name);
<span class="lineNum">    2883 </span>            :                                 else
<span class="lineNum">    2884 </span>            :                                         strcpy(localized_res_name, res_name);
<span class="lineNum">    2885 </span>            :                                 ok = 1;
<span class="lineNum">    2886 </span>            :                         }
<span class="lineNum">    2887 </span>            :                 }
<span class="lineNum">    2888 </span>            :         }
<span class="lineNum">    2889 </span>            :         gf_free(res_url);
<span class="lineNum">    2890 </span>            :         return ok;
<span class="lineNum">    2891 </span>            : }
<span class="lineNum">    2892 </span>            : 
<span class="lineNum">    2893 </span>            : /* function that checks if the default start file exists in the widget (package or folder)
<span class="lineNum">    2894 </span>            :    according to the default start files table from the W3C P&amp;C spec.
<span class="lineNum">    2895 </span>            :    The widget path attribute is used to get the associated relocator from the registered relocators */
<span class="lineNum">    2896 </span>            : static void wm_set_default_start_file(GF_WidgetManager *wm, GF_WidgetContent *content, const char *widget_path) {
<span class="lineNum">    2897 </span>            :         Bool result;
<span class="lineNum">    2898 </span>            :         char localized_path[GF_MAX_PATH], relocated_path[GF_MAX_PATH];
<span class="lineNum">    2899 </span>            :         char *mimetype = &quot;text/html&quot;;
<span class="lineNum">    2900 </span>            :         result = wm_relocate_url(wm, widget_path, &quot;index.htm&quot;, relocated_path, localized_path);
<span class="lineNum">    2901 </span>            :         if (result) {
<span class="lineNum">    2902 </span>            :                 mimetype = &quot;text/html&quot;;
<span class="lineNum">    2903 </span>            :         } else {
<span class="lineNum">    2904 </span>            :                 result = wm_relocate_url(wm, widget_path, &quot;index.html&quot;, relocated_path, localized_path);
<span class="lineNum">    2905 </span>            :                 if (result) {
<span class="lineNum">    2906 </span>            :                         mimetype = &quot;text/html&quot;;
<span class="lineNum">    2907 </span>            :                 } else {
<span class="lineNum">    2908 </span>            :                         result = wm_relocate_url(wm, widget_path, &quot;index.svg&quot;, relocated_path, localized_path);
<span class="lineNum">    2909 </span>            :                         if (result) {
<span class="lineNum">    2910 </span>            :                                 mimetype = &quot;image/svg+xml&quot;;
<span class="lineNum">    2911 </span>            :                         } else {
<span class="lineNum">    2912 </span>            :                                 result = wm_relocate_url(wm, widget_path, &quot;index.xhtml&quot;, relocated_path, localized_path);
<span class="lineNum">    2913 </span>            :                                 if (result) {
<span class="lineNum">    2914 </span>            :                                         mimetype = &quot;application/xhtml+xml&quot;;
<span class="lineNum">    2915 </span>            :                                 } else {
<span class="lineNum">    2916 </span>            :                                         result = wm_relocate_url(wm, widget_path, &quot;index.xht&quot;, relocated_path, localized_path);
<span class="lineNum">    2917 </span>            :                                         if (result) mimetype = &quot;application/xhtml+xml&quot;;
<span class="lineNum">    2918 </span>            :                                 }
<span class="lineNum">    2919 </span>            :                         }
<span class="lineNum">    2920 </span>            :                 }
<span class="lineNum">    2921 </span>            :         }
<span class="lineNum">    2922 </span>            :         if (content-&gt;src) gf_free(content-&gt;src);
<span class="lineNum">    2923 </span>            :         content-&gt;src = gf_strdup(localized_path);
<span class="lineNum">    2924 </span>            :         if (content-&gt;relocated_src) gf_free(content-&gt;relocated_src);
<span class="lineNum">    2925 </span>            :         content-&gt;relocated_src = gf_strdup(relocated_path);
<span class="lineNum">    2926 </span>            :         if (content-&gt;mimetype) gf_free(content-&gt;mimetype);
<span class="lineNum">    2927 </span>            :         content-&gt;mimetype = gf_strdup(mimetype);
<span class="lineNum">    2928 </span>            :         if (content-&gt;encoding) gf_free(content-&gt;encoding);
<span class="lineNum">    2929 </span>            :         content-&gt;encoding = gf_strdup(&quot;utf-8&quot;);
<span class="lineNum">    2930 </span>            : }
<span class="lineNum">    2931 </span>            : 
<span class="lineNum">    2932 </span>            : static GF_WidgetContent *wm_add_icon(GF_Widget *widget, const char *icon_relocated_path, const char *icon_localized_path, const char *uri_fragment)
<span class="lineNum">    2933 </span>            : {
<span class="lineNum">    2934 </span>            :         GF_WidgetContent *icon;
<span class="lineNum">    2935 </span>            :         u32 i, count;
<span class="lineNum">    2936 </span>            :         Bool already_in = 0;
<span class="lineNum">    2937 </span>            : 
<span class="lineNum">    2938 </span>            :         count = gf_list_count(widget-&gt;icons);
<span class="lineNum">    2939 </span>            :         for (i =0; i&lt;count; i++) {
<span class="lineNum">    2940 </span>            :                 GF_WidgetContent *in_icon = gf_list_get(widget-&gt;icons, i);
<span class="lineNum">    2941 </span>            :                 if (!strcmp(icon_localized_path, in_icon-&gt;src)) {
<span class="lineNum">    2942 </span>            :                         already_in = 1;
<span class="lineNum">    2943 </span>            :                         break;
<span class="lineNum">    2944 </span>            :                 }
<span class="lineNum">    2945 </span>            :         }
<span class="lineNum">    2946 </span>            :         if (already_in) return NULL;
<span class="lineNum">    2947 </span>            : 
<span class="lineNum">    2948 </span>            :         GF_SAFEALLOC(icon, GF_WidgetContent);
<span class="lineNum">    2949 </span>            :         if (!icon) return NULL;
<span class="lineNum">    2950 </span>            :         
<span class="lineNum">    2951 </span>            :         if (uri_fragment) {
<span class="lineNum">    2952 </span>            :                 icon-&gt;src = gf_malloc(strlen(icon_localized_path) + strlen(uri_fragment) + 1);
<span class="lineNum">    2953 </span>            :                 if (icon-&gt;src) {
<span class="lineNum">    2954 </span>            :                         strcpy(icon-&gt;src, icon_localized_path);
<span class="lineNum">    2955 </span>            :                         strcat(icon-&gt;src, uri_fragment);
<span class="lineNum">    2956 </span>            :                 }
<span class="lineNum">    2957 </span>            :                 icon-&gt;relocated_src = gf_malloc(strlen(icon_relocated_path) + strlen(uri_fragment) + 1);
<span class="lineNum">    2958 </span>            :                 if (icon-&gt;relocated_src) {
<span class="lineNum">    2959 </span>            :                         strcpy(icon-&gt;relocated_src, icon_relocated_path);
<span class="lineNum">    2960 </span>            :                         strcat(icon-&gt;relocated_src, uri_fragment);
<span class="lineNum">    2961 </span>            :                 }
<span class="lineNum">    2962 </span>            :         } else {
<span class="lineNum">    2963 </span>            :                 icon-&gt;src = gf_strdup(icon_localized_path);
<span class="lineNum">    2964 </span>            :                 icon-&gt;relocated_src = gf_strdup(icon_relocated_path);
<span class="lineNum">    2965 </span>            :         }
<span class="lineNum">    2966 </span>            :         icon-&gt;interfaces = gf_list_new();
<span class="lineNum">    2967 </span>            :         icon-&gt;components = gf_list_new();
<span class="lineNum">    2968 </span>            :         icon-&gt;preferences = gf_list_new();
<span class="lineNum">    2969 </span>            :         icon-&gt;widget = widget;
<span class="lineNum">    2970 </span>            :         gf_list_add(widget-&gt;icons, icon);
<span class="lineNum">    2971 </span>            :         return icon;
<span class="lineNum">    2972 </span>            : }
<span class="lineNum">    2973 </span>            : 
<span class="lineNum">    2974 </span>            : /* Scans the W3C default icons table and add each icon */
<span class="lineNum">    2975 </span>            : static void wm_set_default_icon_files(GF_WidgetManager *wm, const char *widget_path, GF_Widget *widget) {
<span class="lineNum">    2976 </span>            :         char relocated_path[GF_MAX_PATH], localized_path[GF_MAX_PATH];
<span class="lineNum">    2977 </span>            :         Bool result;
<span class="lineNum">    2978 </span>            : 
<span class="lineNum">    2979 </span>            :         result = wm_relocate_url(wm, widget_path, &quot;icon.svg&quot;, relocated_path, localized_path);
<span class="lineNum">    2980 </span>            :         if (result) wm_add_icon(widget, relocated_path, localized_path, NULL);
<span class="lineNum">    2981 </span>            : 
<span class="lineNum">    2982 </span>            :         result = wm_relocate_url(wm, widget_path, &quot;icon.ico&quot;, relocated_path, localized_path);
<span class="lineNum">    2983 </span>            :         if (result) wm_add_icon(widget, relocated_path, localized_path, NULL);
<span class="lineNum">    2984 </span>            : 
<span class="lineNum">    2985 </span>            :         result = wm_relocate_url(wm, widget_path, &quot;icon.png&quot;, relocated_path, localized_path);
<span class="lineNum">    2986 </span>            :         if (result) wm_add_icon(widget, relocated_path, localized_path, NULL);
<span class="lineNum">    2987 </span>            : 
<span class="lineNum">    2988 </span>            :         result = wm_relocate_url(wm, widget_path, &quot;icon.gif&quot;, relocated_path, localized_path);
<span class="lineNum">    2989 </span>            :         if (result) wm_add_icon(widget, relocated_path, localized_path, NULL);
<span class="lineNum">    2990 </span>            : 
<span class="lineNum">    2991 </span>            :         result = wm_relocate_url(wm, widget_path, &quot;icon.jpg&quot;, relocated_path, localized_path);
<span class="lineNum">    2992 </span>            :         if (result) wm_add_icon(widget, relocated_path, localized_path, NULL);
<span class="lineNum">    2993 </span>            : }
<span class="lineNum">    2994 </span>            : 
<span class="lineNum">    2995 </span>            : GF_WidgetInstance *wm_load_widget(GF_WidgetManager *wm, const char *path, u32 InstanceID, Bool skip_context)
<span class="lineNum">    2996 </span>            : {
<span class="lineNum">    2997 </span>            :         char szName[GF_MAX_PATH];
<span class="lineNum">    2998 </span>            :         u32 i, count;
<span class="lineNum">    2999 </span>            :         GF_Widget *widget = NULL;
<span class="lineNum">    3000 </span>            :         GF_WidgetInstance *wi = NULL;
<span class="lineNum">    3001 </span>            :         GF_XMLNode *root, *icon, *nmain, *name, *xml_node;
<span class="lineNum">    3002 </span>            :         GF_Err e;
<span class="lineNum">    3003 </span>            :         GF_DOMParser *dom = NULL;
<span class="lineNum">    3004 </span>            :         GF_WidgetPackage *wpackage = NULL;
<span class="lineNum">    3005 </span>            : 
<span class="lineNum">    3006 </span>            :         GF_DownloadSession *sess = NULL;
<span class="lineNum">    3007 </span>            :         const char *widget_ns_prefix = NULL;
<span class="lineNum">    3008 </span>            :         const char *mpegu_ns_prefix = NULL;
<span class="lineNum">    3009 </span>            :         const char *user_locale = gf_cfg_get_key(wm-&gt;term-&gt;user-&gt;config, &quot;Systems&quot;, &quot;Language2CC&quot;);
<span class="lineNum">    3010 </span>            : 
<span class="lineNum">    3011 </span>            :         /* Try to see if this widget is already loaded */
<span class="lineNum">    3012 </span>            :         e = GF_OK;
<span class="lineNum">    3013 </span>            :         count = gf_list_count(wm-&gt;widgets);
<span class="lineNum">    3014 </span>            :         for (i=0; i&lt;count; i++) {
<span class="lineNum">    3015 </span>            :                 widget = gf_list_get(wm-&gt;widgets, i);
<span class="lineNum">    3016 </span>            :                 if (!strcmp(widget-&gt;url, path)) break;
<span class="lineNum">    3017 </span>            :                 widget = NULL;
<span class="lineNum">    3018 </span>            :         }
<span class="lineNum">    3019 </span>            : 
<span class="lineNum">    3020 </span>            :         /*not found, retrieve the widget (if http), check the package if needed and parse the configuration document/widget manifest*/
<span class="lineNum">    3021 </span>            :         if (!widget) {
<span class="lineNum">    3022 </span>            :                 Bool isDownloadedPackage = 0;
<span class="lineNum">    3023 </span>            : 
<span class="lineNum">    3024 </span>            :                 /* path used to locate the widget (config.xml if unpackaged or zip/isoff package), potentially after download */
<span class="lineNum">    3025 </span>            :                 const char *szLocalPath = path;
<span class="lineNum">    3026 </span>            :                 /* used to locate the config document/widget manifest potentially after unzipping */
<span class="lineNum">    3027 </span>            :                 const char *szManifestPath = path;
<span class="lineNum">    3028 </span>            :                 /* */
<span class="lineNum">    3029 </span>            :                 const char *szWidgetPath = path;
<span class="lineNum">    3030 </span>            :                 const char *desc;
<span class="lineNum">    3031 </span>            :                 GF_WidgetPreference *pref;
<span class="lineNum">    3032 </span>            :                 GF_List *global_prefs;
<span class="lineNum">    3033 </span>            :                 GF_WidgetContent *content;
<span class="lineNum">    3034 </span>            :                 Bool correct_ns = 0;
<span class="lineNum">    3035 </span>            : 
<span class="lineNum">    3036 </span>            :                 if (strstr(path, &quot;http://&quot;)) {
<span class="lineNum">    3037 </span>            :                         /*fetch the remote widget manifest synchronously and load it */
<span class="lineNum">    3038 </span>            :                         sess = gf_dm_sess_new(wm-&gt;term-&gt;downloader, (char *)path, GF_NETIO_SESSION_NOT_THREADED, NULL, NULL, &amp;e);
<span class="lineNum">    3039 </span>            :                         if (sess) {
<span class="lineNum">    3040 </span>            :                                 e = gf_dm_sess_process(sess);
<span class="lineNum">    3041 </span>            :                                 if (e==GF_OK) {
<span class="lineNum">    3042 </span>            :                                         szLocalPath = gf_dm_sess_get_cache_name(sess);
<span class="lineNum">    3043 </span>            : 
<span class="lineNum">    3044 </span>            :                                         if (gf_unzip_probe(szLocalPath)) {
<span class="lineNum">    3045 </span>            :                                                 isDownloadedPackage = 1;
<span class="lineNum">    3046 </span>            :                                         } else {
<span class="lineNum">    3047 </span>            :                                                 /* TODO ISOFF-based packaged widget */
<span class="lineNum">    3048 </span>            :                                         }
<span class="lineNum">    3049 </span>            :                                 }
<span class="lineNum">    3050 </span>            :                         }
<span class="lineNum">    3051 </span>            :                         if (!sess || (e!=GF_OK) || !szLocalPath) goto exit;
<span class="lineNum">    3052 </span>            :                 }
<span class="lineNum">    3053 </span>            : 
<span class="lineNum">    3054 </span>            :                 /* Check if the widget package is a valid package and if it contains a config.xml file */
<span class="lineNum">    3055 </span>            :                 szManifestPath = szLocalPath;
<span class="lineNum">    3056 </span>            : 
<span class="lineNum">    3057 </span>            :                 wpackage = widget_package_new(wm, szLocalPath);
<span class="lineNum">    3058 </span>            :                 if (wpackage) {
<span class="lineNum">    3059 </span>            :                         count = gf_list_count(wpackage-&gt;resources);
<span class="lineNum">    3060 </span>            :                         for (i=0; i&lt;count; i++) {
<span class="lineNum">    3061 </span>            :                                 GF_WidgetPackageResource *wu = gf_list_get(wpackage-&gt;resources, i);
<span class="lineNum">    3062 </span>            :                                 /* According to W3C WPC, the config.xml file (lower case) shall only be located
<span class="lineNum">    3063 </span>            :                                    at the root of the package
<span class="lineNum">    3064 </span>            :                                    see http://www.w3.org/TR/widgets/#ta-dxzVDWpaWg */
<span class="lineNum">    3065 </span>            :                                 if (!strcmp(wu-&gt;inner_path, &quot;config.xml&quot;)) {
<span class="lineNum">    3066 </span>            :                                         szManifestPath = wu-&gt;extracted_path;
<span class="lineNum">    3067 </span>            :                                         break;
<span class="lineNum">    3068 </span>            :                                 }
<span class="lineNum">    3069 </span>            :                         }
<span class="lineNum">    3070 </span>            :                         szWidgetPath = szManifestPath;
<span class="lineNum">    3071 </span>            :                 }
<span class="lineNum">    3072 </span>            : 
<span class="lineNum">    3073 </span>            : 
<span class="lineNum">    3074 </span>            :                 /* Parse the Widget Config Document as a DOM */
<span class="lineNum">    3075 </span>            :                 dom = gf_xml_dom_new();
<span class="lineNum">    3076 </span>            :                 e = gf_xml_dom_parse(dom, szManifestPath, NULL, NULL);
<span class="lineNum">    3077 </span>            :                 if (e) goto exit;
<span class="lineNum">    3078 </span>            : 
<span class="lineNum">    3079 </span>            :                 root = gf_xml_dom_get_root(dom);
<span class="lineNum">    3080 </span>            :                 if (!root) goto exit;
<span class="lineNum">    3081 </span>            : 
<span class="lineNum">    3082 </span>            :                 correct_ns = 0;
<span class="lineNum">    3083 </span>            :                 count = gf_list_count(root-&gt;attributes);
<span class="lineNum">    3084 </span>            :                 for (i=0; i&lt;count; i++) {
<span class="lineNum">    3085 </span>            :                         GF_XMLAttribute *att = gf_list_get(root-&gt;attributes, i);
<span class="lineNum">    3086 </span>            :                         if (att-&gt;name) {
<span class="lineNum">    3087 </span>            :                                 if (!strcmp(att-&gt;name, &quot;xmlns&quot;)) {
<span class="lineNum">    3088 </span>            :                                         if (!strcmp(att-&gt;value, &quot;http://www.w3.org/ns/widgets&quot;)) {
<span class="lineNum">    3089 </span>            :                                                 correct_ns = 1;
<span class="lineNum">    3090 </span>            :                                         }
<span class="lineNum">    3091 </span>            :                                 } else if (!strnicmp(att-&gt;name, &quot;xmlns:&quot;, 6)) {
<span class="lineNum">    3092 </span>            :                                         if (!strcmp(att-&gt;value, &quot;http://www.w3.org/ns/widgets&quot;)) {
<span class="lineNum">    3093 </span>            :                                                 widget_ns_prefix = att-&gt;name+6;
<span class="lineNum">    3094 </span>            :                                                 correct_ns = 1;
<span class="lineNum">    3095 </span>            :                                         } else if (!strcmp(att-&gt;value, &quot;urn:mpeg:mpegu:schema:widgets:manifest:2010&quot;)) {
<span class="lineNum">    3096 </span>            :                                                 mpegu_ns_prefix = att-&gt;name+6;
<span class="lineNum">    3097 </span>            :                                         }
<span class="lineNum">    3098 </span>            :                                 }
<span class="lineNum">    3099 </span>            :                         }
<span class="lineNum">    3100 </span>            :                 }
<span class="lineNum">    3101 </span>            :                 /* According to the spec, wrong or no namespace means invalid widget
<span class="lineNum">    3102 </span>            :                 see http://www.w3.org/TR/widgets/#ta-ACCJfDGwDQ */
<span class="lineNum">    3103 </span>            :                 if (!correct_ns) goto exit;
<span class="lineNum">    3104 </span>            : 
<span class="lineNum">    3105 </span>            :                 /* see http://www.w3.org/TR/widgets/#ta-ACCJfDGwDQ */
<span class="lineNum">    3106 </span>            :                 if ((root-&gt;ns &amp;&amp; (!widget_ns_prefix || strcmp(root-&gt;ns, widget_ns_prefix) || strcmp(root-&gt;name, &quot;widget&quot;))) ||
<span class="lineNum">    3107 </span>            :                         (!root-&gt;ns &amp;&amp; (widget_ns_prefix || strcmp(root-&gt;name, &quot;widget&quot;))))
<span class="lineNum">    3108 </span>            :                         goto exit;
<span class="lineNum">    3109 </span>            : 
<span class="lineNum">    3110 </span>            : 
<span class="lineNum">    3111 </span>            :                 /*pre-parse the root-level preference for use when parsing MPEG-U elements */
<span class="lineNum">    3112 </span>            :                 global_prefs = gf_list_new();
<span class="lineNum">    3113 </span>            :                 i=0;
<span class="lineNum">    3114 </span>            :                 while ((nmain = gf_list_enum(root-&gt;content, &amp;i))) {
<span class="lineNum">    3115 </span>            :                         const char *pname, *pvalue;
<span class="lineNum">    3116 </span>            :                         /* 'normalized' preference name and readonly*/
<span class="lineNum">    3117 </span>            :                         char *npname, *npro;
<span class="lineNum">    3118 </span>            :                         u32 i, count;
<span class="lineNum">    3119 </span>            :                         Bool pref_exists = 0;
<span class="lineNum">    3120 </span>            :                         Bool readOnly = 0;
<span class="lineNum">    3121 </span>            :                         if (nmain-&gt;type != GF_XML_NODE_TYPE) continue;
<span class="lineNum">    3122 </span>            :                         if (strcmp(nmain-&gt;name, &quot;preference&quot;)) continue;
<span class="lineNum">    3123 </span>            :                         pname = wm_xml_get_attr(nmain, &quot;name&quot;);
<span class="lineNum">    3124 </span>            :                         npname = wm_get_single_attribute(pname);
<span class="lineNum">    3125 </span>            :                         if (!npname || !strlen(npname)) continue;
<span class="lineNum">    3126 </span>            : 
<span class="lineNum">    3127 </span>            :                         count = gf_list_count(global_prefs);
<span class="lineNum">    3128 </span>            :                         for (i = 0; i &lt; count; i++) {
<span class="lineNum">    3129 </span>            :                                 GF_WidgetPreference *tmp_pref = gf_list_get(global_prefs, i);
<span class="lineNum">    3130 </span>            :                                 if (!strcmp(tmp_pref-&gt;name, npname)) {
<span class="lineNum">    3131 </span>            :                                         pref_exists = 1;
<span class="lineNum">    3132 </span>            :                                         break;
<span class="lineNum">    3133 </span>            :                                 }
<span class="lineNum">    3134 </span>            :                         }
<span class="lineNum">    3135 </span>            :                         if (pref_exists) continue;
<span class="lineNum">    3136 </span>            : 
<span class="lineNum">    3137 </span>            :                         pvalue = wm_xml_get_attr(nmain, &quot;readonly&quot;);
<span class="lineNum">    3138 </span>            :                         npro = wm_get_single_attribute(pvalue);
<span class="lineNum">    3139 </span>            :                         if (npro &amp;&amp; strlen(npro) &amp;&amp; !strcmp(npro, &quot;true&quot;)) readOnly=1;
<span class="lineNum">    3140 </span>            :                         if (npro) gf_free(npro);
<span class="lineNum">    3141 </span>            : 
<span class="lineNum">    3142 </span>            :                         pvalue = wm_xml_get_attr(nmain, &quot;value&quot;);
<span class="lineNum">    3143 </span>            : 
<span class="lineNum">    3144 </span>            :                         GF_SAFEALLOC(pref, GF_WidgetPreference);
<span class="lineNum">    3145 </span>            :                         pref-&gt;name = npname;
<span class="lineNum">    3146 </span>            :                         if (pvalue) pref-&gt;value = wm_get_single_attribute(pvalue);
<span class="lineNum">    3147 </span>            :                         /*global preferences are save and migratable*/
<span class="lineNum">    3148 </span>            :                         pref-&gt;flags = GF_WM_PREF_SAVE | GF_WM_PREF_MIGRATE;
<span class="lineNum">    3149 </span>            :                         if (readOnly) pref-&gt;flags |= GF_WM_PREF_READONLY;
<span class="lineNum">    3150 </span>            :                         gf_list_add(global_prefs, pref);
<span class="lineNum">    3151 </span>            :                 }
<span class="lineNum">    3152 </span>            : 
<span class="lineNum">    3153 </span>            :                 /* get the content element from the XML Config document */
<span class="lineNum">    3154 </span>            :                 GF_SAFEALLOC(content, GF_WidgetContent);
<span class="lineNum">    3155 </span>            :                 if (!content) {
<span class="lineNum">    3156 </span>            :                         e = GF_OUT_OF_MEM;
<span class="lineNum">    3157 </span>            :                         goto exit;
<span class="lineNum">    3158 </span>            :                 }
<span class="lineNum">    3159 </span>            :                 content-&gt;interfaces = gf_list_new();
<span class="lineNum">    3160 </span>            :                 content-&gt;components = gf_list_new();
<span class="lineNum">    3161 </span>            :                 content-&gt;preferences = gf_list_new();
<span class="lineNum">    3162 </span>            :                 nmain = wm_xml_find(root, widget_ns_prefix, &quot;content&quot;, NULL);
<span class="lineNum">    3163 </span>            :                 if (!nmain) {
<span class="lineNum">    3164 </span>            :                         /* if not found, use the default table of start files */
<span class="lineNum">    3165 </span>            :                         wm_set_default_start_file(wm, content, szWidgetPath);
<span class="lineNum">    3166 </span>            :                 } else {
<span class="lineNum">    3167 </span>            :                         const char *src, *encoding, *mimetype;
<span class="lineNum">    3168 </span>            :                         src = wm_xml_get_attr(nmain, &quot;src&quot;);
<span class="lineNum">    3169 </span>            : 
<span class="lineNum">    3170 </span>            :                         /*check the resource exists*/
<span class="lineNum">    3171 </span>            :                         if (src) {
<span class="lineNum">    3172 </span>            :                                 Bool result;
<span class="lineNum">    3173 </span>            :                                 char relocated_path[GF_MAX_PATH], localized_path[GF_MAX_PATH];
<span class="lineNum">    3174 </span>            :                                 /*remove any existing fragment*/
<span class="lineNum">    3175 </span>            :                                 char *sep = strchr(src, '#');
<span class="lineNum">    3176 </span>            :                                 if (sep) sep[0] = 0;
<span class="lineNum">    3177 </span>            :                                 result = wm_relocate_url(wm, szWidgetPath, src, relocated_path, localized_path);
<span class="lineNum">    3178 </span>            :                                 if (sep) sep[0] = '#';
<span class="lineNum">    3179 </span>            :                                 if (result) {
<span class="lineNum">    3180 </span>            :                                         content-&gt;relocated_src = gf_strdup(relocated_path);
<span class="lineNum">    3181 </span>            :                                         content-&gt;src = gf_strdup(localized_path);
<span class="lineNum">    3182 </span>            :                                 }
<span class="lineNum">    3183 </span>            :                         }
<span class="lineNum">    3184 </span>            : 
<span class="lineNum">    3185 </span>            :                         encoding = wm_xml_get_attr(nmain, &quot;encoding&quot;);
<span class="lineNum">    3186 </span>            :                         if (encoding &amp;&amp; strlen(encoding)) content-&gt;encoding = wm_get_single_attribute(encoding);
<span class="lineNum">    3187 </span>            :                         else content-&gt;encoding = gf_strdup(&quot;utf-8&quot;);
<span class="lineNum">    3188 </span>            : 
<span class="lineNum">    3189 </span>            :                         mimetype = wm_xml_get_attr(nmain, &quot;type&quot;);
<span class="lineNum">    3190 </span>            :                         if (mimetype &amp;&amp; strlen(mimetype)) {
<span class="lineNum">    3191 </span>            :                                 char *sep = strchr(mimetype, ';');
<span class="lineNum">    3192 </span>            :                                 if (sep) sep[0] = 0;
<span class="lineNum">    3193 </span>            :                                 content-&gt;mimetype = wm_get_single_attribute(mimetype);
<span class="lineNum">    3194 </span>            :                                 if (sep) sep[0] = ';';
<span class="lineNum">    3195 </span>            :                         }
<span class="lineNum">    3196 </span>            :                         else content-&gt;mimetype = gf_strdup(&quot;text/html&quot;);
<span class="lineNum">    3197 </span>            : 
<span class="lineNum">    3198 </span>            :                         if (!content-&gt;relocated_src) wm_set_default_start_file(wm, content, szWidgetPath);
<span class="lineNum">    3199 </span>            :                 }
<span class="lineNum">    3200 </span>            :                 if (strlen(content-&gt;relocated_src) == 0) {
<span class="lineNum">    3201 </span>            :                         gf_list_del(content-&gt;interfaces);
<span class="lineNum">    3202 </span>            :                         gf_list_del(content-&gt;components);
<span class="lineNum">    3203 </span>            :                         gf_list_del(content-&gt;preferences);
<span class="lineNum">    3204 </span>            :                         gf_free(content);
<span class="lineNum">    3205 </span>            :                         content = NULL;
<span class="lineNum">    3206 </span>            :                         goto exit;
<span class="lineNum">    3207 </span>            :                 }
<span class="lineNum">    3208 </span>            :                 /* We need to call the parse of the MPEG-U elements to clone the global preferences into widget preferences,
<span class="lineNum">    3209 </span>            :                    this should probably be changed to extract the clone from that function */
<span class="lineNum">    3210 </span>            :                 wm_parse_mpegu_content_element(content, nmain, mpegu_ns_prefix, global_prefs);
<span class="lineNum">    3211 </span>            : 
<span class="lineNum">    3212 </span>            :                 GF_SAFEALLOC(widget, GF_Widget);
<span class="lineNum">    3213 </span>            :                 if (!widget) {
<span class="lineNum">    3214 </span>            :                         e = GF_OUT_OF_MEM;
<span class="lineNum">    3215 </span>            :                         goto exit;
<span class="lineNum">    3216 </span>            :                 }
<span class="lineNum">    3217 </span>            :                 widget-&gt;url = gf_strdup(path);
<span class="lineNum">    3218 </span>            :                 widget-&gt;manifest_path = gf_strdup(szManifestPath);
<span class="lineNum">    3219 </span>            :                 if (isDownloadedPackage) widget-&gt;local_path = gf_strdup(szLocalPath);
<span class="lineNum">    3220 </span>            :                 widget-&gt;wm = wm;
<span class="lineNum">    3221 </span>            :                 widget-&gt;main = content;
<span class="lineNum">    3222 </span>            :                 content-&gt;widget = widget;
<span class="lineNum">    3223 </span>            :                 widget-&gt;icons = gf_list_new();
<span class="lineNum">    3224 </span>            :                 widget-&gt;features = gf_list_new();
<span class="lineNum">    3225 </span>            :                 if (wpackage) {
<span class="lineNum">    3226 </span>            :                         widget-&gt;wpack = wpackage;
<span class="lineNum">    3227 </span>            :                         wpackage-&gt;widget = widget;
<span class="lineNum">    3228 </span>            :                         /*attach downloader to our package to avoid destroying the cache file*/
<span class="lineNum">    3229 </span>            :                         wpackage-&gt;sess = sess;
<span class="lineNum">    3230 </span>            :                         sess = NULL;
<span class="lineNum">    3231 </span>            :                 }
<span class="lineNum">    3232 </span>            : 
<span class="lineNum">    3233 </span>            :                 /*check for icon - can be optional*/
<span class="lineNum">    3234 </span>            :                 i=0;
<span class="lineNum">    3235 </span>            :                 while ((icon = gf_list_enum(root-&gt;content, &amp;i))) {
<span class="lineNum">    3236 </span>            :                         if (icon-&gt;type==GF_XML_NODE_TYPE &amp;&amp;
<span class="lineNum">    3237 </span>            :                                 icon-&gt;name &amp;&amp; !strcmp(icon-&gt;name, &quot;icon&quot;) &amp;&amp;
<span class="lineNum">    3238 </span>            :                                 ((!widget_ns_prefix &amp;&amp; !icon-&gt;ns) || !strcmp(widget_ns_prefix, icon-&gt;ns))) {
<span class="lineNum">    3239 </span>            :                                 char *sep;
<span class="lineNum">    3240 </span>            :                                 char relocated[GF_MAX_PATH], localized_path[GF_MAX_PATH];
<span class="lineNum">    3241 </span>            :                                 char *icon_width, *icon_height;
<span class="lineNum">    3242 </span>            :                                 GF_WidgetContent *iconic;
<span class="lineNum">    3243 </span>            :                                 Bool result;
<span class="lineNum">    3244 </span>            : 
<span class="lineNum">    3245 </span>            :                                 char *pname = (char *)wm_xml_get_attr(icon, &quot;src&quot;);
<span class="lineNum">    3246 </span>            :                                 if (!pname || !strlen(pname)) continue;
<span class="lineNum">    3247 </span>            : 
<span class="lineNum">    3248 </span>            :                                 /*remove any existing fragment*/
<span class="lineNum">    3249 </span>            :                                 sep = strchr(pname, '#');
<span class="lineNum">    3250 </span>            :                                 if (sep) sep[0] = 0;
<span class="lineNum">    3251 </span>            :                                 result = wm_relocate_url(wm, szWidgetPath, pname, relocated, localized_path);
<span class="lineNum">    3252 </span>            :                                 if (sep) sep[0] = '#';
<span class="lineNum">    3253 </span>            :                                 if (!result) continue;
<span class="lineNum">    3254 </span>            : 
<span class="lineNum">    3255 </span>            :                                 iconic = wm_add_icon(widget, relocated, localized_path, sep);
<span class="lineNum">    3256 </span>            :                                 if (iconic) {
<span class="lineNum">    3257 </span>            :                                         wm_parse_mpegu_content_element(iconic, icon, mpegu_ns_prefix, global_prefs);
<span class="lineNum">    3258 </span>            :                                         icon_width = (char *)wm_xml_get_attr(icon, &quot;width&quot;);
<span class="lineNum">    3259 </span>            :                                         if (icon_width) iconic-&gt;width = wm_parse_non_neg(icon_width);
<span class="lineNum">    3260 </span>            :                                         icon_height = (char *)wm_xml_get_attr(icon, &quot;height&quot;);
<span class="lineNum">    3261 </span>            :                                         if (icon_height) iconic-&gt;height = wm_parse_non_neg(icon_height);
<span class="lineNum">    3262 </span>            :                                 }
<span class="lineNum">    3263 </span>            :                         }
<span class="lineNum">    3264 </span>            :                 }
<span class="lineNum">    3265 </span>            :                 /* after processing the icon elements (wether there are valid icons or not), we use the default icon table
<span class="lineNum">    3266 </span>            :                   see http://dev.w3.org/2006/waf/widgets/test-suite/test-cases/ta-FAFYMEGELU/004/ */
<span class="lineNum">    3267 </span>            :                 wm_set_default_icon_files(wm, szWidgetPath, widget);
<span class="lineNum">    3268 </span>            : 
<span class="lineNum">    3269 </span>            :                 /*delete the root-level preference*/
<span class="lineNum">    3270 </span>            :                 i=0;
<span class="lineNum">    3271 </span>            :                 while ((pref = gf_list_enum(global_prefs , &amp;i))) {
<span class="lineNum">    3272 </span>            :                         if (pref-&gt;value) gf_free(pref-&gt;value);
<span class="lineNum">    3273 </span>            :                         gf_free(pref-&gt;name);
<span class="lineNum">    3274 </span>            :                         gf_free(pref);
<span class="lineNum">    3275 </span>            :                 }
<span class="lineNum">    3276 </span>            :                 gf_list_del(global_prefs);
<span class="lineNum">    3277 </span>            : 
<span class="lineNum">    3278 </span>            :                 /*check for optionnal meta data*/
<span class="lineNum">    3279 </span>            :                 name = wm_xml_find(root, widget_ns_prefix, &quot;name&quot;, user_locale);
<span class="lineNum">    3280 </span>            :                 if (name) {
<span class="lineNum">    3281 </span>            :                         const char *shortname = wm_xml_get_attr(name, &quot;short&quot;);
<span class="lineNum">    3282 </span>            :                         widget-&gt;shortname = wm_get_single_attribute(shortname);
<span class="lineNum">    3283 </span>            : 
<span class="lineNum">    3284 </span>            :                         widget-&gt;name = wm_get_normalized_text_content(name, NULL, user_locale);
<span class="lineNum">    3285 </span>            :                 }
<span class="lineNum">    3286 </span>            : 
<span class="lineNum">    3287 </span>            :                 desc = wm_xml_get_attr(root, &quot;id&quot;);
<span class="lineNum">    3288 </span>            :                 if (desc) {
<span class="lineNum">    3289 </span>            :                         /* TODO check if this is a valid IRI, for the moment, just hack to pass the test, check for ':'
<span class="lineNum">    3290 </span>            :                           see http://dev.w3.org/2006/waf/widgets/test-suite/test-cases/ta-RawAIWHoMs/ */
<span class="lineNum">    3291 </span>            :                         if (strchr(desc, ':'))
<span class="lineNum">    3292 </span>            :                                 widget-&gt;identifier = wm_get_single_attribute(desc);
<span class="lineNum">    3293 </span>            :                 }
<span class="lineNum">    3294 </span>            : 
<span class="lineNum">    3295 </span>            :                 desc = wm_xml_get_attr(root, &quot;width&quot;);
<span class="lineNum">    3296 </span>            :                 if (desc) {
<span class="lineNum">    3297 </span>            :                         widget-&gt;width = wm_parse_non_neg(desc);
<span class="lineNum">    3298 </span>            :                 }
<span class="lineNum">    3299 </span>            :                 desc = wm_xml_get_attr(root, &quot;height&quot;);
<span class="lineNum">    3300 </span>            :                 if (desc) {
<span class="lineNum">    3301 </span>            :                         widget-&gt;height = wm_parse_non_neg(desc);
<span class="lineNum">    3302 </span>            :                 }
<span class="lineNum">    3303 </span>            : 
<span class="lineNum">    3304 </span>            :                 name = wm_xml_find(root, widget_ns_prefix, &quot;description&quot;, user_locale);
<span class="lineNum">    3305 </span>            :                 if (name) {
<span class="lineNum">    3306 </span>            :                         widget-&gt;description = wm_get_normalized_text_content(name, NULL, user_locale);
<span class="lineNum">    3307 </span>            :                 }
<span class="lineNum">    3308 </span>            : 
<span class="lineNum">    3309 </span>            :                 name = wm_xml_find(root, widget_ns_prefix, &quot;license&quot;, user_locale);
<span class="lineNum">    3310 </span>            :                 if (name) {
<span class="lineNum">    3311 </span>            :                         const char *href = wm_xml_get_attr(name, &quot;href&quot;);
<span class="lineNum">    3312 </span>            :                         widget-&gt;licenseHref = wm_get_single_attribute(href);
<span class="lineNum">    3313 </span>            : 
<span class="lineNum">    3314 </span>            :                         /* Warning the license text content should not be normalized */
<span class="lineNum">    3315 </span>            :                         widget-&gt;license = wm_get_text_content(name, NULL, user_locale);
<span class="lineNum">    3316 </span>            :                 }
<span class="lineNum">    3317 </span>            : 
<span class="lineNum">    3318 </span>            :                 desc = wm_xml_get_attr(root, &quot;version&quot;);
<span class="lineNum">    3319 </span>            :                 if (desc) widget-&gt;version = wm_get_single_attribute(desc);
<span class="lineNum">    3320 </span>            : 
<span class="lineNum">    3321 </span>            :                 desc = wm_xml_get_attr(root, &quot;uuid&quot;);
<span class="lineNum">    3322 </span>            :                 if (desc) widget-&gt;uuid = gf_strdup(desc);
<span class="lineNum">    3323 </span>            : 
<span class="lineNum">    3324 </span>            :                 desc = wm_xml_get_attr(root, &quot;discardable&quot;);
<span class="lineNum">    3325 </span>            :                 if (desc) widget-&gt;discardable = !strcmp(desc, &quot;true&quot;) ? 1 : 0;
<span class="lineNum">    3326 </span>            : 
<span class="lineNum">    3327 </span>            :                 desc = wm_xml_get_attr(root, &quot;multipleInstances&quot;);
<span class="lineNum">    3328 </span>            :                 if (desc) widget-&gt;multipleInstance = !strcmp(desc, &quot;true&quot;) ? 1 : 0;
<span class="lineNum">    3329 </span>            : 
<span class="lineNum">    3330 </span>            :                 name = wm_xml_find(root, widget_ns_prefix, &quot;author&quot;, NULL);
<span class="lineNum">    3331 </span>            :                 if (name) {
<span class="lineNum">    3332 </span>            :                         desc = wm_xml_get_attr(name, &quot;href&quot;);
<span class="lineNum">    3333 </span>            :                         if (desc &amp;&amp; strchr(desc, ':')) widget-&gt;authorHref = wm_get_single_attribute(desc);
<span class="lineNum">    3334 </span>            : 
<span class="lineNum">    3335 </span>            :                         desc = wm_xml_get_attr(name, &quot;email&quot;);
<span class="lineNum">    3336 </span>            :                         widget-&gt;authorEmail = wm_get_single_attribute(desc);
<span class="lineNum">    3337 </span>            : 
<span class="lineNum">    3338 </span>            :                         widget-&gt;authorName = wm_get_normalized_text_content(name, NULL, user_locale);
<span class="lineNum">    3339 </span>            :                 }
<span class="lineNum">    3340 </span>            : 
<span class="lineNum">    3341 </span>            :                 i=0;
<span class="lineNum">    3342 </span>            :                 while ((xml_node = gf_list_enum(root-&gt;content, &amp;i))) {
<span class="lineNum">    3343 </span>            :                         if (xml_node-&gt;type==GF_XML_NODE_TYPE &amp;&amp;
<span class="lineNum">    3344 </span>            :                                 xml_node-&gt;name &amp;&amp; !strcmp(xml_node-&gt;name, &quot;feature&quot;) &amp;&amp;
<span class="lineNum">    3345 </span>            :                                 ((!widget_ns_prefix &amp;&amp; !xml_node-&gt;ns) || !strcmp(widget_ns_prefix, xml_node-&gt;ns))) {
<span class="lineNum">    3346 </span>            : 
<span class="lineNum">    3347 </span>            :                                 u32 i, count;
<span class="lineNum">    3348 </span>            :                                 Bool already_in = 0;
<span class="lineNum">    3349 </span>            :                                 GF_WidgetFeature *feat;
<span class="lineNum">    3350 </span>            :                                 const char *feature_name, *req_att;
<span class="lineNum">    3351 </span>            :                                 char *nfname;
<span class="lineNum">    3352 </span>            :                                 Bool required = 1;
<span class="lineNum">    3353 </span>            :                                 u32 j;
<span class="lineNum">    3354 </span>            :                                 GF_XMLNode *param_node;
<span class="lineNum">    3355 </span>            : 
<span class="lineNum">    3356 </span>            :                                 feature_name = (char *)wm_xml_get_attr(xml_node, &quot;name&quot;);
<span class="lineNum">    3357 </span>            :                                 if (!feature_name || !strlen(feature_name) || !strchr(feature_name, ':')) continue;
<span class="lineNum">    3358 </span>            :                                 nfname = wm_get_single_attribute(feature_name);
<span class="lineNum">    3359 </span>            : 
<span class="lineNum">    3360 </span>            :                                 req_att = (char *)wm_xml_get_attr(xml_node, &quot;required&quot;);
<span class="lineNum">    3361 </span>            :                                 if (req_att &amp;&amp; !strcmp(req_att, &quot;false&quot;)) required = 0;
<span class="lineNum">    3362 </span>            : 
<span class="lineNum">    3363 </span>            :                                 count = gf_list_count(widget-&gt;features);
<span class="lineNum">    3364 </span>            :                                 for (i = 0; i&lt;count; i++) {
<span class="lineNum">    3365 </span>            :                                         GF_WidgetFeature *tmp = gf_list_get(widget-&gt;features, i);
<span class="lineNum">    3366 </span>            :                                         if (!strcmp(nfname, tmp-&gt;name)) {
<span class="lineNum">    3367 </span>            :                                                 already_in = 1;
<span class="lineNum">    3368 </span>            :                                                 break;
<span class="lineNum">    3369 </span>            :                                         }
<span class="lineNum">    3370 </span>            :                                 }
<span class="lineNum">    3371 </span>            :                                 if (already_in) continue;
<span class="lineNum">    3372 </span>            : 
<span class="lineNum">    3373 </span>            :                                 GF_SAFEALLOC(feat, GF_WidgetFeature);
<span class="lineNum">    3374 </span>            :                                 if (!feat) {
<span class="lineNum">    3375 </span>            :                                         e = GF_OUT_OF_MEM;
<span class="lineNum">    3376 </span>            :                                         goto exit;
<span class="lineNum">    3377 </span>            :                                 }
<span class="lineNum">    3378 </span>            :                                 feat-&gt;name = nfname;
<span class="lineNum">    3379 </span>            :                                 feat-&gt;required = required;
<span class="lineNum">    3380 </span>            :                                 feat-&gt;params = gf_list_new();
<span class="lineNum">    3381 </span>            :                                 gf_list_add(widget-&gt;features, feat);
<span class="lineNum">    3382 </span>            : 
<span class="lineNum">    3383 </span>            :                                 j = 0;
<span class="lineNum">    3384 </span>            :                                 while ((param_node = gf_list_enum(xml_node-&gt;content, &amp;j))) {
<span class="lineNum">    3385 </span>            :                                         if (param_node-&gt;type==GF_XML_NODE_TYPE &amp;&amp;
<span class="lineNum">    3386 </span>            :                                                 param_node-&gt;name &amp;&amp; !strcmp(param_node-&gt;name, &quot;param&quot;) &amp;&amp;
<span class="lineNum">    3387 </span>            :                                                 ((!widget_ns_prefix &amp;&amp; !param_node-&gt;ns) || !strcmp(widget_ns_prefix, param_node-&gt;ns))) {
<span class="lineNum">    3388 </span>            :                                                 GF_WidgetFeatureParam *wfp;
<span class="lineNum">    3389 </span>            :                                                 const char *param_name, *param_value;
<span class="lineNum">    3390 </span>            :                                                 char *npname, *npvalue;
<span class="lineNum">    3391 </span>            : 
<span class="lineNum">    3392 </span>            :                                                 param_name = (char *)wm_xml_get_attr(param_node, &quot;name&quot;);
<span class="lineNum">    3393 </span>            :                                                 npname = wm_get_single_attribute(param_name);
<span class="lineNum">    3394 </span>            :                                                 if (!strlen(npname)) continue;
<span class="lineNum">    3395 </span>            : 
<span class="lineNum">    3396 </span>            :                                                 param_value = (char *)wm_xml_get_attr(param_node, &quot;value&quot;);
<span class="lineNum">    3397 </span>            :                                                 npvalue = wm_get_single_attribute(param_value);
<span class="lineNum">    3398 </span>            :                                                 if (!strlen(npvalue)) {
<span class="lineNum">    3399 </span>            :                                                         gf_free(npname);
<span class="lineNum">    3400 </span>            :                                                         continue;
<span class="lineNum">    3401 </span>            :                                                 }
<span class="lineNum">    3402 </span>            : 
<span class="lineNum">    3403 </span>            :                                                 GF_SAFEALLOC(wfp, GF_WidgetFeatureParam);
<span class="lineNum">    3404 </span>            :                                                 if (!wfp) {
<span class="lineNum">    3405 </span>            :                                                         e = GF_OUT_OF_MEM;
<span class="lineNum">    3406 </span>            :                                                         goto exit;
<span class="lineNum">    3407 </span>            :                                                 }
<span class="lineNum">    3408 </span>            : 
<span class="lineNum">    3409 </span>            :                                                 wfp-&gt;name = npname;
<span class="lineNum">    3410 </span>            :                                                 wfp-&gt;value = npvalue;
<span class="lineNum">    3411 </span>            :                                                 gf_list_add(feat-&gt;params, wfp);
<span class="lineNum">    3412 </span>            : 
<span class="lineNum">    3413 </span>            :                                         }
<span class="lineNum">    3414 </span>            :                                 }
<span class="lineNum">    3415 </span>            : 
<span class="lineNum">    3416 </span>            :                         }
<span class="lineNum">    3417 </span>            :                 }
<span class="lineNum">    3418 </span>            : 
<span class="lineNum">    3419 </span>            :                 gf_list_add(wm-&gt;widgets, widget);
<span class="lineNum">    3420 </span>            :         }
<span class="lineNum">    3421 </span>            : 
<span class="lineNum">    3422 </span>            :         GF_SAFEALLOC(wi, GF_WidgetInstance);
<span class="lineNum">    3423 </span>            :         if (!wi) {
<span class="lineNum">    3424 </span>            :                 e = GF_OUT_OF_MEM;
<span class="lineNum">    3425 </span>            :                 goto exit;
<span class="lineNum">    3426 </span>            :         }
<span class="lineNum">    3427 </span>            :         
<span class="lineNum">    3428 </span>            :         wi-&gt;widget = widget;
<span class="lineNum">    3429 </span>            :         wi-&gt;bound_ifces = gf_list_new();
<span class="lineNum">    3430 </span>            :         wi-&gt;output_triggers = gf_list_new();
<span class="lineNum">    3431 </span>            :         wi-&gt;components = gf_list_new();
<span class="lineNum">    3432 </span>            :         widget-&gt;nb_instances++;
<span class="lineNum">    3433 </span>            :         wi-&gt;instance_id = InstanceID;
<span class="lineNum">    3434 </span>            :         wi-&gt;permanent = 1;
<span class="lineNum">    3435 </span>            : 
<span class="lineNum">    3436 </span>            :         if (!InstanceID) {
<span class="lineNum">    3437 </span>            :                 char szInst[20];
<span class="lineNum">    3438 </span>            : 
<span class="lineNum">    3439 </span>            :                 count = gf_list_count(wm-&gt;widget_instances);
<span class="lineNum">    3440 </span>            :                 for (i=0; i&lt;count; i++) {
<span class="lineNum">    3441 </span>            :                         GF_WidgetInstance *awi = gf_list_get(wm-&gt;widget_instances, i);
<span class="lineNum">    3442 </span>            :                         if (awi-&gt;widget == wi-&gt;widget)
<span class="lineNum">    3443 </span>            :                                 wi-&gt;instance_id = awi-&gt;instance_id;
<span class="lineNum">    3444 </span>            :                 }
<span class="lineNum">    3445 </span>            :                 wi-&gt;instance_id ++;
<span class="lineNum">    3446 </span>            : 
<span class="lineNum">    3447 </span>            :                 sprintf(szName, &quot;%s#%s#Instance%d&quot;, path, wi-&gt;widget-&gt;name, wi-&gt;instance_id);
<span class="lineNum">    3448 </span>            :                 sprintf((char *)wi-&gt;secname, &quot;Widget#%08X&quot;, gf_crc_32(szName, (u32) strlen(szName)));
<span class="lineNum">    3449 </span>            : 
<span class="lineNum">    3450 </span>            :                 /*create section*/
<span class="lineNum">    3451 </span>            :                 gf_cfg_set_key(wm-&gt;term-&gt;user-&gt;config, &quot;Widgets&quot;, (const char *) wi-&gt;secname, &quot; &quot;);
<span class="lineNum">    3452 </span>            :                 gf_cfg_set_key(wm-&gt;term-&gt;user-&gt;config, (const char *) wi-&gt;secname, &quot;WM:Manifest&quot;, wi-&gt;widget-&gt;url);
<span class="lineNum">    3453 </span>            :                 sprintf(szInst, &quot;%d&quot;, wi-&gt;instance_id);
<span class="lineNum">    3454 </span>            :                 gf_cfg_set_key(wm-&gt;term-&gt;user-&gt;config, (const char *) wi-&gt;secname, &quot;WM:InstanceID&quot;, szInst);
<span class="lineNum">    3455 </span>            :         }
<span class="lineNum">    3456 </span>            :         gf_list_add(wm-&gt;widget_instances, wi);
<span class="lineNum">    3457 </span>            : 
<span class="lineNum">    3458 </span>            : 
<span class="lineNum">    3459 </span>            :         if (!skip_context &amp;&amp; strstr(path, &quot;http://&quot;)) {
<span class="lineNum">    3460 </span>            :                 GF_XMLNode *context;
<span class="lineNum">    3461 </span>            :                 GF_DownloadSession *ctx_sess = NULL;
<span class="lineNum">    3462 </span>            :                 char *ctxPath;
<span class="lineNum">    3463 </span>            :                 context = NULL;
<span class="lineNum">    3464 </span>            : 
<span class="lineNum">    3465 </span>            :                 /*fetch the remote widget context synchronously and load it */
<span class="lineNum">    3466 </span>            :                 ctxPath = gf_malloc(sizeof(char) * (strlen(path) + 1 + 15/*?mpeg-u-context*/));
<span class="lineNum">    3467 </span>            :                 strcpy(ctxPath, path);
<span class="lineNum">    3468 </span>            :                 if ((strchr(path, '?') == NULL) &amp;&amp; (strstr(path, &quot;%3f&quot;)==NULL) &amp;&amp; (strstr(path, &quot;%3F&quot;)==NULL) ) {
<span class="lineNum">    3469 </span>            :                         strcat(ctxPath, &quot;?mpeg-u-context&quot;);
<span class="lineNum">    3470 </span>            :                 } else {
<span class="lineNum">    3471 </span>            :                         strcat(ctxPath, &quot;&amp;mpeg-u-context&quot;);
<span class="lineNum">    3472 </span>            :                 }
<span class="lineNum">    3473 </span>            : 
<span class="lineNum">    3474 </span>            :                 /*try to fetch the associated context*/
<span class="lineNum">    3475 </span>            :                 ctx_sess = gf_dm_sess_new(wm-&gt;term-&gt;downloader, (char *)ctxPath, GF_NETIO_SESSION_NOT_THREADED, NULL, NULL, &amp;e);
<span class="lineNum">    3476 </span>            :                 if (ctx_sess) {
<span class="lineNum">    3477 </span>            :                         e = gf_dm_sess_process(ctx_sess);
<span class="lineNum">    3478 </span>            :                         if (e==GF_OK) {
<span class="lineNum">    3479 </span>            :                                 wi-&gt;mpegu_context = gf_xml_dom_new();
<span class="lineNum">    3480 </span>            :                                 e = gf_xml_dom_parse(wi-&gt;mpegu_context , gf_dm_sess_get_cache_name(ctx_sess), NULL, NULL);
<span class="lineNum">    3481 </span>            :                                 if (!e) {
<span class="lineNum">    3482 </span>            :                                         context = gf_xml_dom_get_root(wi-&gt;mpegu_context);
<span class="lineNum">    3483 </span>            :                                         if (strcmp(context-&gt;name, &quot;contextInformation&quot;)) context = NULL;
<span class="lineNum">    3484 </span>            :                                 }
<span class="lineNum">    3485 </span>            :                         }
<span class="lineNum">    3486 </span>            :                         gf_dm_sess_del(ctx_sess);
<span class="lineNum">    3487 </span>            :                         e = GF_OK;
<span class="lineNum">    3488 </span>            :                 }
<span class="lineNum">    3489 </span>            :                 gf_free(ctxPath);
<span class="lineNum">    3490 </span>            :                 ctxPath = NULL;
<span class="lineNum">    3491 </span>            : 
<span class="lineNum">    3492 </span>            :                 if (!context &amp;&amp; wi-&gt;mpegu_context) {
<span class="lineNum">    3493 </span>            :                         gf_xml_dom_del(wi-&gt;mpegu_context);
<span class="lineNum">    3494 </span>            :                         wi-&gt;mpegu_context = NULL;
<span class="lineNum">    3495 </span>            :                 }
<span class="lineNum">    3496 </span>            : 
<span class="lineNum">    3497 </span>            :         }
<span class="lineNum">    3498 </span>            : 
<span class="lineNum">    3499 </span>            : exit:
<span class="lineNum">    3500 </span>            :         if (dom) gf_xml_dom_del(dom);
<span class="lineNum">    3501 </span>            :         if (sess) gf_dm_sess_del(sess);
<span class="lineNum">    3502 </span>            :         if (e || !wi) {
<span class="lineNum">    3503 </span>            :                 if (wi) wm_delete_widget_instance(wm, wi);
<span class="lineNum">    3504 </span>            :                 else {
<span class="lineNum">    3505 </span>            :                         if (wpackage) widget_package_del(wm, wpackage);
<span class="lineNum">    3506 </span>            :                 }
<span class="lineNum">    3507 </span>            :                 return NULL;
<span class="lineNum">    3508 </span>            :         }
<span class="lineNum">    3509 </span>            :         return wi;
<span class="lineNum">    3510 </span>            : }
<span class="lineNum">    3511 </span>            : 
<span class="lineNum">    3512 </span>            : 
<span class="lineNum">    3513 </span>            : static Bool wm_enum_widget(void *cbk, char *file_name, char *file_path, GF_FileEnumInfo *file_info)
<span class="lineNum">    3514 </span>            : {
<span class="lineNum">    3515 </span>            :         GF_WidgetInstance *wid;
<span class="lineNum">    3516 </span>            :         GF_WidgetManager *wm = (GF_WidgetManager *)cbk;
<span class="lineNum">    3517 </span>            :         wid = wm_load_widget(wm, file_path, 0, 0);
<span class="lineNum">    3518 </span>            :         if (wid) {
<span class="lineNum">    3519 </span>            :                 wm_widget_jsbind(wm, wid);
<span class="lineNum">    3520 </span>            :                 /*remove section info*/
<span class="lineNum">    3521 </span>            :                 gf_cfg_del_section(wm-&gt;term-&gt;user-&gt;config, (const char *) wid-&gt;secname);
<span class="lineNum">    3522 </span>            :                 gf_cfg_set_key(wm-&gt;term-&gt;user-&gt;config, &quot;Widgets&quot;, (const char *) wid-&gt;secname, NULL);
<span class="lineNum">    3523 </span>            :         }
<span class="lineNum">    3524 </span>            :         return 0;
<span class="lineNum">    3525 </span>            : }
<span class="lineNum">    3526 </span>            : 
<span class="lineNum">    3527 </span>            : static Bool wm_enum_dir(void *cbk, char *file_name, char *file_path, GF_FileEnumInfo *file_info)
<span class="lineNum">    3528 </span>            : {
<span class="lineNum">    3529 </span>            :         return (gf_enum_directory(file_path, 0, wm_enum_widget, cbk, &quot;mgt&quot;)==GF_OK) ? GF_FALSE : GF_TRUE;
<span class="lineNum">    3530 </span>            : }
<span class="lineNum">    3531 </span>            : 
<span class="lineNum">    3532 </span>            : 
<span class="lineNum">    3533 </span>            : static JSBool SMJS_FUNCTION(wm_initialize)
<span class="lineNum">    3534 </span>            : {
<span class="lineNum">    3535 </span>            :         u32 i, count;
<span class="lineNum">    3536 </span>            :         const char*opt;
<span class="lineNum">    3537 </span>            :         SMJS_OBJ
<span class="lineNum">    3538 </span>            :         //SMJS_ARGS
<span class="lineNum">    3539 </span>            :         GF_WidgetManager *wm = (GF_WidgetManager *)SMJS_GET_PRIVATE(c, obj);
<span class="lineNum">    3540 </span>            : 
<span class="lineNum">    3541 </span>            :         count = gf_cfg_get_key_count(wm-&gt;term-&gt;user-&gt;config, &quot;Widgets&quot;);
<span class="lineNum">    3542 </span>            :         for (i=0; i&lt;count; i++) {
<span class="lineNum">    3543 </span>            :                 const char *name = gf_cfg_get_key_name(wm-&gt;term-&gt;user-&gt;config, &quot;Widgets&quot;, i);
<span class="lineNum">    3544 </span>            :                 /*this is a previously loaded widgets - reload it*/
<span class="lineNum">    3545 </span>            :                 if (!strnicmp(name, &quot;Widget#&quot;, 7)) {
<span class="lineNum">    3546 </span>            :                         const char *manifest = gf_cfg_get_key(wm-&gt;term-&gt;user-&gt;config, name, &quot;WM:Manifest&quot;);
<span class="lineNum">    3547 </span>            :                         if (manifest) {
<span class="lineNum">    3548 </span>            :                                 const char *ID = gf_cfg_get_key(wm-&gt;term-&gt;user-&gt;config, name, &quot;WM:InstanceID&quot;);
<span class="lineNum">    3549 </span>            :                                 u32 instID = ID ? atoi(ID) : 0;
<span class="lineNum">    3550 </span>            :                                 GF_WidgetInstance *wi = wm_load_widget(wm, manifest, instID, 0);
<span class="lineNum">    3551 </span>            :                                 if (wi) {
<span class="lineNum">    3552 </span>            :                                         strcpy((char *)wi-&gt;secname, (const char *) name);
<span class="lineNum">    3553 </span>            :                                         wm_widget_jsbind(wm, wi);
<span class="lineNum">    3554 </span>            :                                 }
<span class="lineNum">    3555 </span>            :                         }
<span class="lineNum">    3556 </span>            :                 }
<span class="lineNum">    3557 </span>            :         }
<span class="lineNum">    3558 </span>            : 
<span class="lineNum">    3559 </span>            :         opt = gf_cfg_get_key(wm-&gt;term-&gt;user-&gt;config, &quot;Widgets&quot;, &quot;WidgetStore&quot;);
<span class="lineNum">    3560 </span>            :         if (opt) gf_enum_directory(opt, 1, wm_enum_dir, wm, NULL);
<span class="lineNum">    3561 </span>            : 
<span class="lineNum">    3562 </span>            :         return JS_TRUE;
<span class="lineNum">    3563 </span>            : }
<span class="lineNum">    3564 </span>            : 
<span class="lineNum">    3565 </span>            : static void widgetmanager_load(GF_JSUserExtension *jsext, GF_SceneGraph *scene, JSContext *c, JSObject *global, Bool unload)
<span class="lineNum">    3566 </span>            : {
<span class="lineNum">    3567 </span>            :         GF_WidgetManager *wm;
<span class="lineNum">    3568 </span>            : 
<span class="lineNum">    3569 </span>            :         GF_JSAPIParam par;
<span class="lineNum">    3570 </span>            :         JSPropertySpec wmClassProps[] = {
<span class="lineNum">    3571 </span>            :                 SMJS_PROPERTY_SPEC(0, 0, 0, 0, 0)
<span class="lineNum">    3572 </span>            :         };
<span class="lineNum">    3573 </span>            :         JSFunctionSpec wmClassFuncs[] = {
<span class="lineNum">    3574 </span>            :                 SMJS_FUNCTION_SPEC(&quot;initialize&quot;, wm_initialize, 0),
<span class="lineNum">    3575 </span>            :                 SMJS_FUNCTION_SPEC(&quot;load&quot;, wm_load, 2),
<span class="lineNum">    3576 </span>            :                 SMJS_FUNCTION_SPEC(&quot;unload&quot;, wm_unload, 1),
<span class="lineNum">    3577 </span>            :                 SMJS_FUNCTION_SPEC(&quot;get&quot;, wm_get, 1),
<span class="lineNum">    3578 </span>            :                 SMJS_FUNCTION_SPEC(&quot;findByInterface&quot;, wm_find_interface, 1),
<span class="lineNum">    3579 </span>            :                 SMJS_FUNCTION_SPEC(0, 0, 0)
<span class="lineNum">    3580 </span>            :         };
<span class="lineNum">    3581 </span>            : 
<span class="lineNum">    3582 </span>            :         wm = jsext-&gt;udta;
<span class="lineNum">    3583 </span>            :         /*widget manager is only loaded once*/
<span class="lineNum">    3584 </span>            :         if (wm-&gt;ctx &amp;&amp; (wm-&gt;ctx != c)) {
<span class="lineNum">    3585 </span>            :                 /*load the 'Widget' object in the global scope*/
<span class="lineNum">    3586 </span>            :                 widget_load(wm, scene, c, global, unload);
<span class="lineNum">    3587 </span>            :                 return;
<span class="lineNum">    3588 </span>            :         }
<span class="lineNum">    3589 </span>            : 
<span class="lineNum">    3590 </span>            :         /*unload widgets*/
<span class="lineNum">    3591 </span>            :         if (unload) {
<span class="lineNum">    3592 </span>            :                 if (wm-&gt;obj) {
<span class="lineNum">    3593 </span>            :                         gf_js_remove_root(wm-&gt;ctx, &amp;wm-&gt;obj, GF_JSGC_OBJECT);
<span class="lineNum">    3594 </span>            :                         wm-&gt;obj = NULL;
<span class="lineNum">    3595 </span>            :                 }
<span class="lineNum">    3596 </span>            : 
<span class="lineNum">    3597 </span>            :                 while (gf_list_count(wm-&gt;widget_instances)) {
<span class="lineNum">    3598 </span>            :                         GF_WidgetInstance *widg = gf_list_get(wm-&gt;widget_instances, 0);
<span class="lineNum">    3599 </span>            :                         wm_delete_widget_instance(wm, widg);
<span class="lineNum">    3600 </span>            :                 }
<span class="lineNum">    3601 </span>            :                 wm-&gt;ctx = NULL;
<span class="lineNum">    3602 </span>            :                 return;
<span class="lineNum">    3603 </span>            :         }
<span class="lineNum">    3604 </span>            :         wm-&gt;ctx = c;
<span class="lineNum">    3605 </span>            : 
<span class="lineNum">    3606 </span>            :         if (!scene) return;
<span class="lineNum">    3607 </span>            : 
<span class="lineNum">    3608 </span>            :         /*setup JS bindings*/
<span class="lineNum">    3609 </span>            :         JS_SETUP_CLASS(wm-&gt;widmanClass, &quot;WIDGETMANAGER&quot;, JSCLASS_HAS_PRIVATE, wm_getProperty, wm_setProperty, JS_FinalizeStub);
<span class="lineNum">    3610 </span>            : 
<span class="lineNum">    3611 </span>            :         GF_JS_InitClass(c, global, 0, &amp;wm-&gt;widmanClass, 0, 0, wmClassProps, wmClassFuncs, 0, 0);
<span class="lineNum">    3612 </span>            :         wm-&gt;obj = JS_DefineObject(c, global, &quot;WidgetManager&quot;, &amp;wm-&gt;widmanClass._class, 0, 0);
<span class="lineNum">    3613 </span>            :         SMJS_SET_PRIVATE(c, wm-&gt;obj, wm);
<span class="lineNum">    3614 </span>            :         gf_js_add_root(c, &amp;wm-&gt;obj, GF_JSGC_OBJECT);
<span class="lineNum">    3615 </span>            : 
<span class="lineNum">    3616 </span>            : 
<span class="lineNum">    3617 </span>            :         {
<span class="lineNum">    3618 </span>            :                 JSPropertySpec wmWidgetClassProps[] = {
<span class="lineNum">    3619 </span>            :                         SMJS_PROPERTY_SPEC(0, 0, 0, 0, 0)
<span class="lineNum">    3620 </span>            :                 };
<span class="lineNum">    3621 </span>            :                 JSFunctionSpec wmWidgetClassFuncs[] = {
<span class="lineNum">    3622 </span>            :                         SMJS_FUNCTION_SPEC(&quot;activate&quot;, wm_widget_activate, 1),
<span class="lineNum">    3623 </span>            :                         SMJS_FUNCTION_SPEC(&quot;deactivate&quot;, wm_widget_deactivate, 0),
<span class="lineNum">    3624 </span>            :                         SMJS_FUNCTION_SPEC(&quot;get_interface&quot;, wm_widget_get_interface, 1),
<span class="lineNum">    3625 </span>            :                         SMJS_FUNCTION_SPEC(&quot;bind_output_trigger&quot;, wm_widget_bind_output_trigger, 2),
<span class="lineNum">    3626 </span>            :                         SMJS_FUNCTION_SPEC(&quot;set_input&quot;, wm_widget_set_input, 2),
<span class="lineNum">    3627 </span>            :                         SMJS_FUNCTION_SPEC(&quot;bind_interface&quot;, wm_widget_bind_interface, 2),
<span class="lineNum">    3628 </span>            :                         SMJS_FUNCTION_SPEC(&quot;unbind_interface&quot;, wm_widget_unbind_interface, 1),
<span class="lineNum">    3629 </span>            :                         SMJS_FUNCTION_SPEC(&quot;call_input_action&quot;, wm_widget_call_input_action, 1),
<span class="lineNum">    3630 </span>            :                         SMJS_FUNCTION_SPEC(&quot;call_input_script&quot;, wm_widget_call_input_script, 2),
<span class="lineNum">    3631 </span>            :                         SMJS_FUNCTION_SPEC(&quot;is_interface_bound&quot;, wm_widget_is_interface_bound, 1),
<span class="lineNum">    3632 </span>            :                         SMJS_FUNCTION_SPEC(&quot;get_param_value&quot;, wm_widget_get_param_value, 1),
<span class="lineNum">    3633 </span>            :                         SMJS_FUNCTION_SPEC(&quot;get_context&quot;, wm_widget_get_context, 0),
<span class="lineNum">    3634 </span>            :                         SMJS_FUNCTION_SPEC(&quot;get_component&quot;, wm_widget_get_component, 2),
<span class="lineNum">    3635 </span>            : 
<span class="lineNum">    3636 </span>            :                         SMJS_FUNCTION_SPEC(0, 0, 0)
<span class="lineNum">    3637 </span>            :                 };
<span class="lineNum">    3638 </span>            :                 /*setup JS bindings*/
<span class="lineNum">    3639 </span>            :                 JS_SETUP_CLASS(wm-&gt;wmWidgetClass, &quot;WMWIDGET&quot;, JSCLASS_HAS_PRIVATE, wm_widget_getProperty, wm_widget_setProperty, JS_FinalizeStub);
<span class="lineNum">    3640 </span>            :                 GF_JS_InitClass(c, global, 0, &amp;wm-&gt;wmWidgetClass, 0, 0, wmWidgetClassProps, wmWidgetClassFuncs, 0, 0);
<span class="lineNum">    3641 </span>            : 
<span class="lineNum">    3642 </span>            :                 JS_SETUP_CLASS(wm-&gt;widgetAnyClass, &quot;WIDGETANY&quot;, JSCLASS_HAS_PRIVATE, JS_PropertyStub, JS_PropertyStub_forSetter, JS_FinalizeStub);
<span class="lineNum">    3643 </span>            :                 GF_JS_InitClass(c, global, 0, &amp;wm-&gt;widgetAnyClass, 0, 0, 0, 0, 0, 0);
<span class="lineNum">    3644 </span>            :         }
<span class="lineNum">    3645 </span>            : 
<span class="lineNum">    3646 </span>            :         JS_SETUP_CLASS(wm-&gt;widgetClass, &quot;MPEGWidget&quot;, JSCLASS_HAS_PRIVATE, widget_getProperty, widget_setProperty, JS_FinalizeStub);
<span class="lineNum">    3647 </span>            : 
<span class="lineNum">    3648 </span>            :         if (scene-&gt;script_action) {
<span class="lineNum">    3649 </span>            :                 if (!scene-&gt;script_action(scene-&gt;script_action_cbck, GF_JSAPI_OP_GET_TERM, scene-&gt;RootNode, &amp;par))
<span class="lineNum">    3650 </span>            :                         return;
<span class="lineNum">    3651 </span>            :                 wm-&gt;term = par.term;
<span class="lineNum">    3652 </span>            :         }
<span class="lineNum">    3653 </span>            : 
<span class="lineNum">    3654 </span>            : }
<span class="lineNum">    3655 </span>            : 
<span class="lineNum">    3656 </span>            : 
<span class="lineNum">    3657 </span>            : static GF_JSUserExtension *gwm_new()
<span class="lineNum">    3658 </span>            : {
<span class="lineNum">    3659 </span>            :         GF_JSUserExtension *dr;
<span class="lineNum">    3660 </span>            :         GF_WidgetManager *wm;
<span class="lineNum">    3661 </span>            :         GF_SAFEALLOC(dr, GF_JSUserExtension);
<span class="lineNum">    3662 </span>            :         if (!dr) return NULL;
<span class="lineNum">    3663 </span>            :         GF_REGISTER_MODULE_INTERFACE(dr, GF_JS_USER_EXT_INTERFACE, &quot;WidgetManager JavaScript Bindings&quot;, &quot;gpac distribution&quot;);
<span class="lineNum">    3664 </span>            : 
<span class="lineNum">    3665 </span>            :         GF_SAFEALLOC(wm, GF_WidgetManager);
<span class="lineNum">    3666 </span>            :         if (!wm) {
<span class="lineNum">    3667 </span>            :                 gf_free(dr);
<span class="lineNum">    3668 </span>            :                 return NULL;
<span class="lineNum">    3669 </span>            :         }
<span class="lineNum">    3670 </span>            :         wm-&gt;widget_instances = gf_list_new();
<span class="lineNum">    3671 </span>            :         wm-&gt;widgets = gf_list_new();
<span class="lineNum">    3672 </span>            :         dr-&gt;load = widgetmanager_load;
<span class="lineNum">    3673 </span>            :         dr-&gt;udta = wm;
<span class="lineNum">    3674 </span>            :         return dr;
<span class="lineNum">    3675 </span>            : }
<span class="lineNum">    3676 </span>            : 
<span class="lineNum">    3677 </span>            : 
<span class="lineNum">    3678 </span>            : static void gwm_delete(GF_BaseInterface *ifce)
<span class="lineNum">    3679 </span>            : {
<span class="lineNum">    3680 </span>            :         GF_WidgetManager *wm;
<span class="lineNum">    3681 </span>            :         GF_JSUserExtension *dr = (GF_JSUserExtension *) ifce;
<span class="lineNum">    3682 </span>            :         if (!dr)
<span class="lineNum">    3683 </span>            :                 return;
<span class="lineNum">    3684 </span>            :         wm = dr-&gt;udta;
<span class="lineNum">    3685 </span>            :         if (!wm)
<span class="lineNum">    3686 </span>            :                 return;
<span class="lineNum">    3687 </span>            :         if (wm-&gt;widget_instances)
<span class="lineNum">    3688 </span>            :                 gf_list_del(wm-&gt;widget_instances);
<span class="lineNum">    3689 </span>            :         wm-&gt;widget_instances = NULL;
<span class="lineNum">    3690 </span>            :         if (wm-&gt;widgets)
<span class="lineNum">    3691 </span>            :                 gf_list_del(wm-&gt;widgets);
<span class="lineNum">    3692 </span>            :         wm-&gt;widgets = NULL;
<span class="lineNum">    3693 </span>            :         gf_free(wm);
<span class="lineNum">    3694 </span>            :         dr-&gt;udta = NULL;
<span class="lineNum">    3695 </span>            :         gf_free(dr);
<span class="lineNum">    3696 </span>            : }
<span class="lineNum">    3697 </span>            : #endif
<span class="lineNum">    3698 </span>            : 
<a name="3699"><span class="lineNum">    3699 </span>            : </a>
<span class="lineNum">    3700 </span>            : GPAC_MODULE_EXPORT
<span class="lineNum">    3701 </span>            : const u32 *QueryInterfaces()
<span class="lineNum">    3702 </span>            : {
<span class="lineNum">    3703 </span>            :         static u32 si [] = {
<span class="lineNum">    3704 </span>            : #ifdef GPAC_HAS_SPIDERMONKEY
<span class="lineNum">    3705 </span>            :                 GF_JS_USER_EXT_INTERFACE,
<span class="lineNum">    3706 </span>            : #ifndef GPAC_DISABLE_SVG
<span class="lineNum">    3707 </span>            :                 GF_SCENE_DECODER_INTERFACE,
<span class="lineNum">    3708 </span>            : #endif
<span class="lineNum">    3709 </span>            : 
<span class="lineNum">    3710 </span>            : #endif
<span class="lineNum">    3711 </span>            :                 0
<span class="lineNum">    3712 </span>            :         };
<span class="lineNum">    3713 </span><span class="lineCov">          1 :         return si;</span>
<span class="lineNum">    3714 </span>            : }
<a name="3715"><span class="lineNum">    3715 </span>            : </a>
<span class="lineNum">    3716 </span>            : GPAC_MODULE_EXPORT
<span class="lineNum">    3717 </span>            : GF_BaseInterface *LoadInterface(u32 InterfaceType)
<span class="lineNum">    3718 </span>            : {
<span class="lineNum">    3719 </span>            : #ifdef GPAC_HAS_SPIDERMONKEY
<span class="lineNum">    3720 </span>            :         if (InterfaceType == GF_JS_USER_EXT_INTERFACE) return (GF_BaseInterface *)gwm_new();
<span class="lineNum">    3721 </span>            : #ifndef GPAC_DISABLE_SVG
<span class="lineNum">    3722 </span>            :         else if (InterfaceType == GF_SCENE_DECODER_INTERFACE) return (GF_BaseInterface *)LoadWidgetReader();
<span class="lineNum">    3723 </span>            : #endif
<span class="lineNum">    3724 </span>            : #endif
<span class="lineNum">    3725 </span><span class="lineNoCov">          0 :         return NULL;</span>
<span class="lineNum">    3726 </span>            : }
<a name="3727"><span class="lineNum">    3727 </span>            : </a>
<span class="lineNum">    3728 </span>            : GPAC_MODULE_EXPORT
<span class="lineNum">    3729 </span>            : void ShutdownInterface(GF_BaseInterface *ifce)
<span class="lineNum">    3730 </span>            : {
<span class="lineNum">    3731 </span>            :         switch (ifce-&gt;InterfaceType) {
<span class="lineNum">    3732 </span>            : #ifdef GPAC_HAS_SPIDERMONKEY
<span class="lineNum">    3733 </span>            :         case GF_JS_USER_EXT_INTERFACE:
<span class="lineNum">    3734 </span>            :                 gwm_delete(ifce);
<span class="lineNum">    3735 </span>            :                 break;
<span class="lineNum">    3736 </span>            : #ifndef GPAC_DISABLE_SVG
<span class="lineNum">    3737 </span>            :         case GF_SCENE_DECODER_INTERFACE:
<span class="lineNum">    3738 </span>            :                 ShutdownWidgetReader(ifce);
<span class="lineNum">    3739 </span>            :                 break;
<span class="lineNum">    3740 </span>            : #endif
<span class="lineNum">    3741 </span>            : 
<span class="lineNum">    3742 </span>            : #endif
<span class="lineNum">    3743 </span>            :         }
<span class="lineNum">    3744 </span><span class="lineNoCov">          0 : }</span>
<span class="lineNum">    3745 </span>            : 
<span class="lineNum">    3746 </span>            : 
<span class="lineNum">    3747 </span>            : GPAC_MODULE_STATIC_DECLARATION( widgetman )
</pre>
      </td>
    </tr>
  </table>
  <br>

  <table width="100%" border=0 cellspacing=0 cellpadding=0>
    <tr><td class="ruler"><img src="../../glass.png" width=3 height=3 alt=""></td></tr>
    <tr><td class="versionInfo">Generated by: <a href="http://ltp.sourceforge.net/coverage/lcov.php" target="_parent">LCOV version 1.12</a></td></tr>
  </table>
  <br>

</body>
</html>
